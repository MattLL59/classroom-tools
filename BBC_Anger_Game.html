<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Builder Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --pink-point: #ff99cc;
            --white-evidence: #ffffff;
            --green-explain: #90ee90;
            --app-color: #2c3e50;
            --accent-color: #e74c3c;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            color: #333;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER & ADMIN BUTTON --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px;
        }
        h1 { margin: 0; color: var(--app-color); font-size: 1.8rem; }
        .admin-btn {
            background: none; border: none; color: #ccc; font-size: 1.5rem; cursor: pointer; transition: color 0.3s;
        }
        .admin-btn:hover { color: var(--app-color); }

        /* --- GAME UI --- */
        .container {
            flex-grow: 1;
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
            position: relative;
            text-align: center;
            display: flex; flex-direction: column;
        }

        .instructions { font-size: 1.1rem; color: #666; margin-bottom: 20px; }

        .progress-container {
            width: 100%; background: #ddd; height: 15px; border-radius: 10px; margin: 10px 0 20px 0;
            overflow: hidden;
        }
        .progress-bar { height: 100%; width: 0%; background: var(--accent-color); transition: width 0.3s; }

        .game-section { display: none; animation: fadeIn 0.4s; flex-grow: 1; }
        .game-section.active { display: block; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-top: 20px; }

        button.option-btn {
            padding: 20px; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-weight: bold; transition: transform 0.2s;
            border: 2px solid #e2e8f0; color: #333;
        }
        button.option-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }

        .btn-pink { background: var(--pink-point); }
        .btn-white { background: var(--white-evidence); }
        .btn-green { background: var(--green-explain); }

        #final-box {
            background: #f8fafc; border: 3px dashed var(--app-color); padding: 30px; font-size: 1.4rem;
            min-height: 100px; display: flex; align-items: center; justify-content: center; margin-top: 20px;
            line-height: 1.6; border-radius: 10px;
        }

        /* Error Overlay */
        #error-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(231, 76, 60, 0.95); color: white; flex-direction: column;
            justify-content: center; align-items: center; z-index: 100; border-radius: 15px;
        }
        .shake { animation: shake 0.5s; }

        /* --- ADMIN MODAL --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 800px; height: 90%; border-radius: 10px;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .modal-header { padding: 15px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { flex-grow: 1; padding: 20px; overflow-y: auto; }
        .modal-footer { padding: 15px; background: #f1f5f9; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-between; }
        
        .admin-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px; }
        .card { border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fff; position: relative; }
        .del-btn { position: absolute; top: 10px; right: 10px; color: red; background: none; border: none; cursor: pointer; font-weight: bold; }
        
        /* WORKSHEET PRINT STYLES */
        #worksheet-area { display: none; }

        @media print {
            body { background: white; padding: 0; height: auto; overflow: visible; display: block; }
            header, .container, .modal-overlay { display: none !important; }
            #worksheet-area { display: block; font-family: 'Times New Roman', serif; }
            .ws-page { page-break-after: always; padding: 40px; }
            .ws-header { border-bottom: 2px solid black; margin-bottom: 20px; padding-bottom: 10px; }
            .match-row { display: flex; justify-content: space-between; margin-bottom: 20px; align-items: center; border-bottom: 1px dotted #ccc; padding-bottom: 10px; }
            .match-box { width: 45%; }
            .gap-line { line-height: 2.5; font-size: 1.2rem; margin-bottom: 30px; }
        }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>

    <script id="app-config" type="application/json">
    {
        "appTitle": "The Anger Builder",
        "adminPass": "teacher",
        "starters": [
            "The writer clearly shows anger when they use...",
            "The writer creates a hostile tone by choosing...",
            "The writer suggests the BBC is dangerous by saying..."
        ],
        "pairs": [
            {
                "id": "p1",
                "quote": "neighbour from hell",
                "explanation": "This metaphor implies the BBC is impossible to live next to.",
                "distractor": "This suggests the BBC lives in a hot climate."
            },
            {
                "id": "p2",
                "quote": "taken an axe",
                "explanation": "This violent imagery suggests they are destroying things deliberately.",
                "distractor": "This shows they are doing gardening work."
            },
            {
                "id": "p3",
                "quote": "state-funded juggernaut",
                "explanation": "This implies the BBC is a massive, unstoppable monster.",
                "distractor": "This suggests the BBC has many large trucks."
            }
        ]
    }
    </script>

    <header>
        <h1 id="display-title">The Anger Builder</h1>
        <button onclick="toggleAdmin()" class="admin-btn"><i class="fas fa-cog"></i></button>
    </header>

    <div class="container" id="game-ui">
        
        <div id="error-overlay" onclick="this.style.display='none'">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 10px;"></i>
            <h1>TRY AGAIN</h1>
            <p>That explanation doesn't match the quote!</p>
            <p style="font-size: 0.9rem; margin-top: 20px;">(Click anywhere to continue)</p>
        </div>

        <div class="progress-container"><div class="progress-bar" id="bar"></div></div>

        <div id="step-1" class="game-section active">
            <h3>Step 1: Make your Point</h3>
            <p class="instructions">Choose a sentence starter:</p>
            <div class="grid" id="starters-grid"></div>
        </div>

        <div id="step-2" class="game-section">
            <h3>Step 2: Add Evidence</h3>
            <p class="instructions">Pick the quote you want to analyze:</p>
            <div class="grid" id="evidence-grid"></div>
        </div>

        <div id="step-3" class="game-section">
            <h3>Step 3: Explain It</h3>
            <p class="instructions">What does this specific quote mean?</p>
            <div class="grid" id="explain-grid"></div>
        </div>

        <div id="step-4" class="game-section">
            <h3 style="color: var(--green-explain)">Analysis Complete!</h3>
            <div id="final-box"></div>
            <button class="option-btn btn-pink" onclick="restartGame()" style="margin-top:20px; width: 100%;">Analyze Another Quote</button>
        </div>
    </div>

    <div id="admin-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin:0;">App Configuration</h2>
                <button onclick="toggleAdmin()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div id="admin-lock" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
                <p>Enter Password:</p>
                <input type="password" id="admin-pass-input" style="padding:10px; font-size:1.2rem; text-align:center;">
                <button onclick="unlockAdmin()" class="option-btn btn-pink" style="margin-top:10px; padding:10px 30px;">Unlock</button>
                <p style="font-size:0.8rem; color:#999; margin-top:10px;">Default: teacher</p>
            </div>

            <div id="admin-editor" class="modal-body" style="display:none;">
                
                <div style="margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 20px;">
                    <label style="font-weight:bold;">App Title</label>
                    <input id="edit-app-title" class="admin-input" oninput="saveLocal()">
                    <label style="font-weight:bold;">Admin Password</label>
                    <input id="edit-admin-pass" class="admin-input" oninput="saveLocal()">
                </div>

                <h3>Sentence Starters (Pink Cards)</h3>
                <div id="edit-starters-list"></div>
                <button onclick="addStarter()" style="background:#eee; border:1px solid #ccc; padding:5px 10px; cursor:pointer;">+ Add Starter</button>

                <h3 style="margin-top:30px;">Logic Pairs (Evidence & Explanation)</h3>
                <div id="edit-pairs-list"></div>
                <button onclick="addPair()" style="background:#eee; border:1px solid #ccc; padding:5px 10px; cursor:pointer;">+ Add Quote Pair</button>

            </div>

            <div id="admin-footer" class="modal-footer" style="display:none;">
                <button onclick="resetDefaults()" style="color:red; background:none; border:none; cursor:pointer;">Reset Defaults</button>
                <div style="display:flex; gap:10px;">
                    <button onclick="window.print()" style="background:#f39c12; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">
                        <i class="fas fa-print"></i> Print Worksheets
                    </button>
                    <button onclick="exportFile()" style="background:#27ae60; color:white; border:none; padding:10px; border-radius:5px; cursor:pointer;">
                        <i class="fas fa-download"></i> Download App
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="worksheet-area">
        <div class="ws-page">
            <div class="ws-header">
                <h1 id="ws-title-1">Analysis Matching</h1>
                <p>Draw a line connecting the Quote to its correct Explanation.</p>
            </div>
            <div id="ws-level-1"></div>
        </div>
        <div class="ws-page">
            <div class="ws-header">
                <h1>Sentence Building</h1>
                <p>Fill in the gaps to complete the analysis.</p>
            </div>
            <div id="ws-level-2"></div>
        </div>
    </div>

    <script>
        // --- CORE CONFIGURATION LOGIC ---
        let config = {};

        // Load Config (From Tag or LocalStorage)
        function loadConfig() {
            try {
                // Try LocalStorage first (dev mode/persistence)
                const local = localStorage.getItem('analysisAppConfig');
                if (local) {
                    config = JSON.parse(local);
                } else {
                    // Fallback to embedded config (distribution mode)
                    config = JSON.parse(document.getElementById('app-config').textContent);
                }
            } catch (e) {
                console.error("Config load error", e);
            }
            applyConfig();
        }

        function applyConfig() {
            document.title = config.appTitle;
            document.getElementById('display-title').innerText = config.appTitle;
            renderGame();
            renderWorksheets();
        }

        // --- GAME LOGIC ---
        let currentStarter = "";
        let currentQuoteID = "";

        function renderGame() {
            // Starters
            const sGrid = document.getElementById('starters-grid');
            sGrid.innerHTML = '';
            config.starters.forEach(text => {
                sGrid.innerHTML += `<button class="option-btn btn-pink" onclick="pickStarter('${text.replace(/'/g, "\\'")}')">${text}</button>`;
            });

            // Evidence
            const eGrid = document.getElementById('evidence-grid');
            eGrid.innerHTML = '';
            config.pairs.forEach(p => {
                eGrid.innerHTML += `<button class="option-btn btn-white" onclick="pickEvidence('${p.id}')">"${p.quote}"</button>`;
            });

            // Explanations (Shuffle logic needed eventually, currently simple map)
            const exGrid = document.getElementById('explain-grid');
            exGrid.innerHTML = '';
            // Shuffle a copy
            let shuffled = [...config.pairs].sort(() => Math.random() - 0.5);
            shuffled.forEach(p => {
                // We pass ID to check logic
                exGrid.innerHTML += `<button class="option-btn btn-green" onclick="checkLogic('${p.id}')">${p.explanation}</button>`;
            });
        }

        function pickStarter(text) {
            currentStarter = text;
            showSection('step-2', 33);
        }

        function pickEvidence(id) {
            currentQuoteID = id;
            // Regenerate explanations grid here to ensure the correct answer is definitely present (though it always is in this logic)
            // But mainly to re-shuffle for randomness
            const exGrid = document.getElementById('explain-grid');
            let shuffled = [...config.pairs].sort(() => Math.random() - 0.5);
            exGrid.innerHTML = '';
            shuffled.forEach(p => {
                exGrid.innerHTML += `<button class="option-btn btn-green" onclick="checkLogic('${p.id}')">${p.explanation}</button>`;
            });
            showSection('step-3', 66);
        }

        function checkLogic(selectedID) {
            if (selectedID === currentQuoteID) {
                // Correct
                buildFinalSentence(selectedID);
                showSection('step-4', 100);
            } else {
                // Error
                const overlay = document.getElementById('error-overlay');
                overlay.style.display = 'flex';
                const container = document.getElementById('game-ui');
                container.classList.add('shake');
                setTimeout(() => container.classList.remove('shake'), 500);
            }
        }

        function buildFinalSentence(id) {
            const pair = config.pairs.find(p => p.id === id);
            document.getElementById('final-box').innerHTML = 
                `${currentStarter} <strong>"${pair.quote}"</strong>. ${pair.explanation}`;
        }

        function showSection(id, progress) {
            document.querySelectorAll('.game-section').forEach(el => el.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.getElementById('bar').style.width = progress + '%';
        }

        function restartGame() {
            showSection('step-1', 0);
            currentStarter = "";
            currentQuoteID = "";
        }

        // --- WORKSHEET GENERATOR ---
        function renderWorksheets() {
            document.getElementById('ws-title-1').innerText = config.appTitle + ": Matching";
            
            // Level 1: Matching
            const ws1 = document.getElementById('ws-level-1');
            ws1.innerHTML = '';
            let rightSide = [...config.pairs].sort(() => Math.random() - 0.5);
            
            config.pairs.forEach((p, i) => {
                ws1.innerHTML += `
                <div class="match-row">
                    <div class="match-box"><strong>"${p.quote}"</strong></div>
                    <div class="match-box">${rightSide[i].explanation}</div>
                </div>`;
            });

            // Level 2: Cloze
            const ws2 = document.getElementById('ws-level-2');
            ws2.innerHTML = '';
            config.pairs.forEach(p => {
                ws2.innerHTML += `
                <div class="gap-line">
                    The writer uses the phrase <strong>"${p.quote}"</strong>. 
                    This makes the reader think that ______________ _________________ _________________.
                </div>`;
            });
        }

        // --- ADMIN FUNCTIONS ---
        function toggleAdmin() {
            const m = document.getElementById('admin-modal');
            m.style.display = (m.style.display === 'flex') ? 'none' : 'flex';
            if (m.style.display === 'flex') {
                document.getElementById('admin-pass-input').value = '';
                document.getElementById('admin-lock').style.display = 'flex';
                document.getElementById('admin-editor').style.display = 'none';
                document.getElementById('admin-footer').style.display = 'none';
            }
        }

        function unlockAdmin() {
            const input = document.getElementById('admin-pass-input').value;
            if (input === config.adminPass) {
                document.getElementById('admin-lock').style.display = 'none';
                document.getElementById('admin-editor').style.display = 'block';
                document.getElementById('admin-footer').style.display = 'flex';
                renderAdminEditor();
            } else {
                alert("Incorrect Password");
            }
        }

        function renderAdminEditor() {
            document.getElementById('edit-app-title').value = config.appTitle;
            document.getElementById('edit-admin-pass').value = config.adminPass;

            // Starters List
            const sl = document.getElementById('edit-starters-list');
            sl.innerHTML = '';
            config.starters.forEach((s, i) => {
                sl.innerHTML += `
                <div style="display:flex; gap:5px; margin-bottom:5px;">
                    <input class="admin-input" value="${s.replace(/"/g, '&quot;')}" oninput="updateConfig('starter', ${i}, this.value)">
                    <button onclick="deleteItem('starter', ${i})" style="color:red; border:none; background:white;">&times;</button>
                </div>`;
            });

            // Pairs List
            const pl = document.getElementById('edit-pairs-list');
            pl.innerHTML = '';
            config.pairs.forEach((p, i) => {
                pl.innerHTML += `
                <div class="card">
                    <button class="del-btn" onclick="deleteItem('pair', ${i})">Delete</button>
                    <label>Quote (Evidence)</label>
                    <input class="admin-input" value="${p.quote.replace(/"/g, '&quot;')}" oninput="updateConfig('pair_quote', ${i}, this.value)">
                    
                    <label>Correct Explanation</label>
                    <textarea class="admin-input" oninput="updateConfig('pair_explain', ${i}, this.value)">${p.explanation}</textarea>
                    
                    <label style="color:#666; font-size:0.9rem;">Wrong Answer (for error checking)</label>
                    <input class="admin-input" style="border-color:#e74c3c;" value="${p.distractor ? p.distractor.replace(/"/g, '&quot;') : ''}" oninput="updateConfig('pair_distract', ${i}, this.value)">
                </div>`;
            });
        }

        // Live Update & Save
        function updateConfig(type, index, value) {
            if (type === 'starter') config.starters[index] = value;
            if (type === 'pair_quote') config.pairs[index].quote = value;
            if (type === 'pair_explain') config.pairs[index].explanation = value;
            if (type === 'pair_distract') config.pairs[index].distractor = value;
            
            if (type === 'appTitle') config.appTitle = document.getElementById('edit-app-title').value;
            if (type === 'adminPass') config.adminPass = document.getElementById('edit-admin-pass').value;

            saveLocal();
        }

        function addStarter() { config.starters.push("The writer uses..."); renderAdminEditor(); saveLocal(); }
        function addPair() { 
            config.pairs.push({ id: "p"+Date.now(), quote: "New Quote", explanation: "Explanation...", distractor: "Wrong answer..." }); 
            renderAdminEditor(); saveLocal(); 
        }

        function deleteItem(type, index) {
            if (!confirm("Delete this item?")) return;
            if (type === 'starter') config.starters.splice(index, 1);
            if (type === 'pair') config.pairs.splice(index, 1);
            renderAdminEditor(); saveLocal();
        }

        function saveLocal() {
            // Update root properties first
            config.appTitle = document.getElementById('edit-app-title').value;
            config.adminPass = document.getElementById('edit-admin-pass').value;
            
            localStorage.setItem('analysisAppConfig', JSON.stringify(config));
            // Update live game behind modal
            applyConfig();
        }

        function resetDefaults() {
            if(confirm("Reset to original settings?")) {
                localStorage.removeItem('analysisAppConfig');
                location.reload();
            }
        }

        // --- EXPORT FUNCTION (Self-Replication) ---
        function exportFile() {
            // 1. Update the JSON script tag with current config
            const jsonString = JSON.stringify(config, null, 4);
            document.getElementById('app-config').textContent = jsonString;

            // 2. Hide Admin Modal logic for the clean file
            document.getElementById('admin-modal').style.display = 'none';
            document.getElementById('admin-lock').style.display = 'flex';
            document.getElementById('admin-editor').style.display = 'none';
            document.getElementById('admin-footer').style.display = 'none';

            // 3. Clone the document to strip any local-storage overrides currently in RAM
            const htmlContent = document.documentElement.outerHTML;

            // 4. Download
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = config.appTitle.replace(/[^a-z0-9]/gi, '_') + '.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alert("App downloaded! You can now share this HTML file.");
        }

        // Run Init
        loadConfig();

    </script>
</body>
</html>
