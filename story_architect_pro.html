<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>STORY ARCHITECT: PRO</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Roboto:wght@300;400;700&display=swap');

        /* Utility Fixes */
        .hidden { display: none !important; }
        
        body { background-color: #f0f4f8; font-family: 'Roboto', sans-serif; color: #333; height: 100vh; overflow: hidden; }
        
        /* Blueprint Paper Style */
        .blueprint-bg {
            background-color: #2c5282;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            color: white;
        }

        .handwritten { font-family: 'Architects Daughter', cursive; }

        /* Sidebar Assets */
        .asset-card {
            background: rgba(255,255,255,0.1);
            border-left: 4px solid #63b3ed;
            padding: 10px; margin-bottom: 10px;
            font-size: 0.85rem; cursor: pointer;
            transition: all 0.2s;
        }
        .asset-card:hover { background: rgba(255,255,255,0.2); transform: translateX(5px); }

        /* Archetype Deck Card */
        .deck-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 8px; 
            padding: 0; display: flex; flex-direction: column; height: 200px;
            position: relative; overflow: hidden; transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            cursor: pointer;
        }
        .deck-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #3b82f6; }
        .deck-card.selected { border: 4px solid #2563eb; background-color: #eff6ff; }
        
        .deck-header {
            padding: 10px 12px; font-weight: bold; font-size: 14px; text-transform: uppercase; color: white;
            display: flex; justify-content: space-between; align-items: center;
        }
        /* Theme Colors for Headers */
        .header-Decision { background-color: #ef4444; } 
        .header-Event { background-color: #f59e0b; }    
        .header-Journey { background-color: #10b981; }  
        .header-Constraint { background-color: #8b5cf6; }
        .header-Default { background-color: #64748b; }

        .deck-body {
            flex-grow: 1; padding: 15px; display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 16px; color: #334155; position: relative;
        }
        
        .nav-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.9); border-radius: 50%; width: 36px; height: 36px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            color: #1e293b; border: 1px solid #cbd5e1; z-index: 10;
            transition: all 0.2s; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .nav-arrow:hover { background: #2563eb; color: white; border-color: #2563eb; }
        .nav-left { left: 10px; }
        .nav-right { right: 10px; }

        /* Modal */
        .modal-overlay {
            background: rgba(0,0,0,0.8);
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50; display: flex; justify-content: center; align-items: center;
        }

        /* Editor Highlights */
        .highlight-error { background-color: #fecaca; border-bottom: 2px solid #ef4444; } 
        .highlight-warning { background-color: #fef08a; border-bottom: 2px solid #eab308; } 
        .highlight-good { background-color: #bbf7d0; border-bottom: 2px solid #22c55e; } 

        /* Tabs */
        .tab-btn { opacity: 0.6; transition: 0.2s; white-space: nowrap; }
        .tab-btn.active { opacity: 1; border-bottom: 3px solid #63b3ed; font-weight: bold; }

        /* Strip Builder Styles */
        .strip-input {
            transition: all 0.2s;
            border-left: 3px solid #cbd5e1;
        }
        .strip-input:focus {
            border-left-color: #3b82f6;
            background-color: #f8fafc;
        }
        .preview-box {
            font-family: 'Georgia', serif;
            line-height: 1.6;
            color: #334155;
        }

        /* Mobile Adjustments */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="flex flex-col" data-new-gr-c-s-check-loaded="14.1265.0" data-gr-ext-installed="">

    <!-- CONFIG BLOCK -->
    <script id="app-config" type="application/json">{
    "adminPass": "ChiefInspector",
    "appTitle": "STORY ARCHITECT: PRO",
    "examPrompts": [
        {
            "type": "Decision",
            "text": "Write about a time when you had to be brave."
        },
        {
            "type": "Decision",
            "text": "Write about a time when you had to make a difficult choice."
        },
        {
            "type": "Decision",
            "text": "Write about a time when you broke the rules."
        },
        {
            "type": "Decision",
            "text": "Write about a time when you challenged an unfair situation."
        },
        {
            "type": "Decision",
            "text": "Write about a time when you were pushed to the limit."
        },
        {
            "type": "Decision",
            "text": "Write a story with the title: The Choice."
        },
        {
            "type": "Decision",
            "text": "Write a story with the title: The Rebel."
        },
        {
            "type": "Event",
            "text": "Write about a time when you saw something surprising."
        },
        {
            "type": "Event",
            "text": "Write about a time when you lost your temper."
        },
        {
            "type": "Event",
            "text": "Write about a time when you felt let down by a friend."
        },
        {
            "type": "Event",
            "text": "Write about an occasion when you were embarrassed by your family."
        },
        {
            "type": "Event",
            "text": "Write a story with the title: The Storm."
        },
        {
            "type": "Event",
            "text": "Write a story with the title: The Wedding."
        },
        {
            "type": "Event",
            "text": "Write a story with the title: The Competition."
        },
        {
            "type": "Event",
            "text": "Write a story with the title: A Memorable Weekend."
        },
        {
            "type": "Journey",
            "text": "Write about a time when you visited a new place."
        },
        {
            "type": "Journey",
            "text": "Write about a time when you went on a long journey."
        },
        {
            "type": "Journey",
            "text": "Write a story with the title: A New Start."
        },
        {
            "type": "Journey",
            "text": "Write a story with the title: A Fresh Start."
        },
        {
            "type": "Journey",
            "text": "Write a story with the title: Everything Had Changed."
        },
        {
            "type": "Journey",
            "text": "Write a story with the title: A New Beginning."
        },
        {
            "type": "Journey",
            "text": "Write a story beginning with: 'It was a new day...'"
        },
        {
            "type": "Journey",
            "text": "Write a story beginning with: 'Everyone said you should never go back...'"
        },
        {
            "type": "Constraint",
            "text": "Write a story beginning with: 'It was an unusual gift...'"
        },
        {
            "type": "Constraint",
            "text": "Write a story beginning with: 'Suddenly, without warning, there was a power cut.'"
        },
        {
            "type": "Constraint",
            "text": "Write a story beginning with: 'I wish I had never agreed to this...'"
        },
        {
            "type": "Constraint",
            "text": "Write a story beginning with: 'I tried to see what he was reading.'"
        },
        {
            "type": "Constraint",
            "text": "Write a story ending with: '...and I knew I had no choice.'"
        },
        {
            "type": "Constraint",
            "text": "Write a story ending with: '...and that was the worst job of my life.'"
        },
        {
            "type": "Constraint",
            "text": "Write a story ending with: '...and I felt so sorry for myself.'"
        },
        {
            "type": "Constraint",
            "text": "Write a story ending with: '...and on that day, I learned my lesson.'"
        }
    ],
    "blueprintPrompts": [
        {
            "id": "p0",
            "title": "Setting the Scene",
            "prompt": "Describe a setting relevant to your chosen prompt. Focus on weather and sounds to create atmosphere."
        },
        {
            "id": "p1",
            "title": "Character Building",
            "prompt": "Who is your protagonist? What is their biggest fear or weakness?"
        },
        {
            "id": "p2",
            "title": "Relationships",
            "prompt": "Write a line of dialogue where someone is hiding a secret from your protagonist."
        },
        {
            "id": "p3",
            "title": "Building Tension",
            "prompt": "Describe a sensory detail (smell or touch) that signals a problem is starting."
        }
    ],
    "structureSteps": [
        {
            "title": "1. The Opening",
            "guidance": "Establish the normal world and atmosphere.",
            "strips": [
                "Describe the weather/atmosphere (Pathetic Fallacy)",
                "Introduce the character doing something normal",
                "Hint that something is slightly off (Foreshadowing)"
            ]
        },
        {
            "title": "2. The Hook (Rising Tension)",
            "guidance": "Disrupt the normal world.",
            "strips": [
                "The Interrupting Event (Sound or Arrival)",
                "Character's initial reaction (Show don't tell)",
                "A line of dialogue revealing the problem"
            ]
        },
        {
            "title": "3. The Complication",
            "guidance": "Things get worse.",
            "strips": [
                "An obstacle blocks their path",
                "Internal thought: A moment of doubt",
                "Sensory detail of rising panic (Heartbeat/Sweat)"
            ]
        },
        {
            "title": "4. The Climax",
            "guidance": "The moment of highest tension.",
            "strips": [
                "Short, sharp sentence for impact",
                "Powerful verb: Describe the main action",
                "A sudden realization or decision",
                "Physical sensation of the moment"
            ]
        },
        {
            "title": "5. Falling Action",
            "guidance": "The immediate aftermath.",
            "strips": [
                "The silence after the noise",
                "Physical reaction to safety or failure",
                "Observing the changed setting"
            ]
        },
        {
            "title": "6. Resolution",
            "guidance": "Reflection.",
            "strips": [
                "Link back to the opening theme",
                "Final thought or lesson learned",
                "Closing image (Fade out)"
            ]
        }
    ]
}</script>

    <!-- HEADER -->
    <header class="bg-gray-900 text-white p-3 md:p-4 shadow-md flex justify-between items-center z-20">
        <div class="flex items-center gap-3">
            <!-- Mobile Sidebar Toggle -->
            <button onclick="toggleSidebar()" class="md:hidden text-blue-400 text-2xl focus:outline-none">
                <i class="fas fa-bars"></i>
            </button>
            <i class="fas fa-drafting-compass text-2xl md:text-3xl text-blue-400 hidden md:block"></i>
            <div class="overflow-hidden">
                <h1 id="header-title" class="text-lg md:text-xl font-bold tracking-widest uppercase truncate">STORY ARCHITECT: PRO</h1>
                <p class="text-xs text-gray-400 hidden md:block">GCSE COMPONENT 1 BUILDER</p>
            </div>
        </div>
        
        <!-- Scrollable Tabs -->
        <div class="flex gap-4 text-sm overflow-x-auto no-scrollbar ml-2 max-w-[60%] md:max-w-none">
            <button onclick="changePhase(1)" id="nav-p1" class="tab-btn active">1. MISSION</button>
            <button onclick="changePhase(2)" id="nav-p2" class="tab-btn">2. BLUEPRINT</button>
            <button onclick="changePhase(3)" id="nav-p3" class="tab-btn">3. CONSTRUCT</button>
            <button onclick="changePhase(4)" id="nav-p4" class="tab-btn">4. INSPECT</button>
        </div>
        
        <button onclick="toggleAdmin()" class="text-gray-500 hover:text-white ml-2 shrink-0"><i class="fas fa-cog"></i></button>
    </header>

    <!-- CONTENT AREA -->
    <div class="flex flex-grow overflow-hidden relative">
        
        <!-- SIDEBAR (Assets & Info) -->
        <aside id="main-sidebar" class="absolute inset-y-0 left-0 transform -translate-x-full md:relative md:translate-x-0 transition duration-200 ease-in-out z-30 w-3/4 md:w-1/4 blueprint-bg p-4 flex flex-col overflow-y-auto shadow-2xl md:shadow-xl">
            
            <div class="flex justify-between items-center md:hidden mb-4 border-b border-blue-500 pb-2">
                <h2 class="text-blue-300 font-bold">TOOLS &amp; ASSETS</h2>
                <button onclick="toggleSidebar()" class="text-white"><i class="fas fa-times"></i></button>
            </div>

            <!-- MISSION DISPLAY -->
            <div class="bg-blue-900 bg-opacity-50 border border-blue-400 p-3 rounded mb-4 shadow-inner">
                <h3 class="text-blue-300 text-xs font-bold uppercase tracking-wider mb-1"><i class="fas fa-crosshairs mr-1"></i> Current Mission</h3>
                <p id="sidebar-mission-text" class="text-white text-sm font-serif italic">No prompt selected.</p>
                <button onclick="changePhase(1); if(window.innerWidth &lt; 768) toggleSidebar();" class="mt-2 text-xs text-blue-300 hover:text-white underline">Change Prompt</button>
            </div>

            <h2 class="text-blue-300 font-bold mb-4 border-b border-blue-500 pb-2 hidden md:block">PROJECT ASSETS</h2>
            <div id="assets-container" class="space-y-4"></div>
            
            <div class="mt-auto pt-6">
                <h3 class="text-blue-300 font-bold mb-2 text-sm">TOOLS</h3>
                <button onclick="startNewSession()" class="w-full bg-red-600 hover:bg-red-500 text-white text-xs py-3 rounded mb-2 text-left px-3">
                    <i class="fas fa-trash-alt mr-2"></i> Start New Story
                </button>
                <button onclick="checkSpelling()" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-xs py-3 rounded mb-2 text-left px-3">
                    <i class="fas fa-check-double mr-2"></i> Run Spell Check
                </button>
                <button onclick="analyzeDialogue()" class="w-full bg-green-600 hover:bg-green-500 text-white text-xs py-3 rounded mb-2 text-left px-3">
                    <i class="fas fa-comments mr-2"></i> Dialogue Validator
                </button>
            </div>
        </aside>

        <!-- OVERLAY FOR MOBILE SIDEBAR -->
        <div id="sidebar-overlay" onclick="toggleSidebar()" class="hidden fixed inset-0 bg-black bg-opacity-50 z-20 md:hidden"></div>

        <!-- MAIN WORKSPACE -->
        <main class="w-full md:w-3/4 bg-white relative">

            <!-- PHASE 1: PROMPT SELECTION -->
            <div id="phase-1" class="absolute inset-0 p-4 md:p-8 overflow-y-auto bg-gray-50 pb-32">
                <div class="max-w-5xl mx-auto">
                    <h2 class="text-2xl md:text-3xl font-bold text-gray-800 mb-2">1. Select Your Mission</h2>
                    <p class="text-sm md:text-base text-gray-500 mb-6">Choose an archetype below. Use arrows to browse specific questions.</p>
                    
                    <div id="deck-grid" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div class="deck-card group" id="card-Decision" onclick="selectDeck('Decision', 'Write a story with the title: The Rebel.')">
                        <div class="deck-header header-Decision">
                            <span>Decision</span>
                            <span class="text-sm font-bold opacity-100">7/7</span>
                        </div>
                        <div class="deck-body">
                            <button onclick="prevPrompt(event, 'Decision')" class="nav-arrow nav-left"><i class="fas fa-chevron-left"></i></button>
                            <p class="px-8 leading-snug font-serif text-lg" id="text-Decision">"Write a story with the title: The Rebel."</p>
                            <button onclick="nextPrompt(event, 'Decision')" class="nav-arrow nav-right"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                
                    <div class="deck-card group" id="card-Event" onclick="selectDeck('Event', 'Write about a time when you saw something surprising.')">
                        <div class="deck-header header-Event">
                            <span>Event</span>
                            <span class="text-sm font-bold opacity-100">1/8</span>
                        </div>
                        <div class="deck-body">
                            <button onclick="prevPrompt(event, 'Event')" class="nav-arrow nav-left"><i class="fas fa-chevron-left"></i></button>
                            <p class="px-8 leading-snug font-serif text-lg" id="text-Event">"Write about a time when you saw something surprising."</p>
                            <button onclick="nextPrompt(event, 'Event')" class="nav-arrow nav-right"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                
                    <div class="deck-card group" id="card-Journey" onclick="selectDeck('Journey', 'Write about a time when you visited a new place.')">
                        <div class="deck-header header-Journey">
                            <span>Journey</span>
                            <span class="text-sm font-bold opacity-100">1/8</span>
                        </div>
                        <div class="deck-body">
                            <button onclick="prevPrompt(event, 'Journey')" class="nav-arrow nav-left"><i class="fas fa-chevron-left"></i></button>
                            <p class="px-8 leading-snug font-serif text-lg" id="text-Journey">"Write about a time when you visited a new place."</p>
                            <button onclick="nextPrompt(event, 'Journey')" class="nav-arrow nav-right"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                
                    <div class="deck-card group" id="card-Constraint" onclick="selectDeck('Constraint', 'Write a story beginning with: \'It was an unusual gift...\'')">
                        <div class="deck-header header-Constraint">
                            <span>Constraint</span>
                            <span class="text-sm font-bold opacity-100">1/8</span>
                        </div>
                        <div class="deck-body">
                            <button onclick="prevPrompt(event, 'Constraint')" class="nav-arrow nav-left"><i class="fas fa-chevron-left"></i></button>
                            <p class="px-8 leading-snug font-serif text-lg" id="text-Constraint">"Write a story beginning with: 'It was an unusual gift...'"</p>
                            <button onclick="nextPrompt(event, 'Constraint')" class="nav-arrow nav-right"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                </div>

                    <div class="h-20 md:h-8"></div>
                </div>
                
                <!-- FIXED BOTTOM BUTTON FOR MOBILE ACCESSIBILITY -->
                <div class="fixed bottom-0 left-0 right-0 p-4 bg-white border-t border-gray-200 md:relative md:bg-transparent md:border-none md:p-0 z-40 md:z-0">
                    <div class="max-w-5xl mx-auto">
                        <button id="start-btn" onclick="confirmPrompt()" class="w-full md:mt-8 text-white px-8 py-4 rounded-lg font-bold shadow-lg transition text-center bg-blue-600 hover:bg-blue-700 bg-gray-400 cursor-not-allowed" disabled="">Initialize Blueprint <i class="fas fa-chevron-right ml-2"></i></button>
                    </div>
                </div>
            </div>
            
            <!-- PHASE 2: BLUEPRINT -->
            <div id="phase-2" class="absolute inset-0 p-4 md:p-8 overflow-y-auto hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">2. The Blueprint</h2>
                <p class="text-sm text-gray-500 mb-6">Define the core elements.</p>
                <div id="blueprint-inputs" class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    <div class="bg-white border p-4 rounded shadow-sm">
                        <label class="block text-blue-800 font-bold mb-1">Setting the Scene</label>
                        <p class="text-xs text-gray-500 mb-2">Describe a setting relevant to your chosen prompt. Focus on weather and sounds to create atmosphere.</p>
                        <textarea id="input-p1" class="w-full border bg-gray-50 p-2 rounded h-24 focus:ring-2 ring-blue-300 outline-none" oninput="saveProgress()" value=""></textarea>
                    </div>
                
                    <div class="bg-white border p-4 rounded shadow-sm">
                        <label class="block text-blue-800 font-bold mb-1">Character Building</label>
                        <p class="text-xs text-gray-500 mb-2">Who is your protagonist? What is their biggest fear or weakness?</p>
                        <textarea id="input-p2" class="w-full border bg-gray-50 p-2 rounded h-24 focus:ring-2 ring-blue-300 outline-none" oninput="saveProgress()" value=""></textarea>
                    </div>
                
                    <div class="bg-white border p-4 rounded shadow-sm">
                        <label class="block text-blue-800 font-bold mb-1">Relationships</label>
                        <p class="text-xs text-gray-500 mb-2">Write a line of dialogue where someone is hiding a secret from your protagonist.</p>
                        <textarea id="input-p3" class="w-full border bg-gray-50 p-2 rounded h-24 focus:ring-2 ring-blue-300 outline-none" oninput="saveProgress()" value=""></textarea>
                    </div>
                
                    <div class="bg-white border p-4 rounded shadow-sm">
                        <label class="block text-blue-800 font-bold mb-1">Building Tension</label>
                        <p class="text-xs text-gray-500 mb-2">Describe a sensory detail (smell or touch) that signals a problem is starting.</p>
                        <textarea id="input-p4" class="w-full border bg-gray-50 p-2 rounded h-24 focus:ring-2 ring-blue-300 outline-none" oninput="saveProgress()" value=""></textarea>
                    </div>
                </div>
                <div class="h-20"></div>
                <button onclick="changePhase(3)" class="mt-4 bg-blue-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:bg-blue-700 float-right mb-8">
                    Proceed to Construction <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>

            <!-- PHASE 3: CONSTRUCTION -->
            <div id="phase-3" class="absolute inset-0 p-4 md:p-8 overflow-y-auto hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">3. Construction</h2>
                <p class="text-sm text-gray-500 mb-6">Build your story beat-by-beat.</p>
                
                <div id="structure-inputs" class="space-y-6">
                    <div class="border-l-4 border-green-500 pl-4 py-2 bg-gray-50 rounded pr-4">
                        <label class="block text-lg font-bold text-gray-800 mb-1">1. The Opening</label>
                        <p class="text-sm text-gray-500 mb-4"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i> Establish the normal world and atmosphere.</p>
                        
                        <div class="space-y-2">
                            
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">Describe the weather/atmosphere (Pathetic Fallacy)</label>
                                <input id="strip-0-0" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(0)">
                            </div>
                        
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">Introduce the character doing something normal</label>
                                <input id="strip-0-1" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(0)">
                            </div>
                        
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">Hint that something is slightly off (Foreshadowing)</label>
                                <input id="strip-0-2" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(0)">
                            </div>
                        
                        </div>

                        <!-- Live Preview -->
                        <div class="mt-4 p-3 bg-white border border-green-200 rounded">
                            <h4 class="text-xs font-bold text-green-600 uppercase mb-1">Paragraph Preview:</h4>
                            <p id="preview-step-0" class="text-sm font-serif text-gray-800 italic preview-box min-h-[1.5rem]">raining Joe is drdivinng He looks in the rear view mirror </p>
                        </div>
                    </div>
                
                    <div class="border-l-4 border-green-500 pl-4 py-2 bg-gray-50 rounded pr-4">
                        <label class="block text-lg font-bold text-gray-800 mb-1">2. The Hook (Rising Tension)</label>
                        <p class="text-sm text-gray-500 mb-4"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i> Disrupt the normal world.</p>
                        
                        <div class="space-y-2">
                            
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">The Interrupting Event (Sound or Arrival)</label>
                                <input id="strip-1-0" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(1)">
                            </div>
                        
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">Character's initial reaction (Show don't tell)</label>
                                <input id="strip-1-1" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(1)">
                            </div>
                        
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">A line of dialogue revealing the problem</label>
                                <input id="strip-1-2" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(1)">
                            </div>
                        
                        </div>

                        <!-- Live Preview -->
                        <div class="mt-4 p-3 bg-white border border-green-200 rounded">
                            <h4 class="text-xs font-bold text-green-600 uppercase mb-1">Paragraph Preview:</h4>
                            <p id="preview-step-1" class="text-sm font-serif text-gray-800 italic preview-box min-h-[1.5rem] opacity-50">Start typing above...</p>
                        </div>
                    </div>
                
                    <div class="border-l-4 border-green-500 pl-4 py-2 bg-gray-50 rounded pr-4">
                        <label class="block text-lg font-bold text-gray-800 mb-1">3. The Complication</label>
                        <p class="text-sm text-gray-500 mb-4"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i> Things get worse.</p>
                        
                        <div class="space-y-2">
                            
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">An obstacle blocks their path</label>
                                <input id="strip-2-0" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(2)">
                            </div>
                        
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">Internal thought: A moment of doubt</label>
                                <input id="strip-2-1" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(2)">
                            </div>
                        
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">Sensory detail of rising panic (Heartbeat/Sweat)</label>
                                <input id="strip-2-2" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(2)">
                            </div>
                        
                        </div>

                        <!-- Live Preview -->
                        <div class="mt-4 p-3 bg-white border border-green-200 rounded">
                            <h4 class="text-xs font-bold text-green-600 uppercase mb-1">Paragraph Preview:</h4>
                            <p id="preview-step-2" class="text-sm font-serif text-gray-800 italic preview-box min-h-[1.5rem] opacity-50">Start typing above...</p>
                        </div>
                    </div>
                
                    <div class="border-l-4 border-green-500 pl-4 py-2 bg-gray-50 rounded pr-4">
                        <label class="block text-lg font-bold text-gray-800 mb-1">4. The Climax</label>
                        <p class="text-sm text-gray-500 mb-4"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i> The moment of highest tension.</p>
                        
                        <div class="space-y-2">
                            
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">Short, sharp sentence for impact</label>
                                <input id="strip-3-0" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(3)">
                            </div>
                        
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">Powerful verb: Describe the main action</label>
                                <input id="strip-3-1" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(3)">
                            </div>
                        
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">A sudden realization or decision</label>
                                <input id="strip-3-2" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(3)">
                            </div>
                        
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">Physical sensation of the moment</label>
                                <input id="strip-3-3" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(3)">
                            </div>
                        
                        </div>

                        <!-- Live Preview -->
                        <div class="mt-4 p-3 bg-white border border-green-200 rounded">
                            <h4 class="text-xs font-bold text-green-600 uppercase mb-1">Paragraph Preview:</h4>
                            <p id="preview-step-3" class="text-sm font-serif text-gray-800 italic preview-box min-h-[1.5rem] opacity-50">Start typing above...</p>
                        </div>
                    </div>
                
                    <div class="border-l-4 border-green-500 pl-4 py-2 bg-gray-50 rounded pr-4">
                        <label class="block text-lg font-bold text-gray-800 mb-1">5. Falling Action</label>
                        <p class="text-sm text-gray-500 mb-4"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i> The immediate aftermath.</p>
                        
                        <div class="space-y-2">
                            
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">The silence after the noise</label>
                                <input id="strip-4-0" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(4)">
                            </div>
                        
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">Physical reaction to safety or failure</label>
                                <input id="strip-4-1" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(4)">
                            </div>
                        
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">Observing the changed setting</label>
                                <input id="strip-4-2" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(4)">
                            </div>
                        
                        </div>

                        <!-- Live Preview -->
                        <div class="mt-4 p-3 bg-white border border-green-200 rounded">
                            <h4 class="text-xs font-bold text-green-600 uppercase mb-1">Paragraph Preview:</h4>
                            <p id="preview-step-4" class="text-sm font-serif text-gray-800 italic preview-box min-h-[1.5rem] opacity-50">Start typing above...</p>
                        </div>
                    </div>
                
                    <div class="border-l-4 border-green-500 pl-4 py-2 bg-gray-50 rounded pr-4">
                        <label class="block text-lg font-bold text-gray-800 mb-1">6. Resolution</label>
                        <p class="text-sm text-gray-500 mb-4"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i> Reflection.</p>
                        
                        <div class="space-y-2">
                            
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">Link back to the opening theme</label>
                                <input id="strip-5-0" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(5)">
                            </div>
                        
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">Final thought or lesson learned</label>
                                <input id="strip-5-1" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(5)">
                            </div>
                        
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">Closing image (Fade out)</label>
                                <input id="strip-5-2" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(5)">
                            </div>
                        
                        </div>

                        <!-- Live Preview -->
                        <div class="mt-4 p-3 bg-white border border-green-200 rounded">
                            <h4 class="text-xs font-bold text-green-600 uppercase mb-1">Paragraph Preview:</h4>
                            <p id="preview-step-5" class="text-sm font-serif text-gray-800 italic preview-box min-h-[1.5rem]">Teacher </p>
                        </div>
                    </div>
                </div>

                <div class="h-24"></div> <!-- Spacer -->
                
                <div class="fixed bottom-6 right-6 md:bottom-8 md:right-8 z-30">
                    <button onclick="compileStory()" class="bg-green-600 text-white px-6 py-3 md:px-8 md:py-4 rounded-full font-bold shadow-2xl hover:bg-green-700 transform hover:scale-105 transition flex items-center text-sm md:text-base">
                        <span>Compile Full Draft</span> <i class="fas fa-hammer ml-2"></i>
                    </button>
                </div>
            </div>

            <!-- PHASE 4: INSPECTION -->
            <div id="phase-4" class="absolute inset-0 p-4 md:p-8 overflow-y-auto hidden">
                <div class="h-full flex flex-col">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-end mb-4 gap-2">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">4. Inspection</h2>
                            <p class="text-sm text-gray-500">Review, refine, and check your work.</p>
                        </div>
                        <div class="flex gap-2 w-full md:w-auto">
                             <button onclick="reCompile()" class="flex-1 md:flex-none bg-blue-100 text-blue-700 border border-blue-300 px-3 py-2 rounded text-xs md:text-sm hover:bg-blue-200"><i class="fas fa-sync mr-1"></i> Refresh</button>
                             <button onclick="downloadStory()" class="flex-1 md:flex-none bg-gray-800 text-white px-4 py-2 rounded text-xs md:text-sm"><i class="fas fa-file-download mr-1"></i> Download</button>
                        </div>
                    </div>

                    <div class="flex-grow relative">
                        <div id="final-editor" contenteditable="true" class="w-full h-full border p-4 md:p-6 rounded bg-gray-50 font-serif text-base md:text-lg leading-relaxed focus:outline-none focus:bg-white focus:ring-2 ring-blue-200 overflow-y-auto" spellcheck="false"></div>
                    </div>
                    
                    <div id="inspection-feedback" class="min-h-[3rem] mt-4 bg-gray-100 rounded border border-gray-300 p-3 flex items-center text-xs md:text-sm text-gray-600">
                        <i class="fas fa-info-circle text-blue-500 text-xl mr-3"></i>
                        <span>Ready for inspection. Click 'Dialogue Validator' or 'Spell Check' in the sidebar menu.</span>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- ADMIN MODAL -->
    <div id="admin-modal" class="modal-overlay hidden">
        <div class="bg-white w-full h-full md:w-11/12 md:h-5/6 md:rounded-lg shadow-2xl flex flex-col overflow-hidden">
            <div class="bg-gray-100 p-4 border-b flex justify-between items-center">
                <h2 class="font-bold text-lg text-gray-700">Chief Architect Admin Panel</h2>
                <button onclick="toggleAdmin()" class="text-gray-500 hover:text-red-500 text-2xl">Ã—</button>
            </div>
            
            <!-- Lock Screen -->
            <div id="admin-lock" class="flex-grow flex flex-col justify-center items-center p-4">
                <p class="text-gray-500 mb-4">Enter password to configure blueprint.</p>
                <div id="pass-hint" class="bg-yellow-100 text-yellow-800 p-2 rounded text-xs mb-4">Default: ChiefInspector</div>
                <input type="password" id="admin-pass" class="border p-2 rounded w-64 text-center mb-4" placeholder="Password">
                <button onclick="unlockAdmin()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">UNLOCK</button>
            </div>

            <!-- Unlocked Screen -->
            <div id="admin-unlocked" class="flex-grow overflow-y-auto p-4 md:p-6 space-y-6 hidden">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500">App Title</label>
                        <input id="edit-title" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Admin Password</label>
                        <input id="edit-pass" class="w-full border p-2 rounded" autocomplete="off">
                    </div>
                </div>
                
                <!-- TABS -->
                 <div class="flex border-b overflow-x-auto">
                    <button class="px-4 py-2 text-sm font-bold text-blue-600 border-b-2 border-blue-600 whitespace-nowrap" onclick="showTab('prompts')">Skill Prompts</button>
                    <button class="px-4 py-2 text-sm font-bold text-gray-500 hover:text-blue-600 whitespace-nowrap" onclick="showTab('structure')">Structure &amp; Strips</button>
                    <button class="px-4 py-2 text-sm font-bold text-gray-500 hover:text-blue-600 whitespace-nowrap" onclick="showTab('exam')">Exam Prompts</button>
                </div>

                <!-- Prompts Editor -->
                <div id="tab-prompts" class="space-y-6 hidden">
                    <div class="border p-4 rounded bg-blue-50">
                        <h3 class="font-bold text-blue-800 mb-2">Phase 2: Skill Prompts</h3>
                        <div id="prompts-editor" class="space-y-3"><div class="bg-white p-2 rounded border mb-2"><input class="w-full text-xs font-bold border-b mb-1 p-title" value="Setting the Scene" placeholder="Title"><input class="w-full text-xs text-gray-600 p-prompt" value="Describe a setting relevant to your chosen prompt. Focus on weather and sounds to create atmosphere." placeholder="Prompt"><button onclick="delPrompt(0)" class="text-red-500 font-bold text-xs mt-1">Delete</button></div><div class="bg-white p-2 rounded border mb-2"><input class="w-full text-xs font-bold border-b mb-1 p-title" value="Character Building" placeholder="Title"><input class="w-full text-xs text-gray-600 p-prompt" value="Who is your protagonist? What is their biggest fear or weakness?" placeholder="Prompt"><button onclick="delPrompt(1)" class="text-red-500 font-bold text-xs mt-1">Delete</button></div><div class="bg-white p-2 rounded border mb-2"><input class="w-full text-xs font-bold border-b mb-1 p-title" value="Relationships" placeholder="Title"><input class="w-full text-xs text-gray-600 p-prompt" value="Write a line of dialogue where someone is hiding a secret from your protagonist." placeholder="Prompt"><button onclick="delPrompt(2)" class="text-red-500 font-bold text-xs mt-1">Delete</button></div><div class="bg-white p-2 rounded border mb-2"><input class="w-full text-xs font-bold border-b mb-1 p-title" value="Building Tension" placeholder="Title"><input class="w-full text-xs text-gray-600 p-prompt" value="Describe a sensory detail (smell or touch) that signals a problem is starting." placeholder="Prompt"><button onclick="delPrompt(3)" class="text-red-500 font-bold text-xs mt-1">Delete</button></div></div>
                        <button onclick="addPrompt()" class="mt-2 text-xs bg-blue-600 text-white px-2 py-1 rounded">+ Add Prompt</button>
                    </div>
                </div>

                <!-- Structure Editor (STRIPS) -->
                <div id="tab-structure" class="space-y-6 hidden">
                    <div class="border p-4 rounded bg-green-50">
                        <h3 class="font-bold text-green-800 mb-2">Phase 3: Structure &amp; Micro-Prompts</h3>
                        <div id="structure-editor" class="space-y-6">
                    <div class="bg-white p-3 rounded border mb-4">
                        <div class="flex justify-between mb-2">
                            <input class="font-bold text-sm border-b s-title w-1/2" value="1. The Opening" placeholder="Step Title">
                            <button onclick="delStep(0)" class="text-red-500 font-bold text-xs">Delete Step</button>
                        </div>
                        <input class="w-full text-xs text-gray-600 s-guide mb-2 border rounded p-1" value="Establish the normal world and atmosphere." placeholder="Guidance">
                        <label class="block text-xs font-bold text-blue-600 mb-1">Micro-Prompts (One per line)</label>
                        <textarea class="w-full text-xs border rounded p-2 h-20 s-strips" placeholder="Enter strips..." value=""></textarea>
                    </div>
                
                    <div class="bg-white p-3 rounded border mb-4">
                        <div class="flex justify-between mb-2">
                            <input class="font-bold text-sm border-b s-title w-1/2" value="2. The Hook (Rising Tension)" placeholder="Step Title">
                            <button onclick="delStep(1)" class="text-red-500 font-bold text-xs">Delete Step</button>
                        </div>
                        <input class="w-full text-xs text-gray-600 s-guide mb-2 border rounded p-1" value="Disrupt the normal world." placeholder="Guidance">
                        <label class="block text-xs font-bold text-blue-600 mb-1">Micro-Prompts (One per line)</label>
                        <textarea class="w-full text-xs border rounded p-2 h-20 s-strips" placeholder="Enter strips..." value=""></textarea>
                    </div>
                
                    <div class="bg-white p-3 rounded border mb-4">
                        <div class="flex justify-between mb-2">
                            <input class="font-bold text-sm border-b s-title w-1/2" value="3. The Complication" placeholder="Step Title">
                            <button onclick="delStep(2)" class="text-red-500 font-bold text-xs">Delete Step</button>
                        </div>
                        <input class="w-full text-xs text-gray-600 s-guide mb-2 border rounded p-1" value="Things get worse." placeholder="Guidance">
                        <label class="block text-xs font-bold text-blue-600 mb-1">Micro-Prompts (One per line)</label>
                        <textarea class="w-full text-xs border rounded p-2 h-20 s-strips" placeholder="Enter strips..." value=""></textarea>
                    </div>
                
                    <div class="bg-white p-3 rounded border mb-4">
                        <div class="flex justify-between mb-2">
                            <input class="font-bold text-sm border-b s-title w-1/2" value="4. The Climax" placeholder="Step Title">
                            <button onclick="delStep(3)" class="text-red-500 font-bold text-xs">Delete Step</button>
                        </div>
                        <input class="w-full text-xs text-gray-600 s-guide mb-2 border rounded p-1" value="The moment of highest tension." placeholder="Guidance">
                        <label class="block text-xs font-bold text-blue-600 mb-1">Micro-Prompts (One per line)</label>
                        <textarea class="w-full text-xs border rounded p-2 h-20 s-strips" placeholder="Enter strips..." value=""></textarea>
                    </div>
                
                    <div class="bg-white p-3 rounded border mb-4">
                        <div class="flex justify-between mb-2">
                            <input class="font-bold text-sm border-b s-title w-1/2" value="5. Falling Action" placeholder="Step Title">
                            <button onclick="delStep(4)" class="text-red-500 font-bold text-xs">Delete Step</button>
                        </div>
                        <input class="w-full text-xs text-gray-600 s-guide mb-2 border rounded p-1" value="The immediate aftermath." placeholder="Guidance">
                        <label class="block text-xs font-bold text-blue-600 mb-1">Micro-Prompts (One per line)</label>
                        <textarea class="w-full text-xs border rounded p-2 h-20 s-strips" placeholder="Enter strips..." value=""></textarea>
                    </div>
                
                    <div class="bg-white p-3 rounded border mb-4">
                        <div class="flex justify-between mb-2">
                            <input class="font-bold text-sm border-b s-title w-1/2" value="6. Resolution" placeholder="Step Title">
                            <button onclick="delStep(5)" class="text-red-500 font-bold text-xs">Delete Step</button>
                        </div>
                        <input class="w-full text-xs text-gray-600 s-guide mb-2 border rounded p-1" value="Reflection." placeholder="Guidance">
                        <label class="block text-xs font-bold text-blue-600 mb-1">Micro-Prompts (One per line)</label>
                        <textarea class="w-full text-xs border rounded p-2 h-20 s-strips" placeholder="Enter strips..." value=""></textarea>
                    </div>
                </div>
                        <button onclick="addStep()" class="mt-4 text-xs bg-green-600 text-white px-2 py-1 rounded">+ Add Step</button>
                    </div>
                </div>

                <!-- Exam Prompts Editor -->
                <div id="tab-exam" class="border p-4 rounded bg-purple-50">
                    <h3 class="font-bold text-purple-800 mb-2">Phase 1: Exam Questions</h3>
                    <div id="exam-editor" class="space-y-3"><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option selected="">Decision</option><option>Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write about a time when you had to be brave."><button onclick="delExamPrompt(0)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option selected="">Decision</option><option>Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write about a time when you had to make a difficult choice."><button onclick="delExamPrompt(1)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option selected="">Decision</option><option>Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write about a time when you broke the rules."><button onclick="delExamPrompt(2)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option selected="">Decision</option><option>Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write about a time when you challenged an unfair situation."><button onclick="delExamPrompt(3)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option selected="">Decision</option><option>Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write about a time when you were pushed to the limit."><button onclick="delExamPrompt(4)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option selected="">Decision</option><option>Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story with the title: The Choice."><button onclick="delExamPrompt(5)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option selected="">Decision</option><option>Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story with the title: The Rebel."><button onclick="delExamPrompt(6)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option selected="">Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write about a time when you saw something surprising."><button onclick="delExamPrompt(7)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option selected="">Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write about a time when you lost your temper."><button onclick="delExamPrompt(8)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option selected="">Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write about a time when you felt let down by a friend."><button onclick="delExamPrompt(9)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option selected="">Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write about an occasion when you were embarrassed by your family."><button onclick="delExamPrompt(10)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option selected="">Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story with the title: The Storm."><button onclick="delExamPrompt(11)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option selected="">Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story with the title: The Wedding."><button onclick="delExamPrompt(12)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option selected="">Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story with the title: The Competition."><button onclick="delExamPrompt(13)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option selected="">Event</option><option>Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story with the title: A Memorable Weekend."><button onclick="delExamPrompt(14)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option selected="">Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write about a time when you visited a new place."><button onclick="delExamPrompt(15)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option selected="">Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write about a time when you went on a long journey."><button onclick="delExamPrompt(16)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option selected="">Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story with the title: A New Start."><button onclick="delExamPrompt(17)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option selected="">Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story with the title: A Fresh Start."><button onclick="delExamPrompt(18)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option selected="">Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story with the title: Everything Had Changed."><button onclick="delExamPrompt(19)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option selected="">Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story with the title: A New Beginning."><button onclick="delExamPrompt(20)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option selected="">Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story beginning with: 'It was a new day...'"><button onclick="delExamPrompt(21)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option selected="">Journey</option><option>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story beginning with: 'Everyone said you should never go back...'"><button onclick="delExamPrompt(22)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option>Journey</option><option selected="">Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story beginning with: 'It was an unusual gift...'"><button onclick="delExamPrompt(23)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option>Journey</option><option selected="">Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story beginning with: 'Suddenly, without warning, there was a power cut.'"><button onclick="delExamPrompt(24)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option>Journey</option><option selected="">Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story beginning with: 'I wish I had never agreed to this...'"><button onclick="delExamPrompt(25)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option>Journey</option><option selected="">Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story beginning with: 'I tried to see what he was reading.'"><button onclick="delExamPrompt(26)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option>Journey</option><option selected="">Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story ending with: '...and I knew I had no choice.'"><button onclick="delExamPrompt(27)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option>Journey</option><option selected="">Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story ending with: '...and that was the worst job of my life.'"><button onclick="delExamPrompt(28)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option>Journey</option><option selected="">Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story ending with: '...and I felt so sorry for myself.'"><button onclick="delExamPrompt(29)" class="text-red-500 font-bold">Ã—</button></div><div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option>Decision</option><option>Event</option><option>Journey</option><option selected="">Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="Write a story ending with: '...and on that day, I learned my lesson.'"><button onclick="delExamPrompt(30)" class="text-red-500 font-bold">Ã—</button></div></div>
                    <button onclick="addExamPrompt()" class="mt-2 text-xs bg-purple-600 text-white px-2 py-1 rounded">+ Add Question</button>
                </div>

            </div>

            <!-- Footer -->
            <div id="admin-footer" class="bg-gray-50 p-4 border-t flex flex-col md:flex-row justify-between gap-4 hidden">
                <button onclick="resetDefaults()" class="text-red-500 text-sm">Reset Defaults</button>
                <div class="flex flex-col md:flex-row gap-2">
                    <button onclick="generateWorksheet()" class="bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-2 rounded font-bold text-sm text-center">
                        <i class="fas fa-file-word mr-2"></i> Worksheet (.doc)
                    </button>
                    <button onclick="copySource()" class="bg-gray-700 text-white px-4 py-2 rounded font-bold text-sm">Copy Source</button>
                    <button onclick="exportFile()" class="bg-purple-700 text-white px-4 py-2 rounded font-bold text-sm">Download File</button>
                    <button onclick="saveLocal()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm">Save (Local)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SAFE STORAGE ---
        const SafeStorage = {
            getItem: (k) => { try { return localStorage.getItem(k) } catch(e){ return null } },
            setItem: (k,v) => { try { localStorage.setItem(k,v) } catch(e){} },
            removeItem: (k) => { try { localStorage.removeItem(k) } catch(e){} }
        };

        // --- LOAD CONFIG ---
        let config;
        try {
            config = JSON.parse(document.getElementById('app-config').textContent);
        } catch(e) { console.error("Config Error", e); config = {}; }

        // Local Override
        try {
            const local = SafeStorage.getItem('storyArchConfig');
            if(local) config = { ...config, ...JSON.parse(local) };
        } catch(e){}

        // --- STATE ---
        let storyData = {
            selectedPrompt: null,
            assets: {},
            drafts: {} 
        };
        
        let deckState = { 'Decision': 0, 'Event': 0, 'Journey': 0, 'Constraint': 0 };

        // --- INIT ---
        window.onload = function() {
            document.title = config.appTitle;
            document.getElementById('header-title').innerText = config.appTitle;
            
            // 1. Initial Render (Default State)
            renderPhase1(); // Deck
            renderPhase2(); // Blueprint
            renderPhase3(); // Construction
            
            // 2. Load Saved Data
            const saved = SafeStorage.getItem('storyArchProgress');
            if(saved) {
                storyData = JSON.parse(saved);
                
                // RESTORE UI STATE WITHOUT CHANGING PHASE
                if(storyData.selectedPrompt) {
                     // Update Sidebar Text
                     document.getElementById('sidebar-mission-text').innerText = `"${storyData.selectedPrompt}"`;
                     
                     // Sync Deck View (Phase 1)
                     const pConfig = config.examPrompts.find(p => p.text === storyData.selectedPrompt);
                     if (pConfig) {
                        const type = pConfig.type || 'Event';
                        const typePrompts = config.examPrompts.filter(p => (p.type || 'Event') === type);
                        const idx = typePrompts.findIndex(p => p.text === storyData.selectedPrompt);
                        
                        if (idx !== -1) deckState[type] = idx;
                        
                        // Re-render Phase 1
                        renderPhase1();
                        
                        // Visual Select
                        const card = document.getElementById(`card-${type}`);
                        if(card) card.classList.add('selected');
                        
                        // Enable Button
                        const btn = document.getElementById('start-btn');
                        if(btn) {
                            btn.disabled = false;
                            btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
                            btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
                            btn.innerHTML = 'Continue Blueprint <i class="fas fa-chevron-right ml-2"></i>';
                        }
                     }
                }
                
                restoreInputs();
                updateAssetsSidebar();
            }

            // 3. FORCE START ON PHASE 1 (The Fix)
            changePhase(1); 
        };

        // --- MOBILE SIDEBAR TOGGLE ---
        function toggleSidebar() {
            const sidebar = document.getElementById('main-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isClosed = sidebar.classList.contains('-translate-x-full');
            
            if(isClosed) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        }
        
        // --- NEW SESSION LOGIC ---
        function startNewSession() {
            if(confirm("Start a new story? This will erase your current work.")) {
                SafeStorage.removeItem('storyArchProgress');
                // Reset State
                storyData = { selectedPrompt: null, assets: {}, drafts: {} };
                // Wipe Inputs
                document.querySelectorAll('textarea, input').forEach(el => el.value = '');
                document.getElementById('final-editor').innerText = '';
                document.getElementById('sidebar-mission-text').innerText = 'No prompt selected.';
                // Reset Phase 1 selection visuals
                document.querySelectorAll('.deck-card').forEach(c => c.classList.remove('selected'));
                document.getElementById('start-btn').disabled = true;
                document.getElementById('start-btn').classList.add('bg-gray-400', 'cursor-not-allowed');
                document.getElementById('start-btn').innerHTML = 'Initialize Blueprint <i class="fas fa-chevron-right ml-2"></i>';
                
                updateAssetsSidebar();
                changePhase(1);
            }
        }

        // --- WORKSHEET GENERATOR (LINED PAPER) ---
        function generateWorksheet() {
            const archetypes = {};
            config.examPrompts.forEach(p => {
                if(!archetypes[p.type]) archetypes[p.type] = [];
                archetypes[p.type].push(p.text);
            });
            
            let selectedPrompts = [];
            ['Decision', 'Event', 'Journey', 'Constraint'].forEach(type => {
                if(archetypes[type] && archetypes[type].length > 0) {
                    const randomIdx = Math.floor(Math.random() * archetypes[type].length);
                    selectedPrompts.push(archetypes[type][randomIdx]);
                }
            });
            
            if(selectedPrompts.length < 4) {
                 const all = config.examPrompts.map(p => p.text);
                 for(let i=0; i<all.length && selectedPrompts.length < 4; i++) {
                     if(!selectedPrompts.includes(all[i])) selectedPrompts.push(all[i]);
                 }
            }
            
            // Helper to generate a lined table
            const createLinedTable = (rows) => {
                let table = `<table style='width:100%; border-collapse: collapse; margin-top:5px; margin-bottom:15px; border: 1px solid #000;'>`;
                for(let i=0; i<rows; i++) {
                    table += `<tr><td style='height: 30px; border-bottom: 1px solid #ccc;'>&nbsp;</td></tr>`;
                }
                table += `</table>`;
                return table;
            };

            let html = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
            <head><meta charset='utf-8'><title>${config.appTitle} Worksheet</title>
            <style>
                body { font-family: Arial, sans-serif; font-size: 11pt; }
                h1 { color: #2c5282; font-size: 16pt; border-bottom: 2px solid #2c5282; padding-bottom: 5px; margin-bottom: 10px; }
                h2 { color: #2b6cb0; font-size: 12pt; margin-top: 15px; background: #ebf8ff; padding: 3px; border-bottom: 1px solid #bee3f8; }
                p { margin-top: 5px; margin-bottom: 5px; font-size: 10pt; color: #4a5568; }
                .prompt-box { border: 1px solid #cbd5e1; padding: 5px; margin-bottom: 5px; background: #f8fafc; font-size: 10pt; }
                .checkbox { width: 12px; height: 12px; border: 1px solid #000; display: inline-block; margin-right: 5px; }
                ul { margin-top: 0; padding-left: 20px; font-size: 10pt; color: #555; }
                li { margin-bottom: 2px; }
            </style>
            </head><body>
            <h1>${config.appTitle} - Planning Worksheet</h1>
            
            <h2>1. SELECT YOUR MISSION</h2>
            <p>Choose <strong>ONE</strong> of the following exam prompts to answer:</p>
            ${selectedPrompts.map(p => `<div class='prompt-box'><span class='checkbox'>&nbsp;</span> ${p}</div>`).join('')}

            <h2>2. THE BLUEPRINT</h2>
            <p>Plan your core story elements.</p>
            ${config.blueprintPrompts.map(p => `
                <p><strong>${p.title}:</strong> ${p.prompt}</p>
                ${createLinedTable(3)}
            `).join('')}

            <br style="page-break-before: always;">

            <h2>3. CONSTRUCTION</h2>
            <p>Build your narrative arc.</p>
            ${config.structureSteps.map(s => `
                <p><strong>${s.title}</strong></p>
                <p><em>Guidance: ${s.guidance}</em></p>
                <ul>
                    ${s.strips ? s.strips.map(strip => `<li>${strip}</li>`).join('') : ''}
                </ul>
                ${createLinedTable(6)}
            `).join('')}
            </body></html>`;

            const blob = new Blob(['\ufeff', html], { type: 'application/msword' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${config.appTitle.replace(/[^a-z0-9]/gi, '_')}_worksheet.doc`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }

        // --- RENDERERS ---
        function renderPhase1() {
            const container = document.getElementById('deck-grid');
            container.innerHTML = '';
            
            const categories = { 'Decision': [], 'Event': [], 'Journey': [], 'Constraint': [] };
            
            // Build categories from config
            config.examPrompts.forEach(p => { 
                const type = p.type || 'Event';
                if(!categories[type]) categories[type] = [];
                categories[type].push(p.text); 
            });

            Object.keys(categories).forEach(type => {
                if(!deckState.hasOwnProperty(type)) deckState[type] = 0;
            });

            for (const [type, prompts] of Object.entries(categories)) {
                if(prompts.length === 0) continue;
                if(deckState[type] >= prompts.length) deckState[type] = 0;
                const currentText = prompts[deckState[type]];
                
                const headerClass = `header-${type}` in { 'header-Decision':1, 'header-Event':1, 'header-Journey':1, 'header-Constraint':1 } ? `header-${type}` : 'header-Default';

                container.innerHTML += `
                    <div class="deck-card group" id="card-${type}" onclick="selectDeck('${type}', '${currentText.replace(/'/g, "\\'")}')">
                        <div class="deck-header ${headerClass}">
                            <span>${type}</span>
                            <span class="text-sm font-bold opacity-100">${deckState[type] + 1}/${prompts.length}</span>
                        </div>
                        <div class="deck-body">
                            <button onclick="prevPrompt(event, '${type}')" class="nav-arrow nav-left"><i class="fas fa-chevron-left"></i></button>
                            <p class="px-8 leading-snug font-serif text-lg" id="text-${type}">"${currentText}"</p>
                            <button onclick="nextPrompt(event, '${type}')" class="nav-arrow nav-right"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                `;
            }
        }

        function renderPhase2() {
            const container = document.getElementById('blueprint-inputs');
            container.innerHTML = '';
            config.blueprintPrompts.forEach(p => {
                container.innerHTML += `
                    <div class="bg-white border p-4 rounded shadow-sm">
                        <label class="block text-blue-800 font-bold mb-1">${p.title}</label>
                        <p class="text-xs text-gray-500 mb-2">${p.prompt}</p>
                        <textarea id="input-${p.id}" class="w-full border bg-gray-50 p-2 rounded h-24 focus:ring-2 ring-blue-300 outline-none" oninput="saveProgress()"></textarea>
                    </div>
                `;
            });
        }

        function renderPhase3() {
            const container = document.getElementById('structure-inputs');
            container.innerHTML = '';
            
            config.structureSteps.forEach((s, stepIndex) => {
                let stripsHtml = '';
                
                if(s.strips && s.strips.length > 0) {
                    s.strips.forEach((stripPrompt, stripIndex) => {
                        stripsHtml += `
                            <div class="mb-3">
                                <label class="block text-xs font-bold text-gray-500 mb-1 pl-2 border-l-2 border-gray-300 uppercase">${stripPrompt}</label>
                                <input id="strip-${stepIndex}-${stripIndex}" class="w-full p-2 bg-white border border-gray-200 rounded strip-input focus:outline-none" placeholder="..." oninput="updateLivePreview(${stepIndex})">
                            </div>
                        `;
                    });
                } else {
                    stripsHtml = `<textarea id="draft-step-${stepIndex}" class="w-full border p-3 rounded h-32" oninput="saveProgress()"></textarea>`;
                }

                container.innerHTML += `
                    <div class="border-l-4 border-green-500 pl-4 py-2 bg-gray-50 rounded pr-4">
                        <label class="block text-lg font-bold text-gray-800 mb-1">${s.title}</label>
                        <p class="text-sm text-gray-500 mb-4"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i> ${s.guidance}</p>
                        
                        <div class="space-y-2">
                            ${stripsHtml}
                        </div>

                        <!-- Live Preview -->
                        <div class="mt-4 p-3 bg-white border border-green-200 rounded">
                            <h4 class="text-xs font-bold text-green-600 uppercase mb-1">Paragraph Preview:</h4>
                            <p id="preview-step-${stepIndex}" class="text-sm font-serif text-gray-800 italic preview-box min-h-[1.5rem] opacity-50">Start typing above...</p>
                        </div>
                    </div>
                `;
            });
        }

        function updateAssetsSidebar() {
            const container = document.getElementById('assets-container');
            container.innerHTML = '';
            
            config.blueprintPrompts.forEach(p => {
                const val = storyData.assets[p.id];
                if(val && val.trim().length > 0) {
                    container.innerHTML += `
                        <div class="asset-card" onclick="insertAsset('${val.replace(/'/g, "\\'")}')">
                            <div class="font-bold text-blue-200 text-xs mb-1">${p.title}</div>
                            <div class="text-white italic">"${val.substring(0, 50)}${val.length>50?'...':''}"</div>
                        </div>
                    `;
                }
            });
        }

        // --- LOGIC ---
        function updateLivePreview(stepIndex) {
            const step = config.structureSteps[stepIndex];
            if(!step.strips) return;
            
            let text = "";
            step.strips.forEach((_, stripIndex) => {
                const el = document.getElementById(`strip-${stepIndex}-${stripIndex}`);
                if(el && el.value.trim()) text += el.value.trim() + " ";
            });
            
            const previewEl = document.getElementById(`preview-step-${stepIndex}`);
            if(text) {
                previewEl.innerText = text;
                previewEl.classList.remove('opacity-50');
            } else {
                previewEl.innerText = "Start typing above...";
                previewEl.classList.add('opacity-50');
            }
            saveProgress();
        }

        function nextPrompt(e, type) {
            e.stopPropagation();
            const prompts = config.examPrompts.filter(p => p.type === type);
            // Dynamic State Check
            if (deckState[type] === undefined) deckState[type] = 0;
            deckState[type] = (deckState[type] + 1) % prompts.length;
            renderPhase1();
            
            // Re-apply selection if this card matches the selected prompt
            const currentText = prompts[deckState[type]];
            if(currentText === storyData.selectedPrompt) {
                 document.getElementById(`card-${type}`).classList.add('selected');
            }
        }

        function prevPrompt(e, type) {
            e.stopPropagation();
            const prompts = config.examPrompts.filter(p => p.type === type);
            if (deckState[type] === undefined) deckState[type] = 0;
            deckState[type] = (deckState[type] - 1 + prompts.length) % prompts.length;
            renderPhase1();

            // Re-apply selection
            const currentText = prompts[deckState[type]];
            if(currentText === storyData.selectedPrompt) {
                 document.getElementById(`card-${type}`).classList.add('selected');
            }
        }

        function selectDeck(type, text) {
            storyData.selectedPrompt = text;
            document.querySelectorAll('.deck-card').forEach(c => c.classList.remove('selected'));
            document.getElementById(`card-${type}`).classList.add('selected');
            
            const btn = document.getElementById('start-btn');
            btn.disabled = false;
            btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }

        function confirmPrompt(silent = false) {
            if(!storyData.selectedPrompt) return;
            document.getElementById('sidebar-mission-text').innerText = `"${storyData.selectedPrompt}"`;
            changePhase(2);
            if(!silent) saveProgress();
        }

        function changePhase(n) {
            document.querySelectorAll('[id^="phase-"]').forEach(el => el.classList.add('hidden'));
            
            const targetId = `phase-${n}`;
            const targetEl = document.getElementById(targetId);
            if(targetEl) targetEl.classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-p${n}`).classList.add('active');

            if(n === 3) updateAssetsSidebar();
        }

        function saveProgress() {
            // Blueprint
            config.blueprintPrompts.forEach(p => {
                const el = document.getElementById(`input-${p.id}`);
                if(el) storyData.assets[p.id] = el.value;
            });
            // Construction (Strips)
            config.structureSteps.forEach((s, stepIndex) => {
                if(s.strips) {
                    s.strips.forEach((_, stripIndex) => {
                         const el = document.getElementById(`strip-${stepIndex}-${stripIndex}`);
                         if(el) storyData.drafts[`${stepIndex}-${stripIndex}`] = el.value;
                    });
                }
            });
            
            SafeStorage.setItem('storyArchProgress', JSON.stringify(storyData));
            updateAssetsSidebar();
        }

        function restoreInputs() {
            if(storyData.selectedPrompt) document.getElementById('sidebar-mission-text').innerText = `"${storyData.selectedPrompt}"`;
            
            config.blueprintPrompts.forEach(p => {
                const el = document.getElementById(`input-${p.id}`);
                if(el && storyData.assets[p.id]) el.value = storyData.assets[p.id];
            });
            
            // Restore Strips
            config.structureSteps.forEach((s, stepIndex) => {
                if(s.strips) {
                    s.strips.forEach((_, stripIndex) => {
                         const el = document.getElementById(`strip-${stepIndex}-${stripIndex}`);
                         const val = storyData.drafts[`${stepIndex}-${stripIndex}`];
                         if(el && val) {
                             el.value = val;
                         }
                    });
                    updateLivePreview(stepIndex);
                }
            });
        }

        function compileStory() {
            let fullText = "";
            config.structureSteps.forEach((s, stepIndex) => {
                let para = "";
                if(s.strips) {
                    s.strips.forEach((_, stripIndex) => {
                        const val = storyData.drafts[`${stepIndex}-${stripIndex}`];
                        if(val) para += val.trim() + " ";
                    });
                }
                if(para.trim()) fullText += para + "\n\n";
            });
            
            const editor = document.getElementById('final-editor');
            if(editor.innerText.trim() === "" || confirm("Overwrite current draft?")) {
                editor.innerText = fullText;
                changePhase(4); 
            }
        }
        
        function reCompile() {
             compileStory();
        }

        function insertAsset(text) {
             try { navigator.clipboard.writeText(text).then(() => alert("Copied!")); } catch(e) { prompt("Copy:", text); }
        }

        // --- TOOLS ---
        function analyzeDialogue() {
            const editor = document.getElementById('final-editor');
            let html = editor.innerText;
            html = html.replace(/(".*?")/g, '<span class="highlight-good">$1</span>');
            editor.innerHTML = html;
            feedback("Dialogue highlighted.");
        }

        function checkSpelling() {
            const editor = document.getElementById('final-editor');
            const isSpell = editor.getAttribute('spellcheck') === 'true';
            editor.setAttribute('spellcheck', !isSpell);
            feedback(`Native Spellcheck: ${!isSpell ? 'ON' : 'OFF'}`);
        }

        function feedback(msg) { document.querySelector('#inspection-feedback span').innerText = msg; }
        
        function downloadStory() {
            const text = document.getElementById('final-editor').innerText;
            const blob = new Blob([text], {type: 'text/plain'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'my_story_draft.txt'; a.click();
        }

        // --- ADMIN FUNCTIONS ---
        function toggleAdmin() {
            const m = document.getElementById('admin-modal'); m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) {
                document.getElementById('admin-lock').classList.remove('hidden');
                document.getElementById('admin-unlocked').classList.add('hidden');
                document.getElementById('admin-footer').classList.add('hidden');
                document.getElementById('admin-pass').value = '';
                if(config.adminPass === 'ChiefInspector') document.getElementById('pass-hint').classList.remove('hidden');
            }
        }
        function unlockAdmin() {
            if(document.getElementById('admin-pass').value === config.adminPass) {
                document.getElementById('admin-lock').classList.add('hidden');
                document.getElementById('admin-unlocked').classList.remove('hidden');
                document.getElementById('admin-footer').classList.remove('hidden');
                renderAdminUI();
            } else alert("Access Denied");
        }
        function showTab(id) {
            ['prompts','structure','exam'].forEach(t => document.getElementById(`tab-${t}`).classList.add('hidden'));
            document.getElementById(`tab-${id}`).classList.remove('hidden');
        }

        function renderAdminUI() {
            document.getElementById('edit-title').value = config.appTitle;
            document.getElementById('edit-pass').value = config.adminPass;

            // Prompts
            const pc = document.getElementById('prompts-editor'); pc.innerHTML = '';
            config.blueprintPrompts.forEach((p, i) => {
                pc.innerHTML += `<div class="bg-white p-2 rounded border mb-2"><input class="w-full text-xs font-bold border-b mb-1 p-title" value="${p.title.replace(/"/g, '&quot;')}" placeholder="Title"><input class="w-full text-xs text-gray-600 p-prompt" value="${p.prompt.replace(/"/g, '&quot;')}" placeholder="Prompt"><button onclick="delPrompt(${i})" class="text-red-500 font-bold text-xs mt-1">Delete</button></div>`;
            });

            // Structure (with Strips)
            const sc = document.getElementById('structure-editor'); sc.innerHTML = '';
            config.structureSteps.forEach((s, i) => {
                // Join strips for editing
                const stripsText = s.strips ? s.strips.join('\n') : "";
                sc.innerHTML += `
                    <div class="bg-white p-3 rounded border mb-4">
                        <div class="flex justify-between mb-2">
                            <input class="font-bold text-sm border-b s-title w-1/2" value="${s.title.replace(/"/g, '&quot;')}" placeholder="Step Title">
                            <button onclick="delStep(${i})" class="text-red-500 font-bold text-xs">Delete Step</button>
                        </div>
                        <input class="w-full text-xs text-gray-600 s-guide mb-2 border rounded p-1" value="${s.guidance.replace(/"/g, '&quot;')}" placeholder="Guidance">
                        <label class="block text-xs font-bold text-blue-600 mb-1">Micro-Prompts (One per line)</label>
                        <textarea class="w-full text-xs border rounded p-2 h-20 s-strips" placeholder="Enter strips...">${stripsText}</textarea>
                    </div>
                `;
            });

            // Exam Prompts
            const ec = document.getElementById('exam-editor'); ec.innerHTML = '';
            config.examPrompts.forEach((e, i) => {
                 // FIX: Corrected template string interpolation here
                 ec.innerHTML += `<div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option ${e.type==='Decision'?'selected':''}>Decision</option><option ${e.type==='Event'?'selected':''}>Event</option><option ${e.type==='Journey'?'selected':''}>Journey</option><option ${e.type==='Constraint'?'selected':''}>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="${e.text.replace(/"/g, '&quot;')}"/><button onclick="delExamPrompt(${i})" class="text-red-500 font-bold">&times;</button></div>`;
            });
        }

        // Actions
        function addPrompt() { config.blueprintPrompts.push({id: "p"+Date.now(), title:"", prompt:""}); renderAdminUI(); }
        function delPrompt(i) { if(confirm('Delete?')) { config.blueprintPrompts.splice(i,1); renderAdminUI(); } }
        function addStep() { config.structureSteps.push({title:"", guidance:"", strips:[]}); renderAdminUI(); }
        function delStep(i) { if(confirm('Delete?')) { config.structureSteps.splice(i,1); renderAdminUI(); } }
        function addExamPrompt() { config.examPrompts.push({type:"Decision", text:""}); renderAdminUI(); }
        function delExamPrompt(i) { if(confirm('Delete?')) { config.examPrompts.splice(i,1); renderAdminUI(); } }

        function collectConfig() {
            config.appTitle = document.getElementById('edit-title').value;
            config.adminPass = document.getElementById('edit-pass').value;
            
            // Collect Prompts
            const newPrompts = [];
            document.querySelectorAll('#prompts-editor > div').forEach((row, i) => {
                newPrompts.push({ id: "p"+i, title: row.querySelector('.p-title').value, prompt: row.querySelector('.p-prompt').value });
            });
            config.blueprintPrompts = newPrompts;

            // Collect Structure & Strips
            const newSteps = [];
            document.querySelectorAll('#structure-editor > div').forEach(row => {
                const rawStrips = row.querySelector('.s-strips').value;
                const stripsArray = rawStrips.split('\n').filter(l => l.trim() !== "");
                newSteps.push({ 
                    title: row.querySelector('.s-title').value, 
                    guidance: row.querySelector('.s-guide').value,
                    strips: stripsArray
                });
            });
            config.structureSteps = newSteps;

            // Collect Exam Prompts
            const newExam = [];
            document.querySelectorAll('#exam-editor > div').forEach(row => {
                newExam.push({ type: row.querySelector('.e-type').value, text: row.querySelector('.e-text').value });
            });
            config.examPrompts = newExam;
        }

        function saveLocal() { collectConfig(); SafeStorage.setItem('storyArchConfig', JSON.stringify(config)); alert("Saved!"); location.reload(); }
        
        // --- CLEAN EXPORT ---
        function prepareDOMForExport() {
            collectConfig();
            document.getElementById('app-config').textContent = JSON.stringify(config, null, 4);
            
            // Reset UI
            document.getElementById('admin-modal').classList.add('hidden');
            document.getElementById('admin-lock').classList.remove('hidden');
            document.getElementById('admin-unlocked').classList.add('hidden');
            document.getElementById('admin-footer').classList.add('hidden');
            document.getElementById('admin-pass').value = '';

            // CRITICAL: WIPE STUDENT INPUTS FROM DOM BEFORE EXPORT
            document.querySelectorAll('input[type="text"], textarea').forEach(el => {
                // Skip admin inputs, focus on game inputs
                if(!el.classList.contains('admin-input') && !el.classList.contains('e-text')) {
                    el.value = ""; 
                    el.setAttribute('value', ''); // Ensure attribute is cleared for outerHTML
                    el.innerText = ""; // For textareas
                }
            });
            document.getElementById('final-editor').innerText = "";
        }

        function exportFile() {
            prepareDOMForExport();
            const html = document.documentElement.outerHTML;
            const blob = new Blob([html], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `story_architect_custom.html`; a.click(); location.reload();
        }

        function copySource() {
            prepareDOMForExport();
            const html = document.documentElement.outerHTML;
            const ta = document.createElement("textarea"); ta.value = html; document.body.appendChild(ta); ta.select(); 
            try { document.execCommand('copy'); alert("Copied!"); } catch(e) { prompt("Copy:", html); }
            document.body.removeChild(ta); location.reload();
        }

        function resetDefaults() { if(confirm('Reset?')) { SafeStorage.removeItem('storyArchConfig'); location.reload(); } }
    </script>


</body><grammarly-desktop-integration data-grammarly-shadow-root="true"></grammarly-desktop-integration></html>
