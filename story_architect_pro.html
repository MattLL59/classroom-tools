<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Architect Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Architects+Daughter&family=Roboto:wght@300;400;700&display=swap');

        /* Utility Fixes */
        .hidden { display: none !important; }
        
        body { background-color: #f0f4f8; font-family: 'Roboto', sans-serif; color: #333; height: 100vh; overflow: hidden; }
        
        /* Blueprint Paper Style */
        .blueprint-bg {
            background-color: #2c5282;
            background-image: 
                linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 20px 20px;
            color: white;
        }

        .handwritten { font-family: 'Architects Daughter', cursive; }

        /* Sidebar Assets */
        .asset-card {
            background: rgba(255,255,255,0.1);
            border-left: 4px solid #63b3ed;
            padding: 10px; margin-bottom: 10px;
            font-size: 0.85rem; cursor: pointer;
            transition: all 0.2s;
        }
        .asset-card:hover { background: rgba(255,255,255,0.2); transform: translateX(5px); }

        /* Archetype Deck Card */
        .deck-card {
            background: white; border: 1px solid #e2e8f0; border-radius: 8px; 
            padding: 0; display: flex; flex-direction: column; height: 180px;
            position: relative; overflow: hidden; transition: all 0.2s;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        }
        .deck-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1); border-color: #3b82f6; }
        .deck-card.selected { border: 3px solid #2563eb; background-color: #eff6ff; }
        
        .deck-header {
            padding: 8px 12px; font-weight: bold; font-size: 14px; text-transform: uppercase; color: white;
            display: flex; justify-content: space-between; align-items: center;
        }
        /* Theme Colors for Headers */
        .header-Decision { background-color: #ef4444; } /* Red */
        .header-Event { background-color: #f59e0b; }    /* Amber */
        .header-Journey { background-color: #10b981; }  /* Green */
        .header-Constraint { background-color: #8b5cf6; } /* Purple */

        .deck-body {
            flex-grow: 1; padding: 15px; display: flex; align-items: center; justify-content: center;
            text-align: center; font-size: 16px; color: #334155; position: relative;
        }
        
        .nav-arrow {
            position: absolute; top: 50%; transform: translateY(-50%);
            background: rgba(255,255,255,0.8); border-radius: 50%; width: 30px; height: 30px;
            display: flex; align-items: center; justify-content: center; cursor: pointer;
            color: #64748b; border: 1px solid #cbd5e1; z-index: 10;
        }
        .nav-arrow:hover { background: #2563eb; color: white; border-color: #2563eb; }
        .nav-left { left: 10px; }
        .nav-right { right: 10px; }

        /* Modal */
        .modal-overlay {
            background: rgba(0,0,0,0.8);
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50; display: flex; justify-content: center; align-items: center;
        }

        /* Editor Highlights */
        .highlight-error { background-color: #fecaca; border-bottom: 2px solid #ef4444; } 
        .highlight-warning { background-color: #fef08a; border-bottom: 2px solid #eab308; } 
        .highlight-good { background-color: #bbf7d0; border-bottom: 2px solid #22c55e; } 

        /* Tabs */
        .tab-btn { opacity: 0.6; transition: 0.2s; }
        .tab-btn.active { opacity: 1; border-bottom: 3px solid #63b3ed; font-weight: bold; }
    </style>
</head>
<body class="flex flex-col">

    <!-- CONFIG BLOCK -->
    <script id="app-config" type="application/json">
    {
        "adminPass": "ChiefInspector",
        "appTitle": "STORY ARCHITECT: PRO",
        "examPrompts": [
            { "type": "Decision", "text": "Write about a time when you had to be brave." },
            { "type": "Decision", "text": "Write about a time when you had to make a difficult choice." },
            { "type": "Decision", "text": "Write about a time when you broke the rules." },
            { "type": "Decision", "text": "Write about a time when you challenged an unfair situation." },
            { "type": "Decision", "text": "Write a story with the title: The Choice." },
            { "type": "Decision", "text": "Write a story with the title: The Rebel." },
            
            { "type": "Event", "text": "Write about a time when you saw something surprising." },
            { "type": "Event", "text": "Write about a time when you lost your temper." },
            { "type": "Event", "text": "Write about a time when you felt let down by a friend." },
            { "type": "Event", "text": "Write a story with the title: The Storm." },
            { "type": "Event", "text": "Write a story with the title: The Wedding." },
            { "type": "Event", "text": "Write a story with the title: The Competition." },
            { "type": "Event", "text": "Write a story with the title: A Memorable Weekend." },

            { "type": "Journey", "text": "Write about a time when you visited a new place." },
            { "type": "Journey", "text": "Write about a time when you went on a long journey." },
            { "type": "Journey", "text": "Write a story with the title: A New Start." },
            { "type": "Journey", "text": "Write a story with the title: Everything Had Changed." },
            { "type": "Journey", "text": "Write a story beginning with: 'It was a new day...'" },

            { "type": "Constraint", "text": "Write a story beginning with: 'It was an unusual gift...'" },
            { "type": "Constraint", "text": "Write a story beginning with: 'Suddenly, without warning, there was a power cut.'" },
            { "type": "Constraint", "text": "Write a story beginning with: 'I wish I had never agreed to this...'" },
            { "type": "Constraint", "text": "Write a story ending with: '...and I knew I had no choice.'" },
            { "type": "Constraint", "text": "Write a story ending with: '...and that was the worst job of my life.'" },
            { "type": "Constraint", "text": "Write a story ending with: '...and I felt so sorry for myself.'" }
        ],
        "blueprintPrompts": [
            { "id": "p1", "title": "Setting the Scene", "prompt": "Describe a setting relevant to your chosen prompt. Focus on weather and sounds to create atmosphere." },
            { "id": "p2", "title": "Character Building", "prompt": "Who is your protagonist? What is their biggest fear or weakness?" },
            { "id": "p3", "title": "Relationships", "prompt": "Write a line of dialogue where someone is hiding a secret from your protagonist." },
            { "id": "p4", "title": "Building Tension", "prompt": "Describe a sensory detail (smell or touch) that signals a problem is starting." }
        ],
        "structureSteps": [
            { "title": "1. The Opening (Setting the Scene)", "guidance": "Introduce the situation and the setting. Establish the atmosphere before the main action begins." },
            { "title": "2. The Hook (Rising Tension)", "guidance": "Start the action. Something shifts or goes wrong. Use your 'Building Tension' sensory detail here." },
            { "title": "3. The Complication", "guidance": "Introduce the conflict or the 'Moment of Change' required by the prompt. Use your 'Relationship' dialogue here." },
            { "title": "4. The Climax", "guidance": "The highest tension point. The character faces their fear or makes the decision." },
            { "title": "5. Falling Action", "guidance": "The immediate aftermath. How has the atmosphere changed?" },
            { "title": "6. Resolution", "guidance": "A twist or reflection. Link back to the prompt's key theme." }
        ]
    }
    </script>

    <!-- HEADER -->
    <header class="bg-gray-900 text-white p-4 shadow-md flex justify-between items-center z-20">
        <div class="flex items-center gap-3">
            <i class="fas fa-drafting-compass text-3xl text-blue-400"></i>
            <div>
                <h1 id="header-title" class="text-xl font-bold tracking-widest uppercase">STORY ARCHITECT</h1>
                <p class="text-xs text-gray-400">GCSE COMPONENT 1 BUILDER</p>
            </div>
        </div>
        <div class="flex gap-4 text-sm">
            <button onclick="changePhase(1)" id="nav-p1" class="tab-btn active">1. MISSION</button>
            <button onclick="changePhase(2)" id="nav-p2" class="tab-btn">2. BLUEPRINT</button>
            <button onclick="changePhase(3)" id="nav-p3" class="tab-btn">3. CONSTRUCT</button>
            <button onclick="changePhase(4)" id="nav-p4" class="tab-btn">4. INSPECT</button>
            <button onclick="toggleAdmin()" class="text-gray-500 hover:text-white ml-4"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <!-- CONTENT AREA -->
    <div class="flex flex-grow overflow-hidden relative">
        
        <!-- SIDEBAR (Assets & Info) -->
        <aside class="w-1/4 blueprint-bg p-4 flex flex-col overflow-y-auto z-10 shadow-xl">
            
            <!-- MISSION DISPLAY -->
            <div class="bg-blue-900 bg-opacity-50 border border-blue-400 p-3 rounded mb-4 shadow-inner">
                <h3 class="text-blue-300 text-xs font-bold uppercase tracking-wider mb-1"><i class="fas fa-crosshairs mr-1"></i> Current Mission</h3>
                <p id="sidebar-mission-text" class="text-white text-sm font-serif italic">No prompt selected.</p>
                <!-- Clear selection button -->
                <button onclick="changePhase(1)" class="mt-2 text-xs text-blue-300 hover:text-white underline">Change Prompt</button>
            </div>

            <h2 class="text-blue-300 font-bold mb-4 border-b border-blue-500 pb-2">PROJECT ASSETS</h2>
            <div id="assets-container" class="space-y-4">
                <p class="text-xs text-blue-200 italic">Complete Phase 2 to generate your story assets here.</p>
            </div>
            
            <div class="mt-auto pt-6">
                <h3 class="text-blue-300 font-bold mb-2 text-sm">TOOLS</h3>
                <button onclick="checkSpelling()" class="w-full bg-blue-600 hover:bg-blue-500 text-white text-xs py-2 rounded mb-2 text-left px-3">
                    <i class="fas fa-check-double mr-2"></i> Run Spell Check
                </button>
                <button onclick="analyzeDialogue()" class="w-full bg-green-600 hover:bg-green-500 text-white text-xs py-2 rounded mb-2 text-left px-3">
                    <i class="fas fa-comments mr-2"></i> Dialogue Validator
                </button>
            </div>
        </aside>

        <!-- MAIN WORKSPACE -->
        <main class="w-3/4 bg-white relative">

            <!-- PHASE 1: PROMPT SELECTION -->
            <div id="phase-1" class="absolute inset-0 p-8 overflow-y-auto bg-gray-50">
                <div class="max-w-5xl mx-auto">
                    <h2 class="text-3xl font-bold text-gray-800 mb-2">1. Select Your Mission</h2>
                    <p class="text-gray-500 mb-8">Choose an archetype below. Use arrows to browse specific questions.</p>
                    
                    <div id="deck-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <!-- Archetype Decks Injected Here -->
                    </div>

                    <button id="start-btn" onclick="confirmPrompt()" class="mt-8 w-full bg-gray-400 text-white px-8 py-4 rounded-lg font-bold shadow-lg transition cursor-not-allowed" disabled>
                        Initialize Blueprint <i class="fas fa-chevron-right ml-2"></i>
                    </button>
                </div>
            </div>
            
            <!-- PHASE 2: BLUEPRINT (Skill Prompts) -->
            <div id="phase-2" class="absolute inset-0 p-8 overflow-y-auto hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">2. The Blueprint</h2>
                <p class="text-gray-500 mb-8">Define the core elements. Ensure they fit your selected prompt.</p>
                
                <div id="blueprint-inputs" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- Injected via JS -->
                </div>
                
                <button onclick="changePhase(3)" class="mt-8 bg-blue-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:bg-blue-700 float-right">
                    Proceed to Construction <i class="fas fa-arrow-right ml-2"></i>
                </button>
            </div>

            <!-- PHASE 3: CONSTRUCTION (Structure) -->
            <div id="phase-3" class="absolute inset-0 p-8 overflow-y-auto hidden">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">3. Construction</h2>
                <p class="text-gray-500 mb-6">Assemble your story using the structure below. Refer to your assets on the left.</p>
                
                <div id="structure-inputs" class="space-y-6">
                    <!-- Injected via JS -->
                </div>

                <button onclick="compileStory()" class="mt-8 bg-green-600 text-white px-8 py-3 rounded-lg font-bold shadow-lg hover:bg-green-700 float-right">
                    Compile Draft <i class="fas fa-hammer ml-2"></i>
                </button>
            </div>

            <!-- PHASE 4: INSPECTION (Full Text) -->
            <div id="phase-4" class="absolute inset-0 p-8 overflow-y-auto hidden">
                <div class="h-full flex flex-col">
                    <div class="flex justify-between items-end mb-4">
                        <div>
                            <h2 class="text-2xl font-bold text-gray-800">4. Inspection</h2>
                            <p class="text-gray-500">Review, refine, and check your work.</p>
                        </div>
                        <div class="flex gap-2">
                             <button onclick="compileStory()" class="bg-blue-100 text-blue-700 border border-blue-300 px-4 py-2 rounded text-sm hover:bg-blue-200"><i class="fas fa-sync mr-2"></i> Refresh from Phase 3</button>
                             <button onclick="downloadStory()" class="bg-gray-800 text-white px-4 py-2 rounded text-sm"><i class="fas fa-file-download mr-2"></i> Download</button>
                        </div>
                    </div>

                    <div class="flex-grow relative">
                        <div id="final-editor" contenteditable="true" class="w-full h-full border p-6 rounded bg-gray-50 font-serif text-lg leading-relaxed focus:outline-none focus:bg-white focus:ring-2 ring-blue-200 overflow-y-auto" spellcheck="false"></div>
                    </div>
                    
                    <div id="inspection-feedback" class="h-16 mt-4 bg-gray-100 rounded border border-gray-300 p-3 flex items-center text-sm text-gray-600">
                        <i class="fas fa-info-circle text-blue-500 text-xl mr-3"></i>
                        <span>Ready for inspection. Click 'Dialogue Validator' or 'Spell Check' on the left.</span>
                    </div>
                </div>
            </div>

        </main>
    </div>

    <!-- ADMIN MODAL -->
    <div id="admin-modal" class="modal-overlay hidden">
        <div class="bg-white w-full max-w-4xl h-5/6 rounded-lg shadow-2xl flex flex-col overflow-hidden">
            <div class="bg-gray-100 p-4 border-b flex justify-between items-center">
                <h2 class="font-bold text-lg text-gray-700">Chief Architect Admin Panel</h2>
                <button onclick="toggleAdmin()" class="text-gray-500 hover:text-red-500 text-2xl">&times;</button>
            </div>
            
            <!-- Lock Screen -->
            <div id="admin-lock" class="flex-grow flex flex-col justify-center items-center">
                <p class="text-gray-500 mb-4">Enter password to configure blueprint.</p>
                <div id="pass-hint" class="bg-yellow-100 text-yellow-800 p-2 rounded text-xs mb-4 hidden">Default: ChiefInspector</div>
                <input type="password" id="admin-pass" class="border p-2 rounded w-64 text-center mb-4" placeholder="Password">
                <button onclick="unlockAdmin()" class="bg-blue-600 text-white px-6 py-2 rounded font-bold">UNLOCK</button>
            </div>

            <!-- Unlocked Screen -->
            <div id="admin-unlocked" class="hidden flex-grow overflow-y-auto p-6 space-y-6">
                
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs font-bold text-gray-500">App Title</label>
                        <input id="edit-title" class="w-full border p-2 rounded">
                    </div>
                    <div>
                        <label class="text-xs font-bold text-gray-500">Admin Password</label>
                        <input id="edit-pass" class="w-full border p-2 rounded" autocomplete="off">
                    </div>
                </div>
                
                <!-- TABS -->
                 <div class="flex border-b">
                    <button class="px-4 py-2 text-sm font-bold text-blue-600 border-b-2 border-blue-600" onclick="showTab('prompts')">Questions</button>
                    <button class="px-4 py-2 text-sm font-bold text-gray-500 hover:text-blue-600" onclick="showTab('exam')">Exam Prompts</button>
                </div>

                <!-- Prompts Editor -->
                <div id="tab-prompts" class="space-y-6">
                    <div class="border p-4 rounded bg-blue-50">
                        <h3 class="font-bold text-blue-800 mb-2">Phase 2: Skill Prompts</h3>
                        <div id="prompts-editor" class="space-y-3"></div>
                        <button onclick="addPrompt()" class="mt-2 text-xs bg-blue-600 text-white px-2 py-1 rounded">+ Add Prompt</button>
                    </div>

                    <div class="border p-4 rounded bg-green-50">
                        <h3 class="font-bold text-green-800 mb-2">Phase 3: Structure Steps</h3>
                        <div id="structure-editor" class="space-y-3"></div>
                        <button onclick="addStep()" class="mt-2 text-xs bg-green-600 text-white px-2 py-1 rounded">+ Add Step</button>
                    </div>
                </div>

                <!-- Exam Prompts Editor -->
                <div id="tab-exam" class="hidden border p-4 rounded bg-purple-50">
                    <h3 class="font-bold text-purple-800 mb-2">Phase 1: Exam Questions</h3>
                    <div id="exam-editor" class="space-y-3"></div>
                    <button onclick="addExamPrompt()" class="mt-2 text-xs bg-purple-600 text-white px-2 py-1 rounded">+ Add Question</button>
                </div>

            </div>

            <!-- Footer -->
            <div id="admin-footer" class="hidden bg-gray-50 p-4 border-t flex justify-between">
                <button onclick="resetDefaults()" class="text-red-500 text-sm">Reset Defaults</button>
                <div class="flex gap-2">
                    <button onclick="copySource()" class="bg-gray-700 text-white px-4 py-2 rounded font-bold text-sm">Copy Source</button>
                    <button onclick="exportFile()" class="bg-purple-700 text-white px-4 py-2 rounded font-bold text-sm">Download File</button>
                    <button onclick="saveLocal()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm">Save (Local)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SAFE STORAGE ---
        const SafeStorage = {
            getItem: (k) => { try { return localStorage.getItem(k) } catch(e){ return null } },
            setItem: (k,v) => { try { localStorage.setItem(k,v) } catch(e){} },
            removeItem: (k) => { try { localStorage.removeItem(k) } catch(e){} }
        };

        // --- LOAD CONFIG ---
        let config;
        try {
            config = JSON.parse(document.getElementById('app-config').textContent);
        } catch(e) { console.error("Config Error", e); config = {}; }

        // Local Override
        try {
            const local = SafeStorage.getItem('storyArchConfig');
            if(local) config = { ...config, ...JSON.parse(local) };
        } catch(e){}

        // --- STATE ---
        let storyData = {
            selectedPrompt: null,
            assets: {},
            drafts: {}
        };
        
        // Deck State: Tracks current index for each category
        let deckState = {
            'Decision': 0,
            'Event': 0,
            'Journey': 0,
            'Constraint': 0
        };

        // --- INIT ---
        window.onload = function() {
            document.title = config.appTitle;
            document.getElementById('header-title').innerText = config.appTitle;
            renderPhase1(); // Deck Render
            renderPhase2();
            renderPhase3();
            
            // Load saved progress?
            const saved = SafeStorage.getItem('storyArchProgress');
            if(saved) {
                storyData = JSON.parse(saved);
                if(storyData.selectedPrompt) {
                     confirmPrompt(true); // Restore UI without alert
                }
                restoreInputs();
                updateAssetsSidebar();
            } else {
                changePhase(1); // Start at Phase 1 (Mission Select)
            }
        };

        // --- RENDERERS ---
        
        // Phase 1: Deck Carousel Renderer
        function renderPhase1() {
            const container = document.getElementById('deck-grid');
            container.innerHTML = '';
            
            // Group prompts by Type
            const categories = { 'Decision': [], 'Event': [], 'Journey': [], 'Constraint': [] };
            config.examPrompts.forEach(p => {
                if(categories[p.type]) categories[p.type].push(p.text);
            });

            // Create Deck Cards
            for (const [type, prompts] of Object.entries(categories)) {
                if(prompts.length === 0) continue;
                
                // Ensure state index is valid
                if(deckState[type] >= prompts.length) deckState[type] = 0;
                const currentText = prompts[deckState[type]];

                container.innerHTML += `
                    <div class="deck-card group" id="card-${type}" onclick="selectDeck('${type}', '${currentText.replace(/'/g, "\\'")}')">
                        <div class="deck-header header-${type}">
                            <span>${type}</span>
                            <span class="text-xs opacity-75">${deckState[type] + 1}/${prompts.length}</span>
                        </div>
                        <div class="deck-body">
                            <button onclick="prevPrompt(event, '${type}')" class="nav-arrow nav-left"><i class="fas fa-chevron-left"></i></button>
                            <p class="px-8 leading-snug font-serif" id="text-${type}">"${currentText}"</p>
                            <button onclick="nextPrompt(event, '${type}')" class="nav-arrow nav-right"><i class="fas fa-chevron-right"></i></button>
                        </div>
                    </div>
                `;
            }
        }

        function renderPhase2() {
            const container = document.getElementById('blueprint-inputs');
            container.innerHTML = '';
            config.blueprintPrompts.forEach(p => {
                container.innerHTML += `
                    <div class="bg-white border p-4 rounded shadow-sm">
                        <label class="block text-blue-800 font-bold mb-1">${p.title}</label>
                        <p class="text-xs text-gray-500 mb-2">${p.prompt}</p>
                        <textarea id="input-${p.id}" class="w-full border bg-gray-50 p-2 rounded h-24 focus:ring-2 ring-blue-300 outline-none" oninput="saveProgress()"></textarea>
                    </div>
                `;
            });
        }

        function renderPhase3() {
            const container = document.getElementById('structure-inputs');
            container.innerHTML = '';
            config.structureSteps.forEach((s, i) => {
                container.innerHTML += `
                    <div class="border-l-4 border-green-500 pl-4 py-2">
                        <label class="block text-lg font-bold text-gray-800">${s.title}</label>
                        <p class="text-sm text-gray-500 mb-2"><i class="fas fa-lightbulb text-yellow-500 mr-1"></i> ${s.guidance}</p>
                        <textarea id="draft-step-${i}" class="w-full border p-3 rounded h-32 font-serif text-lg leading-relaxed focus:bg-white bg-gray-50 outline-none transition" placeholder="Write this section..." oninput="saveProgress()"></textarea>
                    </div>
                `;
            });
        }

        function updateAssetsSidebar() {
            const container = document.getElementById('assets-container');
            container.innerHTML = '';
            
            config.blueprintPrompts.forEach(p => {
                const val = storyData.assets[p.id];
                if(val && val.trim().length > 0) {
                    container.innerHTML += `
                        <div class="asset-card" onclick="insertAsset('${val.replace(/'/g, "\\'")}')">
                            <div class="font-bold text-blue-200 text-xs mb-1">${p.title}</div>
                            <div class="text-white italic">"${val.substring(0, 50)}${val.length>50?'...':''}"</div>
                        </div>
                    `;
                }
            });
        }

        // --- DECK LOGIC ---
        function nextPrompt(e, type) {
            e.stopPropagation(); // Prevent card selection
            const prompts = config.examPrompts.filter(p => p.type === type);
            deckState[type] = (deckState[type] + 1) % prompts.length;
            renderPhase1(); // Re-render to show new text
        }

        function prevPrompt(e, type) {
            e.stopPropagation();
            const prompts = config.examPrompts.filter(p => p.type === type);
            deckState[type] = (deckState[type] - 1 + prompts.length) % prompts.length;
            renderPhase1();
        }

        function selectDeck(type, text) {
            storyData.selectedPrompt = text;
            
            // Visual Selection
            document.querySelectorAll('.deck-card').forEach(c => c.classList.remove('selected'));
            document.getElementById(`card-${type}`).classList.add('selected');
            
            // Enable Button
            const btn = document.getElementById('start-btn');
            btn.disabled = false;
            btn.classList.remove('bg-gray-400', 'cursor-not-allowed');
            btn.classList.add('bg-blue-600', 'hover:bg-blue-700');
        }

        function confirmPrompt(silent = false) {
            if(!storyData.selectedPrompt) return;
            document.getElementById('sidebar-mission-text').innerText = `"${storyData.selectedPrompt}"`;
            changePhase(2);
            if(!silent) saveProgress();
        }

        function changePhase(n) {
            document.querySelectorAll('[id^="phase-"]').forEach(el => el.classList.add('hidden'));
            
            const targetId = `phase-${n}`;
            
            const targetEl = document.getElementById(targetId);
            if(targetEl) targetEl.classList.remove('hidden');
            
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`nav-p${n}`).classList.add('active');

            if(n === 3) updateAssetsSidebar();
        }

        function saveProgress() {
            config.blueprintPrompts.forEach(p => {
                const el = document.getElementById(`input-${p.id}`);
                if(el) storyData.assets[p.id] = el.value;
            });
            config.structureSteps.forEach((s, i) => {
                const el = document.getElementById(`draft-step-${i}`);
                if(el) storyData.drafts[i] = el.value;
            });
            SafeStorage.setItem('storyArchProgress', JSON.stringify(storyData));
            updateAssetsSidebar();
        }

        function restoreInputs() {
            if(storyData.selectedPrompt) document.getElementById('sidebar-mission-text').innerText = `"${storyData.selectedPrompt}"`;
            
            config.blueprintPrompts.forEach(p => {
                const el = document.getElementById(`input-${p.id}`);
                if(el && storyData.assets[p.id]) el.value = storyData.assets[p.id];
            });
            config.structureSteps.forEach((s, i) => {
                const el = document.getElementById(`draft-step-${i}`);
                if(el && storyData.drafts[i]) el.value = storyData.drafts[i];
            });
        }

        function compileStory() {
            let fullText = "";
            config.structureSteps.forEach((s, i) => {
                const text = storyData.drafts[i] || "";
                if(text.trim()) fullText += text + "\n\n";
            });
            
            const editor = document.getElementById('final-editor');
            if(editor.innerText.trim() === "" || confirm("Re-compile story? This will overwrite manual edits.")) {
                editor.innerText = fullText;
                changePhase(4); 
            }
        }

        function insertAsset(text) {
            try {
                // Fallback for browsers blocking clipboard API without user gesture context
                // We use the prompt fallback which is safe everywhere
                prompt("Copy your asset:", text);
            } catch (e) {
                alert("Asset: " + text);
            }
        }

        // --- TOOLS ---
        function analyzeDialogue() {
            const editor = document.getElementById('final-editor');
            let html = editor.innerText;
            html = html.replace(/(".*?")/g, '<span class="highlight-good">$1</span>');
            editor.innerHTML = html;
            feedback("Dialogue highlighted. Green = Well formed quotes.");
        }

        function checkSpelling() {
            const editor = document.getElementById('final-editor');
            const isSpell = editor.getAttribute('spellcheck') === 'true';
            editor.setAttribute('spellcheck', !isSpell);
            feedback(`Native Spellcheck: ${!isSpell ? 'ON' : 'OFF'}`);
        }

        function feedback(msg) {
            document.querySelector('#inspection-feedback span').innerText = msg;
        }
        
        function downloadStory() {
            const text = document.getElementById('final-editor').innerText;
            const blob = new Blob([text], {type: 'text/plain'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'my_story_draft.txt';
            a.click();
        }

        // --- ADMIN FUNCTIONS ---
        function toggleAdmin() {
            const m = document.getElementById('admin-modal');
            m.classList.toggle('hidden');
            if(!m.classList.contains('hidden')) {
                document.getElementById('admin-lock').classList.remove('hidden');
                document.getElementById('admin-unlocked').classList.add('hidden');
                document.getElementById('admin-footer').classList.add('hidden');
                document.getElementById('admin-pass').value = '';
                if(config.adminPass === 'ChiefInspector') document.getElementById('pass-hint').classList.remove('hidden');
            }
        }

        function unlockAdmin() {
            if(document.getElementById('admin-pass').value === config.adminPass) {
                document.getElementById('admin-lock').classList.add('hidden');
                document.getElementById('admin-unlocked').classList.remove('hidden');
                document.getElementById('admin-footer').classList.remove('hidden');
                renderAdminUI();
            } else {
                alert("Access Denied");
            }
        }

        function showTab(id) {
            if(id === 'prompts') { document.getElementById('tab-prompts').classList.remove('hidden'); document.getElementById('tab-exam').classList.add('hidden'); }
            else { document.getElementById('tab-prompts').classList.add('hidden'); document.getElementById('tab-exam').classList.remove('hidden'); }
        }

        function renderAdminUI() {
            document.getElementById('edit-title').value = config.appTitle;
            document.getElementById('edit-pass').value = config.adminPass;

            // Prompts
            const pc = document.getElementById('prompts-editor'); pc.innerHTML = '';
            config.blueprintPrompts.forEach((p, i) => {
                pc.innerHTML += `<div class="flex gap-2 mb-2 bg-white p-2 rounded border"><div class="flex-grow"><input class="w-full text-xs font-bold border-b mb-1 p-title" value="${p.title.replace(/"/g, '&quot;')}" placeholder="Title"><input class="w-full text-xs text-gray-600 p-prompt" value="${p.prompt.replace(/"/g, '&quot;')}" placeholder="Prompt"></div><button onclick="delPrompt(${i})" class="text-red-500 font-bold">&times;</button></div>`;
            });

            // Structure
            const sc = document.getElementById('structure-editor'); sc.innerHTML = '';
            config.structureSteps.forEach((s, i) => {
                sc.innerHTML += `<div class="flex gap-2 mb-2 bg-white p-2 rounded border"><div class="flex-grow"><input class="w-full text-xs font-bold border-b mb-1 s-title" value="${s.title.replace(/"/g, '&quot;')}" placeholder="Step Title"><input class="w-full text-xs text-gray-600 s-guide" value="${s.guidance.replace(/"/g, '&quot;')}" placeholder="Guidance"></div><button onclick="delStep(${i})" class="text-red-500 font-bold">&times;</button></div>`;
            });

            // Exam Prompts
            const ec = document.getElementById('exam-editor'); ec.innerHTML = '';
            config.examPrompts.forEach((e, i) => {
                 ec.innerHTML += `<div class="flex gap-2 mb-2 bg-white p-2 rounded border"><select class="text-xs border rounded e-type"><option ${e.type==='Decision'?'selected':''}>Decision</option><option ${e.type==='Event'?'selected':''}>Event</option><option ${e.type==='Journey'?'selected':''}>Journey</option><option ${e.type==='Constraint'?'selected':''}>Constraint</option></select><input class="flex-grow text-xs border rounded px-1 e-text" value="${e.text.replace(/"/g, '&quot;')}"><button onclick="delExamPrompt(${i})" class="text-red-500 font-bold">&times;</button></div>`;
            });
        }

        // Admin Actions
        function addPrompt() { config.blueprintPrompts.push({id: "p"+Date.now(), title:"", prompt:""}); renderAdminUI(); }
        function delPrompt(i) { if(confirm('Delete?')) { config.blueprintPrompts.splice(i,1); renderAdminUI(); } }
        function addStep() { config.structureSteps.push({title:"", guidance:""}); renderAdminUI(); }
        function delStep(i) { if(confirm('Delete?')) { config.structureSteps.splice(i,1); renderAdminUI(); } }
        function addExamPrompt() { config.examPrompts.push({type:"Decision", text:""}); renderAdminUI(); }
        function delExamPrompt(i) { if(confirm('Delete?')) { config.examPrompts.splice(i,1); renderAdminUI(); } }


        function collectConfig() {
            config.appTitle = document.getElementById('edit-title').value;
            config.adminPass = document.getElementById('edit-pass').value;
            
            const newPrompts = [];
            document.querySelectorAll('#prompts-editor > div').forEach((row, i) => {
                newPrompts.push({ id: "p"+i, title: row.querySelector('.p-title').value, prompt: row.querySelector('.p-prompt').value });
            });
            config.blueprintPrompts = newPrompts;

            const newSteps = [];
            document.querySelectorAll('#structure-editor > div').forEach(row => {
                newSteps.push({ title: row.querySelector('.s-title').value, guidance: row.querySelector('.s-guide').value });
            });
            config.structureSteps = newSteps;

            const newExam = [];
            document.querySelectorAll('#exam-editor > div').forEach(row => {
                newExam.push({ type: row.querySelector('.e-type').value, text: row.querySelector('.e-text').value });
            });
            config.examPrompts = newExam;
        }

        function saveLocal() {
            collectConfig();
            SafeStorage.setItem('storyArchConfig', JSON.stringify(config));
            alert("Settings saved to browser.");
            location.reload();
        }

        function exportFile() {
            collectConfig();
            // Direct Injection
            document.getElementById('app-config').textContent = JSON.stringify(config, null, 4);
            
            // Clean UI
            document.getElementById('admin-modal').classList.add('hidden');
            document.getElementById('admin-lock').classList.remove('hidden');
            document.getElementById('admin-unlocked').classList.add('hidden');
            document.getElementById('admin-footer').classList.add('hidden');
            document.getElementById('admin-pass').value = '';
            
            const html = document.documentElement.outerHTML;
            const blob = new Blob([html], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const safeTitle = config.appTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            a.href = url;
            a.download = `story_architect_${safeTitle}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            location.reload();
        }

        function copySource() {
            collectConfig();
            document.getElementById('app-config').textContent = JSON.stringify(config, null, 4);
            
             // Clean UI
            document.getElementById('admin-modal').classList.add('hidden');
            document.getElementById('admin-lock').classList.remove('hidden');
            document.getElementById('admin-unlocked').classList.add('hidden');
            document.getElementById('admin-footer').classList.add('hidden');
            document.getElementById('admin-pass').value = '';

            const html = document.documentElement.outerHTML;
            
            // Fallback Copy
            const textArea = document.createElement("textarea");
            textArea.value = html;
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                alert("Source Code Copied!");
            } catch (err) {
                prompt("Copy failed.", html);
            }
            document.body.removeChild(textArea);
            location.reload();
        }

        function resetDefaults() {
            if(confirm('Reset?')) { SafeStorage.removeItem('storyArchConfig'); location.reload(); }
        }

    </script>
</body>
</html>
