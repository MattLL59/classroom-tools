<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tone & Structure Architect v3.0</title>
<style>
    /* --- 1. CSS VARIABLES & RESET --- */
    :root {
        --primary: #009688; /* Teal */
        --accent: #ff9800;  /* Orange */
        --bg: #f0f2f5;
        --card: #ffffff;
        --text: #37474f;
        --border: #cfd8dc;
        --success: #4caf50;
        --error: #f44336;
        --tone-color: #9c27b0;
        --struct-color: #2196f3;
        --lang-color: #43a047;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

    /* --- 2. HEADER --- */
    header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--card); box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; flex-shrink: 0; }
    h1 { margin: 0; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; font-weight: 800; }
    .score-badge { background: var(--accent); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; }
    
    .header-controls { display: flex; gap: 8px; align-items: center; }
    .icon-btn { background: none; border: 1px solid var(--border); border-radius: 4px; font-size: 1.2rem; cursor: pointer; padding: 4px 8px; transition: background 0.2s; }
    .icon-btn:hover { background: #eceff1; }
    select.level-select { padding: 5px; border-radius: 4px; border: 1px solid var(--border); font-weight: bold; color: var(--text); }

    /* --- 3. MAIN LAYOUT --- */
    .viewport { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; scroll-behavior: smooth; }
    
    .hub { display: none; animation: fadeIn 0.3s ease-out; }
    .hub.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* --- 4. CARDS & GRID --- */
    .section-header { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: #78909c; margin: 20px 0 10px 0; border-bottom: 2px solid #eceff1; padding-bottom: 5px; font-weight: bold; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; }
    
    .card { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; position: relative; transition: transform 0.1s; overflow: hidden; }
    .card:hover { transform: translateY(-2px); border-color: var(--primary); }
    .card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; }
    .card-tone::before { background: var(--tone-color); }
    .card-structure::before { background: var(--struct-color); }
    .card-language::before { background: var(--lang-color); }
    .card-global { border-left: 5px solid #607d8b; }
    
    .quote-text { font-family: 'Georgia', serif; font-style: italic; font-size: 1.05rem; color: #455a64; display: block; margin-bottom: 8px; }
    .card-meta { display: flex; justify-content: space-between; font-size: 0.75rem; text-transform: uppercase; font-weight: bold; color: #90a4ae; }

    /* --- 5. WRITING DESK --- */
    .builder-area { background: white; padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
    .slot-row { margin-bottom: 10px; }
    .slot-label { font-size: 0.75rem; font-weight: 700; color: var(--primary); text-transform: uppercase; display: block; margin-bottom: 3px; }
    .slot-select, .slot-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 1rem; background: #fafafa; }
    .slot-static { background: #e3f2fd; color: #1565c0; padding: 10px; border-radius: 4px; font-style: italic; border: 1px solid #bbdefb; }
    
    .preview-box { padding: 15px; background: #fff3e0; border: 2px dashed var(--accent); border-radius: 8px; font-size: 1.1rem; line-height: 1.5; min-height: 60px; margin-bottom: 15px; }
    textarea.essay-area { width: 100%; height: 200px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical; margin-bottom: 10px; }

    /* --- 6. BUTTONS & UI --- */
    .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 5px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-accent { background: var(--accent); color: white; }
    .btn-doc { background: #1565c0; color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--error); color: white; }
    .btn-outline { background: white; border: 2px solid var(--border); color: var(--text); }
    .btn-small { padding: 6px 10px; font-size: 0.85rem; width: auto; }
    .filter-bar { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; }
    .filter-btn { flex: 1; min-width: 80px; padding: 8px; font-size: 0.85rem; }
    .filter-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(0, 150, 136, 0.08); }

    /* --- 7. ADMIN / MODALS --- */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .modal.open { display: flex; }
    .modal-content { background: #f5f7fa; width: 95%; max-width: 900px; max-height: 95vh; border-radius: 10px; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden; }
    .modal-header { padding: 15px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.1rem; }
    .modal-body { padding: 20px; overflow-y: auto; }
    
    .admin-section { background: white; border: 1px solid var(--border); border-radius: 6px; padding: 15px; margin-bottom: 15px; }
    .admin-h { color: var(--primary); margin: 0 0 10px 0; font-size: 1rem; border-bottom: 1px solid #eee; padding-bottom: 5px; }
    
    .input-group { margin-bottom: 10px; }
    .input-group label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 3px; }
    .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; }
    .check-row { display: flex; align-items: center; gap: 8px; font-size: 0.9rem; margin-bottom: 8px; }
    .check-row input { transform: scale(1.1); }
    
    .bank-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
    .bank-tag { background: #e0f2f1; border: 1px solid #b2dfdb; padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
    .bank-tag button { background: none; border: none; color: #d32f2f; cursor: pointer; font-weight: bold; }

    .quote-editor { border: 1px solid #e0e0e0; border-radius: 6px; padding: 10px; margin-bottom: 10px; background: #fafafa; }
    .quote-editor-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; margin-bottom: 8px; color: #546e7a; }
    .level-checks { display: flex; gap: 10px; margin-top: 5px; font-size: 0.85rem; }
    .level-checks label { display: flex; align-items: center; gap: 4px; }

    .wizard-progress { font-size: 0.8rem; color: #78909c; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px; }
    .wizard-prompt { margin-bottom: 12px; }

    .celebration { position: fixed; inset: 0; background: rgba(12, 24, 28, 0.92); z-index: 2500; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; text-align: center; }
    .celebration.hidden { display: none; }
    .celebration-inner { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; max-width: 320px; width: 90%; }
    .celebration-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 8px; }
    .celebration-sub { font-size: 0.95rem; margin-bottom: 15px; color: #cfd8dc; }
    .celebration-confetti { position: absolute; inset: 0; overflow: hidden; pointer-events: none; }
    .celebration-emoji { position: absolute; font-size: 1.6rem; animation: floatDown 2.5s linear infinite; opacity: 0.9; }
    @keyframes floatDown { from { transform: translateY(-10vh) rotate(0deg); } to { transform: translateY(110vh) rotate(360deg); } }

    /* --- 8. UTILS & NAV --- */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: white; border-top: 1px solid var(--border); display: flex; justify-content: space-around; z-index: 900; }
    .nav-item { flex: 1; background: none; border: none; color: #90a4ae; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
    .nav-item.active { color: var(--primary); background: rgba(0, 150, 136, 0.05); }
    .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
    .nav-label { font-size: 0.7rem; font-weight: 700; }
    
    .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    .hidden { display: none !important; }
    
    @media print { .no-print { display: none; } }
</style>
</head>
<body>

    <div id="save-status" style="position:fixed; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:5px 15px; border-radius:20px; font-size:0.8rem; opacity:0; transition:0.3s; z-index:3000;">üíæ Saved</div>

    <div id="celebration-overlay" class="celebration hidden">
        <div class="celebration-confetti" id="celebration-confetti"></div>
        <div class="celebration-inner">
            <div class="celebration-title">Level Complete! üéâ</div>
            <div class="celebration-sub" id="celebration-sub">Great work! You finished this level.</div>
            <button class="btn btn-primary" id="celebration-btn" onclick="ui.closeCelebration()">Continue</button>
        </div>
    </div>

    <header class="no-print">
        <h1>
            <button class="icon-btn" onclick="app.resetSession()" style="color:red; border-color:red;" title="Reset Session">‚ú®</button>
            Tone & Structure Architect
            <span class="score-badge" id="score-display">0 XP</span>
        </h1>
        <div class="header-controls">
            <button class="icon-btn" onclick="ui.openModal('modal-help')">‚ùì</button>
            <select id="level-selector" class="level-select" onchange="app.setLevel(this.value)">
                <option value="1">Lvl 1</option>
                <option value="2">L2</option>
                <option value="3">L3</option>
            </select>
            <button class="icon-btn" onclick="ui.openAdmin()">‚öôÔ∏è</button>
        </div>
    </header>

    <div class="viewport no-print">
        
        <div id="view-lab" class="hub active">
            <div style="display:flex; justify-content:space-between; align-items:center; background:white; padding:10px; border-bottom:1px solid var(--border);">
                <div><strong>Topic:</strong> <span id="lbl-title">...</span></div>
                <button class="btn btn-outline" style="width:auto; padding:5px 10px;" onclick="ui.openModal('modal-source')">üìÑ View Text</button>
            </div>
            
            <div style="padding:10px;">
                <div class="filter-bar">
                    <button class="btn btn-outline filter-btn" data-filter="all" onclick="app.setFilter('all')">All</button>
                    <button class="btn btn-outline filter-btn" data-filter="language" onclick="app.setFilter('language')">Language</button>
                    <button class="btn btn-outline filter-btn" data-filter="structure" onclick="app.setFilter('structure')">Structure</button>
                    <button class="btn btn-outline filter-btn" data-filter="tone" onclick="app.setFilter('tone')">Tone</button>
                </div>

                <div id="quote-grid" class="grid"></div>
                
                <div class="section-header" style="margin-top:20px;">Global Analysis</div>
                <div id="global-card-container"></div>
            </div>
        </div>

        <div id="view-desk" class="hub">
            <div style="padding:15px;">
                <div class="section-header" style="margin-top:0;">Sentence Construction</div>
                <div id="sentence-builder" class="builder-area">
                    <div style="text-align:center; color:#999; padding:20px;">Select a quote in the Evidence Lab to start.</div>
                </div>

                <div class="section-header">Preview & Edit</div>
                <div id="preview-box" class="preview-box" contenteditable="true" oninput="app.markPreviewDirty()"></div>
                
                <div style="display:grid; grid-template-columns:1fr 2fr; gap:10px; margin-bottom:20px;">
                    <button class="btn btn-accent" onclick="app.undo()">Undo</button>
                    <button class="btn btn-primary" onclick="app.commitSentence()">Commit to Essay ‚¨á</button>
                </div>

                <textarea id="essay-area" class="essay-area" placeholder="Your essay will appear here..." oninput="app.updateEssay(this.value)"></textarea>
                
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-doc" onclick="app.exportDoc()">Download .doc</button>
                    <button class="btn btn-danger" onclick="app.clearEssay()">Clear</button>
                </div>
            </div>
        </div>

    </div>

    <nav class="bottom-nav no-print">
        <button class="nav-item active" onclick="ui.switchView('lab')" id="nav-lab">
            <span class="nav-icon">üß™</span><span class="nav-label">Evidence Lab</span>
        </button>
        <button class="nav-item" onclick="ui.switchView('desk')" id="nav-desk">
            <span class="nav-icon">‚úçÔ∏è</span><span class="nav-label">Writing Desk</span>
        </button>
    </nav>

    <div id="modal-source" class="modal">
        <div class="modal-content">
            <div class="modal-header">Source Text <button class="icon-btn" onclick="ui.closeModal('modal-source')">‚úï</button></div>
            <div class="modal-body"><div id="source-content" style="white-space:pre-wrap; line-height:1.6; font-size:1.1rem; font-family:'Georgia';"></div></div>
        </div>
    </div>

    <div id="modal-help" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">Help <button class="icon-btn" onclick="ui.closeModal('modal-help')">‚úï</button></div>
            <div class="modal-body">
                <p><strong>1. Evidence Lab:</strong> Read the text and click quotes to analyze them. Correct answers earn XP.</p>
                <p><strong>2. Writing Desk:</strong> Use the dropdowns to build sentences. You can type freely in the preview box before committing.</p>
            </div>
        </div>
    </div>

    <div id="modal-wizard" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span id="wizard-title">Analysis</span> <button class="icon-btn" onclick="ui.closeModal('modal-wizard')">‚úï</button></div>
            <div class="modal-body">
                <div class="wizard-progress" id="wizard-progress">Step 1 of 3</div>
                <div class="wizard-prompt" id="wizard-prompt"></div>
                <div id="wizard-options" class="grid"></div>
            </div>
        </div>
    </div>

    <div id="modal-admin" class="modal">
        <div class="modal-content">
            <div class="modal-header">Teacher Admin <button class="icon-btn" onclick="ui.closeModal('modal-admin')">‚úï</button></div>
            <div class="modal-body">

                <div class="admin-section">
                    <h3 class="admin-h">üîê Access & Behavior</h3>
                    <label class="check-row"><input type="checkbox" id="keep-unlocked" onchange="admin.setUnlocked(this.checked)"> Keep Unlocked (this device)</label>
                    <label class="check-row"><input type="checkbox" id="auto-progress" onchange="admin.setAutoProgress(this.checked)"> Auto-progress levels when complete</label>
                </div>

                <div class="admin-section" style="background:#e3f2fd; border-color:#2196f3;">
                    <h3 class="admin-h">ü§ñ AI Lesson Generator</h3>
                    <div class="input-group">
                        <label>Number of Quotes</label>
                        <input type="number" id="ai-count" value="6" min="1" max="20">
                    </div>
                    <div class="input-group">
                        <label>Question</label>
                        <input type="text" id="ai-question" placeholder="e.g., How does the writer use language?">
                    </div>
                    <div class="input-group">
                        <label>Source Text</label>
                        <textarea id="ai-source" rows="4" placeholder="Paste source text here..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="admin.generatePrompt()">1. Generate Prompt</button>

                    <div id="ai-step2" class="hidden" style="margin-top:10px; padding-top:10px; border-top:1px dashed #999;">
                        <div class="input-group">
                            <label>Generated Prompt (copy into ChatGPT)</label>
                            <textarea id="ai-prompt-out" rows="4" readonly></textarea>
                        </div>
                        <div class="input-group">
                            <label>Paste JSON Response</label>
                            <textarea id="ai-json-in" rows="5" placeholder="Paste JSON here..."></textarea>
                        </div>
                        <div class="input-group">
                            <label>Load Mode</label>
                            <select id="ai-mode">
                                <option value="replace">Replace All</option>
                                <option value="append">Append Quotes</option>
                                <option value="merge">Merge Banks Only</option>
                            </select>
                        </div>
                        <button class="btn btn-success" onclick="admin.loadJson()">2. Load Data</button>
                        <p style="font-size:0.8rem; margin:5px 0; color:#607d8b;">The loader strips ```json code fences automatically.</p>
                    </div>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">‚úçÔ∏è Analysis Banks</h3>
                    <div style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:10px;">
                        <button class="btn btn-outline btn-small" onclick="admin.openBank('markers')">Markers</button>
                        <button class="btn btn-outline btn-small" onclick="admin.openBank('starters')">Starters</button>
                        <button class="btn btn-outline btn-small" onclick="admin.openBank('methods')">Methods</button>
                        <button class="btn btn-outline btn-small" onclick="admin.openBank('points')">Points</button>
                    </div>
                    <div style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:10px;">
                        <button class="btn btn-outline btn-small" onclick="admin.openBank('link_l1')">Links L1</button>
                        <button class="btn btn-outline btn-small" onclick="admin.openBank('link_l2')">Links L2</button>
                        <button class="btn btn-outline btn-small" onclick="admin.openBank('link_l3')">Links L3</button>
                    </div>
                    <div id="bank-editor" class="hidden" style="background:#fafafa; padding:10px; border:1px solid #eee;">
                        <b id="bank-title"></b>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <input id="bank-add-val" placeholder="New item...">
                            <button class="btn btn-primary btn-small" onclick="admin.addBankItem()">Add</button>
                        </div>
                        <div id="bank-list" class="bank-tags"></div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">‚öôÔ∏è Sentence Structure</h3>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <button class="btn btn-outline btn-small" onclick="admin.renderConfig(1)">Lvl 1</button>
                        <button class="btn btn-outline btn-small" onclick="admin.renderConfig(2)">Lvl 2</button>
                        <button class="btn btn-outline btn-small" onclick="admin.renderConfig(3)">Lvl 3</button>
                    </div>
                    <div id="config-slots"></div>
                    <p style="font-size:0.8rem; color:#607d8b; margin-top:6px;">Order controls the builder. Use ‚ÄúManual‚Äù for student input.</p>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üèóÔ∏è Global Structure</h3>
                    <label class="check-row"><input type="checkbox" id="gs-enabled" onchange="admin.updateGlobal('enabled', this.checked)"> Enable Global Structure card</label>
                    <div class="input-group">
                        <label>Question</label>
                        <input type="text" id="gs-question" oninput="admin.updateGlobal('question', this.value)">
                    </div>
                    <div class="input-group">
                        <label>Correct Answer</label>
                        <input type="text" id="gs-correct" oninput="admin.updateGlobal('correct', this.value)">
                    </div>
                    <div class="input-group">
                        <label>Distractors (comma separated)</label>
                        <input type="text" id="gs-distractors" oninput="admin.updateGlobal('distractors', this.value)">
                    </div>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üìù Edit Evidence</h3>
                    <div id="quote-editor-list" style="max-height:260px; overflow-y:auto; border:1px solid #eee; padding:5px; margin-bottom:10px;"></div>
                    <button class="btn btn-success" onclick="admin.addQuote()">+ New Quote</button>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üì¶ Data & Exporting</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn btn-doc" onclick="admin.exportWorksheet()">üìÑ Worksheet</button>
                        <button class="btn btn-primary" style="background:#37474f;" onclick="admin.exportStandalone()">üì¶ Student App</button>
                        <button class="btn btn-outline" onclick="admin.saveConfig()">üíæ Save Config</button>
                        <label class="btn btn-outline" style="text-align:center; cursor:pointer;">üìÇ Load File<input type="file" id="file-up" class="hidden" onchange="admin.loadFile(this)"></label>
                    </div>
                </div>

                <button class="btn btn-danger" onclick="app.factoryReset()">‚ö†Ô∏è Factory Reset</button>
            </div>
        </div>
    </div>

<script>
/** TONE & STRUCTURE ARCHITECT v3.0 */

/*DEFAULT_DATA_START*/
const defaultData = {
    meta: { title: "Demo Lesson", author: "System", version: "3.0" },
    sourceText: "The sky was a bruised purple. The wind howled like a banshee...",
    question: "How does the writer use language?",
    settings: { autoProgress: false },
    globalStructure: {
        enabled: true,
        question: "How does the focus shift across the whole text?",
        correct: "From the outside world to the character's thoughts",
        distractors: ["From calm to calm", "From future to past"]
    },
    banks: {
        markers: ["Furthermore,", "However,", "In contrast,", "Significantly,"],
        starters: ["The writer implies", "The text suggests", "The author emphasizes"],
        methods: ["Metaphor", "Simile", "Personification", "Juxtaposition"],
        points: ["a sense of fear", "a feeling of tension", "an atmosphere of chaos"],
        links: {
            l1: ["This shows", "This suggests", "This means"],
            l2: ["This reinforces", "This highlights", "This effectively conveys"],
            l3: ["This subtly implies", "This serves to underscore", "This crystallizes"]
        }
    },
    sentenceConfig: {
        1: ["starter", "quote", "link", "manual"],
        2: ["marker", "starter", "quote", "method", "link", "manual"],
        3: ["marker", "starter", "quote", "method", "point", "link", "manual"]
    },
    items: [
        {
            id: "q1",
            original: "bruised purple",
            translation: "a dark, painful shade",
            translationDistractors: ["a cheerful glow", "a bright sparkle"],
            type: "language",
            effect: "creates a gloomy atmosphere",
            effectDistractors: ["shows excitement", "creates a calm mood"],
            levels: [1, 2, 3]
        },
        {
            id: "q2",
            original: "the wind howled like a banshee",
            translation: "the wind made a frightening noise",
            translationDistractors: ["the wind whispered softly", "the wind was silent"],
            type: "tone",
            effect: "builds a sense of fear",
            effectDistractors: ["makes the scene peaceful", "suggests happiness"],
            levels: [1, 2, 3]
        },
        {
            id: "q3",
            original: "first the street, then the room",
            translation: "the focus moves from outside to inside",
            translationDistractors: ["the focus stays in one place", "the focus moves backward in time"],
            type: "structure",
            effect: "highlights a narrowing focus",
            effectDistractors: ["creates confusion", "shows a random jump"],
            levels: [2, 3]
        }
    ]
};
/*DEFAULT_DATA_END*/

const app = {
    storage: {
        data: "tsa_v3_data",
        state: "tsa_v3_state",
        admin: "tsa_v3_admin_unlocked"
    },
    data: null,
    state: {
        xp: 0,
        level: 1,
        essay: "",
        completed: [],
        completedLevels: [],
        filter: "all",
        activeQuoteId: null,
        previewDirty: false
    },
    audioContext: null,

    init: function() {
        const savedData = localStorage.getItem(app.storage.data);
        if (savedData) {
            try {
                app.data = app.validateAndRepair(JSON.parse(savedData));
            } catch (e) {
                app.data = app.clone(defaultData);
            }
        } else if (typeof teacherConfig !== "undefined") {
            app.data = app.validateAndRepair(teacherConfig);
        } else {
            app.data = app.clone(defaultData);
        }

        const savedState = localStorage.getItem(app.storage.state);
        if (savedState) {
            try {
                app.state = Object.assign(app.state, JSON.parse(savedState));
            } catch (e) {
                app.state = Object.assign({}, app.state);
            }
        }

        app.state.level = [1, 2, 3].includes(parseInt(app.state.level, 10)) ? parseInt(app.state.level, 10) : 1;
        app.state.xp = Number(app.state.xp) || 0;
        app.state.essay = typeof app.state.essay === "string" ? app.state.essay : "";
        app.state.completed = Array.isArray(app.state.completed) ? app.state.completed : [];
        app.state.completedLevels = Array.isArray(app.state.completedLevels) ? app.state.completedLevels : [];
        app.state.filter = app.state.filter || "all";

        ui.init();
        ui.updateAll();
    },

    clone: function(obj) {
        return JSON.parse(JSON.stringify(obj));
    },

    validateAndRepair: function(d) {
        const safe = d && typeof d === "object" ? d : {};
        const ensureArray = (val) => (Array.isArray(val) ? val : []);

        safe.meta = safe.meta || {};
        safe.meta.title = safe.meta.title || "Untitled Lesson";
        safe.meta.author = safe.meta.author || "Teacher";
        safe.meta.version = safe.meta.version || "3.0";

        safe.sourceText = typeof safe.sourceText === "string" ? safe.sourceText : "";
        safe.question = typeof safe.question === "string" ? safe.question : "";

        safe.settings = safe.settings || {};
        safe.settings.autoProgress = !!safe.settings.autoProgress;

        safe.globalStructure = safe.globalStructure || {};
        safe.globalStructure.enabled = safe.globalStructure.enabled !== false;
        safe.globalStructure.question = typeof safe.globalStructure.question === "string" ? safe.globalStructure.question : "How does the whole text develop?";
        safe.globalStructure.correct = typeof safe.globalStructure.correct === "string" ? safe.globalStructure.correct : "It shifts over time.";
        safe.globalStructure.distractors = ensureArray(safe.globalStructure.distractors);

        safe.banks = safe.banks || {};
        safe.banks.markers = ensureArray(safe.banks.markers);
        safe.banks.starters = ensureArray(safe.banks.starters);
        safe.banks.methods = ensureArray(safe.banks.methods);
        safe.banks.points = ensureArray(safe.banks.points);
        safe.banks.links = safe.banks.links || {};
        safe.banks.links.l1 = ensureArray(safe.banks.links.l1);
        safe.banks.links.l2 = ensureArray(safe.banks.links.l2);
        safe.banks.links.l3 = ensureArray(safe.banks.links.l3);

        safe.sentenceConfig = safe.sentenceConfig || {};
        safe.sentenceConfig[1] = ensureArray(safe.sentenceConfig[1]);
        safe.sentenceConfig[2] = ensureArray(safe.sentenceConfig[2]);
        safe.sentenceConfig[3] = ensureArray(safe.sentenceConfig[3]);
        if (!safe.sentenceConfig[1].length) safe.sentenceConfig[1] = app.clone(defaultData.sentenceConfig[1]);
        if (!safe.sentenceConfig[2].length) safe.sentenceConfig[2] = app.clone(defaultData.sentenceConfig[2]);
        if (!safe.sentenceConfig[3].length) safe.sentenceConfig[3] = app.clone(defaultData.sentenceConfig[3]);

        safe.items = ensureArray(safe.items).map((item, idx) => {
            const it = item && typeof item === "object" ? item : {};
            it.id = it.id || `q_${idx}_${Math.random().toString(36).slice(2, 7)}`;
            it.original = typeof it.original === "string" ? it.original : "";
            it.translation = typeof it.translation === "string" ? it.translation : "";
            it.translationDistractors = ensureArray(it.translationDistractors || it.distractors);
            const typeVal = typeof it.type === "string" ? it.type.toLowerCase() : "";
            it.type = ["tone", "structure", "language"].includes(typeVal) ? typeVal : "language";
            it.effect = typeof it.effect === "string" ? it.effect : "";
            it.effectDistractors = ensureArray(it.effectDistractors);
            it.levels = ensureArray(it.levels);
            if (!it.levels.length) it.levels = [1, 2, 3];
            return it;
        });

        return safe;
    },

    save: function() {
        localStorage.setItem(app.storage.data, JSON.stringify(app.data));
        localStorage.setItem(app.storage.state, JSON.stringify(app.state));
        ui.flashSave();
    },

    resetSession: function() {
        if (confirm("Reset progress?")) {
            app.state = {
                xp: 0,
                level: 1,
                essay: "",
                completed: [],
                completedLevels: [],
                filter: "all",
                activeQuoteId: null,
                previewDirty: false
            };
            app.save();
            ui.updateAll();
        }
    },

    factoryReset: function() {
        if (confirm("NUCLEAR RESET: Delete ALL data?")) {
            localStorage.clear();
            location.reload();
        }
    },

    setLevel: function(level) {
        const next = parseInt(level, 10);
        if (![1, 2, 3].includes(next)) return;
        app.state.level = next;
        app.state.activeQuoteId = null;
        app.save();
        ui.renderLab();
        ui.renderBuilderPlaceholder("Level changed. Select a quote to begin.");
        document.getElementById("level-selector").value = next;
    },

    setFilter: function(type) {
        app.state.filter = type;
        app.save();
        ui.renderLab();
    },

    markPreviewDirty: function() {
        app.state.previewDirty = true;
    },

    updateEssay: function(text) {
        app.state.essay = text;
        app.save();
    },

    commitSentence: function() {
        const text = document.getElementById("preview-box").innerText.trim();
        if (!text) return alert("Nothing to commit yet.");
        app.state.essay = app.state.essay ? `${app.state.essay}\n\n${text}` : text;
        document.getElementById("essay-area").value = app.state.essay;
        app.save();
    },

    undo: function() {
        const parts = (app.state.essay || "").split(/\n\s*\n/).filter(p => p.trim().length);
        parts.pop();
        app.state.essay = parts.join("\n\n");
        document.getElementById("essay-area").value = app.state.essay;
        app.save();
    },

    clearEssay: function() {
        if (confirm("Clear essay?")) {
            app.state.essay = "";
            document.getElementById("essay-area").value = "";
            app.save();
        }
    },

    exportDoc: function() {
        const b = new Blob(["\ufeff" + (app.state.essay || "")], { type: "application/msword" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(b);
        a.download = "Essay.doc";
        a.click();
    },

    isAdminUnlocked: function() {
        return localStorage.getItem(app.storage.admin) === "true";
    },

    setAdminUnlocked: function(flag) {
        localStorage.setItem(app.storage.admin, flag ? "true" : "false");
    },

    isItemForLevel: function(item, level) {
        if (!item || !item.levels || !item.levels.length) return true;
        return item.levels.includes(level);
    },

    getItemsForLevel: function(level) {
        return app.data.items.filter(item => app.isItemForLevel(item, level));
    },

    getBankOptions: function(slot, level) {
        const key = (slot || "").toLowerCase();
        if (key === "marker") return app.data.banks.markers;
        if (key === "starter") return app.data.banks.starters;
        if (key === "method") return app.data.banks.methods;
        if (key === "point") return app.data.banks.points;
        if (key === "link") return app.data.banks.links[`l${level}`] || [];
        if (key.startsWith("link_l")) {
            const l = key.split("_")[1];
            return app.data.banks.links[l] || [];
        }
        return [];
    },

    completeQuote: function(item) {
        if (!item || !item.id) return;
        if (!app.state.completed.includes(item.id)) {
            app.state.completed.push(item.id);
            app.state.xp += 10;
            app.save();
            ui.updateScore();
            ui.renderLab();
        }
        app.checkLevelCompletion();
    },

    checkLevelCompletion: function() {
        const lvl = app.state.level;
        const items = app.getItemsForLevel(lvl);
        if (!items.length) return;
        const done = items.every(item => app.state.completed.includes(item.id));
        if (done && !app.state.completedLevels.includes(lvl)) {
            app.state.completedLevels.push(lvl);
            app.save();
            ui.showCelebration(lvl, app.data.settings.autoProgress);
        }
    },

    playSound: function(type) {
        try {
            if (!app.audioContext) {
                app.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            const ctx = app.audioContext;
            const osc = ctx.createOscillator();
            const gain = ctx.createGain();
            const now = ctx.currentTime;
            osc.type = "triangle";
            const freq = type === "celebrate" ? 880 : 520;
            osc.frequency.setValueAtTime(freq, now);
            gain.gain.setValueAtTime(0.0001, now);
            gain.gain.exponentialRampToValueAtTime(0.2, now + 0.02);
            gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.35);
            osc.connect(gain).connect(ctx.destination);
            osc.start(now);
            osc.stop(now + 0.4);
        } catch (e) {
            // Silent fail for unsupported audio.
        }
    },

    buildOptions: function(correct, distractors, fallback) {
        const options = [];
        const safeCorrect = correct && correct.trim() ? correct.trim() : (fallback && fallback[0]) || "No answer provided";
        options.push(safeCorrect);
        (distractors || []).forEach(d => {
            if (d && d.trim()) options.push(d.trim());
        });
        (fallback || []).forEach(f => {
            if (f && f.trim()) options.push(f.trim());
        });
        const unique = [...new Set(options)].filter(Boolean);
        const fillers = ["Another idea", "Different meaning", "Alternative"];
        let fillIndex = 0;
        while (unique.length < 3) {
            const candidate = fillers[fillIndex % fillers.length];
            unique.push(unique.includes(candidate) ? `${candidate} ${fillIndex + 1}` : candidate);
            fillIndex += 1;
        }
        return app.shuffle(unique);
    },

    shuffle: function(arr) {
        const copy = arr.slice();
        for (let i = copy.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [copy[i], copy[j]] = [copy[j], copy[i]];
        }
        return copy;
    }
};

const ui = {
    wizard: { item: null, step: 0 },

    init: function() {
        document.getElementById("level-selector").value = app.state.level;
    },

    updateAll: function() {
        document.getElementById("lbl-title").innerText = app.data.meta.title || "Untitled Lesson";
        document.getElementById("source-content").innerText = app.data.sourceText || "No source text loaded.";
        document.getElementById("score-display").innerText = `${app.state.xp} XP`;
        document.getElementById("essay-area").value = app.state.essay || "";
        document.getElementById("level-selector").value = app.state.level;
        ui.renderLab();
        ui.renderBuilderPlaceholder();
        admin.syncToggles();
    },

    updateScore: function() {
        document.getElementById("score-display").innerText = `${app.state.xp} XP`;
    },

    renderLab: function() {
        const grid = document.getElementById("quote-grid");
        const filter = app.state.filter;
        const items = app.getItemsForLevel(app.state.level).filter(item => filter === "all" || item.type === filter);
        grid.innerHTML = "";

        document.querySelectorAll(".filter-btn").forEach(btn => {
            btn.classList.toggle("active", btn.dataset.filter === filter);
        });

        if (!items.length) {
            grid.innerHTML = `<div class="card" style="text-align:center; color:#90a4ae;">No quotes for this level yet.</div>`;
        } else {
            items.forEach(item => {
                const typeLabel = item.type ? item.type.charAt(0).toUpperCase() + item.type.slice(1) : "Type";
                const div = document.createElement("div");
                div.className = `card card-item card-${item.type}`;
                div.dataset.type = item.type;
                div.innerHTML = `
                    <span class="quote-text">"${item.original || "Missing quote"}"</span>
                    <div class="card-meta"><span>${typeLabel}</span><span>${app.state.completed.includes(item.id) ? "‚úÖ" : ""}</span></div>
                `;
                div.onclick = () => ui.openWizard(item.id);
                grid.appendChild(div);
            });
        }

        const gc = document.getElementById("global-card-container");
        if (app.data.globalStructure && app.data.globalStructure.enabled) {
            gc.innerHTML = `<div class="card card-global" onclick="ui.openGlobalStructure()"><strong>üèóÔ∏è Whole Text Structure</strong><br><small>Click to answer</small></div>`;
        } else {
            gc.innerHTML = "";
        }
    },

    renderBuilderPlaceholder: function(message) {
        const cont = document.getElementById("sentence-builder");
        cont.innerHTML = `<div style="text-align:center; color:#999; padding:20px;">${message || "Select a quote in the Evidence Lab to start."}</div>`;
        document.getElementById("preview-box").innerText = "";
    },

    switchView: function(v) {
        document.querySelectorAll(".hub").forEach(e => e.classList.remove("active"));
        document.querySelectorAll(".nav-item").forEach(e => e.classList.remove("active"));
        document.getElementById("view-" + v).classList.add("active");
        document.getElementById("nav-" + v).classList.add("active");
    },

    openModal: (id) => document.getElementById(id).classList.add("open"),
    closeModal: (id) => document.getElementById(id).classList.remove("open"),

    openAdmin: function() {
        if (app.isAdminUnlocked()) {
            ui.openModal("modal-admin");
            admin.renderAll();
            return;
        }
        const p = prompt("Password (default: 1234)");
        if (p === "1234") {
            ui.openModal("modal-admin");
            admin.renderAll();
        } else if (p) {
            alert("Incorrect password.");
        }
    },

    openWizard: function(itemId) {
        const item = app.data.items.find(i => i.id === itemId);
        if (!item) return;
        ui.wizard = { item, step: 0 };
        ui.renderWizardStep();
        ui.openModal("modal-wizard");
    },

    renderWizardStep: function() {
        const item = ui.wizard.item;
        const step = ui.wizard.step;
        const title = ["Meaning", "Lens", "Effect"][step];
        const promptEl = document.getElementById("wizard-prompt");
        const optsEl = document.getElementById("wizard-options");
        document.getElementById("wizard-title").innerText = `Analysis ‚Ä¢ ${title}`;
        document.getElementById("wizard-progress").innerText = `Step ${step + 1} of 3`;
        optsEl.innerHTML = "";

        let correct = "";
        let options = [];
        let questionText = "";

        if (step === 0) {
            questionText = "What does this mean?";
            correct = item.translation && item.translation.trim() ? item.translation.trim() : "No translation provided";
            options = app.buildOptions(correct, item.translationDistractors, []);
        } else if (step === 1) {
            questionText = "Which lens fits best?";
            correct = item.type || "language";
            options = app.buildOptions(correct, ["tone", "structure", "language"], []);
        } else {
            questionText = "What is the effect?";
            correct = item.effect && item.effect.trim() ? item.effect.trim() : (app.data.banks.points[0] || "creates an effect");
            options = app.buildOptions(correct, item.effectDistractors, app.data.banks.points);
        }

        promptEl.innerHTML = `<p class="quote-text">"${item.original || "Missing quote"}"</p><p>${questionText}</p>`;

        options.forEach(opt => {
            const btn = document.createElement("button");
            btn.className = "btn btn-outline";
            const normalized = opt.toLowerCase().trim();
            const correctNorm = correct.toLowerCase().trim();
            if (step === 1) {
                btn.textContent = normalized.charAt(0).toUpperCase() + normalized.slice(1);
            } else {
                btn.textContent = opt;
            }
            btn.onclick = () => {
                if (normalized === correctNorm) {
                    btn.style.background = "var(--success)";
                    btn.style.color = "white";
                    app.playSound("correct");
                    setTimeout(() => {
                        if (ui.wizard.step < 2) {
                            ui.wizard.step += 1;
                            ui.renderWizardStep();
                        } else {
                            ui.closeModal("modal-wizard");
                            app.completeQuote(item);
                            ui.buildSentence(item);
                        }
                    }, 350);
                } else {
                    btn.classList.add("shake");
                    btn.style.background = "var(--error)";
                    btn.style.color = "white";
                }
            };
            optsEl.appendChild(btn);
        });
    },

    openGlobalStructure: function() {
        const gs = app.data.globalStructure;
        if (!gs || !gs.enabled) return;
        ui.openModal("modal-wizard");
        document.getElementById("wizard-title").innerText = "Whole Text Structure";
        document.getElementById("wizard-progress").innerText = "Whole Text";
        const promptEl = document.getElementById("wizard-prompt");
        const optsEl = document.getElementById("wizard-options");
        optsEl.innerHTML = "";
        promptEl.innerHTML = `<p>${gs.question || "How does the structure develop?"}</p>`;
        const options = app.buildOptions(gs.correct || "It shifts over time.", gs.distractors || [], []);
        const correct = (gs.correct || "It shifts over time.").toLowerCase().trim();

        options.forEach(opt => {
            const btn = document.createElement("button");
            btn.className = "btn btn-outline";
            btn.textContent = opt;
            btn.onclick = () => {
                if (opt.toLowerCase().trim() === correct) {
                    btn.style.background = "var(--success)";
                    btn.style.color = "white";
                    app.playSound("correct");
                    setTimeout(() => ui.closeModal("modal-wizard"), 400);
                } else {
                    btn.classList.add("shake");
                    btn.style.background = "var(--error)";
                    btn.style.color = "white";
                }
            };
            optsEl.appendChild(btn);
        });
    },

    buildSentence: function(item) {
        ui.switchView("desk");
        const cont = document.getElementById("sentence-builder");
        cont.innerHTML = "";
        const config = app.data.sentenceConfig[app.state.level] || [];
        app.state.activeQuoteId = item.id;
        app.state.previewDirty = false;

        if (!config.length) {
            ui.renderBuilderPlaceholder("No sentence structure set for this level.");
            return;
        }

        config.forEach(slot => {
            const normalized = (slot || "").toLowerCase();
            if (!normalized || normalized === "none") return;
            const row = document.createElement("div");
            row.className = "slot-row";
            const label = ui.getSlotLabel(normalized);

            if (normalized === "quote") {
                const lbl = document.createElement("span");
                lbl.className = "slot-label";
                lbl.textContent = label;
                const staticEl = document.createElement("div");
                staticEl.className = "slot-static";
                staticEl.dataset.val = `"${item.original}"`;
                staticEl.textContent = `"${item.original}"`;
                row.appendChild(lbl);
                row.appendChild(staticEl);
            } else if (normalized.startsWith("manual")) {
                row.innerHTML = `<span class="slot-label">${label}</span><input class="slot-input" placeholder="Your idea..." oninput="ui.updatePreview()">`;
            } else {
                const opts = app.getBankOptions(normalized, app.state.level);
                if (!opts.length) {
                    row.innerHTML = `<span class="slot-label">${label}</span><div class="slot-static" data-val="">(No options)</div>`;
                } else {
                    row.innerHTML = `<span class="slot-label">${label}</span><select class="slot-select" onchange="ui.updatePreview()"><option value="">Select...</option>${opts.map(o => `<option>${o}</option>`).join("")}</select>`;
                }
            }
            cont.appendChild(row);
        });

        ui.updatePreview();
    },

    getSlotLabel: function(slot) {
        if (slot.startsWith("manual_")) {
            return slot.split("_")[1].toUpperCase();
        }
        if (slot.startsWith("link_l")) {
            return `LINK ${slot.split("_")[1].toUpperCase()}`;
        }
        const map = {
            marker: "MARKER",
            starter: "STARTER",
            quote: "QUOTE",
            method: "METHOD",
            point: "POINT",
            link: "LINK",
            manual: "MANUAL"
        };
        return map[slot] || slot.toUpperCase();
    },

    updatePreview: function() {
        const parts = [];
        document.querySelectorAll("#sentence-builder select, #sentence-builder input, #sentence-builder .slot-static").forEach(el => {
            const val = el.tagName === "DIV" ? el.dataset.val : el.value;
            if (val && val.trim()) parts.push(val.trim());
        });
        let sentence = parts.join(" ").replace(/\s+/g, " ").trim();
        if (sentence && !/[.!?]$/.test(sentence)) sentence += ".";
        document.getElementById("preview-box").innerText = sentence;
    },

    showCelebration: function(level, autoAdvance) {
        const overlay = document.getElementById("celebration-overlay");
        const confetti = document.getElementById("celebration-confetti");
        const sub = document.getElementById("celebration-sub");
        const btn = document.getElementById("celebration-btn");

        sub.innerText = `You mastered Level ${level}!`;
        btn.textContent = autoAdvance && level < 3 ? "Next Level" : "Continue";
        confetti.innerHTML = "";
        for (let i = 0; i < 20; i++) {
            const span = document.createElement("span");
            span.className = "celebration-emoji";
            span.textContent = Math.random() > 0.5 ? "üéâ" : "‚≠ê";
            span.style.left = `${Math.random() * 100}%`;
            span.style.animationDelay = `${Math.random() * 1.2}s`;
            span.style.animationDuration = `${2 + Math.random() * 2}s`;
            confetti.appendChild(span);
        }
        overlay.classList.remove("hidden");
        app.playSound("celebrate");

        if (autoAdvance && level < 3) {
            setTimeout(() => {
                app.setLevel(level + 1);
                ui.closeCelebration();
            }, 1400);
        }
    },

    closeCelebration: function() {
        document.getElementById("celebration-overlay").classList.add("hidden");
    },

    flashSave: function() {
        const el = document.getElementById("save-status");
        el.style.opacity = 1;
        setTimeout(() => (el.style.opacity = 0), 800);
    }
};

const admin = {
    currentBankKey: null,
    currentConfigLevel: 1,

    renderAll: function() {
        admin.syncToggles();
        admin.renderConfig(app.state.level || 1);
        admin.renderQuoteEditor();
    },

    syncToggles: function() {
        const keep = document.getElementById("keep-unlocked");
        const auto = document.getElementById("auto-progress");
        const gsEnabled = document.getElementById("gs-enabled");
        const gsQuestion = document.getElementById("gs-question");
        const gsCorrect = document.getElementById("gs-correct");
        const gsDistractors = document.getElementById("gs-distractors");
        const aiQuestion = document.getElementById("ai-question");
        const aiSource = document.getElementById("ai-source");
        if (keep) keep.checked = app.isAdminUnlocked();
        if (auto) auto.checked = !!app.data.settings.autoProgress;
        if (gsEnabled) gsEnabled.checked = !!app.data.globalStructure.enabled;
        if (gsQuestion) gsQuestion.value = app.data.globalStructure.question || "";
        if (gsCorrect) gsCorrect.value = app.data.globalStructure.correct || "";
        if (gsDistractors) gsDistractors.value = (app.data.globalStructure.distractors || []).join(", ");
        if (aiQuestion && !aiQuestion.value) aiQuestion.value = app.data.question || "";
        if (aiSource && !aiSource.value) aiSource.value = app.data.sourceText || "";
    },

    setUnlocked: function(flag) {
        app.setAdminUnlocked(flag);
    },

    setAutoProgress: function(flag) {
        app.data.settings.autoProgress = !!flag;
        app.save();
    },

    updateGlobal: function(field, value) {
        if (!app.data.globalStructure) app.data.globalStructure = { enabled: true, question: "", correct: "", distractors: [] };
        if (field === "enabled") {
            app.data.globalStructure.enabled = !!value;
        } else if (field === "distractors") {
            app.data.globalStructure.distractors = admin.parseCSV(value);
        } else {
            app.data.globalStructure[field] = value;
        }
        app.save();
        ui.renderLab();
    },

    generatePrompt: function() {
        const count = document.getElementById("ai-count").value;
        const text = document.getElementById("ai-source").value;
        const question = document.getElementById("ai-question").value || "How does the writer use language?";
        if (!text.trim()) return alert("Paste source text first.");

        const prompt = `Role: Expert English Teacher.
Task: Create JSON lesson data for "Tone & Structure Architect v3.0".
Question: "${question}"
Source Text: "${text.substring(0, 1200)}"

Requirements:
1) Create ${count} analysis items.
2) Each item must include:
   - id, original, translation, translationDistractors (2), type (tone/structure/language),
     effect, effectDistractors (2), levels [1,2,3].
3) Provide banks with at least 5 entries each: markers, starters, methods, points.
4) Provide links for each level: links.l1, links.l2, links.l3 (3 each).
5) Provide globalStructure with question, correct, distractors.

Return ONLY valid JSON matching this schema:
{
  "meta": { "title": "...", "author": "..." },
  "sourceText": "...",
  "question": "${question}",
  "settings": { "autoProgress": false },
  "globalStructure": { "enabled": true, "question": "...", "correct": "...", "distractors": ["..."] },
  "banks": { "markers": [], "starters": [], "methods": [], "points": [], "links": { "l1": [], "l2": [], "l3": [] } },
  "sentenceConfig": { "1": ["starter","quote","link","manual"], "2": ["marker","starter","quote","method","link","manual"], "3": ["marker","starter","quote","method","point","link","manual"] },
  "items": [ { "id": "q1", "original": "...", "translation": "...", "translationDistractors": ["...","..."], "type": "tone", "effect": "...", "effectDistractors": ["...","..."], "levels": [1,2,3] } ]
}`;

        document.getElementById("ai-prompt-out").value = prompt;
        document.getElementById("ai-step2").classList.remove("hidden");
    },

    cleanJsonInput: function(raw) {
        if (!raw) return "";
        return raw.replace(/```[a-zA-Z]*\s*/g, "").replace(/```/g, "").trim();
    },

    loadJson: function() {
        try {
            const raw = admin.cleanJsonInput(document.getElementById("ai-json-in").value);
            const parsed = JSON.parse(raw);
            const mode = document.getElementById("ai-mode").value;
            const cleaned = app.validateAndRepair(parsed);

            if (mode === "replace") {
                app.data = cleaned;
                app.state.completed = [];
                app.state.completedLevels = [];
                app.state.xp = 0;
                app.state.essay = "";
                app.state.level = 1;
                app.state.filter = "all";
                app.state.activeQuoteId = null;
            } else if (mode === "append") {
                app.data.items = [...app.data.items, ...cleaned.items];
            } else if (mode === "merge") {
                ["markers", "starters", "methods", "points"].forEach(k => {
                    if (cleaned.banks[k]) {
                        app.data.banks[k] = [...new Set([...app.data.banks[k], ...cleaned.banks[k]])];
                    }
                });
                ["l1", "l2", "l3"].forEach(l => {
                    if (cleaned.banks.links[l]) {
                        app.data.banks.links[l] = [...new Set([...app.data.banks.links[l], ...cleaned.banks.links[l]])];
                    }
                });
            }

            app.data = app.validateAndRepair(app.data);
            app.save();
            ui.updateAll();
            admin.renderQuoteEditor();
        } catch (e) {
            alert("Invalid JSON");
        }
    },

    openBank: function(key) {
        admin.currentBankKey = key;
        document.getElementById("bank-editor").classList.remove("hidden");
        document.getElementById("bank-title").innerText = `Editing: ${key}`;
        const list = document.getElementById("bank-list");
        list.innerHTML = "";

        let arr = [];
        if (key.includes("link")) {
            arr = app.data.banks.links[key.split("_")[1]] || [];
        } else {
            arr = app.data.banks[key] || [];
        }

        arr.forEach((v, i) => {
            const tag = document.createElement("span");
            tag.className = "bank-tag";
            const text = document.createElement("span");
            text.innerText = v;
            const btn = document.createElement("button");
            btn.innerText = "x";
            btn.onclick = () => admin.removeBankItem(i);
            tag.appendChild(text);
            tag.appendChild(btn);
            list.appendChild(tag);
        });
    },

    addBankItem: function() {
        const v = document.getElementById("bank-add-val").value.trim();
        if (!v || !admin.currentBankKey) return;
        if (admin.currentBankKey.includes("link")) {
            app.data.banks.links[admin.currentBankKey.split("_")[1]].push(v);
        } else {
            app.data.banks[admin.currentBankKey].push(v);
        }
        app.save();
        admin.openBank(admin.currentBankKey);
        document.getElementById("bank-add-val").value = "";
    },

    removeBankItem: function(idx) {
        if (admin.currentBankKey.includes("link")) {
            app.data.banks.links[admin.currentBankKey.split("_")[1]].splice(idx, 1);
        } else {
            app.data.banks[admin.currentBankKey].splice(idx, 1);
        }
        app.save();
        admin.openBank(admin.currentBankKey);
    },

    renderConfig: function(level) {
        admin.currentConfigLevel = level;
        const cont = document.getElementById("config-slots");
        cont.innerHTML = "";
        const slots = app.data.sentenceConfig[level] || [];
        const allOpts = ["marker", "starter", "quote", "method", "point", "link", "manual", "manual_point", "manual_analysis", "manual_effect", "link_l1", "link_l2", "link_l3"];

        for (let i = 0; i < 7; i++) {
            const group = document.createElement("div");
            group.className = "input-group";
            const label = document.createElement("label");
            label.innerText = `Slot ${i + 1}`;
            const sel = document.createElement("select");
            const none = document.createElement("option");
            none.value = "none";
            none.textContent = "None";
            sel.appendChild(none);

            allOpts.forEach(opt => {
                const option = document.createElement("option");
                option.value = opt;
                option.textContent = opt;
                if (slots[i] === opt) option.selected = true;
                sel.appendChild(option);
            });

            sel.onchange = () => {
                const arr = Array.from(cont.querySelectorAll("select")).map(s => s.value).filter(v => v !== "none");
                app.data.sentenceConfig[level] = arr;
                app.save();
            };

            group.appendChild(label);
            group.appendChild(sel);
            cont.appendChild(group);
        }
    },

    addQuote: function() {
        app.data.items.push({
            id: `q_${Date.now()}`,
            original: "New Quote",
            translation: "Meaning",
            translationDistractors: ["Wrong", "Wrong"],
            type: "tone",
            effect: "creates an effect",
            effectDistractors: ["Wrong", "Wrong"],
            levels: [1, 2, 3]
        });
        app.save();
        admin.renderQuoteEditor();
        ui.renderLab();
    },

    removeQuote: function(id) {
        if (!confirm("Delete this quote?")) return;
        app.data.items = app.data.items.filter(item => item.id !== id);
        app.save();
        admin.renderQuoteEditor();
        ui.renderLab();
    },

    updateQuote: function(id, field, value, isCsv) {
        const item = app.data.items.find(q => q.id === id);
        if (!item) return;
        if (isCsv) {
            item[field] = admin.parseCSV(value);
        } else {
            item[field] = value;
        }
        app.save();
        ui.renderLab();
    },

    toggleLevel: function(id, level, checked) {
        const item = app.data.items.find(q => q.id === id);
        if (!item) return;
        const levels = new Set(item.levels || []);
        if (checked) levels.add(level);
        else levels.delete(level);
        item.levels = Array.from(levels);
        if (!item.levels.length) item.levels = [level];
        app.save();
        ui.renderLab();
    },

    renderQuoteEditor: function() {
        const cont = document.getElementById("quote-editor-list");
        cont.innerHTML = "";
        if (!app.data.items.length) {
            cont.innerHTML = `<div style="text-align:center; color:#90a4ae; padding:10px;">No quotes yet.</div>`;
            return;
        }

        app.data.items.forEach((item, index) => {
            const card = document.createElement("div");
            card.className = "quote-editor";

            const header = document.createElement("div");
            header.className = "quote-editor-header";
            header.textContent = `Quote ${index + 1}`;

            const delBtn = document.createElement("button");
            delBtn.className = "btn btn-outline btn-small";
            delBtn.textContent = "Delete";
            delBtn.onclick = () => admin.removeQuote(item.id);
            header.appendChild(delBtn);
            card.appendChild(header);

            card.appendChild(admin.buildInput("Quote Text", item.original, val => admin.updateQuote(item.id, "original", val)));
            card.appendChild(admin.buildInput("Translation (Meaning)", item.translation, val => admin.updateQuote(item.id, "translation", val)));
            card.appendChild(admin.buildInput("Effect Phrase", item.effect, val => admin.updateQuote(item.id, "effect", val)));

            const typeGroup = document.createElement("div");
            typeGroup.className = "input-group";
            const typeLabel = document.createElement("label");
            typeLabel.textContent = "Type";
            const typeSel = document.createElement("select");
            ["tone", "structure", "language"].forEach(opt => {
                const option = document.createElement("option");
                option.value = opt;
                option.textContent = opt;
                if (item.type === opt) option.selected = true;
                typeSel.appendChild(option);
            });
            typeSel.onchange = () => admin.updateQuote(item.id, "type", typeSel.value);
            typeGroup.appendChild(typeLabel);
            typeGroup.appendChild(typeSel);
            card.appendChild(typeGroup);

            card.appendChild(admin.buildInput("Translation Distractors (comma separated)", (item.translationDistractors || []).join(", "), val => admin.updateQuote(item.id, "translationDistractors", val, true)));
            card.appendChild(admin.buildInput("Effect Distractors (comma separated)", (item.effectDistractors || []).join(", "), val => admin.updateQuote(item.id, "effectDistractors", val, true)));

            const levels = document.createElement("div");
            levels.className = "level-checks";
            [1, 2, 3].forEach(lvl => {
                const label = document.createElement("label");
                const cb = document.createElement("input");
                cb.type = "checkbox";
                cb.checked = (item.levels || []).includes(lvl);
                cb.onchange = () => admin.toggleLevel(item.id, lvl, cb.checked);
                label.appendChild(cb);
                label.appendChild(document.createTextNode(`L${lvl}`));
                levels.appendChild(label);
            });
            card.appendChild(levels);

            cont.appendChild(card);
        });
    },

    buildInput: function(labelText, value, onChange) {
        const group = document.createElement("div");
        group.className = "input-group";
        const label = document.createElement("label");
        label.textContent = labelText;
        const input = document.createElement("input");
        input.value = value || "";
        input.oninput = () => onChange(input.value);
        group.appendChild(label);
        group.appendChild(input);
        return group;
    },

    parseCSV: function(text) {
        return (text || "")
            .split(",")
            .map(t => t.trim())
            .filter(Boolean);
    },

    exportStandalone: function() {
        let h = document.documentElement.outerHTML;
        const marker = /\/\*DEFAULT_DATA_START\*\/[\s\S]*?\/\*DEFAULT_DATA_END\*\//;
        const payload = `/*DEFAULT_DATA_START*/\nconst defaultData = ${JSON.stringify(app.data, null, 2)};\n/*DEFAULT_DATA_END*/`;
        if (!marker.test(h)) {
            return alert("Could not locate defaultData block.");
        }
        h = h.replace(marker, payload);
        const b = new Blob([h], { type: "text/html" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(b);
        a.download = "Tone_Structure_Architect_v3.html";
        a.click();
    },

    exportWorksheet: function() {
        let html = `<h1>${app.data.meta.title}</h1><p>${app.data.sourceText}</p>`;
        app.data.items.forEach(item => {
            html += `<p><strong>"${item.original}"</strong></p>`;
            html += `<p>__________________________________________</p>`;
        });
        const b = new Blob(["\ufeff" + html], { type: "application/msword" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(b);
        a.download = "Worksheet.doc";
        a.click();
    },

    saveConfig: function() {
        const b = new Blob([JSON.stringify(app.data, null, 2)], { type: "application/json" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(b);
        a.download = "config.json";
        a.click();
    },

    loadFile: function(input) {
        const f = input.files[0];
        if (!f) return;
        const r = new FileReader();
        r.onload = e => {
            try {
                app.data = app.validateAndRepair(JSON.parse(e.target.result));
                app.save();
                ui.updateAll();
                admin.renderQuoteEditor();
            } catch (err) {
                alert("Invalid File");
            }
        };
        r.readAsText(f);
    }
};

window.onload = app.init;
</script>
</body>
</html>
