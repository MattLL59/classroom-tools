<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tone & Structure Architect</title>
  <style>
    :root {
      --ink: #1a1a1a;
      --paper: #f8f4ef;
      --cream: #efe8df;
      --accent: #2d5a4a;
      --accent-light: #3d7a64;
      --success: #2d5a3d;
      --error: #8b3a3a;
      --border: #d4c9bc;
      --shadow: rgba(45, 90, 74, 0.12);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      background: var(--paper);
      color: var(--ink);
      min-height: 100vh;
      padding-bottom: 72px;
    }
    h1, h2, .serif { font-family: Georgia, 'Times New Roman', serif; }

    /* Header */
    .header {
      padding: 1rem 1.25rem;
      background: linear-gradient(135deg, var(--accent) 0%, var(--accent-light) 100%);
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    .header h1 { font-size: 1.25rem; font-weight: 600; }
    .header-right { display: flex; align-items: center; gap: 0.75rem; }
    .level-badge {
      background: rgba(255,255,255,0.25);
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      border: none;
      color: inherit;
    }
    .xp-badge {
      background: rgba(255,255,255,0.25);
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      font-size: 0.8rem;
    }
    .btn-icon {
      background: transparent;
      border: none;
      cursor: pointer;
      font-size: 1.25rem;
      padding: 0.25rem;
      border-radius: 6px;
      transition: background 0.2s;
    }
    .btn-icon:hover { background: rgba(255,255,255,0.2); }

    /* Main views */
    .view { display: none; padding: 1rem 1.25rem; }
    .view.active { display: block; }

    /* Evidence Lab */
    .view-text-wrap { margin-bottom: 1rem; }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      transition: background 0.2s, transform 0.15s;
    }
    .btn:hover { background: var(--accent-light); }
    .btn:active { transform: scale(0.98); }
    .btn.secondary { background: var(--cream); color: var(--ink); border: 1px solid var(--border); }
    .btn.secondary:hover { background: #e8dfd4; }

    .quote-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
      gap: 0.75rem;
    }
    .quote-card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem;
      cursor: pointer;
      transition: box-shadow 0.2s, transform 0.15s;
      min-height: 100px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .quote-card:hover {
      box-shadow: 0 4px 12px var(--shadow);
      transform: translateY(-2px);
    }
    .quote-card.done {
      border-color: var(--success);
      background: rgba(45, 90, 61, 0.08);
    }
    .quote-card.done::after {
      content: '‚úì';
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      color: var(--success);
      font-weight: bold;
      font-size: 1rem;
    }
    .quote-card { position: relative; padding-right: 2rem; }
    .quote-card .preview {
      font-family: Georgia, serif;
      font-size: 0.9rem;
      font-style: italic;
      color: #444;
      line-height: 1.35;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }
    .quote-card.global {
      grid-column: 1 / -1;
      background: linear-gradient(135deg, #f0ebe6 0%, #e8e2d9 100%);
      border-color: var(--accent);
      min-height: 80px;
    }
    .quote-card.global .preview { font-style: normal; font-weight: 600; }

    .step-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; color: #666; margin-bottom: 0.25rem; }

    /* Modals */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 1rem;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.2s, visibility 0.2s;
    }
    .modal-overlay.open { opacity: 1; visibility: visible; }
    .modal {
      background: #fff;
      border-radius: 12px;
      max-width: 520px;
      width: 100%;
      max-height: 85vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 50px rgba(0,0,0,0.2);
      transform: scale(0.95);
      transition: transform 0.2s;
    }
    .modal-overlay.open .modal { transform: scale(1); }
    .modal-header {
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .modal-header h3 { font-size: 1.1rem; }
    .modal-body {
      padding: 1.25rem;
      overflow-y: auto;
      flex: 1;
    }
    .modal-footer {
      padding: 1rem 1.25rem;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 0.5rem;
      justify-content: flex-end;
    }
    .source-text-content {
      font-family: Georgia, serif;
      font-size: 1.05rem;
      line-height: 1.65;
      white-space: pre-wrap;
      color: #333;
    }
    .option-list { display: flex; flex-direction: column; gap: 0.5rem; }
    .option-btn {
      width: 100%;
      text-align: left;
      padding: 0.75rem 1rem;
      background: var(--cream);
      border: 2px solid transparent;
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.95rem;
      cursor: pointer;
      transition: border-color 0.2s, background 0.2s;
    }
    .option-btn:hover { background: #e8dfd4; border-color: var(--border); }
    .option-btn.correct { border-color: var(--success); background: rgba(45, 90, 61, 0.15); }
    .option-btn.wrong { border-color: var(--error); background: rgba(139, 58, 58, 0.1); animation: shake 0.4s; }
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      20% { transform: translateX(-6px); }
      40% { transform: translateX(6px); }
      60% { transform: translateX(-4px); }
      80% { transform: translateX(4px); }
    }
    .option-btn:disabled { cursor: default; opacity: 0.85; }
    .quote-in-modal { font-style: italic; color: #555; margin-bottom: 1rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border); }
    .lens-tabs { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .lens-tab {
      padding: 0.5rem 1rem;
      background: var(--cream);
      border: 2px solid transparent;
      border-radius: 8px;
      font-family: inherit;
      cursor: pointer;
      transition: all 0.2s;
    }
    .lens-tab:hover { background: #e8dfd4; }
    .lens-tab.selected { border-color: var(--accent); background: rgba(45, 90, 74, 0.1); }

    .feedback-toast {
      position: fixed;
      bottom: 90px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      padding: 0.75rem 1.25rem;
      border-radius: 10px;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      z-index: 1100;
      opacity: 0;
      visibility: hidden;
      transition: opacity 0.25s, transform 0.25s, visibility 0.25s;
    }
    .feedback-toast.show {
      opacity: 1;
      visibility: visible;
      transform: translateX(-50%) translateY(0);
    }
    .feedback-toast.success { background: var(--success); color: #fff; }
    .feedback-toast.error { background: var(--error); color: #fff; }

    /* Writing Desk */
    .sentence-builder { margin-bottom: 1.25rem; }
    .slot-row {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }
    .slot-label {
      font-size: 0.8rem;
      color: #666;
      min-width: 80px;
    }
    .slot-row select, .slot-row input[type="text"] {
      flex: 1;
      min-width: 160px;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.95rem;
      background: #fff;
    }
    .slot-row input[type="text"]:focus, .slot-row select:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(45, 90, 74, 0.2);
    }
    .preview-box {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1rem 1.25rem;
      min-height: 120px;
      font-family: Georgia, serif;
      font-size: 1.05rem;
      line-height: 1.6;
      color: var(--ink);
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .preview-box:empty::before { content: 'Your sentence will appear here‚Ä¶'; color: #999; }
    .preview-label { font-size: 0.8rem; color: #666; margin-bottom: 0.5rem; }

    /* Bottom nav */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      height: 64px;
      background: #fff;
      border-top: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      padding: 0 1rem;
      z-index: 100;
    }
    .nav-btn {
      flex: 1;
      max-width: 160px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 0.2rem;
      padding: 0.5rem;
      background: transparent;
      border: none;
      border-radius: 10px;
      font-family: inherit;
      font-size: 0.8rem;
      color: #666;
      cursor: pointer;
      transition: background 0.2s, color 0.2s;
    }
    .nav-btn .icon { font-size: 1.4rem; }
    .nav-btn:hover { background: var(--cream); color: var(--ink); }
    .nav-btn.active { background: rgba(45, 90, 74, 0.12); color: var(--accent); font-weight: 500; }

    /* Teacher Admin */
    .admin-section {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 1.25rem;
      margin-bottom: 1rem;
    }
    .admin-section h3 { margin-bottom: 0.75rem; font-size: 1rem; }
    .admin-section textarea, .admin-section input[type="text"] {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      font-family: inherit;
      font-size: 0.9rem;
      margin-bottom: 0.5rem;
    }
    .admin-section textarea { min-height: 80px; resize: vertical; }
    .config-slots { margin-top: 0.75rem; }
    .config-slot {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-bottom: 0.5rem;
    }
    .config-slot select { padding: 0.4rem 0.6rem; border-radius: 6px; border: 1px solid var(--border); font-family: inherit; }
    .help-modal .modal-body { font-size: 0.95rem; line-height: 1.6; }
    .help-modal .modal-body h4 { margin: 1rem 0 0.5rem; font-size: 1rem; }
    .help-modal .modal-body h4:first-child { margin-top: 0; }
    .help-modal .modal-body ul { margin-left: 1.25rem; margin-bottom: 0.5rem; }
  </style>
</head>
<body>
  <header class="header">
    <h1>Tone & Structure Architect</h1>
    <div class="header-right">
      <button type="button" class="level-badge" id="levelBtn" title="Click to change level">Lvl <span id="levelNum">1</span></button>
      <span class="xp-badge"><span id="xpVal">0</span> XP</span>
      <button type="button" class="btn-icon" id="helpBtn" title="Help">‚ùì</button>
      <button type="button" class="btn-icon" id="adminBtn" title="Teacher Admin">‚öôÔ∏è</button>
    </div>
  </header>

  <main>
    <section id="viewEvidence" class="view active">
      <div class="view-text-wrap">
        <button type="button" class="btn" id="viewTextBtn">üìÑ View Text</button>
      </div>
      <div class="quote-grid" id="quoteGrid"></div>
    </section>

    <section id="viewWriting" class="view">
      <div class="sentence-builder" id="sentenceBuilder"></div>
      <p class="preview-label">Preview / Editable</p>
      <div class="preview-box" id="previewBox" contenteditable="true"></div>
    </section>

    <section id="viewAdmin" class="view">
      <div style="display:flex;align-items:center;gap:0.5rem;margin-bottom:1rem;">
        <button type="button" class="btn secondary" id="adminBackBtn">‚Üê Back</button>
        <h2 class="serif" style="margin:0;">‚öôÔ∏è Teacher Admin</h2>
      </div>
      <div class="admin-section">
        <h3>Source Text</h3>
        <textarea id="adminSource" placeholder="Paste the full passage‚Ä¶"></textarea>
      </div>
      <div class="admin-section">
        <h3>Quotes (one per line: quote|level|paraphrase1|paraphrase2(correct)|lens|effect1|effect2(correct))</h3>
        <p style="font-size:0.85rem;color:#666;margin-bottom:0.5rem;">Format: quote|level|paraphrase1;;paraphrase2(correct)|lens|effect1;;effect2(correct). Use ;; between options. Mark correct with (correct).</p>
        <textarea id="adminQuotes" placeholder="e.g. &quot;It was dark.&quot;|1|It was bright;;It was dark (correct)|Tone|Creates joy;;Creates tension (correct)"></textarea>
      </div>
      <div class="admin-section">
        <h3>Global Structure</h3>
        <input type="text" id="adminGlobalQ" placeholder="Question (e.g. How is the whole text structured?)">
        <input type="text" id="adminGlobalOpts" placeholder="Options, comma-separated. Add (correct) to right answer.">
      </div>
      <div class="admin-section">
        <h3>Sentence Configuration</h3>
        <p style="font-size:0.85rem;color:#666;margin-bottom:0.5rem;">Order of slots. Types: Starter, Quote, Method, Analysis, Manual.</p>
        <div class="config-slots" id="configSlots"></div>
        <button type="button" class="btn secondary" id="addSlotBtn">+ Add slot</button>
      </div>
      <div class="admin-section">
        <h3>Dropdown Options (per type)</h3>
        <p style="font-size:0.85rem;color:#666;margin-bottom:0.5rem;">One option per line. Type name then colon, then options.</p>
        <textarea id="adminOptions" placeholder="Starter:&#10;The writer suggests...&#10;This implies...&#10;Method:&#10;through dialogue&#10;via imagery"></textarea>
      </div>
      <div style="display:flex;gap:0.5rem;">
        <button type="button" class="btn" id="saveConfigBtn">üíæ Save Lesson</button>
        <button type="button" class="btn secondary" id="loadDefaultBtn">üìã Load default</button>
      </div>
    </section>
  </main>

  <div class="bottom-nav">
    <button type="button" class="nav-btn active" data-view="evidence"><span class="icon">üî¨</span> Evidence Lab</button>
    <button type="button" class="nav-btn" data-view="writing"><span class="icon">‚úçÔ∏è</span> Writing Desk</button>
  </div>

  <div class="modal-overlay" id="sourceModal">
    <div class="modal">
      <div class="modal-header">
        <h3>üìÑ Source Text</h3>
        <button type="button" class="btn-icon" data-close="sourceModal">‚úï</button>
      </div>
      <div class="modal-body">
        <div class="source-text-content" id="sourceTextContent"></div>
      </div>
    </div>
  </div>

  <div class="modal-overlay" id="workflowModal">
    <div class="modal">
      <div class="modal-header">
        <h3 id="workflowTitle">Quote Analysis</h3>
        <button type="button" class="btn-icon" data-close="workflowModal">‚úï</button>
      </div>
      <div class="modal-body" id="workflowBody"></div>
      <div class="modal-footer" id="workflowFooter"></div>
    </div>
  </div>

  <div class="modal-overlay" id="helpModal">
    <div class="modal help-modal">
      <div class="modal-header">
        <h3>‚ùì Help</h3>
        <button type="button" class="btn-icon" data-close="helpModal">‚úï</button>
      </div>
      <div class="modal-body">
        <h4>Evidence Lab</h4>
        <ul>
          <li>üìÑ View Text: read the full passage.</li>
          <li>Click a quote card to analyse it in 3 steps: Match Meaning ‚Üí Select Lens ‚Üí Analyse Effect.</li>
          <li>Whole Text Structure: one global question on how the text is organised.</li>
          <li>Correct answers earn +10 XP. Completed quotes are marked with ‚úì.</li>
        </ul>
        <h4>Writing Desk</h4>
        <ul>
          <li>Build sentences using the dropdowns (or text inputs for Manual slots).</li>
          <li>Your sentence updates live in the preview box. You can edit it there too.</li>
        </ul>
        <h4>Levels</h4>
        <p>Quotes filter by your level (Lvl 1‚Äì3). Click the level badge in the header to cycle levels.</p>
      </div>
    </div>
  </div>

  <div class="feedback-toast" id="feedbackToast"></div>

  <script>
(function () {
  const STORAGE_KEY = 'toneStructureArchitect';
  const TEACHER_CONFIG_KEY = 'toneStructureTeacherConfig';

  const defaultLesson = {
    sourceText: 'The room was silent. Emma stood by the window, watching the first flakes of snow drift past the streetlamps. She had always loved winter‚Äîthe way it seemed to slow the world down, to strip away the unnecessary. But tonight felt different. The silence was heavy, expectant. Somewhere in the house, a clock struck midnight.',
    quotes: [
      { id: 'q1', text: 'The room was silent.', level: 1, paraphrases: [{ text: 'The room was noisy.', correct: false }, { text: 'There was no sound in the room.', correct: true }], lens: 'Tone', effects: [{ text: 'Creates a calm mood.', correct: false }, { text: 'Creates tension and anticipation.', correct: true }] },
      { id: 'q2', text: 'the way it seemed to slow the world down', level: 1, paraphrases: [{ text: 'time appears to pass more slowly.', correct: true }, { text: 'the world speeds up.', correct: false }], lens: 'Structure', effects: [{ text: 'Emphasises the passing of time.', correct: true }, { text: 'Introduces a new character.', correct: false }] },
      { id: 'q3', text: 'The silence was heavy, expectant.', level: 2, paraphrases: [{ text: 'The quiet felt weighty and full of possibility.', correct: true }, { text: 'The silence was light and cheerful.', correct: false }], lens: 'Language', effects: [{ text: 'Uses sensory language to build atmosphere.', correct: true }, { text: 'Provides factual description only.', correct: false }] },
      { id: 'q4', text: 'a clock struck midnight.', level: 2, paraphrases: [{ text: 'Midnight was signalled by a clock.', correct: true }, { text: 'A clock stopped at noon.', correct: false }], lens: 'Tone', effects: [{ text: 'Suggests a turning point or transition.', correct: true }, { text: 'Adds comic relief.', correct: false }] },
      { id: 'q5', text: 'to strip away the unnecessary', level: 3, paraphrases: [{ text: 'to remove what doesn\'t matter.', correct: true }, { text: 'to add more detail.', correct: false }], lens: 'Language', effects: [{ text: 'Reflects Emma\'s reflective state of mind.', correct: true }, { text: 'Describes the weather.', correct: false }] }
    ],
    globalStructure: {
      question: 'How is the whole text structured?',
      options: [
        { text: 'Chronological description of a single evening.', correct: true },
        { text: 'A series of flashbacks.', correct: false },
        { text: 'Dialogue-driven narrative.', correct: false }
      ]
    },
    sentenceConfig: {
      slots: [
        { type: 'Starter' },
        { type: 'Quote' },
        { type: 'Method' },
        { type: 'Analysis' }
      ],
      options: {
        Starter: ['The writer suggests that', 'This implies', 'Through this, the writer'],
        Quote: ['"The room was silent."', '"the way it seemed to slow the world down"', '"The silence was heavy, expectant."'],
        Method: ['through the use of imagery', 'via contrast', 'by focusing on sensory detail'],
        Analysis: ['creates tension.', 'emphasises the theme of isolation.', 'highlights a turning point.']
      }
    }
  };

  let state = {
    level: 1,
    score: 0,
    completedQuotes: [],
    completedGlobal: false,
    essay: '',
    currentView: 'evidence'
  };

  let teacherConfig = null;
  let workflowState = { step: 0, quoteId: null, chosenLens: null, isGlobal: false };

  function loadState() {
    try {
      const s = localStorage.getItem(STORAGE_KEY);
      if (s) state = { ...state, ...JSON.parse(s) };
    } catch (_) {}
  }

  function saveState() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify({
        level: state.level,
        score: state.score,
        completedQuotes: state.completedQuotes,
        completedGlobal: state.completedGlobal,
        essay: document.getElementById('previewBox')?.innerText || state.essay
      }));
    } catch (_) {}
  }

  function loadTeacherConfig() {
    try {
      const c = localStorage.getItem(TEACHER_CONFIG_KEY);
      teacherConfig = c ? JSON.parse(c) : null;
    } catch (_) {}
    if (!teacherConfig) teacherConfig = JSON.parse(JSON.stringify(defaultLesson));
  }

  function saveTeacherConfig() {
    try {
      localStorage.setItem(TEACHER_CONFIG_KEY, JSON.stringify(teacherConfig));
    } catch (_) {}
  }

  function getConfig() {
    if (!teacherConfig) loadTeacherConfig();
    return teacherConfig || defaultLesson;
  }

  function showToast(message, success) {
    const el = document.getElementById('feedbackToast');
    el.textContent = (success ? '‚úì ' : '‚úï ') + message;
    el.className = 'feedback-toast ' + (success ? 'success' : 'error');
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 2000);
  }

  function openModal(id) {
    document.getElementById(id).classList.add('open');
  }

  function closeModal(id) {
    document.getElementById(id).classList.remove('open');
  }

  function setView(name) {
    state.currentView = name;
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const viewId = name === 'evidence' ? 'viewEvidence' : name === 'writing' ? 'viewWriting' : 'viewAdmin';
    const btn = document.querySelector(`.nav-btn[data-view="${name}"]`);
    if (document.getElementById(viewId)) document.getElementById(viewId).classList.add('active');
    if (btn) btn.classList.add('active');
    if (name === 'writing') renderWritingDesk();
  }

  function showAdmin(hide) {
    const admin = document.getElementById('viewAdmin');
    const evidence = document.getElementById('viewEvidence');
    const writing = document.getElementById('viewWriting');
    if (hide) {
      admin.classList.remove('active');
      evidence.classList.remove('active');
      writing.classList.remove('active');
      const cur = state.currentView === 'writing' ? 'writing' : 'evidence';
      const viewEl = cur === 'writing' ? writing : evidence;
      if (viewEl) viewEl.classList.add('active');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      document.querySelector(`.nav-btn[data-view="${cur}"]`)?.classList.add('active');
      if (cur === 'writing') renderWritingDesk();
      return;
    }
    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    admin.classList.add('active');
    renderAdmin();
  }

  function renderHeader() {
    const levelEl = document.getElementById('levelNum');
    const xpEl = document.getElementById('xpVal');
    if (levelEl) levelEl.textContent = state.level;
    if (xpEl) xpEl.textContent = state.score;
  }

  function renderQuoteGrid() {
    const cfg = getConfig();
    const grid = document.getElementById('quoteGrid');
    if (!grid) return;
    grid.innerHTML = '';

    const levelQuotes = (cfg.quotes || []).filter(q => q.level <= state.level);
    levelQuotes.forEach(q => {
      const card = document.createElement('div');
      card.className = 'quote-card' + (state.completedQuotes.includes(q.id) ? ' done' : '');
      card.innerHTML = '<div class="preview">' + escapeHtml(q.text) + '</div>';
      card.dataset.quoteId = q.id;
      card.addEventListener('click', () => startQuoteWorkflow(q.id, false));
      grid.appendChild(card);
    });

    if (cfg.globalStructure && cfg.globalStructure.question) {
      const global = document.createElement('div');
      global.className = 'quote-card global' + (state.completedGlobal ? ' done' : '');
      global.innerHTML = '<div class="preview">' + escapeHtml(cfg.globalStructure.question) + '</div>';
      global.addEventListener('click', () => startGlobalWorkflow());
      grid.appendChild(global);
    }
  }

  function escapeHtml(s) {
    const d = document.createElement('div');
    d.textContent = s;
    return d.innerHTML;
  }

  function startQuoteWorkflow(quoteId, isGlobal) {
    workflowState = { step: 0, quoteId, chosenLens: null, isGlobal: false };
    if (isGlobal) {
      workflowState.isGlobal = true;
      renderGlobalWorkflow();
    } else {
      renderWorkflowStep();
    }
    openModal('workflowModal');
  }

  function startGlobalWorkflow() {
    startQuoteWorkflow(null, true);
  }

  function renderWorkflowStep() {
    const cfg = getConfig();
    const quote = (cfg.quotes || []).find(q => q.id === workflowState.quoteId);
    if (!quote) return;

    const title = document.getElementById('workflowTitle');
    const body = document.getElementById('workflowBody');
    const footer = document.getElementById('workflowFooter');
    title.textContent = 'Quote Analysis';
    footer.innerHTML = '';

    const steps = ['Match Meaning', 'Select Lens', 'Analyse Effect'];
    const step = workflowState.step;

    if (step === 0) {
      body.innerHTML = '<p class="quote-in-modal">' + escapeHtml(quote.text) + '</p><p class="step-label">Match Meaning</p><div class="option-list" id="workflowOptions"></div>';
      const list = document.getElementById('workflowOptions');
      quote.paraphrases.forEach((p, i) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'option-btn';
        btn.textContent = p.text;
        btn.addEventListener('click', () => {
          quote.paraphrases.forEach((_, j) => {
            const b = list.querySelectorAll('.option-btn')[j];
            b.disabled = true;
            if (quote.paraphrases[j].correct) b.classList.add('correct');
            else if (j === i) b.classList.add('wrong');
          });
          if (p.correct) {
            workflowState.step = 1;
            setTimeout(() => renderWorkflowStep(), 600);
          } else {
            showToast('Try again.', false);
          }
        });
        list.appendChild(btn);
      });
      return;
    }

    if (step === 1) {
      body.innerHTML = '<p class="quote-in-modal">' + escapeHtml(quote.text) + '</p><p class="step-label">Select Lens</p><div class="lens-tabs" id="workflowOptions"></div>';
      const tabs = document.getElementById('workflowOptions');
      ['Tone', 'Structure', 'Language'].forEach(lens => {
        const tab = document.createElement('button');
        tab.type = 'button';
        tab.className = 'lens-tab' + (workflowState.chosenLens === lens ? ' selected' : '');
        tab.textContent = lens;
        tab.addEventListener('click', () => {
          workflowState.chosenLens = lens;
          tabs.querySelectorAll('.lens-tab').forEach(t => t.classList.remove('selected'));
          tab.classList.add('selected');
        });
        tabs.appendChild(tab);
      });
      footer.innerHTML = '<button type="button" class="btn" id="workflowNext">Next</button>';
      document.getElementById('workflowNext').addEventListener('click', () => {
        if (!workflowState.chosenLens) return;
        workflowState.step = 2;
        renderWorkflowStep();
      });
      return;
    }

    if (step === 2) {
      body.innerHTML = '<p class="quote-in-modal">' + escapeHtml(quote.text) + '</p><p class="step-label">Analyse Effect</p><div class="option-list" id="workflowOptions"></div>';
      const list = document.getElementById('workflowOptions');
      const effects = (quote.effects || []).filter(e => e);
      effects.forEach((ef, i) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'option-btn';
        btn.textContent = ef.text;
        btn.addEventListener('click', () => {
          effects.forEach((_, j) => {
            const b = list.querySelectorAll('.option-btn')[j];
            b.disabled = true;
            if (effects[j].correct) b.classList.add('correct');
            else if (j === i) b.classList.add('wrong');
          });
          if (ef.correct) {
            const alreadyDone = state.completedQuotes.includes(quote.id);
            if (!alreadyDone) {
              state.score += 10;
              showToast('+10 XP', true);
            }
            state.completedQuotes = [...new Set([...state.completedQuotes, quote.id])];
            saveState();
            renderHeader();
            renderQuoteGrid();
            setTimeout(() => { closeModal('workflowModal'); renderQuoteGrid(); }, 800);
          } else {
            showToast('Try again.', false);
          }
        });
        list.appendChild(btn);
      });
    }
  }

  function renderGlobalWorkflow() {
    const cfg = getConfig();
    const g = cfg.globalStructure;
    if (!g) return;

    const title = document.getElementById('workflowTitle');
    const body = document.getElementById('workflowBody');
    const footer = document.getElementById('workflowFooter');
    title.textContent = 'Whole Text Structure';
    footer.innerHTML = '';

    body.innerHTML = '<p class="step-label">' + escapeHtml(g.question) + '</p><div class="option-list" id="workflowOptions"></div>';
    const list = document.getElementById('workflowOptions');
    (g.options || []).forEach((opt, i) => {
      const btn = document.createElement('button');
      btn.type = 'button';
      btn.className = 'option-btn';
      btn.textContent = opt.text;
      btn.addEventListener('click', () => {
        g.options.forEach((o, j) => {
          const b = list.querySelectorAll('.option-btn')[j];
          b.disabled = true;
          if (o.correct) b.classList.add('correct');
          else if (j === i) b.classList.add('wrong');
        });
        if (opt.correct) {
          if (!state.completedGlobal) {
            state.score += 10;
            showToast('+10 XP', true);
          }
          state.completedGlobal = true;
          saveState();
          renderHeader();
          renderQuoteGrid();
          setTimeout(() => closeModal('workflowModal'), 800);
        } else {
          showToast('Try again.', false);
        }
      });
      list.appendChild(btn);
    });
  }

  function renderWritingDesk() {
    const cfg = getConfig();
    const sc = cfg.sentenceConfig || { slots: [], options: {} };
    const container = document.getElementById('sentenceBuilder');
    const preview = document.getElementById('previewBox');
    if (!container || !preview) return;

    container.innerHTML = '';
    const parts = [];

    (sc.slots || []).forEach((slot, idx) => {
      const row = document.createElement('div');
      row.className = 'slot-row';
      row.innerHTML = '<span class="slot-label">' + escapeHtml(slot.type) + '</span>';
      const opts = sc.options && sc.options[slot.type] ? sc.options[slot.type] : [];

      if (slot.type === 'Manual') {
        const input = document.createElement('input');
        input.type = 'text';
        input.placeholder = 'Type here‚Ä¶';
        input.dataset.slotIdx = String(idx);
        input.dataset.slotType = 'Manual';
        input.addEventListener('input', () => updatePreview());
        row.appendChild(input);
      } else {
        const sel = document.createElement('select');
        sel.dataset.slotIdx = String(idx);
        sel.dataset.slotType = slot.type;
        const blank = document.createElement('option');
        blank.value = '';
        blank.textContent = '‚Äî Select ‚Äî';
        sel.appendChild(blank);
        (opts || []).forEach(o => {
          const opt = document.createElement('option');
          opt.value = typeof o === 'string' ? o : (o.text || o);
          opt.textContent = typeof o === 'string' ? o : (o.text || o);
          sel.appendChild(opt);
        });
        sel.addEventListener('change', () => updatePreview());
        row.appendChild(sel);
      }
      container.appendChild(row);
    });

    function updatePreview() {
      const segs = [];
      container.querySelectorAll('.slot-row').forEach(r => {
        const sel = r.querySelector('select');
        const inp = r.querySelector('input[type="text"]');
        if (sel && sel.value) segs.push(sel.value);
        if (inp && inp.value.trim()) segs.push(inp.value.trim());
      });
      preview.innerText = segs.join(' ');
      saveState();
    }

    const saved = state.essay;
    if (saved) preview.innerText = saved;
    else updatePreview();
  }

  function renderAdmin() {
    const cfg = getConfig();
    const source = document.getElementById('adminSource');
    const quotes = document.getElementById('adminQuotes');
    const gq = document.getElementById('adminGlobalQ');
    const gopts = document.getElementById('adminGlobalOpts');
    const opts = document.getElementById('adminOptions');
    if (source) source.value = cfg.sourceText || '';
    if (gq) gq.value = (cfg.globalStructure && cfg.globalStructure.question) || '';
    if (gopts) {
      const o = (cfg.globalStructure && cfg.globalStructure.options) || [];
      gopts.value = o.map(x => x.text + (x.correct ? ' (correct)' : '')).join(', ');
    }
    if (quotes) {
      const qs = (cfg.quotes || []).map(q => {
        const par = (q.paraphrases || []).map(p => p.text + (p.correct ? ' (correct)' : '')).join(';;');
        const ef = (q.effects || []).map(e => e.text + (e.correct ? ' (correct)' : '')).join(';;');
        return [q.text, q.level, par, q.lens, ef].join('|');
      });
      quotes.value = qs.join('\n');
    }

    const slotContainer = document.getElementById('configSlots');
    if (slotContainer) {
      slotContainer.innerHTML = '';
      (cfg.sentenceConfig && cfg.sentenceConfig.slots || []).forEach((slot, i) => {
        const row = document.createElement('div');
        row.className = 'config-slot';
        const sel = document.createElement('select');
        ['Starter', 'Quote', 'Method', 'Analysis', 'Manual'].forEach(t => {
          const o = document.createElement('option');
          o.value = t;
          o.textContent = t;
          if (slot.type === t) o.selected = true;
          sel.appendChild(o);
        });
        sel.dataset.idx = String(i);
        const rem = document.createElement('button');
        rem.type = 'button';
        rem.className = 'btn secondary';
        rem.textContent = '‚úï';
        rem.addEventListener('click', () => {
          cfg.sentenceConfig.slots.splice(i, 1);
          renderAdmin();
        });
        row.appendChild(sel);
        row.appendChild(rem);
        slotContainer.appendChild(row);
      });
    }

    if (opts && cfg.sentenceConfig && cfg.sentenceConfig.options) {
      const lines = [];
      Object.entries(cfg.sentenceConfig.options).forEach(([k, v]) => {
        lines.push(k + ':');
        (v || []).forEach(x => lines.push(typeof x === 'string' ? x : (x.text || x)));
      });
      opts.value = lines.join('\n');
    }
  }

  function parseAdminAndSave() {
    const cfg = getConfig();
    const source = document.getElementById('adminSource');
    const quotes = document.getElementById('adminQuotes');
    const gq = document.getElementById('adminGlobalQ');
    const gopts = document.getElementById('adminGlobalOpts');
    const opts = document.getElementById('adminOptions');
    const slotContainer = document.getElementById('configSlots');

    cfg.sourceText = source ? source.value.trim() : '';

    const qLines = quotes && quotes.value.trim() ? quotes.value.trim().split('\n') : [];
    cfg.quotes = [];
    qLines.forEach((line, i) => {
      const parts = line.split('|').map(s => s.trim());
      if (parts.length < 5) return;
      const text = parts[0];
      const level = Math.max(1, Math.min(3, parseInt(parts[1], 10) || 1));
      const paraphraseStrs = (parts[2] || '').split(';;').map(s => s.trim()).filter(Boolean);
      const lens = parts[3] || 'Tone';
      const effectStrs = (parts[4] || '').split(';;').map(s => s.trim()).filter(Boolean);
      const paraphrases = paraphraseStrs.map(s => ({ text: s.replace(/\s*\(correct\)\s*$/i, '').trim(), correct: /\s*\(correct\)\s*$/i.test(s) }));
      const effects = effectStrs.map(s => ({ text: s.replace(/\s*\(correct\)\s*$/i, '').trim(), correct: /\s*\(correct\)\s*$/i.test(s) }));
      cfg.quotes.push({ id: 'q' + (i + 1), text, level, paraphrases, lens, effects });
    });

    if (gq && gopts) {
      cfg.globalStructure = { question: gq.value.trim(), options: [] };
      const oStrs = gopts.value.split(',').map(s => s.trim()).filter(Boolean);
      oStrs.forEach(s => {
        const correct = /\(correct\)$/i.test(s);
        cfg.globalStructure.options.push({ text: s.replace(/\(correct\)$/i, '').trim(), correct });
      });
    }

    cfg.sentenceConfig = cfg.sentenceConfig || { slots: [], options: {} };
    cfg.sentenceConfig.slots = [];
    if (slotContainer) {
      slotContainer.querySelectorAll('.config-slot select').forEach(sel => {
        cfg.sentenceConfig.slots.push({ type: sel.value });
      });
    }

    cfg.sentenceConfig.options = {};
    if (opts && opts.value.trim()) {
      const lines = opts.value.split('\n').map(s => s.trim());
      let current = null;
      lines.forEach(l => {
        if (l.endsWith(':')) {
          current = l.slice(0, -1).trim();
          cfg.sentenceConfig.options[current] = [];
        } else if (current && l) {
          cfg.sentenceConfig.options[current].push(l);
        }
      });
    }

    teacherConfig = cfg;
    saveTeacherConfig();
    showToast('Lesson saved.', true);
  }

  function init() {
    loadState();
    loadTeacherConfig();
    renderHeader();
    renderQuoteGrid();

    document.getElementById('viewTextBtn').addEventListener('click', () => {
      document.getElementById('sourceTextContent').textContent = getConfig().sourceText || '(No source text.)';
      openModal('sourceModal');
    });

    document.querySelectorAll('[data-close]').forEach(btn => {
      btn.addEventListener('click', () => closeModal(btn.dataset.close));
    });
    document.querySelectorAll('.modal-overlay').forEach(ov => {
      ov.addEventListener('click', e => { if (e.target === ov) closeModal(ov.id); });
    });

    document.querySelectorAll('.nav-btn[data-view]').forEach(btn => {
      btn.addEventListener('click', () => setView(btn.dataset.view));
    });

    document.getElementById('adminBtn').addEventListener('click', () => showAdmin(false));
    document.getElementById('adminBackBtn').addEventListener('click', () => showAdmin(true));

    document.getElementById('helpBtn').addEventListener('click', () => openModal('helpModal'));

    document.getElementById('saveConfigBtn').addEventListener('click', parseAdminAndSave);

    document.getElementById('loadDefaultBtn').addEventListener('click', () => {
      teacherConfig = JSON.parse(JSON.stringify(defaultLesson));
      saveTeacherConfig();
      renderAdmin();
      showToast('Default lesson loaded.', true);
    });

    document.getElementById('addSlotBtn').addEventListener('click', () => {
      const cfg = getConfig();
      cfg.sentenceConfig = cfg.sentenceConfig || { slots: [], options: {} };
      cfg.sentenceConfig.slots.push({ type: 'Starter' });
      renderAdmin();
    });

    const preview = document.getElementById('previewBox');
    if (preview) {
      preview.addEventListener('input', () => { state.essay = preview.innerText; saveState(); });
      preview.addEventListener('blur', () => { state.essay = preview.innerText; saveState(); });
    }

    const levelBtn = document.getElementById('levelBtn');
    if (levelBtn) {
      levelBtn.addEventListener('click', () => {
        state.level = state.level >= 3 ? 1 : state.level + 1;
        saveState();
        renderHeader();
        renderQuoteGrid();
        showToast('Level ' + state.level, true);
      });
    }
  }

  init();
})();
  </script>
</body>
</html>
