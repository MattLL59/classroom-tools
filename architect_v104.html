<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tone & Structure Architect v5.1 (Stable)</title>
<style>
    /* --- 1. CSS VARIABLES & RESET --- */
    :root {
        --primary: #009688; --accent: #ff9800; 
        --bg: #f0f2f5; --card: #ffffff; --text: #37474f; 
        --border: #cfd8dc; --success: #4caf50; --error: #f44336;
        --tone-color: #9c27b0; --struct-color: #2196f3; --lang-color: #43a047;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s, color 0.3s; }

    /* --- 2. HEADER --- */
    header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--card); box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; flex-shrink: 0; border-bottom: 1px solid var(--border); }
    h1 { margin: 0; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; font-weight: 800; }
    .score-badge { background: var(--accent); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; }
    .header-controls { display: flex; gap: 8px; align-items: center; }
    .icon-btn { background: none; border: 1px solid var(--border); border-radius: 4px; font-size: 1.2rem; cursor: pointer; padding: 4px 8px; transition: background 0.2s; color: var(--text); }
    .icon-btn:hover { background: rgba(0,0,0,0.05); }
    select.level-select { padding: 5px; border-radius: 4px; border: 1px solid var(--border); font-weight: bold; color: var(--text); background: var(--card); }

    /* --- 3. MAIN LAYOUT --- */
    .viewport { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; scroll-behavior: smooth; }
    .hub { display: none; animation: fadeIn 0.3s ease-out; }
    .hub.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* --- 4. CARDS & GRID --- */
    .section-header { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text); opacity: 0.7; margin: 20px 0 10px 0; border-bottom: 2px solid var(--border); padding-bottom: 5px; font-weight: bold; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; }
    .card { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; position: relative; transition: transform 0.1s; overflow: hidden; }
    .card:hover { transform: translateY(-2px); border-color: var(--primary); }
    .card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; }
    .card-tone::before { background: var(--tone-color); }
    .card-structure::before { background: var(--struct-color); }
    .card-language::before { background: var(--lang-color); }
    .card-global { border-left: 5px solid #607d8b; }
    .quote-text { font-family: 'Georgia', serif; font-style: italic; font-size: 1.05rem; color: var(--text); display: block; margin-bottom: 8px; }
    .card-meta { display: flex; justify-content: space-between; font-size: 0.75rem; text-transform: uppercase; font-weight: bold; opacity: 0.6; }

    /* --- 5. WRITING DESK --- */
    .builder-area { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
    .slot-row { margin-bottom: 10px; }
    .slot-label { font-size: 0.75rem; font-weight: 700; color: var(--primary); text-transform: uppercase; display: block; margin-bottom: 3px; }
    .slot-select, .slot-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 1rem; background: var(--bg); color: var(--text); }
    .slot-static { background: rgba(0, 150, 136, 0.1); color: var(--primary); padding: 10px; border-radius: 4px; font-style: italic; border: 1px solid var(--border); }
    .preview-box { padding: 15px; background: var(--card); border: 2px dashed var(--accent); border-radius: 8px; font-size: 1.1rem; line-height: 1.5; min-height: 60px; margin-bottom: 15px; color: var(--text); }
    .hint-panel { background: rgba(255, 152, 0, 0.12); border: 1px solid var(--accent); color: var(--text); padding: 8px 10px; border-radius: 6px; font-size: 0.9rem; margin-bottom: 10px; }
    .hint-panel.hidden { display: none; }
    textarea.essay-area { width: 100%; height: 200px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical; margin-bottom: 10px; background: var(--card); color: var(--text); }

    /* --- 6. BUTTONS & UI --- */
    .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 5px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-accent { background: var(--accent); color: white; }
    .btn-doc { background: #1565c0; color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--error); color: white; }
    .btn-outline { background: var(--card); border: 2px solid var(--border); color: var(--text); }
    .btn-small { padding: 4px 8px; font-size: 0.8rem; width: auto; margin: 0; }
    .filter-bar { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; }
    .filter-btn { flex: 1; min-width: 80px; padding: 8px; font-size: 0.85rem; }
    .filter-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(0, 150, 136, 0.08); }

    /* --- 7. MODALS & ADMIN --- */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .modal.open { display: flex; }
    .modal-content { background: var(--bg); width: 95%; max-width: 900px; max-height: 95vh; border-radius: 10px; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden; color: var(--text); }
    .modal-header { padding: 15px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.1rem; }
    .modal-body { padding: 20px; overflow-y: auto; }
    
    .admin-section { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 15px; margin-bottom: 15px; }
    .admin-h { color: var(--primary); margin: 0 0 10px 0; font-size: 1rem; border-bottom: 1px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
    .input-group { margin-bottom: 10px; }
    .input-group label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 3px; }
    .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); }
    
    .quote-editor, .struct-editor { border: 1px solid var(--border); border-radius: 6px; padding: 10px; margin-bottom: 10px; background: var(--bg); }
    .editor-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; margin-bottom: 8px; opacity: 0.8; font-size: 0.9rem; }
    .level-checks { display: flex; gap: 10px; margin-top: 5px; font-size: 0.85rem; align-items: center; }
    .level-checks label { display: flex; align-items: center; gap: 4px; cursor: pointer; }
    .level-checks input { margin: 0; }
    
    .level-rule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 6px; margin-top: 6px; }
    .level-rule-grid input, .level-rule-grid select { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); }
    
    .bank-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
    .bank-tag { background: rgba(0,0,0,0.05); border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
    .bank-tag button { background: none; border: none; color: var(--error); cursor: pointer; font-weight: bold; }
    .bank-btn-grid { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
    .bank-btn-grid button { flex: 1; min-width: 80px; font-size: 0.85rem; padding: 6px; }

    /* Guide Section */
    .guide-box { background: rgba(255, 152, 0, 0.1); border: 1px solid var(--accent); border-radius: 6px; padding: 10px; margin-bottom: 15px; }
    .guide-box summary { font-weight: bold; cursor: pointer; color: var(--accent); list-style: none; display: flex; align-items: center; gap: 5px; }
    .guide-box summary::-webkit-details-marker { display: none; }
    .guide-box summary::before { content: 'üìñ'; }
    .guide-content { margin-top: 10px; font-size: 0.9rem; line-height: 1.5; opacity: 0.9; white-space: pre-wrap; }
    .guide-content p { margin: 0 0 6px 0; }
    .guide-content h4 { margin: 10px 0 5px 0; color: var(--primary); }

    /* --- 8. UTILS & NAV --- */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; z-index: 900; }
    .nav-item { flex: 1; background: none; border: none; color: var(--text); opacity: 0.5; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
    .nav-item.active { color: var(--primary); opacity: 1; background: rgba(0, 150, 136, 0.05); }
    .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
    .nav-label { font-size: 0.7rem; font-weight: 700; }
    
    .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    .hidden { display: none !important; }
    
    .theme-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; }
    input[type="color"] { border: none; width: 40px; height: 40px; cursor: pointer; background: none; }
    .reader-controls { display:flex; gap:8px; flex-wrap:wrap; align-items:center; margin-bottom:10px; }
    .reader-label { font-size:0.85rem; display:flex; align-items:center; gap:6px; }
    .reader-controls input[type="range"] { width:120px; }
    .reader-body { position: relative; }
    .reader-window { position: absolute; left: 10px; right: 10px; top: 72px; height: 3.2em; border: 2px solid rgba(0, 150, 136, 0.5); border-radius: 8px; background: rgba(0, 150, 136, 0.08); pointer-events: none; z-index: 2; }
    .reader-window-line { position:absolute; left:0; right:0; top:50%; height:2px; background: rgba(0, 150, 136, 0.6); transform: translateY(-50%); }
    .stage-tag { background: rgba(0,0,0,0.04); border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; display: inline-flex; align-items: center; gap: 5px; }
    .stage-tag.clickable { cursor: pointer; }
    .question-banner { background: rgba(0, 150, 136, 0.08); border: 1px solid var(--border); border-radius: 6px; padding: 8px 10px; margin: 10px 0; font-size: 0.95rem; }

    @media print { .no-print { display: none; } }
    
    .celebration { position: fixed; inset: 0; background: rgba(12, 24, 28, 0.92); z-index: 2500; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; text-align: center; }
    .celebration.hidden { display: none; }
    .celebration-inner { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; max-width: 320px; width: 90%; }
    .celebration-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 8px; }
    .celebration-confetti { position: absolute; inset: 0; overflow: hidden; pointer-events: none; }
    .celebration-emoji { position: absolute; font-size: 1.6rem; animation: floatDown 2.5s linear infinite; opacity: 0.9; }
    @keyframes floatDown { from { transform: translateY(-10vh) rotate(0deg); } to { transform: translateY(110vh) rotate(360deg); } }

    .splash { position: fixed; inset: 0; background: #0f1416; color: #e8f5f2; z-index: 2600; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.6s ease; }
    .splash.hidden { opacity: 0; pointer-events: none; }
    .splash-title { font-size: 2rem; font-weight: 900; letter-spacing: 1px; color: var(--primary); }
    .splash-sub { font-size: 0.95rem; opacity: 0.8; margin-top: 6px; }
    .splash-glow { margin-top: 12px; width: 120px; height: 6px; background: linear-gradient(90deg, transparent, var(--accent), transparent); animation: pulse 1.2s ease-in-out infinite; border-radius: 999px; }
    @keyframes pulse { 0%, 100% { opacity: 0.2; transform: scaleX(0.7); } 50% { opacity: 1; transform: scaleX(1.1); } }
    .intro-screen { position: fixed; inset: 0; background: var(--bg); color: var(--text); z-index: 2550; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; transition: opacity 0.6s ease; }
    .intro-screen.hidden { opacity: 0; pointer-events: none; }
    .intro-text { max-width: 700px; font-size: 1.05rem; line-height: 1.6; white-space: pre-wrap; }
    .intro-hint { margin-top: 12px; font-size: 0.85rem; opacity: 0.7; }
    .pick-screen { position: fixed; inset: 0; background: var(--bg); color: var(--text); z-index: 2540; display: flex; align-items: center; justify-content: center; transition: opacity 0.6s ease; }
    .pick-screen.hidden { opacity: 0; pointer-events: none; }
    .pick-title { font-size: 1.4rem; font-weight: 800; color: var(--primary); }

    #emergency-reset { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; background: #d32f2f; color: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); text-align: center; display: none; }
</style>
</head>
<body>

    <div id="save-status" style="position:fixed; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:5px 15px; border-radius:20px; font-size:0.8rem; opacity:0; transition:0.3s; z-index:3000;">üíæ Saved</div>

    <div id="emergency-reset">
        <h2>‚ö†Ô∏è App Crashed</h2>
        <p>The loaded data was corrupted.</p>
        <button class="btn btn-outline" style="background:white; color:black; margin-top:10px;" onclick="localStorage.clear(); location.reload();">Emergency Reset</button>
    </div>

    <div id="celebration-overlay" class="celebration hidden">
        <div class="celebration-confetti" id="celebration-confetti"></div>
        <div class="celebration-inner">
            <div class="celebration-title" id="celebration-title">Level Complete! üéâ</div>
            <div id="celebration-sub" style="margin-bottom:15px; color:#cfd8dc;">Great work!</div>
            <button class="btn btn-primary" id="celebration-btn" onclick="ui.closeCelebration()">Continue</button>
        </div>
    </div>

    <div id="splash-screen" class="splash hidden">
        <div class="splash-title">Answer Architect</div>
        <div class="splash-sub">Booting your analysis tools...</div>
        <div class="splash-glow"></div>
    </div>

    <div id="intro-text-screen" class="intro-screen hidden">
        <div>
            <div id="intro-text" class="intro-text">Loading text...</div>
            <div class="intro-hint">Get ready to explore the language.</div>
        </div>
    </div>

    <div id="pick-quote-screen" class="pick-screen hidden">
        <div class="pick-title">Pick a quote</div>
    </div>

    <header class="no-print">
        <h1>
            <button class="icon-btn" onclick="app.resetSession()" style="color:red; border-color:red;" title="Reset Session">‚ú®</button>
            Tone & Structure
            <span class="score-badge" id="score-display">0 XP</span>
            <span class="score-badge" id="level-display">Lvl 1</span>
        </h1>
        <div class="header-controls">
            <button class="icon-btn" onclick="ui.openModal('modal-help')">‚ùì</button>
            <button class="icon-btn" onclick="ui.openModal('modal-theme')" title="Colors">üé®</button>
            <select id="level-selector" class="level-select" onchange="app.setLevel(this.value)"></select>
            <button class="icon-btn" id="btn-admin" onclick="ui.openAdmin()">Data</button>
        </div>
    </header>

    <div class="viewport no-print">
        
        <div id="view-lab" class="hub active">
            <div style="display:flex; justify-content:space-between; align-items:center; background:var(--card); padding:10px; border-bottom:1px solid var(--border);">
                <div><strong>Topic:</strong> <span id="lbl-title">...</span></div>
                <button class="btn btn-outline" style="width:auto; padding:5px 10px;" onclick="ui.openModal('modal-source')">üìÑ View Text</button>
            </div>
            
            <div style="padding:10px;">
                <div id="question-banner" class="question-banner hidden"></div>
                <details class="guide-box" open>
                    <summary>Source Text (Tap to collapse)</summary>
                    <div class="guide-content" id="source-inline"></div>
                </details>

                <div class="filter-bar">
                    <button class="btn btn-outline filter-btn" data-filter="all" onclick="app.setFilter('all')">All</button>
                    <button class="btn btn-outline filter-btn" data-filter="language" onclick="app.setFilter('language')">Lang</button>
                    <button class="btn btn-outline filter-btn" data-filter="structure" onclick="app.setFilter('structure')">Struct</button>
                    <button class="btn btn-outline filter-btn" data-filter="tone" onclick="app.setFilter('tone')">Tone</button>
                    <button class="btn btn-outline filter-btn" id="btn-show-done" onclick="app.toggleDone()">Show Done</button>
                </div>

                <div id="quote-grid" class="grid"></div>
                
                <div class="section-header" style="margin-top:20px;">Global Analysis</div>
                <div id="global-card-container"></div>
            </div>
        </div>

    <div id="view-select" class="hub">
        <div style="padding:15px;">
            <div id="selection-area"></div>
        </div>
    </div>

        <div id="view-desk" class="hub">
            <div style="padding:15px;">
                <div class="section-header" style="margin-top:0;">Sentence Construction</div>
                <div id="sentence-builder" class="builder-area">
                    <div style="text-align:center; opacity:0.6; padding:20px;">Select a quote in the Evidence Lab to start.</div>
                </div>

                <div class="section-header">Preview & Edit</div>
                <div id="preview-box" class="preview-box" contenteditable="true"></div>
                <div id="hint-panel" class="hint-panel hidden"></div>
                
                <div style="display:grid; grid-template-columns:1fr 2fr; gap:10px; margin-bottom:20px;">
                    <button class="btn btn-accent" onclick="app.undo()">Undo</button>
                    <button class="btn btn-primary" onclick="app.commitSentence()">Commit to Answer ‚¨á</button>
                </div>

                <textarea id="essay-area" class="essay-area" placeholder="Your answer will appear here..." oninput="app.updateEssay(this.value)"></textarea>
                
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-doc" onclick="app.exportDoc()">Download .doc</button>
                    <button class="btn btn-danger" onclick="app.clearEssay()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav no-print">
        <button class="nav-item active" onclick="ui.switchView('lab')" id="nav-lab">
            <span class="nav-icon">üß™</span><span class="nav-label">Evidence Lab</span>
        </button>
        <button class="nav-item hidden" onclick="ui.switchView('select')" id="nav-select">
            <span class="nav-icon">üéØ</span><span class="nav-label">Quote Select</span>
        </button>
        <button class="nav-item" onclick="ui.switchView('desk')" id="nav-desk">
            <span class="nav-icon">‚úçÔ∏è</span><span class="nav-label">Writing Desk</span>
        </button>
    </nav>

    <div id="modal-source" class="modal">
        <div class="modal-content">
            <div class="modal-header">Source Text <button class="icon-btn" onclick="ui.closeModal('modal-source')">‚úï</button></div>
            <div class="modal-body reader-body">
                <div class="reader-controls">
                    <button class="btn btn-outline btn-small" id="reader-toggle" onclick="ui.toggleReader()">Auto-Scroll</button>
                    <label class="reader-label">Speed
                        <input type="range" id="reader-speed" min="10" max="120" value="40">
                    </label>
                    <label class="reader-label">Zoom
                        <input type="range" id="reader-zoom" min="90" max="160" value="110">
                    </label>
                    <button class="btn btn-outline btn-small" onclick="ui.toggleHighlight()">Highlight</button>
                    <button class="btn btn-outline btn-small" onclick="ui.copySourceText()">Copy Text</button>
                    <button class="btn btn-outline btn-small" onclick="ui.resetReader()">Reset</button>
                </div>
                <div id="reader-window" class="reader-window hidden"><div class="reader-window-line"></div></div>
                <div id="source-content" style="white-space:pre-wrap; line-height:1.6; font-size:1.1rem; font-family:'Georgia'; max-height:60vh; overflow:auto; padding-right:4px;"></div>
            </div>
        </div>
    </div>

    <div id="modal-wizard" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span id="wizard-title">Analysis</span> <button class="icon-btn" onclick="ui.closeModal('modal-wizard')">‚úï</button></div>
            <div class="modal-body">
                <div id="wizard-prompt" style="margin-bottom:15px;"></div>
                <div id="wizard-options" class="grid"></div>
            </div>
        </div>
    </div>

    <div id="modal-help" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">Student Help <button class="icon-btn" onclick="ui.closeModal('modal-help')">‚úï</button></div>
            <div class="modal-body">
                <p><strong>1. Evidence Lab:</strong> Read the source text. Click on colored quote cards to analyze them. Correct answers earn XP.</p>
                <hr>
                <p><strong>2. Writing Desk:</strong> Use the dropdown menus to build professional analytical sentences. You can edit the text manually before adding it to your final essay.</p>
            </div>
        </div>
    </div>

    <div id="modal-theme" class="modal">
        <div class="modal-content" style="max-width:350px;">
            <div class="modal-header">Theme Colors <button class="icon-btn" onclick="ui.closeModal('modal-theme')">‚úï</button></div>
            <div class="modal-body">
                <div class="theme-row"><span>Background:</span> <input type="color" id="col-bg" onchange="ui.setTheme('bg', this.value)"></div>
                <div class="theme-row"><span>Text Color:</span> <input type="color" id="col-text" onchange="ui.setTheme('text', this.value)"></div>
                <div class="theme-row"><span>Card Color:</span> <input type="color" id="col-card" onchange="ui.setTheme('card', this.value)"></div>
                <hr>
                <button class="btn btn-outline" onclick="ui.resetTheme()">Reset to Defaults</button>
            </div>
        </div>
    </div>

    <div id="modal-admin" class="modal">
        <div class="modal-content">
            <div class="modal-header">Teacher Settings <button class="icon-btn" onclick="ui.closeModal('modal-admin')">‚úï</button></div>
            <div class="modal-body">
                <div class="admin-section" style="border-color:#2196f3;">
                    <h3 class="admin-h" style="color:#1565c0;">Quick Controls</h3>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-primary" onclick="admin.generateUnifiedPrompt()">Generate Unified Prompt</button>
                        <button class="btn btn-outline" onclick="admin.copyUnifiedPrompt()">Copy Unified Prompt</button>
                        <button class="btn btn-outline" onclick="admin.loadUnifiedFromClipboard()">Load Unified from Clipboard</button>
                    </div>
                    <div style="margin-top:10px; font-size:0.85rem;">
                        Active Modules:
                        <div id="modules-active" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;"></div>
                    </div>
                </div>
                
                <details class="guide-box" open>
                    <summary>Teacher Guide (Click to collapse)</summary>
                    <div class="guide-content">
                        <h4>ü§ñ AI Lesson Generator (Important)</h4>
                        <ol style="padding-left:20px; margin:0;">
                            <li>Paste your Source Text and Focus Question below.</li>
                            <li>Click <strong>Generate Prompt</strong>.</li>
                            <li><strong>Copy the generated prompt text.</strong></li>
                            <li>Paste it into ChatGPT, Claude, or Gemini.</li>
                            <li>Copy the <strong>JSON code</strong> the AI gives you.</li>
                            <li>Paste that JSON into the box below and click <strong>Load Data</strong>.</li>
                        </ol>
                        <h4>‚öôÔ∏è Structure & Banks</h4>
                        <p>Customize the sentence builders for Levels 1-3. Select 'point' to use AI-generated analysis points.</p>
                        <h4>üìÑ Worksheet</h4>
                        <p>Exports a Word doc with 'Match the Meaning' and 'Analysis' sections.</p>
                    </div>
                </details>

                <div class="admin-section" style="background:rgba(33, 150, 243, 0.1); border-color:#2196f3;">
                    <h3 class="admin-h" style="color:#1565c0;">ü§ñ AI Lesson Generator</h3>
                    <div class="input-group">
                        <label>Lesson Focus / Question</label>
                        <input type="text" id="ai-question" placeholder="e.g. How is tension created?" style="border:2px solid #2196f3;">
                    </div>
                    <div class="input-group">
                        <label>Source Text</label>
                        <textarea id="ai-input" style="height:60px; width:100%; border:1px solid #ccc;" placeholder="Paste text here..."></textarea>
                    </div>
                    <button class="btn btn-outline btn-small" onclick="admin.useSourceText()" style="margin-bottom:10px;">Use as Source Text</button>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1"><label style="font-size:0.8rem">Mode</label><select id="ai-mode" style="width:100%; padding:5px;"><option value="replace">Replace All</option><option value="append">Append</option></select></div>
                        <div style="width:80px"><label style="font-size:0.8rem">Quotes</label><input type="number" id="ai-count" value="6" min="1" max="20" style="width:100%; padding:5px;"></div>
                    </div>
                    <button class="btn btn-outline btn-small" onclick="admin.toggleAiPanel()" style="margin-bottom:8px;">Show/Hide JSON Panel</button>
                    <div class="input-group">
                        <label>Levels Included</label>
                        <div class="level-checks" style="margin-top:0;">
                            <label>1<input type="checkbox" id="ai-level-1" checked></label>
                            <label>2<input type="checkbox" id="ai-level-2" checked></label>
                            <label>3<input type="checkbox" id="ai-level-3" checked></label>
                        </div>
                    </div>
                    <label style="display:block; font-size:0.85rem; margin-bottom:8px;"><input type="checkbox" id="ai-all-levels" onchange="admin.setAiAllLevels(this.checked)"> Include all 10 levels in prompt</label>
                    <div class="input-group">
                        <label>Level 1 Rules (Below GCSE Pass)</label>
                        <div class="level-rule-grid">
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Count</label>
                                <input type="number" id="ai-l1-count" min="0" placeholder="L1 count">
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Max words</label>
                                <input type="number" id="ai-l1-words" min="3" value="12" placeholder="Max words">
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Complexity</label>
                                <select id="ai-l1-complex">
                                    <option value="very simple">Very simple</option>
                                    <option value="simple">Simple</option>
                                    <option value="medium">Medium</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Subtlety</label>
                                <select id="ai-l1-subtle">
                                    <option value="obvious">Obvious distractors</option>
                                    <option value="medium">Medium subtlety</option>
                                    <option value="subtle">Subtle</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Ellipses if &gt;</label>
                                <input type="number" id="ai-l1-ellipsis" min="3" value="7" placeholder="Words">
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Level 2 Rules (GCSE 3-4)</label>
                        <div class="level-rule-grid">
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Count</label>
                                <input type="number" id="ai-l2-count" min="0" placeholder="L2 count">
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Max words</label>
                                <input type="number" id="ai-l2-words" min="3" value="20" placeholder="Max words">
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Complexity</label>
                                <select id="ai-l2-complex">
                                    <option value="simple">Simple</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Subtlety</label>
                                <select id="ai-l2-subtle">
                                    <option value="obvious">Obvious distractors</option>
                                    <option value="medium" selected>Medium subtlety</option>
                                    <option value="subtle">Subtle</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Ellipses if &gt;</label>
                                <input type="number" id="ai-l2-ellipsis" min="3" value="7" placeholder="Words">
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Level 3 Rules (GCSE 4+)</label>
                        <div class="level-rule-grid">
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Count</label>
                                <input type="number" id="ai-l3-count" min="0" placeholder="L3 count">
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Max words</label>
                                <input type="number" id="ai-l3-words" min="3" value="30" placeholder="Max words">
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Complexity</label>
                                <select id="ai-l3-complex">
                                    <option value="medium">Medium</option>
                                    <option value="advanced" selected>Advanced</option>
                                    <option value="very advanced">Very advanced</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Subtlety</label>
                                <select id="ai-l3-subtle">
                                    <option value="medium">Medium subtlety</option>
                                    <option value="subtle" selected>Subtle</option>
                                    <option value="very subtle">Very subtle</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Ellipses if &gt;</label>
                                <input type="number" id="ai-l3-ellipsis" min="3" value="7" placeholder="Words">
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-outline" onclick="admin.generatePrompt()">Generate Lesson Prompt</button>
                        <button class="btn btn-outline" onclick="admin.generateSelectionPrompt()">Generate Quote-Selection Prompt</button>
                    </div>
                    <div class="input-group" style="margin-top:10px;">
                        <label>Quote Selection Stages (applies to all lessons)</label>
                        <div style="display:flex; gap:6px; align-items:center; margin-bottom:6px;">
                            <label style="font-size:0.85rem;">Preset</label>
                            <select id="selection-stage-preset" onchange="admin.applySelectionPreset(this.value)" style="padding:4px;">
                                <option value="custom">Custom</option>
                                <option value="beginner">Beginner</option>
                                <option value="intermediate">Intermediate</option>
                                <option value="advanced">Advanced</option>
                            </select>
                        </div>
                        <div id="selection-stages" style="display:flex; flex-wrap:wrap; gap:6px; font-size:0.85rem;"></div>
                    </div>
                    <div class="input-group" style="margin-top:10px;">
                        <label>Unified JSON (single paste)</label>
                        <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:6px;">
                            <button class="btn btn-outline btn-small" onclick="admin.pasteUnifiedJson()">Paste Unified JSON</button>
                            <button class="btn btn-success btn-small" onclick="admin.loadUnifiedJson()">Load Unified JSON</button>
                        </div>
                        <textarea id="unified-prompt-out" style="height:80px; width:100%; margin-bottom:6px;" readonly placeholder="Unified prompt will appear here..."></textarea>
                        <textarea id="unified-json-in" style="height:90px; width:100%;" placeholder="Paste unified JSON response here..."></textarea>
                    </div>
                    
                    <textarea id="ai-prompt-out" style="height:60px; width:100%; margin-top:10px;" readonly placeholder="Lesson prompt will appear here..."></textarea>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üìå Lesson Templates</h3>
                    <div class="input-group">
                        <label>Template Name</label>
                        <input type="text" id="template-name" placeholder="e.g. Persuasive Writing L2">
                    </div>
                    <div style="display:flex; gap:8px; margin-bottom:10px;">
                        <button class="btn btn-outline" onclick="admin.saveTemplate()">Save Template</button>
                        <button class="btn btn-outline" onclick="admin.loadTemplate()">Load Template</button>
                        <select id="template-select" style="width:100%; padding:6px;"></select>
                    </div>
                    <div style="font-size:0.85rem; opacity:0.7;">Templates store AI level settings and sentence structures.</div>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üéØ Quote Selection</h3>
                    <div style="display:flex; gap:8px; flex-wrap:wrap;">
                        <button class="btn btn-outline" onclick="admin.clearSelectionGate()">Unlock Evidence Lab</button>
                        <button class="btn btn-outline" onclick="admin.markLabComplete()">Mark Evidence Complete</button>
                    </div>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üß≠ Quote Selection Editor</h3>
                    <div style="font-size:0.85rem; opacity:0.7; margin-bottom:8px;">Mark quotes as analysis-worthy or noise. Edit reasons and distractors for teacher control.</div>
                    <div id="selection-editor-list" style="max-height:300px; overflow-y:auto; padding-right:5px;"></div>
                    <button class="btn btn-success" onclick="admin.addSelectionItem()">+ Add Selection Quote</button>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üõ†Ô∏è Controls</h3>
                    <label style="display:block; margin-bottom:5px;"><input type="checkbox" id="keep-unlocked" onchange="admin.setUnlocked(this.checked)"> Keep Unlocked</label>
                    <label style="display:block; margin-bottom:5px;"><input type="checkbox" id="auto-progress" onchange="admin.setAutoProgress(this.checked)"> Auto-progress Levels</label>
                    <label style="display:block; margin-bottom:6px;"><input type="checkbox" id="practice-mode" onchange="admin.setPracticeMode(this.checked)"> Practice Mode (lock selected level)</label>
                    <label style="display:block; margin-bottom:6px;"><input type="checkbox" id="strict-mode" onchange="admin.setStrictMode(this.checked)"> Strict Mode (block incorrect choices)</label>
                    <button class="btn btn-outline" onclick="admin.resetSelectionProgress()">Reset Selection Progress</button>
                    <div style="display:flex; gap:6px; align-items:center; font-size:0.85rem;">
                        <span>Practice Level:</span>
                        <select id="practice-level" onchange="admin.setPracticeLevel(this.value)" style="padding:4px;">
                            <option value="1">Level 1</option>
                            <option value="2">Level 2</option>
                            <option value="3">Level 3</option>
                            <option value="4">Level 4</option>
                            <option value="5">Level 5</option>
                            <option value="6">Level 6</option>
                            <option value="7">Level 7</option>
                            <option value="8">Level 8</option>
                            <option value="9">Level 9</option>
                            <option value="10">Level 10</option>
                        </select>
                    </div>
                    <label style="display:block; margin-top:6px; font-size:0.85rem;"><input type="checkbox" id="practice-force-auto" onchange="admin.setPracticeForceAuto(this.checked)"> Practice Auto-only (no manual slots)</label>
                    <label style="display:block; margin-top:6px; font-size:0.85rem;"><input type="checkbox" id="practice-fixed-template" onchange="admin.setPracticeFixedTemplate(this.checked)"> Practice Fixed Template (ignore custom structure)</label>
                    <div style="margin-top:8px; font-size:0.85rem;">
                        Active Levels:
                        <div id="active-levels" style="display:flex; flex-wrap:wrap; gap:6px; margin-top:6px;"></div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üìù Edit Evidence (Quotes)</h3>
                    <div id="quote-editor-list" style="max-height:300px; overflow-y:auto; padding-right:5px;"></div>
                    <button class="btn btn-success" onclick="admin.addQuote()">+ New Quote</button>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">‚úçÔ∏è Analysis Banks Editor</h3>
                    <div class="bank-btn-grid">
                        <button class="btn btn-outline" onclick="admin.editBank('markers')">Markers</button>
                        <button class="btn btn-outline" onclick="admin.editBank('starters')">Starters</button>
                        <button class="btn btn-outline" onclick="admin.editBank('methods')">Methods</button>
                        <button class="btn btn-outline" onclick="admin.editBank('points')">Points</button>
                    </div>
                    <div class="bank-btn-grid">
                        <button class="btn btn-outline" style="border-color:var(--primary);" onclick="admin.editBank('link_l1')">Links L1</button>
                        <button class="btn btn-outline" style="border-color:var(--primary);" onclick="admin.editBank('link_l2')">Links L2</button>
                        <button class="btn btn-outline" style="border-color:var(--primary);" onclick="admin.editBank('link_l3')">Links L3</button>
                    </div>
                    
                    <div id="bank-editor-ui" class="hidden" style="background:var(--bg); padding:10px; border-radius:6px; border:1px solid var(--border);">
                        <strong id="bank-name-display" style="display:block; margin-bottom:5px; color:var(--primary);"></strong>
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <input id="bank-add-input" placeholder="New item..." style="flex:1;">
                            <button class="btn btn-primary" style="width:auto; margin:0;" onclick="admin.addBankItem()">Add</button>
                        </div>
                        <div id="bank-list-container"></div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">‚öôÔ∏è Sentence Structure</h3>
                    <div style="display:flex; gap:8px; align-items:center; margin-bottom:10px;">
                        <label style="font-size:0.85rem;">Level</label>
                        <select id="config-level-select" onchange="admin.renderConfig(parseInt(this.value, 10))" style="padding:4px;">
                            <option value="1">Level 1</option>
                            <option value="2">Level 2</option>
                            <option value="3">Level 3</option>
                            <option value="4">Level 4</option>
                            <option value="5">Level 5</option>
                            <option value="6">Level 6</option>
                            <option value="7">Level 7</option>
                            <option value="8">Level 8</option>
                            <option value="9">Level 9</option>
                            <option value="10">Level 10</option>
                        </select>
                    </div>
                    <div id="config-slots"></div>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üèóÔ∏è Global Structure Questions</h3>
                    <label style="display:block; margin-bottom:10px;"><input type="checkbox" id="gs-enabled" onchange="admin.toggleGlobal(this.checked)"> Enable Section</label>
                    <div id="global-editor-list"></div>
                    <button class="btn btn-success" onclick="admin.addGlobalQuestion()">+ Add Question</button>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üì¶ Export</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn btn-doc" onclick="admin.exportWorksheet()">üìÑ Worksheet (Word)</button>
                        <button class="btn btn-primary" style="background:#37474f;" onclick="admin.exportStandalone()">üì¶ Student App</button>
                        <button class="btn btn-outline" onclick="admin.saveConfig()">üíæ Save JSON</button>
                        <button class="btn btn-outline" onclick="admin.exportTemplates()">üß© Export Templates</button>
                        <label class="btn btn-outline" style="text-align:center; cursor:pointer;">üß© Import Templates<input type="file" id="templates-up" class="hidden" onchange="admin.importTemplates(this)"></label>
                        <label class="btn btn-outline" style="text-align:center; cursor:pointer;">üìÇ Load JSON<input type="file" id="file-up" class="hidden" onchange="admin.loadFile(this)"></label>
                    </div>
                    <div style="margin-top:10px; font-size:0.85rem; opacity:0.8;">
                        Match Game Layout:
                        <select id="worksheet-match-mode" onchange="admin.setWorksheetMatchMode(this.value)" style="padding:4px; margin-left:6px;">
                            <option value="jumbled">Jumbled interpretations (draw lines)</option>
                            <option value="aligned">Aligned interpretations (copy lines)</option>
                            <option value="list">Simple list (original)</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-danger" onclick="app.factoryReset()">‚ö†Ô∏è Factory Reset</button>
            </div>
        </div>
    </div>
    <script>
/** ARCHITECT v5.1 (Safety First) **/

/* --- DEFAULT DATA --- */
const defaultData = {
    meta: { title: "Demo Lesson", author: "System", version: "5.1" },
    sourceText: "The sky was a bruised purple...",
    question: "How is language used?",
    settings: { 
        autoProgress: false,
        practiceMode: false,
        practiceModeLevel: 1,
        practiceForceAuto: false,
        practiceFixedTemplate: false,
        worksheetMatchMode: "jumbled",
        activeLevels: [1,2,3],
        aiPromptAllLevels: false,
        strictMode: false,
        selectionStages: ["discriminate","boundary","align","justify","open"],
        modulesActive: { selection: true, lab: true, desk: true },
        levelRules: {
            1: { maxWords: 12, ellipsesMaxWords: 7 },
            2: { maxWords: 20, ellipsesMaxWords: 7 },
            3: { maxWords: 30, ellipsesMaxWords: 7 }
        }
    },
    selection: {
        enabled: false,
        text: { source: "" },
        question: { prompt: "", focusTags: [] },
        items: [],
        modes: { selectionMode: "closed", showHints: true, requireReason: true, quoteCount: 4 }
    },
    globalStructure: {
        enabled: true,
        items: [
            { id: "g1", question: "How does the text shift?", correct: "Outside to Inside", distractors: ["Inside to Outside", "No shift"] }
        ]
    },
    banks: {
        markers: ["Furthermore,", "However,"],
        starters: ["The writer implies", "The text suggests"],
        methods: ["Metaphor", "Simile"],
        points: ["a sense of fear is created", "tension builds for the reader"],
        links: { l1: ["This shows"], l2: ["This reinforces"], l3: ["This highlights"] }
    },
    sentenceConfig: {
        1: ["starter", "quote", "link_l1", "point"],
        2: ["marker", "starter", "quote", "method", "point", "link_l2"],
        3: ["marker", "starter", "quote", "method", "point", "link_l3"]
    },
    items: [
        { id: "q1", original: "bruised purple", translation: "Dark color", translationDistractors: ["Bright"], type: "language", effect: "gloomy mood", effectDistractors: ["happy"], levels: [1,2,3], includeInWorksheet: true }
    ],
    isStandalone: false 
};

let appData = null;
let userState = { score: 0, level: 1, essay: "", completed: [], completedLevels: [], filter: "all", showDone: false, selectionCompleted: false, selectionStage: 1, selectionKey: "", selectionProgress: {}, labCompleted: false };
let currentBankKey = null;
let saveTimeout = null;

/* --- APP LOGIC --- */
const app = {
    normalizeKey: function(raw) {
        return String(raw || "lesson").toLowerCase().replace(/[^a-z0-9]+/g, "_").slice(0, 60);
    },
    getStateKey: function() {
        if(appData && appData.isStandalone) {
            const id = app.normalizeKey(appData.meta && appData.meta.id ? appData.meta.id : "");
            if(id) return `tsa_v5_1_state_${id}`;
            const title = app.normalizeKey(appData.meta && appData.meta.title ? appData.meta.title : "standalone");
            const version = app.normalizeKey(appData.meta && appData.meta.version ? appData.meta.version : "v1");
            return `tsa_v5_1_state_${title}_${version}`;
        }
        return "tsa_v5_1_state";
    },
    getPracticeTemplate: function(level) {
        const templates = {
            1: ["starter", "quote", "link_l1", "point"],
            2: ["marker", "starter", "quote", "method", "point", "link_l2"],
            3: ["marker", "starter", "quote", "method", "point", "link_l3"]
        };
        return templates[level] || templates[1];
    },
    escapeHtml: function(text) {
        return String(text || "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;");
    },
    isLikelyJson: function(text) {
        const t = String(text || "").trim();
        if(!t) return false;
        if(!(t.startsWith("{") || t.startsWith("["))) return false;
        return /\"items\"|\"quote\"|\"sourceText\"|\"selection\"/i.test(t);
    },
    formatSourceHtml: function(text) {
        const clean = app.cleanSourceText(text || "");
        if(!clean) return "Source text not provided.";
        const parts = clean.split(/\n\s*\n/);
        return parts.map(p => `<p style="margin:0 0 16px 0;">${app.escapeHtml(p).replace(/\n/g, "<br>")}</p>`).join("");
    },
    repairSelection: function(s) {
        const safe = s && typeof s === "object" ? s : {};
        const text = safe.text && typeof safe.text === "object" ? safe.text : {};
        const question = safe.question && typeof safe.question === "object" ? safe.question : {};
        const items = Array.isArray(safe.items) ? safe.items : [];
        const modes = safe.modes && typeof safe.modes === "object" ? safe.modes : {};
        return {
            enabled: !!safe.enabled || items.length > 0,
            text: { source: app.cleanSourceText(text.source || safe.sourceText || "") },
            question: {
                prompt: typeof question.prompt === "string" ? question.prompt : (typeof safe.question === "string" ? safe.question : ""),
                focusTags: Array.isArray(question.focusTags) ? question.focusTags.filter(v => typeof v === "string") : []
            },
            items: items.map((it, idx) => {
                const item = it && typeof it === "object" ? it : {};
                const rawDistractors = Array.isArray(item.distractors) ? item.distractors : [];
                const reasons = Array.isArray(item.reasons)
                    ? item.reasons.filter(v => typeof v === "string")
                    : (typeof item.reason === "string" ? [item.reason] : []);
                const distractors = rawDistractors.map((d, di) => {
                    if(typeof d === "string") {
                        return { id: `sd${idx+1}_${di+1}`, quote: d, reason: "" };
                    }
                    return {
                        id: typeof d.id === "string" ? d.id : `sd${idx+1}_${di+1}`,
                        quote: typeof d.quote === "string" ? d.quote : "",
                        reason: typeof d.reason === "string" ? d.reason : ""
                    };
                });
                return {
                    id: typeof item.id === "string" ? item.id : `s${idx+1}`,
                    quote: typeof item.quote === "string" ? item.quote : "",
                    correct: item.correct === true,
                    reasons,
                    distractors
                };
            }).filter(i => i.quote),
            modes: {
                selectionMode: modes.selectionMode === "open" ? "open" : "closed",
                showHints: typeof modes.showHints === "boolean" ? modes.showHints : true,
                requireReason: typeof modes.requireReason === "boolean" ? modes.requireReason : true,
                quoteCount: parseInt(modes.quoteCount, 10) || 4,
                stages: Array.isArray(modes.stages) && modes.stages.length
                    ? modes.stages.filter(v => ["recognize","guided","justify","open","discriminate","boundary","align"].includes(v))
                    : ["discriminate","boundary","align","justify","open"]
            }
        };
    },
    cleanSourceText: function(text) {
        if(typeof text !== "string") return "";
        let t = text;
        if(app.isLikelyJson(t)) return "";
        t = t.replace(/<[^>]*>/g, " ");
        t = t.replace(/&nbsp;/gi, " ").replace(/&amp;/gi, "&").replace(/&lt;/gi, "<").replace(/&gt;/gi, ">");
        const cutoffIdx = (() => {
            const markers = ["Part A: Match", "Part B: Analysis", "Worksheet", "Match Meanings"];
            let idx = -1;
            markers.forEach(m => {
                const i = t.indexOf(m);
                if(i >= 0 && (idx === -1 || i < idx)) idx = i;
            });
            return idx;
        })();
        if(cutoffIdx > 0) t = t.slice(0, cutoffIdx);
        t = t.replace(/\s+\n/g, "\n").replace(/\n{3,}/g, "\n\n").replace(/[ \t]{2,}/g, " ");
        return t.trim();
    },
    getDefaultSentenceConfig: function(level) {
        if(level === 1) return ["starter", "quote", "link_l1", "point"];
        if(level === 2) return ["marker", "starter", "quote", "method", "point", "link_l2"];
        if(level === 3) return ["marker", "starter", "quote", "method", "point", "link_l3"];
        if(level === 4) return ["marker", "starter", "quote", "method", "manual_point", "link_l3"];
        if(level === 5) return ["marker", "starter", "quote", "manual_method", "point", "link_l3"];
        if(level === 6) return ["marker", "manual_starter", "quote", "method", "point", "link_l3"];
        if(level === 7) return ["manual_marker", "starter", "quote", "method", "point", "link_l3"];
        if(level === 8) return ["marker", "starter", "quote", "method", "point", "manual_link"];
        if(level === 9) return ["marker", "starter", "quote", "method", "manual_analysis", "link_l3"];
        return ["marker", "starter", "quote", "method", "manual_effect", "link_l3"];
    },
    getActiveLevels: function() {
        const raw = appData && appData.settings && Array.isArray(appData.settings.activeLevels)
            ? appData.settings.activeLevels
            : [1,2,3];
        const cleaned = raw
            .map(n => parseInt(n, 10))
            .filter(n => n >= 1 && n <= 10);
        return cleaned.length ? Array.from(new Set(cleaned)).sort((a,b)=>a-b) : [1,2,3];
    },
    getSelectionKey: function() {
        const sel = appData && appData.selection ? appData.selection : null;
        if(!sel || !sel.items || !sel.items.length) return "";
        const base = `${sel.text && sel.text.source ? sel.text.source.slice(0,120) : ""}|${sel.question && sel.question.prompt ? sel.question.prompt : ""}|${sel.items.length}`;
        return base;
    },
    shuffle: function(arr) {
        const a = arr.slice();
        for(let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    },
    makeBoundaryChoices: function(quote) {
        const words = app.wordList(quote);
        if(words.length <= 6) return { options: [quote], correct: quote };
        const short = app.truncateWithEllipses(words, Math.min(6, words.length));
        const medium = app.truncateWithEllipses(words, Math.min(12, words.length));
        const long = quote;
        const options = app.shuffle([short, medium, long]);
        return { options, correct: medium };
    },
    wordList: function(text) {
        return String(text || "").trim().split(/\s+/).filter(Boolean);
    },
    truncateWithEllipses: function(words, maxWords) {
        if(!Array.isArray(words) || words.length <= maxWords || maxWords <= 0) {
            return words.join(" ");
        }
        const total = words.length;
        const minKeep = Math.min(2, maxWords - 1);
        const targetHead = Math.max(minKeep, Math.ceil(maxWords / 2));
        const isBoundary = (w) => /[.!?;:]$/.test(w || "");

        let headCount = targetHead;
        for(let i = targetHead; i >= minKeep; i--) {
            if(isBoundary(words[i - 1])) { headCount = i; break; }
        }
        headCount = Math.min(headCount, maxWords - 1);

        let tailCount = maxWords - headCount;
        if(tailCount < 1) {
            tailCount = 1;
            headCount = maxWords - 1;
        }

        let tailStart = total - tailCount;
        const tailWindowStart = Math.max(headCount, total - tailCount - 4);
        for(let i = total - 2; i >= tailWindowStart; i--) {
            if(isBoundary(words[i])) {
                const candidateStart = i + 1;
                if(total - candidateStart <= tailCount) {
                    tailStart = candidateStart;
                    tailCount = total - tailStart;
                    break;
                }
            }
        }

        const head = words.slice(0, headCount);
        const tail = words.slice(tailStart);
        return `${head.join(" ")} ... ${tail.join(" ")}`;
    },
    applyLevelRules: function(items, levelRules, overrideLevel) {
        if(!Array.isArray(items) || !levelRules) return items;
        items.forEach(item => {
            if(!item.originalFull) item.originalFull = item.original;
            const lvl = overrideLevel || (Array.isArray(item.levels) && item.levels.length ? item.levels[0] : 1);
            const rule = levelRules[lvl];
            if(!rule) return;
            const maxWords = parseInt(rule.maxWords, 10) || 0;
            const ellipsesAt = parseInt(rule.ellipsesMaxWords, 10) || 0;
            const words = app.wordList(item.original);
            const total = words.length;
            if(total === 0) return;
            let out = words.join(" ");
            if(maxWords > 0 && total > maxWords) {
                out = app.truncateWithEllipses(words, maxWords);
            } else if(ellipsesAt > 0 && total > ellipsesAt) {
                // No truncation needed, but indicate omission for long quotes
                if(!/(\.\.\.|‚Ä¶)$/.test(out)) out += "...";
            }
            item.original = out;
        });
        return items;
    },
    init: function() {
        window.onerror = function() { document.getElementById('emergency-reset').style.display = 'block'; };

        // CHECK FOR INJECTED STANDALONE DATA
        if (typeof window.STANDALONE_LESSON !== 'undefined') {
            appData = app.repair(window.STANDALONE_LESSON);
            appData.isStandalone = true;
            
            // CLEANUP: If by some miracle HTML remains, kill it
            const btn = document.getElementById('btn-admin'); if(btn) btn.remove();
            const mod = document.getElementById('modal-admin'); if(mod) mod.remove();
            document.querySelectorAll('.modal.open').forEach(m => m.classList.remove('open'));

        } else {
            // NORMAL TEACHER MODE
            const d = localStorage.getItem('tsa_v5_1_data');
            if(d) {
                try { appData = app.repair(JSON.parse(d)); } 
                catch(e) { appData = app.repair(defaultData); }
            } else if (typeof teacherConfig !== "undefined") {
                appData = app.repair(teacherConfig);
            } else {
                appData = app.repair(defaultData);
            }
        }

        if(appData.isStandalone && (!Array.isArray(appData.items) || appData.items.length === 0)) {
            const fallback = app.repair(defaultData);
            appData.items = fallback.items;
            appData.banks = fallback.banks;
            appData.sentenceConfig = fallback.sentenceConfig;
            appData.globalStructure = fallback.globalStructure;
            if(!appData.sourceText) appData.sourceText = fallback.sourceText;
            if(!appData.question) appData.question = fallback.question;
            if(!appData.meta || !appData.meta.title) appData.meta = fallback.meta;
        }

        const s = localStorage.getItem(app.getStateKey());
        if(s) {
            try { userState = JSON.parse(s); } catch(e) { userState = { score: 0, level: 1, essay: "", completed: [], completedLevels: [], filter: "all", showDone: false, selectionCompleted: false, selectionStage: 1, selectionKey: "", selectionProgress: {}, labCompleted: false }; }
        }
        if(typeof userState.selectionCompleted !== "boolean") userState.selectionCompleted = false;
        if(typeof userState.selectionStage !== "number") userState.selectionStage = 1;
        if(typeof userState.selectionKey !== "string") userState.selectionKey = "";
        if(!userState.selectionProgress || typeof userState.selectionProgress !== "object") userState.selectionProgress = {};
        if(typeof userState.labCompleted !== "boolean") userState.labCompleted = false;

        try { ui.init(); } catch(e) { document.getElementById('emergency-reset').style.display = 'block'; }
    },

    repair: function(d) {
        if(!d || typeof d !== 'object') return JSON.parse(JSON.stringify(defaultData));

        const safe = d;
        safe.meta = safe.meta && typeof safe.meta === 'object' ? safe.meta : {};
        safe.meta.title = typeof safe.meta.title === 'string' ? safe.meta.title : defaultData.meta.title;
        safe.meta.author = typeof safe.meta.author === 'string' ? safe.meta.author : defaultData.meta.author;
        safe.meta.version = typeof safe.meta.version === 'string' ? safe.meta.version : defaultData.meta.version;
        safe.sourceText = app.cleanSourceText(typeof safe.sourceText === 'string' ? safe.sourceText : defaultData.sourceText);
        safe.question = typeof safe.question === 'string' ? safe.question : defaultData.question;

        safe.settings = safe.settings && typeof safe.settings === 'object' ? safe.settings : {};
        if(typeof safe.settings.autoProgress !== 'boolean') safe.settings.autoProgress = false;
        if(typeof safe.settings.practiceMode !== 'boolean') safe.settings.practiceMode = false;
        safe.settings.practiceModeLevel = [1,2,3].includes(parseInt(safe.settings.practiceModeLevel, 10))
            ? parseInt(safe.settings.practiceModeLevel, 10)
            : 1;
        if(typeof safe.settings.practiceForceAuto !== 'boolean') safe.settings.practiceForceAuto = false;
        if(typeof safe.settings.practiceFixedTemplate !== 'boolean') safe.settings.practiceFixedTemplate = false;
        safe.settings.worksheetMatchMode = ["aligned","jumbled","list"].includes(safe.settings.worksheetMatchMode)
            ? safe.settings.worksheetMatchMode
            : "jumbled";
        safe.settings.templates = Array.isArray(safe.settings.templates) ? safe.settings.templates : [];
        safe.settings.activeLevels = Array.isArray(safe.settings.activeLevels)
            ? safe.settings.activeLevels.map(n => parseInt(n, 10)).filter(n => n >= 1 && n <= 10)
            : [1,2,3];
        if(!safe.settings.activeLevels.length) safe.settings.activeLevels = [1,2,3];
        if(typeof safe.settings.aiPromptAllLevels !== 'boolean') safe.settings.aiPromptAllLevels = false;
        if(typeof safe.settings.strictMode !== 'boolean') safe.settings.strictMode = false;
        safe.settings.selectionStages = Array.isArray(safe.settings.selectionStages) && safe.settings.selectionStages.length
            ? safe.settings.selectionStages.filter(v => ["discriminate","boundary","align","justify","open","recognize","guided"].includes(v))
            : ["discriminate","boundary","align","justify","open"];
        safe.settings.modulesActive = safe.settings.modulesActive && typeof safe.settings.modulesActive === "object"
            ? safe.settings.modulesActive
            : { selection: true, lab: true, desk: true };
        if(typeof safe.settings.modulesActive.selection !== "boolean") safe.settings.modulesActive.selection = true;
        if(typeof safe.settings.modulesActive.lab !== "boolean") safe.settings.modulesActive.lab = true;
        if(typeof safe.settings.modulesActive.desk !== "boolean") safe.settings.modulesActive.desk = true;
        safe.settings.levelRules = safe.settings.levelRules && typeof safe.settings.levelRules === 'object'
            ? safe.settings.levelRules
            : JSON.parse(JSON.stringify(defaultData.settings.levelRules));
        for(let lvl = 1; lvl <= 10; lvl++) {
            const r = safe.settings.levelRules[lvl] || {};
            safe.settings.levelRules[lvl] = {
                maxWords: parseInt(r.maxWords, 10) || (defaultData.settings.levelRules[lvl] ? defaultData.settings.levelRules[lvl].maxWords : defaultData.settings.levelRules[3].maxWords),
                ellipsesMaxWords: parseInt(r.ellipsesMaxWords, 10) || (defaultData.settings.levelRules[lvl] ? defaultData.settings.levelRules[lvl].ellipsesMaxWords : defaultData.settings.levelRules[3].ellipsesMaxWords)
            };
        }

        safe.globalStructure = safe.globalStructure && typeof safe.globalStructure === 'object' ? safe.globalStructure : { enabled: true, items: [] };
        safe.globalStructure.enabled = typeof safe.globalStructure.enabled === 'boolean' ? safe.globalStructure.enabled : true;
        if(safe.globalStructure.question && !safe.globalStructure.items) { 
            safe.globalStructure.items = [{ id:"g_old", question: safe.globalStructure.question, correct: safe.globalStructure.correct, distractors: safe.globalStructure.distractors }];
        }
        if(!Array.isArray(safe.globalStructure.items)) safe.globalStructure.items = [];
        safe.globalStructure.items = safe.globalStructure.items.map((q, idx) => {
            const item = q && typeof q === 'object' ? q : {};
            return {
                id: typeof item.id === 'string' ? item.id : `g${idx + 1}`,
                question: typeof item.question === 'string' ? item.question : 'New Question?',
                correct: typeof item.correct === 'string' ? item.correct : 'Answer',
                distractors: Array.isArray(item.distractors) ? item.distractors.filter(v => typeof v === 'string') : []
            };
        });

        safe.banks = safe.banks && typeof safe.banks === 'object' ? safe.banks : {};
        safe.banks.markers = Array.isArray(safe.banks.markers) ? safe.banks.markers.filter(v => typeof v === 'string') : [];
        safe.banks.starters = Array.isArray(safe.banks.starters) ? safe.banks.starters.filter(v => typeof v === 'string') : [];
        safe.banks.methods = Array.isArray(safe.banks.methods) ? safe.banks.methods.filter(v => typeof v === 'string') : [];
        safe.banks.points = Array.isArray(safe.banks.points) ? safe.banks.points.filter(v => typeof v === 'string') : [];
        safe.banks.links = safe.banks.links && typeof safe.banks.links === 'object' ? safe.banks.links : {};
        for(let lvl = 1; lvl <= 10; lvl++) {
            const key = `l${lvl}`;
            if(Array.isArray(safe.banks.links[key])) {
                safe.banks.links[key] = safe.banks.links[key].filter(v => typeof v === 'string');
            } else if(lvl >= 4 && Array.isArray(safe.banks.links.l3)) {
                safe.banks.links[key] = JSON.parse(JSON.stringify(safe.banks.links.l3));
            } else {
                safe.banks.links[key] = [];
            }
        }

        safe.sentenceConfig = safe.sentenceConfig && typeof safe.sentenceConfig === 'object' ? safe.sentenceConfig : JSON.parse(JSON.stringify(defaultData.sentenceConfig));
        for(let lvl = 1; lvl <= 10; lvl++) {
            const fallback = app.getDefaultSentenceConfig(lvl);
            if(!Array.isArray(safe.sentenceConfig[lvl])) safe.sentenceConfig[lvl] = JSON.parse(JSON.stringify(fallback));
        }

        if(!Array.isArray(safe.items)) safe.items = [];
        safe.items = safe.items.map((i, idx) => {
            const item = i && typeof i === 'object' ? i : {};
            const rawLevels = Array.isArray(item.levels)
                ? item.levels
                : (typeof item.level === 'number' || typeof item.level === 'string')
                    ? [item.level]
                    : (typeof item.levels === 'string' ? item.levels.split(',') : []);
            const levels = Array.isArray(rawLevels)
                ? rawLevels.map(n => parseInt(n, 10)).filter(n => n >= 1 && n <= 10)
                : [1,2,3];
            const original = typeof item.original === 'string' ? item.original
                : (typeof item.quote === 'string' ? item.quote
                : (typeof item.evidence === 'string' ? item.evidence
                : (typeof item.text === 'string' ? item.text : 'New Quote')));
            const translation = typeof item.translation === 'string' ? item.translation
                : (typeof item.meaning === 'string' ? item.meaning
                : (typeof item.simpleMeaning === 'string' ? item.simpleMeaning : 'Meaning'));
            const translationDistractors = Array.isArray(item.translationDistractors)
                ? item.translationDistractors
                : (Array.isArray(item.wrongMeanings) ? item.wrongMeanings
                : (Array.isArray(item.translation_distractors) ? item.translation_distractors : []));
            const effect = typeof item.effect === 'string' ? item.effect
                : (typeof item.analysis === 'string' ? item.analysis
                : (typeof item.interpretation === 'string' ? item.interpretation : ''));
            const effectDistractors = Array.isArray(item.effectDistractors)
                ? item.effectDistractors
                : (Array.isArray(item.wrongAnalyses) ? item.wrongAnalyses
                : (Array.isArray(item.effect_distractors) ? item.effect_distractors : []));
            const type = ['tone','structure','language'].includes(item.type)
                ? item.type
                : (['tone','structure','language'].includes(item.category) ? item.category : 'tone');
            return {
                id: typeof item.id === 'string' ? item.id : `q${idx + 1}`,
                original: original,
                translation: translation,
                translationDistractors: translationDistractors.filter(v => typeof v === 'string'),
                type: type,
                effect: effect,
                effectDistractors: effectDistractors.filter(v => typeof v === 'string'),
                levels: levels.length ? levels : [1,2,3],
                includeInWorksheet: typeof item.includeInWorksheet === 'boolean' ? item.includeInWorksheet : true
            };
        });

        if(safe.settings && safe.settings.levelRules) {
            if(safe.settings.practiceMode) {
                app.applyLevelRules(safe.items, safe.settings.levelRules, safe.settings.practiceModeLevel);
            } else {
                app.applyLevelRules(safe.items, safe.settings.levelRules);
            }
        }

        safe.selection = app.repairSelection(safe.selection);
        return safe;
    },

    save: function() {
        if(!appData.isStandalone) {
            localStorage.setItem('tsa_v5_1_data', JSON.stringify(appData));
        }
        localStorage.setItem(app.getStateKey(), JSON.stringify(userState));
        document.getElementById('save-status').style.opacity = 1;
        setTimeout(()=>document.getElementById('save-status').style.opacity=0, 800);
        ui.renderLab();
    },

    updateEssay: function(text) {
        userState.essay = text;
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => { app.save(); }, 1000);
    },

    resetSession: function() {
        if(confirm("Reset progress?")) {
            userState = { score: 0, level: 1, essay: "", completed: [], completedLevels: [], filter: "all", showDone: false, selectionCompleted: false, selectionStage: 1, selectionKey: "", selectionProgress: {}, labCompleted: false };
            app.save(); location.reload();
        }
    },

    factoryReset: function() {
        if(confirm("Delete ALL data?")) { localStorage.clear(); location.reload(); }
    },

    setLevel: function(l) {
        const target = parseInt(l, 10);
        const levels = app.getActiveLevels();
        userState.level = levels.includes(target) ? target : levels[0];
        app.save();
        const levelBadge = document.getElementById("level-display");
        if(levelBadge) levelBadge.innerText = "Lvl " + userState.level;
        document.getElementById("sentence-builder").innerHTML = '<div style="text-align:center; opacity:0.6; padding:20px;">Level Changed. Select quote.</div>';
    },

    setFilter: function(f) { userState.filter = f; ui.renderLab(); },
    toggleDone: function() { userState.showDone = !userState.showDone; document.getElementById('btn-show-done').classList.toggle('active', userState.showDone); ui.renderLab(); },

    selectQuote: function(id) {
        const item = appData.items.find(i=>i.id===id);
        if(item) ui.startWizard(item);
    },

    commitSentence: function() {
        const txt = document.getElementById("preview-box").innerText.trim();
        if(!txt) return alert("Empty sentence.");
        const wrong = ui.getIncorrectSelections();
        if(wrong.length) {
            if(appData.settings && appData.settings.strictMode) {
                alert("Some choices may not fit the quote. Try again.");
                return;
            }
            if(!confirm("Some choices may not fit the quote. Continue anyway?")) return;
        }
        
        document.getElementById("essay-area").value += (document.getElementById("essay-area").value ? "\n\n" : "") + txt;
        userState.essay = document.getElementById("essay-area").value;

        if(ui.activeQuoteId && !userState.completed.includes(ui.activeQuoteId)) {
            userState.completed.push(ui.activeQuoteId);
        }
        
        app.save();
        app.checkLevelCompletion();
        ui.switchView('lab'); 
        ui.renderLab(); 
    },

    checkLevelCompletion: function() {
        if(appData.settings && appData.settings.practiceMode) return;
        const levelItems = appData.items
            .filter(i => i.levels.includes(userState.level))
            .filter(i => {
                if(!ui._seenQuoteKeys) ui._seenQuoteKeys = new Set();
                const key = `${i.original}|${i.translation}|${i.type}|${i.effect}`;
                if(ui._seenQuoteKeys.has(key)) return false;
                ui._seenQuoteKeys.add(key);
                return true;
            });
        if(levelItems.length === 0) return;

        const allDone = levelItems.every(i => userState.completed.includes(i.id));

        if(allDone) {
            if(!userState.completedLevels.includes(userState.level)) {
                userState.completedLevels.push(userState.level);
            }
            const levels = app.getActiveLevels();
            const maxLevel = Math.max(...levels);
            if(userState.level < maxLevel) {
                ui.showCelebration(appData.settings && appData.settings.autoProgress);
            } else {
                ui.showCelebration(false, true); 
            }
            app.save();
        }
    },

    undo: function() {
        let v = document.getElementById("essay-area").value;
        let p = v.split("\n\n"); p.pop();
        let newVal = p.join("\n\n");
        document.getElementById("essay-area").value = newVal;
        userState.essay = newVal;
        app.save();
    },

    clearEssay: function() { 
        if(confirm("Clear essay?")) { 
            document.getElementById("essay-area").value = ""; 
            userState.essay = "";
            app.save(); 
        } 
    },

    restartCourse: function() {
        if(confirm("Play again from Level 1?")) {
            userState = { score: 0, level: 1, essay: "", completed: [], completedLevels: [], filter: "all", showDone: false, selectionCompleted: false, selectionStage: 1, selectionKey: "", selectionProgress: {}, labCompleted: false };
            app.save(); location.reload();
        }
    },
    
    exportDoc: function() {
        const text = document.getElementById("essay-area").value || "";
        const html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>Answer</title>
        <style>body{font-family:'Aptos','Calibri',sans-serif;} p{margin:0 0 10px 0;}</style>
        </head><body><p>${text.replace(/\n/g, '</p><p>')}</p></body></html>`;
        const b = new Blob(['\ufeff'+html], {type:'application/msword'});
        const a = document.createElement("a"); a.href=URL.createObjectURL(b); a.download="Answer.doc"; a.click();
    },

    playSound: function(type) {
        if(window.AudioContext) {
            const ctx = new window.AudioContext();
            const now = ctx.currentTime;
            
            if (type === 'celebrate') {
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'triangle';
                    const start = now + (i * 0.15);
                    const dur = i === 3 ? 0.8 : 0.1; 
                    gain.gain.setValueAtTime(0.1, start);
                    gain.gain.exponentialRampToValueAtTime(0.001, start + dur);
                    osc.start(start);
                    osc.stop(start + dur);
                });
            } else if (type === 'final') {
                [392.00, 523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    const start = now + (i * 0.18);
                    const dur = i === 4 ? 0.9 : 0.12; 
                    gain.gain.setValueAtTime(0.12, start);
                    gain.gain.exponentialRampToValueAtTime(0.001, start + dur);
                    osc.start(start);
                    osc.stop(start + dur);
                });
            } else {
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.connect(g); g.connect(ctx.destination);
                osc.frequency.value = 600;
                g.gain.value = 0.1;
                osc.start(); osc.stop(now + 0.1);
            }
        }
    }
};

/* --- UI --- */
const ui = {
    activeQuoteId: null,
    _readerTimer: null,
    _stopWords: new Set(["the","a","an","and","or","but","to","of","in","on","for","with","is","are","was","were","be","been","being","how","does","do","did","what","why","where","when","which","who","whom","this","that","these","those","it","its","as","at","by","from","about"]),

    init: function() {
        const aiInputEl = document.getElementById("ai-input");
        const selectionText = appData.selection && appData.selection.text && appData.selection.text.source
            ? appData.selection.text.source
            : "";
        const fallbackText = aiInputEl && aiInputEl.value && aiInputEl.value.trim()
            ? aiInputEl.value.trim()
            : "";
        const rawSource = (appData.sourceText && appData.sourceText.trim())
            ? appData.sourceText
            : (selectionText || fallbackText);
        const sourceText = app.cleanSourceText(rawSource);
        document.getElementById("lbl-title").innerText = appData.meta.title;
        document.getElementById("source-content").innerHTML = app.formatSourceHtml(sourceText);
        const levelSelect = document.getElementById("level-selector");
        if(levelSelect) {
            const levels = app.getActiveLevels();
            levelSelect.innerHTML = levels.map(n => `<option value="${n}">Lvl ${n}</option>`).join("");
        }
        const inline = document.getElementById("source-inline");
        if(inline) {
            inline.innerHTML = app.formatSourceHtml(sourceText);
        }
        const introText = document.getElementById("intro-text");
        if(introText) {
            introText.innerHTML = app.formatSourceHtml(sourceText);
        }
        ui.renderQuestionBanner();
        ui.initReaderControls();
        document.getElementById("score-display").innerText = userState.score + " XP";
        const levelBadge = document.getElementById("level-display");
        if(levelBadge) levelBadge.innerText = "Lvl " + userState.level;
        document.getElementById("essay-area").value = userState.essay;
        const activeLevels = app.getActiveLevels();
        if(!activeLevels.includes(userState.level)) userState.level = activeLevels[0];
        if(levelSelect) levelSelect.value = userState.level;
        ui.loadTheme();

        if(appData.settings && appData.settings.practiceMode) {
            const lvl = appData.settings.practiceModeLevel || 1;
            userState.level = lvl;
            userState.showDone = true;
            const sel = document.getElementById("level-selector");
            if(sel) { sel.value = lvl; sel.disabled = true; sel.title = "Practice mode locks the selected level"; }
        }
        
        // --- FORCE LAB VIEW ON START ---
        ui.switchView('lab'); 
        
        ui.renderLab();

        document.querySelectorAll(".modal").forEach(modal => {
            if(modal.dataset.backdropBound) return;
            modal.dataset.backdropBound = "true";
            modal.addEventListener("click", (e) => {
                if(e.target === modal) ui.closeModal(modal.id);
            });
        });
        
        ui.showSplash();
        
        // Only sync admin UI if we are in Teacher Mode AND the element exists
        // This is the check that prevents freezing!
        if(!appData.isStandalone && document.getElementById('modal-admin')) {
            admin.syncUI();
        }

        const selectNav = document.getElementById("nav-select");
        if(selectNav) {
            const hasSelection = appData.selection && appData.selection.enabled && appData.selection.items.length && !appData.isStandalone;
            selectNav.classList.toggle("hidden", !hasSelection);
        }
        const selectionEnabled = appData.selection && appData.selection.enabled && appData.selection.items.length && !appData.isStandalone;
        if(selectionEnabled) {
            const key = app.getSelectionKey();
            if(key && userState.selectionKey !== key) {
                userState.selectionCompleted = false;
                userState.selectionStage = 1;
                userState.selectionKey = key;
                userState.labCompleted = false;
                app.save();
            }
        }
        const navLab = document.getElementById("nav-lab");
        const navDesk = document.getElementById("nav-desk");
        const modules = appData.settings.modulesActive;
        if(navLab) navLab.classList.toggle("hidden", !modules.lab);
        if(navDesk) navDesk.classList.toggle("hidden", !modules.desk);
    },
    initReaderControls: function() {
        const zoom = document.getElementById("reader-zoom");
        if(zoom && !zoom.dataset.bound) {
            zoom.dataset.bound = "true";
            zoom.addEventListener("input", () => ui.applyReaderZoom(zoom.value));
        }
        const saved = localStorage.getItem("tsa_reader_zoom");
        if(zoom && saved) zoom.value = saved;
        ui.applyReaderZoom(zoom ? zoom.value : 110);
    },
    applyReaderZoom: function(value) {
        const content = document.getElementById("source-content");
        if(!content) return;
        const pct = Math.max(80, Math.min(180, parseInt(value, 10) || 110));
        content.style.fontSize = (pct / 100) + "rem";
        localStorage.setItem("tsa_reader_zoom", String(pct));
    },
    getKeywordMap: function(question, focusTags) {
        const map = {};
        if(Array.isArray(focusTags) && focusTags.length) {
            focusTags.forEach(tag => {
                const raw = String(tag || "").trim();
                if(!raw) return;
                const parts = raw.split(/[:=]/);
                const key = parts[0].trim().toLowerCase();
                if(!key) return;
                const syns = parts.slice(1).join(":").split(/[,|]/).map(s => s.trim().toLowerCase()).filter(Boolean);
                map[key] = Array.from(new Set([key, ...syns]));
            });
        }
        if(!Object.keys(map).length) {
            const words = String(question || "").toLowerCase().match(/\b[a-z']+\b/g) || [];
            words.filter(w => w.length >= 4 && !ui._stopWords.has(w)).forEach(w => {
                if(!map[w]) map[w] = [w];
            });
        }
        return map;
    },
    countTerm: function(term, text) {
        if(!term || !text) return 0;
        const safe = term.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
        const re = new RegExp(`\\b${safe}\\b`, "g");
        const matches = text.match(re);
        return matches ? matches.length : 0;
    },
    buildQuestionHtml: function(question, focusTags, quote) {
        const q = String(question || "");
        if(!q) return "";
        const map = ui.getKeywordMap(q, focusTags);
        const quoteText = String(quote || "").toLowerCase();
        return q.replace(/\b([A-Za-z][A-Za-z']*)\b/g, (m) => {
            const key = m.toLowerCase();
            const terms = map[key];
            if(!terms) return app.escapeHtml(m);
            let hits = 0;
            terms.forEach(t => { hits += ui.countTerm(t, quoteText); });
            const level = Math.min(3, hits);
            if(level <= 0) return app.escapeHtml(m);
            const glow = 6 + (level * 4);
            const alpha = 0.2 + (level * 0.15);
            const style = `style="color: var(--primary); box-shadow: 0 0 ${glow}px rgba(0,150,136,${alpha}); border-bottom:2px solid rgba(0,150,136,${alpha}); padding:0 2px; border-radius:4px;"`;
            return `<span ${style}>${app.escapeHtml(m)}</span>`;
        });
    },
    renderQuestionBanner: function() {
        const banner = document.getElementById("question-banner");
        if(!banner) return;
        const question = appData && appData.question ? appData.question : "";
        if(!question) { banner.classList.add("hidden"); banner.innerHTML = ""; return; }
        banner.classList.remove("hidden");
        banner.innerHTML = `<strong>Focus Question:</strong> ${ui.buildQuestionHtml(question, appData.selection && appData.selection.question ? appData.selection.question.focusTags : [], "")}`;
    },

    // THEME
    setTheme: function(key, val) { document.documentElement.style.setProperty('--'+key, val); localStorage.setItem('tsa_theme_'+key, val); },
    loadTheme: function() {
        const bg = localStorage.getItem('tsa_theme_bg');
        const text = localStorage.getItem('tsa_theme_text');
        const card = localStorage.getItem('tsa_theme_card');
        if(bg) document.documentElement.style.setProperty('--bg', bg);
        if(text) document.documentElement.style.setProperty('--text', text);
        if(card) document.documentElement.style.setProperty('--card', card);
    },
    resetTheme: function() { 
        localStorage.removeItem('tsa_theme_bg'); 
        localStorage.removeItem('tsa_theme_text'); 
        localStorage.removeItem('tsa_theme_card'); 
        location.reload(); 
    },

    renderLab: function() {
        const g = document.getElementById("quote-grid"); g.innerHTML = "";
        ui._seenQuoteKeys = new Set();
        
        if(!appData.items || appData.items.length === 0) {
            g.innerHTML = `
                <div class="card" style="cursor:default;">
                    <div style="font-weight:800; font-size:1.1rem; margin-bottom:6px;">No lesson data</div>
                    <div style="opacity:0.8;">This file doesn't contain any quotes yet.</div>
                </div>
            `;
            document.getElementById("global-card-container").innerHTML = "";
            return;
        }
        
        const practiceMode = appData.settings && appData.settings.practiceMode;
        const effectiveLevel = practiceMode ? (appData.settings.practiceModeLevel || 1) : userState.level;

        // If current level has no items, jump to first available level
        if(!practiceMode) {
            const availableLevels = app.getActiveLevels().filter(lvl => appData.items.some(i => i.levels.includes(lvl)));
            if(availableLevels.length && !availableLevels.includes(userState.level)) {
                userState.level = availableLevels[0];
                const sel = document.getElementById("level-selector");
                if(sel) sel.value = userState.level;
            }
        }

        const levelItems = appData.items.filter(i => practiceMode ? true : i.levels.includes(userState.level));
        const levelDone = levelItems.length > 0 && levelItems.every(i => userState.completed.includes(i.id));
        const maxLevel = Math.max(...app.getActiveLevels());
        if(!practiceMode && userState.level === maxLevel && levelDone) {
            const essayPreview = (userState.essay || "").trim().replace(/\n/g, "<br>");
            g.innerHTML = `
                <div class="card" style="cursor:default;">
                    <div style="font-weight:800; font-size:1.1rem; margin-bottom:6px;">üèÅ Course Complete</div>
                    <div style="opacity:0.8; margin-bottom:10px;">You have finished all Level 3 quotes. Great work!</div>
                    <div style="border:1px solid var(--border); border-radius:6px; padding:8px; background:var(--bg); max-height:140px; overflow:auto; margin-bottom:10px;">
                        ${essayPreview ? essayPreview : "<span style='opacity:0.6;'>No essay text yet.</span>"}
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px;">
                        <button class="btn btn-outline" onclick="ui.switchView('desk')">Review Answer</button>
                        <button class="btn btn-doc" onclick="app.exportDoc()">Download Answer</button>
                    </div>
                    <button class="btn btn-outline" onclick="window.print()">Print</button>
                    <button class="btn btn-primary" onclick="app.restartCourse()">Play Again</button>
                </div>
            `;
            return;
        }
        let items = levelItems.filter(i => {
            const isType = (userState.filter==="all" || i.type===userState.filter);
            const isDone = userState.completed.includes(i.id);
            if(isDone && !userState.showDone) return false;
            return isType;
        });

        // If nothing shows but level has items, relax filters
        if(items.length === 0 && levelItems.length > 0) {
            if(userState.filter !== "all") userState.filter = "all";
            if(!userState.showDone) userState.showDone = true;
            items = levelItems.filter(i => true);
        }
        
        items.forEach(i => {
            const div = document.createElement("div");
            div.className = `card card-${i.type}`;
            if(userState.completed.includes(i.id)) div.style.opacity = "0.5";
            div.innerHTML = `<span class="quote-text">"${i.original}"</span><div class="card-meta"><span>${i.type}</span><span>${userState.completed.includes(i.id)?'‚úÖ':''}</span></div>`;
            div.onclick = () => app.selectQuote(i.id);
            g.appendChild(div);
        });

        const gs = document.getElementById("global-card-container");
        if(appData.globalStructure.enabled && appData.globalStructure.items.length > 0) {
            gs.innerHTML = "";
            appData.globalStructure.items.forEach(q => {
                const div = document.createElement("div");
                div.className = "card card-global";
                div.innerHTML = `<strong>üèóÔ∏è Structure</strong><br><small>${q.question}</small>`;
                div.onclick = () => ui.runGlobal(q);
                gs.appendChild(div);
            });
        } else { gs.innerHTML = ""; }
        
        document.querySelectorAll(".filter-btn").forEach(b => b.classList.toggle("active", b.dataset.filter === userState.filter));
    },

    switchView: function(v) {
        document.querySelectorAll(".hub").forEach(e=>e.classList.remove("active"));
        document.querySelectorAll(".nav-item").forEach(e=>e.classList.remove("active"));
        document.getElementById("view-"+v).classList.add("active");
        document.getElementById("nav-"+v).classList.add("active");
        if(v === "select") ui.renderSelection();
    },

    openModal: (id) => document.getElementById(id).classList.add("open"),
    closeModal: (id) => {
        document.getElementById(id).classList.remove("open");
        if(id === 'modal-source') { ui.stopReader(); }
        if(id === 'modal-admin' && !appData.isStandalone) {
            ui._pauseSelectionGate = false;
            ui.renderLab();
            if(ui.activeQuoteId) {
                const item = appData.items.find(i=>i.id===ui.activeQuoteId);
                if(item) ui.runBuilder(item); 
            }
        }
    },
    
    openAdmin: () => {
        ui._pauseSelectionGate = true;
        admin.renderAll(); 
        if(localStorage.getItem('tsa_unlocked')==='true') { ui.openModal("modal-admin"); }
        else if(prompt("Password (1234)")==="1234") { ui.openModal("modal-admin"); }
    },
    openSourceText: () => ui.openModal("modal-source"),
    getReaderScroller: function() {
        const content = document.getElementById("source-content");
        if(content && content.scrollHeight > content.clientHeight) return content;
        return document.querySelector("#modal-source .modal-body");
    },
    toggleReader: function() {
        const body = ui.getReaderScroller();
        if(!body) return;
        const btn = document.getElementById("reader-toggle");
        if(ui._readerTimer) { ui.stopReader(); return; }
        const speedEl = document.getElementById("reader-speed");
        const speed = speedEl ? parseInt(speedEl.value, 10) : 40;
        ui._readerTimer = setInterval(() => {
            body.scrollTop += Math.max(1, speed / 10);
            if(body.scrollTop + body.clientHeight >= body.scrollHeight - 2) {
                ui.stopReader();
            }
        }, 100);
        if(btn) btn.textContent = "Pause";
    },
    stopReader: function() {
        if(ui._readerTimer) { clearInterval(ui._readerTimer); ui._readerTimer = null; }
        const btn = document.getElementById("reader-toggle");
        if(btn) btn.textContent = "Auto-Scroll";
    },
    resetReader: function() {
        const body = ui.getReaderScroller();
        if(body) body.scrollTop = 0;
        ui.stopReader();
    },
    toggleHighlight: function() {
        const windowEl = document.getElementById("reader-window");
        if(windowEl) windowEl.classList.toggle("hidden");
    },
    copySourceText: async function() {
        const text = (appData && appData.sourceText) ? appData.sourceText : (document.getElementById("source-content")?.innerText || "");
        try {
            if(navigator.clipboard && text) {
                await navigator.clipboard.writeText(text);
            }
        } catch(e) {}
        const status = document.getElementById("save-status");
        if(status) {
            const prev = status.textContent;
            status.textContent = "Copied";
            status.style.opacity = 1;
            setTimeout(() => { status.style.opacity = 0; status.textContent = prev; }, 900);
        } else {
            alert("Copied to clipboard.");
        }
    },

    startWizard: function(item) {
        const opts = [item.translation, ...item.translationDistractors||[]].sort(()=>Math.random()-0.5);
        ui.openModal("modal-wizard");
        document.getElementById("wizard-title").innerText = "Phase 1: Meaning";
        document.getElementById("wizard-prompt").innerHTML = `<p class="quote-text">"${item.original}"</p><p>What does this mean?</p>`;
        const grid = document.getElementById("wizard-options"); grid.innerHTML = "";
        opts.forEach(o => {
            const b = document.createElement("button"); b.className = "btn btn-outline"; b.textContent = o;
            b.onclick = () => {
                if(o === item.translation) {
                    b.style.background = "var(--success)"; b.style.color="white"; app.playSound('correct');
                    setTimeout(() => {
                        const hasAnalysis = item.effect || (item.effectDistractors && item.effectDistractors.length);
                        if(hasAnalysis) {
                            ui.runAnalysisStep(item);
                        } else {
                            ui.closeModal("modal-wizard");
                            ui.runBuilder(item);
                        }
                    }, 500);
                } else { b.classList.add('shake'); b.style.background = "var(--error)"; b.style.color="white"; }
            };
            grid.appendChild(b);
        });
    },

    runAnalysisStep: function(item) {
        const opts = [item.effect, ...item.effectDistractors||[]].filter(Boolean).sort(()=>Math.random()-0.5);
        document.getElementById("wizard-title").innerText = "Phase 2: Analysis";
        document.getElementById("wizard-prompt").innerHTML = `<p class="quote-text">"${item.original}"</p><p>Which analysis is most accurate?</p>`;
        const grid = document.getElementById("wizard-options"); grid.innerHTML = "";
        opts.forEach(o => {
            const b = document.createElement("button"); b.className = "btn btn-outline"; b.textContent = o;
            b.onclick = () => {
                if(o === item.effect) {
                    b.style.background = "var(--success)"; b.style.color="white"; app.playSound('correct');
                    setTimeout(() => {
                        ui.closeModal("modal-wizard");
                        ui.runBuilder(item);
                    }, 500);
                } else { b.classList.add('shake'); b.style.background = "var(--error)"; b.style.color="white"; }
            };
            grid.appendChild(b);
        });
    },

    runBuilder: function(item) {
        ui.activeQuoteId = item.id;
        ui.switchView("desk");
        const cont = document.getElementById("sentence-builder"); cont.innerHTML = "";
        const level = (appData.settings && appData.settings.practiceMode)
            ? (appData.settings.practiceModeLevel || 1)
            : userState.level;
        let cfg = appData.sentenceConfig[level] || appData.sentenceConfig[3] || [];
        if(appData.settings && appData.settings.practiceMode && appData.settings.practiceFixedTemplate) {
            cfg = app.getPracticeTemplate(level);
        }
        if(appData.settings && appData.settings.practiceMode && appData.settings.practiceForceAuto) {
            const linkSlot = `link_l${level}`;
            const mapSlot = (slot) => {
                if(!slot || !slot.startsWith("manual")) return slot;
                const tail = slot.split("_")[1] || "";
                if(tail === "marker") return "marker";
                if(tail === "starter") return "starter";
                if(tail === "method") return "method";
                if(tail === "link") return linkSlot;
                return "point";
            };
            cfg = cfg.map(mapSlot);
        }
        
        cfg.forEach(slot => {
            const row = document.createElement("div"); row.className = "slot-row";
            if(slot === "quote") {
                row.innerHTML = `<span class="slot-label">EVIDENCE</span><div class="slot-static" data-v='"${item.original}"'>"${item.original}"</div>`;
            } else if(slot.startsWith("manual")) {
                let lbl = slot.split('_')[1] || "Text";
                row.innerHTML = `<span class="slot-label">${lbl.toUpperCase()} (Idea)</span><input class="slot-input" oninput="ui.updPrev()">`;
            } else {
                let key = slot.includes("link") ? (slot.split('_')[1]||'l1') : slot+"s";
                if(slot==='point' || slot === "analysis") key='points';

                const perQuoteList = (() => {
                    if(slot === "point" || slot === "analysis") {
                        if(item.effect || (item.effectDistractors && item.effectDistractors.length)) {
                            return [item.effect, ...(item.effectDistractors || [])].filter(Boolean);
                        }
                    }
                    if(slot === "starter") {
                        const base = Array.isArray(item.starters) ? item.starters : (item.starter ? [item.starter] : null);
                        if(base) return [...base, ...(item.starterDistractors || [])].filter(Boolean);
                    }
                    if(slot === "marker") {
                        const base = Array.isArray(item.markers) ? item.markers : (item.marker ? [item.marker] : null);
                        if(base) return [...base, ...(item.markerDistractors || [])].filter(Boolean);
                    }
                    if(slot === "method") {
                        const base = Array.isArray(item.methods) ? item.methods : (item.method ? [item.method] : null);
                        if(base) return [...base, ...(item.methodDistractors || [])].filter(Boolean);
                    }
                    return null;
                })();

                let list = null;
                let correct = null;
                if(perQuoteList) {
                    list = perQuoteList;
                    if(slot === "point" || slot === "analysis") correct = item.effect;
                    if(slot === "starter") correct = item.starter || (Array.isArray(item.starters) ? item.starters[0] : null);
                    if(slot === "marker") correct = item.marker || (Array.isArray(item.markers) ? item.markers[0] : null);
                    if(slot === "method") correct = item.method || (Array.isArray(item.methods) ? item.methods[0] : null);
                }
                else if(slot.includes("link")) {
                    list = appData.banks.links[key];
                    if(!list || !list.length) list = appData.banks.links.l3;
                } else {
                    list = appData.banks[key];
                }
                if(list) {
                    const options = correct ? app.shuffle(list) : list;
                    row.innerHTML = `<span class="slot-label">${slot.toUpperCase()}</span><select class="slot-select" onchange="ui.updPrev()"><option value="">Select...</option>${options.map(o=>`<option>${o}</option>`).join('')}</select>`;
                    if(correct) {
                        const sel = row.querySelector("select");
                        sel.dataset.correct = correct;
                        sel.dataset.hint = "Does that make sense? What word would work better here?";
                    }
                }
            }
            cont.appendChild(row);
        });
        ui.updPrev();
        
        if(!userState.completed.includes(item.id)) { 
            userState.score+=10; document.getElementById("score-display").innerText = userState.score + " XP";
        }
    },

    updPrev: function() {
        let txt = [];
        document.querySelectorAll("#sentence-builder select, #sentence-builder input, #sentence-builder .slot-static").forEach(el => {
            let v = el.tagName==="DIV"? el.dataset.v : el.value;
            if(v && v.trim()) txt.push(v);
        });
        document.getElementById("preview-box").innerText = txt.join(" ") + ".";
        ui.updateHintPanel();
    },
    updateHintPanel: function() {
        const hint = document.getElementById("hint-panel");
        if(!hint) return;
        const wrong = ui.getIncorrectSelections();
        if(!wrong.length) {
            hint.classList.add("hidden");
            return;
        }
        const el = wrong[0];
        const count = parseInt(el.dataset.wrong || "0", 10);
        const correct = el.dataset.correct || "";
        const messages = [
            "Does that make sense?",
            "Try a different option. Think about meaning and tone.",
            correct ? `Hint: The best fit is "${correct}".` : "Try a different option."
        ];
        hint.textContent = messages[Math.min(count, messages.length - 1)];
        hint.classList.remove("hidden");
    },
    getIncorrectSelections: function() {
        const wrong = [];
        document.querySelectorAll("#sentence-builder select[data-correct]").forEach(sel => {
            if(!sel.dataset.lastValue) sel.dataset.lastValue = sel.value || "";
            const isCorrect = sel.value && sel.value === sel.dataset.correct;
            if(isCorrect) {
                sel.dataset.wrong = "0";
            } else if(sel.value) {
                if(sel.dataset.lastValue !== sel.value) {
                    const next = parseInt(sel.dataset.wrong || "0", 10) + 1;
                    sel.dataset.wrong = String(next);
                }
            }
            sel.dataset.lastValue = sel.value || "";
            if(sel.value && sel.value !== sel.dataset.correct) wrong.push(sel);
        });
        return wrong;
    },

    runGlobal: function(q) {
        ui.openModal("modal-wizard");
        document.getElementById("wizard-title").innerText = "Structure Analysis";
        document.getElementById("wizard-prompt").innerHTML = `<p>${q.question}</p>`;
        const opts = [q.correct, ...q.distractors].sort(()=>Math.random()-0.5);
        const grid = document.getElementById("wizard-options"); grid.innerHTML = "";
        opts.forEach(o => {
            const b = document.createElement("button"); b.className = "btn btn-outline"; b.textContent = o;
            b.onclick = () => {
                if(o === q.correct) {
                    b.style.background = "var(--success)"; b.style.color="white"; userState.score+=20; app.save(); ui.init(); app.playSound('correct');
                    setTimeout(()=>ui.closeModal("modal-wizard"), 800);
                } else { b.classList.add('shake'); b.style.background = "var(--error)"; b.style.color="white"; }
            };
            grid.appendChild(b);
        });
    },

    renderSelection: function() {
        const cont = document.getElementById("selection-area");
        if(!cont) return;
        const sel = appData.selection;
        if(!sel || !sel.enabled || !sel.items.length) {
            cont.innerHTML = `<div class="card" style="cursor:default;">No selection data loaded.</div>`;
            return;
        }
        const stages = sel.modes && sel.modes.stages ? sel.modes.stages : ["discriminate","boundary","align","justify","open"];
        const stageIndex = Math.max(1, Math.min(stages.length, userState.selectionStage || 1));
        const stageKey = stages[stageIndex - 1];
        const correctItems = sel.items.filter(i => i.correct);
        const primaryCorrect = correctItems[0] || sel.items[0];
        const chosenCorrect = ui._selectionCorrectItem || primaryCorrect;
        const distractorItems = primaryCorrect.distractors.map(d => ({ quote: d.quote, reason: d.reason, correct: false }));
        const options = app.shuffle([{ quote: primaryCorrect.quote, correct: true }, ...distractorItems]).slice(0, sel.modes.quoteCount);
        const reasons = app.shuffle([...(chosenCorrect.reasons || []), ...distractorItems.map(d => d.reason).filter(Boolean)]);
        const textHtml = app.formatSourceHtml(sel.text && sel.text.source ? sel.text.source : appData.sourceText);
        const canJumpStages = !appData.isStandalone;
        cont.innerHTML = `
            <div class="section-header" style="margin-top:0;">Quote Selection</div>
            <div style="display:flex; gap:6px; flex-wrap:wrap; margin-bottom:10px;">
                ${stages.map((s, i)=>canJumpStages
                    ? `<button class="stage-tag clickable" onclick="ui.setSelectionStage(${i+1})" style="border-color:${i+1===stageIndex?'var(--primary)':'var(--border)'}; background:${i+1===stageIndex?'rgba(0,150,136,0.12)':'rgba(0,0,0,0.04)'};">${i+1}. ${s}</button>`
                    : `<span class="stage-tag" style="border-color:${i+1===stageIndex?'var(--primary)':'var(--border)'}; background:${i+1===stageIndex?'rgba(0,150,136,0.12)':'rgba(0,0,0,0.04)'};">${i+1}. ${s}</span>`
                ).join("")}
            </div>
            <div class="builder-area">
                <div id="selection-question" class="question-banner"></div>
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:6px;">
                    <strong>Source Text</strong>
                    <button class="btn btn-outline btn-small" onclick="ui.openModal('modal-source')">Open Full Text</button>
                </div>
                <div class="guide-content" style="max-height:360px; overflow:auto; border:1px solid var(--border); border-radius:6px; padding:8px; background:var(--bg); margin-bottom:10px;">${textHtml}</div>
                <div id="selection-body"></div>
            </div>
        `;
        const body = cont.querySelector("#selection-body");
        const questionEl = cont.querySelector("#selection-question");
        if(questionEl) {
            const quoteCtx = ui._selectionQuote || (chosenCorrect && chosenCorrect.quote) || "";
            const questionText = sel.question && sel.question.prompt ? sel.question.prompt : appData.question || "";
            questionEl.innerHTML = `<strong>Question:</strong> ${ui.buildQuestionHtml(questionText, sel.question && Array.isArray(sel.question.focusTags) ? sel.question.focusTags : [], quoteCtx)}`;
        }
        if(stageKey === "discriminate") {
            const pool = app.shuffle([
                ...correctItems.map(i => ({ quote: i.quote, correct: true })),
                ...sel.items.filter(i => !i.correct).map(i => ({ quote: i.quote, correct: false }))
            ]);
            userState.selectionProgress.discriminate = userState.selectionProgress.discriminate || {};
            body.innerHTML = `<div style="font-weight:700; margin-bottom:6px;">Discrimination: Which quotes have analysis "meat"?</div>
                <div style="font-size:0.85rem; opacity:0.7; margin-bottom:8px;">Choose "Analysis-worthy" for rich language/technique, or "Plot/Noise" for surface detail.</div>
                <div class="grid" id="selection-quotes"></div>`;
            const grid = body.querySelector("#selection-quotes");
            pool.forEach(o => {
                const card = document.createElement("div");
                card.className = "card";
                card.innerHTML = `<div class="quote-text">"${o.quote}"</div>
                    <div style="display:flex; gap:6px; margin-top:8px;">
                        <button class="btn btn-outline btn-small">Analysis-worthy</button>
                        <button class="btn btn-outline btn-small">Plot/Noise</button>
                    </div>
                    <div class="card-meta" style="margin-top:6px;"><span></span></div>`;
                const [yesBtn, noBtn] = card.querySelectorAll("button");
                const meta = card.querySelector(".card-meta span");
                const key = o.quote;
                const update = (choice) => {
                    const correct = o.correct ? "analysis" : "noise";
                    userState.selectionProgress.discriminate[key] = choice;
                    if(choice === correct) {
                        meta.textContent = "‚úÖ";
                    } else {
                        meta.textContent = "‚ö†Ô∏è";
                    }
                    app.save();
                    const done = pool.every(p => userState.selectionProgress.discriminate[p.quote]);
                    if(done) {
                        const allCorrect = pool.every(p => {
                            const c = userState.selectionProgress.discriminate[p.quote];
                            return (p.correct && c === "analysis") || (!p.correct && c === "noise");
                        });
                        if(allCorrect) {
                            userState.selectionStage = stageIndex + 1;
                            app.save();
                            ui.renderSelection();
                        }
                    }
                };
                yesBtn.onclick = () => update("analysis");
                noBtn.onclick = () => update("noise");
                grid.appendChild(card);
            });
            return;
        }
        if(stageKey === "boundary") {
            const boundary = app.makeBoundaryChoices(chosenCorrect.quote);
            body.innerHTML = `<div style="font-weight:700; margin-bottom:6px;">Boundary: Which quote is the "sweet spot"?</div>
                <div style="font-size:0.85rem; opacity:0.7; margin-bottom:8px;">Avoid over‚Äëquoting or under‚Äëquoting.</div>
                <div class="grid" id="selection-quotes"></div>`;
            const grid = body.querySelector("#selection-quotes");
            boundary.options.forEach(q => {
                const btn = document.createElement("button");
                btn.className = "btn btn-outline";
                btn.textContent = `"${q}"`;
                btn.onclick = () => {
                    if(q === boundary.correct) {
                        btn.style.background = "var(--success)";
                        btn.style.color = "white";
                        userState.selectionStage = stageIndex + 1;
                        app.save();
                        ui.renderSelection();
                    } else if(sel.modes.showHints) {
                        btn.classList.add("shake");
                    }
                };
                grid.appendChild(btn);
            });
            return;
        }
        if(stageKey === "align") {
            const tags = (sel.question && sel.question.focusTags && sel.question.focusTags.length)
                ? sel.question.focusTags
                : (sel.question && sel.question.prompt ? sel.question.prompt.split(/\s+/).slice(0,4) : []);
            body.innerHTML = `<div style="font-weight:700; margin-bottom:6px;">Alignment: Which quote best answers the question?</div>
                <div style="font-size:0.85rem; opacity:0.7; margin-bottom:8px;">Focus words: ${tags.map(t=>`<span class="bank-tag">${app.escapeHtml(t)}</span>`).join(" ")}</div>
                <div class="grid" id="selection-quotes"></div>`;
            const grid = body.querySelector("#selection-quotes");
            const alignOptions = app.shuffle([
                ...correctItems.map(i => ({ quote: i.quote, correct: true, item: i })),
                ...sel.items.filter(i => !i.correct).map(i => ({ quote: i.quote, correct: false, item: i }))
            ]).slice(0, sel.modes.quoteCount);
            alignOptions.forEach(o => {
                const btn = document.createElement("button");
                btn.className = "btn btn-outline";
                btn.textContent = `"${o.quote}"`;
                btn.onclick = () => {
                    if(o.correct) {
                        btn.style.background = "var(--success)";
                        btn.style.color = "white";
                        ui._selectionQuote = o.quote;
                        ui._selectionCorrectItem = o.item || primaryCorrect;
                        userState.selectionStage = stageIndex + 1;
                        app.save();
                        ui.renderSelection();
                    } else if(sel.modes.showHints) {
                        btn.classList.add("shake");
                    }
                };
                grid.appendChild(btn);
            });
            return;
        }
        if(stageKey === "recognize") {
            body.innerHTML = `<div style="font-weight:700; margin-bottom:6px;">Recognize the best quote.</div>
                <div class="grid" id="selection-quotes"></div>
                <button class="btn btn-outline" id="selection-reveal">Reveal best quote</button>`;
            const grid = body.querySelector("#selection-quotes");
            const recogOptions = app.shuffle([
                ...correctItems.map(i => ({ quote: i.quote, correct: true, item: i })),
                ...sel.items.filter(i => !i.correct).map(i => ({ quote: i.quote, correct: false, item: i }))
            ]).slice(0, sel.modes.quoteCount);
            recogOptions.forEach(o => {
                const btn = document.createElement("button");
                btn.className = "btn btn-outline";
                btn.textContent = `"${o.quote}"`;
                btn.onclick = () => {
                    if(o.correct) { btn.style.background = "var(--success)"; btn.style.color = "white"; }
                    else if(sel.modes.showHints) { btn.classList.add("shake"); }
                };
                grid.appendChild(btn);
            });
            body.querySelector("#selection-reveal").onclick = () => {
                ui._selectionQuote = primaryCorrect.quote;
                ui._selectionCorrectItem = primaryCorrect;
                userState.selectionStage = stageIndex + 1;
                app.save();
                ui.renderSelection();
            };
            return;
        }
        if(stageKey === "guided") {
            body.innerHTML = `<div style="font-weight:700; margin-bottom:6px;">Pick the best quote:</div>
                <div class="grid" id="selection-quotes"></div>`;
            const grid = body.querySelector("#selection-quotes");
            const guidedOptions = app.shuffle([
                ...correctItems.map(i => ({ quote: i.quote, correct: true, item: i })),
                ...sel.items.filter(i => !i.correct).map(i => ({ quote: i.quote, correct: false, item: i }))
            ]).slice(0, sel.modes.quoteCount);
            guidedOptions.forEach(o => {
                const btn = document.createElement("button");
                btn.className = "btn btn-outline";
                btn.textContent = `"${o.quote}"`;
                btn.onclick = () => {
                    if(o.correct) {
                        btn.style.background = "var(--success)";
                        btn.style.color = "white";
                        ui._selectionQuote = o.quote;
                        ui._selectionCorrectItem = o.item || primaryCorrect;
                        if(sel.modes.requireReason && stages.includes("justify")) {
                            userState.selectionStage = stages.indexOf("justify") + 1;
                        } else if(stages.includes("open")) {
                            userState.selectionStage = stages.indexOf("open") + 1;
                        } else {
                            userState.selectionCompleted = true;
                        }
                        app.save();
                        ui.renderSelection();
                    } else if(sel.modes.showHints) {
                        btn.classList.add("shake");
                    }
                };
                grid.appendChild(btn);
            });
            return;
        }
        if(stageKey === "justify") {
            body.innerHTML = `<div style="font-weight:700; margin-bottom:6px;">Why is this the best choice?</div>`;
            reasons.forEach(r => {
                const rb = document.createElement("button");
                rb.className = "btn btn-outline";
                rb.textContent = r;
                rb.onclick = () => {
                    if((chosenCorrect.reasons || []).includes(r)) {
                        rb.style.background = "var(--success)";
                        rb.style.color = "white";
                        if(stages.includes("open")) {
                            userState.selectionStage = stages.indexOf("open") + 1;
                        } else {
                            userState.selectionCompleted = true;
                        }
                        app.save();
                        ui.renderSelection();
                    } else if(sel.modes.showHints) {
                        rb.classList.add("shake");
                    }
                };
                body.appendChild(rb);
            });
            return;
        }
        if(stageKey === "open") {
            body.innerHTML = `<div style="font-weight:700; margin-bottom:6px;">Find a quote in the text and paste it here:</div>
                <textarea id="selection-open-input" style="width:100%; height:70px; padding:8px; border:1px solid var(--border); border-radius:6px;"></textarea>
                <button class="btn btn-primary" id="selection-open-check">Check Quote</button>
                <div id="selection-open-feedback" style="margin-top:8px; font-size:0.9rem;"></div>`;
            body.querySelector("#selection-open-check").onclick = () => {
                const val = body.querySelector("#selection-open-input").value || "";
                const norm = val.trim().toLowerCase();
                const target = (chosenCorrect.quote || "").trim().toLowerCase();
                const fb = body.querySelector("#selection-open-feedback");
                if(norm && (norm === target || target.includes(norm) || norm.includes(target))) {
                    fb.style.color = "var(--success)";
                    fb.textContent = "Great choice. Continue to the Evidence Lab.";
                    userState.selectionCompleted = true;
                    app.save();
                    const send = document.createElement("button");
                    send.className = "btn btn-primary";
                    send.textContent = "Use this quote in Evidence Lab";
                    send.onclick = () => { ui._selectionQuote = chosenCorrect.quote; ui.useSelectionQuote(); };
                    body.appendChild(send);
                } else {
                    fb.style.color = "var(--error)";
                    fb.textContent = "Try again. Does your quote directly answer the question?";
                }
            };
            return;
        }
    },
    useSelectionQuote: function() {
        const q = ui._selectionQuote;
        if(!q) return;
        let item = appData.items.find(i => i.original === q);
        if(!item) item = appData.items.find(i => i.original && q && i.original.includes(q));
        if(!item) return alert("No matching quote found in this lesson.");
        userState.selectionCompleted = true;
        app.save();
        if(appData.settings.modulesActive.lab) {
            ui.switchView("lab");
            ui.startWizard(item);
        } else if(appData.settings.modulesActive.desk) {
            ui.switchView("desk");
            ui.runBuilder(item);
        }
    },
    setSelectionStage: function(stage) {
        const sel = appData.selection;
        if(!sel || !sel.modes || !sel.modes.stages) return;
        const maxStage = sel.modes.stages.length;
        const target = Math.max(1, Math.min(maxStage, parseInt(stage, 10) || 1));
        userState.selectionStage = target;
        app.save();
        ui.renderSelection();
    },

    showCelebration: function(autoAdvance, isFinal) {
        const overlay = document.getElementById('celebration-overlay');
        const title = document.getElementById('celebration-title');
        const sub = document.getElementById('celebration-sub');
        const btn = document.getElementById('celebration-btn');

        overlay.classList.remove('hidden');
        app.playSound(isFinal ? 'final' : 'celebrate');

        if (isFinal) {
            title.innerText = "Course Complete! üèÜ";
            sub.innerText = "Well done! Check your answer and print, save or send to your teacher.";
            btn.innerText = "Review Work";
            btn.style.display = 'block';
            btn.onclick = ui.closeCelebration;
        } else {
            title.innerText = `Level ${userState.level} Complete! üéâ`;
            sub.innerText = "Great work! Moving up...";
            if (autoAdvance) {
                btn.style.display = 'none';
                setTimeout(() => {
                    ui.closeCelebration();
                    app.setLevel(userState.level + 1);
                }, 3000);
            } else {
                btn.innerText = "Continue";
                btn.style.display = 'block';
                btn.onclick = () => {
                    ui.closeCelebration();
                    app.setLevel(userState.level + 1);
                    ui.switchView('lab');
                };
            }
        }
    },

    closeCelebration: function() {
        document.getElementById("celebration-overlay").classList.add("hidden");
    },

    showSplash: function() {
        const splash = document.getElementById("splash-screen");
        if(!splash || splash.dataset.shown) return;
        splash.dataset.shown = "true";
        splash.classList.remove("hidden");
        setTimeout(() => {
            app.playSound("celebrate");
        }, 600);

        const intro = document.getElementById("intro-text-screen");
        const pick = document.getElementById("pick-quote-screen");

        setTimeout(() => {
            splash.classList.add("hidden");
            if(intro) intro.classList.add("hidden");
            if(pick) pick.classList.add("hidden");
        }, 3500);
    }
};

/* --- ADMIN --- */
const admin = {
    aiAutoBound: false,
    renderAll: function() {
        admin.syncUI();
        admin.bindAiAutoPrompt();
        admin.ensureAiStepVisible();
        admin.refreshTemplateList();
        admin.renderQuoteList();
        admin.renderSelectionEditor();
        admin.renderGlobalList();
        const lvl = typeof currentConfigLevel === 'number' ? currentConfigLevel : 1;
        admin.renderConfig(lvl);
    },
    ensureSelectionData: () => {
        if(!appData.selection || typeof appData.selection !== "object") {
            appData.selection = app.repairSelection({});
        }
        if(!appData.selection.question || typeof appData.selection.question !== "object") {
            appData.selection.question = { prompt: "", focusTags: [] };
        }
        if(!appData.selection.modes || typeof appData.selection.modes !== "object") {
            appData.selection.modes = { selectionMode: "closed", showHints: true, requireReason: true, quoteCount: 4 };
        }
        if(!Array.isArray(appData.selection.items)) appData.selection.items = [];
        if(typeof appData.selection.enabled !== "boolean") appData.selection.enabled = appData.selection.items.length > 0;
    },
    syncUI: function() {
        document.getElementById("keep-unlocked").checked = localStorage.getItem("tsa_unlocked") === "true";
        document.getElementById("auto-progress").checked = appData.settings.autoProgress;
        document.getElementById("practice-mode").checked = !!appData.settings.practiceMode;
        const pl = document.getElementById("practice-level");
        if(pl) pl.value = appData.settings.practiceModeLevel || 1;
        const pfa = document.getElementById("practice-force-auto");
        if(pfa) pfa.checked = !!appData.settings.practiceForceAuto;
        const pft = document.getElementById("practice-fixed-template");
        if(pft) pft.checked = !!appData.settings.practiceFixedTemplate;
        const wmm = document.getElementById("worksheet-match-mode");
        if(wmm) wmm.value = appData.settings.worksheetMatchMode || "jumbled";
        const allLevels = document.getElementById("ai-all-levels");
        if(allLevels) allLevels.checked = !!appData.settings.aiPromptAllLevels;
        const strict = document.getElementById("strict-mode");
        if(strict) strict.checked = !!appData.settings.strictMode;
        const modulesWrap = document.getElementById("modules-active");
        if(modulesWrap) {
            const modules = ["selection","lab","desk"];
            const labels = { selection: "Quote Select", lab: "Evidence Lab", desk: "Writing Desk" };
            modulesWrap.innerHTML = "";
            modules.forEach(m => {
                const lbl = document.createElement("label");
                lbl.style.display = "flex";
                lbl.style.alignItems = "center";
                lbl.style.gap = "4px";
                lbl.style.fontSize = "0.85rem";
                lbl.innerHTML = `<input type="checkbox" ${appData.settings.modulesActive[m] ? "checked" : ""} data-module="${m}"> ${labels[m]}`;
                const cb = lbl.querySelector("input");
                cb.addEventListener("change", admin.updateModulesActive);
                modulesWrap.appendChild(lbl);
            });
        }
        const stageWrap = document.getElementById("selection-stages");
        if(stageWrap) {
            const allStages = ["discriminate","boundary","align","justify","open","recognize","guided"];
            const active = new Set(appData.settings.selectionStages || []);
            stageWrap.innerHTML = "";
            allStages.forEach(s => {
                const lbl = document.createElement("label");
                lbl.style.display = "flex";
                lbl.style.alignItems = "center";
                lbl.style.gap = "4px";
                lbl.style.fontSize = "0.85rem";
                lbl.innerHTML = `<input type="checkbox" ${active.has(s) ? "checked" : ""} data-stage="${s}"> ${s}`;
                const cb = lbl.querySelector("input");
                cb.addEventListener("change", admin.updateSelectionStages);
                stageWrap.appendChild(lbl);
            });
            const preset = document.getElementById("selection-stage-preset");
            if(preset) preset.value = "custom";
        }
        const activeWrap = document.getElementById("active-levels");
        if(activeWrap) {
            const active = new Set(app.getActiveLevels());
            activeWrap.innerHTML = "";
            for(let i = 1; i <= 10; i++) {
                const lbl = document.createElement("label");
                lbl.style.display = "flex";
                lbl.style.alignItems = "center";
                lbl.style.gap = "4px";
                lbl.style.fontSize = "0.85rem";
                lbl.innerHTML = `<input type="checkbox" ${active.has(i) ? "checked" : ""} data-level="${i}"> L${i}`;
                const cb = lbl.querySelector("input");
                cb.addEventListener("change", admin.updateActiveLevels);
                activeWrap.appendChild(lbl);
            }
        }
        document.getElementById("gs-enabled").checked = appData.globalStructure.enabled;

        const step2 = document.getElementById("ai-step2");
        const jsonIn = document.getElementById("ai-json-in");
        const promptOut = document.getElementById("ai-prompt-out");
        const keepOpen = localStorage.getItem("tsa_ai_step2") === "true";
        if(step2 && (keepOpen || (jsonIn && jsonIn.value && jsonIn.value.trim()) || (promptOut && promptOut.value && promptOut.value.trim()))) {
            step2.classList.remove("hidden");
        }
    },
    setUnlocked: (c) => localStorage.setItem("tsa_unlocked", c),
    setAutoProgress: (c) => { 
        if(!appData.settings) appData.settings = {};
        appData.settings.autoProgress = c; 
        app.save(); 
    },
    setPracticeMode: (c) => {
        if(!appData.settings) appData.settings = {};
        appData.settings.practiceMode = c;
        app.save();
        ui.init();
        admin.syncUI();
    },
    setPracticeLevel: (v) => {
        if(!appData.settings) appData.settings = {};
        const lvl = parseInt(v, 10);
        appData.settings.practiceModeLevel = [1,2,3].includes(lvl) ? lvl : 1;
        app.save();
        if(appData.settings.practiceMode) { ui.init(); admin.syncUI(); }
    },
    setPracticeForceAuto: (c) => {
        if(!appData.settings) appData.settings = {};
        appData.settings.practiceForceAuto = c;
        app.save();
        if(appData.settings.practiceMode) { ui.init(); admin.syncUI(); }
    },
    setPracticeFixedTemplate: (c) => {
        if(!appData.settings) appData.settings = {};
        appData.settings.practiceFixedTemplate = c;
        app.save();
        if(appData.settings.practiceMode) { ui.init(); admin.syncUI(); }
    },
    setStrictMode: (c) => {
        if(!appData.settings) appData.settings = {};
        appData.settings.strictMode = c;
        app.save();
    },
    setAiAllLevels: (c) => {
        if(!appData.settings) appData.settings = {};
        appData.settings.aiPromptAllLevels = c;
        app.save();
    },
    updateActiveLevels: () => {
        const activeWrap = document.getElementById("active-levels");
        if(!activeWrap) return;
        const selected = Array.from(activeWrap.querySelectorAll("input[type='checkbox']"))
            .filter(cb => cb.checked)
            .map(cb => parseInt(cb.dataset.level, 10))
            .filter(n => n >= 1 && n <= 10);
        if(!selected.length) return;
        if(!appData.settings) appData.settings = {};
        appData.settings.activeLevels = selected;
        app.save();
        ui.init();
        admin.syncUI();
    },
    updateSelectionStages: () => {
        const wrap = document.getElementById("selection-stages");
        if(!wrap) return;
        const selected = Array.from(wrap.querySelectorAll("input[type='checkbox']"))
            .filter(cb => cb.checked)
            .map(cb => cb.dataset.stage)
            .filter(Boolean);
        if(!selected.length) return;
        if(!appData.settings) appData.settings = {};
        appData.settings.selectionStages = selected;
        app.save();
        if(appData.selection) {
            appData.selection.modes = appData.selection.modes || {};
            appData.selection.modes.stages = selected;
        }
        ui.renderSelection();
    },
    applySelectionPreset: (preset) => {
        const presets = {
            beginner: ["guided","justify"],
            intermediate: ["discriminate","align","justify"],
            advanced: ["discriminate","boundary","align","justify","open"]
        };
        if(!presets[preset]) return;
        if(!appData.settings) appData.settings = {};
        appData.settings.selectionStages = presets[preset];
        app.save();
        if(appData.selection) {
            appData.selection.modes = appData.selection.modes || {};
            appData.selection.modes.stages = presets[preset];
        }
        admin.syncUI();
        ui.renderSelection();
    },
    updateModulesActive: () => {
        const wrap = document.getElementById("modules-active");
        if(!wrap) return;
        const selected = Array.from(wrap.querySelectorAll("input[type='checkbox']"))
            .reduce((acc, cb) => {
                acc[cb.dataset.module] = cb.checked;
                return acc;
            }, {});
        if(!appData.settings) appData.settings = {};
        appData.settings.modulesActive = Object.assign({ selection: true, lab: true, desk: true }, selected);
        app.save();
        ui.init();
    },
    markLabComplete: () => {
        userState.labCompleted = true;
        app.save();
        ui.init();
    },
    resetSelectionProgress: () => {
        userState.completed = [];
        userState.completedLevels = [];
        userState.score = 0;
        userState.showDone = false;
        userState.selectionCompleted = false;
        userState.selectionStage = 1;
        userState.selectionKey = "";
        userState.selectionProgress = {};
        userState.labCompleted = false;
        app.save();
        ui.init();
    },
    setWorksheetMatchMode: (v) => {
        if(!appData.settings) appData.settings = {};
        appData.settings.worksheetMatchMode = ["aligned","jumbled","list"].includes(v) ? v : "jumbled";
        app.save();
    },
    toggleGlobal: (c) => { appData.globalStructure.enabled = c; app.save(); ui.renderLab(); },

    // QUOTE LIST
    renderQuoteList: function() {
        const c = document.getElementById("quote-editor-list"); c.innerHTML = "";
        appData.items.forEach((item, idx) => {
            const div = document.createElement("div"); div.className = "quote-editor";
            div.innerHTML = `
                <div class="editor-header">#${idx+1} <button class="btn btn-danger btn-small" onclick="admin.delQuote(${idx})">Del</button></div>
                <div class="input-group"><label>Quote</label><input value="${item.original}" onchange="admin.updQuote(${idx},'original',this.value)"></div>
                <div class="input-group"><label>Translation</label><input value="${item.translation}" onchange="admin.updQuote(${idx},'translation',this.value)"></div>
                <div class="input-group"><label>Translation Distractors (CSV)</label><input value="${(item.translationDistractors||[]).join(',')}" onchange="admin.updQuote(${idx},'translationDistractors',this.value.split(','))"></div>
                <div class="input-group"><label>Analysis (Effect)</label><input value="${item.effect || ''}" onchange="admin.updQuote(${idx},'effect',this.value)"></div>
                <div class="input-group"><label>Analysis Distractors (CSV)</label><input value="${(item.effectDistractors||[]).join(',')}" onchange="admin.updQuote(${idx},'effectDistractors',this.value.split(','))"></div>
                <div class="level-checks">
                    <label>Worksheet: <input type="checkbox" ${item.includeInWorksheet?'checked':''} onchange="admin.updQuote(${idx},'includeInWorksheet',this.checked)"></label>
                    | Lvl:
                    ${Array.from({length:10},(_,i)=>`<label>${i+1}<input type="checkbox" ${item.levels.includes(i+1)?'checked':''} onchange="admin.togLvl(${idx},${i+1})"></label>`).join('')}
                </div>
            `;
            c.appendChild(div);
        });
    },
    updQuote: (idx, k, v) => { appData.items[idx][k] = v; app.save(); },
    togLvl: (idx, l) => { 
        const i = appData.items[idx]; 
        if(i.levels.includes(l)) i.levels = i.levels.filter(x=>x!==l); else i.levels.push(l);
        app.save();
    },
    delQuote: (idx) => { appData.items.splice(idx, 1); app.save(); admin.renderQuoteList(); },
    addQuote: () => { 
        appData.items.push({ id:"q"+Date.now(), original:"New Quote", translation:"Meaning", translationDistractors:["Wrong"], effect:"Analysis", effectDistractors:["Wrong analysis"], type:"tone", levels:[1,2,3], includeInWorksheet:true }); 
        app.save(); admin.renderQuoteList();
    },

    // GLOBAL STRUCTURE LIST
    renderGlobalList: function() {
        const c = document.getElementById("global-editor-list"); c.innerHTML = "";
        appData.globalStructure.items.forEach((item, idx) => {
            const div = document.createElement("div"); div.className = "struct-editor";
            div.innerHTML = `
                <div class="editor-header">Q${idx+1} <button class="btn btn-danger btn-small" onclick="admin.delGlobal(${idx})">Del</button></div>
                <div class="input-group"><label>Question</label><input value="${item.question}" onchange="admin.updGlobal(${idx},'question',this.value)"></div>
                <div class="input-group"><label>Correct</label><input value="${item.correct}" onchange="admin.updGlobal(${idx},'correct',this.value)"></div>
                <div class="input-group"><label>Distractors (CSV)</label><input value="${(item.distractors||[]).join(',')}" onchange="admin.updGlobal(${idx},'distractors',this.value.split(','))"></div>
            `;
            c.appendChild(div);
        });
    },
    updGlobal: (idx, k, v) => { appData.globalStructure.items[idx][k] = v; app.save(); },
    delGlobal: (idx) => { appData.globalStructure.items.splice(idx, 1); app.save(); admin.renderGlobalList(); },
    addGlobalQuestion: () => {
        appData.globalStructure.items.push({ id:"g"+Date.now(), question:"New Question?", correct:"Answer", distractors:["Wrong"] });
        app.save(); admin.renderGlobalList();
    },

    // AI
    bindAiAutoPrompt: () => {
        if(admin.aiAutoBound) return;
        const ids = [
            "ai-question","ai-input","ai-mode","ai-count",
            "ai-level-1","ai-level-2","ai-level-3",
            "ai-l1-count","ai-l1-words","ai-l1-complex","ai-l1-subtle","ai-l1-ellipsis",
            "ai-l2-count","ai-l2-words","ai-l2-complex","ai-l2-subtle","ai-l2-ellipsis",
            "ai-l3-count","ai-l3-words","ai-l3-complex","ai-l3-subtle","ai-l3-ellipsis"
        ];
        const handler = () => {
            const txt = document.getElementById("ai-input").value;
            if(txt && txt.trim()) {
                if(!app.isLikelyJson(txt)) {
                    if(!appData.sourceText || appData.sourceText.trim() !== txt.trim()) {
                        appData.sourceText = txt.trim();
                        app.save();
                        ui.init();
                    }
                }
                admin.generatePrompt(true);
            }
        };
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(!el) return;
            el.addEventListener("input", handler);
            el.addEventListener("change", handler);
        });
        ["ai-input","ai-prompt-out","selection-prompt-out","unified-prompt-out","unified-json-in"].forEach(id => {
            const el = document.getElementById(id);
            if(!el) return;
            el.addEventListener("focus", () => { ui._pauseSelectionGate = true; });
            el.addEventListener("blur", () => { ui._pauseSelectionGate = false; });
        });
        admin.aiAutoBound = true;
    },
    useSourceText: () => {
        const txt = document.getElementById("ai-input").value || "";
        if(app.isLikelyJson(txt)) return alert("That looks like JSON. Paste plain source text instead.");
        const cleaned = app.cleanSourceText(txt);
        if(!cleaned) return alert("Paste source text first.");
        appData.sourceText = cleaned;
        app.save();
        ui.init();
    },
    generateBothPrompts: () => {
        admin.generatePrompt();
        admin.generateSelectionPrompt();
    },
    generateUnifiedPrompt: () => {
        const text = (document.getElementById("ai-input").value || "").trim() || (appData.sourceText || "");
        const q = document.getElementById("ai-question").value || "How does the writer use language?";
        if(!text.trim()) return alert("Paste source text first.");
        const stages = (appData.settings && appData.settings.selectionStages) ? appData.settings.selectionStages : ["discriminate","boundary","align","justify","open"];
        const prompt = `Role: Expert English Teacher
Task: Create ONE JSON object that includes BOTH:
1) A lesson for Tone & Structure Architect
2) A quote-selection training module

Source Text: "${text.substring(0,800)}..."
Focus Question: "${q}"

Output JSON schema:
{
  lesson: { ...the lesson JSON your app already uses... },
  selection: { ...the quote-selection JSON schema below... }
}

Quote-selection schema:
{
  meta:{title, level, author, version},
  text:{source, type, wordCount},
  question:{prompt, focusTags[]},
  items:[{id, quote, correct:true, reasons[2], distractors:[{quote, reason}]}],
  modes:{selectionMode:"closed"|"open", showHints:true|false, requireReason:true|false, quoteCount, stages:${JSON.stringify(stages)}}
}

Lesson requirements: keep the same as the Tone & Structure lesson prompt (quotes, distractors, banks, sentenceConfig, globalStructure, settings).
Selection requirements: include 2‚Äì3 correct quotes (analysis‚Äëworthy) and 3‚Äì5 distractors (plot/noise).

Output ONLY valid JSON.`;
        const out = document.getElementById("unified-prompt-out");
        if(out) out.value = prompt;
    },
    copyUnifiedPrompt: async () => {
        const out = document.getElementById("unified-prompt-out");
        if(!out || !out.value.trim()) return alert("Generate the unified prompt first.");
        try {
            await navigator.clipboard.writeText(out.value);
            alert("Unified prompt copied to clipboard.");
        } catch(e) {
            out.focus();
            out.select();
            alert("Copy failed. The prompt is selected‚Äîpress Ctrl/Cmd+C.");
        }
    },
    pasteUnifiedJson: async () => {
        try {
            const txt = await navigator.clipboard.readText();
            if(!txt || !txt.trim()) return alert("Clipboard is empty.");
            const box = document.getElementById("unified-json-in");
            if(box) box.value = txt.trim();
        } catch(e) {
            alert("Paste failed. Use Ctrl/Cmd+V in the Unified JSON box.");
        }
    },
    loadUnifiedJson: () => {
        try {
            const raw = document.getElementById("unified-json-in").value;
            if(!raw || !raw.trim()) return alert("Paste unified JSON.");
            const j = JSON.parse(raw);
            const existingTemplates = admin.getTemplates();
            const lesson = j.lesson || (j.items && j.banks ? j : null);
            const selection = j.selection || (j.text && j.items && j.items[0] && j.items[0].quote ? j : null);
            if(lesson) {
                const safe = app.repair(lesson);
                if(!safe.settings.templates || !safe.settings.templates.length) safe.settings.templates = existingTemplates;
                appData = safe;
            }
            if(selection) {
                appData.selection = app.repairSelection(selection);
                if(appData.settings && Array.isArray(appData.settings.selectionStages)) {
                    appData.selection.modes = appData.selection.modes || {};
                    appData.selection.modes.stages = appData.settings.selectionStages;
                }
                userState.selectionCompleted = false;
                userState.selectionStage = 1;
                userState.selectionKey = "";
                userState.selectionProgress = {};
            }
            app.save();
            ui.init();
            admin.renderAll();
        } catch(e) {
            const msg = e && e.message ? e.message : "Invalid JSON.";
            alert("Invalid JSON: " + msg);
        }
    },
    loadUnifiedFromClipboard: async () => {
        try {
            const txt = await navigator.clipboard.readText();
            if(!txt || !txt.trim()) return alert("Clipboard is empty.");
            const box = document.getElementById("unified-json-in");
            if(box) box.value = txt.trim();
            admin.loadUnifiedJson();
        } catch(e) {
            alert("Clipboard read failed. Use Paste Unified JSON instead.");
        }
    },
    toggleAiPanel: () => {
        const step2 = document.getElementById("ai-step2");
        if(!step2) return;
        const isHidden = step2.classList.contains("hidden");
        step2.classList.toggle("hidden", !isHidden);
        localStorage.setItem("tsa_ai_step2", isHidden ? "true" : "false");
    },
    ensureAiStepVisible: () => {
        const step2 = document.getElementById("ai-step2");
        if(!step2) return;
        const promptOut = document.getElementById("ai-prompt-out");
        const jsonIn = document.getElementById("ai-json-in");
        const hasPrompt = promptOut && promptOut.value && promptOut.value.trim();
        const hasJson = jsonIn && jsonIn.value && jsonIn.value.trim();
        if(hasPrompt || hasJson) step2.classList.remove("hidden");
    },
    getAiSettings: () => {
        const getLevel = (lvl) => ({
            enabled: document.getElementById(`ai-level-${lvl}`).checked,
            count: parseInt(document.getElementById(`ai-l${lvl}-count`).value, 10) || 0,
            maxWords: parseInt(document.getElementById(`ai-l${lvl}-words`).value, 10) || 0,
            complexity: document.getElementById(`ai-l${lvl}-complex`).value,
            subtlety: document.getElementById(`ai-l${lvl}-subtle`).value,
            ellipsesMaxWords: parseInt(document.getElementById(`ai-l${lvl}-ellipsis`).value, 10) || 0
        });
        return {
            question: document.getElementById("ai-question").value,
            count: parseInt(document.getElementById("ai-count").value, 10) || 6,
            mode: document.getElementById("ai-mode").value,
            levels: { 1: getLevel(1), 2: getLevel(2), 3: getLevel(3) }
        };
    },
    applyAiSettings: (s) => {
        if(!s || typeof s !== 'object') return;
        if(typeof s.question === 'string') document.getElementById("ai-question").value = s.question;
        if(typeof s.count === 'number') document.getElementById("ai-count").value = s.count;
        if(typeof s.mode === 'string') document.getElementById("ai-mode").value = s.mode;
        const applyLevel = (lvl) => {
            const l = s.levels && s.levels[lvl] ? s.levels[lvl] : {};
            if(typeof l.enabled === 'boolean') document.getElementById(`ai-level-${lvl}`).checked = l.enabled;
            if(typeof l.count === 'number') document.getElementById(`ai-l${lvl}-count`).value = l.count || "";
            if(typeof l.maxWords === 'number') document.getElementById(`ai-l${lvl}-words`).value = l.maxWords || "";
            if(typeof l.complexity === 'string') document.getElementById(`ai-l${lvl}-complex`).value = l.complexity;
            if(typeof l.subtlety === 'string') document.getElementById(`ai-l${lvl}-subtle`).value = l.subtlety;
            if(typeof l.ellipsesMaxWords === 'number') document.getElementById(`ai-l${lvl}-ellipsis`).value = l.ellipsesMaxWords || "";
        };
        applyLevel(1); applyLevel(2); applyLevel(3);
    },
    getTemplates: () => {
        let local = [];
        try {
            const raw = JSON.parse(localStorage.getItem("tsa_templates_v1") || "[]");
            if(Array.isArray(raw)) local = raw;
        } catch(e) {}
        const embedded = (appData && appData.settings && Array.isArray(appData.settings.templates))
            ? appData.settings.templates
            : [];
        const merged = [...local];
        embedded.forEach(t => {
            if(!t || !t.name) return;
            if(!merged.find(x => x && x.name === t.name)) merged.push(t);
        });
        return merged;
    },
    saveTemplates: (templates) => {
        localStorage.setItem("tsa_templates_v1", JSON.stringify(templates));
        if(appData && appData.settings) {
            appData.settings.templates = templates;
            app.save();
        }
    },
    refreshTemplateList: () => {
        const sel = document.getElementById("template-select");
        if(!sel) return;
        const templates = admin.getTemplates();
        sel.innerHTML = templates.length ? templates.map(t => `<option value="${t.name}">${t.name}</option>`).join('') : `<option value="">No templates</option>`;
    },
    saveTemplate: () => {
        const name = document.getElementById("template-name").value.trim();
        if(!name) return alert("Enter a template name.");
        const templates = admin.getTemplates();
        const payload = {
            name,
            aiSettings: admin.getAiSettings(),
            sentenceConfig: JSON.parse(JSON.stringify(appData.sentenceConfig)),
            banks: JSON.parse(JSON.stringify(appData.banks))
        };
        const idx = templates.findIndex(t => t.name === name);
        if(idx >= 0) templates[idx] = payload; else templates.push(payload);
        admin.saveTemplates(templates);
        admin.refreshTemplateList();
        document.getElementById("template-select").value = name;
    },
    loadTemplate: () => {
        const sel = document.getElementById("template-select");
        const name = sel ? sel.value : "";
        if(!name) return alert("Select a template.");
        const templates = admin.getTemplates();
        const t = templates.find(x => x.name === name);
        if(!t) return alert("Template not found.");
        admin.applyAiSettings(t.aiSettings);
        if(t.sentenceConfig && typeof t.sentenceConfig === 'object') {
            appData.sentenceConfig = JSON.parse(JSON.stringify(t.sentenceConfig));
        }
        if(t.banks && typeof t.banks === 'object') {
            appData.banks = JSON.parse(JSON.stringify(t.banks));
        }
        app.save();
        if(t.sentenceConfig && typeof t.sentenceConfig === 'object') {
            const lvl = typeof currentConfigLevel === 'number' ? currentConfigLevel : 1;
            admin.renderConfig(lvl);
        }
    },
    generatePrompt: (silent) => {
        const c = document.getElementById("ai-count").value;
        const txt = (document.getElementById("ai-input").value || "").trim() || (appData.sourceText || "");
        const q = document.getElementById("ai-question").value || "How does the writer use language?";
        if(!txt) { if(!silent) alert("Paste text."); return; }
        
        const pointCount = Math.max(5, parseInt(c));
        const settings = admin.getAiSettings();
        const lvl = settings.levels;
        const enabledLevels = (appData.settings && appData.settings.aiPromptAllLevels)
            ? Array.from({length:10}, (_,i)=>i+1)
            : app.getActiveLevels();
        if(enabledLevels.length === 0) { if(!silent) alert("Select at least one level."); return; }
        const levelRules = enabledLevels.map(n => {
            const l = lvl[n] || {};
            const maxWords = l.maxWords ? `max ${l.maxWords} words` : (n > 3 ? `max ${30 + (n-3)*4} words` : "short quotes");
            const count = l.count ? `Aim for ${l.count} items` : "Balanced items";
            const complexity = l.complexity || (n >= 6 ? "very advanced" : n >= 4 ? "advanced" : "medium");
            const subtlety = l.subtlety || (n >= 6 ? "very subtle" : n >= 4 ? "subtle" : "medium");
            const ellipsesRule = l.ellipsesMaxWords ? `ellipsis if > ${l.ellipsesMaxWords} words` : "ellipsis only if needed";
            return `- L${n}: ${count}, ${maxWords}, ${complexity} meanings/analysis, ${subtlety} distractors, ${ellipsesRule}.`;
        }).join("\n");
        const levelRulesJson = JSON.stringify(Object.fromEntries(
            enabledLevels.map(n => [
                n,
                {
                    maxWords: (lvl[n] && lvl[n].maxWords) ? lvl[n].maxWords : (n > 3 ? 30 + (n-3)*4 : (n === 1 ? 12 : n === 2 ? 20 : 30)),
                    ellipsesMaxWords: (lvl[n] && lvl[n].ellipsesMaxWords) ? lvl[n].ellipsesMaxWords : 7
                }
            ])
        ));
        const anyCounts = enabledLevels.some(n => (lvl[n] && (lvl[n].count || 0) > 0));
        const targetSplit = anyCounts ? enabledLevels.map(n => `${lvl[n].count || 0}`).join(" / ") : "balanced across selected levels";

        document.getElementById("ai-prompt-out").value = `Role: Expert English Teacher. 
Task: Create a JSON lesson for students.
Source Text: "${txt.substring(0,800)}..."
Focus Question: "${q}"

Requirements:
1. Create ${c} items. Each item object must have: { id, original (quote from text), translation (meaning), translationDistractors (2 wrong meanings), type (tone/structure/language), effect (analysis sentence), effectDistractors (2 wrong analysis sentences), levels:[1..10], includeInWorksheet:true }.
2. Assign EACH item to one level only (${enabledLevels.join(", ")}). Ensure lower levels are simpler and higher levels are more nuanced.
3. Level rules (STRICT): 
${levelRules}
   - Enforce max word limits per level. If a quote exceeds max words, shorten with ellipses per level rule and keep it faithful to the text.
   - Do NOT output quotes longer than the max for that level.
4. Manage cognitive load: keep L1 very accessible to reduce overload, L2 for regular practice, L3 to stretch comprehension, memory, and attention. Increase subtlety gradually across levels.
5. Quality target: L2 and L3 meanings/effects should model Eduqas Grade 4+ responses; L1 is simplified practice phrasing.
6. If you cannot match the exact target split (${targetSplit}) then keep the level proportions close.
7. Populate 'globalStructure': { enabled:true, items:[ {question, correct, distractors:[2]} ] } (Create 2 distinct questions about the whole text structure, relevant to the Focus Question).
8. Provide 'sentenceConfig' for each level to build grammatically correct sentences. Use:
   - L1: ["starter","quote","link_l1","point"]
   - L2: ["marker","starter","quote","method","point","link_l2"]
   - L3: ["marker","starter","quote","method","point","link_l3"]
   - L4: ["marker","starter","quote","method","manual_point","link_l3"]
   - L5: ["marker","starter","quote","manual_method","point","link_l3"]
   - L6: ["marker","manual_starter","quote","method","point","link_l3"]
   - L7: ["manual_marker","starter","quote","method","point","link_l3"]
   - L8: ["marker","starter","quote","method","point","manual_link"]
   - L9: ["marker","starter","quote","method","manual_analysis","link_l3"]
   - L10: ["marker","starter","quote","method","manual_effect","link_l3"]
9. Populate 'banks': markers (5), starters (5), methods (5), points (${pointCount}), links:{l1:[3 simple],l2:[3 medium],l3:[3 advanced]}.
   - Create points FIRST as full, grammatically complete analysis clauses (no capital letter needed).
   - Ensure points slot into the sentenceConfig smoothly (e.g., after method or link), so the assembled sentence reads well without manual edits.
   - Keep markers/starter/link wording consistent with those point clauses.
   - Links should be clause-openers that do NOT repeat verbs from the next element (e.g., "This suggests that" + analysis).
10. If possible, include per-item options for slot-level accuracy:
    - marker or markers + markerDistractors (2)
    - starter or starters + starterDistractors (2)
    - method or methods + methodDistractors (2)
    - effect + effectDistractors (2) for analysis/point slots
11. Include settings: { autoProgress:false, practiceMode:false, practiceModeLevel:1, practiceForceAuto:false, practiceFixedTemplate:false, worksheetMatchMode:"jumbled", levelRules: ${levelRulesJson} }.

Output ONLY valid JSON.`;
        document.getElementById("ai-step2").classList.remove("hidden");
        localStorage.setItem("tsa_ai_step2", "true");
    },
    loadJson: (exportAfter) => {
        try {
            let j = JSON.parse(document.getElementById("ai-json-in").value.replace(/```json|```/g, ''));
            if(Array.isArray(j)) j = { items: j };
            const mode = document.getElementById("ai-mode").value;
            const existingTemplates = admin.getTemplates();
            if(j && j.text && j.items && j.items[0] && j.items[0].quote) {
                appData.selection = app.repairSelection(j);
                if(appData.settings && Array.isArray(appData.settings.selectionStages)) {
                    appData.selection.modes = appData.selection.modes || {};
                    appData.selection.modes.stages = appData.settings.selectionStages;
                }
                userState.selectionCompleted = false;
                userState.selectionStage = 1;
                userState.selectionKey = "";
            userState.selectionProgress = {};
        userState.labCompleted = false;
                app.save();
                ui.init();
                admin.renderAll();
                return;
            }
            const safe = app.repair(j);
            const aiText = (document.getElementById("ai-input").value || "").trim();
            const aiQuestion = (document.getElementById("ai-question").value || "").trim();
            if(aiText && !j.sourceText) safe.sourceText = aiText;
            if(aiQuestion && !j.question) safe.question = aiQuestion;
            if((!j.meta || !j.meta.title) && aiQuestion) safe.meta.title = aiQuestion;

            const aiSettings = admin.getAiSettings && admin.getAiSettings();
            if(aiSettings && aiSettings.levels) {
                const rules = {};
                [1,2,3].forEach(lvl => {
                    rules[lvl] = {
                        maxWords: aiSettings.levels[lvl].maxWords || defaultData.settings.levelRules[lvl].maxWords,
                        ellipsesMaxWords: aiSettings.levels[lvl].ellipsesMaxWords || defaultData.settings.levelRules[lvl].ellipsesMaxWords
                    };
                });
                if(!safe.settings) safe.settings = {};
                if(!safe.settings.levelRules || typeof safe.settings.levelRules !== 'object') safe.settings.levelRules = {};
                [1,2,3].forEach(lvl => {
                    if(!safe.settings.levelRules[lvl]) safe.settings.levelRules[lvl] = rules[lvl];
                    if(!safe.settings.levelRules[lvl].maxWords) safe.settings.levelRules[lvl].maxWords = rules[lvl].maxWords;
                    if(!safe.settings.levelRules[lvl].ellipsesMaxWords) safe.settings.levelRules[lvl].ellipsesMaxWords = rules[lvl].ellipsesMaxWords;
                });
                const usePractice = safe.settings && safe.settings.practiceMode;
                const practiceLevel = safe.settings && safe.settings.practiceModeLevel;
                app.applyLevelRules(safe.items, safe.settings.levelRules, usePractice ? practiceLevel : undefined);
            }
            
            if(mode === "replace") {
                appData = safe;
                if(!appData.settings.templates || !appData.settings.templates.length) {
                    appData.settings.templates = existingTemplates;
                }
                userState.completed = [];
                userState.completedLevels = [];
                userState.filter = "all";
                userState.showDone = false;
                userState.level = 1;
            } else if (mode === "append") {
                appData.items = [...(appData.items||[]), ...(safe.items||[])];
            }
            
            app.save();
            ui.renderLab();
            admin.renderAll();
            const step2 = document.getElementById("ai-step2");
            if(step2) step2.classList.remove("hidden");
            localStorage.setItem("tsa_ai_step2", "true");
            if(exportAfter) admin.exportStandalone();
        } catch(e) {
            const msg = e && e.message ? e.message : "Invalid JSON or corrupted file.";
            alert("Invalid JSON: " + msg);
        }
    },
    loadSelectionJson: () => {
        try {
            const raw = document.getElementById("selection-json-in").value;
            if(!raw || !raw.trim()) return alert("Paste selection JSON.");
            const j = JSON.parse(raw);
            appData.selection = app.repairSelection(j);
            if(appData.settings && Array.isArray(appData.settings.selectionStages)) {
                appData.selection.modes = appData.selection.modes || {};
                appData.selection.modes.stages = appData.settings.selectionStages;
            }
            userState.selectionCompleted = false;
            userState.selectionStage = 1;
            userState.selectionKey = "";
            userState.selectionProgress = {};
        userState.labCompleted = false;
            app.save();
            ui.init();
            admin.renderAll();
        } catch(e) {
            const msg = e && e.message ? e.message : "Invalid JSON.";
            alert("Invalid JSON. Paste ONLY the JSON output (no plain text). Details: " + msg);
        }
    },
    generateSelectionPrompt: () => {
        const text = (document.getElementById("ai-input").value || "").trim() || (appData.sourceText || "");
        const q = document.getElementById("ai-question").value || "How does the writer use language?";
        if(!text.trim()) return alert("Paste source text first.");
        const prompt = `Role: Expert English Teacher
Task: Create a JSON template for quote-selection practice.

Source Text: "${text.substring(0,800)}..."
Focus Question: "${q}"

Requirements:
1. Output valid JSON following this schema:
{
  meta:{title, level, author, version},
  text:{source, type, wordCount},
  question:{prompt, focusTags[]},
  items:[{id, quote, correct:true, reasons[2], distractors:[{quote, reason}]}],
  modes:{selectionMode:"closed"|"open", showHints:true|false, requireReason:true|false, quoteCount, stages:["recognize","guided","justify","open"]}
}
2. Create 4‚Äì6 total quotes:
   - 1 correct quote
   - 3‚Äì5 distractors
   - All quotes must be from the source text
3. Write 2 short reasons for the correct quote.
4. Each distractor must include a reason explaining why it is weaker.
5. Use accessible language (Entry 3 ‚Äì Grade 3).

Output ONLY JSON.`;
        const out = document.getElementById("selection-prompt-out");
        if(out) out.value = prompt;
    },
    copySelectionPrompt: async () => {
        const out = document.getElementById("selection-prompt-out");
        if(!out || !out.value.trim()) return alert("Generate the prompt first.");
        try {
            await navigator.clipboard.writeText(out.value);
            alert("Prompt copied to clipboard.");
        } catch(e) {
            out.focus();
            out.select();
            alert("Copy failed. The prompt is selected‚Äîpress Ctrl/Cmd+C.");
        }
    },
    pasteSelectionJson: async () => {
        try {
            const txt = await navigator.clipboard.readText();
            if(!txt || !txt.trim()) return alert("Clipboard is empty.");
            const box = document.getElementById("selection-json-in");
            if(box) box.value = txt.trim();
        } catch(e) {
            alert("Paste failed. Use Ctrl/Cmd+V in the Selection JSON box.");
        }
    },
    clearSelectionGate: () => {
        userState.selectionCompleted = true;
        app.save();
        ui.init();
    },
    renderSelectionEditor: () => {
        admin.ensureSelectionData();
        const wrap = document.getElementById("selection-editor-list");
        if(!wrap) return;
        const sel = appData.selection;
        const focusTags = Array.isArray(sel.question.focusTags) ? sel.question.focusTags.join(", ") : "";
        wrap.innerHTML = `
            <div class="input-group">
                <label>Enable Quote Selection</label>
                <label style="display:flex; align-items:center; gap:6px; font-size:0.9rem;">
                    <input type="checkbox" id="selection-enabled" ${sel.enabled ? "checked" : ""} onchange="admin.updateSelectionMeta('enabled', this.checked)"> Enabled
                </label>
            </div>
            <div class="input-group">
                <label>Question Prompt</label>
                <input type="text" id="selection-question" value="${app.escapeHtml(sel.question.prompt || "")}" onchange="admin.updateSelectionMeta('prompt', this.value)">
            </div>
            <div class="input-group">
                <label>Focus Tags (CSV, synonyms with ":" e.g., fear: dread, terror)</label>
                <input type="text" id="selection-focus-tags" value="${app.escapeHtml(focusTags)}" onchange="admin.updateSelectionMeta('focusTags', this.value)">
            </div>
            <div class="input-group">
                <label>Quote Count (shown per stage)</label>
                <input type="number" id="selection-quote-count" min="2" max="10" value="${parseInt(sel.modes.quoteCount, 10) || 4}" onchange="admin.updateSelectionMeta('quoteCount', this.value)">
            </div>
            <div style="font-weight:700; margin:10px 0 6px 0;">Quotes</div>
            ${sel.items.map((item, idx) => {
                const reasons = Array.isArray(item.reasons) ? item.reasons.join("\\n") : "";
                const distractors = Array.isArray(item.distractors)
                    ? item.distractors.map(d => `${d.quote || ""} || ${d.reason || ""}`).join("\\n")
                    : "";
                return `
                    <div class="quote-editor">
                        <div class="editor-header">#${idx+1}
                            <button class="btn btn-danger btn-small" onclick="admin.delSelectionItem(${idx})">Del</button>
                        </div>
                        <div class="input-group"><label>Quote</label><input value="${app.escapeHtml(item.quote || "")}" onchange="admin.updateSelectionItem(${idx}, 'quote', this.value)"></div>
                        <div class="input-group"><label>Analysis-worthy</label><label style="display:flex; align-items:center; gap:6px; font-size:0.9rem;"><input type="checkbox" ${item.correct ? "checked" : ""} onchange="admin.updateSelectionItem(${idx}, 'correct', this.checked)"> Correct</label></div>
                        <div class="input-group"><label>Reasons (one per line)</label><textarea onchange="admin.updateSelectionItem(${idx}, 'reasons', this.value)" style="height:70px;">${app.escapeHtml(reasons)}</textarea></div>
                        <div class="input-group"><label>Distractors (one per line: quote || reason)</label><textarea onchange="admin.updateSelectionItem(${idx}, 'distractors', this.value)" style="height:90px;">${app.escapeHtml(distractors)}</textarea></div>
                    </div>
                `;
            }).join("")}
        `;
    },
    updateSelectionMeta: (key, value) => {
        admin.ensureSelectionData();
        if(key === "enabled") {
            appData.selection.enabled = !!value;
        } else if(key === "prompt") {
            appData.selection.question.prompt = String(value || "");
            appData.question = appData.selection.question.prompt || appData.question;
        } else if(key === "focusTags") {
            const tags = String(value || "").split(",").map(t => t.trim()).filter(Boolean);
            appData.selection.question.focusTags = tags;
        } else if(key === "quoteCount") {
            const n = Math.max(2, Math.min(10, parseInt(value, 10) || 4));
            appData.selection.modes.quoteCount = n;
        }
        app.save();
        ui.init();
        admin.renderSelectionEditor();
    },
    updateSelectionItem: (idx, key, value) => {
        admin.ensureSelectionData();
        const item = appData.selection.items[idx];
        if(!item) return;
        if(key === "quote") {
            item.quote = String(value || "");
        } else if(key === "correct") {
            item.correct = !!value;
        } else if(key === "reasons") {
            item.reasons = String(value || "").split(/\n+/).map(v => v.trim()).filter(Boolean);
        } else if(key === "distractors") {
            const lines = String(value || "").split(/\n+/).map(v => v.trim()).filter(Boolean);
            item.distractors = lines.map((line, i) => {
                const parts = line.split("||").map(p => p.trim());
                return { id: `sd${idx+1}_${i+1}`, quote: parts[0] || "", reason: parts[1] || "" };
            });
        }
        app.save();
        ui.renderSelection();
    },
    addSelectionItem: () => {
        admin.ensureSelectionData();
        appData.selection.items.push({
            id: "s" + Date.now(),
            quote: "New quote",
            correct: false,
            reasons: ["Reason 1", "Reason 2"],
            distractors: [{ id: "sd_new_1", quote: "Distractor quote", reason: "Weaker reason" }]
        });
        app.save();
        admin.renderSelectionEditor();
    },
    delSelectionItem: (idx) => {
        admin.ensureSelectionData();
        appData.selection.items.splice(idx, 1);
        app.save();
        admin.renderSelectionEditor();
        ui.renderSelection();
    },

    // BANK EDITOR
    editBank: (key) => {
        currentBankKey = key;
        document.getElementById('bank-editor-ui').classList.remove('hidden');
        document.getElementById('bank-name-display').innerText = "Editing: " + key.toUpperCase();
        
        let list = [];
        if(key.includes('link')) {
            const l = key.split('_')[1];
            list = appData.banks.links[l] || [];
        } else {
            list = appData.banks[key] || [];
        }

        const cont = document.getElementById('bank-list-container');
        cont.innerHTML = list.map((val, i) => 
            `<span class="bank-tag">${val}<button onclick="admin.removeBankItem(${i})">x</button></span>`
        ).join('');
    },

    addBankItem: () => {
        const val = document.getElementById('bank-add-input').value;
        if(!val || !currentBankKey) return;
        
        if(currentBankKey.includes('link')) {
            const l = currentBankKey.split('_')[1];
            if(!appData.banks.links[l]) appData.banks.links[l] = [];
            appData.banks.links[l].push(val);
        } else {
            if(!appData.banks[currentBankKey]) appData.banks[currentBankKey] = [];
            appData.banks[currentBankKey].push(val);
        }
        app.save();
        admin.editBank(currentBankKey); 
        document.getElementById('bank-add-input').value = '';
    },

    removeBankItem: (idx) => {
        if(currentBankKey.includes('link')) {
            const l = currentBankKey.split('_')[1];
            appData.banks.links[l].splice(idx, 1);
        } else {
            appData.banks[currentBankKey].splice(idx, 1);
        }
        app.save();
        admin.editBank(currentBankKey);
    },

    renderConfig: function(lvl) {
        currentConfigLevel = lvl;
        const sel = document.getElementById('config-level-select');
        if(sel) sel.value = String(lvl);
        const cont = document.getElementById('config-slots'); cont.innerHTML = '';
        const slots = appData.sentenceConfig[lvl];
        const allOpts = ['marker', 'starter', 'quote', 'method', 'analysis', 'link_l1', 'link_l2', 'link_l3', 'point', 'manual_marker', 'manual_starter', 'manual_method', 'manual_point', 'manual_link', 'manual_analysis', 'manual_effect'];
        
        for(let i=0; i<6; i++) {
            const sel = document.createElement('select');
            sel.innerHTML = `<option value="none">None</option>` + allOpts.map(o => `<option value="${o}" ${slots[i]===o?'selected':''}>${o}</option>`).join('');
            sel.onchange = () => {
                const arr = Array.from(cont.querySelectorAll('select')).map(s=>s.value).filter(v=>v!=='none');
                appData.sentenceConfig[lvl] = arr; app.save();
            };
            cont.appendChild(sel);
        }
    },

    // EXPORTS
    exportWorksheet: function() {
        let content = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>Worksheet</title>
        <style>body{font-family:'Aptos','Calibri',sans-serif;} .box{border:1px solid #999; padding:10px; margin-bottom:15px;} .dotted{border-bottom:1px dotted #000; display:inline-block; width:95%; margin-top:5px;}</style>
        </head><body>
        <h1>${appData.meta.title}</h1>
        <p>${appData.sourceText.replace(/\n/g, '<br>')}</p><hr>`;
        
        const shuffle = (arr) => {
            const a = arr.slice();
            for(let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        };
        const uiLevel = parseInt((document.getElementById("level-selector") || {}).value, 10) || 1;
        const level = (appData.settings && appData.settings.practiceMode)
            ? (appData.settings.practiceModeLevel || 1)
            : uiLevel;
        let structure = appData.sentenceConfig[level] || appData.sentenceConfig[3] || ["starter", "quote", "point"];
        if(appData.settings && appData.settings.practiceMode && appData.settings.practiceFixedTemplate) {
            structure = app.getPracticeTemplate(level);
        }
        if(appData.settings && appData.settings.practiceMode && appData.settings.practiceForceAuto) {
            const linkSlot = `link_l${level}`;
            const mapSlot = (slot) => {
                if(!slot || !slot.startsWith("manual")) return slot;
                const tail = slot.split("_")[1] || "";
                if(tail === "marker") return "marker";
                if(tail === "starter") return "starter";
                if(tail === "method") return "method";
                if(tail === "link") return linkSlot;
                return "point";
            };
            structure = structure.map(mapSlot);
        }

        const worksheetQuote = (item) => {
            const raw = item.originalFull || item.original || "";
            const ruleSet = appData.settings && appData.settings.levelRules ? appData.settings.levelRules : {};
            const rule = ruleSet[level] || {};
            const maxWords = parseInt(rule.maxWords, 10) || 0;
            const words = app.wordList(raw);
            if(maxWords > 0 && words.length > maxWords) return app.truncateWithEllipses(words, maxWords);
            return raw;
        };

        // Part A: Match
        const included = appData.items.filter(i=>i.includeInWorksheet);
        const matchMode = (appData.settings && appData.settings.worksheetMatchMode) || "jumbled";
        const meanings = included.map(i=>i.translation);
        if(matchMode === "list") {
            const shuffled = shuffle(meanings);
            content += `<h3>Part A: Match Meanings</h3><p><em>Choices: ${shuffled.join(' / ')}</em></p>`;
            included.forEach((item, idx) => {
                content += `<p>${idx+1}. "${worksheetQuote(item)}" = __________________</p>`;
            });
        } else {
            const rightSide = matchMode === "aligned" ? meanings : shuffle(meanings);
            content += `<h3>Part A: Match Meanings</h3>`;
            content += `<p><em>Draw a line through the middle column to match each quote with its interpretation.</em></p>`;
            content += `<table style="width:100%; border-collapse:collapse; margin-bottom:15px;">`;
            content += `<tr><th style="text-align:left; border-bottom:1px solid #999; padding:6px;">Quote</th><th style="text-align:center; border-bottom:1px solid #999; padding:6px;">Match</th><th style="text-align:left; border-bottom:1px solid #999; padding:6px;">Interpretation</th></tr>`;
            included.forEach((item, idx) => {
                const right = rightSide[idx] || "";
                content += `<tr>
                    <td style="border-bottom:1px dotted #ccc; padding:6px;">${idx+1}. "${worksheetQuote(item)}"</td>
                    <td style="border-bottom:1px dotted #ccc; padding:6px; text-align:center;">&nbsp;</td>
                    <td style="border-bottom:1px dotted #ccc; padding:6px;">${right}</td>
                </tr>`;
            });
            content += `</table>`;
        }

        // Part B: Analysis
        content += `<br><h3>Part B: Analysis</h3>`;
        appData.items.forEach((item, idx) => {
            if(!item.includeInWorksheet) return;
            content += `<div class="box"><p><strong>${idx+1}. Quote: "${worksheetQuote(item)}"</strong></p>`;
            
            structure.forEach(slot => {
                let label = slot.toUpperCase();
                let inner = "";
                
                if(slot === 'quote') return; 
                else if(slot.startsWith('manual')) {
                    inner = `<span class="dotted"></span>`;
                    label = slot.split('_')[1].toUpperCase();
                } else {
                    let key = slot.includes('link') ? (slot.split('_')[1]||'l2') : slot+"s";
                    if(slot==='point' || slot === "analysis") key='points';
                    let opts = null;
                    if(slot === "point" || slot === "analysis") {
                        if(item.effect || (item.effectDistractors && item.effectDistractors.length)) {
                            opts = [item.effect, ...(item.effectDistractors || [])].filter(Boolean);
                        }
                    }
                    if(!opts) {
                        if(slot.includes('link')) {
                            opts = appData.banks.links[key];
                            if(!opts || !opts.length) opts = appData.banks.links.l3;
                        } else {
                            opts = appData.banks[key];
                        }
                    }
                    if(opts) inner = `<em>${opts.join(' / ')}</em><br><span class="dotted"></span>`;
                }
                content += `<p><strong>${label}:</strong> ${inner}</p>`;
            });
            content += `<br><p><strong>Sentence:</strong><br><span class="dotted"></span><br><span class="dotted"></span></p></div>`;
        });
        
        content += `</body></html>`;
        const b = new Blob(['\ufeff'+content], {type:'application/msword'});
        const a = document.createElement("a"); a.href=URL.createObjectURL(b); a.download="Worksheet.doc"; a.click();
    },

    exportStandalone: () => {
        if(!appData.items || appData.items.length === 0) {
            return alert("No lesson data to export yet.");
        }
        // 1. Prepare data with lock
        const exportData = JSON.parse(JSON.stringify(appData));
        exportData.isStandalone = true; 
        if(!exportData.sourceText) {
            const aiInput = document.getElementById("ai-input");
            const sourceInline = document.getElementById("source-inline");
            const sourceModal = document.getElementById("source-content");
            const candidates = [
                aiInput && aiInput.value,
                sourceInline && sourceInline.innerText,
                sourceModal && sourceModal.innerText
            ].map(v => (v || "").trim()).filter(Boolean);
            if(candidates.length) exportData.sourceText = app.cleanSourceText(candidates[0]);
        }
        if(!exportData.meta) exportData.meta = {};
        if(!exportData.meta.id) exportData.meta.id = "lesson_" + Date.now();

        // 2. Clone document to avoid mutating live DOM
        const clone = document.documentElement.cloneNode(true);
        const cloneDoc = document.implementation.createHTMLDocument();
        cloneDoc.replaceChild(clone, cloneDoc.documentElement);

        // 3. Remove teacher-only UI in the clone
        const adminBtn = cloneDoc.querySelector('#btn-admin');
        if (adminBtn) adminBtn.remove();
        const adminModal = cloneDoc.querySelector('#modal-admin');
        if (adminModal) adminModal.remove();

        // 4. Inject standalone data at start of body
        const dataScript = cloneDoc.createElement('script');
        dataScript.textContent = `window.STANDALONE_LESSON = ${JSON.stringify(exportData)};`;
        cloneDoc.body.prepend(dataScript);

        // 5. Serialize with doctype
        const h = '<!DOCTYPE html>\n' + cloneDoc.documentElement.outerHTML;
        const b = new Blob([h], {type:'text/html'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='StudentApp.html'; a.click();
    },
    saveConfig: () => {
        const b = new Blob([JSON.stringify(appData)], {type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='config.json'; a.click();
    },
    exportTemplates: () => {
        const templates = admin.getTemplates();
        const payload = { templates };
        const b = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='templates.json'; a.click();
    },
    importTemplates: (input) => {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            try {
                const parsed = JSON.parse(e.target.result);
                const incoming = Array.isArray(parsed) ? parsed : (parsed && parsed.templates) ? parsed.templates : [];
                if(!Array.isArray(incoming)) throw new Error("Invalid templates format.");
                const current = admin.getTemplates();
                const merged = [...current];
                incoming.forEach(t => {
                    if(!t || !t.name) return;
                    if(!merged.find(x => x && x.name === t.name)) merged.push(t);
                });
                admin.saveTemplates(merged);
                admin.refreshTemplateList();
                alert(`Imported ${incoming.length} template(s).`);
            } catch(err) {
                alert("Template import failed: " + (err && err.message ? err.message : "Invalid file"));
            }
        };
        r.readAsText(f);
        input.value = "";
    },
    loadFile: (input) => {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            const raw = e.target.result || "";
            const text = String(raw || "");
            try {
                const parsed = JSON.parse(text);
                appData = app.repair(parsed);
                app.save();
                location.reload();
            } catch(err) {
                const cleaned = app.cleanSourceText(text);
                if(!cleaned) {
                    alert("This file is not valid JSON or readable text.");
                    return;
                }
                if(!appData) appData = app.repair(defaultData);
                appData.sourceText = cleaned;
                app.save();
                ui.init();
                const aiInput = document.getElementById("ai-input");
                if(aiInput) aiInput.value = cleaned;
                localStorage.setItem("tsa_ai_step2", "true");
                const step2 = document.getElementById("ai-step2");
                if(step2) step2.classList.remove("hidden");
                if(localStorage.getItem("tsa_unlocked") === "true") {
                    const adminModal = document.getElementById("modal-admin");
                    if(adminModal && !adminModal.classList.contains("open")) {
                        ui.openModal("modal-admin");
                    }
                }
                alert("Source text loaded. Use the AI panel to generate lesson data.");
            }
        };
        r.readAsText(f);
    }
};

window.onload = app.init;
</script>
</body>
</html>
