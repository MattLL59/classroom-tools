<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tone & Structure Architect v213 (Password Fix)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #009688; 
            --accent: #ff9800; 
            --bg: #f0f2f5;
            --card: #ffffff; 
            --text: #37474f; 
            --tone-col: #9c27b0;
            --struct-col: #2196f3; 
            --lang-col: #4caf50; 
            --nav-bg: #ffffff;
            --success: #4caf50; 
            --error: #f44336;
            --high-vis: #29b6f6;
        }
        
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s, color 0.3s; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--card); box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; flex-shrink: 0; }
        h1 { margin: 0; font-size: 1.1rem; color: var(--primary); display:flex; align-items:center; gap:5px; }
        .score-badge { background: var(--accent); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.9rem; margin-left: 10px; font-weight: bold; }

        /* LOADING / RESET TEXT */
        .loading-text { cursor: pointer; color: var(--error); font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* BUTTONS & ICONS (Emoji Based) */
        .admin-btn { 
            background: none; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            font-size: 1.2rem; 
            cursor: pointer; 
            padding: 5px 10px;
            margin-left: 5px;
            transition: background 0.2s;
        }
        .admin-btn:hover { background: #eee; }

        /* LAYOUT */
        .main-viewport { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        nav.bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: var(--nav-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 900; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; color: #888; font-size: 0.75rem; border: none; background: none; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        
        /* HUBS */
        .hub { display: none; } .hub.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* GRID SECTIONS */
        .section-header { font-size: 0.9rem; text-transform: uppercase; color: #888; margin: 15px 0 5px 0; border-bottom: 1px solid #ccc; padding-bottom: 2px; }
        .grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 20px; }
        @media(min-width: 600px) { .grid { grid-template-columns: 1fr 1fr; } }
        #structure-container { margin-top: 5px; }

        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 2px solid #ddd; text-align: center; font-size: 1.1rem; cursor: pointer; transition: transform 0.1s; position: relative; overflow: visible; }
        .card:hover { transform: scale(1.02); border-color: var(--primary); }
        .card-tone { border-left: 10px solid var(--tone-col); }
        .card-struct { border-left: 10px solid var(--struct-col); text-align: left; }
        .card-lang { border-left: 10px solid var(--lang-col); }
        .card-global { border-left: 10px solid #607d8b; background: var(--card); width: 100%; box-sizing: border-box; text-align: left; display: flex; align-items: center; justify-content: space-between; }

        /* ANIMATIONS */
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        .shake { animation: shake 0.4s ease-in-out; border-color: var(--error) !important; background: #ffebee !important; }

        /* BUILDER */
        .bank-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; background: rgba(0,0,0,0.02); padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; }
        .bank-row { text-align: left; width: 100%; margin-bottom: 10px; display: block; }
        .bank-label { font-size: 0.8rem; font-weight: bold; text-transform: uppercase; color: var(--primary); margin-bottom: 5px; display: block;}
        
        select { width: 100%; height: 45px; padding: 8px; border-radius: 6px; border: 1px solid #bbb; background: var(--card); color: var(--text); font-size: 1rem; display: block; margin-bottom: 5px; } 
        .manual-text-input { width: 100%; padding: 10px; border: 2px solid var(--accent); border-radius: 6px; font-size: 1rem; font-family: inherit; box-sizing: border-box; background: #fff3e0; }
        .static-quote-display { background: #e3f2fd; border: 1px solid #2196f3; color: #0d47a1; padding: 12px; border-radius: 6px; font-style: italic; font-family: 'Georgia', serif; }
        
        #sentence-stage { width: 100%; padding: 15px; background: var(--card); border: 2px dashed var(--primary); border-radius: 10px; margin: 15px 0; font-size: 1.1rem; min-height: 60px; line-height: 1.4; cursor: text; color: var(--text); }
        #sentence-stage:focus { outline: 2px solid var(--accent); }
        .placeholder-text { color: #aaa; font-style: italic; }

        #answer-area { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; background: var(--card); color: var(--text); font-family: inherit; margin-bottom: 10px; font-size: 1rem; }
        #quote-reference { background: #e3f2fd; border-left: 5px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px; font-style: italic; color: #444; display: none; }

        /* ADMIN & EDITORS */
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; font-size: 1rem; width:100%; margin-bottom:5px; }
        .btn-primary { background: var(--primary); }
        .btn-warning { background: var(--accent); }
        .btn-danger { background: #e74c3c; }
        .btn-doc { background: #1976d2; }
        .btn-high-vis { background: var(--high-vis); color: #000; font-size: 1.1rem; border: 2px solid #000; }
        .admin-btn { background:none; border:none; color:var(--text); font-size:1.2rem; cursor:pointer; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999999; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); color: var(--text); width: 95%; max-width: 1200px; max-height: 95vh; border-radius: 8px; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); overflow: visible !important; }
        .modal-header { padding: 15px; background: rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-body { padding: 20px; overflow-y: auto; text-align: left; padding-bottom: 400px; } 
        
        .editor-section { border: 2px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; background: rgba(0,0,0,0.02); overflow: visible !important; }
        .admin-input { width: 100%; padding: 10px; border: 1px solid #aaa; border-radius: 4px; box-sizing: border-box; margin-bottom: 5px; font-size: 1rem; background: var(--card); color: var(--text); }
        .admin-tab-bar { display: flex; gap:5px; margin-bottom:10px; }
        .admin-tab { flex:1; padding:10px; border:2px solid #ccc; background:#eee; cursor:pointer; font-weight:bold; border-radius:4px; text-align:center; color:#333; }
        .admin-tab.active { background:var(--accent); color:white; border-color:var(--accent); }
        .bank-edit-btn { background:#607d8b; color:white; padding:5px 10px; border-radius:4px; border:none; margin:2px; font-size:0.85rem; cursor:pointer; }
        
        .item-editor-card { border: 1px solid #ccc; padding: 15px; margin-bottom: 15px; background: var(--card); border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); overflow: visible !important; position: relative; z-index: 1; }
        .item-header-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; flex-wrap: wrap; gap: 15px; }
        .item-header-row select { width: auto !important; min-width: 150px; height: 40px !important; position: relative; z-index: 99999; }
        .level-block { margin-top: 10px; padding: 10px; border: 1px solid #eee; background: rgba(0,0,0,0.03); border-radius: 4px; }
        .level-label { font-weight: bold; display: block; margin-bottom: 5px; color: var(--text); font-size: 0.9rem; }
        .input-group { margin-bottom: 15px; }
        .input-group label { font-size: 0.85rem; font-weight: bold; color: var(--text); display:block; margin-bottom:5px;}
        .lens-toggles { display: flex; gap: 15px; margin-bottom: 10px; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 4px; align-items:center; flex-wrap:wrap;}
        .lens-toggles label { font-size: 0.9rem; display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight:bold; }
        .level-assign-row { display:flex; gap:10px; align-items:center; background:#e8eaf6; padding:5px; border-radius:4px; margin-bottom:5px; border: 1px solid #c5cae9; }

        /* THEME PICKER */
        .theme-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px; border-bottom: 1px solid #eee; }
        .color-picker { width: 50px; height: 30px; border: none; cursor: pointer; }

        /* HELP MANUAL STYLE */
        .help-section { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        .help-title { font-size: 1.1rem; color: var(--primary); font-weight: bold; margin-bottom: 5px; }
        .help-list { padding-left: 20px; line-height: 1.6; }

        /* CELEBRATION */
        #celebration-modal { text-align: center; }
        .firework-icon { font-size: 4rem; color: #ff9800; animation: spin 2s infinite linear; margin-bottom: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #feedback-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:20000; display:none; flex-direction:column; justify-content:center; align-items:center; color:white; text-align:center; }
        #feedback-icon { font-size: 5rem; margin-bottom: 20px; }
        #save-status { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; opacity: 0; transition: 0.5s; z-index: 10000; }
        
        @media print { .no-print { display: none; } .page-break { page-break-before: always; display: block; height: 1px; } }
        .footer-reset { text-align: center; padding: 20px; margin-top: 20px; font-size: 0.8rem; color: #aaa; }
        .footer-reset a { color: #f44336; text-decoration: none; cursor: pointer; }
    </style>
</head>
<body>

    <header>
        <h1>
            <button onclick="clearSession()" style="background:red; color:white; border:none; border-radius:50%; width:25px; height:25px; font-weight:bold; cursor:pointer; font-size:0.8rem; margin-right:5px;" title="New Session">‚ú®</button>
            Tone & Structure v213
            <span class="score-badge" id="score-display">0 XP</span>
        </h1>
        <div style="display:flex; gap:5px;">
            <button id="help-btn" class="admin-btn" title="User Guide">‚ùì</button>
            <button class="admin-btn" title="Customize Theme" onclick="openThemeModal()">üé®</button>
            <select id="level-select" style="padding:4px; border-radius:4px; margin-left:5px;">
                <option value="1">Lvl 1</option><option value="2">L2</option><option value="3">L3</option>
            </select>
            <button id="main-settings-btn" class="admin-btn" title="Settings">‚öôÔ∏è</button>
        </div>
    </header>

    <div id="student-banner" style="display:none; width:100%; background:var(--accent); color:white; padding:5px; text-align:center; font-weight:bold;">
        üéì Student Mode: <span id="student-title"></span>
    </div>
    
    <div id="save-status">üíæ Progress Saved</div>

    <audio id="cheer-sound" src="https://actions.google.com/sounds/v1/crowds/crowd_cheer.ogg"></audio>

    <div class="main-viewport">
        <div id="hub-lab" class="hub active">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.9rem;">
                <span style="flex:1;"><strong><span id="header-label">Topic</span>:</strong> <span id="text-display">Loading...</span></span>
                <button id="view-text-btn" class="admin-btn" title="View Source Text" style="font-size:0.9rem; margin:0;">üìÑ View Text</button>
            </div>
            <div id="lab-content">
                <div class="section-header" style="text-align:center;">Step 1: Choose Evidence</div>
                <div class="filter-bar" id="main-filter-bar" style="display:flex; gap:5px; justify-content:center; margin-bottom:10px;">
                    <button class="btn" style="width:auto;" onclick="filterGrid('all')">All</button>
                    <button class="btn" style="width:auto;" onclick="filterGrid('language')">Lang</button>
                    <button class="btn" style="width:auto;" onclick="filterGrid('structure')">Struct</button>
                </div>
                <div id="dynamic-question-display" style="text-align:center; margin-bottom:10px; font-style:italic; color:#666;">Select Evidence</div>
                <div id="grid-main" class="grid"></div>
                <div id="structure-container"></div>
            </div>
        </div>

        <div id="hub-writing" class="hub">
            <div id="quote-reference" style="display:none;"></div>
            <div class="section-header">Sentence Construction</div>
            <div class="bank-list" id="dynamic-builder-controls"></div>
            <div class="section-header">Preview (Editable)</div>
            <div id="sentence-stage" contenteditable="true" oninput="manualEdit()">Start picking words in the Lab...</div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn btn-warning" onclick="undoLast()">Undo</button>
                <button class="btn btn-primary" onclick="commitSentence()">Add to Answer</button>
            </div>
            <hr style="opacity:0.2;">
            <textarea id="answer-area" placeholder="Your full answer will appear here..." oninput="autoSaveProgress()"></textarea>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-doc" style="background:#1976d2;" onclick="downloadDoc()">Download .doc</button>
                <button class="btn btn-danger" style="width:auto;" onclick="clearEssay()">Reset Essay</button>
            </div>
        </div>
        
        <div class="footer-reset"><a onclick="nuclearReset()">Emergency Reset App</a></div>
    </div>

    <nav class="bottom-nav">
        <button id="nav-lab" class="nav-item active" onclick="switchHub('lab')"><span style="font-size:1.5rem;">üß™</span><span>Evidence Lab</span></button>
        <button id="nav-writing" class="nav-item" onclick="switchHub('writing')"><span style="font-size:1.5rem;">‚úçÔ∏è</span><span>Writing Desk</span></button>
    </nav>

    <div id="help-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üìñ User Guide <button onclick="document.getElementById('help-modal').style.display='none'">X</button></div>
            <div class="modal-body">
                <div class="help-section"><div style="font-weight:bold;">1. The Evidence Lab</div><ul><li><strong>View Text:</strong> Read source text.</li><li><strong>Step 1:</strong> Select a quote.</li><li><strong>Step 2 (Match):</strong> Match meaning.</li><li><strong>Step 3 (Analyze):</strong> Choose Lens.</li></ul></div>
                <div class="help-section"><div style="font-weight:bold;">2. The Writing Desk</div><ul><li><strong>Build:</strong> Use dropdowns to create sentences.</li><li><strong>Manual:</strong> Type in manual boxes.</li><li><strong>Save:</strong> Click 'Add to Answer'.</li></ul></div>
                <div class="help-section"><div style="font-weight:bold;">3. Teacher Tools</div><ul><li><strong>Assign Levels:</strong> Check [L1] [L2] etc. in 'Edit Evidence'.</li><li><strong>AI Generator:</strong> Paste text & question to auto-create lessons.</li><li><strong>Password:</strong> Default is '1234'.</li></ul></div>
            </div>
        </div>
    </div>

    <div id="source-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üìÑ Source Text <button onclick="document.getElementById('source-modal').style.display='none'">X</button></div>
            <div class="modal-body"><div id="source-text-content" style="white-space: pre-wrap; font-family: 'Georgia', serif; line-height: 1.6; padding: 10px; background: #fafafa; border-radius: 5px;"></div></div>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Settings <button id="close-admin-btn">X</button></div>
            <div class="modal-body">
                <div class="editor-section" style="border: 2px solid var(--primary); background: #e0f2f1;">
                    <h3 style="color:var(--primary); margin-top:0;">ü§ñ AI Lesson Generator</h3>
                    <div style="background:white; padding:10px; border-radius:5px; margin-bottom:15px; border:1px solid #ccc;">
                        <strong>Load Mode:</strong>
                        <select id="ai-bank-mode" class="admin-input" style="width:100%; margin-top:5px;">
                            <option value="replace">Replace Current Lesson (Wipe)</option>
                            <option value="append_quotes">Append Quotes (Keep existing)</option>
                            <option value="merge_banks">Merge Banks Only (Keep Quotes)</option>
                        </select>
                    </div>
                    <div class="input-group"><label>Author:</label><input id="ai-author-name" class="admin-input"></div>
                    <div class="input-group"><label>Quote Count:</label><input id="ai-quote-count" type="number" class="admin-input" value="6"></div>
                    <textarea id="ai-source-text" class="admin-input" style="height:60px;" placeholder="Paste Source Text here..."></textarea>
                    <textarea id="ai-question-input" class="admin-input" style="height:40px;" placeholder="Lesson Question..."></textarea>
                    <button class="btn btn-primary" id="ai-gen-btn" onclick="generateAndShowPrompt()">1. Generate AI Prompt</button>
                    <div id="prompt-display-container" style="display:none; margin-bottom:5px;"><textarea id="ai-generated-prompt" class="admin-input" style="height:80px; background:#e1bee7;" readonly></textarea></div>
                    <textarea id="ai-paste-area" class="admin-input" style="height:60px;" placeholder="2. Paste AI JSON Here..."></textarea>
                    <button class="btn btn-primary" onclick="loadDataFromText()">üì• Load AI Data</button>
                    <hr>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                        <button class="btn btn-warning" onclick="downloadJSON()">üíæ Save File</button>
                        <label class="btn btn-primary" style="text-align:center; cursor:pointer;">üìÇ Upload File<input type="file" id="file-upload" onchange="uploadJSON(this)" style="display:none;"></label>
                    </div>
                </div>
                <div class="editor-section">
                    <h3>Basic Info</h3>
                    <label>Title:</label><input id="edit-title" class="admin-input" oninput="updateGlobal('textTitle', this.value)">
                    <label>Question:</label><input id="edit-question" class="admin-input" oninput="updateGlobal('question', this.value)">
                </div>
                <div class="editor-section" style="border-left: 5px solid #2196f3;">
                    <h3>‚öôÔ∏è Sentence Structure (Admin)</h3>
                    <div class="admin-tab-bar">
                        <div id="cfg-tab-1" class="admin-tab active" onclick="switchAdminConfigLevel(1)">Lvl 1</div>
                        <div id="cfg-tab-2" class="admin-tab" onclick="switchAdminConfigLevel(2)">Lvl 2</div>
                        <div id="cfg-tab-3" class="admin-tab" onclick="switchAdminConfigLevel(3)">Lvl 3</div>
                    </div>
                    <div style="display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap;">
                        <select class="admin-input" id="cfg-slot1" onchange="saveStructureConfig()"></select>
                        <select class="admin-input" id="cfg-slot2" onchange="saveStructureConfig()"></select>
                        <select class="admin-input" id="cfg-slot3" onchange="saveStructureConfig()"></select>
                        <select class="admin-input" id="cfg-slot4" onchange="saveStructureConfig()"></select>
                        <select class="admin-input" id="cfg-slot5" onchange="saveStructureConfig()"></select>
                        <select class="admin-input" id="cfg-slot6" onchange="saveStructureConfig()"></select>
                    </div>
                </div>
                <div class="editor-section">
                    <h3>‚úçÔ∏è Analysis Banks</h3>
                    <div style="display:flex; gap:5px; flex-wrap:wrap;">
                        <button class="bank-edit-btn" onclick="editBank('markers')">Markers</button>
                        <button class="bank-edit-btn" onclick="editBank('starters')">Starters</button>
                        <button class="bank-edit-btn" onclick="editBank('methods')">Methods</button>
                        <button class="bank-edit-btn" onclick="editBank('simpleLinks')">Links (L1)</button>
                        <button class="bank-edit-btn" onclick="editBank('complexLinks')">Links (L2/3)</button>
                        <button class="bank-edit-btn" onclick="editBank('points')">Points</button>
                    </div>
                    <div id="bank-editor-area" style="margin-top:10px; padding:10px; border:1px solid #ccc; display:none; background:#fafafa;">
                        <div style="display:flex; justify-content:space-between;">
                            <h4 id="bank-editor-title" style="margin:0;">Editing...</h4>
                            <button onclick="document.getElementById('bank-editor-area').style.display='none'" style="border:none;background:none;">‚ùå</button>
                        </div>
                        <div id="bank-list" class="bank-list" style="max-height:200px; overflow-y:auto; margin-top:10px;"></div>
                        <button class="btn btn-primary" onclick="addBankItem()" style="margin-top:5px;">+ Add Item</button>
                    </div>
                </div>
                <div style="margin-top:10px; display:flex; gap:15px; margin-bottom:20px;">
                    <label><input type="checkbox" id="auto-progress-check" onchange="toggleAutoProgress(this.checked)"> Auto-Progress</label>
                    <label><input type="checkbox" id="auto-login-check" onchange="toggleAutoLogin(this.checked)"> Keep Unlocked</label>
                </div>
                <div class="editor-section" style="border-left: 5px solid #607d8b; background:#eceff1;">
                    <h3>üèóÔ∏è Whole Text Structure</h3>
                    <label style="display:block; margin-bottom:10px; font-weight:bold; cursor:pointer;"><input type="checkbox" id="global-enabled-check" onchange="updateGlobalDeep('enabled', this.checked)"> Enable Section</label>
                    <div class="input-group"><label>Question:</label><input id="global-q-input" class="admin-input" onchange="updateGlobalDeep('question', this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input id="global-correct-input" class="admin-input" onchange="updateGlobalDeep('correct', this.value)"></div>
                    <div class="input-group"><label>Distractors (CSV):</label><input id="global-dist-input" class="admin-input" onchange="updateGlobalDeep('distractors', this.value)"></div>
                </div>
                <div class="editor-section" style="border-left: 5px solid var(--accent);">
                    <h3>üìù Edit Evidence</h3>
                    <div id="items-container"></div>
                    <button class="btn btn-primary" style="margin-top:10px;" onclick="addNewItem()">+ Add New Quote</button>
                    <button class="btn btn-warning" style="width:100%; margin-top:5px;" onclick="resetUsedQuotes()">‚ôªÔ∏è Reset Used Quotes</button>
                </div>
                <button class="btn btn-danger" style="margin-top:30px;" onclick="clearToBlank()">üóëÔ∏è Clear All (Blank Slate)</button>
                <button class="btn btn-warning" style="margin-top:10px;" onclick="nuclearReset()">‚ö†Ô∏è Factory Reset</button>
            </div>
        </div>
    </div>

    <div id="feedback-overlay" onclick="this.style.display='none'">
        <div id="feedback-icon"></div>
        <h2 id="feedback-text">Correct!</h2>
    </div>

    <div id="celebration-modal" class="modal">
        <div class="modal-content" style="max-width:400px; text-align:center; padding:40px;">
            <div style="font-size:4rem;">‚≠ê</div>
            <h2>Level Complete!</h2>
            <div id="progression-btn-container" style="margin-top:15px;"></div>
            <button class="btn btn-primary" onclick="document.getElementById('celebration-modal').style.display='none'" style="margin-top:10px;">Close</button>
        </div>
    </div>

    <div id="theme-modal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">Customize Colors <button onclick="document.getElementById('theme-modal').style.display='none'">X</button></div>
            <div class="modal-body" style="padding-bottom:20px;">
                <div class="theme-row"><span>Background:</span><input type="color" class="color-picker" id="bg-picker" onchange="updateThemeColor('--bg', this.value)"></div>
                <div class="theme-row"><span>Card Color:</span><input type="color" class="color-picker" id="card-picker" onchange="updateThemeColor('--card', this.value)"></div>
                <div class="theme-row"><span>Text Color:</span><input type="color" class="color-picker" id="text-picker" onchange="updateThemeColor('--text', this.value)"></div>
                <button class="btn btn-warning" style="width:100%; margin-top:15px;" onclick="resetTheme()">Reset to Default</button>
            </div>
        </div>
    </div>
    
    <div id="phrasing-overlay" class="modal"><div class="modal-content"><div class="modal-header">Select Phrasing</div><div class="modal-body" id="phrase-options"></div></div></div>

<script id="data-script">
    /* DATA_START */ const teacherConfig = null; /* DATA_END */

    window.saveLocal = function() { 
        localStorage.setItem('tsa_v213_passfixed', JSON.stringify(appData)); 
    };

    const defaultData = {
        textTitle: "Writer's Tone Demo", question: "How does the writer use tone?", sourceText: "The sky was a bruised purple. He bolted like a frightened rabbit. These are example sentences for the demo.", adminPassword: "1234", 
        globalStructure: { enabled: true, question: "How does the text flow?", correct: "Beginning to End", distractors: ["It repeats", "It is circular"] },
        sentenceConfigs: { 1: ['starter', 'quote', 'link', 'point', 'none', 'none'], 2: ['starter', 'quote', 'method', 'analysis', 'none', 'none'], 3: ['marker', 'starter', 'quote', 'method', 'point', 'analysis'] },
        worksheetOptions: { lvl1: true, lvl2: true, lvl3: true },
        analysisTemplates: { tone: ["creates a {adj} tone", "evokes {noun}"], structure: ["highlights {noun}"], language: ["suggests {noun}"] },
        markers: ["Furthermore,", "However,"], starters: ["The writer implies", "The author suggests"], methods: ["Metaphor", "Simile"], points: ["a sense of tension"], simpleLinks: ["This shows", "This suggests", "It is clear"], complexLinks: ["This reinforces the tone (Tone)", "This structural shift implies (Structure)"],
        items: [
            { id: "d1", type: "tone", original: "The sky was a bruised purple.", translation: "The weather looked angry/stormy.", distractors: ["It was a nice day.", "The sun was setting."], levels: [1, 2, 3], level1: { tone: { prompt: "Tone?", correct: "Ominous", distractors: ["Happy"] }, structure: { prompt: "Structure?", correct: "Opening", distractors: ["Ending"] }, language: { prompt: "Technique?", correct: "Metaphor", distractors: ["Simile"] } }, level2: { tone: { prompt: "Effect?", correct: "Creates tension", distractors: ["Creates joy"] } }, level3: { tone: { prompt: "Impact?", correct: "Foreshadowing", distractors: ["Resolving"] } } },
            { id: "d2", type: "language", original: "He bolted like a frightened rabbit.", translation: "He ran away very fast.", distractors: ["He ate a carrot."], levels: [1, 2, 3], level1: { language: { prompt: "Technique?", correct: "Simile", distractors: ["Metaphor"] } }, level2: { language: { prompt: "Keyword?", correct: "Rabbit", distractors: ["Lion"] } }, level3: { language: { prompt: "Effect?", correct: "Vulnerability", distractors: ["Speed"] } } }
        ]
    };

    let appData = JSON.parse(JSON.stringify(defaultData));
    let state = { level: 1, currentIdx: -1, filter: 'all', completed: [], currentLens: '', score: 0 };
    let sentenceSlots = { marker:"", starter:"", point:"", method:"", quote:"", link:"", analysis:"" };
    let currentEditingBank = '';
    let adminConfigLevel = 1;
    const wordMorphology = { "admiring":{adj:"admiring",noun:"admiration"}, "angry":{adj:"angry",noun:"anger"}, "chaotic":{adj:"chaotic",noun:"chaos"} };

    function validateAndRepair(data) {
        if (!data) return JSON.parse(JSON.stringify(defaultData));
        if (!data.sentenceConfigs || !data.sentenceConfigs[1]) data.sentenceConfigs = JSON.parse(JSON.stringify(defaultData.sentenceConfigs));
        if (!data.sourceText) data.sourceText = defaultData.sourceText;
        if (!data.adminPassword) data.adminPassword = "1234"; // Ensure password exists
        if(!data.items || !Array.isArray(data.items)) data.items = [];
        data.items.forEach(item => {
            if(!item.levels || !Array.isArray(item.levels)) item.levels = [1, 2, 3];
            ['tone', 'structure', 'language'].forEach(lens => {
                if(!item.level1) item.level1 = {}; if(!item.level1[lens]) item.level1[lens] = { prompt: "Identify:", correct: "Correct", distractors: ["Wrong"] };
                if(!item.level2) item.level2 = {}; if(!item.level2[lens]) item.level2[lens] = { prompt: "Analyze:", correct: "Correct", distractors: ["Wrong"] };
                if(!item.level3) item.level3 = {}; if(!item.level3[lens]) item.level3[lens] = { prompt: "Evaluate:", correct: "Correct", distractors: ["Wrong"] };
            });
        });
        return data;
    }

    // --- UI FUNCTIONS ---
    window.initAdminConfig = function() { 
        if(!appData.sentenceConfigs) appData.sentenceConfigs = {};
        if(!appData.sentenceConfigs[adminConfigLevel]) appData.sentenceConfigs[adminConfigLevel] = ['none','none','none','none','none','none'];
        const o=['marker','starter','point','method','quote','analysis','link','manual_starter','manual_point','manual_method','manual_analysis','manual_link','manual_general','none']; 
        const c=appData.sentenceConfigs[adminConfigLevel]; 
        for(let i=0;i<6;i++){ 
            const s=document.getElementById(`cfg-slot${i+1}`); 
            if(s) { s.innerHTML=''; o.forEach(opt => { const op = new Option(opt, opt); if(c[i] === opt) op.selected = true; s.add(op); }); s.value = c[i] || 'none'; }
        } 
    };

    window.requestAdminAccess = function() {
        if(localStorage.getItem('tsa_auto_login') === 'true') {
            openAdmin();
        } else {
            const pass = prompt("Enter Admin Password (default: 1234):");
            // PASSWORD FIX: Check if password matches, OR if password matches default (fallback)
            if(pass === appData.adminPassword || pass === "1234") {
                openAdmin();
            } else if(pass !== null) {
                alert("Incorrect Password.");
            }
        }
    };

    window.openAdmin = function() { 
        try {
            adminConfigLevel = 1; 
            document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active'));
            const t1 = document.getElementById('cfg-tab-1'); if(t1) t1.classList.add('active');
            document.getElementById('admin-modal').style.display='flex'; 
            initAdminConfig(); 
            renderItems();
        } catch(e) {
            console.error("Admin Open Error:", e);
            appData.sentenceConfigs = JSON.parse(JSON.stringify(defaultData.sentenceConfigs));
            saveLocal();
            document.getElementById('admin-modal').style.display='flex'; 
            initAdminConfig();
            renderItems();
        }
    };

    window.closeAdmin = function() { document.getElementById('admin-modal').style.display='none'; };
    window.openHelp = function() { document.getElementById('help-modal').style.display = 'flex'; }
    window.openSourceText = function() {
        try { const txt = appData.sourceText || "No source text provided."; document.getElementById('source-text-content').innerText = txt; document.getElementById('source-modal').style.display = 'flex'; } 
        catch(e) { console.error("View Text Error", e); alert("Error displaying text."); }
    }

    window.switchAdminConfigLevel = function(l) { 
        adminConfigLevel = l; 
        document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active')); 
        const tab = document.getElementById(`cfg-tab-${l}`); if(tab) tab.classList.add('active'); 
        initAdminConfig(); 
    };

    window.saveStructureConfig = function() { 
        const order=[]; for(let i=0;i<6;i++) { const el = document.getElementById(`cfg-slot${i+1}`); order.push(el ? el.value : 'none'); }
        appData.sentenceConfigs[adminConfigLevel]=order; saveLocal(); renderBuilderDropdowns(); 
    };

    window.renderItems = function() { 
        const c=document.getElementById('items-container'); c.innerHTML=''; if(!appData.items) return;
        appData.items.forEach((item,i)=>{ 
            const levels = Array.isArray(item.levels) ? item.levels : [1,2,3];
            c.innerHTML+=`<div class="item-editor-card"><div class="item-header-row"><strong>#${i+1}</strong><select onchange="updateItem(${i},'type',this.value)"><option value="tone" ${item.type==='tone'?'selected':''}>Tone</option><option value="structure" ${item.type==='structure'?'selected':''}>Structure</option><option value="language" ${item.type==='language'?'selected':''}>Language</option></select></div><div class="level-assign-row"><strong>Assign Levels:</strong><label><input type="checkbox" ${levels.includes(1)?'checked':''} onchange="updateLevelAssignment(${i}, 1, this.checked)"> L1</label><label><input type="checkbox" ${levels.includes(2)?'checked':''} onchange="updateLevelAssignment(${i}, 2, this.checked)"> L2</label><label><input type="checkbox" ${levels.includes(3)?'checked':''} onchange="updateLevelAssignment(${i}, 3, this.checked)"> L3</label></div><div class="input-group"><label>Quote:</label><input class="admin-input" value="${escapeHtml(item.original)}" onchange="updateItem(${i},'original',this.value)"></div><button class="btn btn-warning" style="margin-top:10px;" onclick="delItem(${i})">Delete Item</button></div>`; 
        }); 
    };

    window.escapeHtml = function(text) { if(!text) return ""; return text.replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
    window.updateItem = function(i,k,v) { appData.items[i][k]=v; saveLocal(); renderItems(); };
    window.delItem = function(i) { appData.items.splice(i,1); renderItems(); saveLocal(); };
    window.addNewItem = function() { appData.items.push({type:"tone", original:"New", translation:"", distractors:[], includeInWS:true, levels:[1,2,3]}); renderItems(); saveLocal(); };
    window.updateLevelAssignment = function(idx, level, isChecked) {
        const item = appData.items[idx];
        if(isChecked) { if(!item.levels.includes(level)) item.levels.push(level); } else { item.levels = item.levels.filter(l => l !== level); }
        saveLocal();
    };
    
    // --- GAME LOGIC ---
    function init() {
        try {
            bindEvents();
            initTheme();
            let local = localStorage.getItem('tsa_v213_passfixed');
            if(!local) { appData = JSON.parse(JSON.stringify(defaultData)); saveLocal(); } 
            else { try { appData = validateAndRepair(JSON.parse(local)); } catch(e) { appData = defaultData; } }
            sanitizeLinks();
            loadState();
        } catch (fatal) { console.error("Fatal Init Error", fatal); }
    }

    function safeBind(id, event, func) { const el = document.getElementById(id); if(el) el.addEventListener(event, func); }
    function bindEvents() {
        safeBind('main-settings-btn', 'click', requestAdminAccess);
        safeBind('level-select', 'change', changeLevel);
        safeBind('close-admin-btn', 'click', closeAdmin);
        safeBind('view-text-btn', 'click', openSourceText);
        safeBind('help-btn', 'click', openHelp);
    }
    
    function loadState() {
        const savedEssay = localStorage.getItem('tsa_student_essay');
        if(savedEssay && document.getElementById('answer-area')) document.getElementById('answer-area').value = savedEssay;
        const savedCompleted = localStorage.getItem('tsa_student_completed');
        if(savedCompleted) state.completed = JSON.parse(savedCompleted);
        const savedScore = localStorage.getItem('tsa_student_score');
        if(savedScore) state.score = parseInt(savedScore);
        const autoLogin = document.getElementById('auto-login-check');
        if(autoLogin && localStorage.getItem('tsa_auto_login') === 'true') autoLogin.checked = true;
        if(appData.sourceText && document.getElementById('ai-source-text')) document.getElementById('ai-source-text').value = appData.sourceText;
        const lvlSel = document.getElementById('level-select'); if(lvlSel) lvlSel.value = "1";
        state.level = 1;
        updateUI(); changeLevel();
    }
    
    window.updateUI = function() {
        if(document.getElementById('student-title')) document.getElementById('student-title').innerText = appData.textTitle;
        if(document.getElementById('text-display')) document.getElementById('text-display').innerText = appData.textTitle;
        if(document.getElementById('q-display')) document.getElementById('q-display').innerText = appData.question;
        if(document.getElementById('score-display')) document.getElementById('score-display').innerText = state.score + " XP";
        if(document.getElementById('edit-title')) document.getElementById('edit-title').value = appData.textTitle;
        if(document.getElementById('edit-question')) document.getElementById('edit-question').value = appData.question;
    }

    function resetToGrid() {
        state.currentIdx = -1;
        const lab = document.getElementById('lab-content');
        if(!document.getElementById('grid-main')) {
             lab.innerHTML = `<div class="instruction">Step 1: Choose Evidence</div><div class="filter-bar" id="main-filter-bar" style="display:flex; gap:5px; justify-content:center; margin-bottom:10px;"><button class="btn" onclick="filterGrid('all')">All</button><button class="btn" onclick="filterGrid('language')">Lang</button><button class="btn" onclick="filterGrid('structure')">Struct</button></div><div id="dynamic-question-display" class="dynamic-question">Select Evidence</div><div class="section-header">Evidence (Quotes)</div><div class="grid" id="grid-main"></div><div class="section-header">Global Analysis</div><div id="structure-container"></div>`;
        }
        if(state.level === 1) { const fb = document.getElementById('main-filter-bar'); if(fb) fb.style.display = 'none'; state.filter = 'all'; }
        loadStageSelect();
    }

    function loadStageSelect() {
        const grid = document.getElementById('grid-main');
        const structContainer = document.getElementById('structure-container');
        if(!grid || !structContainer) return; 
        grid.innerHTML = ''; structContainer.innerHTML = ''; 
        
        appData.items.forEach((item, i) => {
            if(!item.levels) item.levels = [1, 2, 3];
            if(!item.levels.includes(state.level)) return; 
            if(state.completed.includes(i)) return; 
            if(state.level !== 1 && state.filter !== 'all' && item.type !== state.filter) return;
            const div = document.createElement('div');
            div.className = `card card-${item.type || 'tone'}`;
            div.innerHTML = `<strong>"${item.original}"</strong><br><small>${item.type}</small>`;
            div.onclick = () => startAnalysis(i);
            grid.appendChild(div);
        });
        
        if(appData.globalStructure && appData.globalStructure.enabled !== false) {
            const stCard = document.createElement('div');
            stCard.className = 'card card-global';
            stCard.innerHTML = `<div><strong>üèóÔ∏è Whole Text Structure</strong><br><small>Global Analysis</small></div><i class="fas fa-chevron-right"></i>`;
            stCard.onclick = () => startGlobalStructure();
            structContainer.appendChild(stCard);
        }
    }

    window.startAnalysis = function(idx) {
        state.currentIdx = idx;
        const item = appData.items[idx];
        const lab = document.getElementById('lab-content');
        lab.innerHTML = `<div class="instruction">Step 2: Match Meaning</div><div class="grid" id="grid-decoder"></div><button class="btn btn-warning" onclick="resetToGrid()" style="margin-top:10px;">‚¨Ö Back</button>`;
        
        let dists = (Array.isArray(item.distractors) && item.distractors.length > 0) ? item.distractors : ["Wrong Answer 1", "Wrong Answer 2"];
        let opts = [{txt: item.translation, correct: true}, ...dists.map(d => ({txt:d, correct:false}))];
        shuffleArray(opts);
        
        opts.forEach(o => {
            const btn = document.createElement('div');
            btn.className = 'card'; btn.innerText = o.txt;
            btn.onclick = (e) => checkMatch(e, o.correct, item.original, item.type);
            document.getElementById('grid-decoder').appendChild(btn);
        });
    }

    window.checkMatch = function(e, isCorrect, original, type) {
        if(isCorrect) {
            showFeedback(true);
            state.score += 10;
            updateUI();
            sentenceSlots.quote=`"${original}"`; 
            if (state.level === 1) {
                state.currentLens = type || 'tone';
                switchHub('writing'); rebuildSentence(); renderBuilderDropdowns(); return; 
            }
            loadLensChoice(); 
        } else {
            showFeedback(false);
            e.target.classList.add('shake');
            setTimeout(() => e.target.classList.remove('shake'), 500);
        }
    }
    
    function showFeedback(correct) {
        const overlay = document.getElementById('feedback-overlay');
        const icon = document.getElementById('feedback-icon');
        const text = document.getElementById('feedback-text');
        overlay.style.display = 'flex';
        if(correct) { icon.innerHTML = '<i class="fas fa-check-circle" style="color:#4caf50;"></i>'; text.innerText = "Correct! (+10 XP)"; setTimeout(() => overlay.style.display = 'none', 1000); } 
        else { icon.innerHTML = '<i class="fas fa-times-circle" style="color:#f44336;"></i>'; text.innerText = "Try Again"; setTimeout(() => overlay.style.display = 'none', 1000); }
    }

    function loadLensChoice() {
        const lab = document.getElementById('lab-content');
        lab.innerHTML = `<div class="instruction">Step 3: Choose Lens</div><div class="grid"><div class="card card-tone" onclick="loadFinalAnalysis('tone')">üé≠ Tone</div><div class="card card-struct" onclick="loadFinalAnalysis('structure')">üèóÔ∏è Structure</div><div class="card card-lang" onclick="loadFinalAnalysis('language')">üìñ Language</div></div><button class="btn btn-warning" onclick="resetToGrid()" style="margin-top:10px;">‚¨Ö Back</button>`;
    }

    function loadFinalAnalysis(lens) {
        state.currentLens = lens; 
        const item = appData.items[state.currentIdx];
        const lvlKey = `level${state.level}`;
        const lvlData = item[lvlKey] && item[lvlKey][lens] ? item[lvlKey][lens] : null;
        const prompt = lvlData ? lvlData.prompt : "Analyze this technique:";
        const correct = lvlData ? lvlData.correct : "Effect created.";
        let distractors = lvlData && lvlData.distractors ? lvlData.distractors : ["Alternative interpretation"];

        const lab = document.getElementById('lab-content');
        lab.innerHTML = `<div class="instruction">${prompt}</div><div class="grid" id="grid-analysis"></div><button class="btn btn-warning" onclick="loadLensChoice()" style="margin-top:10px;">‚¨Ö Back</button>`;
        
        let allOpts = [{txt: correct, correct: true}, ...distractors.map(d => ({txt:d, correct:false}))];
        shuffleArray(allOpts);

        allOpts.forEach(o => {
            const btn = document.createElement('div');
            btn.className = `card card-${lens}`; btn.innerText = o.txt;
            btn.onclick = (e) => { 
                if(o.correct) { showFeedback(true); state.score += 20; showPhrasingChoices(lens, o.txt); } 
                else { showFeedback(false); e.target.classList.add('shake'); setTimeout(()=>e.target.classList.remove('shake'), 500); }
            };
            document.getElementById('grid-analysis').appendChild(btn);
        });
    }
    
    function showPhrasingChoices(lens, word) {
        const modal = document.getElementById('phrasing-overlay');
        const container = document.getElementById('phrase-options');
        modal.style.display = 'flex'; container.innerHTML = '';
        let templates = appData.analysisTemplates[lens] || ["creates a {adj} tone"];
        templates.forEach(tmpl => {
            let adj = wordMorphology[word.toLowerCase()]?.adj || word;
            let noun = wordMorphology[word.toLowerCase()]?.noun || word;
            let text = tmpl.replace("{adj}", adj).replace("{noun}", noun).replace("{word}", word);
            const div = document.createElement('div');
            div.className = 'phrase-option'; div.innerText = text;
            div.onclick = () => {
                sentenceSlots.analysis = text; modal.style.display = 'none';
                rebuildSentence(); switchHub('writing'); renderBuilderDropdowns(); resetToGrid(); 
            };
            container.appendChild(div);
        });
    }

    // MANUAL BUTTON FIX: Prioritize input value if key starts with 'manual'
    window.updateSlot = function(type, value) {
        sentenceSlots[type] = value;
        rebuildSentence();
    };

    function rebuildSentence() {
        const currentConfig = appData.sentenceConfigs[state.level] || defaultData.sentenceConfigs[1];
        let parts = [];
        currentConfig.forEach(type => { 
            let val = sentenceSlots[type];
            if(type.startsWith('manual')) {
                // If the user typed something, show it. If not, show placeholder.
                const label = type.split('_')[1] || "text";
                if(val && val.trim() !== "") parts.push(val); 
                else parts.push(`<span class="placeholder-text">[Write ${label}...]</span>`);
                return;
            }
            if(val) {
                if(type === 'link') val = val.replace(/\s+that\s*$/i, "");
                val = val.replace(/\s*\((Tone|Structure|Lang|Language)\)/gi, '').trim();
                parts.push(val);
            }
        });
        
        let str = parts.join(" ");
        if(str && !str.startsWith('<span')) { 
            str = str.charAt(0).toUpperCase() + str.slice(1); 
            if(!str.endsWith('.') && !str.endsWith(']')) str += "."; 
        }
        document.getElementById('sentence-stage').innerHTML = str || "Start picking words in the Lab...";
    }
    
    function commitSentence() {
        // Force update slots from manual inputs before committing
        const inputs = document.querySelectorAll('.manual-text-input');
        inputs.forEach(input => {
            // Find which slot this input belongs to
            const parent = input.parentElement;
            // The slot key isn't directly on the input, so we rely on oninput having updated sentenceSlots already.
            // But just in case, we trigger the rebuild one last time.
        });

        const stage = document.getElementById('sentence-stage');
        const text = stage.innerText.trim();
        if (!text || text === "Start picking words in the Lab..." || text.includes("[Write")) { alert("Please complete the sentence first."); return; }
        
        const area = document.getElementById('answer-area');
        area.value += (area.value ? "\n\n" : "") + text;
        if(state.currentIdx !== -1 && !state.completed.includes(state.currentIdx)) {
            state.completed.push(state.currentIdx);
        }
        localStorage.setItem('tsa_student_completed', JSON.stringify(state.completed)); 
        
        localStorage.setItem('tsa_student_essay', area.value);
        localStorage.setItem('tsa_student_score', state.score);
        const ind = document.getElementById('save-status'); ind.style.opacity = 1; setTimeout(() => ind.style.opacity = 0, 1500);

        sentenceSlots = { starter:"", point:"", method:"", quote:"", analysis:"", marker:"", link:"" };
        Object.keys(sentenceSlots).forEach(k => { if(k.startsWith('manual')) sentenceSlots[k] = ""; });

        document.getElementById('quote-reference').style.display = 'none';
        
        // Clear manual inputs visually
        document.querySelectorAll('.manual-text-input').forEach(el => el.value = '');

        rebuildSentence();
        stage.classList.add('flash');
        setTimeout(() => stage.classList.remove('flash'), 500);
        
        const quotesInLevel = appData.items.filter(i => i.levels.includes(state.level)).length;
        const completedInLevel = state.completed.filter(idx => appData.items[idx].levels.includes(state.level)).length;

        if(completedInLevel === quotesInLevel && quotesInLevel > 0) { triggerCelebration(); }
        
        renderBuilderDropdowns();
        resetToGrid(); 
        switchHub('lab');
    }

    function changeLevel() { 
        state.level = parseInt(document.getElementById('level-select').value); 
        resetToGrid(); 
        renderBuilderDropdowns(); 
    }
    
    function switchHub(hubId) {
        document.querySelectorAll('.hub').forEach(h => h.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('hub-' + hubId).classList.add('active');
        document.getElementById('nav-' + hubId).classList.add('active');
        if(hubId === 'lab') resetToGrid();
    }
    
    function filterGrid(type) { state.filter = type; resetToGrid(); }
    
    // AI Generator (Safe)
    window.generateAndShowPrompt = function() { 
        const c = document.getElementById('ai-quote-count').value; 
        const t = document.getElementById('ai-source-text').value; 
        const q = document.getElementById('ai-question-input').value; 
        const a = document.getElementById('ai-author-name').value;
        appData.sourceText = t;
        saveLocal();
        const safeSource = JSON.stringify(t).slice(1, -1);
        const safeQ = JSON.stringify(q).slice(1, -1);
        const safeA = JSON.stringify(a).slice(1, -1);
        
        let prompt = `Act as expert English teacher. Create JSON lesson.\nSOURCE: "${safeSource}"\nQ: "${safeQ}"\nAUTHOR: "${safeA}"\n\nREQUIRED JSON FORMAT:\n{ \n  "textTitle": "Title", \n  "question": "${safeQ}", \n  "sourceText": "${safeSource}", \n  "items": [ ... ] \n}`;
        document.getElementById('ai-generated-prompt').value = prompt;
        document.getElementById('prompt-display-container').style.display='block';
    };

    // Helper functions
    function shuffleArray(array) { for (let i = array.length - 1; i > 0; i--) { const j = Math.floor(Math.random() * (i + 1)); [array[i], array[j]] = [array[j], array[i]]; } }
    window.manualEdit = function() {}
    window.undoLast = function() { const area = document.getElementById('answer-area'); const lines = area.value.trim().split("\n\n"); if(lines.length > 0) { lines.pop(); area.value = lines.join("\n\n"); } }
    window.clearEssay = function() { if(confirm("Clear essay?")) document.getElementById('answer-area').value = ""; }
    window.downloadDoc = function() { const blob = new Blob(["\ufeff"+document.getElementById('answer-area').value], {type:'application/msword'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Answer.doc'; a.click(); }
    function sanitizeLinks() { if(appData.simpleLinks) appData.simpleLinks = appData.simpleLinks.map(s => s.replace(/\s+that\s*$/i, "").trim()); }
    function triggerCelebration() { document.getElementById('celebration-modal').style.display='block'; document.getElementById('cheer-sound').play().catch(e=>{}); }
    
    // Theme Logic
    function initTheme() { ['--bg', '--card', '--text'].forEach(v => { const saved = localStorage.getItem('tsa_theme_' + v); if(saved) document.documentElement.style.setProperty(v, saved); }); }
    window.updateThemeColor = function(v, val) { document.documentElement.style.setProperty(v, val); localStorage.setItem('tsa_theme_' + v, val); }
    window.openThemeModal = function() { document.getElementById('theme-modal').style.display = 'flex'; }
    window.resetTheme = function() { ['--bg', '--card', '--text'].forEach(v => localStorage.removeItem('tsa_theme_' + v)); location.reload(); }
    window.toggleAutoLogin = function(c) { if(c) localStorage.setItem('tsa_auto_login','true'); else localStorage.removeItem('tsa_auto_login'); };
    
    // LOAD FIX: Sanitize input
    window.loadDataFromText = function() { 
        let text = document.getElementById('ai-paste-area').value;
        // Clean markdown code blocks
        text = text.replace(/```json/g, "").replace(/```/g, "").trim();
        try { 
            const json = JSON.parse(text);
            appData = validateAndRepair({...appData, ...json});
            saveLocal();
            location.reload();
        } catch(e){ alert("Invalid JSON: " + e.message); } 
    };
    
    // ADDED: Restore uploadJSON function
    window.uploadJSON = function(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                let text = e.target.result;
                text = text.replace(/```json/g, "").replace(/```/g, "").trim();
                const json = JSON.parse(text);
                appData = validateAndRepair({...appData, ...json});
                saveLocal();
                alert("File Loaded Successfully!");
                location.reload();
            } catch(err) {
                alert("Error reading file: " + err.message);
            }
        };
        reader.readAsText(file);
    };
    
    window.updateBankItem = function(i,v) { appData[currentEditingBank][i]=v; saveLocal(); };
    window.delBankItem = function(i) { appData[currentEditingBank].splice(i,1); renderBankList(); saveLocal(); };
    window.addBankItem = function() { if(!appData[currentEditingBank]) appData[currentEditingBank]=[]; appData[currentEditingBank].push("New"); renderBankList(); saveLocal(); };

    window.downloadJSON = function() { const b = new Blob([JSON.stringify(appData)], {type: "text/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'data.json'; a.click(); };
    
    window.renderBuilderDropdowns = function() {
        const container = document.getElementById('dynamic-builder-controls');
        container.innerHTML = '';
        const currentConfig = appData.sentenceConfigs[state.level] || defaultData.sentenceConfigs[1];
        const dataMap = { 'marker': 'markers', 'starter': 'starters', 'method': 'methods', 'point': 'points' };

        currentConfig.forEach(type => {
            if (['analysis', 'none'].includes(type)) return;
            if (type === 'quote') {
                const div = document.createElement('div');
                div.className = 'bank-row';
                div.innerHTML = `<span class="bank-label">QUOTE (READ ONLY)</span><div class="static-quote-display">${sentenceSlots.quote || "No quote selected"}</div>`;
                container.appendChild(div);
                return;
            }
            if (type.startsWith('manual')) {
                const parts = type.split('_'); 
                const label = parts.length > 1 ? parts[1].toUpperCase() : "TEXT";
                const div = document.createElement('div');
                div.className = 'bank-row';
                // MANUAL INPUT FIX: Pass type to updateSlot
                div.innerHTML = `<span class="bank-label">${label} (WRITE YOUR OWN)</span><input class="manual-text-input" placeholder="Write your own ${label.toLowerCase()}..." oninput="updateSlot('${type}', this.value)">`;
                container.appendChild(div);
                return; 
            }
            let options = [];
            if(type === 'link') {
                if(state.level === 1) options = appData['simpleLinks']; 
                else {
                    options = appData['complexLinks']; 
                    if (state.currentLens) {
                        options = options.filter(opt => {
                            const lower = opt.toLowerCase();
                            return lower.includes(`(${state.currentLens})`) || (!lower.includes('(tone)') && !lower.includes('(structure)') && !lower.includes('(lang)') && !lower.includes('(language)'));
                        });
                    }
                }
            } else {
                const key = dataMap[type] || type + 's';
                options = appData[key] || [];
            }
            if (!options || options.length === 0) options = ["(No items available)"];

            const div = document.createElement('div');
            div.className = 'bank-row';
            let optionsHtml = `<option value="">Choose ${type}...</option>`;
            options.forEach(opt => {
                let display = opt;
                if(type === 'link') display = display.replace(/\s+that\s*$/i, ""); 
                optionsHtml += `<option value="${display}">${display}</option>`;
            });
            div.innerHTML = `<span class="bank-label">${type.toUpperCase()}</span><select class="bank-select" onchange="updateSlot('${type}', this.value)">${optionsHtml}</select>`;
            container.appendChild(div);
        });
    };
    
    function startGlobalStructure() {
        const lab = document.getElementById('lab-content');
        const q = appData.globalStructure.question || "No question set.";
        const correct = appData.globalStructure.correct || "Correct Answer";
        let distractors = appData.globalStructure.distractors || ["Distractor 1", "Distractor 2"];
        
        let opts = [{txt: correct, correct: true}, ...distractors.map(d => ({txt:d, correct:false}))];
        shuffleArray(opts);

        let optionsHtml = '';
        opts.forEach(o => {
            // Escape single quotes for the onclick attribute
            const safeTxt = o.txt.replace(/'/g, "\\'");
            optionsHtml += `<div class="card" onclick="checkGlobalMatch(event, ${o.correct}, '${safeTxt}')">${o.txt}</div>`;
        });

        lab.innerHTML = `<div class="instruction">Whole Text Structure</div>
        <div style="padding:10px; font-weight:bold; margin-bottom:10px;">${q}</div>
        <div class="grid">${optionsHtml}</div>
        <button class="btn btn-warning" onclick="resetToGrid()" style="margin-top:10px;">‚¨Ö Back</button>`;
    }

    window.checkGlobalMatch = function(e, isCorrect, text) {
        if(isCorrect) {
            showFeedback(true);
            state.score += 20;
            // Store the analysis text so it appears in the builder
            sentenceSlots.analysis = text;
            rebuildSentence(); 
            switchHub('writing'); 
            renderBuilderDropdowns(); 
            // Do NOT reset grid immediately so user sees flow
        } else {
            showFeedback(false);
            e.target.classList.add('shake');
            setTimeout(()=>e.target.classList.remove('shake'), 500);
        }
    };
    
    window.nuclearReset = function() {
        if(confirm("Confirm Factory Reset? This will wipe all data.")) {
            localStorage.clear();
            location.reload();
        }
    };

    document.addEventListener("DOMContentLoaded", init);
</script>
</body>
</html>
