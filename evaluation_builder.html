<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluation Architect</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS STYLES --- */
        :root {
            --col-1-pink: #ff99cc; --col-2-yellow: #ffeb3b; --col-3-blue: #85c1e9; --col-4-green: #90ee90;
            --app-color: #2c3e50; --accent-color: #e74c3c;
            --level-1: #3498db; --level-2: #2ecc71; --level-3: #9b59b6;
        }
        body { 
            font-family: 'Aptos', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f4f6f7; 
            color: #333; 
            margin: 0; 
            padding: 20px; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            text-align: center;
        }
        /* HEADER */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 5px; 
            padding-bottom: 5px; 
            border-bottom: 2px solid #e0e0e0; 
            flex-shrink: 0;
            min-height: 40px;
            background-color: #f4f6f7;
            position: relative;
            z-index: 50; 
        }
        h1 { margin: 0; color: var(--app-color); font-size: 1.4rem; }
        
        #score-board { background: var(--app-color); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; display: flex; gap: 15px; align-items: center; }
        .level-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; text-transform: uppercase; color: white; }
        
        /* FLOATING ADMIN BTN */
        .admin-btn { 
            position: fixed; 
            top: 15px; 
            right: 15px; 
            font-size: 1.8rem; 
            color: #555; 
            background: white;
            border: 3px solid #e74c3c; 
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer; 
            z-index: 2147483647 !important; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.3);
            transition: all 0.2s;
            pointer-events: auto !important; 
        }
        .admin-btn:hover { transform: scale(1.1); background: #fdfdfd; }
        
        .reset-btn { background: #c0392b; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 70px; }

        .container { 
            flex-grow: 1; 
            max-width: 1000px; 
            width: 100%;
            margin: 0 auto; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.08); 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; 
            position: relative;
            z-index: 1;
        }
        
        .progress-track { background: #eee; height: 8px; border-radius: 4px; margin-bottom: 20px; overflow: hidden; flex-shrink: 0; }
        .progress-fill { height: 100%; width: 0%; background: var(--app-color); transition: width 0.4s ease; }
        
        .stage-area { display: none; animation: fadeIn 0.4s; flex-grow: 1; text-align: center; }
        .stage-area.active { display: block; }
        
        h2.stage-title { font-size: 1.4rem; margin-bottom: 5px; color: #444; }
        p.stage-subtitle { color: #777; margin-bottom: 10px; font-style: italic; }
        
        /* TOPIC DISPLAY - VISIBLE */
        #topic-display { 
            background: #3498db; 
            color: white; 
            padding: 15px; 
            border-radius: 8px; 
            margin-bottom: 10px; 
            font-weight: bold; 
            font-size: 1.2rem; 
            text-align: center; 
            flex-shrink: 0; 
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        #current-task-info {
            font-size: 0.9rem; color: #7f8c8d; margin-bottom: 10px; font-weight: bold;
        }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
        
        button.choice-btn { padding: 20px; border: 2px solid transparent; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.2s; color: #333; opacity: 0.9; }
        button.choice-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); opacity: 1; }
        button.choice-btn.selected { border: 4px solid #333; transform: scale(1.05); opacity: 1; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        button.choice-btn.completed { background: #d5f5e3; border-color: #2ecc71; color: #27ae60; opacity: 0.8; }
        
        .btn-s1 { background: var(--col-1-pink); } .btn-s2 { background: var(--col-2-yellow); } .btn-s3 { background: var(--col-3-blue); } .btn-s4 { background: var(--col-4-green); } .btn-white { background: white; border-color: #ddd; }
        
        #confirm-bar { margin-top:20px; padding-top:15px; border-top:1px solid #eee; display:none; }
        #confirm-btn { background: #27ae60; color: white; padding: 12px 30px; font-size: 1.1rem; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s; margin-left: 10px;}
        #back-btn { background: #95a5a6; color: white; padding: 12px 30px; font-size: 1.1rem; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s; }
        button:hover { transform: scale(1.05); }

        #typing-interface { display: none; flex-direction: column; align-items: center; width: 100%; }
        #typing-input { width: 80%; padding: 15px; font-size: 1.1rem; border: 2px solid #ccc; border-radius: 8px; margin-bottom: 15px; font-family: inherit; resize: vertical; min-height: 80px; }
        #typing-submit { padding: 12px 30px; font-size: 1.1rem; background: var(--app-color); color: white; border: none; border-radius: 6px; cursor: pointer; }
        
        #sentence-builder { margin-top: 20px; padding: 15px; background: #f8f9fa; border: 2px dashed #ccc; border-radius: 8px; min-height: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-wrap: wrap; gap: 5px; flex-shrink: 0; }
        .fragment { padding: 2px 5px; border-radius: 4px; }
        
        /* NEW ESSAY DISPLAY */
        #essay-display {
            display: none;
            margin-top: 20px;
            padding: 20px;
            background: #fff;
            border: 1px solid #ddd;
            border-left: 5px solid #f1c40f;
            border-radius: 8px;
            text-align: left;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            font-family: 'Aptos', 'Segoe UI', sans-serif;
            line-height: 1.6;
            max-height: 200px;
            overflow-y: auto;
            position: relative;
        }
        #essay-display h3 { margin-top: 0; font-size: 1rem; color: #7f8c8d; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 10px; }
        #essay-content { font-size: 1.1rem; color: #2c3e50; white-space: pre-wrap; }
        #clear-essay-btn {
            position: absolute; top: 15px; right: 15px; background: #e74c3c; color: white; border: none; border-radius: 3px; cursor: pointer; font-size: 0.8rem; padding: 5px 10px;
        }

        /* OVERLAYS */
        #overlay, #levelup-overlay, #win-overlay, #admin-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; justify-content: center; align-items: center; text-align: center; color: white; }
        #overlay { background: rgba(231, 76, 60, 0.95); } 
        #levelup-overlay { background: rgba(46, 204, 113, 0.98); }
        #admin-modal { background: rgba(0,0,0,0.5); z-index: 2147483646; color: #333; } 
        
        /* NEW REWARD SCREEN */
        #win-overlay { 
            background: rgba(0,0,0,0.85); 
            z-index: 3000;
        }
        .win-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            max-width: 500px;
            width: 90%;
            position: relative;
            z-index: 3002;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }
        .trophy-anim {
            font-size: 6rem;
            margin-bottom: 10px;
            animation: float 2s ease-in-out infinite;
            display: inline-block;
        }
        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-10px) rotate(5deg); }
            100% { transform: translateY(0px) rotate(0deg); }
        }
        #confetti-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 3001;
        }
        .win-title {
            color: #f1c40f;
            font-size: 2.5rem;
            margin: 0;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.1);
        }
        .win-btn {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            border: none;
            padding: 15px 40px;
            font-size: 1.3rem;
            border-radius: 50px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.4);
            transition: transform 0.2s;
        }
        .win-btn:hover { transform: scale(1.05); }

        .shake { animation: shake 0.4s; }
        
        .admin-panel { background: white; width: 95%; max-width: 1200px; height: 95%; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: left; }
        .panel-header { padding: 15px; background: #eee; display: flex; justify-content: space-between; font-weight: bold; }
        .panel-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .section-box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .section-title { font-weight: bold; margin-bottom: 10px; display: block; color: var(--app-color); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .admin-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; }
        .admin-textarea { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; height: 60px; resize: vertical; }
        .del-btn { background: #ffdddd; border: 1px solid #ffaaaa; color: red; cursor: pointer; padding: 5px 10px; border-radius: 4px; white-space: nowrap; }
        .toggle-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; background: #eef; padding: 10px; border-radius: 5px; }
        .content-card { background: #fdfdfd; border: 1px solid #ddd; border-left: 5px solid #333; padding: 15px; margin-bottom: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .content-card-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; color: #333; border-bottom:1px solid #eee; padding-bottom:5px; align-items:center;}
        .step-label { font-size: 0.8rem; font-weight: bold; color: #666; display: block; margin-bottom: 3px; }
        .step-sublabel { font-size: 0.75rem; color: #999; font-weight: normal; margin-left: 5px; font-style: italic; }
        .step-1 { border-left: 4px solid var(--col-1-pink); padding-left: 10px; margin-bottom: 10px; }
        .step-2 { border-left: 4px solid var(--col-2-yellow); padding-left: 10px; margin-bottom: 10px; }
        .step-3 { border-left: 4px solid #333; padding-left: 10px; margin-bottom: 10px; }
        .step-4 { border-left: 4px solid var(--col-3-blue); padding-left: 10px; margin-bottom: 10px; }
        .step-5 { border-left: 4px solid var(--col-4-green); padding-left: 10px; margin-bottom: 10px; }
        
        .mode-select { 
            font-size:0.75rem; background:#fff; padding:3px; border-radius:3px; border:1px solid #ccc; margin-right:5px; width: 140px;
        }

        .scaffold-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-bottom:8px; border-bottom:1px solid #eee; }
        .scaffold-select { padding: 5px; border-radius: 4px; border: 1px solid #ccc; }
        
        .duplicate-error { border: 2px solid red !important; background-color: #ffeeee; }
        .source-hint { font-size: 0.75rem; color: #999; margin-left: 5px; font-style: italic; }

        #config-io-area { width: 100%; height: 100px; font-family: monospace; font-size: 0.8rem; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; color: #555; display:block; margin-bottom:10px; }
        #worksheet-area { display: none; }
        
        #emergency-reset {
            position: fixed; bottom: 5px; right: 5px;
            font-size: 10px; color: #ccc; cursor: pointer;
            z-index: 999999;
        }
        #emergency-reset:hover { color: red; }
        
        /* FOOTER LINK REMOVED FOR SECURITY */

        .data-manager { background: #e8f6f3; border: 2px solid #1abc9c; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .data-btn { background: #16a085; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; margin-right: 10px; font-weight: bold; }
        .data-btn:hover { background: #1abc9c; }
        
        .banks-container { display:flex; gap:20px; }
        .bank-column { flex: 1; border:1px solid #ccc; padding:10px; border-radius:5px; background:#f9f9f9; }
        .bank-column.active-bank { border:2px solid #2ecc71; background:#eaffea; }
        .bank-header { font-weight:bold; margin-bottom:10px; text-transform:uppercase; font-size:0.9rem; color:#555; border-bottom:1px solid #ddd; padding-bottom:5px;}
        
        .bulk-btn { font-size: 0.75rem; padding: 2px 8px; border-radius: 4px; background: #9b59b6; color: white; border: none; cursor: pointer; margin-left: 10px; }
        .bulk-btn:hover { background: #8e44ad; }

        /* CSS FIREWORKS */
        @keyframes firework {
            0% { transform: translate(var(--x), var(--initialY)); width: var(--initialSize); opacity: 1; }
            50% { width: 0.5rem; opacity: 1; }
            100% { width: var(--finalSize); opacity: 0; }
        }
        .firework, .firework::before, .firework::after {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 0.5rem; aspect-ratio: 1; background: radial-gradient(circle, #ff0 0.2rem, #0000 0) 50% 0% / 120% 120%, no-repeat;
            animation: firework 2s infinite; pointer-events: none;
        }
        .firework::before { transform: translate(-50%, -50%) rotate(25deg) !important; }
        .firework::after { transform: translate(-50%, -50%) rotate(-37deg) !important; }
    </style>
</head>
<body>

    <button class="admin-btn" id="cog-btn" onclick="openAdmin()" title="Settings (Press ESC)"><i class="fas fa-cog"></i></button>

    <header>
        <h1 id="app-title-display">Evaluation Architect</h1>
        <div style="display:flex; gap:15px; align-items:center;">
            <div id="score-board">
                <span id="level-badge" class="level-badge" style="background:var(--level-1)">LEVEL 1</span>
                <span>Streak: <span id="streak-val">0</span>/<span id="target-val">3</span></span>
                <span style="border-left:1px solid #ccc; padding-left:15px;">Score: <span id="score-val" style="font-size:1.2rem; color:#f1c40f;">0</span></span>
            </div>
            <button onclick="forceReset()" class="reset-btn">‚ö† RESET</button>
        </div>
    </header>

    <div class="container" id="game-container">
        <div id="topic-display">Question: How is the text presented?</div>
        
        <div class="progress-track"><div class="progress-fill" id="progress-bar"></div></div>
        
        <div id="stage-area" class="stage-area">
            <div id="current-task-info"></div>
            
            <h2 id="stage-title" class="stage-title">Select Evidence</h2>
            <p id="stage-subtitle" class="stage-subtitle">Instruction goes here</p>
            <div class="grid" id="game-grid"></div>
            <div id="confirm-bar">
                <button id="back-btn" onclick="goBack()">Back</button>
                <button id="confirm-btn" onclick="confirmChoice()">Confirm</button>
            </div>
        </div>
        
        <div id="typing-interface">
            <h2 id="typing-title" class="stage-title">Complete the Sentence</h2>
            <textarea id="typing-input" placeholder="Start typing..."></textarea>
            <button id="typing-submit" onclick="submitTyping()">Next >></button>
        </div>

        <div id="stage-final" class="stage-area">
            <h2 class="stage-title" style="color:green;">Construction Complete!</h2>
            <div style="margin-top:20px;">
                <button class="choice-btn btn-white" style="background:#95a5a6; color:white; margin-right:10px;" onclick="goBackFromFinal()">Review / Edit</button>
                <button class="choice-btn btn-white" onclick="saveAndNext()">Next Question</button>
            </div>
        </div>
        
        <div id="sentence-builder"><span style="color:#ccc;">Your sentence will appear here...</span></div>
        
        <div id="essay-display">
            <button id="clear-essay-btn" onclick="clearEssay()">Clear</button>
            <h3>Your Essay So Far:</h3>
            <div id="essay-content"></div>
        </div>
    </div>
    
    <div id="overlay" onclick="closeOverlay()"><div id="overlay-msg"><i class="fas fa-times-circle" style="font-size:3rem; color:#e74c3c; margin-bottom:15px;"></i><h2>Incorrect</h2><p>Try again.</p></div></div>
    <div id="levelup-overlay" onclick="closeLevelUp()"><div class="overlay-content"><div class="firework"></div><h2 style="margin-top:50px;">LEVEL UP!</h2><p id="levelup-msg"></p><button class="choice-btn btn-white">Continue</button></div></div>
    
    <div id="win-overlay">
        <canvas id="confetti-canvas"></canvas>
        <div class="win-card">
            <div class="trophy-anim">üèÜ</div>
            <h1 class="win-title">Awesome!</h1>
            <p style="color:#777; font-size:1.2rem;">You completed the challenge!</p>
            <p id="final-score" style="font-weight:bold; font-size:1.1rem; color:#2c3e50;">Score: 0</p>
            <button class="win-btn" onclick="restartSession()">Play Again</button>
        </div>
    </div>

    <div id="admin-modal">
        <div class="admin-panel">
            <div class="panel-header"><span>Teacher Settings</span><button onclick="closeAdmin()" style="border:none; background:none; font-weight:bold; cursor:pointer;">X</button></div>
            <div id="admin-lock" style="height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <p>Password:</p> <input type="password" id="admin-pass-input" style="padding:10px;"> <button onclick="unlockAdmin()" style="margin-top:10px; padding:10px;">Unlock</button>
            </div>
            <div id="admin-edit" class="panel-body" style="display:none;">
                
                <div class="data-manager">
                    <h3 style="margin-top:0; color:#16a085;">üíæ Data Manager</h3>
                    <button class="data-btn" onclick="downloadConfig()"><i class="fas fa-download"></i> Save Progress to File</button>
                    <button class="data-btn" onclick="document.getElementById('file-upload').click()"><i class="fas fa-folder-open"></i> Load Progress from File</button>
                    <input type="file" id="file-upload" style="display:none" onchange="uploadConfig(this)">
                </div>

                <div style="margin-bottom:20px;"><label>Main Question</label><input id="edit-topic" class="admin-input" style="width:95%" onchange="updateConfigVal('topic', this.value)"></div>
                
                <div class="section-box">
                    <strong>Global Banks (Manage Sources for "Open" Mode)</strong>
                    <div style="font-size:0.8rem; color:#777; margin-bottom:10px;">If you choose "Open (Any)" mode in a question, the game will pull from these lists based on the active Game Mode (AO2 vs AO4).</div>
                    
                    <div class="banks-container">
                        <div class="bank-column" id="bank-col-ao2">
                            <div class="bank-header">AO2 Banks (Analysis)</div>
                            <div style="margin-bottom:10px;"><button onclick="addItem('s1', false)">+ Add Starter</button> <div id="list-s1-ao2"></div></div>
                            <div style="margin-bottom:10px;"><button onclick="addItem('s2', false)">+ Add Method</button> <div id="list-s2-ao2"></div></div>
                            <div style="margin-bottom:10px;"><button onclick="addItem('s3', false)">+ Add Link</button> <div id="list-s3-ao2"></div></div>
                        </div>
                        
                        <div class="bank-column" style="background:#fff;">
                            <div class="bank-header">Shared Banks</div>
                            <div style="margin-bottom:10px;"><button onclick="addItem('quote_bank')">+ Distractor Quotes</button> <div id="list-quote-bank"></div></div>
                            <div style="margin-bottom:10px;"><button onclick="addItem('point_bank')">+ Distractor Points</button> <div id="list-point-bank"></div></div>
                        </div>

                        <div class="bank-column" id="bank-col-ao4">
                            <div class="bank-header">AO4 Banks (Evaluation)</div>
                            <div style="margin-bottom:10px;"><button onclick="addItem('s1', true)">+ Add Discourse Marker</button> <div id="list-s1-ao4"></div></div>
                            <div style="margin-bottom:10px;"><button onclick="addItem('s2', true)">+ Add Opinion Indicator</button> <div id="list-s2-ao4"></div></div>
                            <div style="margin-bottom:10px;"><button onclick="addItem('s3', true)">+ Add Link</button> <div id="list-s3-ao4"></div></div>
                        </div>
                    </div>
                </div>

                <div class="section-box" style="border-left: 5px solid var(--col-2-yellow);">
                    <strong>1. Point Manager</strong>
                    <div id="list-content"></div>
                    <div style="margin-top:10px;"><button onclick="addContent()" style="background:#f1c40f; padding:10px; width:100%; border:none; font-weight:bold;">+ Add New Point</button></div>
                </div>
                
                <div class="section-box" style="border-left: 5px solid #2ecc71;">
                    <strong>2. Worksheet & Game Scaffolding</strong>
                    <div style="background:#eef; padding:10px; margin-bottom:10px; border-radius:5px;">
                        <small>Default Sentence Order:</small>
                        <div style="display:flex; gap:5px; margin-top:5px;">
                            <select id="def-struct-0" class="admin-input" onchange="updateDefaultStruct()"><option value="s1">Starter</option><option value="s2">Method</option><option value="quote">Quote</option><option value="s3">Link</option><option value="s4">Point</option></select>
                            <select id="def-struct-1" class="admin-input" onchange="updateDefaultStruct()"><option value="s1">Starter</option><option value="s2">Method</option><option value="quote">Quote</option><option value="s3">Link</option><option value="s4">Point</option></select>
                            <select id="def-struct-2" class="admin-input" onchange="updateDefaultStruct()"><option value="s1">Starter</option><option value="s2">Method</option><option value="quote">Quote</option><option value="s3">Link</option><option value="s4">Point</option></select>
                            <select id="def-struct-3" class="admin-input" onchange="updateDefaultStruct()"><option value="s1">Starter</option><option value="s2">Method</option><option value="quote">Quote</option><option value="s3">Link</option><option value="s4">Point</option></select>
                            <select id="def-struct-4" class="admin-input" onchange="updateDefaultStruct()"><option value="s1">Starter</option><option value="s2">Method</option><option value="quote">Quote</option><option value="s3">Link</option><option value="s4">Point</option><option value="none">-- Remove --</option></select>
                            <button onclick="applyDefaultStructureToAll()" style="font-size:0.8rem; background:#e74c3c; color:white; border:none; padding:5px; border-radius:3px; cursor:pointer;">Apply Default Structure to ALL Questions</button>
                        </div>
                    </div>
                    
                    <div style="background:#f9f9f9; padding:10px; margin-top:10px; border-top:1px dashed #ccc;">
                        <strong>Bulk Mode Tools:</strong><br>
                        <div style="display:flex; gap:5px; margin-top:5px; flex-wrap:wrap;">
                            <button class="bulk-btn" onclick="bulkSetMode('s1','open')">Set All Starters to Open</button>
                            <button class="bulk-btn" onclick="bulkSetMode('s2','open')">Set All Methods to Open</button>
                            <button class="bulk-btn" onclick="bulkSetMode('s3','open')">Set All Links to Open</button>
                        </div>
                    </div>

                    <div style="background:#f0f9f0; padding:10px; margin-top:10px;">
                        <div class="scaffold-row"><span>1. Starter</span><select id="s1-mode" class="scaffold-select" onchange="updateWSSetting('s1_mode', this.value)"><option value="text">Text</option><option value="scaffold">Blank</option></select></div>
                        <div class="scaffold-row"><span>2. Method</span><select id="s2-mode" class="scaffold-select" onchange="updateWSSetting('s2_mode', this.value)"><option value="text">Text</option><option value="scaffold">Blank</option></select></div>
                        <div class="scaffold-row"><span>3. Quote</span><select id="quote-mode" class="scaffold-select" onchange="updateWSSetting('quote_mode', this.value)"><option value="text">Text</option><option value="scaffold">Blank</option></select></div>
                        <div class="scaffold-row"><span>4. Link</span><select id="s3-mode" class="scaffold-select" onchange="updateWSSetting('s3_mode', this.value)"><option value="text">Text</option><option value="scaffold">Blank</option></select></div>
                        <div class="scaffold-row"><span>5. Point</span><select id="s4-mode" class="scaffold-select" onchange="updateWSSetting('s4_mode', this.value)"><option value="text">Text</option><option value="scaffold">Blank</option></select></div>
                    </div>
                </div>

                <div class="section-box">
                    <strong>Game Rules</strong>
                    <div class="toggle-row"><label>Mode</label><select id="edit-gamemode" onchange="updateConfigVal('gameMode', this.value)"><option value="AO2">AO2</option><option value="AO4">AO4</option></select></div>
                    <div class="toggle-row"><label>Start Level</label><select id="edit-start-lvl" onchange="updateConfigVal('settings.startLevel', this.value)"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div>
                    <div class="toggle-row"><label>Progression</label>
                        <select id="edit-progression" onchange="updateConfigVal('settings.progressionMode', this.value)">
                            <option value="level_up">üöÄ Linear (Auto-Level Up)</option>
                            <option value="loop">üîÅ Single Level (Loop & Win)</option>
                        </select>
                    </div>
                    <div class="toggle-row"><label>Essay Building</label>
                        <select id="edit-essaymode" onchange="updateConfigVal('settings.accumulateEssay', this.value)">
                            <option value="false">Off (Sentence Only)</option>
                            <option value="true">On (Accumulate Sentences)</option>
                        </select>
                    </div>
                    <div class="toggle-row"><label>Target Streak</label><input type="number" id="edit-streak" class="admin-input" style="width:60px" onchange="updateConfigVal('settings.streakThreshold', this.value)"></div>
                </div>

                <div style="display:flex; justify-content: space-between; padding-top:20px; border-top:1px solid #eee;">
                    
                    <div style="display:flex; gap:10px; align-items:center;">
                        <select id="ws-style" class="admin-input" onchange="updateWSSetting('style', this.value)" style="width:200px; border:2px solid #2980b9;">
                            <option value="mcq">Paper Game (Multiple Choice)</option>
                            <option value="blank">Fill-in-the-Blanks</option>
                            <option value="key">Answer Key (Completed)</option>
                        </select>
                        <button onclick="printWorksheet()" style="background:#f39c12; color:white; border:none; padding:10px;">Print PDF</button>
                        <button onclick="downloadWordDoc()" style="background:#2980b9; color:white; border:none; padding:10px;">Word Doc</button>
                    </div>
                    
                    <div style="display:flex; gap:10px;">
                        <button onclick="triggerSave()" id="save-btn" style="background:#3498db; color:white; padding:10px;">Save Settings</button>
                        <button onclick="exportApp()" style="background:#27ae60; color:white; border:none; padding:10px;">Download App</button>
                    </div>
                </div>

            </div>
        </div>
    </div>
    
    <div id="emergency-reset" onclick="forceReset()">Emergency Factory Reset</div>

    <script>
        // --- 0. HELPERS & GLOBAL FUNCTIONS ---
        // Defined early to avoid reference errors
        function updateBankHighlights() {
            var isAO4 = (config.gameMode === "AO4");
            var col2 = document.getElementById('bank-col-ao2');
            var col4 = document.getElementById('bank-col-ao4');
            if(col2 && col4) {
                if(isAO4) {
                    col4.classList.add('active-bank');
                    col2.classList.remove('active-bank');
                } else {
                    col2.classList.add('active-bank');
                    col4.classList.remove('active-bank');
                }
            }
        }

        function updateAdminInputs() {
            document.getElementById('edit-topic').value = config.topic || "";
            document.getElementById('edit-gamemode').value = config.gameMode || "AO2";
            document.getElementById('edit-start-lvl').value = config.settings.startLevel || 1;
            document.getElementById('edit-progression').value = config.settings.progressionMode || "level_up";
            document.getElementById('edit-essaymode').value = config.settings.accumulateEssay || "false";
            document.getElementById('edit-streak').value = config.settings.streakThreshold || 3;
        }

        function openAdmin() { 
            document.getElementById('admin-modal').style.display = 'flex'; 
            updateAdminInputs();
            updateBankHighlights(); 
        }
        function closeAdmin() { document.getElementById('admin-modal').style.display = 'none'; }
        function unlockAdmin() {
            var val = document.getElementById('admin-pass-input').value.trim();
            if(val === config.adminPass || val === "teacher") {
                document.getElementById('admin-lock').style.display = 'none';
                document.getElementById('admin-edit').style.display = 'block';
                renderAdminUI();
            } else { alert("Incorrect"); }
        }
        function forceReset() {
            if(confirm("Factory Reset? This clears all saved data.")) { localStorage.removeItem(STORE_KEY); window.location.reload(); }
        }
        
        // --- NEW: SAFE RESTART FUNCTION ---
        function restartSession() {
            // Reset Game State but keep Config/Data
            gameState = {
                currentLevel: parseInt(config.settings.startLevel),
                streak: 0,
                score: 0,
                roundScoreAdded: false,
                completedIds: []
            };
            
            // NOTE: Essay content persists. 
            document.getElementById('win-overlay').style.display = 'none';
            updateScoreBoard();
            resetGame();
        }
        
        function clearEssay() {
            if(confirm("Clear your essay?")) {
                document.getElementById('essay-content').innerText = "";
                document.getElementById('essay-display').style.display = 'none';
            }
        }
        
        // --- NEW: SAVE HELPER (Used by both saveAndNext AND finishGame) ---
        function saveEssayContent() {
            if(config.settings.accumulateEssay === "true" || config.settings.accumulateEssay === true) {
                // Build Sentence based on structure
                let fullSentence = "";
                let struct = config.default_structure;
                
                // Safety check for quote ID
                if (!currentQuoteId) return;

                let q = config.content_pairs.find(x => x.id === currentQuoteId);
                if(q && q.structure) struct = q.structure;
                
                let uniqueStruct = [...new Set(struct)].filter(k => k !== 'none');
                
                uniqueStruct.forEach(k => {
                    if(sentenceParts[k]) fullSentence += sentenceParts[k] + " ";
                });
                
                // Append to Essay Box
                let essayDiv = document.getElementById('essay-content');
                if(fullSentence.trim() !== "") {
                    // Check if sentence already exists to prevent double add on win
                    if(!essayDiv.innerText.includes(fullSentence.trim())) {
                         essayDiv.innerText += fullSentence.trim() + "\n\n";
                         document.getElementById('essay-display').style.display = 'block';
                    }
                }
            }
        }

        // --- 1. DEFAULT DATA ---
        var defaultStructure = ['s1', 's2', 'quote', 's3', 's4'];
        var defaultData = {
            appTitle: "Evaluation Architect", topic: "How is the character presented?", adminPass: "teacher", gameMode: "AO2", 
            settings: { startLevel: 1, maxLevel: 3, streakThreshold: 3, progressionMode: "level_up", accumulateEssay: "false" },
            default_structure: defaultStructure, 
            worksheetSettings: { showTask1: true, showTask2: true, style: "mcq", s1_mode: "text", s2_mode: "text", quote_mode: "text", s3_mode: "text", s4_mode: "text" },
            starters_evidence: [ "The writer uses", "The author explicitly chooses" ], ao2_methods: ["Metaphor", "Simile"], starters_evaluative: [ "to suggest", "to imply" ],
            ao4_starters: [ "I agree that", "It is evident that" ], ao4_markers: [ "However,", "Furthermore," ], ao4_links: [ "evident when" ],
            quote_bank: ["Random Quote 1"], point_bank: ["Random Point 1"],
            content_pairs: [
                { id: "c1", title: "Point 1", level: 1, specific_s1: "", quote: "neighbour from hell", method: "metaphor", specific_s3: "", effect: "that the BBC is impossible.", distractors: [], structure: defaultStructure, modes: { s1:'open', s2:'open', quote:'quiz', s3:'open', s4:'quiz' } }
            ]
        };

        var STORE_KEY = 'eval_arch_v124_final_logic'; 
        var config = JSON.parse(JSON.stringify(defaultData));
        var currentQuoteId = null;
        var sentenceParts = { s1: "", s2: "", quote: "", s3: "", s4: "" };
        var gameState = { currentLevel: 1, streak: 0, score: 0, roundScoreAdded: false, completedIds: [] };
        var currentStageIndex = 0;
        var currentGameStructure = [];
        var currentSelectedOption = null;

        document.addEventListener('keydown', function(event) {
            if (event.key === "Escape") {
                var modal = document.getElementById('admin-modal');
                if (modal.style.display === 'none') openAdmin(); else closeAdmin();
            }
        });

        window.onload = function() {
            try {
                var local = localStorage.getItem(STORE_KEY);
                if(local) {
                    var parsed = JSON.parse(local);
                    config = Object.assign({}, defaultData, parsed);
                    if(!config.content_pairs) config.content_pairs = defaultData.content_pairs;
                }
            } catch(e) {
                console.log("Resetting corrupted data");
                config = JSON.parse(JSON.stringify(defaultData));
            }
            
            document.getElementById('admin-modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            
            // Set worksheet dropdown
            var wsStyle = document.getElementById('ws-style');
            if(wsStyle && config.worksheetSettings.style) wsStyle.value = config.worksheetSettings.style;

            sanitizeData();
            updateDOM();
            setTimeout(() => {
                renderAdminUI();
                updateAdminInputs(); // PRE-FILL SETTINGS ON LOAD
            }, 100);
        };

        function sanitizeData() {
            if(!config.content_pairs || !Array.isArray(config.content_pairs)) config.content_pairs = JSON.parse(JSON.stringify(defaultData.content_pairs));
            config.content_pairs.forEach(p => {
                if(!p.title) p.title = "Point 1"; // Fallback
                if(!p.level) p.level = 1; 
                if(!p.distractors) p.distractors = [];
                if(!p.modes) p.modes = { s1: 'open', s2: 'open', quote: 'quiz', s3: 'open', s4: 'quiz' };
                if(!p.structure) p.structure = ['s1', 's2', 'quote', 's3', 's4'];
            });
            if(!config.quote_bank) config.quote_bank = [];
            if(!config.point_bank) config.point_bank = [];
            if(!config.ao4_starters) config.ao4_starters = ["I agree that"];
            if(!config.ao4_markers) config.ao4_markers = ["However,", "Therefore,"];
            if(!config.ao4_links) config.ao4_links = ["evident because"];
            if(!config.settings.progressionMode) config.settings.progressionMode = "level_up";
            if(!config.settings.accumulateEssay) config.settings.accumulateEssay = "false";
        }

        function updateDOM() {
            // FIXED: Ensure dynamic topic display (REMOVED hardcoded default so user input is respected)
            document.getElementById('topic-display').innerText = config.topic || "Enter a Question in Settings";
            gameState.currentLevel = parseInt(config.settings.startLevel);
            updateScoreBoard();
            
            // Show/Hide Essay Box
            var essayBox = document.getElementById('essay-display');
            if(config.settings.accumulateEssay === "true") {
                if(document.getElementById('essay-content').innerText.trim() !== "") {
                    essayBox.style.display = "block";
                } else {
                    essayBox.style.display = "none";
                }
            } else {
                essayBox.style.display = "none";
            }
            
            resetGame();
        }

        function getStageLabel(key) {
            if(key === 's1') return "Starter";
            if(key === 's2') return "Method/Marker";
            if(key === 'quote') return "Quote";
            if(key === 's3') return "Link";
            if(key === 's4') return "Point";
            return "";
        }
        
        // --- NEW: SAVE AND NEXT LOGIC ---
        function saveAndNext() {
            saveEssayContent();
            resetGame();
        }

        function resetGame() {
            sentenceParts = { s1: "", s2: "", quote: "", s3: "", s4: "" };
            currentStageIndex = 0; currentQuoteId = null; currentGameStructure = []; currentSelectedOption = null;
            gameState.roundScoreAdded = false;
            updateBuilder();
            renderGameGrid('quote_select_mode'); 
        }

        function loadStage() {
            if(currentStageIndex >= currentGameStructure.length) { finishGame(); return; }
            document.getElementById('confirm-bar').style.display = 'none';
            currentSelectedOption = null;

            var stageKey = currentGameStructure[currentStageIndex];
            renderGameGrid(stageKey);
        }

        function renderGameGrid(key) {
            hideAllStages();
            document.getElementById('stage-area').style.display = 'block';
            var grid = document.getElementById('game-grid');
            grid.innerHTML = '';

            // --- MAIN GRID (Acts as Menu AND Quote Selection) ---
            if(key === 'quote_select_mode') {
                document.getElementById('current-task-info').innerText = ""; // Clear task info
                document.getElementById('stage-title').innerText = "Select Evidence to Analyse";
                document.getElementById('stage-subtitle').innerText = "Choose a quote to build your sentence around.";
                
                var levelQuestions = config.content_pairs.filter(p => parseInt(p.level) === gameState.currentLevel);
                if(levelQuestions.length === 0) {
                    grid.innerHTML = `<p style="grid-column:1/-1;">No points found for Level ${gameState.currentLevel}. Please add them in settings.</p>`;
                    return;
                }

                levelQuestions.forEach(p => {
                    var btn = createBtn(p.quote, () => {
                        // 1. SET ID
                        currentQuoteId = p.id;
                        
                        // 2. AUTO-FILL QUOTE
                        sentenceParts['quote'] = `"${p.quote}"`;
                        
                        // 3. CALCULATE STRUCTURE & REMOVE QUOTE STEP
                        var rawStruct = (p.structure && p.structure.length>0) ? p.structure : config.default_structure;
                        // Unique set, then remove 'none' AND 'quote' (since we just picked it)
                        var uniqueStruct = [...new Set(rawStruct)];
                        currentGameStructure = uniqueStruct.filter(k => k !== 'none' && k !== 'quote');
                        
                        currentStageIndex = 0;
                        updateBuilder();
                        loadStage();
                    });
                    btn.classList.add('btn-white');
                    // Check if already completed
                    if(gameState.completedIds && gameState.completedIds.includes(p.id)) {
                        btn.classList.add('completed');
                        btn.innerHTML += ' ‚úÖ';
                    }
                    grid.appendChild(btn);
                });
                return;
            }

            // --- SUB STAGES ---
            var pair = config.content_pairs.find(p => p.id === currentQuoteId);
            
            // SHOW CURRENT TASK - UPDATED TO "Drafting: Point X"
            document.getElementById('current-task-info').innerText = "Drafting: " + (pair.title || "Point");

            document.getElementById('stage-title').innerText = (currentStageIndex + 1) + ". " + getStageLabel(key);
            document.getElementById('stage-subtitle').innerText = getStageSubtitle(key);

            var isAO4 = (config.gameMode === "AO4");
            var mode = pair.modes[key] || 'quiz'; 
            var options = [];

            if(mode === 'scaffold') {
                var correctText = getSpecificText(key, pair, isAO4);
                options.push({ txt: correctText, correct: true });
            } 
            else if (mode === 'quiz') {
                var correctText = getSpecificText(key, pair, isAO4);
                options.push({ txt: correctText, correct: true });
                var dists = getDistractors(key, pair, isAO4, correctText, currentQuoteId);
                dists = dists.filter(t => t !== correctText);
                dists.sort(()=>Math.random()-0.5);
                for(var i=0; i<3 && i<dists.length; i++) options.push({ txt: dists[i], correct: false });
            }
            else if (mode === 'open') {
                // FORCE BANK ITEMS IF OPEN
                var bankItems = getBankItems(key, isAO4);
                
                // V116 RECALL: Ensure previously selected choice is available
                var recall = sentenceParts[key];
                if(recall && !bankItems.includes(recall)) {
                    bankItems.push(recall);
                }

                // Also add the specific correct text if it exists (so it's not missing)
                var specific = getSpecificText(key, pair, isAO4);
                if(specific && specific !== "..." && !bankItems.includes(specific)) {
                    bankItems.push(specific);
                }

                bankItems.sort(()=>Math.random()-0.5);
                // Ensure at least 4 items if possible
                for(var i=0; i<4 && i<bankItems.length; i++) options.push({ txt: bankItems[i], correct: true });
            }

            options.sort(()=>Math.random()-0.5);
            var seen=new Set(); var final=[];
            options.forEach(o=>{if(!seen.has(o.txt)){seen.add(o.txt); final.push(o);}});

            final.forEach(opt => {
                var btn = createBtn(opt.txt, function() { selectOption(this, opt, key); });
                var cls = key==='s1'?'btn-s1':key==='s2'?'btn-s2':key==='s3'?'btn-s3':'btn-s3'; // Link is Blue
                if(key==='s4') cls='btn-s4'; // Point is Green
                if(key==='quote') cls='btn-white';
                
                // V116 RECALL: Highlight if already selected
                if(sentenceParts[key] === opt.txt || (key === 'quote' && sentenceParts[key] === `"${opt.txt}"`)) {
                    btn.classList.add('selected');
                    currentSelectedOption = opt;
                    document.getElementById('confirm-bar').style.display = 'block';
                }

                btn.classList.add(cls);
                grid.appendChild(btn);
            });
        }

        function getSpecificText(key, pair, isAO4) {
            if(key === 'quote') return pair.quote;
            if(key === 's1') return pair.specific_s1 || (isAO4 ? config.ao4_starters[0] : config.starters_evidence[0]);
            if(key === 's2') return pair.method || (isAO4 ? "However," : "metaphor");
            if(key === 's3') return pair.specific_s3 || (isAO4 ? config.ao4_links[0] : config.starters_evaluative[0]);
            if(key === 's4') return pair.effect;
            return "...";
        }

        function getBankItems(key, isAO4) {
            // STRICT SEPARATION OF BANKS
            if(key==='s1') return isAO4 ? config.ao4_starters : config.starters_evidence;
            if(key==='s2') return isAO4 ? config.ao4_markers : config.ao2_methods;
            if(key==='s3') return isAO4 ? config.ao4_links : config.starters_evaluative;
            return [];
        }

        function getDistractors(key, pair, isAO4, correctText, qId) {
            var dists = [];
            if(key==='quote') {
                dists = config.quote_bank.concat(config.content_pairs.filter(p=>p.id!==qId).map(p=>p.quote));
            } else if(key==='s4') {
                dists = config.point_bank.concat(pair.distractors || []);
            } else {
                dists = getBankItems(key, isAO4);
            }
            return dists;
        }

        function getStageSubtitle(key) {
            var isAO4 = (config.gameMode === "AO4");
            if(key === 's1') return isAO4 ? "State your opinion." : "How will you introduce the quote?";
            if(key === 's2') return isAO4 ? "Choose a discourse marker." : "What terminology applies?";
            if(key === 'quote') return "Select the evidence.";
            if(key === 's3') return "Connect to the meaning.";
            if(key === 's4') return "What is the deeper meaning/effect?";
            return "Select the correct option.";
        }

        function selectOption(btn, opt, key) {
            document.querySelectorAll('#game-grid .choice-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            sentenceParts[key] = key==='quote'?`"${opt.txt}"`:opt.txt;
            updateBuilder();
            currentSelectedOption = opt;
            document.getElementById('confirm-bar').style.display = 'block';
        }

        function confirmChoice() {
            if(!currentSelectedOption) return;
            if(currentSelectedOption.correct) { advanceStage(); } else { showError(); }
        }

        function goBack() {
            if(currentStageIndex === 0) {
                resetGame(); // Go back to Grid
            } else {
                currentStageIndex--;
                loadStage();
            }
        }

        function goBackFromFinal() {
            currentStageIndex = currentGameStructure.length - 1;
            loadStage();
        }

        function finishGame() {
            if(!gameState.roundScoreAdded) {
                var pts = 2 * Math.pow(2, gameState.currentLevel - 1);
                gameState.score += pts;
                gameState.streak++;
                gameState.roundScoreAdded = true;
                
                if(currentQuoteId && !gameState.completedIds.includes(currentQuoteId)) {
                    gameState.completedIds.push(currentQuoteId);
                }

                updateScoreBoard();
                
                if(gameState.streak >= config.settings.streakThreshold) {
                    
                    // SAVE ESSAY BEFORE WIN SCREEN
                    saveEssayContent();

                    if (config.settings.progressionMode === 'level_up' && gameState.currentLevel < config.settings.maxLevel) {
                        showLevelUp(pts);
                    } else {
                        showWin(pts); 
                    }
                    return; 
                }
            }
            hideAllStages();
            document.getElementById('stage-final').style.display = 'block';
        }

        // --- HELPERS ---
        function createBtn(t, click) { var b=document.createElement('button'); b.className='choice-btn'; b.innerHTML=t; b.onclick=click; return b; }
        function advanceStage() { currentStageIndex++; loadStage(); }
        
        function updateBuilder() {
            var h=""; 
            var structToUse = config.default_structure;
            if(currentQuoteId) {
                var p = config.content_pairs.find(x => x.id === currentQuoteId);
                if(p && p.structure && p.structure.length > 0) structToUse = p.structure;
            }
            var uniqueStruct = [...new Set(structToUse)].filter(k => k !== 'none');

            uniqueStruct.forEach(k=>{
                if(sentenceParts[k]) {
                    var c = k==='s1'?'var(--col-1-pink)':k==='s2'?'var(--col-2-yellow)':k==='quote'?'white':k==='s3'?'var(--col-3-blue)':'var(--col-4-green)';
                    h+=`<span class="fragment" style="background:${c}">${sentenceParts[k]}</span> `;
                }
            });
            document.getElementById('sentence-builder').innerHTML=h||"<span style='color:#ccc'>Your sentence will appear here...</span>";
        }

        function hideAllStages() { document.getElementById('stage-area').style.display='none'; document.getElementById('typing-interface').style.display='none'; document.getElementById('stage-final').style.display='none'; }
        function updateScoreBoard() { document.getElementById('score-val').innerText=gameState.score; document.getElementById('streak-val').innerText=gameState.streak+"/"+config.settings.streakThreshold; document.getElementById('level-badge').innerText="LEVEL "+gameState.currentLevel; }
        function closeLevelUp() { 
            gameState.currentLevel++; 
            gameState.streak=0; 
            gameState.completedIds = []; 
            document.getElementById('levelup-overlay').style.display='none'; 
            updateScoreBoard(); 
            resetGame(); 
        }
        function showLevelUp(p) { document.getElementById('levelup-overlay').style.display='flex'; document.getElementById('levelup-msg').innerText=`+${p}`; triggerConfetti(); }
        function showWin(p) { 
            document.getElementById('win-overlay').style.display='flex'; 
            document.getElementById('final-score').innerText = "Score: " + gameState.score;
            triggerConfetti();
        }
        function showError() { var o=document.getElementById('overlay'); o.style.display='flex'; gameState.streak=0; updateScoreBoard(); }
        function closeOverlay() { document.getElementById('overlay').style.display='none'; }
        
        // --- CONFETTI ENGINE (No external dependency) ---
        function triggerConfetti() {
            const canvas = document.getElementById('confetti-canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            let particles = [];
            const colors = ['#f1c40f', '#e74c3c', '#3498db', '#9b59b6', '#2ecc71'];
            
            for(let i=0; i<150; i++) {
                particles.push({
                    x: canvas.width/2, y: canvas.height/2,
                    r: Math.random()*10+5,
                    dx: (Math.random()-0.5)*20,
                    dy: (Math.random()-0.5)*20,
                    color: colors[Math.floor(Math.random()*colors.length)],
                    tilt: Math.random()*10
                });
            }
            
            function animate() {
                ctx.clearRect(0,0,canvas.width,canvas.height);
                particles.forEach((p, i) => {
                    p.x += p.dx; p.y += p.dy; p.dy += 0.5; // gravity
                    p.tilt += 0.5;
                    ctx.fillStyle = p.color;
                    ctx.beginPath();
                    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
                    ctx.fill();
                    if(p.y > canvas.height) particles.splice(i, 1);
                });
                if(particles.length > 0) requestAnimationFrame(animate);
            }
            animate();
        }

        // --- DATA MANAGER ---
        function downloadConfig() {
            var blob = new Blob([JSON.stringify(config)], {type: "application/json"});
            var url = URL.createObjectURL(blob);
            var a = document.createElement("a");
            a.href = url;
            a.download = "evaluation_data.json";
            a.click();
        }

        function uploadConfig(input) {
            var file = input.files[0];
            if(!file) return;
            var reader = new FileReader();
            reader.onload = function(e) {
                try {
                    config = JSON.parse(e.target.result);
                    if(!config.worksheetSettings.style) config.worksheetSettings.style = "mcq";
                    saveLocal(true);
                    updateAdminInputs();
                    alert("Data Loaded Successfully!");
                } catch(e) { alert("Invalid File"); }
            };
            reader.readAsText(file);
        }
        
        function bulkSetMode(key, mode) {
            if(confirm("Set ALL questions' " + key.toUpperCase() + " to " + mode.toUpperCase() + "?")) {
                config.content_pairs.forEach(p => {
                    if(!p.modes) p.modes = { s1:'open', s2:'open', quote:'quiz', s3:'open', s4:'quiz' };
                    p.modes[key] = mode;
                });
                renderAdminUI();
            }
        }
        
        // --- NEW: AUTO POINT NAMING ---
        function addContent() { 
            var newNum = config.content_pairs.length + 1;
            config.content_pairs.push({
                id: "c"+Date.now(), 
                title: "Point " + newNum, // Default to Point X
                level: 1, 
                specific_s1:"", quote:"New", method:"", specific_s3:"", effect:"", 
                distractors:[], 
                structure: JSON.parse(JSON.stringify(config.default_structure)), 
                modes:{s1:'open',s2:'open',quote:'quiz',s3:'open',s4:'quiz'}
            }); 
            renderAdminUI(); 
        }

        // --- ADMIN ---
        function renderAdminUI() {
            var list = document.getElementById('list-content'); list.innerHTML = '';
            config.content_pairs.forEach((p, i) => {
                var div = document.createElement('div'); div.className='content-card';
                var getMode = (k) => p.modes[k] || 'open';
                var sel = (k, v) => getMode(k) === v ? 'selected' : '';
                var mSelect = (k) => `<select class="mode-select" onchange="setMode(${i},'${k}',this.value)">
                    <option value="scaffold" ${sel(k,'scaffold')}>1. Scaffold (Fixed)</option>
                    <option value="quiz" ${sel(k,'quiz')}>2. Quiz (Specific)</option>
                    ${ (k!=='quote' && k!=='s4') ? `<option value="open" ${sel(k,'open')}>3. Open (Any)</option>` : '' }
                </select>`;

                var structHTML = `<div style="background:#eef; padding:5px; margin-bottom:5px; border-radius:3px;">
                        <small><strong>Sentence Order (Custom):</strong></small><br>
                        <div style="display:flex; gap:3px;">`;
                p.structure.forEach((sVal, sIdx) => {
                    structHTML += `<select class="admin-input" style="padding:2px; font-size:0.8rem;" onchange="updateCardStruct(${i}, ${sIdx}, this.value)">
                        <option value="s1" ${sVal=='s1'?'selected':''}>Starter</option>
                        <option value="s2" ${sVal=='s2'?'selected':''}>Method</option>
                        <option value="quote" ${sVal=='quote'?'selected':''}>Quote</option>
                        <option value="s3" ${sVal=='s3'?'selected':''}>Link</option>
                        <option value="s4" ${sVal=='s4'?'selected':''}>Point</option>
                        <option value="none" ${sVal=='none'?'selected':''}>-- Remove --</option>
                    </select>`;
                });
                structHTML += `</div></div>`;
                
                var levelHTML = `<div style="margin-bottom:5px;"><label>Assign to Level:</label> <select class="admin-input" style="width:auto;" onchange="updateContent(${i}, 'level', this.value)"><option value="1" ${p.level==1?'selected':''}>1</option><option value="2" ${p.level==2?'selected':''}>2</option><option value="3" ${p.level==3?'selected':''}>3</option></select></div>`;
                
                var getHint = (k) => {
                    var m = getMode(k);
                    if(m==='open') return '<span class="source-hint">(Source: Global Bank)</span>';
                    if(m==='quiz') return '<span class="source-hint">(Specific vs Distractors)</span>';
                    return '<span class="source-hint">(Only this text)</span>';
                };

                div.innerHTML = `<div class="content-card-header"><input class="admin-input" style="font-weight:bold;width:60%" value="${esc(p.title)}" onchange="updateContent(${i},'title',this.value)"> <button class="del-btn" onclick="delContent(${i})">Delete</button></div>
                ${levelHTML}
                ${structHTML}
                <div class="step-1"><div style="display:flex;justify-content:space-between;"><span>1. Starter ${getHint('s1')}</span>${mSelect('s1')}</div><input class="admin-input" value="${esc(p.specific_s1)}" onchange="updateContent(${i},'specific_s1',this.value)"></div>
                <div class="step-2"><div style="display:flex;justify-content:space-between;"><span>2. Method ${getHint('s2')}</span>${mSelect('s2')}</div><input class="admin-input" value="${esc(p.method)}" onchange="updateContent(${i},'method',this.value)"></div>
                <div class="step-3"><div style="display:flex;justify-content:space-between;"><span>3. Quote ${getHint('quote')}</span>${mSelect('quote')}</div><textarea class="admin-textarea" onchange="updateContent(${i},'quote',this.value)">${esc(p.quote)}</textarea></div>
                <div class="step-4"><div style="display:flex;justify-content:space-between;"><span>4. Link ${getHint('s3')}</span>${mSelect('s3')}</div><input class="admin-input" value="${esc(p.specific_s3)}" onchange="updateContent(${i},'specific_s3',this.value)"></div>
                <div class="step-5"><div style="display:flex;justify-content:space-between;"><span>5. Point ${getHint('s4')}</span>${mSelect('s4')}</div><textarea class="admin-textarea" onchange="updateContent(${i},'effect',this.value)">${esc(p.effect)}</textarea></div>`;
                
                var distHTML = `<div style="margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;"><span style="font-size:0.8rem; color:red;">Specific Distractors (Point)</span>`;
                p.distractors.forEach((d,dIdx) => {
                    distHTML += `<div style="display:flex; gap:5px; margin-bottom:3px;"><input class="admin-input" style="font-size:0.8rem;" value="${esc(d)}" onchange="updateDist(${i},${dIdx},this.value)"><button style="background:#faa;border:none;cursor:pointer;" onclick="removeDist(${i},${dIdx})">x</button></div>`;
                });
                distHTML += `<button style="width:100%;font-size:0.8rem;" onclick="addDist(${i})">+ Add Specific Distractor</button></div>`;
                div.innerHTML += distHTML;
                list.appendChild(div);
            });
            
            renderList('list-s1-ao2', config.starters_evidence, 'starters_evidence');
            renderList('list-s2-ao2', config.ao2_methods, 'ao2_methods');
            renderList('list-s3-ao2', config.starters_evaluative, 'starters_evaluative');
            
            renderList('list-s1-ao4', config.ao4_starters, 'ao4_starters');
            renderList('list-s2-ao4', config.ao4_markers, 'ao4_markers');
            renderList('list-s3-ao4', config.ao4_links, 'ao4_links');
            
            renderList('list-quote-bank', config.quote_bank, 'quote_bank');
            renderList('list-point-bank', config.point_bank, 'point_bank');
            
            updateBankHighlights();
        }
        
        function setMode(i,k,m){ config.content_pairs[i].modes[k]=m; renderAdminUI(); }
        function updateContent(i,f,v) { config.content_pairs[i][f] = v; }
        function updateCardStruct(i,p,v) { config.content_pairs[i].structure[p]=v; renderAdminUI(); }
        function updateDist(i,di,v){ config.content_pairs[i].distractors[di]=v; }
        function removeDist(i,di){ config.content_pairs[i].distractors.splice(di,1); renderAdminUI(); }
        function addDist(i){ config.content_pairs[i].distractors.push("Wrong Answer"); renderAdminUI(); }
        function delContent(i) { config.content_pairs.splice(i,1); renderAdminUI(); }
        // FIXED UPDATE CONFIG VAL
        function updateConfigVal(k,v) { 
            if(k.includes('settings')) {
                // If the setting is startLevel or streakThreshold, parse as Int.
                // Otherwise (progressionMode, accumulateEssay), keep as String.
                if (k === 'settings.startLevel' || k === 'settings.streakThreshold') {
                    config.settings[k.split('.')[1]] = parseInt(v);
                } else {
                    config.settings[k.split('.')[1]] = v;
                }
            } else {
                config[k] = v;
            }
            
            if(k==='topic') {
                updateDOM(); // Immediate update on typing
            }
            if(k==='gameMode') {
                updateDOM();
                updateBankHighlights();
            }
            if(k==='settings.accumulateEssay') {
                updateDOM();
            }
        }
        function updateWSSetting(k,v) { config.worksheetSettings[k]=v; }
        function updateDefaultStruct() { var n=[]; for(var i=0;i<5;i++) n.push(document.getElementById('def-struct-'+i).value); config.default_structure=n; }
        function applyDefaultStructureToAll() { if(confirm("Apply this structure to ALL questions? This overwrites custom structures.")) { config.content_pairs.forEach(p=>p.structure=JSON.parse(JSON.stringify(config.default_structure))); renderAdminUI(); } }
        function saveLocal(render) { localStorage.setItem(STORE_KEY, JSON.stringify(config)); if(render) { renderAdminUI(); resetGame(); } }
        function triggerSave() { saveLocal(true); alert("Saved!"); }
        function esc(s) { return s?s.toString().replace(/"/g,'&quot;'):""; }
        
        function addItem(t, isAO4) { 
            var v=prompt("Enter text:"); 
            if(v) { 
                if(t==='s1') (isAO4 ? config.ao4_starters : config.starters_evidence).push(v);
                else if(t==='s2') (isAO4 ? config.ao4_markers : config.ao2_methods).push(v);
                else if(t==='s3') (isAO4 ? config.ao4_links : config.starters_evaluative).push(v);
                else if(t==='quote_bank') config.quote_bank.push(v);
                else if(t==='point_bank') config.point_bank.push(v);
                renderAdminUI(); 
            } 
        }
        
        function renderList(id, arr, k) {
            var d=document.getElementById(id); d.innerHTML='';
            if(!arr) return;
            arr.forEach((txt,i)=>{
                var r=document.createElement('div'); r.style.display='flex'; r.style.marginBottom='2px';
                r.innerHTML=`<input value="${esc(txt)}" onchange="updateList('${k}',${i},this.value)" style="width:80%;font-size:0.8rem;border:1px solid #eee"><button onclick="delList('${k}',${i})" style="color:red;border:none;background:none;cursor:pointer">x</button>`;
                d.appendChild(r);
            });
        }
        function updateList(k,i,v){ 
            if(config[k]) config[k][i]=v; 
        }
        function delList(k,i){ 
            if(config[k]) config[k].splice(i,1);
            renderAdminUI(); 
        }

        // --- EXPORT FUNCTION (PAPER GAME) ---
        function getExportHTML() {
            var style = config.worksheetSettings.style || "mcq";
            var h = "<html><head><style>body { font-family: 'Aptos', 'Segoe UI', sans-serif; }</style></head><body>";
            h += "<h1>"+config.topic+"</h1>";
            
            if(config.worksheetSettings.showTask1) {
                h+="<h2>Task 1: Match the Evidence to the Effect</h2>";
                h+="<table border='1' cellspacing='0' cellpadding='10' style='width:100%;border-collapse:collapse; margin-bottom:20px;'>";
                var shuf = [].concat(config.content_pairs).sort(()=>Math.random()-0.5);
                config.content_pairs.forEach((p,i)=>{ h+=`<tr><td style="width:50%">${p.quote}</td><td style="width:50%">${shuf[i].effect}</td></tr>`; });
                h+="</table>";
            }

            if(config.worksheetSettings.showTask2) {
                h+="<h2>Task 2: Build the Evaluation</h2>";
                
                config.content_pairs.forEach((p, idx)=>{
                    h+=`<div style="border:1px solid #333; padding:15px; margin-bottom:20px; page-break-inside:avoid;">`;
                    h+=`<h3>${idx+1}. ${p.title || "Question"}</h3>`;
                    
                    var effectiveStruct = (p.structure && p.structure.length>0) ? p.structure : config.default_structure;
                    var uniqueStruct = [...new Set(effectiveStruct)].filter(k => k !== 'none');
                    var isAO4 = (config.gameMode === "AO4");

                    uniqueStruct.forEach(stepKey => {
                        var scaffoldMode = config.worksheetSettings[stepKey+'_mode'] || "text";
                        var label = getStageLabel(stepKey);
                        var correctText = getSpecificText(stepKey, p, isAO4);
                        
                        h+=`<div style="margin-bottom:10px;"><strong>${label}:</strong><br>`;

                        if (style === "key") {
                            h+=`<span style="color:green; font-weight:bold;">${correctText}</span>`;
                        } else if (style === "blank" || scaffoldMode === "scaffold" || scaffoldMode === "line") {
                            h+=`___________________________________________________________`;
                        } else {
                            var mode = p.modes[stepKey] || 'quiz';
                            var options = [];
                            options.push(correctText);
                            var dists = [];
                            if (mode === 'open') dists = getBankItems(stepKey, isAO4);
                            else dists = getDistractors(stepKey, p, isAO4, correctText, p.id);
                            
                            dists = dists.filter(d => d !== correctText);
                            dists = dists.sort(() => Math.random() - 0.5).slice(0, 3);
                            options = options.concat(dists);
                            options.sort(() => Math.random() - 0.5);

                            h+=`<div style="display:grid; grid-template-columns: 1fr 1fr; gap:5px; margin-top:5px;">`;
                            options.forEach(opt => {
                                h+=`<div style="border:1px solid #ccc; padding:5px;">&#9711; ${opt}</div>`;
                            });
                            h+=`</div>`;
                        }
                        h+=`</div>`;
                    });
                    h+=`</div>`;
                });
            }
            h += "</body></html>";
            return h;
        }
        function printWorksheet() { var w=window.open(); w.document.write(getExportHTML()); w.print(); w.close(); }
        function downloadWordDoc() { var b=new Blob(['\ufeff', "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'><body>"+getExportHTML()+"</body></html>"],{type:'application/msword'}); var a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='worksheet.doc'; a.click(); }
        function exportApp() { var h=document.documentElement.outerHTML.replace(/var defaultData = \{.*?\};/s, "var defaultData = "+JSON.stringify(config)+";"); var b=new Blob([h],{type:'text/html'}); var a=document.createElement('a'); a.href=URL.createObjectURL(b); a.download='evaluation_architect.html'; a.click(); }

    </script>
</body>
</html>
