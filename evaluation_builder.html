<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analysis Builder: Ultimate Edition</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --pink-point: #ff99cc;
            --white-evidence: #ffffff;
            --yellow-method: #ffeb3b;
            --green-explain: #90ee90;
            --app-color: #2c3e50;
            --accent-color: #e74c3c;
            --level-1-color: #3498db;
            --level-2-color: #2ecc71;
            --level-3-color: #9b59b6;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f4f8;
            color: #333;
            margin: 0;
            padding: 20px;
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- HEADER & SCORE --- */
        header {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 10px;
        }
        h1 { margin: 0; color: var(--app-color); font-size: 1.5rem; }
        
        #score-board {
            background: var(--app-color); color: white; padding: 5px 15px; border-radius: 20px;
            font-weight: bold; font-size: 0.9rem; display: flex; gap: 10px; align-items: center;
        }

        .level-badge {
            padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; text-transform: uppercase; color: white;
        }
        
        /* --- GAME UI --- */
        .container {
            flex-grow: 1;
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
            position: relative;
            text-align: center;
            display: flex; flex-direction: column;
        }

        .progress-container {
            width: 100%; background: #ddd; height: 10px; border-radius: 10px; margin: 10px 0 20px 0;
            overflow: hidden;
        }
        .progress-bar { height: 100%; width: 0%; background: var(--accent-color); transition: width 0.3s; }

        .game-section { display: none; animation: fadeIn 0.4s; flex-grow: 1; }
        .game-section.active { display: block; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 20px; }

        button.option-btn {
            padding: 20px; border: none; border-radius: 8px; font-size: 1.1rem; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1); font-weight: bold; transition: transform 0.2s;
            border: 2px solid #e2e8f0; color: #333; position: relative;
        }
        button.option-btn:hover { transform: translateY(-3px); box-shadow: 0 6px 12px rgba(0,0,0,0.15); }

        .btn-pink { background: var(--pink-point); }
        .btn-white { background: var(--white-evidence); }
        .btn-yellow { background: var(--yellow-method); }
        .btn-green { background: var(--green-explain); }

        #final-box {
            background: #f8fafc; border: 3px dashed var(--app-color); padding: 30px; font-size: 1.3rem;
            min-height: 100px; display: flex; align-items: center; justify-content: center; margin-top: 20px;
            line-height: 1.6; border-radius: 10px;
        }

        /* --- OVERLAYS --- */
        #error-overlay, #levelup-overlay {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            flex-direction: column; justify-content: center; align-items: center; z-index: 100; border-radius: 15px;
            text-align: center; color: white;
        }
        
        #error-overlay { background: rgba(231, 76, 60, 0.95); }
        #levelup-overlay { background: rgba(46, 204, 113, 0.95); }

        .shake { animation: shake 0.5s; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* --- ADMIN MODAL --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center;
        }
        .modal-content {
            background: white; width: 90%; max-width: 800px; height: 90%; border-radius: 10px;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .modal-header { padding: 15px; background: #f1f5f9; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; }
        .modal-body { flex-grow: 1; padding: 20px; overflow-y: auto; }
        
        .admin-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; margin-bottom: 5px; }
        .card { border: 1px solid #e2e8f0; padding: 15px; border-radius: 8px; margin-bottom: 15px; background: #fff; position: relative; }
        .del-btn { position: absolute; top: 10px; right: 10px; color: red; background: none; border: none; cursor: pointer; font-weight: bold; }
        
        .toggle-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; background: #eef; padding: 10px; border-radius: 5px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
    </style>
</head>
<body>

    <script id="app-config" type="application/json">
    {
        "appTitle": "The Evaluation Builder",
        "adminPass": "teacher",
        "settings": {
            "startLevel": 1,
            "maxLevel": 3,
            "streakThreshold": 3
        },
        "starters": [
            "The writer clearly shows anger when they use...",
            "The writer creates a hostile tone by choosing...",
            "The writer suggests the BBC is dangerous by saying..."
        ],
        "pairs": [
            {
                "id": "p1",
                "quote": "neighbour from hell",
                "method": "the aggressive metaphor",
                "explanation": "This implies the BBC is impossible to live next to.",
                "distractor": "This suggests the BBC lives in a hot climate."
            },
            {
                "id": "p2",
                "quote": "taken an axe",
                "method": "the violent imagery",
                "explanation": "This suggests they are destroying things deliberately.",
                "distractor": "This shows they are doing gardening work."
            },
            {
                "id": "p3",
                "quote": "state-funded juggernaut",
                "method": "the massive metaphor",
                "explanation": "This implies the BBC is a massive, unstoppable monster.",
                "distractor": "This suggests the BBC has many large trucks."
            }
        ]
    }
    </script>

    <header>
        <div>
            <h1 id="display-title">The Anger Builder</h1>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div id="score-board">
                <span id="level-badge" class="level-badge" style="background:var(--level-1-color)">LEVEL 1</span>
                <span>Streak: <span id="streak-val">0</span>/<span id="target-val">3</span></span>
            </div>
            <button onclick="toggleAdmin()" style="border:none; background:none; font-size:1.5rem; cursor:pointer; color:#ccc;"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div class="container" id="game-ui">
        
        <div id="error-overlay" onclick="this.style.display='none'">
            <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 10px;"></i>
            <h1>TRY AGAIN</h1>
            <p>That doesn't match the evidence!</p>
            <p style="font-size: 0.9rem; margin-top: 20px;">(Click to continue)</p>
        </div>

        <div id="levelup-overlay" onclick="closeLevelUp()">
            <i class="fas fa-arrow-up" style="font-size: 4rem; margin-bottom: 10px; color: yellow;"></i>
            <h1>LEVEL UP!</h1>
            <p id="levelup-msg">You have unlocked the next stage.</p>
            <button class="option-btn btn-white" style="margin-top:20px; color:black;">Continue</button>
        </div>

        <div class="progress-container"><div class="progress-bar" id="bar"></div></div>

        <div id="step-1" class="game-section active">
            <h3>Step 1: Make your Point</h3>
            <p>Choose a sentence starter:</p>
            <div class="grid" id="starters-grid"></div>
        </div>

        <div id="step-2" class="game-section">
            <h3>Step 2: Add Evidence</h3>
            <p>Pick the quote you want to analyze:</p>
            <div class="grid" id="evidence-grid"></div>
        </div>

        <div id="step-method" class="game-section">
            <h3>Step 3: Identify the Terminology</h3>
            <p>What technique is being used?</p>
            <div class="grid" id="method-grid"></div>
        </div>

        <div id="step-explain" class="game-section">
            <h3>Step <span id="explain-step-num">3</span>: Explain It</h3>
            <p>What does this specific quote mean?</p>
            <div class="grid" id="explain-grid"></div>
        </div>

        <div id="step-result" class="game-section">
            <h3 style="color: var(--green-explain)">Analysis Complete!</h3>
            <div id="final-box"></div>
            <button class="option-btn btn-pink" onclick="restartGame()" style="margin-top:20px; width: 100%;">Next Question</button>
        </div>
    </div>

    <div id="admin-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin:0;">Teacher Settings</h2>
                <button onclick="toggleAdmin()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            
            <div id="admin-lock" style="display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%;">
                <p>Enter Password:</p>
                <input type="password" id="admin-pass-input" style="padding:10px; font-size:1.2rem; text-align:center;">
                <button onclick="unlockAdmin()" class="option-btn btn-pink" style="margin-top:10px; padding:10px 30px;">Unlock</button>
                <p style="font-size:0.8rem; color:#999; margin-top:10px;">Default: teacher</p>
            </div>

            <div id="admin-editor" class="modal-body" style="display:none;">
                
                <h3 style="color:var(--app-color); border-bottom:2px solid #eee; padding-bottom:5px;">Game Progression</h3>
                
                <div class="toggle-row">
                    <label style="flex:1;"><strong>Starting Level:</strong></label>
                    <select id="edit-start-lvl" class="admin-input" style="width:auto;" onchange="updateSettings()">
                        <option value="1">Level 1 (Point + Evidence)</option>
                        <option value="2">Level 2 (P + E + Explanation)</option>
                        <option value="3">Level 3 (P + E + Terminology + Exp)</option>
                    </select>
                </div>

                <div class="toggle-row">
                    <label style="flex:1;"><strong>Max Level Cap:</strong><br><small>Prevent students going higher than this.</small></label>
                    <select id="edit-max-lvl" class="admin-input" style="width:auto;" onchange="updateSettings()">
                        <option value="1">Level 1 Only</option>
                        <option value="2">Cap at Level 2</option>
                        <option value="3">Full Access (Level 3)</option>
                    </select>
                </div>

                <div class="toggle-row">
                    <label style="flex:1;"><strong>Correct Answers to Level Up:</strong></label>
                    <input type="number" id="edit-streak" class="admin-input" style="width:60px;" min="1" max="50" onchange="updateSettings()">
                </div>
                
                <hr style="margin: 20px 0; border:0; border-top:1px solid #eee;">

                <div style="margin-bottom: 20px;">
                    <label style="font-weight:bold;">App Title</label>
                    <input id="edit-app-title" class="admin-input" oninput="saveLocal()">
                </div>

                <h3>Content Editor</h3>
                <div id="edit-pairs-list"></div>
                <button onclick="addPair()" style="background:#eee
