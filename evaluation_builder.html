<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluation Architect</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS STYLES --- */
        :root {
            --col-1-pink: #ff99cc; --col-2-yellow: #ffeb3b; --col-3-blue: #85c1e9; --col-4-green: #90ee90;
            --app-color: #2c3e50; --accent-color: #e74c3c;
            --level-1: #3498db; --level-2: #2ecc71; --level-3: #9b59b6;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f4f6f7; 
            color: #333; 
            margin: 0; 
            padding: 20px; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            text-align: center;
        }
        /* HEADER FIX: High Z-Index to ensure Cog is always clickable */
        header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 2px solid #e0e0e0; 
            flex-shrink: 0;
            position: relative;
            z-index: 5000; 
            background-color: #f4f6f7; /* Ensure opaque background */
        }
        h1 { margin: 0; color: var(--app-color); font-size: 1.6rem; }
        
        #score-board { background: var(--app-color); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; display: flex; gap: 15px; align-items: center; }
        .level-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; text-transform: uppercase; color: white; }
        
        .admin-btn { border: none; background: none; font-size: 1.5rem; color: #999; cursor: pointer; }
        .admin-btn:hover { color: var(--app-color); }
        .reset-btn { background: #c0392b; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 10px; }

        .container { 
            flex-grow: 1; 
            max-width: 1000px; 
            width: 100%;
            margin: 0 auto; 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 8px 30px rgba(0,0,0,0.08); 
            padding: 20px; 
            display: flex; 
            flex-direction: column; 
            overflow-y: auto; 
            position: relative;
            z-index: 1;
        }
        
        .progress-track { background: #eee; height: 8px; border-radius: 4px; margin-bottom: 20px; overflow: hidden; flex-shrink: 0; }
        .progress-fill { height: 100%; width: 0%; background: var(--app-color); transition: width 0.4s ease; }
        
        .stage-area { display: none; animation: fadeIn 0.4s; flex-grow: 1; text-align: center; }
        .stage-area.active { display: block; }
        
        h2.stage-title { font-size: 1.4rem; margin-bottom: 5px; color: #444; }
        p.stage-subtitle { color: #777; margin-bottom: 10px; font-style: italic; }
        
        #topic-display { background: #eaf2f8; color: var(--app-color); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; font-size: 1.1rem; border-left: 5px solid var(--level-1); text-align: left; flex-shrink: 0; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
        
        button.choice-btn { padding: 20px; border: 2px solid transparent; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.2s; color: #333; opacity: 0.9; }
        button.choice-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); opacity: 1; }
        
        button.choice-btn.selected { border: 4px solid #333; transform: scale(1.05); opacity: 1; box-shadow: 0 0 15px rgba(0,0,0,0.2); }
        
        .btn-s1 { background: var(--col-1-pink); } .btn-s2 { background: var(--col-2-yellow); } .btn-s3 { background: var(--col-3-blue); } .btn-s4 { background: var(--col-4-green); } .btn-white { background: white; border-color: #ddd; }
        
        #confirm-bar { margin-top:20px; padding-top:15px; border-top:1px solid #eee; display:none; }
        #confirm-btn { background: #27ae60; color: white; padding: 12px 30px; font-size: 1.1rem; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s; margin-left: 10px;}
        #confirm-btn:hover { transform: scale(1.05); }
        
        #back-btn { background: #95a5a6; color: white; padding: 12px 30px; font-size: 1.1rem; border: none; border-radius: 50px; cursor: pointer; font-weight: bold; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: transform 0.2s; }
        #back-btn:hover { transform: scale(1.05); }

        #typing-interface { display: none; flex-direction: column; align-items: center; width: 100%; }
        #typing-input { width: 80%; padding: 15px; font-size: 1.1rem; border: 2px solid #ccc; border-radius: 8px; margin-bottom: 15px; font-family: inherit; resize: vertical; min-height: 80px; }
        #typing-submit { padding: 12px 30px; font-size: 1.1rem; background: var(--app-color); color: white; border: none; border-radius: 6px; cursor: pointer; }
        
        #sentence-builder { margin-top: 20px; padding: 15px; background: #f8f9fa; border: 2px dashed #ccc; border-radius: 8px; min-height: 60px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-wrap: wrap; gap: 5px; flex-shrink: 0; }
        .fragment { padding: 2px 5px; border-radius: 4px; }
        
        /* OVERLAYS */
        #overlay, #levelup-overlay, #win-overlay, #admin-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 2000; justify-content: center; align-items: center; text-align: center; color: white; }
        #overlay { background: rgba(231, 76, 60, 0.95); } 
        #levelup-overlay { background: rgba(46, 204, 113, 0.98); }
        #win-overlay { background: rgba(241, 196, 15, 0.98); color: #333; }
        #admin-modal { background: rgba(0,0,0,0.5); z-index: 6000; color: #333; }
        
        .shake { animation: shake 0.4s; }
        
        .admin-panel { background: white; width: 90%; max-width: 900px; height: 95%; border-radius: 8px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); text-align: left; }
        .panel-header { padding: 15px; background: #eee; display: flex; justify-content: space-between; font-weight: bold; }
        .panel-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .section-box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; }
        .section-title { font-weight: bold; margin-bottom: 10px; display: block; color: var(--app-color); text-transform: uppercase; font-size: 0.8rem; letter-spacing: 1px; }
        .input-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .admin-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; }
        .admin-textarea { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 4px; font-family: inherit; height: 60px; resize: vertical; }
        .del-btn { background: #ffdddd; border: 1px solid #ffaaaa; color: red; cursor: pointer; padding: 5px 10px; border-radius: 4px; white-space: nowrap; }
        .toggle-row { display: flex; align-items: center; gap: 10px; margin-bottom: 10px; background: #eef; padding: 10px; border-radius: 5px; }
        .content-card { background: #fdfdfd; border: 1px solid #ddd; border-left: 5px solid #333; padding: 15px; margin-bottom: 20px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .content-card-header { display: flex; justify-content: space-between; margin-bottom: 15px; font-weight: bold; color: #333; border-bottom:1px solid #eee; padding-bottom:5px;}
        .step-label { font-size: 0.8rem; font-weight: bold; color: #666; display: block; margin-bottom: 3px; }
        .step-sublabel { font-size: 0.75rem; color: #999; font-weight: normal; margin-left: 5px; font-style: italic; }
        .step-1 { border-left: 4px solid var(--col-1-pink); padding-left: 10px; margin-bottom: 10px; }
        .step-2 { border-left: 4px solid var(--col-2-yellow); padding-left: 10px; margin-bottom: 10px; }
        .step-3 { border-left: 4px solid #333; padding-left: 10px; margin-bottom: 10px; }
        .step-4 { border-left: 4px solid var(--col-3-blue); padding-left: 10px; margin-bottom: 10px; }
        .step-5 { border-left: 4px solid var(--col-4-green); padding-left: 10px; margin-bottom: 10px; }
        
        .mode-toggle { 
            display:inline-block; font-size:0.75rem; background:#eee; padding:2px 5px; border-radius:3px; border:1px solid #ccc; cursor:pointer; margin-right:5px;
        }
        .mode-toggle.active { background: #3498db; color:white; border-color:#2980b9; }

        #config-io-area { width: 100%; height: 100px; font-family: monospace; font-size: 0.8rem; padding: 10px; border: 1px solid #ccc; background: #f9f9f9; color: #555; display:block; margin-bottom:10px; }
        #worksheet-area { display: none; }

        /* CSS FIREWORKS */
        @keyframes firework {
            0% { transform: translate(var(--x), var(--initialY)); width: var(--initialSize); opacity: 1; }
            50% { width: 0.5rem; opacity: 1; }
            100% { width: var(--finalSize); opacity: 0; }
        }
        .firework, .firework::before, .firework::after {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            width: 0.5rem; aspect-ratio: 1; background: radial-gradient(circle, #ff0 0.2rem, #0000 0) 50% 0% / 120% 120%, no-repeat;
            animation: firework 2s infinite; pointer-events: none;
        }
        .firework::before { transform: translate(-50%, -50%) rotate(25deg) !important; }
        .firework::after { transform: translate(-50%, -50%) rotate(-37deg) !important; }
    </style>
</head>
<body>

    <header>
        <h1 id="app-title-display">Evaluation Architect</h1>
        <div style="display:flex; gap:15px; align-items:center;">
            <div id="score-board">
                <span id="level-badge" class="level-badge" style="background:var(--level-1)">LEVEL 1</span>
                <span>Streak: <span id="streak-val">0</span>/<span id="target-val">3</span></span>
                <span style="border-left:1px solid #ccc; padding-left:15px;">Score: <span id="score-val" style="font-size:1.2rem; color:#f1c40f;">0</span></span>
            </div>
            <button onclick="forceReset()" class="reset-btn">‚ö† RESET</button>
            <button class="admin-btn" id="cog-btn" onclick="openAdmin()"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div class="container" id="game-container">
        <div id="topic-display">Question: How is the text presented?</div>
        <div class="progress-track"><div class="progress-fill" id="progress-bar"></div></div>
        
        <div id="stage-area" class="stage-area">
            <h2 id="stage-title" class="stage-title">Select Evidence</h2>
            <p id="stage-subtitle" class="stage-subtitle">Instruction goes here</p>
            <div class="grid" id="game-grid"></div>
            <div id="confirm-bar">
                <button id="back-btn" onclick="goBack()">Back</button>
                <button id="confirm-btn" onclick="confirmChoice()">Confirm</button>
            </div>
        </div>
        
        <div id="typing-interface">
            <h2 id="typing-title" class="stage-title">Complete the Sentence</h2>
            <textarea id="typing-input" placeholder="Start typing..."></textarea>
            <button id="typing-submit" onclick="submitTyping()">Next >></button>
        </div>

        <div id="stage-final" class="stage-area">
            <h2 class="stage-title" style="color:green;">Construction Complete!</h2>
            <div style="margin-top:20px;">
                <button class="choice-btn btn-white" style="background:#95a5a6; color:white; margin-right:10px;" onclick="goBackFromFinal()">Review / Edit</button>
                <button class="choice-btn btn-white" onclick="resetGame()">Next Question</button>
            </div>
        </div>
        
        <div id="sentence-builder"><span style="color:#ccc;">Your sentence will appear here...</span></div>
    </div>

    <div id="overlay" onclick="closeOverlay()"><div id="overlay-msg"><i class="fas fa-times-circle" style="font-size:3rem; color:#e74c3c; margin-bottom:15px;"></i><h2>Incorrect</h2><p>Try again.</p></div></div>
    <div id="levelup-overlay" onclick="closeLevelUp()"><div class="overlay-content"><div class="firework"></div><h2 style="margin-top:50px;">LEVEL UP!</h2><p id="levelup-msg"></p><button class="choice-btn btn-white">Continue</button></div></div>
    <div id="win-overlay"><div class="overlay-content"><div style="font-size:5rem;">üèÜ</div><h1>CONGRATULATIONS!</h1><p id="final-score">0</p><button class="choice-btn" onclick="forceReset()">Play Again</button></div></div>

    <div id="admin-modal">
        <div class="admin-panel">
            <div class="panel-header"><span>Teacher Settings</span><button onclick="closeAdmin()" style="border:none; background:none; font-weight:bold; cursor:pointer;">X</button></div>
            <div id="admin-lock" style="height:100%; display:flex; flex-direction:column; justify-content:center; align-items:center;">
                <p>Password:</p> <input type="password" id="admin-pass-input" style="padding:10px;"> <button onclick="unlockAdmin()" style="margin-top:10px; padding:10px;">Unlock</button>
            </div>
            <div id="admin-edit" class="panel-body" style="display:none;">
                <div style="margin-bottom:20px;"><label>Topic</label><input id="edit-topic" class="admin-input" style="width:95%" onchange="updateConfigVal('topic', this.value)"></div>
                <div class="section-box"><button onclick="triggerSave()" id="save-btn" style="background:#3498db; color:white; padding:10px; width:100%;">Save Settings</button></div>
                
                <div class="section-box">
                    <strong>Banks (Manage Global Options)</strong>
                    <div style="margin-top:5px;"><button onclick="addItem('s1')">+ Add Starter</button> <button onclick="addItem('s2')">+ Add Method/Marker</button> <button onclick="addItem('quote_bank')">+ Add Distractor Quote</button> <button onclick="addItem('s3')">+ Add Link</button> <button onclick="addItem('point_bank')">+ Add Distractor Point</button></div>
                </div>

                <div id="list-content"></div>
                
                <div class="section-box">
                    <strong>Game Rules</strong>
                    <div class="toggle-row"><label>Mode</label><select id="edit-gamemode" onchange="updateConfigVal('gameMode', this.value)"><option value="AO2">AO2</option><option value="AO4">AO4</option></select></div>
                    <div class="toggle-row"><label>Start Level</label><select id="edit-start-lvl" onchange="updateConfigVal('settings.startLevel', this.value)"><option value="1">1</option><option value="2">2</option><option value="3">3</option></select></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. DEFAULT DATA ---
        var defaultStructure = ['s1', 's2', 'quote', 's3', 's4'];
        var defaultData = {
            appTitle: "Evaluation Architect", topic: "How is the character presented?", adminPass: "teacher", gameMode: "AO2", 
            settings: { startLevel: 1, maxLevel: 3, streakThreshold: 3 },
            default_structure: defaultStructure, 
            worksheetSettings: { showTask1: true, showTask2: true, s1_mode: "text", s2_mode: "text", quote_mode: "text", s3_mode: "text", s4_mode: "text" },
            starters_evidence: [ "The writer uses", "The author explicitly chooses" ], ao2_methods: ["Metaphor", "Simile"], starters_evaluative: [ "to suggest", "to imply" ],
            ao4_starters: [ "I agree that" ], ao4_markers: [ "However,", "Furthermore," ], ao4_links: [ "evident when" ],
            quote_bank: ["Random Quote 1"], point_bank: ["Random Point 1"],
            content_pairs: [
                { id: "c1", specific_s1: "", quote: "neighbour from hell", method: "metaphor", specific_s3: "", effect: "that the BBC is impossible.", distractors: [], structure: defaultStructure, modes: { s1:'multiple', s2:'multiple', quote:'multiple', s3:'multiple', s4:'multiple' } }
            ]
        };

        var STORE_KEY = 'eval_arch_v89_review'; 
        var config = JSON.parse(JSON.stringify(defaultData));
        var currentQuoteId = null;
        var sentenceParts = { s1: "", s2: "", quote: "", s3: "", s4: "" };
        var gameState = { currentLevel: 1, streak: 0, score: 0, roundScoreAdded: false };
        var currentStageIndex = 0;
        var currentGameStructure = [];
        var currentSelectedOption = null;

        window.onload = function() {
            try {
                var local = localStorage.getItem(STORE_KEY);
                if(local) config = Object.assign({}, defaultData, JSON.parse(local));
            } catch(e) {}
            document.getElementById('admin-modal').style.display = 'none';
            document.getElementById('overlay').style.display = 'none';
            updateDOM();
            setTimeout(renderAdminUI, 10);
        };

        function updateDOM() {
            document.getElementById('topic-display').innerText = "Question: " + config.topic;
            gameState.currentLevel = parseInt(config.settings.startLevel);
            updateScoreBoard();
            resetGame();
        }

        function getStageLabel(key) {
            if(key === 's1') return "Starter";
            if(key === 's2') return "Method/Marker";
            if(key === 'quote') return "Quote";
            if(key === 's3') return "Link";
            if(key === 's4') return "Point";
            return "";
        }

        function resetGame() {
            sentenceParts = { s1: "", s2: "", quote: "", s3: "", s4: "" };
            currentStageIndex = 0; currentQuoteId = null; currentGameStructure = []; currentSelectedOption = null;
            gameState.roundScoreAdded = false;
            updateBuilder();
            renderGameGrid('quote_select_mode'); 
        }

        function loadStage() {
            if(currentStageIndex >= currentGameStructure.length) { finishGame(); return; }
            document.getElementById('confirm-bar').style.display = 'none';
            currentSelectedOption = null;

            var stageKey = currentGameStructure[currentStageIndex];
            
            // --- LEVEL 1 LOGIC: SKIP s2 and s3 ---
            if(gameState.currentLevel === 1) {
                // We keep s1 (Starter), quote, s4 (Point). Skip others.
                if(stageKey !== 's1' && stageKey !== 'quote' && stageKey !== 's4') {
                    // Check if we need to go forward or backward based on current Index vs intended
                    // But simpler: just increment index and recursive call
                    currentStageIndex++; 
                    loadStage(); 
                    return;
                }
            }

            renderGameGrid(stageKey);
        }

        function renderGameGrid(key) {
            hideAllStages();
            document.getElementById('stage-area').style.display = 'block';
            var grid = document.getElementById('game-grid');
            grid.innerHTML = '';

            if(key === 'quote_select_mode') {
                document.getElementById('stage-title').innerText = "Select Evidence";
                document.getElementById('stage-subtitle').innerText = "Start by choosing a quote.";
                config.content_pairs.forEach(p => {
                    var btn = createBtn(p.quote, () => {
                        currentQuoteId = p.id;
                        currentGameStructure = (p.structure && p.structure.length===5) ? p.structure : config.default_structure;
                        currentStageIndex = 0;
                        updateBuilder();
                        loadStage();
                    });
                    btn.classList.add('btn-white');
                    grid.appendChild(btn);
                });
                return;
            }

            document.getElementById('stage-title').innerText = (currentStageIndex + 1) + ". " + getStageLabel(key);
            document.getElementById('stage-subtitle').innerText = "Select the best option.";

            var pair = config.content_pairs.find(p => p.id === currentQuoteId);
            var isAO4 = (config.gameMode === "AO4");
            var mode = pair.modes[key];
            var options = [];

            // GENERATE OPTIONS
            var correctText = "";
            var isBlankAny = false;

            if(key === 'quote') correctText = pair.quote;
            else if(key === 's1') { if(pair.specific_s1) correctText=pair.specific_s1; else isBlankAny=true; }
            else if(key === 's2') { if(pair.method) correctText=pair.method; else if(isAO4) isBlankAny=true; else correctText="Method"; }
            else if(key === 's3') { if(pair.specific_s3) correctText=pair.specific_s3; else isBlankAny=true; }
            else if(key === 's4') correctText = pair.effect;

            if(!isBlankAny) options.push({ txt: correctText, correct: true });

            var dists = [];
            if(key==='quote') dists = config.quote_bank.concat(config.content_pairs.filter(p=>p.id!==currentQuoteId).map(p=>p.quote));
            else if(key==='s4') dists = config.point_bank.concat(pair.distractors || []);
            else if(key==='s1') dists = isAO4 ? config.ao4_starters : config.starters_evidence;
            else if(key==='s2') dists = isAO4 ? config.ao4_markers : config.ao2_methods;
            else if(key==='s3') dists = isAO4 ? config.ao4_links : config.starters_evaluative;

            if(isBlankAny) {
                dists.sort(()=>Math.random()-0.5);
                for(var i=0; i<4 && i<dists.length; i++) options.push({ txt: dists[i], correct: true });
            } else {
                dists = dists.filter(t=>t!==correctText);
                dists.sort(()=>Math.random()-0.5);
                for(var i=0; i<3 && i<dists.length; i++) options.push({ txt: dists[i], correct: false });
            }

            options.sort(()=>Math.random()-0.5);
            // Dedup
            var seen=new Set(); var final=[];
            options.forEach(o=>{if(!seen.has(o.txt)){seen.add(o.txt); final.push(o);}});

            final.forEach(opt => {
                var btn = createBtn(opt.txt, function() { selectOption(this, opt, key); });
                var cls = key==='s1'?'btn-s1':key==='s2'?'btn-s2':key==='s3'?'btn-s3':'btn-s4';
                if(key==='quote') cls='btn-white';
                btn.classList.add(cls);
                grid.appendChild(btn);
            });
        }

        function selectOption(btn, opt, key) {
            document.querySelectorAll('#game-grid .choice-btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            sentenceParts[key] = key==='quote'?`"${opt.txt}"`:opt.txt;
            updateBuilder();
            currentSelectedOption = opt;
            document.getElementById('confirm-bar').style.display = 'block';
        }

        function confirmChoice() {
            if(!currentSelectedOption) return;
            if(currentSelectedOption.correct) { advanceStage(); } else { showError(); }
        }

        function goBack() {
            currentStageIndex--;
            // If going back lands us on a skipped stage (in Level 1), keep going back
            if(gameState.currentLevel === 1) {
                // simple check loop
                while(currentStageIndex >= 0) {
                    var k = currentGameStructure[currentStageIndex];
                    if(k === 's1' || k === 'quote' || k === 's4') break; // valid
                    currentStageIndex--;
                }
            }
            
            if(currentStageIndex < 0) resetGame();
            else loadStage();
        }

        function goBackFromFinal() {
            // Find last valid stage
            currentStageIndex = currentGameStructure.length - 1;
            if(gameState.currentLevel === 1) {
                while(currentStageIndex >= 0) {
                    var k = currentGameStructure[currentStageIndex];
                    if(k === 's1' || k === 'quote' || k === 's4') break;
                    currentStageIndex--;
                }
            }
            loadStage();
        }

        function finishGame() {
            if(!gameState.roundScoreAdded) {
                var pts = 2 * Math.pow(2, gameState.currentLevel - 1);
                gameState.score += pts;
                gameState.streak++;
                gameState.roundScoreAdded = true;
                updateScoreBoard();
                if(gameState.streak >= config.settings.streakThreshold && gameState.currentLevel < config.settings.maxLevel) {
                    showLevelUp(pts); return; 
                }
            }
            hideAllStages();
            document.getElementById('stage-final').style.display = 'block';
        }

        // --- HELPERS ---
        function createBtn(t, click) { var b=document.createElement('button'); b.className='choice-btn'; b.innerHTML=t; b.onclick=click; return b; }
        function advanceStage() { currentStageIndex++; loadStage(); }
        function updateBuilder() {
            var h=""; 
            var s = (currentGameStructure.length>0)?currentGameStructure:config.default_structure;
            s.forEach(k=>{
                if(sentenceParts[k]) {
                    var c = k==='s1'?'var(--col-1-pink)':k==='s2'?'var(--col-2-yellow)':k==='quote'?'white':k==='s3'?'var(--col-3-blue)':'var(--col-4-green)';
                    h+=`<span class="fragment" style="background:${c}">${sentenceParts[k]}</span> `;
                }
            });
            document.getElementById('sentence-builder').innerHTML=h||"...";
        }
        function hideAllStages() { document.getElementById('stage-area').style.display='none'; document.getElementById('typing-interface').style.display='none'; document.getElementById('stage-final').style.display='none'; }
        function updateScoreBoard() { document.getElementById('score-val').innerText=gameState.score; document.getElementById('streak-val').innerText=gameState.streak+"/"+config.settings.streakThreshold; document.getElementById('level-badge').innerText="LEVEL "+gameState.currentLevel; }
        function closeLevelUp() { gameState.currentLevel++; gameState.streak=0; document.getElementById('levelup-overlay').style.display='none'; updateScoreBoard(); resetGame(); }
        function showLevelUp(p) { document.getElementById('levelup-overlay').style.display='flex'; document.getElementById('levelup-msg').innerText=`+${p}`; }
        function showError() { var o=document.getElementById('overlay'); o.style.display='flex'; gameState.streak=0; updateScoreBoard(); }
        function closeOverlay() { document.getElementById('overlay').style.display='none'; }
        
        // --- ADMIN ---
        function renderAdminUI() {
            var list = document.getElementById('list-content'); list.innerHTML = '';
            config.content_pairs.forEach((p, i) => {
                var div = document.createElement('div'); div.className='content-card';
                div.innerHTML = `<div class="content-card-header">Set #${i+1} <button class="del-btn" onclick="delContent(${i})">Delete</button></div>
                <div class="step-1"><span class="step-label">1. Starter</span><input class="admin-input" value="${esc(p.specific_s1)}" onchange="updateContent(${i},'specific_s1',this.value)"></div>
                <div class="step-2"><span class="step-label">2. Method</span><input class="admin-input" value="${esc(p.method)}" onchange="updateContent(${i},'method',this.value)"></div>
                <div class="step-3"><span class="step-label">3. Quote</span><textarea class="admin-textarea" onchange="updateContent(${i},'quote',this.value)">${esc(p.quote)}</textarea></div>
                <div class="step-4"><span class="step-label">4. Link</span><input class="admin-input" value="${esc(p.specific_s3)}" onchange="updateContent(${i},'specific_s3',this.value)"></div>
                <div class="step-5"><span class="step-label">5. Point</span><textarea class="admin-textarea" onchange="updateContent(${i},'effect',this.value)">${esc(p.effect)}</textarea></div>`;
                list.appendChild(div);
            });
        }
        function updateContent(i,f,v) { config.content_pairs[i][f] = v; }
        function delContent(i) { config.content_pairs.splice(i,1); renderAdminUI(); }
        function addContent() { config.content_pairs.push({id:"c"+Date.now(), specific_s1:"", quote:"New", method:"", specific_s3:"", effect:"", structure: defaultStructure, modes:{s1:'multiple',s2:'multiple',quote:'multiple',s3:'multiple',s4:'multiple'}}); renderAdminUI(); }
        function updateConfigVal(k,v) { if(k.includes('settings')) config.settings[k.split('.')[1]]=parseInt(v); else config[k]=v; if(k==='gameMode') resetGame(); }
        function saveLocal(render) { localStorage.setItem(STORE_KEY, JSON.stringify(config)); if(render) { renderAdminUI(); resetGame(); } }
        function triggerSave() { saveLocal(true); alert("Saved!"); }
        function unlockAdmin() { if(document.getElementById('admin-pass-input').value===config.adminPass) { document.getElementById('admin-lock').style.display='none'; document.getElementById('admin-edit').style.display='block'; renderAdminUI(); } else alert("Wrong Password"); }
        function esc(s) { return s?s.toString().replace(/"/g,'&quot;'):""; }
        function forceReset() { if(confirm("Reset?")) { localStorage.removeItem(STORE_KEY); window.location.reload(); }}
        function addItem(t) { var v=prompt("Enter text:"); if(v) { if(t=='s1')(config.gameMode=='AO4'?config.ao4_starters:config.starters_evidence).push(v); else if(t=='s4')config.point_bank.push(v); } }
    </script>
</body>
</html>
