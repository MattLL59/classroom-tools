<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluation Architect</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    
    <script>
        // --- 1. ROBUST DEFAULT DATA ---
        var defaultData = {
            appTitle: "Evaluation Architect",
            topic: "How is the character presented?",
            adminPass: "teacher",
            settings: { startLevel: 1, maxLevel: 3, streakThreshold: 3 },
            worksheetSettings: {
                showTask1: true, showTask2: true,
                s1_mode: "text", s2_mode: "text", quote_mode: "text", s3_mode: "text", s4_mode: "text"
            },
            starters_evidence: [ "The writer uses", "The author explicitly chooses", "The text presents" ],
            starters_evaluative: [ "to effectively suggest", "in order to imply", "which creates the impression" ],
            content_pairs: [
                { id: "c1", specific_s1: "", quote: "neighbour from hell", method: "the aggressive metaphor", specific_s3: "", effect: "that the BBC is impossible to live alongside.", distractor: "that the BBC lives in a hot place." },
                { id: "c2", specific_s1: "", quote: "taken an axe", method: "the violent imagery", specific_s3: "", effect: "that they are destroying local news deliberately.", distractor: "that they are doing some gardening." }
            ]
        };

        var STORE_KEY = 'eval_arch_v67_fixed'; 
        var config = JSON.parse(JSON.stringify(defaultData));
        var currentQuoteId = null;
        var sentenceParts = { s1: "", s2: "", quote: "", s3: "", s4: "" };
        var gameState = { currentLevel: 1, streak: 0 };
        var currentTypingStage = "";

        // --- 2. INIT ---
        function init() {
            try {
                var local = localStorage.getItem(STORE_KEY);
                if(local) {
                    var saved = JSON.parse(local);
                    config = Object.assign({}, defaultData, saved);
                    if(saved.settings) config.settings = Object.assign({}, defaultData.settings, saved.settings);
                    if(saved.worksheetSettings) config.worksheetSettings = Object.assign({}, defaultData.worksheetSettings, saved.worksheetSettings);
                }
            } catch(e) {
                console.log("Load error, using defaults.");
                config = JSON.parse(JSON.stringify(defaultData));
            }

            // SAFETY: Restore if empty
            if(!config.content_pairs || config.content_pairs.length === 0) {
                config.content_pairs = JSON.parse(JSON.stringify(defaultData.content_pairs));
            }
            
            updateDOM();
            renderAdminUI();
        }

        function updateDOM() {
            document.getElementById('app-title-display').innerText = config.appTitle;
            document.getElementById('topic-display').innerText = "Question: " + config.topic;
            document.title = config.appTitle;
            gameState.currentLevel = parseInt(config.settings.startLevel);
            updateScoreBoard();
            renderStage0();
        }

        // --- 3. DOM HELPERS ---
        function getSafeVal(id) { var el = document.getElementById(id); return el ? el.value : ""; }
        function getSafeCheck(id) { var el = document.getElementById(id); return el ? el.checked : false; }
        function safeSetVal(id, val) { var el = document.getElementById(id); if(el) el.value = val; }
        function safeSetCheck(id, val) { var el = document.getElementById(id); if(el) el.checked = val; }
        function esc(str) { 
            if(str === null || str === undefined) return "";
            return str.toString().replace(/"/g, '&quot;'); 
        }

        // --- 4. CORE FUNCTIONS ---
        function forceReset() {
            if(confirm("Factory Reset: This will wipe all saved data and reload.")) {
                localStorage.removeItem(STORE_KEY);
                window.location.reload();
            }
        }

        function saveLocal(render) {
            if(render === undefined) render = true;
            try {
                if(document.getElementById('admin-modal').style.display === 'flex') {
                    updateSettingsFromUI();
                }
                
                localStorage.setItem(STORE_KEY, JSON.stringify(config));
                
                document.getElementById('app-title-display').innerText = config.appTitle;
                document.getElementById('topic-display').innerText = "Question: " + config.topic;
                
                if(document.getElementById('config-io-area')) {
                    document.getElementById('config-io-area').value = JSON.stringify(config);
                }

                if(render) {
                    renderAdminUI();
                    // FORCE RESET GAME TO SHOW NEW CONTENT IMMEDIATELY
                    resetGame(); 
                }
            } catch(e) {
                alert("Error saving: " + e.message);
            }
        }

        function updateSettingsFromUI() {
            config.appTitle = getSafeVal('edit-app-title');
            config.adminPass = getSafeVal('edit-admin-pass');
            config.topic = getSafeVal('edit-topic');
            
            var el;
            if(el = document.getElementById('edit-start-lvl')) config.settings.startLevel = parseInt(el.value);
            if(el = document.getElementById('edit-max-lvl')) config.settings.maxLevel = parseInt(el.value);
            if(el = document.getElementById('edit-streak')) config.settings.streakThreshold = parseInt(el.value);

            if(document.getElementById('ws-task1')) config.worksheetSettings.showTask1 = document.getElementById('ws-task1').checked;
            if(document.getElementById('ws-task2')) config.worksheetSettings.showTask2 = document.getElementById('ws-task2').checked;
            
            if(el = document.getElementById('s1-mode')) config.worksheetSettings.s1_mode = el.value;
            if(el = document.getElementById('s2-mode')) config.worksheetSettings.s2_mode = el.value;
            if(el = document.getElementById('quote-mode')) config.worksheetSettings.quote_mode = el.value;
            if(el = document.getElementById('s3-mode')) config.worksheetSettings.s3_mode = el.value;
            if(el = document.getElementById('s4-mode')) config.worksheetSettings.s4_mode = el.value;
        }

        window.onload = init;
    </script>

    <style>
        /* CSS STYLES */
        :root {
            --col-1-pink: #ff99cc; --col-2-yellow: #ffeb3b; --col-3-blue: #85c1e9; --col-4-green: #90ee90;
            --app-color: #2c3e50; --accent-color: #e74c3c;
            --level-1: #3498db; --level-2: #2ecc71; --level-3: #9b59b6;
        }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f4f6f7; color: #333; margin: 0; padding: 20px; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0; }
        h1 { margin: 0; color: var(--app-color); font-size: 1.6rem; }
        #score-board { background: var(--app-color); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; display: flex; gap: 10px; align-items: center; }
        .level-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; text-transform: uppercase; color: white; }
        .admin-btn { border: none; background: none; font-size: 1.5rem; color: #999; cursor: pointer; }
        .admin-btn:hover { color: var(--app-color); }
        .reset-btn { background: #c0392b; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-right: 10px; }
        .container { flex-grow: 1; max-width: 1000px; margin: 0 auto; background: white; border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); padding: 20px; display: flex; flex-direction: column; overflow-y: auto; }
        .progress-track { background: #eee; height: 8px; border-radius: 4px; margin-bottom: 20px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; background: var(--app-color); transition: width 0.4s ease; }
        .stage-area { display: none; animation: fadeIn 0.4s; flex-grow: 1; text-align: center; }
        .stage-area.active { display: block; }
        h2.stage-title { font-size: 1.4rem; margin-bottom: 5px; color: #444; }
        p.stage-subtitle { color: #777; margin-bottom: 20px; font-style: italic; }
        #topic-display { background: #eaf2f8; color: var(--app-color); padding: 15px; border-radius: 8px; margin-bottom: 20px; font-weight: bold; font-size: 1.1rem; border-left: 5px solid var(--level-1); text-align: left; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
        button.choice-btn { padding: 20px; border: 2px solid transparent; border-radius: 10px; font-size: 1.1rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.2s; color: #333; }
        button.choice-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 15px rgba(0,0,0,0.1); }
        .btn-s1 { background: var(--col-1-pink); } .btn-s2 { background: var(--col-2-yellow); } .btn-s3 { background: var(--col-3-blue); } .btn-s4 { background: var(--col-4-green); } .btn-white { background: white; border
