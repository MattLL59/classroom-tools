<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tone & Structure Architect v5.1 (Stable)</title>
<style>
    /* --- 1. CSS VARIABLES & RESET --- */
    :root {
        --primary: #009688; --accent: #ff9800; 
        --bg: #f0f2f5; --card: #ffffff; --text: #37474f; 
        --border: #cfd8dc; --success: #4caf50; --error: #f44336;
        --tone-color: #9c27b0; --struct-color: #2196f3; --lang-color: #43a047;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s, color 0.3s; }

    /* --- 2. HEADER --- */
    header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--card); box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; flex-shrink: 0; border-bottom: 1px solid var(--border); }
    h1 { margin: 0; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; font-weight: 800; }
    .score-badge { background: var(--accent); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; }
    .header-controls { display: flex; gap: 8px; align-items: center; }
    .icon-btn { background: none; border: 1px solid var(--border); border-radius: 4px; font-size: 1.2rem; cursor: pointer; padding: 4px 8px; transition: background 0.2s; color: var(--text); }
    .icon-btn:hover { background: rgba(0,0,0,0.05); }
    select.level-select { padding: 5px; border-radius: 4px; border: 1px solid var(--border); font-weight: bold; color: var(--text); background: var(--card); }

    /* --- 3. MAIN LAYOUT --- */
    .viewport { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; scroll-behavior: smooth; }
    .hub { display: none; animation: fadeIn 0.3s ease-out; }
    .hub.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* --- 4. CARDS & GRID --- */
    .section-header { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text); opacity: 0.7; margin: 20px 0 10px 0; border-bottom: 2px solid var(--border); padding-bottom: 5px; font-weight: bold; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; }
    .card { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; position: relative; transition: transform 0.1s; overflow: hidden; }
    .card:hover { transform: translateY(-2px); border-color: var(--primary); }
    .card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; }
    .card-tone::before { background: var(--tone-color); }
    .card-structure::before { background: var(--struct-color); }
    .card-language::before { background: var(--lang-color); }
    .card-global { border-left: 5px solid #607d8b; }
    .quote-text { font-family: 'Georgia', serif; font-style: italic; font-size: 1.05rem; color: var(--text); display: block; margin-bottom: 8px; }
    .card-meta { display: flex; justify-content: space-between; font-size: 0.75rem; text-transform: uppercase; font-weight: bold; opacity: 0.6; }

    /* --- 5. WRITING DESK --- */
    .builder-area { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
    .slot-row { margin-bottom: 10px; }
    .slot-label { font-size: 0.75rem; font-weight: 700; color: var(--primary); text-transform: uppercase; display: block; margin-bottom: 3px; }
    .slot-select, .slot-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 1rem; background: var(--bg); color: var(--text); }
    .slot-static { background: rgba(0, 150, 136, 0.1); color: var(--primary); padding: 10px; border-radius: 4px; font-style: italic; border: 1px solid var(--border); }
    .preview-box { padding: 15px; background: var(--card); border: 2px dashed var(--accent); border-radius: 8px; font-size: 1.1rem; line-height: 1.5; min-height: 60px; margin-bottom: 15px; color: var(--text); }
    textarea.essay-area { width: 100%; height: 200px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical; margin-bottom: 10px; background: var(--card); color: var(--text); }

    /* --- 6. BUTTONS & UI --- */
    .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 5px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-accent { background: var(--accent); color: white; }
    .btn-doc { background: #1565c0; color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--error); color: white; }
    .btn-outline { background: var(--card); border: 2px solid var(--border); color: var(--text); }
    .btn-small { padding: 4px 8px; font-size: 0.8rem; width: auto; margin: 0; }
    .filter-bar { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; }
    .filter-btn { flex: 1; min-width: 80px; padding: 8px; font-size: 0.85rem; }
    .filter-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(0, 150, 136, 0.08); }

    /* --- 7. MODALS & ADMIN --- */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .modal.open { display: flex; }
    .modal-content { background: var(--bg); width: 95%; max-width: 900px; max-height: 95vh; border-radius: 10px; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden; color: var(--text); }
    .modal-header { padding: 15px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.1rem; }
    .modal-body { padding: 20px; overflow-y: auto; }
    
    .admin-section { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 15px; margin-bottom: 15px; }
    .admin-h { color: var(--primary); margin: 0 0 10px 0; font-size: 1rem; border-bottom: 1px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
    .input-group { margin-bottom: 10px; }
    .input-group label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 3px; }
    .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); }
    
    .quote-editor, .struct-editor { border: 1px solid var(--border); border-radius: 6px; padding: 10px; margin-bottom: 10px; background: var(--bg); }
    .editor-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; margin-bottom: 8px; opacity: 0.8; font-size: 0.9rem; }
    .level-checks { display: flex; gap: 10px; margin-top: 5px; font-size: 0.85rem; align-items: center; }
    .level-checks label { display: flex; align-items: center; gap: 4px; cursor: pointer; }
    .level-checks input { margin: 0; }
    
    .level-rule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 6px; margin-top: 6px; }
    .level-rule-grid input, .level-rule-grid select { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); }
    
    .bank-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
    .bank-tag { background: rgba(0,0,0,0.05); border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
    .bank-tag button { background: none; border: none; color: var(--error); cursor: pointer; font-weight: bold; }
    .bank-btn-grid { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
    .bank-btn-grid button { flex: 1; min-width: 80px; font-size: 0.85rem; padding: 6px; }

    /* Guide Section */
    .guide-box { background: rgba(255, 152, 0, 0.1); border: 1px solid var(--accent); border-radius: 6px; padding: 10px; margin-bottom: 15px; }
    .guide-box summary { font-weight: bold; cursor: pointer; color: var(--accent); list-style: none; display: flex; align-items: center; gap: 5px; }
    .guide-box summary::-webkit-details-marker { display: none; }
    .guide-box summary::before { content: 'üìñ'; }
    .guide-content { margin-top: 10px; font-size: 0.9rem; line-height: 1.5; opacity: 0.9; }
    .guide-content h4 { margin: 10px 0 5px 0; color: var(--primary); }

    /* --- 8. UTILS & NAV --- */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; z-index: 900; }
    .nav-item { flex: 1; background: none; border: none; color: var(--text); opacity: 0.5; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
    .nav-item.active { color: var(--primary); opacity: 1; background: rgba(0, 150, 136, 0.05); }
    .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
    .nav-label { font-size: 0.7rem; font-weight: 700; }
    
    .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    .hidden { display: none !important; }
    
    .theme-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; }
    input[type="color"] { border: none; width: 40px; height: 40px; cursor: pointer; background: none; }

    @media print { .no-print { display: none; } }
    
    .celebration { position: fixed; inset: 0; background: rgba(12, 24, 28, 0.92); z-index: 2500; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; text-align: center; }
    .celebration.hidden { display: none; }
    .celebration-inner { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; max-width: 320px; width: 90%; }
    .celebration-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 8px; }
    .celebration-confetti { position: absolute; inset: 0; overflow: hidden; pointer-events: none; }
    .celebration-emoji { position: absolute; font-size: 1.6rem; animation: floatDown 2.5s linear infinite; opacity: 0.9; }
    @keyframes floatDown { from { transform: translateY(-10vh) rotate(0deg); } to { transform: translateY(110vh) rotate(360deg); } }

    #emergency-reset { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; background: #d32f2f; color: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); text-align: center; display: none; }
</style>
</head>
<body>

    <div id="save-status" style="position:fixed; top:10px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.8); color:white; padding:5px 15px; border-radius:20px; font-size:0.8rem; opacity:0; transition:0.3s; z-index:3000;">üíæ Saved</div>

    <div id="emergency-reset">
        <h2>‚ö†Ô∏è App Crashed</h2>
        <p>The loaded data was corrupted.</p>
        <button class="btn btn-outline" style="background:white; color:black; margin-top:10px;" onclick="localStorage.clear(); location.reload();">Emergency Reset</button>
    </div>

    <div id="celebration-overlay" class="celebration hidden">
        <div class="celebration-confetti" id="celebration-confetti"></div>
        <div class="celebration-inner">
            <div class="celebration-title" id="celebration-title">Level Complete! üéâ</div>
            <div id="celebration-sub" style="margin-bottom:15px; color:#cfd8dc;">Great work!</div>
            <button class="btn btn-primary" id="celebration-btn" onclick="ui.closeCelebration()">Continue</button>
        </div>
    </div>

    <header class="no-print">
        <h1>
            <button class="icon-btn" onclick="app.resetSession()" style="color:red; border-color:red;" title="Reset Session">‚ú®</button>
            Tone & Structure
            <span class="score-badge" id="score-display">0 XP</span>
        </h1>
        <div class="header-controls">
            <button class="icon-btn" onclick="ui.openModal('modal-help')">‚ùì</button>
            <button class="icon-btn" onclick="ui.openModal('modal-theme')" title="Colors">üé®</button>
            <select id="level-selector" class="level-select" onchange="app.setLevel(this.value)">
                <option value="1">Lvl 1</option>
                <option value="2">L2</option>
                <option value="3">L3</option>
            </select>
            <button class="icon-btn" id="btn-admin" onclick="ui.openAdmin()">‚öôÔ∏è</button>
        </div>
    </header>

    <div class="viewport no-print">
        
        <div id="view-lab" class="hub active">
            <div style="display:flex; justify-content:space-between; align-items:center; background:var(--card); padding:10px; border-bottom:1px solid var(--border);">
                <div><strong>Topic:</strong> <span id="lbl-title">...</span></div>
                <button class="btn btn-outline" style="width:auto; padding:5px 10px;" onclick="ui.openModal('modal-source')">üìÑ View Text</button>
            </div>
            
            <div style="padding:10px;">
                <div class="filter-bar">
                    <button class="btn btn-outline filter-btn" data-filter="all" onclick="app.setFilter('all')">All</button>
                    <button class="btn btn-outline filter-btn" data-filter="language" onclick="app.setFilter('language')">Lang</button>
                    <button class="btn btn-outline filter-btn" data-filter="structure" onclick="app.setFilter('structure')">Struct</button>
                    <button class="btn btn-outline filter-btn" data-filter="tone" onclick="app.setFilter('tone')">Tone</button>
                    <button class="btn btn-outline filter-btn" id="btn-show-done" onclick="app.toggleDone()">Show Done</button>
                </div>

                <div id="quote-grid" class="grid"></div>
                
                <div class="section-header" style="margin-top:20px;">Global Analysis</div>
                <div id="global-card-container"></div>
            </div>
        </div>

        <div id="view-desk" class="hub">
            <div style="padding:15px;">
                <div class="section-header" style="margin-top:0;">Sentence Construction</div>
                <div id="sentence-builder" class="builder-area">
                    <div style="text-align:center; opacity:0.6; padding:20px;">Select a quote in the Evidence Lab to start.</div>
                </div>

                <div class="section-header">Preview & Edit</div>
                <div id="preview-box" class="preview-box" contenteditable="true"></div>
                
                <div style="display:grid; grid-template-columns:1fr 2fr; gap:10px; margin-bottom:20px;">
                    <button class="btn btn-accent" onclick="app.undo()">Undo</button>
                    <button class="btn btn-primary" onclick="app.commitSentence()">Commit to Answer ‚¨á</button>
                </div>

                <textarea id="essay-area" class="essay-area" placeholder="Your answer will appear here..." oninput="app.updateEssay(this.value)"></textarea>
                
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-doc" onclick="app.exportDoc()">Download .doc</button>
                    <button class="btn btn-danger" onclick="app.clearEssay()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav no-print">
        <button class="nav-item active" onclick="ui.switchView('lab')" id="nav-lab">
            <span class="nav-icon">üß™</span><span class="nav-label">Evidence Lab</span>
        </button>
        <button class="nav-item" onclick="ui.switchView('desk')" id="nav-desk">
            <span class="nav-icon">‚úçÔ∏è</span><span class="nav-label">Writing Desk</span>
        </button>
    </nav>

    <div id="modal-source" class="modal">
        <div class="modal-content">
            <div class="modal-header">Source Text <button class="icon-btn" onclick="ui.closeModal('modal-source')">‚úï</button></div>
            <div class="modal-body"><div id="source-content" style="white-space:pre-wrap; line-height:1.6; font-size:1.1rem; font-family:'Georgia';"></div></div>
        </div>
    </div>

    <div id="modal-wizard" class="modal">
        <div class="modal-content">
            <div class="modal-header"><span id="wizard-title">Analysis</span> <button class="icon-btn" onclick="ui.closeModal('modal-wizard')">‚úï</button></div>
            <div class="modal-body">
                <div id="wizard-prompt" style="margin-bottom:15px;"></div>
                <div id="wizard-options" class="grid"></div>
            </div>
        </div>
    </div>

    <div id="modal-help" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">Student Help <button class="icon-btn" onclick="ui.closeModal('modal-help')">‚úï</button></div>
            <div class="modal-body">
                <p><strong>1. Evidence Lab:</strong> Read the source text. Click on colored quote cards to analyze them. Correct answers earn XP.</p>
                <hr>
                <p><strong>2. Writing Desk:</strong> Use the dropdown menus to build professional analytical sentences. You can edit the text manually before adding it to your final essay.</p>
            </div>
        </div>
    </div>

    <div id="modal-theme" class="modal">
        <div class="modal-content" style="max-width:350px;">
            <div class="modal-header">Theme Colors <button class="icon-btn" onclick="ui.closeModal('modal-theme')">‚úï</button></div>
            <div class="modal-body">
                <div class="theme-row"><span>Background:</span> <input type="color" id="col-bg" onchange="ui.setTheme('bg', this.value)"></div>
                <div class="theme-row"><span>Text Color:</span> <input type="color" id="col-text" onchange="ui.setTheme('text', this.value)"></div>
                <div class="theme-row"><span>Card Color:</span> <input type="color" id="col-card" onchange="ui.setTheme('card', this.value)"></div>
                <hr>
                <button class="btn btn-outline" onclick="ui.resetTheme()">Reset to Defaults</button>
            </div>
        </div>
    </div>

    <div id="modal-admin" class="modal">
        <div class="modal-content">
            <div class="modal-header">Teacher Settings <button class="icon-btn" onclick="ui.closeModal('modal-admin')">‚úï</button></div>
            <div class="modal-body">
                
                <details class="guide-box" open>
                    <summary>Teacher Guide (Click to collapse)</summary>
                    <div class="guide-content">
                        <h4>ü§ñ AI Lesson Generator (Important)</h4>
                        <ol style="padding-left:20px; margin:0;">
                            <li>Paste your Source Text and Focus Question below.</li>
                            <li>Click <strong>Generate Prompt</strong>.</li>
                            <li><strong>Copy the generated prompt text.</strong></li>
                            <li>Paste it into ChatGPT, Claude, or Gemini.</li>
                            <li>Copy the <strong>JSON code</strong> the AI gives you.</li>
                            <li>Paste that JSON into the box below and click <strong>Load Data</strong>.</li>
                        </ol>
                        <h4>‚öôÔ∏è Structure & Banks</h4>
                        <p>Customize the sentence builders for Levels 1-3. Select 'point' to use AI-generated analysis points.</p>
                        <h4>üìÑ Worksheet</h4>
                        <p>Exports a Word doc with 'Match the Meaning' and 'Analysis' sections.</p>
                    </div>
                </details>

                <div class="admin-section" style="background:rgba(33, 150, 243, 0.1); border-color:#2196f3;">
                    <h3 class="admin-h" style="color:#1565c0;">ü§ñ AI Lesson Generator</h3>
                    <div class="input-group">
                        <label>Lesson Focus / Question</label>
                        <input type="text" id="ai-question" placeholder="e.g. How is tension created?" style="border:2px solid #2196f3;">
                    </div>
                    <div class="input-group">
                        <label>Source Text</label>
                        <textarea id="ai-input" style="height:60px; width:100%; border:1px solid #ccc;" placeholder="Paste text here..."></textarea>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1"><label style="font-size:0.8rem">Mode</label><select id="ai-mode" style="width:100%; padding:5px;"><option value="replace">Replace All</option><option value="append">Append</option></select></div>
                        <div style="width:80px"><label style="font-size:0.8rem">Quotes</label><input type="number" id="ai-count" value="6" min="1" max="20" style="width:100%; padding:5px;"></div>
                    </div>
                    <div class="input-group">
                        <label>Levels Included</label>
                        <div class="level-checks" style="margin-top:0;">
                            <label>1<input type="checkbox" id="ai-level-1" checked></label>
                            <label>2<input type="checkbox" id="ai-level-2" checked></label>
                            <label>3<input type="checkbox" id="ai-level-3" checked></label>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Level 1 Rules (Below GCSE Pass)</label>
                        <div class="level-rule-grid">
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Count</label>
                                <input type="number" id="ai-l1-count" min="0" placeholder="L1 count">
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Max words</label>
                                <input type="number" id="ai-l1-words" min="3" value="12" placeholder="Max words">
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Complexity</label>
                                <select id="ai-l1-complex">
                                    <option value="very simple">Very simple</option>
                                    <option value="simple">Simple</option>
                                    <option value="medium">Medium</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Subtlety</label>
                                <select id="ai-l1-subtle">
                                    <option value="obvious">Obvious distractors</option>
                                    <option value="medium">Medium subtlety</option>
                                    <option value="subtle">Subtle</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Ellipses if &gt;</label>
                                <input type="number" id="ai-l1-ellipsis" min="3" value="7" placeholder="Words">
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Level 2 Rules (GCSE 3-4)</label>
                        <div class="level-rule-grid">
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Count</label>
                                <input type="number" id="ai-l2-count" min="0" placeholder="L2 count">
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Max words</label>
                                <input type="number" id="ai-l2-words" min="3" value="20" placeholder="Max words">
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Complexity</label>
                                <select id="ai-l2-complex">
                                    <option value="simple">Simple</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="advanced">Advanced</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Subtlety</label>
                                <select id="ai-l2-subtle">
                                    <option value="obvious">Obvious distractors</option>
                                    <option value="medium" selected>Medium subtlety</option>
                                    <option value="subtle">Subtle</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Ellipses if &gt;</label>
                                <input type="number" id="ai-l2-ellipsis" min="3" value="7" placeholder="Words">
                            </div>
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Level 3 Rules (GCSE 4+)</label>
                        <div class="level-rule-grid">
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Count</label>
                                <input type="number" id="ai-l3-count" min="0" placeholder="L3 count">
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Max words</label>
                                <input type="number" id="ai-l3-words" min="3" value="30" placeholder="Max words">
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Complexity</label>
                                <select id="ai-l3-complex">
                                    <option value="medium">Medium</option>
                                    <option value="advanced" selected>Advanced</option>
                                    <option value="very advanced">Very advanced</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Subtlety</label>
                                <select id="ai-l3-subtle">
                                    <option value="medium">Medium subtlety</option>
                                    <option value="subtle" selected>Subtle</option>
                                    <option value="very subtle">Very subtle</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-size:0.75rem; opacity:0.7;">Ellipses if &gt;</label>
                                <input type="number" id="ai-l3-ellipsis" min="3" value="7" placeholder="Words">
                            </div>
                        </div>
                    </div>
                    <button class="btn btn-primary" onclick="admin.generatePrompt()">Generate Prompt</button>
                    
                    <div id="ai-step2" class="hidden" style="margin-top:10px;">
                        <textarea id="ai-prompt-out" style="height:60px; width:100%;" readonly></textarea>
                        <p style="font-size:0.8rem; margin:5px 0;"><strong>Paste the AI result below:</strong></p>
                        <textarea id="ai-json-in" style="height:80px; width:100%;" placeholder="Paste JSON here..."></textarea>
                        <div style="display:flex; gap:8px;">
                            <button class="btn btn-success" onclick="admin.loadJson()">Load Data</button>
                            <button class="btn btn-outline" onclick="admin.loadJson(true)">Load + Export Student App</button>
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üìå Lesson Templates</h3>
                    <div class="input-group">
                        <label>Template Name</label>
                        <input type="text" id="template-name" placeholder="e.g. Persuasive Writing L2">
                    </div>
                    <div style="display:flex; gap:8px; margin-bottom:10px;">
                        <button class="btn btn-outline" onclick="admin.saveTemplate()">Save Template</button>
                        <button class="btn btn-outline" onclick="admin.loadTemplate()">Load Template</button>
                        <select id="template-select" style="width:100%; padding:6px;"></select>
                    </div>
                    <div style="font-size:0.85rem; opacity:0.7;">Templates store AI level settings and sentence structures.</div>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üõ†Ô∏è Controls</h3>
                    <label style="display:block; margin-bottom:5px;"><input type="checkbox" id="keep-unlocked" onchange="admin.setUnlocked(this.checked)"> Keep Unlocked</label>
                    <label style="display:block;"><input type="checkbox" id="auto-progress" onchange="admin.setAutoProgress(this.checked)"> Auto-progress Levels</label>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üìù Edit Evidence (Quotes)</h3>
                    <div id="quote-editor-list" style="max-height:300px; overflow-y:auto; padding-right:5px;"></div>
                    <button class="btn btn-success" onclick="admin.addQuote()">+ New Quote</button>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">‚úçÔ∏è Analysis Banks Editor</h3>
                    <div class="bank-btn-grid">
                        <button class="btn btn-outline" onclick="admin.editBank('markers')">Markers</button>
                        <button class="btn btn-outline" onclick="admin.editBank('starters')">Starters</button>
                        <button class="btn btn-outline" onclick="admin.editBank('methods')">Methods</button>
                        <button class="btn btn-outline" onclick="admin.editBank('points')">Points</button>
                    </div>
                    <div class="bank-btn-grid">
                        <button class="btn btn-outline" style="border-color:var(--primary);" onclick="admin.editBank('link_l1')">Links L1</button>
                        <button class="btn btn-outline" style="border-color:var(--primary);" onclick="admin.editBank('link_l2')">Links L2</button>
                        <button class="btn btn-outline" style="border-color:var(--primary);" onclick="admin.editBank('link_l3')">Links L3</button>
                    </div>
                    
                    <div id="bank-editor-ui" class="hidden" style="background:var(--bg); padding:10px; border-radius:6px; border:1px solid var(--border);">
                        <strong id="bank-name-display" style="display:block; margin-bottom:5px; color:var(--primary);"></strong>
                        <div style="display:flex; gap:5px; margin-bottom:10px;">
                            <input id="bank-add-input" placeholder="New item..." style="flex:1;">
                            <button class="btn btn-primary" style="width:auto; margin:0;" onclick="admin.addBankItem()">Add</button>
                        </div>
                        <div id="bank-list-container"></div>
                    </div>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">‚öôÔ∏è Sentence Structure</h3>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <button class="btn btn-outline" style="width:auto;" onclick="admin.renderConfig(1)">Lvl 1</button>
                        <button class="btn btn-outline" style="width:auto;" onclick="admin.renderConfig(2)">Lvl 2</button>
                        <button class="btn btn-outline" style="width:auto;" onclick="admin.renderConfig(3)">Lvl 3</button>
                    </div>
                    <div id="config-slots"></div>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üèóÔ∏è Global Structure Questions</h3>
                    <label style="display:block; margin-bottom:10px;"><input type="checkbox" id="gs-enabled" onchange="admin.toggleGlobal(this.checked)"> Enable Section</label>
                    <div id="global-editor-list"></div>
                    <button class="btn btn-success" onclick="admin.addGlobalQuestion()">+ Add Question</button>
                </div>

                <div class="admin-section">
                    <h3 class="admin-h">üì¶ Export</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn btn-doc" onclick="admin.exportWorksheet()">üìÑ Worksheet (Word)</button>
                        <button class="btn btn-primary" style="background:#37474f;" onclick="admin.exportStandalone()">üì¶ Student App</button>
                        <button class="btn btn-outline" onclick="admin.saveConfig()">üíæ Save JSON</button>
                        <label class="btn btn-outline" style="text-align:center; cursor:pointer;">üìÇ Load JSON<input type="file" id="file-up" class="hidden" onchange="admin.loadFile(this)"></label>
                    </div>
                </div>

                <button class="btn btn-danger" onclick="app.factoryReset()">‚ö†Ô∏è Factory Reset</button>
            </div>
        </div>
    </div>
    <script>
/** ARCHITECT v5.1 (Safety First) **/

/* --- DEFAULT DATA --- */
const defaultData = {
    meta: { title: "Demo Lesson", author: "System", version: "5.1" },
    sourceText: "The sky was a bruised purple...",
    question: "How is language used?",
    settings: { autoProgress: false },
    globalStructure: {
        enabled: true,
        items: [
            { id: "g1", question: "How does the text shift?", correct: "Outside to Inside", distractors: ["Inside to Outside", "No shift"] }
        ]
    },
    banks: {
        markers: ["Furthermore,", "However,"],
        starters: ["The writer implies", "The text suggests"],
        methods: ["Metaphor", "Simile"],
        points: ["a sense of fear", "tension"],
        links: { l1: ["This shows"], l2: ["This reinforces"], l3: ["This highlights"] }
    },
    sentenceConfig: {
        1: ["starter", "quote", "link_l1", "manual_point"],
        2: ["marker", "starter", "quote", "method", "link_l2", "manual_analysis"],
        3: ["marker", "starter", "quote", "method", "manual_deep_analysis", "link_l3"]
    },
    items: [
        { id: "q1", original: "bruised purple", translation: "Dark color", translationDistractors: ["Bright"], type: "language", effect: "gloomy mood", effectDistractors: ["happy"], levels: [1,2,3], includeInWorksheet: true }
    ],
    isStandalone: false 
};

let appData = null;
let userState = { score: 0, level: 1, essay: "", completed: [], completedLevels: [], filter: "all", showDone: false };
let currentBankKey = null;
let saveTimeout = null;

/* --- APP LOGIC --- */
const app = {
    init: function() {
        window.onerror = function() { document.getElementById('emergency-reset').style.display = 'block'; };

        // CHECK FOR INJECTED STANDALONE DATA
        if (typeof window.STANDALONE_LESSON !== 'undefined') {
            appData = app.repair(window.STANDALONE_LESSON);
            appData.isStandalone = true;
            
            // CLEANUP: If by some miracle HTML remains, kill it
            const btn = document.getElementById('btn-admin'); if(btn) btn.remove();
            const mod = document.getElementById('modal-admin'); if(mod) mod.remove();

        } else {
            // NORMAL TEACHER MODE
            const d = localStorage.getItem('tsa_v5_1_data');
            if(d) {
                try { appData = app.repair(JSON.parse(d)); } 
                catch(e) { appData = app.repair(defaultData); }
            } else if (typeof teacherConfig !== "undefined") {
                appData = app.repair(teacherConfig);
            } else {
                appData = app.repair(defaultData);
            }
        }

        if(appData.isStandalone && (!Array.isArray(appData.items) || appData.items.length === 0)) {
            const fallback = app.repair(defaultData);
            appData.items = fallback.items;
            appData.banks = fallback.banks;
            appData.sentenceConfig = fallback.sentenceConfig;
            appData.globalStructure = fallback.globalStructure;
            if(!appData.sourceText) appData.sourceText = fallback.sourceText;
            if(!appData.question) appData.question = fallback.question;
            if(!appData.meta || !appData.meta.title) appData.meta = fallback.meta;
        }

        const s = localStorage.getItem('tsa_v5_1_state');
        if(s) {
            try { userState = JSON.parse(s); } catch(e) { userState = { score: 0, level: 1, essay: "", completed: [], completedLevels: [], filter: "all", showDone: false }; }
        }

        try { ui.init(); } catch(e) { document.getElementById('emergency-reset').style.display = 'block'; }
    },

    repair: function(d) {
        if(!d || typeof d !== 'object') return JSON.parse(JSON.stringify(defaultData));

        const safe = d;
        safe.meta = safe.meta && typeof safe.meta === 'object' ? safe.meta : {};
        safe.meta.title = typeof safe.meta.title === 'string' ? safe.meta.title : defaultData.meta.title;
        safe.meta.author = typeof safe.meta.author === 'string' ? safe.meta.author : defaultData.meta.author;
        safe.meta.version = typeof safe.meta.version === 'string' ? safe.meta.version : defaultData.meta.version;
        safe.sourceText = typeof safe.sourceText === 'string' ? safe.sourceText : defaultData.sourceText;
        safe.question = typeof safe.question === 'string' ? safe.question : defaultData.question;

        safe.settings = safe.settings && typeof safe.settings === 'object' ? safe.settings : {};
        if(typeof safe.settings.autoProgress !== 'boolean') safe.settings.autoProgress = false;

        safe.globalStructure = safe.globalStructure && typeof safe.globalStructure === 'object' ? safe.globalStructure : { enabled: true, items: [] };
        safe.globalStructure.enabled = typeof safe.globalStructure.enabled === 'boolean' ? safe.globalStructure.enabled : true;
        if(safe.globalStructure.question && !safe.globalStructure.items) { 
            safe.globalStructure.items = [{ id:"g_old", question: safe.globalStructure.question, correct: safe.globalStructure.correct, distractors: safe.globalStructure.distractors }];
        }
        if(!Array.isArray(safe.globalStructure.items)) safe.globalStructure.items = [];
        safe.globalStructure.items = safe.globalStructure.items.map((q, idx) => {
            const item = q && typeof q === 'object' ? q : {};
            return {
                id: typeof item.id === 'string' ? item.id : `g${idx + 1}`,
                question: typeof item.question === 'string' ? item.question : 'New Question?',
                correct: typeof item.correct === 'string' ? item.correct : 'Answer',
                distractors: Array.isArray(item.distractors) ? item.distractors.filter(v => typeof v === 'string') : []
            };
        });

        safe.banks = safe.banks && typeof safe.banks === 'object' ? safe.banks : {};
        safe.banks.markers = Array.isArray(safe.banks.markers) ? safe.banks.markers.filter(v => typeof v === 'string') : [];
        safe.banks.starters = Array.isArray(safe.banks.starters) ? safe.banks.starters.filter(v => typeof v === 'string') : [];
        safe.banks.methods = Array.isArray(safe.banks.methods) ? safe.banks.methods.filter(v => typeof v === 'string') : [];
        safe.banks.points = Array.isArray(safe.banks.points) ? safe.banks.points.filter(v => typeof v === 'string') : [];
        safe.banks.links = safe.banks.links && typeof safe.banks.links === 'object' ? safe.banks.links : {};
        safe.banks.links.l1 = Array.isArray(safe.banks.links.l1) ? safe.banks.links.l1.filter(v => typeof v === 'string') : [];
        safe.banks.links.l2 = Array.isArray(safe.banks.links.l2) ? safe.banks.links.l2.filter(v => typeof v === 'string') : [];
        safe.banks.links.l3 = Array.isArray(safe.banks.links.l3) ? safe.banks.links.l3.filter(v => typeof v === 'string') : [];

        safe.sentenceConfig = safe.sentenceConfig && typeof safe.sentenceConfig === 'object' ? safe.sentenceConfig : JSON.parse(JSON.stringify(defaultData.sentenceConfig));
        [1, 2, 3].forEach(lvl => {
            if(!Array.isArray(safe.sentenceConfig[lvl])) safe.sentenceConfig[lvl] = JSON.parse(JSON.stringify(defaultData.sentenceConfig[lvl]));
        });

        if(!Array.isArray(safe.items)) safe.items = [];
        safe.items = safe.items.map((i, idx) => {
            const item = i && typeof i === 'object' ? i : {};
            const rawLevels = Array.isArray(item.levels)
                ? item.levels
                : (typeof item.level === 'number' || typeof item.level === 'string')
                    ? [item.level]
                    : (typeof item.levels === 'string' ? item.levels.split(',') : []);
            const levels = Array.isArray(rawLevels)
                ? rawLevels.map(n => parseInt(n, 10)).filter(n => [1,2,3].includes(n))
                : [1,2,3];
            const original = typeof item.original === 'string' ? item.original
                : (typeof item.quote === 'string' ? item.quote
                : (typeof item.evidence === 'string' ? item.evidence
                : (typeof item.text === 'string' ? item.text : 'New Quote')));
            const translation = typeof item.translation === 'string' ? item.translation
                : (typeof item.meaning === 'string' ? item.meaning
                : (typeof item.simpleMeaning === 'string' ? item.simpleMeaning : 'Meaning'));
            const translationDistractors = Array.isArray(item.translationDistractors)
                ? item.translationDistractors
                : (Array.isArray(item.wrongMeanings) ? item.wrongMeanings
                : (Array.isArray(item.translation_distractors) ? item.translation_distractors : []));
            const effect = typeof item.effect === 'string' ? item.effect
                : (typeof item.analysis === 'string' ? item.analysis
                : (typeof item.interpretation === 'string' ? item.interpretation : ''));
            const effectDistractors = Array.isArray(item.effectDistractors)
                ? item.effectDistractors
                : (Array.isArray(item.wrongAnalyses) ? item.wrongAnalyses
                : (Array.isArray(item.effect_distractors) ? item.effect_distractors : []));
            const type = ['tone','structure','language'].includes(item.type)
                ? item.type
                : (['tone','structure','language'].includes(item.category) ? item.category : 'tone');
            return {
                id: typeof item.id === 'string' ? item.id : `q${idx + 1}`,
                original: original,
                translation: translation,
                translationDistractors: translationDistractors.filter(v => typeof v === 'string'),
                type: type,
                effect: effect,
                effectDistractors: effectDistractors.filter(v => typeof v === 'string'),
                levels: levels.length ? levels : [1,2,3],
                includeInWorksheet: typeof item.includeInWorksheet === 'boolean' ? item.includeInWorksheet : true
            };
        });

        return safe;
    },

    save: function() {
        if(!appData.isStandalone) {
            localStorage.setItem('tsa_v5_1_data', JSON.stringify(appData));
        }
        localStorage.setItem('tsa_v5_1_state', JSON.stringify(userState));
        document.getElementById('save-status').style.opacity = 1;
        setTimeout(()=>document.getElementById('save-status').style.opacity=0, 800);
        ui.renderLab();
    },

    updateEssay: function(text) {
        userState.essay = text;
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => { app.save(); }, 1000);
    },

    resetSession: function() {
        if(confirm("Reset progress?")) {
            userState = { score: 0, level: 1, essay: "", completed: [], completedLevels: [], filter: "all", showDone: false };
            app.save(); location.reload();
        }
    },

    factoryReset: function() {
        if(confirm("Delete ALL data?")) { localStorage.clear(); location.reload(); }
    },

    setLevel: function(l) {
        userState.level = parseInt(l);
        app.save();
        document.getElementById("sentence-builder").innerHTML = '<div style="text-align:center; opacity:0.6; padding:20px;">Level Changed. Select quote.</div>';
    },

    setFilter: function(f) { userState.filter = f; ui.renderLab(); },
    toggleDone: function() { userState.showDone = !userState.showDone; document.getElementById('btn-show-done').classList.toggle('active', userState.showDone); ui.renderLab(); },

    selectQuote: function(id) {
        const item = appData.items.find(i=>i.id===id);
        if(item) ui.startWizard(item);
    },

    commitSentence: function() {
        const txt = document.getElementById("preview-box").innerText.trim();
        if(!txt) return alert("Empty sentence.");
        
        document.getElementById("essay-area").value += (document.getElementById("essay-area").value ? "\n\n" : "") + txt;
        userState.essay = document.getElementById("essay-area").value;

        if(ui.activeQuoteId && !userState.completed.includes(ui.activeQuoteId)) {
            userState.completed.push(ui.activeQuoteId);
        }
        
        app.save();
        app.checkLevelCompletion();
        ui.switchView('lab'); 
        ui.renderLab(); 
    },

    checkLevelCompletion: function() {
        const levelItems = appData.items.filter(i => i.levels.includes(userState.level));
        if(levelItems.length === 0) return;

        const allDone = levelItems.every(i => userState.completed.includes(i.id));

        if(allDone) {
            if(!userState.completedLevels.includes(userState.level)) {
                userState.completedLevels.push(userState.level);
            }
            if(userState.level < 3) {
                ui.showCelebration(appData.settings && appData.settings.autoProgress);
            } else {
                ui.showCelebration(false, true); 
            }
            app.save();
        }
    },

    undo: function() {
        let v = document.getElementById("essay-area").value;
        let p = v.split("\n\n"); p.pop();
        let newVal = p.join("\n\n");
        document.getElementById("essay-area").value = newVal;
        userState.essay = newVal;
        app.save();
    },

    clearEssay: function() { 
        if(confirm("Clear essay?")) { 
            document.getElementById("essay-area").value = ""; 
            userState.essay = "";
            app.save(); 
        } 
    },

    restartCourse: function() {
        if(confirm("Play again from Level 1?")) {
            userState = { score: 0, level: 1, essay: "", completed: [], completedLevels: [], filter: "all", showDone: false };
            app.save(); location.reload();
        }
    },
    
    exportDoc: function() {
        const text = document.getElementById("essay-area").value || "";
        const html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>Answer</title>
        <style>body{font-family:'Aptos','Calibri',sans-serif;} p{margin:0 0 10px 0;}</style>
        </head><body><p>${text.replace(/\n/g, '</p><p>')}</p></body></html>`;
        const b = new Blob(['\ufeff'+html], {type:'application/msword'});
        const a = document.createElement("a"); a.href=URL.createObjectURL(b); a.download="Answer.doc"; a.click();
    },

    playSound: function(type) {
        if(window.AudioContext) {
            const ctx = new window.AudioContext();
            const now = ctx.currentTime;
            
            if (type === 'celebrate') {
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'triangle';
                    const start = now + (i * 0.15);
                    const dur = i === 3 ? 0.8 : 0.1; 
                    gain.gain.setValueAtTime(0.1, start);
                    gain.gain.exponentialRampToValueAtTime(0.001, start + dur);
                    osc.start(start);
                    osc.stop(start + dur);
                });
            } else if (type === 'final') {
                [392.00, 523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    const start = now + (i * 0.18);
                    const dur = i === 4 ? 0.9 : 0.12; 
                    gain.gain.setValueAtTime(0.12, start);
                    gain.gain.exponentialRampToValueAtTime(0.001, start + dur);
                    osc.start(start);
                    osc.stop(start + dur);
                });
            } else {
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.connect(g); g.connect(ctx.destination);
                osc.frequency.value = 600;
                g.gain.value = 0.1;
                osc.start(); osc.stop(now + 0.1);
            }
        }
    }
};

/* --- UI --- */
const ui = {
    activeQuoteId: null,

    init: function() {
        document.getElementById("lbl-title").innerText = appData.meta.title;
        document.getElementById("source-content").innerText = appData.sourceText;
        document.getElementById("score-display").innerText = userState.score + " XP";
        document.getElementById("essay-area").value = userState.essay;
        document.getElementById("level-selector").value = userState.level;
        ui.loadTheme();
        
        // --- FORCE LAB VIEW ON START ---
        ui.switchView('lab'); 
        
        ui.renderLab();
        
        // Only sync admin UI if we are in Teacher Mode AND the element exists
        // This is the check that prevents freezing!
        if(!appData.isStandalone && document.getElementById('modal-admin')) {
            admin.syncUI();
        }
    },

    // THEME
    setTheme: function(key, val) { document.documentElement.style.setProperty('--'+key, val); localStorage.setItem('tsa_theme_'+key, val); },
    loadTheme: function() {
        const bg = localStorage.getItem('tsa_theme_bg');
        const text = localStorage.getItem('tsa_theme_text');
        const card = localStorage.getItem('tsa_theme_card');
        if(bg) document.documentElement.style.setProperty('--bg', bg);
        if(text) document.documentElement.style.setProperty('--text', text);
        if(card) document.documentElement.style.setProperty('--card', card);
    },
    resetTheme: function() { 
        localStorage.removeItem('tsa_theme_bg'); 
        localStorage.removeItem('tsa_theme_text'); 
        localStorage.removeItem('tsa_theme_card'); 
        location.reload(); 
    },

    renderLab: function() {
        const g = document.getElementById("quote-grid"); g.innerHTML = "";
        
        if(!appData.items || appData.items.length === 0) {
            g.innerHTML = `
                <div class="card" style="cursor:default;">
                    <div style="font-weight:800; font-size:1.1rem; margin-bottom:6px;">No lesson data</div>
                    <div style="opacity:0.8;">This file doesn't contain any quotes yet.</div>
                </div>
            `;
            document.getElementById("global-card-container").innerHTML = "";
            return;
        }
        
        // If current level has no items, jump to first available level
        const availableLevels = [1,2,3].filter(lvl => appData.items.some(i => i.levels.includes(lvl)));
        if(availableLevels.length && !availableLevels.includes(userState.level)) {
            userState.level = availableLevels[0];
            const sel = document.getElementById("level-selector");
            if(sel) sel.value = userState.level;
        }

        const levelItems = appData.items.filter(i => i.levels.includes(userState.level));
        const levelDone = levelItems.length > 0 && levelItems.every(i => userState.completed.includes(i.id));
        if(userState.level === 3 && levelDone) {
            const essayPreview = (userState.essay || "").trim().replace(/\n/g, "<br>");
            g.innerHTML = `
                <div class="card" style="cursor:default;">
                    <div style="font-weight:800; font-size:1.1rem; margin-bottom:6px;">üèÅ Course Complete</div>
                    <div style="opacity:0.8; margin-bottom:10px;">You have finished all Level 3 quotes. Great work!</div>
                    <div style="border:1px solid var(--border); border-radius:6px; padding:8px; background:var(--bg); max-height:140px; overflow:auto; margin-bottom:10px;">
                        ${essayPreview ? essayPreview : "<span style='opacity:0.6;'>No essay text yet.</span>"}
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px;">
                        <button class="btn btn-outline" onclick="ui.switchView('desk')">Review Answer</button>
                        <button class="btn btn-doc" onclick="app.exportDoc()">Download Answer</button>
                    </div>
                    <button class="btn btn-outline" onclick="window.print()">Print</button>
                    <button class="btn btn-primary" onclick="app.restartCourse()">Play Again</button>
                </div>
            `;
            return;
        }
        let items = levelItems.filter(i => {
            const isType = (userState.filter==="all" || i.type===userState.filter);
            const isDone = userState.completed.includes(i.id);
            if(isDone && !userState.showDone) return false;
            return isType;
        });

        // If nothing shows but level has items, relax filters
        if(items.length === 0 && levelItems.length > 0) {
            if(userState.filter !== "all") userState.filter = "all";
            if(!userState.showDone) userState.showDone = true;
            items = levelItems.filter(i => true);
        }
        
        items.forEach(i => {
            const div = document.createElement("div");
            div.className = `card card-${i.type}`;
            if(userState.completed.includes(i.id)) div.style.opacity = "0.5";
            div.innerHTML = `<span class="quote-text">"${i.original}"</span><div class="card-meta"><span>${i.type}</span><span>${userState.completed.includes(i.id)?'‚úÖ':''}</span></div>`;
            div.onclick = () => app.selectQuote(i.id);
            g.appendChild(div);
        });

        const gs = document.getElementById("global-card-container");
        if(appData.globalStructure.enabled && appData.globalStructure.items.length > 0) {
            gs.innerHTML = "";
            appData.globalStructure.items.forEach(q => {
                const div = document.createElement("div");
                div.className = "card card-global";
                div.innerHTML = `<strong>üèóÔ∏è Structure</strong><br><small>${q.question}</small>`;
                div.onclick = () => ui.runGlobal(q);
                gs.appendChild(div);
            });
        } else { gs.innerHTML = ""; }
        
        document.querySelectorAll(".filter-btn").forEach(b => b.classList.toggle("active", b.dataset.filter === userState.filter));
    },

    switchView: function(v) {
        document.querySelectorAll(".hub").forEach(e=>e.classList.remove("active"));
        document.querySelectorAll(".nav-item").forEach(e=>e.classList.remove("active"));
        document.getElementById("view-"+v).classList.add("active");
        document.getElementById("nav-"+v).classList.add("active");
    },

    openModal: (id) => document.getElementById(id).classList.add("open"),
    closeModal: (id) => {
        document.getElementById(id).classList.remove("open");
        if(id === 'modal-admin' && !appData.isStandalone) {
            ui.renderLab();
            if(ui.activeQuoteId) {
                const item = appData.items.find(i=>i.id===ui.activeQuoteId);
                if(item) ui.runBuilder(item); 
            }
        }
    },
    
    openAdmin: () => {
        admin.renderAll(); 
        if(localStorage.getItem('tsa_unlocked')==='true') { ui.openModal("modal-admin"); }
        else if(prompt("Password (1234)")==="1234") { ui.openModal("modal-admin"); }
    },
    openSourceText: () => ui.openModal("modal-source"),

    startWizard: function(item) {
        const opts = [item.translation, ...item.translationDistractors||[]].sort(()=>Math.random()-0.5);
        ui.openModal("modal-wizard");
        document.getElementById("wizard-title").innerText = "Phase 1: Meaning";
        document.getElementById("wizard-prompt").innerHTML = `<p class="quote-text">"${item.original}"</p><p>What does this mean?</p>`;
        const grid = document.getElementById("wizard-options"); grid.innerHTML = "";
        opts.forEach(o => {
            const b = document.createElement("button"); b.className = "btn btn-outline"; b.textContent = o;
            b.onclick = () => {
                if(o === item.translation) {
                    b.style.background = "var(--success)"; b.style.color="white"; app.playSound('correct');
                    setTimeout(() => {
                        ui.closeModal("modal-wizard");
                        ui.runBuilder(item);
                    }, 500);
                } else { b.classList.add('shake'); b.style.background = "var(--error)"; b.style.color="white"; }
            };
            grid.appendChild(b);
        });
    },

    runBuilder: function(item) {
        ui.activeQuoteId = item.id;
        ui.switchView("desk");
        const cont = document.getElementById("sentence-builder"); cont.innerHTML = "";
        const cfg = appData.sentenceConfig[userState.level] || [];
        
        cfg.forEach(slot => {
            const row = document.createElement("div"); row.className = "slot-row";
            if(slot === "quote") {
                row.innerHTML = `<span class="slot-label">EVIDENCE</span><div class="slot-static" data-v='"${item.original}"'>"${item.original}"</div>`;
            } else if(slot.startsWith("manual")) {
                let lbl = slot.split('_')[1] || "Text";
                row.innerHTML = `<span class="slot-label">${lbl.toUpperCase()} (Idea)</span><input class="slot-input" oninput="ui.updPrev()">`;
            } else {
                let key = slot.includes("link") ? (slot.split('_')[1]||'l1') : slot+"s";
                if(slot==='point') key='points';
                
                let list = slot.includes("link") ? appData.banks.links[key] : appData.banks[key];
                if(list) {
                    row.innerHTML = `<span class="slot-label">${slot.toUpperCase()}</span><select class="slot-select" onchange="ui.updPrev()"><option value="">Select...</option>${list.map(o=>`<option>${o}</option>`).join('')}</select>`;
                }
            }
            cont.appendChild(row);
        });
        ui.updPrev();
        
        if(!userState.completed.includes(item.id)) { 
            userState.score+=10; document.getElementById("score-display").innerText = userState.score + " XP";
        }
    },

    updPrev: function() {
        let txt = [];
        document.querySelectorAll("#sentence-builder select, #sentence-builder input, #sentence-builder .slot-static").forEach(el => {
            let v = el.tagName==="DIV"? el.dataset.v : el.value;
            if(v && v.trim()) txt.push(v);
        });
        document.getElementById("preview-box").innerText = txt.join(" ") + ".";
    },

    runGlobal: function(q) {
        ui.openModal("modal-wizard");
        document.getElementById("wizard-title").innerText = "Structure Analysis";
        document.getElementById("wizard-prompt").innerHTML = `<p>${q.question}</p>`;
        const opts = [q.correct, ...q.distractors].sort(()=>Math.random()-0.5);
        const grid = document.getElementById("wizard-options"); grid.innerHTML = "";
        opts.forEach(o => {
            const b = document.createElement("button"); b.className = "btn btn-outline"; b.textContent = o;
            b.onclick = () => {
                if(o === q.correct) {
                    b.style.background = "var(--success)"; b.style.color="white"; userState.score+=20; app.save(); ui.init(); app.playSound('correct');
                    setTimeout(()=>ui.closeModal("modal-wizard"), 800);
                } else { b.classList.add('shake'); b.style.background = "var(--error)"; b.style.color="white"; }
            };
            grid.appendChild(b);
        });
    },

    showCelebration: function(autoAdvance, isFinal) {
        const overlay = document.getElementById('celebration-overlay');
        const title = document.getElementById('celebration-title');
        const sub = document.getElementById('celebration-sub');
        const btn = document.getElementById('celebration-btn');

        overlay.classList.remove('hidden');
        app.playSound(isFinal ? 'final' : 'celebrate');

        if (isFinal) {
            title.innerText = "Course Complete! üèÜ";
            sub.innerText = "Well done! Check your answer and print, save or send to your teacher.";
            btn.innerText = "Review Work";
            btn.style.display = 'block';
            btn.onclick = ui.closeCelebration;
        } else {
            title.innerText = `Level ${userState.level} Complete! üéâ`;
            sub.innerText = "Great work! Moving up...";
            if (autoAdvance) {
                btn.style.display = 'none';
                setTimeout(() => {
                    ui.closeCelebration();
                    app.setLevel(userState.level + 1);
                }, 3000);
            } else {
                btn.innerText = "Continue";
                btn.style.display = 'block';
                btn.onclick = () => {
                    ui.closeCelebration();
                    app.setLevel(userState.level + 1);
                    ui.switchView('lab');
                };
            }
        }
    },

    closeCelebration: function() {
        document.getElementById("celebration-overlay").classList.add("hidden");
    }
};

/* --- ADMIN --- */
const admin = {
    aiAutoBound: false,
    renderAll: function() {
        admin.syncUI();
        admin.bindAiAutoPrompt();
        admin.refreshTemplateList();
        admin.renderQuoteList();
        admin.renderGlobalList();
    },
    syncUI: function() {
        document.getElementById("keep-unlocked").checked = localStorage.getItem("tsa_unlocked") === "true";
        document.getElementById("auto-progress").checked = appData.settings.autoProgress;
        document.getElementById("gs-enabled").checked = appData.globalStructure.enabled;
    },
    setUnlocked: (c) => localStorage.setItem("tsa_unlocked", c),
    setAutoProgress: (c) => { 
        if(!appData.settings) appData.settings = {};
        appData.settings.autoProgress = c; 
        app.save(); 
    },
    toggleGlobal: (c) => { appData.globalStructure.enabled = c; app.save(); ui.renderLab(); },

    // QUOTE LIST
    renderQuoteList: function() {
        const c = document.getElementById("quote-editor-list"); c.innerHTML = "";
        appData.items.forEach((item, idx) => {
            const div = document.createElement("div"); div.className = "quote-editor";
            div.innerHTML = `
                <div class="editor-header">#${idx+1} <button class="btn btn-danger btn-small" onclick="admin.delQuote(${idx})">Del</button></div>
                <div class="input-group"><label>Quote</label><input value="${item.original}" onchange="admin.updQuote(${idx},'original',this.value)"></div>
                <div class="input-group"><label>Translation</label><input value="${item.translation}" onchange="admin.updQuote(${idx},'translation',this.value)"></div>
                <div class="level-checks">
                    <label>Worksheet: <input type="checkbox" ${item.includeInWorksheet?'checked':''} onchange="admin.updQuote(${idx},'includeInWorksheet',this.checked)"></label>
                    | Lvl: 
                    <label>1<input type="checkbox" ${item.levels.includes(1)?'checked':''} onchange="admin.togLvl(${idx},1)"></label>
                    <label>2<input type="checkbox" ${item.levels.includes(2)?'checked':''} onchange="admin.togLvl(${idx},2)"></label>
                    <label>3<input type="checkbox" ${item.levels.includes(3)?'checked':''} onchange="admin.togLvl(${idx},3)"></label>
                </div>
            `;
            c.appendChild(div);
        });
    },
    updQuote: (idx, k, v) => { appData.items[idx][k] = v; app.save(); },
    togLvl: (idx, l) => { 
        const i = appData.items[idx]; 
        if(i.levels.includes(l)) i.levels = i.levels.filter(x=>x!==l); else i.levels.push(l);
        app.save();
    },
    delQuote: (idx) => { appData.items.splice(idx, 1); app.save(); admin.renderQuoteList(); },
    addQuote: () => { 
        appData.items.push({ id:"q"+Date.now(), original:"New Quote", translation:"Meaning", type:"tone", levels:[1,2,3], includeInWorksheet:true, translationDistractors:["Wrong"] }); 
        app.save(); admin.renderQuoteList();
    },

    // GLOBAL STRUCTURE LIST
    renderGlobalList: function() {
        const c = document.getElementById("global-editor-list"); c.innerHTML = "";
        appData.globalStructure.items.forEach((item, idx) => {
            const div = document.createElement("div"); div.className = "struct-editor";
            div.innerHTML = `
                <div class="editor-header">Q${idx+1} <button class="btn btn-danger btn-small" onclick="admin.delGlobal(${idx})">Del</button></div>
                <div class="input-group"><label>Question</label><input value="${item.question}" onchange="admin.updGlobal(${idx},'question',this.value)"></div>
                <div class="input-group"><label>Correct</label><input value="${item.correct}" onchange="admin.updGlobal(${idx},'correct',this.value)"></div>
                <div class="input-group"><label>Distractors (CSV)</label><input value="${(item.distractors||[]).join(',')}" onchange="admin.updGlobal(${idx},'distractors',this.value.split(','))"></div>
            `;
            c.appendChild(div);
        });
    },
    updGlobal: (idx, k, v) => { appData.globalStructure.items[idx][k] = v; app.save(); },
    delGlobal: (idx) => { appData.globalStructure.items.splice(idx, 1); app.save(); admin.renderGlobalList(); },
    addGlobalQuestion: () => {
        appData.globalStructure.items.push({ id:"g"+Date.now(), question:"New Question?", correct:"Answer", distractors:["Wrong"] });
        app.save(); admin.renderGlobalList();
    },

    // AI
    bindAiAutoPrompt: () => {
        if(admin.aiAutoBound) return;
        const ids = [
            "ai-question","ai-input","ai-mode","ai-count",
            "ai-level-1","ai-level-2","ai-level-3",
            "ai-l1-count","ai-l1-words","ai-l1-complex","ai-l1-subtle","ai-l1-ellipsis",
            "ai-l2-count","ai-l2-words","ai-l2-complex","ai-l2-subtle","ai-l2-ellipsis",
            "ai-l3-count","ai-l3-words","ai-l3-complex","ai-l3-subtle","ai-l3-ellipsis"
        ];
        const handler = () => {
            const txt = document.getElementById("ai-input").value;
            if(!txt || !txt.trim()) return;
            admin.generatePrompt(true);
        };
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(!el) return;
            el.addEventListener("input", handler);
            el.addEventListener("change", handler);
        });
        admin.aiAutoBound = true;
    },
    getAiSettings: () => {
        const getLevel = (lvl) => ({
            enabled: document.getElementById(`ai-level-${lvl}`).checked,
            count: parseInt(document.getElementById(`ai-l${lvl}-count`).value, 10) || 0,
            maxWords: parseInt(document.getElementById(`ai-l${lvl}-words`).value, 10) || 0,
            complexity: document.getElementById(`ai-l${lvl}-complex`).value,
            subtlety: document.getElementById(`ai-l${lvl}-subtle`).value,
            ellipsesMaxWords: parseInt(document.getElementById(`ai-l${lvl}-ellipsis`).value, 10) || 0
        });
        return {
            question: document.getElementById("ai-question").value,
            count: parseInt(document.getElementById("ai-count").value, 10) || 6,
            mode: document.getElementById("ai-mode").value,
            levels: { 1: getLevel(1), 2: getLevel(2), 3: getLevel(3) }
        };
    },
    applyAiSettings: (s) => {
        if(!s || typeof s !== 'object') return;
        if(typeof s.question === 'string') document.getElementById("ai-question").value = s.question;
        if(typeof s.count === 'number') document.getElementById("ai-count").value = s.count;
        if(typeof s.mode === 'string') document.getElementById("ai-mode").value = s.mode;
        const applyLevel = (lvl) => {
            const l = s.levels && s.levels[lvl] ? s.levels[lvl] : {};
            if(typeof l.enabled === 'boolean') document.getElementById(`ai-level-${lvl}`).checked = l.enabled;
            if(typeof l.count === 'number') document.getElementById(`ai-l${lvl}-count`).value = l.count || "";
            if(typeof l.maxWords === 'number') document.getElementById(`ai-l${lvl}-words`).value = l.maxWords || "";
            if(typeof l.complexity === 'string') document.getElementById(`ai-l${lvl}-complex`).value = l.complexity;
            if(typeof l.subtlety === 'string') document.getElementById(`ai-l${lvl}-subtle`).value = l.subtlety;
            if(typeof l.ellipsesMaxWords === 'number') document.getElementById(`ai-l${lvl}-ellipsis`).value = l.ellipsesMaxWords || "";
        };
        applyLevel(1); applyLevel(2); applyLevel(3);
    },
    getTemplates: () => {
        try { return JSON.parse(localStorage.getItem("tsa_templates_v1") || "[]"); }
        catch(e) { return []; }
    },
    saveTemplates: (templates) => localStorage.setItem("tsa_templates_v1", JSON.stringify(templates)),
    refreshTemplateList: () => {
        const sel = document.getElementById("template-select");
        if(!sel) return;
        const templates = admin.getTemplates();
        sel.innerHTML = templates.length ? templates.map(t => `<option value="${t.name}">${t.name}</option>`).join('') : `<option value="">No templates</option>`;
    },
    saveTemplate: () => {
        const name = document.getElementById("template-name").value.trim();
        if(!name) return alert("Enter a template name.");
        const templates = admin.getTemplates();
        const payload = {
            name,
            aiSettings: admin.getAiSettings(),
            sentenceConfig: JSON.parse(JSON.stringify(appData.sentenceConfig)),
            banks: JSON.parse(JSON.stringify(appData.banks))
        };
        const idx = templates.findIndex(t => t.name === name);
        if(idx >= 0) templates[idx] = payload; else templates.push(payload);
        admin.saveTemplates(templates);
        admin.refreshTemplateList();
        document.getElementById("template-select").value = name;
    },
    loadTemplate: () => {
        const sel = document.getElementById("template-select");
        const name = sel ? sel.value : "";
        if(!name) return alert("Select a template.");
        const templates = admin.getTemplates();
        const t = templates.find(x => x.name === name);
        if(!t) return alert("Template not found.");
        admin.applyAiSettings(t.aiSettings);
        if(t.sentenceConfig && typeof t.sentenceConfig === 'object') {
            appData.sentenceConfig = JSON.parse(JSON.stringify(t.sentenceConfig));
        }
        if(t.banks && typeof t.banks === 'object') {
            appData.banks = JSON.parse(JSON.stringify(t.banks));
        }
        app.save();
        if(t.sentenceConfig && typeof t.sentenceConfig === 'object') {
            const lvl = typeof currentConfigLevel === 'number' ? currentConfigLevel : 1;
            admin.renderConfig(lvl);
        }
    },
    generatePrompt: (silent) => {
        const c = document.getElementById("ai-count").value;
        const txt = document.getElementById("ai-input").value;
        const q = document.getElementById("ai-question").value || "How does the writer use language?";
        if(!txt) { if(!silent) alert("Paste text."); return; }
        
        const pointCount = Math.max(5, parseInt(c));
        const settings = admin.getAiSettings();
        const lvl = settings.levels;
        const enabledLevels = [1,2,3].filter(n => lvl[n].enabled);
        if(enabledLevels.length === 0) { if(!silent) alert("Select at least one level."); return; }
        const levelRules = enabledLevels.map(n => {
            const l = lvl[n];
            const maxWords = l.maxWords ? `max ${l.maxWords} words` : "short quotes";
            const count = l.count ? `Aim for ${l.count} items` : "Balanced items";
            const ellipsesRule = l.ellipsesMaxWords ? `ellipsis if > ${l.ellipsesMaxWords} words` : "ellipsis only if needed";
            return `- L${n}: ${count}, ${maxWords}, ${l.complexity} meanings/analysis, ${l.subtlety} distractors, ${ellipsesRule}.`;
        }).join("\n");
        const anyCounts = enabledLevels.some(n => (lvl[n].count || 0) > 0);
        const targetSplit = anyCounts ? enabledLevels.map(n => `${lvl[n].count || 0}`).join(" / ") : "balanced across selected levels";

        document.getElementById("ai-prompt-out").value = `Role: Expert English Teacher. 
Task: Create a JSON lesson for students.
Source Text: "${txt.substring(0,800)}..."
Focus Question: "${q}"

Requirements:
1. Create ${c} items. Each item object must have: { id, original (quote from text), translation (meaning), translationDistractors (2 wrong meanings), type (tone/structure/language), effect (analysis sentence), effectDistractors (2 wrong analysis sentences), levels:[1,2,3], includeInWorksheet:true }.
2. Assign EACH item to one level only (${enabledLevels.join(", ")}). Ensure L1 uses simpler quotes/answers, L3 is most nuanced.
3. Level rules:
${levelRules}
4. Manage cognitive load: keep L1 very accessible to reduce overload, L2 for regular practice, L3 to stretch comprehension, memory, and attention. Increase subtlety gradually across levels.
5. If you cannot match the exact target split (${targetSplit}) then keep the level proportions close.
6. Populate 'globalStructure': { enabled:true, items:[ {question, correct, distractors:[2]} ] } (Create 2 distinct questions about the whole text structure, relevant to the Focus Question).
7. Populate 'banks': markers (5), starters (5), methods (5), points (${pointCount} analysis phrases relevant to Focus Question), links:{l1:[3 simple],l2:[3 medium],l3:[3 advanced]}.

Output ONLY valid JSON.`;
        document.getElementById("ai-step2").classList.remove("hidden");
    },
    loadJson: (exportAfter) => {
        try {
            let j = JSON.parse(document.getElementById("ai-json-in").value.replace(/```json|```/g, ''));
            if(Array.isArray(j)) j = { items: j };
            const mode = document.getElementById("ai-mode").value;
            const safe = app.repair(j);
            const aiText = (document.getElementById("ai-input").value || "").trim();
            const aiQuestion = (document.getElementById("ai-question").value || "").trim();
            if(aiText && !j.sourceText) safe.sourceText = aiText;
            if(aiQuestion && !j.question) safe.question = aiQuestion;
            if((!j.meta || !j.meta.title) && aiQuestion) safe.meta.title = aiQuestion;
            
            if(mode === "replace") {
                appData = safe;
                userState.completed = [];
                userState.completedLevels = [];
                userState.filter = "all";
                userState.showDone = false;
                userState.level = 1;
            } else if (mode === "append") {
                appData.items = [...(appData.items||[]), ...(safe.items||[])];
            }
            
            app.save();
            ui.renderLab();
            admin.renderAll();
            const step2 = document.getElementById("ai-step2");
            if(step2) step2.classList.remove("hidden");
            if(exportAfter) admin.exportStandalone();
        } catch(e) { alert("Invalid JSON or corrupted file."); }
    },

    // BANK EDITOR
    editBank: (key) => {
        currentBankKey = key;
        document.getElementById('bank-editor-ui').classList.remove('hidden');
        document.getElementById('bank-name-display').innerText = "Editing: " + key.toUpperCase();
        
        let list = [];
        if(key.includes('link')) {
            const l = key.split('_')[1];
            list = appData.banks.links[l] || [];
        } else {
            list = appData.banks[key] || [];
        }

        const cont = document.getElementById('bank-list-container');
        cont.innerHTML = list.map((val, i) => 
            `<span class="bank-tag">${val}<button onclick="admin.removeBankItem(${i})">x</button></span>`
        ).join('');
    },

    addBankItem: () => {
        const val = document.getElementById('bank-add-input').value;
        if(!val || !currentBankKey) return;
        
        if(currentBankKey.includes('link')) {
            const l = currentBankKey.split('_')[1];
            if(!appData.banks.links[l]) appData.banks.links[l] = [];
            appData.banks.links[l].push(val);
        } else {
            if(!appData.banks[currentBankKey]) appData.banks[currentBankKey] = [];
            appData.banks[currentBankKey].push(val);
        }
        app.save();
        admin.editBank(currentBankKey); 
        document.getElementById('bank-add-input').value = '';
    },

    removeBankItem: (idx) => {
        if(currentBankKey.includes('link')) {
            const l = currentBankKey.split('_')[1];
            appData.banks.links[l].splice(idx, 1);
        } else {
            appData.banks[currentBankKey].splice(idx, 1);
        }
        app.save();
        admin.editBank(currentBankKey);
    },

    renderConfig: function(lvl) {
        currentConfigLevel = lvl;
        const cont = document.getElementById('config-slots'); cont.innerHTML = '';
        const slots = appData.sentenceConfig[lvl];
        const allOpts = ['marker', 'starter', 'quote', 'method', 'link_l1', 'link_l2', 'link_l3', 'point', 'manual_marker', 'manual_starter', 'manual_method', 'manual_point', 'manual_link', 'manual_analysis', 'manual_effect'];
        
        for(let i=0; i<6; i++) {
            const sel = document.createElement('select');
            sel.innerHTML = `<option value="none">None</option>` + allOpts.map(o => `<option value="${o}" ${slots[i]===o?'selected':''}>${o}</option>`).join('');
            sel.onchange = () => {
                const arr = Array.from(cont.querySelectorAll('select')).map(s=>s.value).filter(v=>v!=='none');
                appData.sentenceConfig[lvl] = arr; app.save();
            };
            cont.appendChild(sel);
        }
    },

    // EXPORTS
    exportWorksheet: function() {
        let content = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>Worksheet</title>
        <style>body{font-family:'Aptos','Calibri',sans-serif;} .box{border:1px solid #999; padding:10px; margin-bottom:15px;} .dotted{border-bottom:1px dotted #000; display:inline-block; width:95%; margin-top:5px;}</style>
        </head><body>
        <h1>${appData.meta.title}</h1>
        <p>${appData.sourceText.replace(/\n/g, '<br>')}</p><hr>`;
        
        const structure = appData.sentenceConfig[2] || ["starter", "quote", "method", "manual_analysis"];

        // Part A: Match
        let meanings = appData.items.filter(i=>i.includeInWorksheet).map(i=>i.translation).sort(()=>Math.random()-0.5);
        content += `<h3>Part A: Match Meanings</h3><p><em>Choices: ${meanings.join(' / ')}</em></p>`;
        appData.items.forEach((item, idx) => {
            if(!item.includeInWorksheet) return;
            content += `<p>${idx+1}. "${item.original}" = __________________</p>`;
        });

        // Part B: Analysis
        content += `<br><h3>Part B: Analysis</h3>`;
        appData.items.forEach((item, idx) => {
            if(!item.includeInWorksheet) return;
            content += `<div class="box"><p><strong>${idx+1}. Quote: "${item.original}"</strong></p>`;
            
            structure.forEach(slot => {
                let label = slot.toUpperCase();
                let inner = "";
                
                if(slot === 'quote') return; 
                else if(slot.startsWith('manual')) {
                    inner = `<span class="dotted"></span>`;
                    label = slot.split('_')[1].toUpperCase();
                } else {
                    let key = slot.includes('link') ? (slot.split('_')[1]||'l2') : slot+"s";
                    if(slot==='point') key='points';
                    let opts = (slot.includes('link')) ? appData.banks.links[key] : appData.banks[key];
                    if(opts) inner = `<em>${opts.join(' / ')}</em><br><span class="dotted"></span>`;
                }
                content += `<p><strong>${label}:</strong> ${inner}</p>`;
            });
            content += `<br><p><strong>Sentence:</strong><br><span class="dotted"></span><br><span class="dotted"></span></p></div>`;
        });
        
        content += `</body></html>`;
        const b = new Blob(['\ufeff'+content], {type:'application/msword'});
        const a = document.createElement("a"); a.href=URL.createObjectURL(b); a.download="Worksheet.doc"; a.click();
    },

    exportStandalone: () => {
        if(!appData.items || appData.items.length === 0) {
            return alert("No lesson data to export yet.");
        }
        // 1. Prepare data with lock
        const exportData = JSON.parse(JSON.stringify(appData));
        exportData.isStandalone = true; 

        // 2. Clone document to avoid mutating live DOM
        const clone = document.documentElement.cloneNode(true);
        const cloneDoc = document.implementation.createHTMLDocument();
        cloneDoc.replaceChild(clone, cloneDoc.documentElement);

        // 3. Remove teacher-only UI in the clone
        const adminBtn = cloneDoc.querySelector('#btn-admin');
        if (adminBtn) adminBtn.remove();
        const adminModal = cloneDoc.querySelector('#modal-admin');
        if (adminModal) adminModal.remove();

        // 4. Inject standalone data at start of body
        const dataScript = cloneDoc.createElement('script');
        dataScript.textContent = `window.STANDALONE_LESSON = ${JSON.stringify(exportData)};`;
        cloneDoc.body.prepend(dataScript);

        // 5. Serialize with doctype
        const h = '<!DOCTYPE html>\n' + cloneDoc.documentElement.outerHTML;
        const b = new Blob([h], {type:'text/html'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='StudentApp.html'; a.click();
    },
    saveConfig: () => {
        const b = new Blob([JSON.stringify(appData)], {type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='config.json'; a.click();
    },
    loadFile: (input) => {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = e => { try { appData = app.repair(JSON.parse(e.target.result)); app.save(); location.reload(); } catch(err) { alert("Error"); } };
        r.readAsText(f);
    }
};

window.onload = app.init;
</script>
</body>
</html>
