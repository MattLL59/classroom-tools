<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=5.0, user-scalable=yes">
    <title>The Empathy Code Pro</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Special+Elite&family=Roboto:wght@400;700&display=swap');

        /* Backup styles */
        .hidden { display: none !important; }
        .flex { display: flex !important; }

        body {
            background-color: #2d2d2d;
            font-family: 'Roboto', sans-serif;
            color: #e0e0e0;
            overflow-x: auto;
            touch-action: manipulation;
        }

        .typewriter { font-family: 'Special Elite', cursive; }
        
        .polaroid {
            background: white; padding: 10px 10px 25px 10px;
            box-shadow: 3px 3px 10px rgba(0,0,0,0.4); color: #333;
            transform: rotate(-2deg); transition: transform 0.2s;
        }
        .polaroid:hover { transform: rotate(0deg) scale(1.05); z-index: 10; }

        .evidence-card {
            background-color: #fcf8e3; border: 1px solid #dcdcdc;
            color: #333; cursor: pointer;
        }
        .evidence-card.selected { border: 3px solid #d32f2f; background-color: #fff; }
        .matched { opacity: 0.5; pointer-events: none; border-color: #4caf50 !important; }

        /* Modal Overlay */
        .modal-overlay {
            background: rgba(0,0,0,0.9);
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50; display: flex; justify-content: center; align-items: center;
        }
        
        /* Admin Inputs */
        .admin-input {
            width: 100%; padding: 8px; background: #fff; color: #000;
            border: 1px solid #ccc; border-radius: 4px; font-size: 14px;
        }
        .admin-label { font-size: 11px; font-weight: bold; color: #555; text-transform: uppercase; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- CONFIG BLOCK: THE BRAIN OF THE APP -->
    <script id="app-config" type="application/json">
    {
        "adminPass": "ChiefInspector",
        "caseTitle": "CASE FILE: MMA RAMOTSWE",
        "level1Data": [
            { "text": "\"She drew in her breath.\"", "type": "evidence" },
            { "text": "Mma Ramotswe is shocked and apprehensive.", "type": "insight" },
            { "text": "Happy bluntly announces her \"Daddy\" arrived.", "type": "evidence" },
            { "text": "\"Impostor looking for a retirement home.\"", "type": "evidence" },
            { "text": "Happy is suspicious and tired of being used.", "type": "insight" },
            { "text": "\"I'll find out. I'll find out.\"", "type": "evidence" },
            { "text": "Mma Ramotswe is emphatic and determined.", "type": "insight" }
        ],
        "level2Data": [
            { 
                "evidence": "\"All he does is sit in his chair...\"", 
                "method": "Description / Tone", 
                "insight": "Happy feels resentment at doing all the work." 
            },
            { 
                "evidence": "\"Can you find out...?\"", 
                "method": "Dialogue / Question", 
                "insight": "Happy is desperate for help." 
            },
            { 
                "evidence": "Mma smiles and pays a compliment.", 
                "method": "Body Language", 
                "insight": "Mma seems pleased and polite." 
            },
            { 
                "evidence": "\"Many men are like that.\"", 
                "method": "Short Statement", 
                "insight": "Mma expresses a cynical opinion about men." 
            }
        ]
    }
    </script>

    <!-- Header -->
    <header class="bg-gray-900 p-2 md:p-4 shadow-lg z-10 flex justify-between items-center">
        <div class="flex items-center space-x-3">
            <i class="fas fa-user-secret text-2xl md:text-3xl text-yellow-500"></i>
            <h1 class="text-xl md:text-2xl typewriter text-white tracking-widest">DETECTIVE'S TOOLKIT PRO</h1>
        </div>
        <div class="flex gap-4 items-center">
            <div id="score-board" class="hidden text-yellow-500 typewriter text-sm md:text-xl">
                CASE: <span id="progress-text">0/0</span>
            </div>
            <button onclick="toggleModal('admin-modal')" class="text-gray-500 hover:text-white transition">
                <i class="fas fa-cog text-xl"></i>
            </button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow relative flex items-center justify-center p-2 md:p-4">
        
        <!-- INTRO SCREEN -->
        <div id="screen-intro" class="text-center max-w-2xl bg-gray-800 p-8 rounded-lg shadow-2xl border-t-4 border-yellow-600">
            <h2 id="display-title" class="text-3xl md:text-4xl typewriter mb-6 text-yellow-500">The Empathy Code</h2>
            <p class="text-base md:text-lg mb-8 text-gray-300">
                Detectives, we have a messy file. The evidence is mixed up with the insights. 
                <br><br>
                First, separate the <strong>FACTS</strong> from the <strong>FEELINGS</strong>. Then, connect the clues to solve the case.
            </p>
            <button onclick="startGame1()" class="bg-yellow-600 hover:bg-yellow-700 text-black font-bold py-3 px-8 rounded text-lg md:text-xl transition transform hover:scale-105 typewriter">
                OPEN CASE FILE
            </button>
        </div>

        <!-- GAME 1: SCRAMBLE -->
        <div id="screen-game1" class="hidden w-full max-w-5xl">
            <div class="text-center mb-4">
                <h2 class="text-xl md:text-3xl typewriter text-white">LEVEL 1: The Evidence Scramble</h2>
                <p class="text-gray-400 text-sm">Sort the cards: Is it **Evidence** (Text) or **Insight** (Meaning)?</p>
            </div>
            <div class="flex flex-col md:flex-row justify-between items-start gap-4">
                <div class="w-full md:w-1/3 h-48 md:h-80 bg-gray-700 rounded border-dashed border-4 border-gray-600 flex flex-col items-center justify-center relative p-4 hover:bg-gray-600 cursor-pointer" onclick="sortCard('evidence')">
                    <i class="fas fa-search text-4xl text-blue-300 mb-2"></i>
                    <h3 class="text-xl font-bold text-blue-300">EVIDENCE</h3>
                    <p class="text-xs text-gray-400">What the text SAYS</p>
                </div>
                <div class="w-full md:w-1/3 h-48 md:h-80 flex items-center justify-center relative perspective-1000">
                    <div id="current-card" class="bg-white text-black p-4 rounded shadow-2xl w-full h-40 flex items-center justify-center text-center text-lg font-bold polaroid select-none">
                        <span id="card-text">Loading...</span>
                    </div>
                </div>
                <div class="w-full md:w-1/3 h-48 md:h-80 bg-gray-700 rounded border-dashed border-4 border-gray-600 flex flex-col items-center justify-center relative p-4 hover:bg-gray-600 cursor-pointer" onclick="sortCard('insight')">
                    <i class="fas fa-lightbulb text-4xl text-yellow-300 mb-2"></i>
                    <h3 class="text-xl font-bold text-yellow-300">INSIGHT</h3>
                    <p class="text-xs text-gray-400">What it REVEALS</p>
                </div>
            </div>
            <div id="feedback-g1" class="h-8 text-center mt-2 text-lg font-bold opacity-0 transition-opacity"></div>
        </div>

        <!-- INTERMISSION -->
        <div id="screen-intermission" class="hidden text-center max-w-2xl bg-gray-800 p-8 rounded-lg shadow-2xl border-t-4 border-red-600 slide-up">
            <h2 class="text-2xl typewriter mb-4 text-green-500">LEVEL 1 COMPLETE</h2>
            <p class="text-gray-300 mb-6">Excellent sorting. Now connect the <strong>Red String</strong>.</p>
            <button onclick="startGame2()" class="bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-8 rounded typewriter">START LEVEL 2</button>
        </div>

        <!-- GAME 2: RED STRING -->
        <div id="screen-game2" class="hidden w-full h-full absolute inset-0 corkboard overflow-auto" style="background: #5c4033;">
            <div class="absolute top-2 left-0 w-full text-center z-40 pointer-events-none">
                <span class="text-white bg-black bg-opacity-50 px-4 py-1 rounded typewriter">Connect: Evidence + Method + Insight</span>
            </div>
            <svg id="string-layer" class="absolute inset-0 w-full h-full pointer-events-none z-30"></svg>
            <div class="container mx-auto h-full flex justify-between pt-16 pb-16 px-2 gap-4">
                <div class="w-1/3 flex flex-col space-y-2 z-40">
                    <div class="text-center font-bold text-blue-200 bg-gray-900 p-1 rounded">EVIDENCE</div>
                    <div id="col-evidence" class="flex-grow flex flex-col gap-2"></div>
                </div>
                <div class="w-1/3 flex flex-col space-y-2 z-40">
                    <div class="text-center font-bold text-red-200 bg-gray-900 p-1 rounded">METHOD</div>
                    <div id="col-method" class="flex-grow flex flex-col justify-center gap-2"></div>
                </div>
                <div class="w-1/3 flex flex-col space-y-2 z-40">
                    <div class="text-center font-bold text-yellow-200 bg-gray-900 p-1 rounded">INSIGHT</div>
                    <div id="col-insight" class="flex-grow flex flex-col gap-2"></div>
                </div>
            </div>
            <div class="absolute bottom-4 right-4 z-50">
                 <button id="check-link-btn" onclick="checkLink()" class="bg-gray-600 text-white font-bold py-2 px-6 rounded shadow-lg typewriter opacity-50 cursor-not-allowed" disabled>VERIFY LINK</button>
            </div>
        </div>

        <!-- FINAL SCREEN -->
        <div id="screen-final" class="hidden text-center max-w-4xl bg-white text-gray-900 p-8 rounded shadow-2xl border-4 border-black w-full m-4">
            <h2 class="text-3xl typewriter mb-4 text-red-700 underline">CASE SOLVED</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-left">
                <div>
                    <div class="bg-yellow-100 p-4 border border-yellow-300 font-bold text-sm mb-4">
                        ACTION: Use the summary to write your Q3 Analysis.
                    </div>
                    <button onclick="location.reload()" class="bg-gray-800 text-white font-bold py-2 px-6 rounded w-full">Reset Case</button>
                </div>
                <div class="bg-gray-100 p-4 border border-gray-300 rounded h-64 overflow-y-auto">
                    <h3 class="font-bold border-b border-gray-400 pb-2 mb-2">ðŸ“‚ Case Summary</h3>
                    <div id="final-report-content" class="space-y-2 text-xs"></div>
                </div>
            </div>
        </div>

    </main>

    <!-- ADMIN MODAL -->
    <div id="admin-modal" class="hidden modal-overlay justify-center items-center">
        <div class="bg-white text-black p-6 rounded-lg w-full max-w-4xl h-5/6 overflow-y-auto relative shadow-2xl">
            <button onclick="toggleModal('admin-modal')" class="absolute top-4 right-4 text-xl font-bold hover:text-red-500">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Chief Inspector Admin Panel</h2>

            <!-- LOGIN -->
            <div id="editor-lock-screen" class="text-center py-10">
                <div id="default-pass-alert" class="bg-yellow-100 text-yellow-800 p-2 rounded text-xs mb-4 inline-block hidden">
                    Default Password: <strong>ChiefInspector</strong>
                </div>
                <input type="password" id="admin-password-input" class="border-2 p-2 rounded w-64 mx-auto block mb-4 text-center" placeholder="Enter Password">
                <button onclick="unlockEditor()" class="bg-red-600 text-white px-6 py-2 rounded font-bold hover:bg-red-700">UNLOCK</button>
            </div>

            <!-- EDITOR -->
            <div id="editor-unlocked-screen" class="hidden space-y-6">
                
                <!-- Settings -->
                <div class="bg-blue-50 p-4 rounded grid grid-cols-2 gap-4">
                    <div>
                        <label class="admin-label">Case Title</label>
                        <input type="text" id="edit-case-title" class="admin-input">
                    </div>
                    <div>
                        <label class="admin-label">Admin Password</label>
                        <input type="text" id="new-admin-pass" class="admin-input" autocomplete="off">
                    </div>
                </div>

                <!-- Level 1 Editor -->
                <div class="border p-4 rounded">
                    <div class="flex justify-between mb-2">
                        <h3 class="font-bold text-blue-800">Level 1: Sorting Cards</h3>
                        <button onclick="addL1Card()" class="text-xs bg-green-600 text-white px-2 py-1 rounded">+ Add Card</button>
                    </div>
                    <div id="l1-editor-container" class="space-y-2 max-h-40 overflow-y-auto"></div>
                </div>

                <!-- Level 2 Editor -->
                <div class="border p-4 rounded">
                    <div class="flex justify-between mb-2">
                        <h3 class="font-bold text-red-800">Level 2: The Red String</h3>
                        <button onclick="addL2Link()" class="text-xs bg-green-600 text-white px-2 py-1 rounded">+ Add Link</button>
                    </div>
                    <div id="l2-editor-container" class="space-y-4 max-h-60 overflow-y-auto"></div>
                </div>

                <!-- Footer -->
                <div class="flex justify-between pt-4 border-t">
                    <button onclick="resetToDefaults()" class="text-red-500 text-xs">Reset Defaults</button>
                    <div class="flex gap-2">
                        <button onclick="copySourceCode()" class="bg-gray-700 text-white px-4 py-2 rounded font-bold text-sm">Copy Source</button>
                        <button onclick="exportStandaloneFile()" class="bg-purple-700 text-white px-4 py-2 rounded font-bold text-sm">Download File</button>
                        <button onclick="saveLocal()" class="bg-blue-600 text-white px-4 py-2 rounded font-bold text-sm">Save (Local)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CORE: LOAD CONFIG ---
        let appConfig;
        try {
            const scriptContent = document.getElementById('app-config').textContent;
            appConfig = JSON.parse(scriptContent);
        } catch (e) { console.error("Config Error", e); }

        // --- STATE ---
        let game1Index = 0, game1Score = 0, shuffledSortData = [];
        let selectedEvidence = null, selectedMethod = null, selectedInsight = null, solvedLinks = 0;

        // --- INIT ---
        window.onload = function() {
            // Load Local Overrides if any
            const localConfig = localStorage.getItem('empathyCodeConfig');
            if(localConfig) {
                const parsed = JSON.parse(localConfig);
                // Simple merge for now
                appConfig = parsed;
            }
            document.getElementById('display-title').innerText = appConfig.caseTitle;
        };

        // --- GAME 1 LOGIC ---
        function startGame1() {
            document.getElementById('screen-intro').classList.add('hidden');
            document.getElementById('screen-game1').classList.remove('hidden');
            document.getElementById('score-board').classList.remove('hidden');
            shuffledSortData = [...appConfig.level1Data].sort(() => Math.random() - 0.5);
            game1Index = 0;
            updateGame1Card();
            document.getElementById('progress-text').innerText = `0/${shuffledSortData.length}`;
        }

        function updateGame1Card() {
            if (game1Index >= shuffledSortData.length) {
                setTimeout(() => {
                    document.getElementById('screen-game1').classList.add('hidden');
                    document.getElementById('screen-intermission').classList.remove('hidden');
                }, 500); return;
            }
            document.getElementById('card-text').innerText = shuffledSortData[game1Index].text;
        }

        function sortCard(choice) {
            const current = shuffledSortData[game1Index];
            const fb = document.getElementById('feedback-g1');
            if (current.type === choice) {
                fb.innerText = "CORRECT!"; fb.className = "h-8 text-center mt-2 text-green-400 font-bold opacity-100"; game1Score++;
            } else {
                fb.innerText = "Try again."; fb.className = "h-8 text-center mt-2 text-red-400 font-bold opacity-100";
            }
            setTimeout(() => fb.classList.remove('opacity-100'), 800);
            game1Index++;
            document.getElementById('progress-text').innerText = `${game1Index}/${shuffledSortData.length}`;
            updateGame1Card();
        }

        // --- GAME 2 LOGIC ---
        function startGame2() {
            document.getElementById('screen-intermission').classList.add('hidden');
            document.getElementById('screen-game2').classList.remove('hidden');
            setupGame2Board();
        }

        function setupGame2Board() {
            const createCard = (text, type, id) => {
                const d = document.createElement('div');
                d.className = `evidence-card p-2 rounded shadow text-xs relative hover:bg-white transition-all mb-2`;
                d.innerText = text; d.dataset.type = type; d.dataset.id = id;
                d.onclick = () => selectItem(d, type, id); return d;
            };
            const data = appConfig.level2Data;
            document.getElementById('progress-text').innerText = `0/${data.length}`;
            
            // Randomize columns
            const evs = data.map((d, i) => ({...d, id: i})).sort(() => Math.random() - 0.5);
            const mets = data.map((d, i) => ({...d, id: i})).sort(() => Math.random() - 0.5);
            const ins = data.map((d, i) => ({...d, id: i})).sort(() => Math.random() - 0.5);

            evs.forEach(i => document.getElementById('col-evidence').appendChild(createCard(i.evidence, 'evidence', i.id)));
            mets.forEach(i => document.getElementById('col-method').appendChild(createCard(i.method, 'method', i.id)));
            ins.forEach(i => document.getElementById('col-insight').appendChild(createCard(i.insight, 'insight', i.id)));
        }

        function selectItem(el, type, id) {
            if(el.classList.contains('matched')) return;
            Array.from(el.parentElement.children).forEach(c => c.classList.remove('selected'));
            el.classList.add('selected');
            if (type === 'evidence') selectedEvidence = { el, id };
            if (type === 'method') selectedMethod = { el, id };
            if (type === 'insight') selectedInsight = { el, id };
            
            if(selectedEvidence && selectedMethod && selectedInsight) {
                document.getElementById('check-link-btn').disabled = false;
                document.getElementById('check-link-btn').classList.remove('opacity-50', 'cursor-not-allowed');
                document.getElementById('check-link-btn').classList.add('bg-green-600');
                drawTempLines();
            }
        }

        function checkLink() {
            if (selectedEvidence.id == selectedMethod.id && selectedMethod.id == selectedInsight.id) {
                // Match
                [selectedEvidence.el, selectedMethod.el, selectedInsight.el].forEach(e => {
                    e.classList.remove('selected'); e.classList.add('matched');
                });
                solvedLinks++;
                document.getElementById('progress-text').innerText = `${solvedLinks}/${appConfig.level2Data.length}`;
                
                // Clear selection
                selectedEvidence = null; selectedMethod = null; selectedInsight = null;
                document.getElementById('string-layer').innerHTML = ''; // Clear temp lines
                document.getElementById('check-link-btn').disabled = true;
                document.getElementById('check-link-btn').classList.add('opacity-50');

                if (solvedLinks === appConfig.level2Data.length) {
                    setTimeout(() => {
                        generateReport();
                        document.getElementById('screen-game2').classList.add('hidden');
                        document.getElementById('screen-final').classList.remove('hidden');
                    }, 1000);
                }
            } else {
                alert("The Red String doesn't connect perfectly.");
            }
        }

        function drawTempLines() {
            const svg = document.getElementById('string-layer'); svg.innerHTML = '';
            drawLine(selectedEvidence.el, selectedMethod.el, svg);
            drawLine(selectedMethod.el, selectedInsight.el, svg);
        }

        function drawLine(el1, el2, svg) {
            const r1 = el1.getBoundingClientRect();
            const r2 = el2.getBoundingClientRect();
            const svgR = svg.getBoundingClientRect();
            const line = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            line.setAttribute('x1', (r1.left + r1.right)/2 - svgR.left);
            line.setAttribute('y1', (r1.top + r1.bottom)/2 - svgR.top);
            line.setAttribute('x2', (r2.left + r2.right)/2 - svgR.left);
            line.setAttribute('y2', (r2.top + r2.bottom)/2 - svgR.top);
            line.setAttribute('stroke', '#ffeb3b'); line.setAttribute('stroke-width', '3');
            svg.appendChild(line);
        }

        function generateReport() {
            const con = document.getElementById('final-report-content'); con.innerHTML = '';
            appConfig.level2Data.forEach((d, i) => {
                con.innerHTML += `<div class="bg-white p-2 rounded mb-2 border-l-4 border-red-500"><strong>#${i+1}</strong> Method: ${d.method}<br>Evidence: "${d.evidence}"<br>Insight: ${d.insight}</div>`;
            });
        }

        // --- ADMIN LOGIC ---
        function toggleModal(id) {
            const m = document.getElementById(id);
            if(m.classList.contains('hidden')) {
                m.classList.remove('hidden'); m.classList.add('flex');
                if(id==='admin-modal' && appConfig.adminPass === 'ChiefInspector') document.getElementById('default-pass-alert').classList.remove('hidden');
            } else {
                m.classList.add('hidden'); m.classList.remove('flex');
            }
        }

        function unlockEditor() {
            if(document.getElementById('admin-password-input').value === appConfig.adminPass) {
                document.getElementById('editor-lock-screen').classList.add('hidden');
                document.getElementById('editor-unlocked-screen').classList.remove('hidden');
                renderAdminUI();
            } else alert("Access Denied");
        }

        function renderAdminUI() {
            document.getElementById('edit-case-title').value = appConfig.caseTitle;
            document.getElementById('new-admin-pass').value = appConfig.adminPass;
            
            // L1 Render
            const l1c = document.getElementById('l1-editor-container'); l1c.innerHTML = '';
            appConfig.level1Data.forEach((d, i) => {
                l1c.innerHTML += `<div class="flex gap-2 mb-2"><input class="admin-input flex-1 l1-text" value="${d.text.replace(/"/g, '&quot;')}"><select class="admin-input w-24 l1-type"><option ${d.type=='evidence'?'selected':''}>evidence</option><option ${d.type=='insight'?'selected':''}>insight</option></select><button onclick="delL1(${i})" class="text-red-500 font-bold">x</button></div>`;
            });

            // L2 Render
            const l2c = document.getElementById('l2-editor-container'); l2c.innerHTML = '';
            appConfig.level2Data.forEach((d, i) => {
                l2c.innerHTML += `<div class="border p-2 mb-2 text-xs relative"><button onclick="delL2(${i})" class="absolute top-0 right-0 text-red-500 font-bold px-1">x</button><div class="grid grid-cols-3 gap-1"><input class="admin-input l2-ev" value="${d.evidence.replace(/"/g, '&quot;')}"><input class="admin-input l2-mt" value="${d.method.replace(/"/g, '&quot;')}"><input class="admin-input l2-in" value="${d.insight.replace(/"/g, '&quot;')}"></div></div>`;
            });
        }

        function addL1Card() { appConfig.level1Data.push({text:"", type:"evidence"}); renderAdminUI(); }
        function delL1(i) { appConfig.level1Data.splice(i,1); renderAdminUI(); }
        function addL2Link() { appConfig.level2Data.push({evidence:"", method:"", insight:""}); renderAdminUI(); }
        function delL2(i) { appConfig.level2Data.splice(i,1); renderAdminUI(); }

        function collectConfig() {
            appConfig.caseTitle = document.getElementById('edit-case-title').value;
            appConfig.adminPass = document.getElementById('new-admin-pass').value;
            
            // Collect L1
            const newL1 = [];
            document.querySelectorAll('#l1-editor-container > div').forEach(r => {
                newL1.push({ text: r.querySelector('.l1-text').value, type: r.querySelector('.l1-type').value });
            });
            appConfig.level1Data = newL1.filter(i => i.text !== "");

            // Collect L2
            const newL2 = [];
            document.querySelectorAll('#l2-editor-container > div').forEach(r => {
                newL2.push({
                    evidence: r.querySelector('.l2-ev').value,
                    method: r.querySelector('.l2-mt').value,
                    insight: r.querySelector('.l2-in').value
                });
            });
            appConfig.level2Data = newL2.filter(i => i.evidence !== "");
        }

        function saveLocal() {
            collectConfig();
            localStorage.setItem('empathyCodeConfig', JSON.stringify(appConfig));
            alert("Saved to Browser Memory.");
            location.reload();
        }

        // --- DIRECT INJECTION EXPORT ---
        function exportStandaloneFile() {
            collectConfig();
            // Directly write to the config block
            document.getElementById('app-config').textContent = JSON.stringify(appConfig, null, 4);
            
            // Clean UI
            document.getElementById('screen-game1').classList.add('hidden');
            document.getElementById('screen-game2').classList.add('hidden');
            document.getElementById('screen-final').classList.add('hidden');
            document.getElementById('screen-intro').classList.remove('hidden');
            document.getElementById('admin-modal').classList.add('hidden');
            document.getElementById('admin-modal').classList.remove('flex');
            document.getElementById('editor-lock-screen').classList.remove('hidden');
            document.getElementById('editor-unlocked-screen').classList.add('hidden');
            document.getElementById('admin-password-input').value = '';

            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const safeTitle = appConfig.caseTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            a.href = url;
            a.download = `empathy_code_${safeTitle}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            location.reload();
        }

        function copySourceCode() {
            collectConfig();
            document.getElementById('app-config').textContent = JSON.stringify(appConfig, null, 4);
            
            // Fallback Copy
            const htmlContent = document.documentElement.outerHTML;
            const textArea = document.createElement("textarea");
            textArea.value = htmlContent;
            textArea.style.position = "fixed"; textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try { document.execCommand('copy'); alert("Source Code Copied!"); } 
            catch (err) { prompt("Copy failed. Manually copy:", htmlContent); }
            document.body.removeChild(textArea);
            location.reload();
        }

        function resetToDefaults() {
            if(confirm("Reset?")) { localStorage.removeItem('empathyCodeConfig'); location.reload(); }
        }
    </script>
</body>
</html>
