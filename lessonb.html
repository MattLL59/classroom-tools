<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tone &amp; Structure Architect v182 (Structure Upgrade)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #009688; 
            --accent: #ff9800; 
            --bg: #f0f2f5;
            --card: #ffffff; 
            --text: #37474f; 
            --tone-col: #9c27b0;
            --struct-col: #2196f3; 
            --lang-col: #4caf50; 
            --nav-bg: #ffffff;
            --success: #4caf50; 
            --error: #f44336;
            --high-vis: #29b6f6;
        }
        
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s, color 0.3s; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--card); box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; flex-shrink: 0; }
        h1 { margin: 0; font-size: 1.1rem; color: var(--primary); display:flex; align-items:center; gap:5px; }
        .score-badge { background: var(--accent); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.9rem; margin-left: 10px; font-weight: bold; }

        /* LOADING / RESET TEXT */
        .loading-text { cursor: pointer; color: var(--error); font-weight: bold; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* LAYOUT */
        .main-viewport { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        nav.bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: var(--nav-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 900; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; color: #888; font-size: 0.75rem; border: none; background: none; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        
        /* HUBS */
        .hub { display: none; } .hub.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        /* GRID SECTIONS */
        .section-header {
            font-size: 0.9rem;
            text-transform: uppercase;
            color: #888;
            margin: 15px 0 5px 0;
            border-bottom: 1px solid #ccc;
            padding-bottom: 2px;
        }

        .grid { display: grid; grid-template-columns: 1fr; gap: 12px; margin-bottom: 20px; }
        @media(min-width: 600px) { .grid { grid-template-columns: 1fr 1fr; } }
        
        #structure-container { margin-top: 5px; }

        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 2px solid #ddd; text-align: center; font-size: 1.1rem; cursor: pointer; transition: transform 0.1s; position: relative; overflow: visible; }
        .card:hover { transform: scale(1.02); border-color: var(--primary); }
        .card-tone { border-left: 10px solid var(--tone-col); }
        .card-struct { border-left: 10px solid var(--struct-col); text-align: left; }
        .card-lang { border-left: 10px solid var(--lang-col); }
        .card-global { border-left: 10px solid #607d8b; background: var(--card); width: 100%; box-sizing: border-box; text-align: left; display: flex; align-items: center; justify-content: space-between; }

        /* ANIMATIONS */
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        .shake { animation: shake 0.4s ease-in-out; border-color: var(--error) !important; background: #ffebee !important; }

        /* BUILDER */
        .bank-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; background: rgba(0,0,0,0.02); padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; }
        .bank-row { text-align: left; width: 100%; margin-bottom: 10px; display: block; }
        .bank-label { font-size: 0.8rem; font-weight: bold; text-transform: uppercase; color: var(--primary); margin-bottom: 5px; display: block;}
        
        select { 
            width: 100%; 
            height: 45px; 
            padding: 8px; 
            border-radius: 6px; 
            border: 1px solid #bbb; 
            background: var(--card); 
            color: var(--text);
            font-size: 1rem; 
            display: block;
            margin-bottom: 5px;
        } 
        
        #sentence-stage { 
            width: 100%; 
            padding: 15px; 
            background: var(--card); 
            border: 2px dashed var(--primary); 
            border-radius: 10px; 
            margin: 15px 0; 
            font-size: 1.1rem; 
            min-height: 60px; 
            line-height: 1.4; 
            cursor: text;
            color: var(--text);
        }
        #sentence-stage:focus { outline: 2px solid var(--accent); }

        #answer-area { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; background: var(--card); color: var(--text); font-family: inherit; margin-bottom: 10px; font-size: 1rem; }
        #quote-reference { background: #e3f2fd; border-left: 5px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px; font-style: italic; color: #444; display: none; }

        /* ADMIN & EDITORS */
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; font-size: 1rem;}
        .btn-primary { background: var(--primary); width: 100%; }
        .btn-warning { background: var(--accent); }
        .btn-danger { background: #e74c3c; }
        .btn-doc { background: #1976d2; }
        .btn-high-vis { background: var(--high-vis); color: #000; font-size: 1.1rem; border: 2px solid #000; }
        .admin-btn { background:none; border:none; color:var(--text); font-size:1.2rem; cursor:pointer; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999999; justify-content: center; align-items: center; }
        
        .modal-content { 
            background: var(--card); 
            color: var(--text); 
            width: 95%; 
            max-width: 1200px; 
            max-height: 95vh; 
            border-radius: 8px; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            overflow: visible !important; 
        }
        
        .modal-header { padding: 15px; background: rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-body { padding: 20px; overflow-y: auto; text-align: left; padding-bottom: 400px; } 
        
        .editor-section { 
            border: 2px solid #ddd; 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: 5px; 
            background: rgba(0,0,0,0.02); 
            overflow: visible !important; 
        }
        
        .admin-input { width: 100%; padding: 10px; border: 1px solid #aaa; border-radius: 4px; box-sizing: border-box; margin-bottom: 5px; font-size: 1rem; background: var(--card); color: var(--text); }
        .admin-tab-bar { display: flex; gap:5px; margin-bottom:10px; }
        .admin-tab { flex:1; padding:10px; border:2px solid #ccc; background:#eee; cursor:pointer; font-weight:bold; border-radius:4px; text-align:center; color:#333; }
        .admin-tab.active { background:var(--accent); color:white; border-color:var(--accent); }
        .bank-edit-btn { background:#607d8b; color:white; padding:5px 10px; border-radius:4px; border:none; margin:2px; font-size:0.85rem; cursor:pointer; }
        
        .item-editor-card { 
            border: 1px solid #ccc; 
            padding: 15px; 
            margin-bottom: 15px; 
            background: var(--card); 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            overflow: visible !important; 
            position: relative; 
            z-index: 1;
        }
        
        .item-header-row {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px;
            flex-wrap: wrap; 
            gap: 15px;
        }
        
        .item-header-row select {
            width: auto !important;
            min-width: 150px;
            height: 40px !important;
            position: relative;
            z-index: 99999; 
        }
        
        .level-block { margin-top: 10px; padding: 10px; border: 1px solid #eee; background: rgba(0,0,0,0.03); border-radius: 4px; }
        .level-label { font-weight: bold; display: block; margin-bottom: 5px; color: var(--text); font-size: 0.9rem; }
        .input-group { margin-bottom: 15px; }
        .input-group label { font-size: 0.85rem; font-weight: bold; color: var(--text); display:block; margin-bottom:5px;}

        /* LENS TOGGLES IN EDITOR */
        .lens-toggles { display: flex; gap: 15px; margin-bottom: 10px; background: rgba(0,0,0,0.05); padding: 8px; border-radius: 4px; align-items:center;}
        .lens-toggles label { font-size: 0.9rem; display: flex; align-items: center; gap: 5px; cursor: pointer; font-weight:bold; }

        /* THEME PICKER */
        .theme-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px; border-bottom: 1px solid #eee; }
        .color-picker { width: 50px; height: 30px; border: none; cursor: pointer; }

        /* HELP MANUAL STYLE */
        .help-section { margin-bottom: 20px; border-bottom: 1px solid #ccc; padding-bottom: 10px; }
        .help-title { font-size: 1.1rem; color: var(--primary); font-weight: bold; margin-bottom: 5px; }
        .help-list { padding-left: 20px; line-height: 1.6; }

        /* CELEBRATION */
        #celebration-modal { text-align: center; }
        .firework-icon { font-size: 4rem; color: #ff9800; animation: spin 2s infinite linear; margin-bottom: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #feedback-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:20000; display:none; flex-direction:column; justify-content:center; align-items:center; color:white; text-align:center; }
        #feedback-icon { font-size: 5rem; margin-bottom: 20px; }
        #save-status { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; opacity: 0; transition: 0.5s; z-index: 10000; }
        
        @media print { 
            .no-print { display: none; } 
            .page-break { page-break-before: always; display: block; height: 1px; }
        }
    </style>
</head>
<body data-new-gr-c-s-check-loaded="14.1268.0" data-gr-ext-installed="">

    <header>
        <h1>
            <button onclick="clearSession()" style="background:red; color:white; border:none; border-radius:50%; width:25px; height:25px; font-weight:bold; cursor:pointer; font-size:0.8rem; margin-right:5px;" title="New Session">‚ú®</button>
            <i class="fas fa-cubes"></i> Tone &amp; Structure v182
            <span class="score-badge" id="score-display">60 XP</span>
        </h1>
        <div style="display:flex; gap:10px;">
            <button class="admin-btn" title="User Guide" onclick="openHelp()"><i class="fas fa-question-circle"></i></button>
            <button class="admin-btn" title="Customize Theme" onclick="openThemeModal()"><i class="fas fa-palette"></i></button>
            <select id="level-select" style="padding:4px; border-radius:4px;">
                <option value="1">Lvl 1</option><option value="2">L2</option><option value="3">L3</option>
            </select>
            <button id="main-settings-btn" class="admin-btn"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div id="student-banner" style="display:none; width:100%; background:var(--accent); color:white; padding:5px; text-align:center; font-weight:bold;">
        üéì Student Mode: <span id="student-title">The BBC: Neighbour from Hell?</span>
    </div>
    
    <div id="save-status">üíæ Progress Saved</div>

    <div class="main-viewport">
        <div id="hub-lab" class="hub active">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.9rem;">
                <span style="flex:1;"><strong><span id="header-label">Topic</span>:</strong> <span id="text-display">The BBC: Neighbour from Hell?</span></span>
                <span style="flex:1; text-align:right;"><strong>Q:</strong> <span id="q-display">To what extent does the writer show frustration and anger at the BBC?</span></span>
            </div>
            <div id="lab-content">
                <div class="instruction">Step 1: Choose Evidence</div>
                <div class="filter-bar" id="main-filter-bar" style="display: none; gap: 5px; justify-content: center; margin-bottom: 10px;">
                    <button class="btn" onclick="filterGrid('all')">All</button>
                    <button class="btn" onclick="filterGrid('language')">Lang</button>
                    <button class="btn" onclick="filterGrid('structure')">Struct</button>
                </div>
                <div id="dynamic-question-display" class="dynamic-question">Select Evidence</div>
                
                <div class="section-header">Evidence (Quotes)</div>
                <div class="grid" id="grid-main"><div class="card card-language"><strong>"neighbour from hell"</strong><br><small>language</small></div><div class="card card-structure"><strong>"state-funded juggernaut"</strong><br><small>structure</small></div><div class="card card-tone"><strong>"taken an axe to its much-loved local radio"</strong><br><small>tone</small></div><div class="card card-structure"><strong>"Unlike Google, and Meta, the BBC‚Äôs funding is guaranteed"</strong><br><small>structure</small></div><div class="card card-tone"><strong>"splashing your cash"</strong><br><small>tone</small></div><div class="card card-structure"><strong>"So, it is time the BBC showed that it is not the biggest threat"</strong><br><small>structure</small></div></div>
                
                <div class="section-header">Global Analysis</div>
                <div id="structure-container"></div>
            </div>
        </div>

        <div id="hub-writing" class="hub">
            <div id="quote-reference"></div>
            <div class="instruction">Sentence Construction</div>
            <div class="bank-list" id="dynamic-builder-controls"><div class="bank-row">
                <span class="bank-label">STARTER</span>
                <select class="bank-select" onchange="updateSlot('starter', this.value)">
                    <option value="">Choose starter...</option><option value="The writer suggests">The writer suggests</option><option value="The author highlights">The author highlights</option><option value="The writer emphasizes">The writer emphasizes</option><option value="The author implies">The author implies</option><option value="The writer conveys">The writer conveys</option>
                </select>
            </div><div class="bank-row">
                <span class="bank-label">LINK</span>
                <select class="bank-select" onchange="updateSlot('link', this.value)">
                    <option value="">Choose link...</option><option value="This shows">This shows</option><option value="Here we see">Here we see</option><option value="This demonstrates">This demonstrates</option><option value="It is clear">It is clear</option><option value="This indicates">This indicates</option>
                </select>
            </div><div class="bank-row">
                <span class="bank-label">POINT</span>
                <select class="bank-select" onchange="updateSlot('point', this.value)">
                    <option value="">Choose point...</option><option value="a sense of deep unfairness">a sense of deep unfairness</option><option value="anger at the destruction of local news">anger at the destruction of local news</option><option value="frustration with the BBC's dominance">frustration with the BBC's dominance</option><option value="a feeling of powerlessness">a feeling of powerlessness</option><option value="resentment towards the funding model">resentment towards the funding model</option>
                </select>
            </div></div>
            <div class="instruction">Current Construction (Editable):</div>
            <div id="sentence-stage" contenteditable="true" oninput="manualEdit()">Start picking words in the Lab...</div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn btn-warning" style="flex:1" onclick="undoLast()">Undo</button>
                <button class="btn btn-primary" style="flex:2" onclick="commitSentence()">Add to Answer</button>
            </div>
            <hr style="opacity:0.2;">
            <textarea id="answer-area" placeholder="Your full answer will appear here..." oninput="autoSaveProgress()"></textarea>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-doc" style="flex:1" onclick="downloadDoc()">Download .doc</button>
                <button class="btn btn-warning" style="flex:0 0 auto; background:#e74c3c;" onclick="clearEssay()">Reset Essay</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button id="nav-lab" class="nav-item active" onclick="switchHub('lab')"><i class="fas fa-vial"></i><span>Evidence Lab</span></button>
        <button id="nav-writing" class="nav-item" onclick="switchHub('writing')"><i class="fas fa-pen-fancy"></i><span>Writing Desk</span></button>
    </nav>

    <div id="help-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">üìñ User Guide <button onclick="document.getElementById('help-modal').style.display='none'">X</button></div>
            <div class="modal-body">
                <div class="help-section">
                    <div class="help-title">1. The Evidence Lab (Student Mode)</div>
                    <ul class="help-list">
                        <li><strong>Step 1:</strong> Select a colored quote card from the "Evidence" grid.</li>
                        <li><strong>Step 2 (Match):</strong> Choose the correct meaning of the quote.</li>
                        <li><strong>Step 3 (Analyze):</strong> Choose a Lens (Tone, Structure, or Language). <em>Note: Teachers can hide specific lenses if they are empty or irrelevant for a quote.</em></li>
                        <li><strong>Whole Text:</strong> The gray card at the bottom covers general structure questions.</li>
                    </ul>
                </div>
                <div class="help-section">
                    <div class="help-title">2. The Writing Desk</div>
                    <ul class="help-list">
                        <li><strong>Build:</strong> Use the dropdown menus to construct a high-level analytical sentence.</li>
                        <li><strong>Edit:</strong> You can type directly into the "Current Construction" box to tweak your sentence.</li>
                        <li><strong>Save:</strong> Click "Add to Answer" to move your sentence into the main essay box.</li>
                    </ul>
                </div>
                <div class="help-section">
                    <div class="help-title">3. Teacher Tools (Settings)</div>
                    <ul class="help-list">
                        <li><strong>AI Generator:</strong> Paste a text/question, generate a prompt, and load the JSON response. Use "Append" to add to existing lessons.</li>
                        <li><strong>Edit Evidence:</strong> Use the checkboxes (Tone/Structure/Language) to <strong>hide specific buttons</strong> for a quote if the AI did not generate a good question for it.</li>
                        <li><strong>Worksheet:</strong> Click "Download Worksheet" for a printable Word doc. This includes a page break between matching and analysis.</li>
                    </ul>
                </div>
                <div class="help-section">
                    <div class="help-title">4. Exporting &amp; Hosting</div>
                    <ul class="help-list">
                        <li><strong>Download Student App:</strong> In Settings, click the big blue "Download Student App" button. This creates a single `.html` file containing your entire lesson.</li>
                        <li><strong>How to Host:</strong>
                            <ul>
                                <li><strong>Google Classroom / Teams:</strong> Upload the HTML file as an "Assignment Material". Students simply click to download and open it in their browser.</li>
                                <li><strong>Moodle / Canvas:</strong> Upload as a "File Resource".</li>
                                <li><strong>Network Drive:</strong> Save it to a shared folder. Students double-click to run.</li>
                            </ul>
                        </li>
                        <li><strong>No Internet Needed:</strong> The student file works entirely offline once downloaded.</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal" style="display: flex;">
        <div class="modal-content">
            <div class="modal-header">Settings <button id="close-admin-btn">X</button></div>
            <div class="modal-body">
                
                <div class="editor-section" style="border: 2px solid var(--primary); background: #e0f2f1;">
                    <h3 style="color:var(--primary); margin-top:0;"><i class="fas fa-robot"></i> Lesson Generator &amp; File Manager</h3>
                    
                    <div style="background:white; padding:10px; border-radius:5px; margin-bottom:15px; border:1px solid #ccc; display:flex; align-items:center; justify-content:space-between;">
                        <span style="font-weight:bold;">Load Mode:</span>
                        <select id="ai-bank-mode" class="admin-input" style="width:70%; margin:0; font-weight:bold;">
                            <option value="replace">Replace Current Lesson</option>
                            <option value="append">Append (Add to existing)</option>
                        </select>
                    </div>

                    <div class="input-group">
                        <label>Author Name:</label>
                        <input id="ai-author-name" class="admin-input" placeholder="e.g. Charles Dickens">
                    </div>
                    <div class="input-group">
                        <label>Number of Quotes:</label>
                        <input id="ai-quote-count" type="number" class="admin-input" value="6" min="1" max="15">
                    </div>

                    <textarea id="ai-source-text" class="admin-input" style="height:60px;" placeholder="Paste Source Text..."></textarea>
                    <textarea id="ai-question-input" class="admin-input" style="height:40px;" placeholder="Lesson Question..."></textarea>
                    
                    <button class="btn" style="background:#7b1fa2; width:100%; margin:5px 0;" onclick="generateAndShowPrompt()">1. Generate AI Prompt</button>
                    
                    <div id="prompt-display-container" style="display:none; margin-bottom:5px;">
                        <textarea id="ai-generated-prompt" class="admin-input" style="height:80px; background:#e1bee7;" readonly=""></textarea>
                    </div>
                    <textarea id="ai-paste-area" class="admin-input" style="height:60px;" placeholder="2. Paste AI JSON Here..."></textarea>
                    <button class="btn" style="background:var(--primary); width:100%; margin-bottom:15px;" onclick="loadDataFromText()">üì• Load AI Data</button>

                    <hr>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                        <button class="btn btn-doc" onclick="downloadJSON()"><i class="fas fa-save"></i> Save File</button>
                        <label class="btn btn-primary" style="text-align:center; cursor:pointer;">
                            <i class="fas fa-folder-open"></i> Upload File
                            <input type="file" id="file-upload" onchange="uploadJSON(this)" style="display:none;">
                        </label>
                    </div>

                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px;">
                        <button class="btn btn-high-vis" style="font-size:0.9rem;" onclick="downloadWorksheetDoc()">üìÑ Worksheet</button>
                        <button class="btn btn-primary" style="background:#34495e; font-size:0.9rem;" onclick="downloadStudentApp()">üì¶ Student App</button>
                    </div>
                </div>

                <div class="editor-section">
                    <h3>Basic Info</h3>
                    <label>Title:</label><input id="edit-title" class="admin-input" oninput="updateGlobal('textTitle', this.value)">
                    <label>Question:</label><input id="edit-question" class="admin-input" oninput="updateGlobal('question', this.value)">
                </div>

                <div class="editor-section" style="border-left: 5px solid #2196f3;">
                    <h3>‚öôÔ∏è Sentence Structure (Admin)</h3>
                    <div class="admin-tab-bar">
                        <div id="cfg-tab-1" class="admin-tab active" onclick="switchAdminConfigLevel(1)">Lvl 1</div>
                        <div id="cfg-tab-2" class="admin-tab" onclick="switchAdminConfigLevel(2)">Lvl 2</div>
                        <div id="cfg-tab-3" class="admin-tab" onclick="switchAdminConfigLevel(3)">Lvl 3</div>
                    </div>
                    <div style="display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap;">
                        <select class="admin-input" id="cfg-slot1" onchange="saveStructureConfig()"><option value="marker">marker</option><option value="starter">starter</option><option value="point">point</option><option value="method">method</option><option value="quote">quote</option><option value="analysis">analysis</option><option value="link">link</option><option value="none">none</option></select>
                        <select class="admin-input" id="cfg-slot2" onchange="saveStructureConfig()"><option value="marker">marker</option><option value="starter">starter</option><option value="point">point</option><option value="method">method</option><option value="quote">quote</option><option value="analysis">analysis</option><option value="link">link</option><option value="none">none</option></select>
                        <select class="admin-input" id="cfg-slot3" onchange="saveStructureConfig()"><option value="marker">marker</option><option value="starter">starter</option><option value="point">point</option><option value="method">method</option><option value="quote">quote</option><option value="analysis">analysis</option><option value="link">link</option><option value="none">none</option></select>
                        <select class="admin-input" id="cfg-slot4" onchange="saveStructureConfig()"><option value="marker">marker</option><option value="starter">starter</option><option value="point">point</option><option value="method">method</option><option value="quote">quote</option><option value="analysis">analysis</option><option value="link">link</option><option value="none">none</option></select>
                        <select class="admin-input" id="cfg-slot5" onchange="saveStructureConfig()"><option value="marker">marker</option><option value="starter">starter</option><option value="point">point</option><option value="method">method</option><option value="quote">quote</option><option value="analysis">analysis</option><option value="link">link</option><option value="none">none</option></select>
                        <select class="admin-input" id="cfg-slot6" onchange="saveStructureConfig()"><option value="marker">marker</option><option value="starter">starter</option><option value="point">point</option><option value="method">method</option><option value="quote">quote</option><option value="analysis">analysis</option><option value="link">link</option><option value="none">none</option></select>
                    </div>
                </div>

                <div class="editor-section">
                    <h3>‚úçÔ∏è Analysis Banks (Edit)</h3>
                    <div style="display:flex; gap:5px; flex-wrap:wrap;">
                        <button class="bank-edit-btn" onclick="editBank('markers')">Markers</button>
                        <button class="bank-edit-btn" onclick="editBank('starters')">Starters</button>
                        <button class="bank-edit-btn" onclick="editBank('methods')">Methods</button>
                        <button class="bank-edit-btn" onclick="editBank('simpleLinks')">Links (L1)</button>
                        <button class="bank-edit-btn" onclick="editBank('complexLinks')">Links (L2/3)</button>
                        <button class="bank-edit-btn" onclick="editBank('points')">Points</button>
                    </div>
                    <div id="bank-editor-area" style="margin-top:10px; padding:10px; border:1px solid #ccc; display:none; background:#fafafa;">
                        <div style="display:flex; justify-content:space-between;">
                            <h4 id="bank-editor-title" style="margin:0;">Editing...</h4>
                            <button onclick="document.getElementById('bank-editor-area').style.display='none'" style="border:none;background:none;">‚ùå</button>
                        </div>
                        <div id="bank-list" class="list-container" style="max-height:200px; overflow-y:auto; margin-top:10px;"></div>
                        <button class="btn btn-add" style="background:#2ecc71;" onclick="addBankItem()">+ Add Item</button>
                    </div>
                </div>
                
                <div style="margin-top:10px; display:flex; gap:15px; margin-bottom:20px;">
                    <label><input type="checkbox" id="auto-progress-check" onchange="toggleAutoProgress(this.checked)"> Auto-Progress</label>
                    <label><input type="checkbox" id="auto-login-check" onchange="toggleAutoLogin(this.checked)"> Keep Unlocked</label>
                </div>

                <div class="editor-section" style="border-left: 5px solid #607d8b; background:#eceff1;">
                    <h3>üèóÔ∏è Whole Text Structure (Edit)</h3>
                    <label style="display:block; margin-bottom:10px; font-weight:bold; cursor:pointer;">
                        <input type="checkbox" id="global-enabled-check" onchange="updateGlobalDeep('enabled', this.checked)"> Enable Section
                    </label>
                    <div class="input-group"><label>Question:</label><input id="global-q-input" class="admin-input" onchange="updateGlobalDeep('question', this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input id="global-correct-input" class="admin-input" onchange="updateGlobalDeep('correct', this.value)"></div>
                    <div class="input-group"><label>Distractors (Comma separated):</label><input id="global-dist-input" class="admin-input" onchange="updateGlobalDeep('distractors', this.value)"></div>
                </div>

                <div class="editor-section" style="border-left: 5px solid var(--accent);">
                    <h3>üìù Edit Evidence &amp; Analysis</h3>
                    <p style="font-size:0.9rem;">Uncheck Tone/Struct/Lang to hide empty questions from students.</p>
                    <div id="items-container">
            <div class="item-editor-card">
                <div class="item-header-row">
                    <strong>#1</strong>
                    <select onchange="updateItem(0,'type',this.value)">
                        <option value="tone">Tone</option>
                        <option value="structure">Structure</option>
                        <option value="language" selected="">Language</option>
                    </select>
                    <div>
                        <label title="Include in Worksheet"><input type="checkbox" onchange="updateItemBool(0,'includeInWS',this.checked)"> WS</label>
                    </div>
                </div>
                
                <div class="lens-toggles">
                    <strong>Enable Lenses:</strong>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(0,'enableTone',this.checked)"> Tone</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(0,'enableStructure',this.checked)"> Structure</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(0,'enableLanguage',this.checked)"> Language</label>
                </div>

                <div class="input-group"><label>Quote:</label><input class="admin-input" value="state-funded juggernaut" onchange="updateItem(0,'original',this.value)"></div>
                <div class="input-group"><label>Translation:</label><input class="admin-input" value="A huge, unstoppable force paid for by the government/people" onchange="updateItem(0,'translation',this.value)"></div>
                <div class="input-group"><label>Match Distractors (CSV):</label><input class="admin-input" value="A small local business, A slow moving vehicle, A helpful charity" onchange="updateDistractors(0,'base',this.value)"></div>
                
                <div class="level-block level-1">
                    <span class="level-label">Level 1 (Identify)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What technique is used in 'juggernaut'?" onchange="updateDeep(0,'level1','language','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="Metaphor" onchange="updateDeep(0,'level1','language','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="Simile, Personification" onchange="updateDistractors(0,'level1',this.value)"></div>
                </div>
                
                <div class="level-block level-2">
                    <span class="level-label">Level 2 (Analyze)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What does the noun 'juggernaut' suggest?" onchange="updateDeep(0,'level2','language','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="An overwhelming, destructive force that cannot be stopped" onchange="updateDeep(0,'level2','language','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="A carefully planned operation, A gentle and supportive friend" onchange="updateDistractors(0,'level2',this.value)"></div>
                </div>
                
                <div class="level-block level-3">
                    <span class="level-label">Level 3 (Evaluate Effect)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="Evaluate the effect of combining 'state-funded' with 'juggernaut'." onchange="updateDeep(0,'level3','language','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="It creates a paradox: a public service acting like a destructive monster" onchange="updateDeep(0,'level3','language','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="It makes the BBC sound efficient and modern, It explains how the licence fee works" onchange="updateDistractors(0,'level3',this.value)"></div>
                </div>
                
                <button class="btn btn-warning" style="margin-top:10px;" onclick="delItem(0)">Delete Item</button>
            </div>
            <div class="item-editor-card">
                <div class="item-header-row">
                    <strong>#2</strong>
                    <select onchange="updateItem(1,'type',this.value)">
                        <option value="tone">Tone</option>
                        <option value="structure">Structure</option>
                        <option value="language" selected="">Language</option>
                    </select>
                    <div>
                        <label title="Include in Worksheet"><input type="checkbox" onchange="updateItemBool(1,'includeInWS',this.checked)"> WS</label>
                    </div>
                </div>
                
                <div class="lens-toggles">
                    <strong>Enable Lenses:</strong>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(1,'enableTone',this.checked)"> Tone</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(1,'enableStructure',this.checked)"> Structure</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(1,'enableLanguage',this.checked)"> Language</label>
                </div>

                <div class="input-group"><label>Quote:</label><input class="admin-input" value="suffocate independent journalism" onchange="updateItem(1,'original',this.value)"></div>
                <div class="input-group"><label>Translation:</label><input class="admin-input" value="To kill off or stop local news from surviving" onchange="updateItem(1,'translation',this.value)"></div>
                <div class="input-group"><label>Match Distractors (CSV):</label><input class="admin-input" value="To help journalism breathe, To hide the news, To buy local newspapers" onchange="updateDistractors(1,'base',this.value)"></div>
                
                <div class="level-block level-1">
                    <span class="level-label">Level 1 (Identify)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What type of imagery is 'suffocate'?" onchange="updateDeep(1,'level1','language','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="Violent imagery" onchange="updateDeep(1,'level1','language','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="Natural imagery, Peaceful imagery" onchange="updateDistractors(1,'level1',this.value)"></div>
                </div>
                
                <div class="level-block level-2">
                    <span class="level-label">Level 2 (Analyze)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What does 'suffocate' imply about the method of destruction?" onchange="updateDeep(1,'level2','language','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="It is a slow, painful deprivation of resources (oxygen/money)" onchange="updateDeep(1,'level2','language','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="It is a quick and painless end, It is an accidental occurrence" onchange="updateDistractors(1,'level2',this.value)"></div>
                </div>
                
                <div class="level-block level-3">
                    <span class="level-label">Level 3 (Evaluate Effect)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="Evaluate the impact of personifying journalism here." onchange="updateDeep(1,'level3','language','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="It treats journalism as a living thing being murdered, evoking strong sympathy" onchange="updateDeep(1,'level3','language','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="It makes the text sound more scientific, It suggests journalism is boring" onchange="updateDistractors(1,'level3',this.value)"></div>
                </div>
                
                <button class="btn btn-warning" style="margin-top:10px;" onclick="delItem(1)">Delete Item</button>
            </div>
            <div class="item-editor-card">
                <div class="item-header-row">
                    <strong>#3</strong>
                    <select onchange="updateItem(2,'type',this.value)">
                        <option value="tone" selected="">Tone</option>
                        <option value="structure">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div>
                        <label title="Include in Worksheet"><input type="checkbox" onchange="updateItemBool(2,'includeInWS',this.checked)"> WS</label>
                    </div>
                </div>
                
                <div class="lens-toggles">
                    <strong>Enable Lenses:</strong>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(2,'enableTone',this.checked)"> Tone</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(2,'enableStructure',this.checked)"> Structure</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(2,'enableLanguage',this.checked)"> Language</label>
                </div>

                <div class="input-group"><label>Quote:</label><input class="admin-input" value="taken an axe to its much-loved local radio" onchange="updateItem(2,'original',this.value)"></div>
                <div class="input-group"><label>Translation:</label><input class="admin-input" value="Violently cut or closed down popular stations" onchange="updateItem(2,'translation',this.value)"></div>
                <div class="input-group"><label>Match Distractors (CSV):</label><input class="admin-input" value="Carefully reduced spending, Fixed old equipment, Built a new studio" onchange="updateDistractors(2,'base',this.value)"></div>
                
                <div class="level-block level-1">
                    <span class="level-label">Level 1 (Identify)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What is the tone of 'taken an axe'?" onchange="updateDeep(2,'level1','tone','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="Aggressive and brutal" onchange="updateDeep(2,'level1','tone','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="Calm and clinical, Sad and regretful" onchange="updateDistractors(2,'level1',this.value)"></div>
                </div>
                
                <div class="level-block level-2">
                    <span class="level-label">Level 2 (Analyze)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="Why describe the radio as 'much-loved'?" onchange="updateDeep(2,'level2','tone','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="To heighten the outrage by showing the BBC destroying something popular" onchange="updateDeep(2,'level2','tone','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="To show that radio is old-fashioned, To complain about music choices" onchange="updateDistractors(2,'level2',this.value)"></div>
                </div>
                
                <div class="level-block level-3">
                    <span class="level-label">Level 3 (Evaluate Effect)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="Evaluate the emotional shift in this sentence." onchange="updateDeep(2,'level3','tone','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="It moves from suspicion ('seems to be') to confirmed brutality ('taken an axe')" onchange="updateDeep(2,'level3','tone','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="It moves from anger to happiness, It stays neutral throughout" onchange="updateDistractors(2,'level3',this.value)"></div>
                </div>
                
                <button class="btn btn-warning" style="margin-top:10px;" onclick="delItem(2)">Delete Item</button>
            </div>
            <div class="item-editor-card">
                <div class="item-header-row">
                    <strong>#4</strong>
                    <select onchange="updateItem(3,'type',this.value)">
                        <option value="tone" selected="">Tone</option>
                        <option value="structure">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div>
                        <label title="Include in Worksheet"><input type="checkbox" onchange="updateItemBool(3,'includeInWS',this.checked)"> WS</label>
                    </div>
                </div>
                
                <div class="lens-toggles">
                    <strong>Enable Lenses:</strong>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(3,'enableTone',this.checked)"> Tone</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(3,'enableStructure',this.checked)"> Structure</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(3,'enableLanguage',this.checked)"> Language</label>
                </div>

                <div class="input-group"><label>Quote:</label><input class="admin-input" value="splashing your cash" onchange="updateItem(3,'original',this.value)"></div>
                <div class="input-group"><label>Translation:</label><input class="admin-input" value="Wasting the public's money carelessly" onchange="updateItem(3,'translation',this.value)"></div>
                <div class="input-group"><label>Match Distractors (CSV):</label><input class="admin-input" value="Saving money carefully, Investing wisely, Earning a profit" onchange="updateDistractors(3,'base',this.value)"></div>
                
                <div class="level-block level-1">
                    <span class="level-label">Level 1 (Identify)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="Is the phrase 'splashing your cash' formal or informal?" onchange="updateDeep(3,'level1','tone','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="Informal / Colloquial" onchange="updateDeep(3,'level1','tone','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="Formal, Academic" onchange="updateDistractors(3,'level1',this.value)"></div>
                </div>
                
                <div class="level-block level-2">
                    <span class="level-label">Level 2 (Analyze)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What attitude does 'splashing' convey?" onchange="updateDeep(3,'level2','tone','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="Disapproval of reckless waste" onchange="updateDeep(3,'level2','tone','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="Admiration of generosity, Confusion about banking" onchange="updateDistractors(3,'level2',this.value)"></div>
                </div>
                
                <div class="level-block level-3">
                    <span class="level-label">Level 3 (Evaluate Effect)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="How does 'your cash' provoke a reaction?" onchange="updateDeep(3,'level3','tone','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="It makes the reader feel personally robbed, inciting anger" onchange="updateDeep(3,'level3','tone','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="It makes the reader feel rich, It makes the reader want to donate" onchange="updateDistractors(3,'level3',this.value)"></div>
                </div>
                
                <button class="btn btn-warning" style="margin-top:10px;" onclick="delItem(3)">Delete Item</button>
            </div>
            <div class="item-editor-card">
                <div class="item-header-row">
                    <strong>#5</strong>
                    <select onchange="updateItem(4,'type',this.value)">
                        <option value="tone">Tone</option>
                        <option value="structure">Structure</option>
                        <option value="language" selected="">Language</option>
                    </select>
                    <div>
                        <label title="Include in Worksheet"><input type="checkbox" onchange="updateItemBool(4,'includeInWS',this.checked)"> WS</label>
                    </div>
                </div>
                
                <div class="lens-toggles">
                    <strong>Enable Lenses:</strong>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(4,'enableTone',this.checked)"> Tone</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(4,'enableStructure',this.checked)"> Structure</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(4,'enableLanguage',this.checked)"> Language</label>
                </div>

                <div class="input-group"><label>Quote:</label><input class="admin-input" value="biggest threat local journalism has ever faced" onchange="updateItem(4,'original',this.value)"></div>
                <div class="input-group"><label>Translation:</label><input class="admin-input" value="The most dangerous danger in history for local news" onchange="updateItem(4,'translation',this.value)"></div>
                <div class="input-group"><label>Match Distractors (CSV):</label><input class="admin-input" value="A minor problem for newspapers, A great opportunity for growth, The second biggest threat" onchange="updateDistractors(4,'base',this.value)"></div>
                
                <div class="level-block level-1">
                    <span class="level-label">Level 1 (Identify)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What language feature is 'biggest threat'?" onchange="updateDeep(4,'level1','language','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="Superlative / Hyperbole" onchange="updateDeep(4,'level1','language','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="Understatement, Rhetorical Question" onchange="updateDistractors(4,'level1',this.value)"></div>
                </div>
                
                <div class="level-block level-2">
                    <span class="level-label">Level 2 (Analyze)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="Why does the writer use the word 'ever'?" onchange="updateDeep(4,'level2','language','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="To emphasize the historic magnitude of the danger" onchange="updateDeep(4,'level2','language','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="To suggest the threat is over, To rhyme with never" onchange="updateDistractors(4,'level2',this.value)"></div>
                </div>
                
                <div class="level-block level-3">
                    <span class="level-label">Level 3 (Evaluate Effect)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="Evaluate the use of 'threat' rather than 'competitor'." onchange="updateDeep(4,'level3','language','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="It demonizes the BBC as an enemy rather than a business rival" onchange="updateDeep(4,'level3','language','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="It is a synonym with no difference, It suggests a friendly game" onchange="updateDistractors(4,'level3',this.value)"></div>
                </div>
                
                <button class="btn btn-warning" style="margin-top:10px;" onclick="delItem(4)">Delete Item</button>
            </div>
            <div class="item-editor-card">
                <div class="item-header-row">
                    <strong>#6</strong>
                    <select onchange="updateItem(5,'type',this.value)">
                        <option value="tone">Tone</option>
                        <option value="structure" selected="">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div>
                        <label title="Include in Worksheet"><input type="checkbox" onchange="updateItemBool(5,'includeInWS',this.checked)"> WS</label>
                    </div>
                </div>
                
                <div class="lens-toggles">
                    <strong>Enable Lenses:</strong>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(5,'enableTone',this.checked)"> Tone</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(5,'enableStructure',this.checked)"> Structure</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(5,'enableLanguage',this.checked)"> Language</label>
                </div>

                <div class="input-group"><label>Quote:</label><input class="admin-input" value="So, it is time the BBC showed that it is not the biggest threat" onchange="updateItem(5,'original',this.value)"></div>
                <div class="input-group"><label>Translation:</label><input class="admin-input" value="The BBC needs to prove it isn't dangerous right now" onchange="updateItem(5,'translation',this.value)"></div>
                <div class="input-group"><label>Match Distractors (CSV):</label><input class="admin-input" value="The BBC is definitely the biggest threat, The BBC should close down, It is time to watch TV" onchange="updateDistractors(5,'base',this.value)"></div>
                
                <div class="level-block level-1">
                    <span class="level-label">Level 1 (Identify)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="Where does this sentence appear in the text?" onchange="updateDeep(5,'level1','structure','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="The ending" onchange="updateDeep(5,'level1','structure','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="The beginning, The middle" onchange="updateDistractors(5,'level1',this.value)"></div>
                </div>
                
                <div class="level-block level-2">
                    <span class="level-label">Level 2 (Analyze)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What is the function of the connective 'So'?" onchange="updateDeep(5,'level2','structure','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="To draw a conclusion and issue a call to action" onchange="updateDeep(5,'level2','structure','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="To add more information, To ask a question" onchange="updateDistractors(5,'level2',this.value)"></div>
                </div>
                
                <div class="level-block level-3">
                    <span class="level-label">Level 3 (Evaluate Effect)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="Evaluate the effectiveness of this ending." onchange="updateDeep(5,'level3','structure','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="It empowers the reader/editors by putting the burden of proof on the BBC" onchange="updateDeep(5,'level3','structure','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="It is weak because it doesn't finish the story, It is confusing" onchange="updateDistractors(5,'level3',this.value)"></div>
                </div>
                
                <button class="btn btn-warning" style="margin-top:10px;" onclick="delItem(5)">Delete Item</button>
            </div>
            <div class="item-editor-card">
                <div class="item-header-row">
                    <strong>#7</strong>
                    <select onchange="updateItem(6,'type',this.value)">
                        <option value="tone">Tone</option>
                        <option value="structure">Structure</option>
                        <option value="language" selected="">Language</option>
                    </select>
                    <div>
                        <label title="Include in Worksheet"><input type="checkbox" onchange="updateItemBool(6,'includeInWS',this.checked)"> WS</label>
                    </div>
                </div>
                
                <div class="lens-toggles">
                    <strong>Enable Lenses:</strong>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(6,'enableTone',this.checked)"> Tone</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(6,'enableStructure',this.checked)"> Structure</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(6,'enableLanguage',this.checked)"> Language</label>
                </div>

                <div class="input-group"><label>Quote:</label><input class="admin-input" value="neighbour from hell" onchange="updateItem(6,'original',this.value)"></div>
                <div class="input-group"><label>Translation:</label><input class="admin-input" value="The worst possible person to live next to" onchange="updateItem(6,'translation',this.value)"></div>
                <div class="input-group"><label>Match Distractors (CSV):</label><input class="admin-input" value="A slightly annoying person, A distant relative, A noisy friend" onchange="updateDistractors(6,'base',this.value)"></div>
                
                <div class="level-block level-1">
                    <span class="level-label">Level 1 (Identify)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What technique is used here?" onchange="updateDeep(6,'level1','language','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="Metaphor" onchange="updateDeep(6,'level1','language','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(6,'level1',this.value)"></div>
                </div>
                
                <div class="level-block level-2">
                    <span class="level-label">Level 2 (Analyze)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What does this suggest about the writer's experience?" onchange="updateDeep(6,'level2','language','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="It is a constant nightmare" onchange="updateDeep(6,'level2','language','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(6,'level2',this.value)"></div>
                </div>
                
                <div class="level-block level-3">
                    <span class="level-label">Level 3 (Evaluate Effect)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="How does this establish the writer's stance?" onchange="updateDeep(6,'level3','language','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="It creates immediate hostility via a relatable image of domestic conflict" onchange="updateDeep(6,'level3','language','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(6,'level3',this.value)"></div>
                </div>
                
                <button class="btn btn-warning" style="margin-top:10px;" onclick="delItem(6)">Delete Item</button>
            </div>
            <div class="item-editor-card">
                <div class="item-header-row">
                    <strong>#8</strong>
                    <select onchange="updateItem(7,'type',this.value)">
                        <option value="tone">Tone</option>
                        <option value="structure" selected="">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div>
                        <label title="Include in Worksheet"><input type="checkbox" onchange="updateItemBool(7,'includeInWS',this.checked)"> WS</label>
                    </div>
                </div>
                
                <div class="lens-toggles">
                    <strong>Enable Lenses:</strong>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(7,'enableTone',this.checked)"> Tone</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(7,'enableStructure',this.checked)"> Structure</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(7,'enableLanguage',this.checked)"> Language</label>
                </div>

                <div class="input-group"><label>Quote:</label><input class="admin-input" value="state-funded juggernaut" onchange="updateItem(7,'original',this.value)"></div>
                <div class="input-group"><label>Translation:</label><input class="admin-input" value="A huge, unstoppable force paid for by the government" onchange="updateItem(7,'translation',this.value)"></div>
                <div class="input-group"><label>Match Distractors (CSV):</label><input class="admin-input" value="A large lorry, A government department, A slow moving object" onchange="updateDistractors(7,'base',this.value)"></div>
                
                <div class="level-block level-1">
                    <span class="level-label">Level 1 (Identify)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="Identify the structure used here:" onchange="updateDeep(7,'level1','structure','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="See translation" onchange="updateDeep(7,'level1','structure','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="Option A, Option B" onchange="updateDistractors(7,'level1',this.value)"></div>
                </div>
                
                <div class="level-block level-2">
                    <span class="level-label">Level 2 (Analyze)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What does this structure suggest?" onchange="updateDeep(7,'level2','structure','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="Effect on meaning" onchange="updateDeep(7,'level2','structure','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="Alternative idea, Opposite meaning" onchange="updateDistractors(7,'level2',this.value)"></div>
                </div>
                
                <div class="level-block level-3">
                    <span class="level-label">Level 3 (Evaluate Effect)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="Evaluate the effect of this structure:" onchange="updateDeep(7,'level3','structure','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="Creates strong impact" onchange="updateDeep(7,'level3','structure','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="Weakens the text, Confuses the reader" onchange="updateDistractors(7,'level3',this.value)"></div>
                </div>
                
                <button class="btn btn-warning" style="margin-top:10px;" onclick="delItem(7)">Delete Item</button>
            </div>
            <div class="item-editor-card">
                <div class="item-header-row">
                    <strong>#9</strong>
                    <select onchange="updateItem(8,'type',this.value)">
                        <option value="tone" selected="">Tone</option>
                        <option value="structure">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div>
                        <label title="Include in Worksheet"><input type="checkbox" onchange="updateItemBool(8,'includeInWS',this.checked)"> WS</label>
                    </div>
                </div>
                
                <div class="lens-toggles">
                    <strong>Enable Lenses:</strong>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(8,'enableTone',this.checked)"> Tone</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(8,'enableStructure',this.checked)"> Structure</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(8,'enableLanguage',this.checked)"> Language</label>
                </div>

                <div class="input-group"><label>Quote:</label><input class="admin-input" value="taken an axe to its much-loved local radio" onchange="updateItem(8,'original',this.value)"></div>
                <div class="input-group"><label>Translation:</label><input class="admin-input" value="Violently cut or closed down popular radio stations" onchange="updateItem(8,'translation',this.value)"></div>
                <div class="input-group"><label>Match Distractors (CSV):</label><input class="admin-input" value="Carefully trimmed the budget, Fixed the radio equipment, Built a new studio" onchange="updateDistractors(8,'base',this.value)"></div>
                
                <div class="level-block level-1">
                    <span class="level-label">Level 1 (Identify)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What is the tone of the phrase 'taken an axe'?" onchange="updateDeep(8,'level1','tone','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="Aggressive" onchange="updateDeep(8,'level1','tone','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(8,'level1',this.value)"></div>
                </div>
                
                <div class="level-block level-2">
                    <span class="level-label">Level 2 (Analyze)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="Why does the writer describe the stations as 'much-loved'?" onchange="updateDeep(8,'level2','tone','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="To create a contrast between the public's love and the BBC's cruelty" onchange="updateDeep(8,'level2','tone','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(8,'level2',this.value)"></div>
                </div>
                
                <div class="level-block level-3">
                    <span class="level-label">Level 3 (Evaluate Effect)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What does this imply about the BBC's decision-making?" onchange="updateDeep(8,'level3','tone','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="It is brutal, sudden, and disregards public feeling" onchange="updateDeep(8,'level3','tone','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(8,'level3',this.value)"></div>
                </div>
                
                <button class="btn btn-warning" style="margin-top:10px;" onclick="delItem(8)">Delete Item</button>
            </div>
            <div class="item-editor-card">
                <div class="item-header-row">
                    <strong>#10</strong>
                    <select onchange="updateItem(9,'type',this.value)">
                        <option value="tone">Tone</option>
                        <option value="structure" selected="">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div>
                        <label title="Include in Worksheet"><input type="checkbox" onchange="updateItemBool(9,'includeInWS',this.checked)"> WS</label>
                    </div>
                </div>
                
                <div class="lens-toggles">
                    <strong>Enable Lenses:</strong>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(9,'enableTone',this.checked)"> Tone</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(9,'enableStructure',this.checked)"> Structure</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(9,'enableLanguage',this.checked)"> Language</label>
                </div>

                <div class="input-group"><label>Quote:</label><input class="admin-input" value="Unlike Google, and Meta, the BBC‚Äôs funding is guaranteed" onchange="updateItem(9,'original',this.value)"></div>
                <div class="input-group"><label>Translation:</label><input class="admin-input" value="The BBC has money safe, while others do not" onchange="updateItem(9,'translation',this.value)"></div>
                <div class="input-group"><label>Match Distractors (CSV):</label><input class="admin-input" value="Google and Meta are the same as the BBC, The BBC has no money, Everyone has guaranteed funding" onchange="updateDistractors(9,'base',this.value)"></div>
                
                <div class="level-block level-1">
                    <span class="level-label">Level 1 (Identify)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What does the word 'Unlike' signal at the start of the sentence?" onchange="updateDeep(9,'level1','structure','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="Contrast" onchange="updateDeep(9,'level1','structure','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(9,'level1',this.value)"></div>
                </div>
                
                <div class="level-block level-2">
                    <span class="level-label">Level 2 (Analyze)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What idea is being contrasted here?" onchange="updateDeep(9,'level2','structure','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="The security of the BBC vs the risk faced by others" onchange="updateDeep(9,'level2','structure','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(9,'level2',this.value)"></div>
                </div>
                
                <div class="level-block level-3">
                    <span class="level-label">Level 3 (Evaluate Effect)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="How does this sentence structure build the writer's argument?" onchange="updateDeep(9,'level3','structure','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="It creates a direct comparison to expose the unfair advantage the BBC holds" onchange="updateDeep(9,'level3','structure','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(9,'level3',this.value)"></div>
                </div>
                
                <button class="btn btn-warning" style="margin-top:10px;" onclick="delItem(9)">Delete Item</button>
            </div>
            <div class="item-editor-card">
                <div class="item-header-row">
                    <strong>#11</strong>
                    <select onchange="updateItem(10,'type',this.value)">
                        <option value="tone" selected="">Tone</option>
                        <option value="structure">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div>
                        <label title="Include in Worksheet"><input type="checkbox" onchange="updateItemBool(10,'includeInWS',this.checked)"> WS</label>
                    </div>
                </div>
                
                <div class="lens-toggles">
                    <strong>Enable Lenses:</strong>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(10,'enableTone',this.checked)"> Tone</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(10,'enableStructure',this.checked)"> Structure</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(10,'enableLanguage',this.checked)"> Language</label>
                </div>

                <div class="input-group"><label>Quote:</label><input class="admin-input" value="splashing your cash" onchange="updateItem(10,'original',this.value)"></div>
                <div class="input-group"><label>Translation:</label><input class="admin-input" value="Wasting the public's money carelessly" onchange="updateItem(10,'translation',this.value)"></div>
                <div class="input-group"><label>Match Distractors (CSV):</label><input class="admin-input" value="Saving money carefully, Investing wisely, Earning a profit" onchange="updateDistractors(10,'base',this.value)"></div>
                
                <div class="level-block level-1">
                    <span class="level-label">Level 1 (Identify)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="Is the phrase 'splashing your cash' formal or informal?" onchange="updateDeep(10,'level1','tone','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="Informal" onchange="updateDeep(10,'level1','tone','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(10,'level1',this.value)"></div>
                </div>
                
                <div class="level-block level-2">
                    <span class="level-label">Level 2 (Analyze)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What does the colloquialism 'splashing' imply?" onchange="updateDeep(10,'level2','tone','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="Reckless and childish wastefulness" onchange="updateDeep(10,'level2','tone','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(10,'level2',this.value)"></div>
                </div>
                
                <div class="level-block level-3">
                    <span class="level-label">Level 3 (Evaluate Effect)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What effect does addressing the reader as 'your cash' have?" onchange="updateDeep(10,'level3','tone','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="It provokes personal anger by highlighting the reader's financial loss" onchange="updateDeep(10,'level3','tone','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(10,'level3',this.value)"></div>
                </div>
                
                <button class="btn btn-warning" style="margin-top:10px;" onclick="delItem(10)">Delete Item</button>
            </div>
            <div class="item-editor-card">
                <div class="item-header-row">
                    <strong>#12</strong>
                    <select onchange="updateItem(11,'type',this.value)">
                        <option value="tone">Tone</option>
                        <option value="structure" selected="">Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div>
                        <label title="Include in Worksheet"><input type="checkbox" onchange="updateItemBool(11,'includeInWS',this.checked)"> WS</label>
                    </div>
                </div>
                
                <div class="lens-toggles">
                    <strong>Enable Lenses:</strong>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(11,'enableTone',this.checked)"> Tone</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(11,'enableStructure',this.checked)"> Structure</label>
                    <label><input type="checkbox" checked="" onchange="updateItemBool(11,'enableLanguage',this.checked)"> Language</label>
                </div>

                <div class="input-group"><label>Quote:</label><input class="admin-input" value="So, it is time the BBC showed that it is not the biggest threat" onchange="updateItem(11,'original',this.value)"></div>
                <div class="input-group"><label>Translation:</label><input class="admin-input" value="The BBC needs to prove it isn't dangerous right now" onchange="updateItem(11,'translation',this.value)"></div>
                <div class="input-group"><label>Match Distractors (CSV):</label><input class="admin-input" value="The BBC is definitely the biggest threat, The BBC should close down, It is time to watch TV" onchange="updateDistractors(11,'base',this.value)"></div>
                
                <div class="level-block level-1">
                    <span class="level-label">Level 1 (Identify)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="Where does this sentence appear in the text?" onchange="updateDeep(11,'level1','structure','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="The ending" onchange="updateDeep(11,'level1','structure','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(11,'level1',this.value)"></div>
                </div>
                
                <div class="level-block level-2">
                    <span class="level-label">Level 2 (Analyze)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="What is the function of the connective 'So'?" onchange="updateDeep(11,'level2','structure','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="To draw a final conclusion" onchange="updateDeep(11,'level2','structure','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(11,'level2',this.value)"></div>
                </div>
                
                <div class="level-block level-3">
                    <span class="level-label">Level 3 (Evaluate Effect)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="How does this ending affect the reader?" onchange="updateDeep(11,'level3','structure','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="It leaves them with a challenge or call to action" onchange="updateDeep(11,'level3','structure','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="" onchange="updateDistractors(11,'level3',this.value)"></div>
                </div>
                
                <button class="btn btn-warning" style="margin-top:10px;" onclick="delItem(11)">Delete Item</button>
            </div></div>
                    <button class="btn btn-add" style="background:#2ecc71; margin-top:10px;" onclick="addNewItem()">+ Add New Quote</button>
                    <button class="btn btn-warning" style="width:100%; margin-top:5px;" onclick="resetUsedQuotes()">‚ôªÔ∏è Reset Used Quotes</button>
                </div>

                <button class="btn btn-danger" style="width:100%; margin-top:30px; background:#e74c3c; color:white; padding:15px;" onclick="nuclearReset()">‚ö†Ô∏è Factory Reset</button>
            </div>
        </div>
    </div>

    <div id="feedback-overlay" onclick="this.style.display='none'">
        <div id="feedback-icon"><i class="fas fa-check-circle"></i></div>
        <h2 id="feedback-text">Correct!</h2>
    </div>

    <div id="celebration-modal" class="modal">
        <div class="modal-content" style="max-width:400px; text-align:center; padding:40px;">
            <i class="fas fa-star firework-icon"></i>
            <h2>Level Complete!</h2>
            <div id="progression-btn-container"></div>
            <button class="btn btn-primary" onclick="document.getElementById('celebration-modal').style.display='none'">Close</button>
        </div>
    </div>

    <div id="theme-modal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">Customize Colors <button onclick="document.getElementById('theme-modal').style.display='none'">X</button></div>
            <div class="modal-body" style="padding-bottom:20px;">
                <div class="theme-row">
                    <span>Background Color:</span>
                    <input type="color" class="color-picker" id="bg-picker" onchange="updateThemeColor('--bg', this.value)">
                </div>
                <div class="theme-row">
                    <span>Card/Panel Color:</span>
                    <input type="color" class="color-picker" id="card-picker" onchange="updateThemeColor('--card', this.value)">
                </div>
                <div class="theme-row">
                    <span>Text Color:</span>
                    <input type="color" class="color-picker" id="text-picker" onchange="updateThemeColor('--text', this.value)">
                </div>
                <button class="btn btn-warning" style="width:100%; margin-top:15px;" onclick="resetTheme()">Reset to Default</button>
            </div>
        </div>
    </div>
    
    <div id="phrasing-overlay" class="modal"><div class="modal-content"><div class="modal-header">Select Phrasing</div><div class="modal-body" id="phrase-options"></div></div></div>

<script id="data-script">
    /* DATA_START */ const teacherConfig = {"textTitle":"The BBC: Neighbour from Hell?","question":"To what extent does the writer show frustration and anger at the BBC?","globalStructure":{"enabled":false,"question":"How does the writer structure their argument to escalate from a metaphor of size ('juggernaut') to specific financial accusations, ending with a direct challenge?","correct":"Analysis required.","distractors":["Incorrect interpretation","Irrelevant point"]},"sentenceConfigs":{"1":["starter","quote","link","point","none","none"],"2":["starter","quote","method","analysis","none","none"],"3":["marker","starter","quote","method","point","analysis"]},"worksheetOptions":{"lvl1":true,"lvl2":true,"lvl3":true},"analysisTemplates":{"tone":["creates a {adj} tone","evokes {noun}"],"structure":["highlights {noun}"],"language":["suggests {noun}"]},"markers":["Furthermore,","However,","Consequently,","Significantly,","In addition,","Crucially,"],"starters":["The writer suggests","The author highlights","The writer emphasizes","The author implies","The writer conveys"],"methods":["Metaphor","Hyperbole","Contrast","Colloquialism","Tone","Direct Address"],"points":["a sense of deep unfairness","anger at the destruction of local news","frustration with the BBC's dominance","a feeling of powerlessness","resentment towards the funding model"],"simpleLinks":["This shows","Here we see","This demonstrates","It is clear","This indicates"],"complexLinks":["This reinforces the angry tone (Tone)","This structural shift highlights the contrast (Structure)","This use of language suggests aggression (Lang)","This builds the sense of frustration (Tone)","This links to the previous argument (Structure)"],"items":[{"id":"q1","type":"language","original":"state-funded juggernaut","translation":"A huge, unstoppable force paid for by the government/people","distractors":["A small local business","A slow moving vehicle","A helpful charity"],"level1":{"language":{"prompt":"What technique is used in 'juggernaut'?","correct":"Metaphor","distractors":["Simile","Personification"]},"tone":{"prompt":"What is the tone of 'state-funded' in this context?","correct":"Resentful and critical","distractors":["Grateful and happy","Neutral and factual"]},"structure":{"prompt":"Where does this description appear?","correct":"Near the beginning, to define the enemy","distractors":["At the very end","In the middle of a list"]}},"level2":{"language":{"prompt":"What does the noun 'juggernaut' suggest?","correct":"An overwhelming, destructive force that cannot be stopped","distractors":["A carefully planned operation","A gentle and supportive friend"]},"tone":{"prompt":"Why is the writer angry about the funding?","correct":"It highlights the unfairness of using public money to destroy public choice","distractors":["Because the writer hates taxes","Because the BBC is too poor"]},"structure":{"prompt":"How does this phrase set up the rest of the text?","correct":"It establishes the massive scale of the threat before listing specific actions","distractors":["It concludes the argument immediately","It provides a solution to the problem"]}},"level3":{"language":{"prompt":"Evaluate the effect of combining 'state-funded' with 'juggernaut'.","correct":"It creates a paradox: a public service acting like a destructive monster","distractors":["It makes the BBC sound efficient and modern","It explains how the licence fee works"]},"tone":{"prompt":"How does this influence the reader's attitude?","correct":"It makes them feel small and threatened by a powerful entity","distractors":["It makes them feel safe and protected","It makes them feel indifferent"]},"structure":{"prompt":"How does this contrast with the description of local news?","correct":"It contrasts a massive machine against the 'fragile' independent sector mentioned later","distractors":["It shows both sides are equal","It suggests local news is stronger"]}},"enableTone":true,"enableStructure":true,"enableLanguage":true},{"id":"q2","type":"language","original":"suffocate independent journalism","translation":"To kill off or stop local news from surviving","distractors":["To help journalism breathe","To hide the news","To buy local newspapers"],"level1":{"language":{"prompt":"What type of imagery is 'suffocate'?","correct":"Violent imagery","distractors":["Natural imagery","Peaceful imagery"]},"tone":{"prompt":"What feeling does this verb evoke?","correct":"Panic and hostility","distractors":["Calm and peace","Happiness"]},"structure":{"prompt":"This phrase describes the 'course' of the juggernaut. What is the relationship?","correct":"Cause and Effect","distractors":["Comparison","Question and Answer"]}},"level2":{"language":{"prompt":"What does 'suffocate' imply about the method of destruction?","correct":"It is a slow, painful deprivation of resources (oxygen/money)","distractors":["It is a quick and painless end","It is an accidental occurrence"]},"tone":{"prompt":"How does this heighten the sense of injustice?","correct":"It portrays the BBC as a killer and local news as a victim","distractors":["It portrays the BBC as a fair competitor","It suggests independent journalism is bad"]},"structure":{"prompt":"How does this fit into the sentence flow?","correct":"It is the climax of the opening sentence, emphasising the ultimate consequence","distractors":["It is an introductory clause","It is a minor detail in brackets"]}},"level3":{"language":{"prompt":"Evaluate the impact of personifying journalism here.","correct":"It treats journalism as a living thing being murdered, evoking strong sympathy","distractors":["It makes the text sound more scientific","It suggests journalism is boring"]},"tone":{"prompt":"Does this word choice suggest accidental or deliberate harm?","correct":"Deliberate and cruel harm","distractors":["Accidental bumping","Friendly rivalry"]},"structure":{"prompt":"How does this link to the later mention of 'fragile' sectors?","correct":"It explains *why* the sector is fragile (it is being starved of air/money)","distractors":["It contradicts the later point","It is unrelated"]}},"enableTone":true,"enableStructure":true,"enableLanguage":true},{"id":"q3","type":"tone","original":"taken an axe to its much-loved local radio","translation":"Violently cut or closed down popular stations","distractors":["Carefully reduced spending","Fixed old equipment","Built a new studio"],"level1":{"tone":{"prompt":"What is the tone of 'taken an axe'?","correct":"Aggressive and brutal","distractors":["Calm and clinical","Sad and regretful"]},"language":{"prompt":"What literary device is 'taken an axe'?","correct":"Metaphor / Idiom","distractors":["Simile","Oxymoron"]},"structure":{"prompt":"What does this phrase introduce?","correct":"A specific example of the BBC's actions","distractors":["A conclusion to the argument","A quote from the BBC"]}},"level2":{"tone":{"prompt":"Why describe the radio as 'much-loved'?","correct":"To heighten the outrage by showing the BBC destroying something popular","distractors":["To show that radio is old-fashioned","To complain about music choices"]},"language":{"prompt":"What connotations does 'axe' have here?","correct":"Reckless, violent destruction","distractors":["Precision engineering","Artistic creation"]},"structure":{"prompt":"How does this phrase connect to the 'mission' mentioned earlier?","correct":"It is the evidence that proves the BBC is on a destructive mission","distractors":["It suggests the mission failed","It is unrelated to the mission"]}},"level3":{"tone":{"prompt":"Evaluate the emotional shift in this sentence.","correct":"It moves from suspicion ('seems to be') to confirmed brutality ('taken an axe')","distractors":["It moves from anger to happiness","It stays neutral throughout"]},"language":{"prompt":"How does the writer position the reader against the BBC here?","correct":"By aligning the reader with the 'much-loved' victim against the aggressor","distractors":["By asking the reader to buy an axe","By suggesting the reader stops listening to radio"]},"structure":{"prompt":"Why is this example placed before the discussion of online news?","correct":"To show a pattern of behavior: destroying one format to dominate another","distractors":["Because radio is more important than online","It happened chronologically later"]}},"enableTone":true,"enableStructure":true,"enableLanguage":true},{"id":"q4","type":"tone","original":"splashing your cash","translation":"Wasting the public's money carelessly","distractors":["Saving money carefully","Investing wisely","Earning a profit"],"level1":{"tone":{"prompt":"Is the phrase 'splashing your cash' formal or informal?","correct":"Informal / Colloquial","distractors":["Formal","Academic"]},"language":{"prompt":"What technique is used in 'splashing'?","correct":"Verb choice / Idiom","distractors":["Adjective","Noun"]},"structure":{"prompt":"Who is being addressed by 'your'?","correct":"The reader (Direct Address)","distractors":["The BBC","The government"]}},"level2":{"tone":{"prompt":"What attitude does 'splashing' convey?","correct":"Disapproval of reckless waste","distractors":["Admiration of generosity","Confusion about banking"]},"language":{"prompt":"Why use 'cash' instead of 'funds'?","correct":"It sounds more tangible and personal to the reader","distractors":["It sounds more official","It rhymes with splash"]},"structure":{"prompt":"How does this sentence shift the argument's focus?","correct":"It shifts from the BBC's actions against rivals to its offense against the public","distractors":["It repeats the previous point about radio","It introduces a new topic about water"]}},"level3":{"tone":{"prompt":"How does 'your cash' provoke a reaction?","correct":"It makes the reader feel personally robbed, inciting anger","distractors":["It makes the reader feel rich","It makes the reader want to donate"]},"language":{"prompt":"Evaluate the effect of this colloquialism in a serious article.","correct":"It cuts through bureaucratic language to expose the raw truth of the waste","distractors":["It makes the writer seem uneducated","It makes the text hard to read"]},"structure":{"prompt":"How does this link back to the 'licence fee' mentioned earlier?","correct":"It redefines the 'guaranteed funding' as 'your cash' being wasted","distractors":["It contradicts the licence fee point","It suggests the fee should be higher"]}},"enableTone":true,"enableStructure":true,"enableLanguage":true},{"id":"q5","type":"language","original":"biggest threat local journalism has ever faced","translation":"The most dangerous danger in history for local news","distractors":["A minor problem for newspapers","A great opportunity for growth","The second biggest threat"],"level1":{"language":{"prompt":"What language feature is 'biggest threat'?","correct":"Superlative / Hyperbole","distractors":["Understatement","Rhetorical Question"]},"tone":{"prompt":"What tone does this exaggeration create?","correct":"Alarmist and urgent","distractors":["Calm and relaxed","Happy and excited"]},"structure":{"prompt":"What does this phrase define?","correct":"The scale of the problem","distractors":["The solution to the problem","The history of the BBC"]}},"level2":{"language":{"prompt":"Why does the writer use the word 'ever'?","correct":"To emphasize the historic magnitude of the danger","distractors":["To suggest the threat is over","To rhyme with never"]},"tone":{"prompt":"How does comparing the BBC to Tech Giants affect the tone?","correct":"It paints the BBC as a ruthless monopoly like Google or Meta","distractors":["It makes the BBC look small","It makes the BBC look friendly"]},"structure":{"prompt":"How is this sentence constructed for impact?","correct":"It contrasts the 'guaranteed' funding with the 'threat' it causes","distractors":["It is a simple short sentence","It uses a list of three"]}},"level3":{"language":{"prompt":"Evaluate the use of 'threat' rather than 'competitor'.","correct":"It demonizes the BBC as an enemy rather than a business rival","distractors":["It is a synonym with no difference","It suggests a friendly game"]},"tone":{"prompt":"Does this statement sound objective or subjective?","correct":"Highly subjective and emotive","distractors":["Completely factual and neutral","Scientific and proven"]},"structure":{"prompt":"How does this central claim support the 'juggernaut' metaphor?","correct":"It confirms that the 'juggernaut' is not just big, but actively dangerous","distractors":["It contradicts the juggernaut idea","It suggests the juggernaut is safe"]}},"enableTone":true,"enableStructure":true,"enableLanguage":true},{"id":"q6","type":"structure","original":"So, it is time the BBC showed that it is not the biggest threat","translation":"The BBC needs to prove it isn't dangerous right now","distractors":["The BBC is definitely the biggest threat","The BBC should close down","It is time to watch TV"],"level1":{"structure":{"prompt":"Where does this sentence appear in the text?","correct":"The ending","distractors":["The beginning","The middle"]},"tone":{"prompt":"What is the tone of this final statement?","correct":"Challenging and demanding","distractors":["Soft and pleading","Confused"]},"language":{"prompt":"What connective word starts this sentence?","correct":"So","distractors":["Because","However"]}},"level2":{"structure":{"prompt":"What is the function of the connective 'So'?","correct":"To draw a conclusion and issue a call to action","distractors":["To add more information","To ask a question"]},"tone":{"prompt":"How does the tone shift at the end?","correct":"From angry description to a direct ultimatum","distractors":["It becomes very happy","It becomes apologetic"]},"language":{"prompt":"Why repeat 'biggest threat' at the end?","correct":"To remind the reader of the central accusation one last time","distractors":["Because the writer forgot other words","To make it rhyme"]}},"level3":{"structure":{"prompt":"Evaluate the effectiveness of this ending.","correct":"It empowers the reader/editors by putting the burden of proof on the BBC","distractors":["It is weak because it doesn't finish the story","It is confusing"]},"tone":{"prompt":"What does the phrase 'it is time' imply?","correct":"Impatience; the writer has waited long enough","distractors":["It is 5 o'clock","The writer is patient"]},"language":{"prompt":"How does the final focus on 'community independent journalism' affect the reader?","correct":"It reminds us of the vulnerable victim that needs protecting","distractors":["It sounds very corporate","It suggests journalism is strong"]}},"enableTone":true,"enableStructure":true,"enableLanguage":true},{"id":"q1","type":"language","original":"neighbour from hell","translation":"The worst possible person to live next to","distractors":["A slightly annoying person","A distant relative","A noisy friend"],"level1":{"language":{"prompt":"What technique is used here?","correct":"Metaphor","options":["Metaphor","Simile"]},"tone":{"prompt":"Identify the tone used here:","correct":"See translation","distractors":["Option A","Option B"]},"structure":{"prompt":"Identify the structure used here:","correct":"See translation","distractors":["Option A","Option B"]}},"level2":{"language":{"prompt":"What does this suggest about the writer's experience?","correct":"It is a constant nightmare","options":["It is a constant nightmare","It is sometimes difficult"]},"tone":{"prompt":"What does this tone suggest?","correct":"Effect on meaning","distractors":["Alternative idea","Opposite meaning"]},"structure":{"prompt":"What does this structure suggest?","correct":"Effect on meaning","distractors":["Alternative idea","Opposite meaning"]}},"level3":{"language":{"prompt":"How does this establish the writer's stance?","correct":"It creates immediate hostility via a relatable image of domestic conflict","options":["It creates immediate hostility via a relatable image of domestic conflict","It suggests the writer wants to move house"]},"tone":{"prompt":"Evaluate the effect of this tone:","correct":"Creates strong impact","distractors":["Weakens the text","Confuses the reader"]},"structure":{"prompt":"Evaluate the effect of this structure:","correct":"Creates strong impact","distractors":["Weakens the text","Confuses the reader"]}},"enableTone":true,"enableStructure":true,"enableLanguage":true},{"id":"q2","type":"structure","original":"state-funded juggernaut","translation":"A huge, unstoppable force paid for by the government","distractors":["A large lorry","A government department","A slow moving object"],"level1":{"language":{"prompt":"What does the word 'juggernaut' suggest?","correct":"Power","options":["Power","Weakness"]},"tone":{"prompt":"Identify the tone used here:","correct":"See translation","distractors":["Option A","Option B"]},"structure":{"prompt":"Identify the structure used here:","correct":"See translation","distractors":["Option A","Option B"]}},"level2":{"language":{"prompt":"What connotations does 'juggernaut' have?","correct":"A destructive, crushing force that cannot be stopped","options":["A destructive, crushing force that cannot be stopped","A helpful, supporting organization"]},"tone":{"prompt":"What does this tone suggest?","correct":"Effect on meaning","distractors":["Alternative idea","Opposite meaning"]},"structure":{"prompt":"What does this structure suggest?","correct":"Effect on meaning","distractors":["Alternative idea","Opposite meaning"]}},"level3":{"language":{"prompt":"Why does the writer pair this with 'state-funded'?","correct":"To highlight the injustice that the public is paying for this destruction","options":["To highlight the injustice that the public is paying for this destruction","To show that the BBC has a lot of money"]},"tone":{"prompt":"Evaluate the effect of this tone:","correct":"Creates strong impact","distractors":["Weakens the text","Confuses the reader"]},"structure":{"prompt":"Evaluate the effect of this structure:","correct":"Creates strong impact","distractors":["Weakens the text","Confuses the reader"]}},"enableTone":true,"enableStructure":true,"enableLanguage":true},{"id":"q3","type":"tone","original":"taken an axe to its much-loved local radio","translation":"Violently cut or closed down popular radio stations","distractors":["Carefully trimmed the budget","Fixed the radio equipment","Built a new studio"],"level1":{"tone":{"prompt":"What is the tone of the phrase 'taken an axe'?","correct":"Aggressive","options":["Aggressive","Calm"]},"structure":{"prompt":"Identify the structure used here:","correct":"See translation","distractors":["Option A","Option B"]},"language":{"prompt":"Identify the language used here:","correct":"See translation","distractors":["Option A","Option B"]}},"level2":{"tone":{"prompt":"Why does the writer describe the stations as 'much-loved'?","correct":"To create a contrast between the public's love and the BBC's cruelty","options":["To create a contrast between the public's love and the BBC's cruelty","To show that radio is popular"]},"structure":{"prompt":"What does this structure suggest?","correct":"Effect on meaning","distractors":["Alternative idea","Opposite meaning"]},"language":{"prompt":"What does this language suggest?","correct":"Effect on meaning","distractors":["Alternative idea","Opposite meaning"]}},"level3":{"tone":{"prompt":"What does this imply about the BBC's decision-making?","correct":"It is brutal, sudden, and disregards public feeling","options":["It is brutal, sudden, and disregards public feeling","It is careful and financial"]},"structure":{"prompt":"Evaluate the effect of this structure:","correct":"Creates strong impact","distractors":["Weakens the text","Confuses the reader"]},"language":{"prompt":"Evaluate the effect of this language:","correct":"Creates strong impact","distractors":["Weakens the text","Confuses the reader"]}},"enableTone":true,"enableStructure":true,"enableLanguage":true},{"id":"q4","type":"structure","original":"Unlike Google, and Meta, the BBC‚Äôs funding is guaranteed","translation":"The BBC has money safe, while others do not","distractors":["Google and Meta are the same as the BBC","The BBC has no money","Everyone has guaranteed funding"],"level1":{"structure":{"prompt":"What does the word 'Unlike' signal at the start of the sentence?","correct":"Contrast","options":["Contrast","Agreement"]},"tone":{"prompt":"Identify the tone used here:","correct":"See translation","distractors":["Option A","Option B"]},"language":{"prompt":"Identify the language used here:","correct":"See translation","distractors":["Option A","Option B"]}},"level2":{"structure":{"prompt":"What idea is being contrasted here?","correct":"The security of the BBC vs the risk faced by others","options":["The security of the BBC vs the risk faced by others","The size of the companies"]},"tone":{"prompt":"What does this tone suggest?","correct":"Effect on meaning","distractors":["Alternative idea","Opposite meaning"]},"language":{"prompt":"What does this language suggest?","correct":"Effect on meaning","distractors":["Alternative idea","Opposite meaning"]}},"level3":{"structure":{"prompt":"How does this sentence structure build the writer's argument?","correct":"It creates a direct comparison to expose the unfair advantage the BBC holds","options":["It creates a direct comparison to expose the unfair advantage the BBC holds","It lists similar companies to show the market size"]},"tone":{"prompt":"Evaluate the effect of this tone:","correct":"Creates strong impact","distractors":["Weakens the text","Confuses the reader"]},"language":{"prompt":"Evaluate the effect of this language:","correct":"Creates strong impact","distractors":["Weakens the text","Confuses the reader"]}},"enableTone":true,"enableStructure":true,"enableLanguage":true},{"id":"q5","type":"tone","original":"splashing your cash","translation":"Wasting the public's money carelessly","distractors":["Saving money carefully","Investing wisely","Earning a profit"],"level1":{"tone":{"prompt":"Is the phrase 'splashing your cash' formal or informal?","correct":"Informal","options":["Informal","Formal"]},"structure":{"prompt":"Identify the structure used here:","correct":"See translation","distractors":["Option A","Option B"]},"language":{"prompt":"Identify the language used here:","correct":"See translation","distractors":["Option A","Option B"]}},"level2":{"tone":{"prompt":"What does the colloquialism 'splashing' imply?","correct":"Reckless and childish wastefulness","options":["Reckless and childish wastefulness","Generous giving"]},"structure":{"prompt":"What does this structure suggest?","correct":"Effect on meaning","distractors":["Alternative idea","Opposite meaning"]},"language":{"prompt":"What does this language suggest?","correct":"Effect on meaning","distractors":["Alternative idea","Opposite meaning"]}},"level3":{"tone":{"prompt":"What effect does addressing the reader as 'your cash' have?","correct":"It provokes personal anger by highlighting the reader's financial loss","options":["It provokes personal anger by highlighting the reader's financial loss","It makes the reader feel rich"]},"structure":{"prompt":"Evaluate the effect of this structure:","correct":"Creates strong impact","distractors":["Weakens the text","Confuses the reader"]},"language":{"prompt":"Evaluate the effect of this language:","correct":"Creates strong impact","distractors":["Weakens the text","Confuses the reader"]}},"enableTone":true,"enableStructure":true,"enableLanguage":true},{"id":"q6","type":"structure","original":"So, it is time the BBC showed that it is not the biggest threat","translation":"The BBC needs to prove it isn't dangerous right now","distractors":["The BBC is definitely the biggest threat","The BBC should close down","It is time to watch TV"],"level1":{"structure":{"prompt":"Where does this sentence appear in the text?","correct":"The ending","options":["The ending","The beginning"]},"tone":{"prompt":"Identify the tone used here:","correct":"See translation","distractors":["Option A","Option B"]},"language":{"prompt":"Identify the language used here:","correct":"See translation","distractors":["Option A","Option B"]}},"level2":{"structure":{"prompt":"What is the function of the connective 'So'?","correct":"To draw a final conclusion","options":["To draw a final conclusion","To add a new point"]},"tone":{"prompt":"What does this tone suggest?","correct":"Effect on meaning","distractors":["Alternative idea","Opposite meaning"]},"language":{"prompt":"What does this language suggest?","correct":"Effect on meaning","distractors":["Alternative idea","Opposite meaning"]}},"level3":{"structure":{"prompt":"How does this ending affect the reader?","correct":"It leaves them with a challenge or call to action","options":["It leaves them with a challenge or call to action","It makes them feel the issue is resolved"]},"tone":{"prompt":"Evaluate the effect of this tone:","correct":"Creates strong impact","distractors":["Weakens the text","Confuses the reader"]},"language":{"prompt":"Evaluate the effect of this language:","correct":"Creates strong impact","distractors":["Weakens the text","Confuses the reader"]}},"enableTone":true,"enableStructure":true,"enableLanguage":true}]}; /* DATA_END */

    const defaultData = {
        textTitle: "New Lesson", question: "Enter Question", adminPassword: "1234", 
        globalStructure: { enabled: true, question: "How does the text flow?", correct: "Beginning to End", distractors: ["It repeats", "It is circular"] },
        sentenceConfigs: { 1: ['starter', 'quote', 'link', 'point', 'none', 'none'], 2: ['starter', 'quote', 'method', 'analysis', 'none', 'none'], 3: ['marker', 'starter', 'quote', 'method', 'point', 'analysis'] },
        worksheetOptions: { lvl1: true, lvl2: true, lvl3: true },
        analysisTemplates: { tone: ["creates a {adj} tone", "evokes {noun}"], structure: ["highlights {noun}"], language: ["suggests {noun}"] },
        markers: ["Furthermore,", "However,"], starters: ["The writer implies", "The author suggests"], methods: ["Metaphor", "Simile"], points: ["a sense of tension"], simpleLinks: ["This shows", "This suggests", "It is clear"], complexLinks: ["This reinforces the tone (Tone)", "This structural shift implies (Structure)"],
        items: []
    };

    let appData = JSON.parse(JSON.stringify(defaultData));
    let state = { level: 1, currentIdx: -1, filter: 'all', completed: [], currentLens: '', score: 0 };
    let sentenceSlots = { marker:"", starter:"", point:"", method:"", quote:"", link:"", analysis:"" };
    let currentEditingBank = '';
    let adminConfigLevel = 1;
    const wordMorphology = { "admiring":{adj:"admiring",noun:"admiration"}, "angry":{adj:"angry",noun:"anger"}, "chaotic":{adj:"chaotic",noun:"chaos"} };

    // EMERGENCY ERROR HANDLER
    window.onerror = function() {
        // Silent Fail
    };

    function init() {
        try {
            bindEvents();
            initTheme(); 

            if (teacherConfig && typeof teacherConfig === 'object') {
                appData = validateAndRepair(teacherConfig);
                document.getElementById('student-banner').style.display='block';
                document.getElementById('student-title').innerText = appData.textTitle;
                loadState();
                return;
            }
            
            // CLEAN SLATE KEY
            let local = localStorage.getItem('tsa_v182_structure');
            if(!local) local = localStorage.getItem('tsa_v180_labels'); 
            
            if(local) { 
                try { 
                    const parsed = JSON.parse(local);
                    appData = validateAndRepair(parsed);
                } catch(e) { 
                    appData = defaultData; 
                } 
            }
            
            sanitizeLinks();
            loadState();
            
            const autoLogin = document.getElementById('auto-login-check');
            if(autoLogin && localStorage.getItem('tsa_auto_login') === 'true') autoLogin.checked = true;
            
            const autoProg = document.getElementById('auto-progress-check');
            if(autoProg && localStorage.getItem('tsa_auto_progress') === 'true') autoProg.checked = true;

        } catch (fatal) {
            console.error("Fatal Init Error", fatal);
        }
    }

    function safeBind(id, event, func) {
        const el = document.getElementById(id);
        if(el) {
            el.addEventListener(event, func);
        }
    }

    function bindEvents() {
        safeBind('main-settings-btn', 'click', openAdmin);
        safeBind('level-select', 'change', changeLevel);
        safeBind('close-admin-btn', 'click', closeAdmin);
    }

    window.openHelp = function() {
        document.getElementById('help-modal').style.display = 'flex';
    }

    // THEME LOGIC
    function initTheme() {
        ['--bg', '--card', '--text'].forEach(v => {
            const saved = localStorage.getItem('tsa_theme_' + v);
            if(saved) document.documentElement.style.setProperty(v, saved);
        });
    }

    window.updateThemeColor = function(v, val) {
        document.documentElement.style.setProperty(v, val);
        localStorage.setItem('tsa_theme_' + v, val);
    }

    window.openThemeModal = function() {
        document.getElementById('theme-modal').style.display = 'flex';
        const styles = getComputedStyle(document.documentElement);
        document.getElementById('bg-picker').value = styles.getPropertyValue('--bg').trim();
        document.getElementById('card-picker').value = styles.getPropertyValue('--card').trim();
        document.getElementById('text-picker').value = styles.getPropertyValue('--text').trim();
    }

    window.resetTheme = function() {
        ['--bg', '--card', '--text'].forEach(v => localStorage.removeItem('tsa_theme_' + v));
        location.reload();
    }

    function validateAndRepair(data) {
        if (!data) return JSON.parse(JSON.stringify(defaultData));
        
        // Structure Object Migration
        if (typeof data.globalStructure === 'string') {
            data.globalStructure = {
                enabled: true,
                question: data.globalStructure,
                correct: "Analysis required.",
                distractors: ["Incorrect interpretation", "Irrelevant point"]
            };
        }
        if (!data.globalStructure) data.globalStructure = defaultData.globalStructure;

        ['markers','starters','methods','points','simpleLinks','complexLinks','items'].forEach(key => {
            if (!Array.isArray(data[key])) data[key] = defaultData[key] || [];
            if (data[key].length === 0) data[key] = ["(No items available)"]; 
        });
        if (!data.sentenceConfigs || !data.sentenceConfigs[1]) data.sentenceConfigs = defaultData.sentenceConfigs;
        if(data.items) {
            data.items.forEach(item => {
                if(item.enableTone === undefined) item.enableTone = true;
                if(item.enableStructure === undefined) item.enableStructure = true;
                if(item.enableLanguage === undefined) item.enableLanguage = true;

                ['tone', 'structure', 'language'].forEach(lens => {
                    if(!item.level1) item.level1 = {};
                    if(!item.level1[lens]) item.level1[lens] = { prompt: `Identify ${lens}:`, correct: "See translation", distractors: ["Option A", "Option B"] };
                    if(!item.level2) item.level2 = {};
                    if(!item.level2[lens]) item.level2[lens] = { prompt: `Analyze ${lens}:`, correct: "Effect", distractors: ["Option A", "Option B"] };
                    if(!item.level3) item.level3 = {};
                    if(!item.level3[lens]) item.level3[lens] = { prompt: `Evaluate ${lens}:`, correct: "Impact", distractors: ["Option A", "Option B"] };
                });
                
                if (!item.distractors || !Array.isArray(item.distractors)) item.distractors = ["Wrong 1", "Wrong 2"];
            });
        }
        return data;
    }
    
    function loadState() {
        const savedEssay = localStorage.getItem('tsa_student_essay');
        if(savedEssay) document.getElementById('answer-area').value = savedEssay;
        const savedCompleted = localStorage.getItem('tsa_student_completed');
        if(savedCompleted) state.completed = JSON.parse(savedCompleted);
        const savedScore = localStorage.getItem('tsa_student_score');
        if(savedScore) state.score = parseInt(savedScore);
        
        // Load Global Structure Editor
        if(appData.globalStructure) {
            document.getElementById('global-q-input').value = appData.globalStructure.question || "";
            document.getElementById('global-correct-input').value = appData.globalStructure.correct || "";
            document.getElementById('global-dist-input').value = (appData.globalStructure.distractors || []).join(", ");
            document.getElementById('global-enabled-check').checked = appData.globalStructure.enabled !== false;
        }
        
        document.getElementById('level-select').value = "1";
        state.level = 1;
        updateUI(); 
        changeLevel();
    }
    
    function sanitizeLinks() {
        if(appData.simpleLinks) appData.simpleLinks = appData.simpleLinks.map(s => s.replace(/\s+that\s*$/i, "").trim());
    }
    
    function autoSaveProgress() {
        localStorage.setItem('tsa_student_essay', document.getElementById('answer-area').value);
        localStorage.setItem('tsa_student_score', state.score);
        const ind = document.getElementById('save-status'); ind.style.opacity = 1; setTimeout(() => ind.style.opacity = 0, 1500);
    }
    
    window.emergencyReset = function() {
        if(confirm("Emergency Reset: This will wipe all data to fix the crash. Continue?")) {
            nuclearReset();
        }
    }

    window.nuclearReset = function() {
        if(confirm("Confirm Factory Reset?")) {
            localStorage.removeItem('tsa_v182_structure');
            localStorage.removeItem('tsa_v180_labels');
            localStorage.removeItem('tsa_student_essay');
            localStorage.removeItem('tsa_student_completed');
            localStorage.removeItem('tsa_student_score');
            ['--bg', '--card', '--text'].forEach(v => localStorage.removeItem('tsa_theme_' + v));
            location.reload();
        }
    };
    
    function resetUsedQuotes() {
        if(confirm("Restore all completed quotes?")) {
            state.completed = [];
            localStorage.removeItem('tsa_student_completed');
            resetToGrid();
            alert("Restored!");
        }
    }

    function switchHub(hubId) {
        document.querySelectorAll('.hub').forEach(h => h.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('hub-' + hubId).classList.add('active');
        document.getElementById('nav-' + hubId).classList.add('active');
        if(hubId === 'lab') resetToGrid();
    }

    function resetToGrid() {
        state.currentIdx = -1;
        document.getElementById('header-label').innerText = "Topic";
        document.getElementById('text-display').innerText = appData.textTitle;
        const lab = document.getElementById('lab-content');
        
        // Ensure Grid Exists
        if(!document.getElementById('grid-main')) {
             lab.innerHTML = `<div class="instruction">Step 1: Choose Evidence</div><div class="filter-bar" id="main-filter-bar" style="display:flex; gap:5px; justify-content:center; margin-bottom:10px;"><button class="btn" onclick="filterGrid('all')">All</button><button class="btn" onclick="filterGrid('language')">Lang</button><button class="btn" onclick="filterGrid('structure')">Struct</button></div><div id="dynamic-question-display" class="dynamic-question">Select Evidence</div>
             <div class="section-header">Evidence (Quotes)</div><div class="grid" id="grid-main"></div>
             <div class="section-header">Global Analysis</div><div id="structure-container"></div>`;
        }
        
        if(state.level === 1) { 
            const fb = document.getElementById('main-filter-bar');
            if(fb) fb.style.display = 'none'; 
            state.filter = 'all'; 
        }
        loadStageSelect();
    }

    function loadStageSelect() {
        const grid = document.getElementById('grid-main');
        const structContainer = document.getElementById('structure-container');
        if(!grid || !structContainer) return; 
        
        grid.innerHTML = '';
        structContainer.innerHTML = '';
        
        let count = 0;
        appData.items.forEach((item, i) => {
            if(state.completed.includes(i)) return; 
            if(state.level !== 1 && state.filter !== 'all' && item.type !== state.filter) return;
            count++;
            const div = document.createElement('div');
            div.className = `card card-${item.type || 'tone'}`;
            div.innerHTML = `<strong>"${item.original}"</strong><br><small>${item.type}</small>`;
            div.onclick = () => startAnalysis(i);
            grid.appendChild(div);
        });

        // Structure Card at BOTTOM (Separate Container)
        if(appData.globalStructure && appData.globalStructure.enabled !== false) {
            const stCard = document.createElement('div');
            stCard.className = 'card card-global';
            stCard.innerHTML = `<div><strong>üèóÔ∏è Whole Text Structure</strong><br><small>Global Analysis</small></div><i class="fas fa-chevron-right"></i>`;
            stCard.onclick = () => startGlobalStructure();
            structContainer.appendChild(stCard);
        }
    }
    
    function filterGrid(type) { state.filter = type; resetToGrid(); }
    
    function changeLevel() { 
        state.level = parseInt(document.getElementById('level-select').value); 
        resetToGrid(); 
        renderBuilderDropdowns(); 
    }

    function startGlobalStructure() {
        const lab = document.getElementById('lab-content');
        const q = appData.globalStructure.question || "No question set.";
        const correct = appData.globalStructure.correct || "Correct Answer";
        let distractors = appData.globalStructure.distractors || ["Distractor 1", "Distractor 2"];
        
        // Shuffle Options
        let opts = [{txt: correct, correct: true}, ...distractors.map(d => ({txt:d, correct:false}))];
        shuffleArray(opts);

        let optionsHtml = '';
        opts.forEach(o => {
            optionsHtml += `<div class="card" onclick="checkGlobalMatch(event, ${o.correct}, '${o.txt.replace(/'/g, "\\'")}')">${o.txt}</div>`;
        });

        lab.innerHTML = `<div class="instruction">Whole Text Structure</div>
        <div style="padding:10px; font-weight:bold; margin-bottom:10px;">${q}</div>
        <div class="grid">${optionsHtml}</div>
        <button class="btn btn-warning" onclick="resetToGrid()" style="margin-top:10px;">‚¨Ö Back</button>`;
    }

    window.checkGlobalMatch = function(e, isCorrect, text) {
        if(isCorrect) {
            showFeedback(true);
            state.score += 20;
            // Add to essay
            sentenceSlots.analysis = text;
            rebuildSentence(); 
            switchHub('writing'); 
            renderBuilderDropdowns(); 
            resetToGrid();
        } else {
            showFeedback(false);
            e.target.classList.add('shake');
            setTimeout(()=>e.target.classList.remove('shake'), 500);
        }
    };

    function startAnalysis(idx) {
        state.currentIdx = idx;
        const item = appData.items[idx];
        document.getElementById('header-label').innerText = "Quote";
        document.getElementById('text-display').innerText = item.original.length > 50 ? item.original.substring(0,50)+"..." : item.original;

        const lab = document.getElementById('lab-content');
        lab.innerHTML = `<div class="instruction">Step 2: Match Meaning</div><div class="grid" id="grid-decoder"></div><button class="btn btn-warning" onclick="resetToGrid()" style="margin-top:10px;">‚¨Ö Back</button>`;
        
        let dists = (Array.isArray(item.distractors) && item.distractors.length > 0) ? item.distractors : ["Wrong Answer 1", "Wrong Answer 2"];
        let opts = [{txt: item.translation, correct: true}, ...dists.map(d => ({txt:d, correct:false}))];
        shuffleArray(opts);
        
        opts.forEach(o => {
            const btn = document.createElement('div');
            btn.className = 'card'; btn.innerText = o.txt;
            btn.onclick = (e) => checkMatch(e, o.correct, item.original, item.type);
            document.getElementById('grid-decoder').appendChild(btn);
        });
    }

    function checkMatch(e, isCorrect, original, type) {
        if(isCorrect) {
            showFeedback(true);
            state.score += 10;
            updateUI();
            sentenceSlots.quote=`"${original}"`; 
            document.getElementById('quote-reference').innerHTML = `<strong>Current Quote:</strong> "${original}"`;
            document.getElementById('quote-reference').style.display = 'block';
            if (state.level === 1) {
                state.currentLens = type || 'tone';
                switchHub('writing'); rebuildSentence(); renderBuilderDropdowns(); return; 
            }
            loadLensChoice(); 
        } else {
            showFeedback(false);
            e.target.classList.add('shake');
            setTimeout(() => e.target.classList.remove('shake'), 500);
        }
    }

    function showFeedback(correct) {
        const overlay = document.getElementById('feedback-overlay');
        const icon = document.getElementById('feedback-icon');
        const text = document.getElementById('feedback-text');
        overlay.style.display = 'flex';
        if(correct) {
            icon.innerHTML = '<i class="fas fa-check-circle" style="color:#4caf50;"></i>';
            text.innerText = "Correct! (+10 XP)";
            setTimeout(() => overlay.style.display = 'none', 1000);
        } else {
            icon.innerHTML = '<i class="fas fa-times-circle" style="color:#f44336;"></i>';
            text.innerText = "Try Again";
            setTimeout(() => overlay.style.display = 'none', 1000);
        }
    }

    function loadLensChoice() {
        const lab = document.getElementById('lab-content');
        const item = appData.items[state.currentIdx];
        let buttons = '';
        if(item.enableTone !== false) buttons += `<div class="card card-tone" onclick="loadFinalAnalysis('tone')">üé≠ Tone</div>`;
        if(item.enableStructure !== false) buttons += `<div class="card card-struct" onclick="loadFinalAnalysis('structure')">üèóÔ∏è Structure</div>`;
        if(item.enableLanguage !== false) buttons += `<div class="card card-lang" onclick="loadFinalAnalysis('language')">üìñ Language</div>`;

        lab.innerHTML = `<div class="instruction">Step 3: Choose Lens</div><div class="grid">${buttons}</div><button class="btn btn-warning" onclick="resetToGrid()" style="margin-top:10px;">‚¨Ö Back</button>`;
    }

    function loadFinalAnalysis(lens) {
        state.currentLens = lens; 
        const item = appData.items[state.currentIdx];
        
        const lvlKey = `level${state.level}`;
        const lvlData = item[lvlKey] && item[lvlKey][lens] ? item[lvlKey][lens] : null;
        
        const prompt = lvlData ? lvlData.prompt : "Analyze this technique:";
        const correct = lvlData ? lvlData.correct : "Effect created.";
        
        let distractors = [];
        if (lvlData && Array.isArray(lvlData.distractors) && lvlData.distractors.length > 0) {
            distractors = lvlData.distractors;
        } else {
            distractors = ["Alternative interpretation", "Unrelated effect"];
        }

        const lab = document.getElementById('lab-content');
        lab.innerHTML = `<div class="instruction">${prompt}</div><div class="grid" id="grid-analysis"></div><button class="btn btn-warning" onclick="loadLensChoice()" style="margin-top:10px;">‚¨Ö Back</button>`;
        
        let allOpts = [{txt: correct, correct: true}, ...distractors.map(d => ({txt:d, correct:false}))];
        shuffleArray(allOpts);

        allOpts.forEach(o => {
            const btn = document.createElement('div');
            btn.className = `card card-${lens}`; btn.innerText = o.txt;
            btn.onclick = (e) => { 
                if(o.correct) {
                    showFeedback(true);
                    state.score += 20;
                    showPhrasingChoices(lens, o.txt); 
                } else {
                    showFeedback(false);
                    e.target.classList.add('shake');
                    setTimeout(()=>e.target.classList.remove('shake'), 500);
                }
            };
            document.getElementById('grid-analysis').appendChild(btn);
        });
    }

    function shuffleArray(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
    }

    function showPhrasingChoices(lens, word) {
        const modal = document.getElementById('phrasing-overlay');
        const container = document.getElementById('phrase-options');
        modal.style.display = 'flex'; container.innerHTML = '';
        let templates = appData.analysisTemplates[lens] || ["creates a {adj} tone"];
        templates.forEach(tmpl => {
            let adj = wordMorphology[word.toLowerCase()]?.adj || word;
            let noun = wordMorphology[word.toLowerCase()]?.noun || word;
            let text = tmpl.replace("{adj}", adj).replace("{noun}", noun).replace("{word}", word);
            const div = document.createElement('div');
            div.className = 'phrase-option'; div.innerText = text;
            div.onclick = () => {
                sentenceSlots.analysis = text; modal.style.display = 'none';
                rebuildSentence(); switchHub('writing'); renderBuilderDropdowns(); resetToGrid(); 
            };
            container.appendChild(div);
        });
    }

    function renderBuilderDropdowns() {
        const container = document.getElementById('dynamic-builder-controls');
        container.innerHTML = '';
        
        const currentConfig = appData.sentenceConfigs[state.level] || defaultData.sentenceConfigs[1];
        const dataMap = { 'marker': 'markers', 'starter': 'starters', 'method': 'methods', 'point': 'points' };

        currentConfig.forEach(type => {
            if (['quote', 'analysis', 'none'].includes(type)) return;
            
            let options = [];
            
            if(type === 'link') {
                if(state.level === 1) {
                    options = appData['simpleLinks']; 
                } else {
                    options = appData['complexLinks']; 
                    if (state.currentLens) {
                        options = options.filter(opt => {
                            const lower = opt.toLowerCase();
                            return lower.includes(`(${state.currentLens})`) || (!lower.includes('(tone)') && !lower.includes('(structure)') && !lower.includes('(lang)') && !lower.includes('(language)'));
                        });
                    }
                }
            } else {
                const key = dataMap[type] || type + 's';
                options = appData[key];
            }

            if (!options || options.length === 0) {
                options = ["(No items available)"];
            }

            const div = document.createElement('div');
            div.className = 'bank-row';
            
            let optionsHtml = `<option value="">Choose ${type}...</option>`;
            options.forEach(opt => {
                let display = opt;
                if(type === 'link') display = display.replace(/\s+that\s*$/i, ""); 
                optionsHtml += `<option value="${display}">${display}</option>`;
            });

            div.innerHTML = `
                <span class="bank-label">${type.toUpperCase()}</span>
                <select class="bank-select" onchange="updateSlot('${type}', this.value)">
                    ${optionsHtml}
                </select>
            `;
            container.appendChild(div);
        });
    }

    window.updateSlot = function(type, value) {
        sentenceSlots[type] = value;
        rebuildSentence();
    };

    window.manualEdit = function() {
        // Allows manual typing in stage, does not update slots but updates displayed text
    }

    function rebuildSentence() {
        const currentConfig = appData.sentenceConfigs[state.level] || defaultData.sentenceConfigs[1];
        let parts = [];
        currentConfig.forEach(type => { 
            let val = sentenceSlots[type];
            if(val) {
                if(type === 'link') val = val.replace(/\s+that\s*$/i, "");
                val = val.replace(/\s*\((Tone|Structure|Lang|Language)\)/gi, '').trim();
                parts.push(val);
            }
        });
        let str = parts.join(" ");
        if(str) { str = str.charAt(0).toUpperCase() + str.slice(1); if(!str.endsWith('.')) str += "."; }
        
        document.getElementById('sentence-stage').innerText = str || "Start picking words in the Lab...";
    }

    function commitSentence() {
        const stage = document.getElementById('sentence-stage');
        const text = stage.innerText.trim();
        
        if (!text || text === "Start picking words in the Lab...") {
            alert("Please construct a sentence first.");
            return;
        }
        
        const area = document.getElementById('answer-area');
        area.value += (area.value ? "\n\n" : "") + text;
        
        if(state.currentIdx !== -1 && !state.completed.includes(state.currentIdx)) {
            state.completed.push(state.currentIdx);
        }
        localStorage.setItem('tsa_student_completed', JSON.stringify(state.completed)); 
        autoSaveProgress();
        
        sentenceSlots = { starter:"", point:"", method:"", quote:"", analysis:"", marker:"", link:"" };
        document.getElementById('quote-reference').style.display = 'none';
        rebuildSentence();
        
        stage.classList.add('flash');
        setTimeout(() => stage.classList.remove('flash'), 500);
        
        const total = appData.items.length;
        if(state.completed.length === total) {
            triggerCelebration();
        }
        
        renderBuilderDropdowns();
        resetToGrid(); 
        switchHub('lab');
    }
    
    function toggleAutoProgress(c) { if(c) localStorage.setItem('tsa_auto_progress', 'true'); else localStorage.removeItem('tsa_auto_progress'); }

    function downloadDoc() { 
        const BOM = "\ufeff";
        const html = `<html><head><meta charset="utf-8"><title>Essay</title></head><body>${document.getElementById('answer-area').value.replace(/\n/g,'<br>')}</body></html>`;
        const blob = new Blob([BOM + html], {type:'application/msword;charset=utf-8'}); 
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Answer.doc'; a.click(); 
    }

    // ADMIN FUNCTIONS
    window.generateAndShowPrompt = function() { 
        const c = document.getElementById('ai-quote-count').value; 
        const t = document.getElementById('ai-source-text').value; 
        const q = document.getElementById('ai-question-input').value; 
        const a = document.getElementById('ai-author-name').value; 
        
        document.getElementById('ai-generated-prompt').value = `Act as expert English teacher. Create JSON lesson.
SOURCE: "${t}"
Q: "${q}"
AUTHOR: "${a}"

CRITICAL: For each quote, you MUST attempt to fill inside 'level1', 'level2', and 'level3' for ALL THREE lenses (Tone, Structure, Language). Do not leave them empty.
CRITICAL: You MUST include a "globalStructure" object with question, correct, and distractors.

REQUIRED JSON FORMAT:
{ 
  "textTitle": "Title", 
  "question": "${q}", 
  "globalStructure": { "enabled": true, "question": "Question about whole text flow?", "correct": "Correct Answer", "distractors": ["Wrong 1", "Wrong 2"] }, 
  "items": [ 
    { 
      "id":"q1", 
      "type":"language", 
      "original":"quote", 
      "translation":"meaning", 
      "distractors":["wrong1","wrong2"], 
      "level1":{ 
        "tone": { "prompt":"Q", "correct":"Ans", "distractors":["W1","W2"] },
        "structure": { "prompt":"Q", "correct":"Ans", "distractors":["W1","W2"] },
        "language": { "prompt":"Q", "correct":"Ans", "distractors":["W1","W2"] }
      }, 
      "level2":{ ...same structure }, 
      "level3":{ ...same structure } 
    } 
  ]... (include markers, starters, methods, points, simpleLinks (no 'that'), complexLinks) 
}`; 
        document.getElementById('prompt-display-container').style.display='block'; 
    };
    
    window.loadDataFromText = function() { 
        let text = document.getElementById('ai-paste-area').value;
        text = text.replace(/```json/g, "").replace(/```/g, "").trim();
        try { 
            const json = JSON.parse(text);
            
            const mode = document.getElementById('ai-bank-mode').value;
            
            if (mode === 'append_quotes') {
                if (json.items) appData.items = appData.items.concat(json.items);
                if (json.textTitle) appData.textTitle = json.textTitle;
            } else if (mode === 'merge_banks') {
                ['markers','starters','methods','points','simpleLinks','complexLinks'].forEach(key => {
                    if(json[key]) appData[key] = [...new Set([...appData[key], ...json[key]])];
                });
                alert("Banks Merged Successfully!");
            } else {
                appData = validateAndRepair({...appData, ...json}); 
                state.completed=[]; 
            }

            sanitizeLinks(); 
            saveLocal(); 
            location.reload(); 
        } catch(e){ 
            alert("Invalid JSON Error: " + e.message); 
        } 
    };
    
    window.updateGlobalDeep = function(key, val) {
        if(!appData.globalStructure) appData.globalStructure = { enabled: true, question:"", correct:"", distractors:[] };
        
        if(key === 'distractors') {
            appData.globalStructure[key] = val.split(',').map(s => s.trim());
        } else {
            appData.globalStructure[key] = val;
        }
        saveLocal();
    };

    window.uploadJSON = function(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const json = JSON.parse(e.target.result);
                
                const mode = document.getElementById('ai-bank-mode').value;
                if (mode === 'append_quotes') {
                    if (json.items) appData.items = appData.items.concat(json.items);
                    if (json.textTitle) appData.textTitle = json.textTitle;
                } else if (mode === 'merge_banks') {
                    ['markers','starters','methods','points','simpleLinks','complexLinks'].forEach(key => {
                        if(json[key]) appData[key] = [...new Set([...appData[key], ...json[key]])];
                    });
                    alert("Banks Merged Successfully!");
                } else {
                    appData = validateAndRepair({...appData, ...json});
                    state.completed=[];
                }
                
                sanitizeLinks();
                saveLocal();
                location.reload();
            } catch(err) {
                alert("Error reading file: " + err.message);
            }
        };
        reader.readAsText(file);
    };
    
    window.saveLocal = function() { localStorage.setItem('tsa_v182_structure', JSON.stringify(appData)); };
    window.updateUI = function() { document.getElementById('student-title').innerText = appData.textTitle; document.getElementById('text-display').innerText = appData.textTitle; document.getElementById('q-display').innerText = appData.question; document.getElementById('score-display').innerText = state.score + " XP"; document.getElementById('edit-title').value = appData.textTitle; document.getElementById('edit-question').value = appData.question;}
    window.updateGlobal = function(k, v) { appData[k]=v; saveLocal(); updateUI(); };

    window.openAdmin = function() { 
        try {
            document.getElementById('admin-modal').style.display='flex'; 
            initAdminConfig(); 
            renderItems();
        } catch(e) {
            console.error("Admin Render Error:", e);
            alert("Warning: Some admin items could not load. Reset Recommended.");
        }
    };
    
    window.closeAdmin = function() { document.getElementById('admin-modal').style.display='none'; };
    window.requestAdminAccess = function() { if(localStorage.getItem('tsa_auto_login')==='true') openAdmin(); else if(prompt("Password:")===appData.adminPassword) openAdmin(); };
    window.toggleAutoLogin = function(c) { if(c) localStorage.setItem('tsa_auto_login','true'); else localStorage.removeItem('tsa_auto_login'); };
    window.updateGlobal = function(k, v) { appData[k]=v; saveLocal(); updateUI(); };
    window.downloadJSON = function() { const b = new Blob([JSON.stringify(appData)], {type: "text/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'data.json'; a.click(); };
    window.downloadStudentApp = function() { const c = JSON.parse(JSON.stringify(appData)); delete c.adminPassword; let h = document.documentElement.outerHTML.replace(/const teacherConfig = null;/, `const teacherConfig = ${JSON.stringify(c)};`); const b = new Blob([h], {type:'text/html'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'student-lesson.html'; a.click(); };
    window.editBank = function(t) { currentEditingBank=t; document.getElementById('bank-editor-area').style.display='block'; document.getElementById('bank-editor-title').innerText=t.toUpperCase(); renderBankList(); };
    window.updateBankItem = function(i,v) { appData[currentEditingBank][i]=v; saveLocal(); renderBuilderDropdowns(); }; 
    window.delBankItem = function(i) { appData[currentEditingBank].splice(i,1); renderBankList(); saveLocal(); renderBuilderDropdowns(); }; 
    window.addBankItem = function() { if(!appData[currentEditingBank]) appData[currentEditingBank]=[]; appData[currentEditingBank].push("New"); renderBankList(); saveLocal(); renderBuilderDropdowns(); }; 
    
    window.escapeHtml = function(text) {
        if(!text) return "";
        return text.replace(/"/g, "&quot;").replace(/'/g, "&#039;");
    }

    window.renderItems = function() { 
        const c=document.getElementById('items-container'); 
        c.innerHTML=''; 
        if(!appData.items) return;
        
        appData.items.forEach((item,i)=>{ 
            const l1 = item.level1?.[item.type] || {};
            const l2 = item.level2?.[item.type] || {};
            const l3 = item.level3?.[item.type] || {};
            const distractors = item.distractors ? item.distractors.join(", ") : "";
            const d1 = l1.distractors ? l1.distractors.join(", ") : "";
            const d2 = l2.distractors ? l2.distractors.join(", ") : "";
            const d3 = l3.distractors ? l3.distractors.join(", ") : "";
            
            c.innerHTML+=`
            <div class="item-editor-card">
                <div class="item-header-row">
                    <strong>#${i+1}</strong>
                    <select onchange="updateItem(${i},'type',this.value)">
                        <option value="tone" ${item.type==='tone'?'selected':''}>Tone</option>
                        <option value="structure" ${item.type==='structure'?'selected':''}>Structure</option>
                        <option value="language" ${item.type==='language'?'selected':''}>Language</option>
                    </select>
                    <div>
                        <label title="Include in Worksheet"><input type="checkbox" ${item.includeInWS?'checked':''} onchange="updateItemBool(${i},'includeInWS',this.checked)"> WS</label>
                    </div>
                </div>
                
                <div class="lens-toggles">
                    <strong>Enable Lenses:</strong>
                    <label><input type="checkbox" ${item.enableTone !== false ? 'checked' : ''} onchange="updateItemBool(${i},'enableTone',this.checked)"> Tone</label>
                    <label><input type="checkbox" ${item.enableStructure !== false ? 'checked' : ''} onchange="updateItemBool(${i},'enableStructure',this.checked)"> Structure</label>
                    <label><input type="checkbox" ${item.enableLanguage !== false ? 'checked' : ''} onchange="updateItemBool(${i},'enableLanguage',this.checked)"> Language</label>
                </div>

                <div class="input-group"><label>Quote:</label><input class="admin-input" value="${escapeHtml(item.original)}" onchange="updateItem(${i},'original',this.value)"></div>
                <div class="input-group"><label>Translation:</label><input class="admin-input" value="${escapeHtml(item.translation)}" onchange="updateItem(${i},'translation',this.value)"></div>
                <div class="input-group"><label>Match Distractors (CSV):</label><input class="admin-input" value="${escapeHtml(distractors)}" onchange="updateDistractors(${i},'base',this.value)"></div>
                
                <div class="level-block level-1">
                    <span class="level-label">Level 1 (Identify)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="${escapeHtml(l1.prompt||'')}" onchange="updateDeep(${i},'level1','${item.type}','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="${escapeHtml(l1.correct||'')}" onchange="updateDeep(${i},'level1','${item.type}','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="${escapeHtml(d1)}" onchange="updateDistractors(${i},'level1',this.value)"></div>
                </div>
                
                <div class="level-block level-2">
                    <span class="level-label">Level 2 (Analyze)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="${escapeHtml(l2.prompt||'')}" onchange="updateDeep(${i},'level2','${item.type}','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="${escapeHtml(l2.correct||'')}" onchange="updateDeep(${i},'level2','${item.type}','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="${escapeHtml(d2)}" onchange="updateDistractors(${i},'level2',this.value)"></div>
                </div>
                
                <div class="level-block level-3">
                    <span class="level-label">Level 3 (Evaluate Effect)</span>
                    <div class="input-group"><label>Question:</label><input class="admin-input" value="${escapeHtml(l3.prompt||'')}" onchange="updateDeep(${i},'level3','${item.type}','prompt',this.value)"></div>
                    <div class="input-group"><label>Correct Answer:</label><input class="admin-input" value="${escapeHtml(l3.correct||'')}" onchange="updateDeep(${i},'level3','${item.type}','correct',this.value)"></div>
                    <div class="input-group"><label>Wrong Answers (CSV):</label><input class="admin-input" value="${escapeHtml(d3)}" onchange="updateDistractors(${i},'level3',this.value)"></div>
                </div>
                
                <button class="btn btn-warning" style="margin-top:10px;" onclick="delItem(${i})">Delete Item</button>
            </div>`; 
        }); 
    };
    
    window.toggleDetails = function(i) { /* Legacy stub */ };
    window.updateItem = function(i,k,v) { appData.items[i][k]=v; saveLocal(); renderItems(); };
    window.updateDistractors = function(i, level, v) { 
        const arr = v.split(',').map(s => s.trim());
        if(level === 'base') {
            appData.items[i].distractors = arr;
        } else {
            const type = appData.items[i].type;
            if(!appData.items[i][level]) appData.items[i][level] = {};
            if(!appData.items[i][level][type]) appData.items[i][level][type] = {};
            appData.items[i][level][type].distractors = arr;
        }
        saveLocal(); 
    };
    window.updateItemBool = function(i,k,v) { appData.items[i][k]=v; saveLocal(); };
    window.updateDeep = function(i,l,t,k,v) { if(!appData.items[i][l]) appData.items[i][l]={}; if(!appData.items[i][l][t]) appData.items[i][l][t]={}; appData.items[i][l][t][k]=v; saveLocal(); };
    window.delItem = function(i) { appData.items.splice(i,1); renderItems(); saveLocal(); };
    window.addNewItem = function() { appData.items.push({type:"tone", original:"New", translation:"", distractors:[], includeInWS:true}); renderItems(); saveLocal(); };
    window.saveStructureConfig = function() { const order=[]; for(let i=0;i<6;i++) order.push(document.getElementById(`cfg-slot${i+1}`).value); appData.sentenceConfigs[adminConfigLevel]=order; saveLocal(); renderBuilderDropdowns(); };
    
    window.downloadWorksheetDoc = function() {
        let html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Worksheet</title><style>body{font-family:Arial, sans-serif;} table{width:100%; border-collapse:collapse; margin-bottom:20px;} td,th{border:1px solid #000; padding:10px;} .box{border:1px solid #000; padding:15px; margin-bottom:15px;} .struct-box{background:#f0f0f0; padding:15px; border:1px solid #000; margin-top:20px;} .page-break { page-break-before: always; }</style></head><body>`;
        
        html += `<h1>Worksheet: ${appData.textTitle}</h1>`;
        html += `<p><strong>Question:</strong> ${appData.question}</p><hr>`;

        let evidence = [], meanings = [];
        appData.items.forEach(i => { 
            if(i.includeInWS !== false) { 
                evidence.push(i.original); 
                meanings.push(i.translation); 
            }
        });
        
        if(evidence.length > 0) {
            let shuffledMeanings = [...meanings];
            shuffleArray(shuffledMeanings);
            html += `<h3>Part 1: Match the Evidence</h3><p>Draw a line to match the quote to its meaning.</p><table><tr><th>Evidence from Text</th><th>Meaning / Translation</th></tr>`;
            evidence.forEach((ev, i) => html += `<tr><td>"${ev}"</td><td>${shuffledMeanings[i]}</td></tr>`);
            html += `</table>`;
        }

        html += `<br clear=all style='mso-special-character:line-break;page-break-before:always'>`;

        html += `<h3>Part 2: Deep Analysis</h3>`;
        appData.items.forEach((item,i) => { 
            if(item.includeInWS === false) return; 
            
            const l1Prompt = item.level1?.[item.type]?.prompt || "Identify the technique:";
            const l2Prompt = item.level2?.[item.type]?.prompt || "What does this suggest?";
            const l3Prompt = item.level3?.[item.type]?.prompt || "Evaluate the effect on the reader:";

            html += `<div class="box">
                <p><strong>${i+1}. "${item.original}"</strong> (${item.type})</p>
                <p>1. ${l1Prompt}</p><br>
                <p>2. ${l2Prompt}</p><br>
                <p>3. ${l3Prompt}</p><br>
            </div>`; 
        });

        if(appData.globalStructure && appData.globalStructure.enabled !== false) {
            html += `<div class="struct-box"><h3>Part 3: Whole Text Structure</h3><p><strong>Question:</strong> ${appData.globalStructure.question}</p><br><br><br><br></div>`;
        }

        html += `</body></html>`;
        
        const blob = new Blob(['\ufeff', html], {
            type: 'application/msword'
        });
        
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = 'Worksheet.doc';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    };
    
    window.exportWordDoc = function() { alert("Use View/Print > Save as PDF for best results."); openPrintView(); };
    window.switchAdminConfigLevel = function(l) { adminConfigLevel=l; document.querySelectorAll('.admin-tab').forEach(t=>t.classList.remove('active')); document.getElementById(`cfg-tab-${l}`).classList.add('active'); initAdminConfig(); };
    window.initAdminConfig = function() { 
        if(!appData.sentenceConfigs || !appData.sentenceConfigs[adminConfigLevel]) {
            appData.sentenceConfigs = defaultData.sentenceConfigs;
        }
        const o=['marker','starter','point','method','quote','analysis','link','none']; 
        const c=appData.sentenceConfigs[adminConfigLevel]; 
        for(let i=0;i<6;i++){ 
            const s=document.getElementById(`cfg-slot${i+1}`); 
            s.innerHTML=''; 
            o.forEach(opt=>s.add(new Option(opt,opt))); 
            s.value=c[i] || 'none'; 
        } 
    };
    window.renderBankList = function() { const l=document.getElementById('bank-list'); l.innerHTML=''; (appData[currentEditingBank]||[]).forEach((item,i)=>{ l.innerHTML+=`<div><input class="admin-input" value="${item}" onchange="updateBankItem(${i},this.value)"> <button onclick="delBankItem(${i})" class="btn-edit-item" style="background:red;">X</button></div>`; }); };

    document.addEventListener("DOMContentLoaded", init);
</script>


</body><grammarly-desktop-integration data-grammarly-shadow-root="true"></grammarly-desktop-integration></html>
