<!DOCTYPE html>
<html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Tone &amp; Structure Architect v5.1 (Stable)</title>
<style>
    /* --- 1. CSS VARIABLES & RESET --- */
    :root {
        --primary: #009688; --accent: #ff9800; 
        --bg: #f0f2f5; --card: #ffffff; --text: #37474f; 
        --border: #cfd8dc; --success: #4caf50; --error: #f44336;
        --tone-color: #9c27b0; --struct-color: #2196f3; --lang-color: #43a047;
    }
    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s, color 0.3s; }

    /* --- 2. HEADER --- */
    header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--card); box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; flex-shrink: 0; border-bottom: 1px solid var(--border); }
    h1 { margin: 0; font-size: 1.1rem; color: var(--primary); display: flex; align-items: center; gap: 8px; font-weight: 800; }
    .score-badge { background: var(--accent); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; }
    .header-controls { display: flex; gap: 8px; align-items: center; }
    .icon-btn { background: none; border: 1px solid var(--border); border-radius: 4px; font-size: 1.2rem; cursor: pointer; padding: 4px 8px; transition: background 0.2s; color: var(--text); }
    .icon-btn:hover { background: rgba(0,0,0,0.05); }
    select.level-select { padding: 5px; border-radius: 4px; border: 1px solid var(--border); font-weight: bold; color: var(--text); background: var(--card); }

    /* --- 3. MAIN LAYOUT --- */
    .viewport { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; scroll-behavior: smooth; }
    .hub { display: none; animation: fadeIn 0.3s ease-out; }
    .hub.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

    /* --- 4. CARDS & GRID --- */
    .section-header { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: var(--text); opacity: 0.7; margin: 20px 0 10px 0; border-bottom: 2px solid var(--border); padding-bottom: 5px; font-weight: bold; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 10px; }
    .card { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); cursor: pointer; position: relative; transition: transform 0.1s; overflow: hidden; }
    .card:hover { transform: translateY(-2px); border-color: var(--primary); }
    .card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 5px; }
    .card-tone::before { background: var(--tone-color); }
    .card-structure::before { background: var(--struct-color); }
    .card-language::before { background: var(--lang-color); }
    .card-global { border-left: 5px solid #607d8b; }
    .quote-text { font-family: 'Georgia', serif; font-style: italic; font-size: 1.05rem; color: var(--text); display: block; margin-bottom: 8px; }
    .card-meta { display: flex; justify-content: space-between; font-size: 0.75rem; text-transform: uppercase; font-weight: bold; opacity: 0.6; }

    /* --- 5. WRITING DESK --- */
    .builder-area { background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); margin-bottom: 20px; }
    .slot-row { margin-bottom: 10px; }
    .slot-label { font-size: 0.75rem; font-weight: 700; color: var(--primary); text-transform: uppercase; display: block; margin-bottom: 3px; }
    .slot-select, .slot-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 4px; font-size: 1rem; background: var(--bg); color: var(--text); }
    .slot-static { background: rgba(0, 150, 136, 0.1); color: var(--primary); padding: 10px; border-radius: 4px; font-style: italic; border: 1px solid var(--border); }
    .preview-box { padding: 15px; background: var(--card); border: 2px dashed var(--accent); border-radius: 8px; font-size: 1.1rem; line-height: 1.5; min-height: 60px; margin-bottom: 15px; color: var(--text); }
    .hint-panel { background: rgba(255, 152, 0, 0.12); border: 1px solid var(--accent); color: var(--text); padding: 8px 10px; border-radius: 6px; font-size: 0.9rem; margin-bottom: 10px; }
    .hint-panel.hidden { display: none; }
    textarea.essay-area { width: 100%; height: 200px; padding: 10px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; font-family: inherit; resize: vertical; margin-bottom: 10px; background: var(--card); color: var(--text); }

    /* --- 6. BUTTONS & UI --- */
    .btn { width: 100%; padding: 12px; border: none; border-radius: 6px; font-weight: bold; font-size: 1rem; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 5px; margin-bottom: 5px; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-accent { background: var(--accent); color: white; }
    .btn-doc { background: #1565c0; color: white; }
    .btn-success { background: var(--success); color: white; }
    .btn-danger { background: var(--error); color: white; }
    .btn-outline { background: var(--card); border: 2px solid var(--border); color: var(--text); }
    .btn-small { padding: 4px 8px; font-size: 0.8rem; width: auto; margin: 0; }
    .filter-bar { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 5px; margin-bottom: 10px; }
    .filter-btn { flex: 1; min-width: 80px; padding: 8px; font-size: 0.85rem; }
    .filter-btn.active { border-color: var(--primary); color: var(--primary); background: rgba(0, 150, 136, 0.08); }

    /* --- 7. MODALS & ADMIN --- */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
    .modal.open { display: flex; }
    .modal-content { background: var(--bg); width: 95%; max-width: 900px; max-height: 95vh; border-radius: 10px; display: flex; flex-direction: column; box-shadow: 0 10px 40px rgba(0,0,0,0.3); overflow: hidden; color: var(--text); }
    .modal-header { padding: 15px; background: var(--card); border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.1rem; }
    .modal-body { padding: 20px; overflow-y: auto; }
    
    .admin-section { background: var(--card); border: 1px solid var(--border); border-radius: 6px; padding: 15px; margin-bottom: 15px; }
    .admin-h { color: var(--primary); margin: 0 0 10px 0; font-size: 1rem; border-bottom: 1px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between; align-items: center; }
    .input-group { margin-bottom: 10px; }
    .input-group label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 3px; }
    .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); }
    
    .quote-editor, .struct-editor { border: 1px solid var(--border); border-radius: 6px; padding: 10px; margin-bottom: 10px; background: var(--bg); }
    .editor-header { display: flex; justify-content: space-between; align-items: center; font-weight: bold; margin-bottom: 8px; opacity: 0.8; font-size: 0.9rem; }
    .level-checks { display: flex; gap: 10px; margin-top: 5px; font-size: 0.85rem; align-items: center; }
    .level-checks label { display: flex; align-items: center; gap: 4px; cursor: pointer; }
    .level-checks input { margin: 0; }
    
    .level-rule-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 6px; margin-top: 6px; }
    .level-rule-grid input, .level-rule-grid select { width: 100%; padding: 6px; border: 1px solid var(--border); border-radius: 4px; background: var(--bg); color: var(--text); }
    
    .bank-tags { display: flex; flex-wrap: wrap; gap: 5px; margin-top: 5px; }
    .bank-tag { background: rgba(0,0,0,0.05); border: 1px solid var(--border); padding: 4px 8px; border-radius: 4px; font-size: 0.85rem; display: flex; align-items: center; gap: 5px; }
    .bank-tag button { background: none; border: none; color: var(--error); cursor: pointer; font-weight: bold; }
    .bank-btn-grid { display: flex; gap: 5px; flex-wrap: wrap; margin-bottom: 10px; }
    .bank-btn-grid button { flex: 1; min-width: 80px; font-size: 0.85rem; padding: 6px; }

    /* Guide Section */
    .guide-box { background: rgba(255, 152, 0, 0.1); border: 1px solid var(--accent); border-radius: 6px; padding: 10px; margin-bottom: 15px; }
    .guide-box summary { font-weight: bold; cursor: pointer; color: var(--accent); list-style: none; display: flex; align-items: center; gap: 5px; }
    .guide-box summary::-webkit-details-marker { display: none; }
    .guide-box summary::before { content: 'üìñ'; }
    .guide-content { margin-top: 10px; font-size: 0.9rem; line-height: 1.5; opacity: 0.9; }
    .guide-content h4 { margin: 10px 0 5px 0; color: var(--primary); }

    /* --- 8. UTILS & NAV --- */
    .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: var(--card); border-top: 1px solid var(--border); display: flex; justify-content: space-around; z-index: 900; }
    .nav-item { flex: 1; background: none; border: none; color: var(--text); opacity: 0.5; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; }
    .nav-item.active { color: var(--primary); opacity: 1; background: rgba(0, 150, 136, 0.05); }
    .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
    .nav-label { font-size: 0.7rem; font-weight: 700; }
    
    .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    .hidden { display: none !important; }
    
    .theme-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-weight: bold; }
    input[type="color"] { border: none; width: 40px; height: 40px; cursor: pointer; background: none; }

    @media print { .no-print { display: none; } }
    
    .celebration { position: fixed; inset: 0; background: rgba(12, 24, 28, 0.92); z-index: 2500; display: flex; align-items: center; justify-content: center; flex-direction: column; color: white; text-align: center; }
    .celebration.hidden { display: none; }
    .celebration-inner { background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); padding: 20px; border-radius: 12px; max-width: 320px; width: 90%; }
    .celebration-title { font-size: 1.5rem; font-weight: 800; margin-bottom: 8px; }
    .celebration-confetti { position: absolute; inset: 0; overflow: hidden; pointer-events: none; }
    .celebration-emoji { position: absolute; font-size: 1.6rem; animation: floatDown 2.5s linear infinite; opacity: 0.9; }
    @keyframes floatDown { from { transform: translateY(-10vh) rotate(0deg); } to { transform: translateY(110vh) rotate(360deg); } }

    .splash { position: fixed; inset: 0; background: #0f1416; color: #e8f5f2; z-index: 2600; display: flex; align-items: center; justify-content: center; flex-direction: column; transition: opacity 0.6s ease; }
    .splash.hidden { opacity: 0; pointer-events: none; }
    .splash-title { font-size: 2rem; font-weight: 900; letter-spacing: 1px; color: var(--primary); }
    .splash-sub { font-size: 0.95rem; opacity: 0.8; margin-top: 6px; }
    .splash-glow { margin-top: 12px; width: 120px; height: 6px; background: linear-gradient(90deg, transparent, var(--accent), transparent); animation: pulse 1.2s ease-in-out infinite; border-radius: 999px; }
    @keyframes pulse { 0%, 100% { opacity: 0.2; transform: scaleX(0.7); } 50% { opacity: 1; transform: scaleX(1.1); } }
    .intro-screen { position: fixed; inset: 0; background: var(--bg); color: var(--text); z-index: 2550; display: flex; align-items: center; justify-content: center; padding: 20px; text-align: center; transition: opacity 0.6s ease; }
    .intro-screen.hidden { opacity: 0; pointer-events: none; }
    .intro-text { max-width: 700px; font-size: 1.05rem; line-height: 1.6; white-space: pre-wrap; }
    .intro-hint { margin-top: 12px; font-size: 0.85rem; opacity: 0.7; }
    .pick-screen { position: fixed; inset: 0; background: var(--bg); color: var(--text); z-index: 2540; display: flex; align-items: center; justify-content: center; transition: opacity 0.6s ease; }
    .pick-screen.hidden { opacity: 0; pointer-events: none; }
    .pick-title { font-size: 1.4rem; font-weight: 800; color: var(--primary); }

    #emergency-reset { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 9999; background: #d32f2f; color: white; padding: 20px; border-radius: 8px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); text-align: center; display: none; }
</style>
</head>
<body data-new-gr-c-s-check-loaded="14.1270.0" data-gr-ext-installed="" data-new-gr-c-s-loaded="14.1270.0"><script>window.STANDALONE_LESSON = {"focusQuestion":"How does the writer try to show that Mark Poulton loves his work as a Punch and Judy man? You should comment on: ‚Ä¢ what is said ‚Ä¢ the use of language, tone and structure ‚Ä¢ other ways the writer tries to show that Mark Poulton loves his work","items":[{"id":"q1","original":"calls it his dream job","translation":"He describes the work as perfect for him.","translationDistractors":["He dreams about working while sleeping.","He thinks the job makes him sleepy."],"type":"tone","effect":"emphasizes his deep personal satisfaction.","effectDistractors":["shows that he is tired of working.","suggests he wants a different job."],"levels":[1],"includeInWorksheet":true},{"id":"q2","original":"entertains the crowds every summer","translation":"He performs for people annually.","translationDistractors":["He is entertained by the crowds.","He avoids the crowds in summer."],"type":"tone","effect":"highlights his consistent dedication.","effectDistractors":["shows he only works when forced.","suggests he dislikes the summer."],"levels":[1],"includeInWorksheet":true},{"id":"q3","original":"shows run four or five times daily","translation":"He performs many times each day.","translationDistractors":["He runs around the beach four times.","He watches four or five shows a day."],"type":"tone","effect":"demonstrates his tireless work ethic.","effectDistractors":["shows he has too much free time.","implies he is lazy and works little."],"levels":[2],"includeInWorksheet":true},{"id":"q4","original":"only one he had ever wanted","translation":"He never desired any other career.","translationDistractors":["He wanted many other jobs.","He is the only one who wanted the job."],"type":"tone","effect":"reveals his singular focus and passion.","effectDistractors":["suggests he had no other choices.","shows he settled for this job."],"levels":[2],"includeInWorksheet":true},{"id":"q5","original":"Weymouth‚Äôs Mr Punch and Judy man","translation":"He is the town's recognized performer.","translationDistractors":["He owns the town of Weymouth.","He is a man named Mr Weymouth."],"type":"tone","effect":"suggests his identity is defined by his role.","effectDistractors":["shows he is a stranger to the town.","implies nobody knows who he is."],"levels":[3],"includeInWorksheet":true},{"id":"q6","original":"sky is thick with grey clouds","translation":"The weather is gloomy and overcast.","translationDistractors":["The clouds are made of thick smoke.","The sky is falling down."],"type":"tone","effect":"contrasts the dull weather with his joy.","effectDistractors":["shows that the weather makes him sad.","suggests he prefers working in the rain."],"levels":[3],"includeInWorksheet":true},{"id":"q7","original":"dream job... even though times are harder","translation":"He loves it despite the difficulties.","translationDistractors":["The job is too hard for him now.","He is dreaming of harder times."],"type":"tone","effect":"proves his love outweighs financial challenges.","effectDistractors":["shows he is complaining about money.","suggests he wants to quit soon."],"levels":[4],"includeInWorksheet":true},{"id":"q8","original":"bump into... Mark Poulton","translation":"The reporter meets him by chance.","translationDistractors":["The reporter crashed into him.","Mark Poulton bumped into a wall."],"type":"tone","effect":"introduces him as a prominent local figure.","effectDistractors":["shows he is clumsy and falls over.","implies he is hiding from people."],"levels":[4],"includeInWorksheet":true},{"id":"q9","original":"threatens to rain","translation":"The weather looks like it will spoil the day.","translationDistractors":["The rain is shouting at him.","He is threatening the rain."],"type":"tone","effect":"emphasizes his persistence despite bad conditions.","effectDistractors":["shows he is afraid of getting wet.","suggests he cancels shows easily."],"levels":[5],"includeInWorksheet":true},{"id":"q10","original":"since watching a Punch and Judy show","translation":"Viewing a performance as a child.","translationDistractors":["He has been watching shows recently.","He is currently watching a show."],"type":"tone","effect":"establishes the childhood origin of his passion.","effectDistractors":["shows he likes watching more than performing.","suggests he learned nothing from watching."],"levels":[5],"includeInWorksheet":true}],"globalStructure":{"enabled":true,"items":[{"id":"g1","question":"How does the writer use the opening to set the scene?","correct":"It contrasts the gloomy weather with Mark's bright enthusiasm.","distractors":["It shows that the weather is perfect for a beach day.","It complains about how boring Weymouth is."]},{"id":"g2","question":"What is the structural shift in the text?","correct":"It moves from the present atmosphere to Mark's background.","distractors":["It moves from the future to the past.","It stays focused only on the weather throughout."]}]},"sentenceConfig":{"1":["starter","quote","link_l1","point"],"2":["marker","starter","quote","method","point","link_l2"],"3":["marker","starter","quote","method","point","link_l3"],"4":["marker","starter","quote","method","manual_point","link_l3"],"5":["marker","starter","quote","manual_method","point","link_l3"],"6":["marker","manual_starter","quote","method","point","link_l3"],"7":["manual_marker","starter","quote","method","point","link_l3"],"8":["marker","starter","quote","method","point","manual_link"],"9":["marker","starter","quote","method","manual_analysis","link_l3"],"10":["marker","starter","quote","method","manual_effect","link_l3"]},"banks":{"markers":["Firstly,","Furthermore,","In addition,","Moreover,","Significantly,"],"starters":["the writer states","the text describes","the author notes","the article mentions","the reporter observes"],"methods":["using language to show that","using a specific tone to reveal that","employing structure to highlight that","choosing words to demonstrate that","using phrasing which implies that"],"points":["he feels a deep sense of personal fulfillment","he remains dedicated despite the difficult challenges","his identity is completely defined by this role","he is committed to entertaining the public daily","his passion began when he was just a child","he persists even when the weather is miserable","he views the profession as his ultimate ambition","he works tirelessly to maintain the tradition","the performance brings joy to the gloomy seafront","he is a unique and established figure in the town"],"links":{"l1":["which suggests that","which shows that","meaning that"],"l2":[", highlighting his dedication.",", proving he loves the job.",", showing his strong work ethic."],"l3":[", reinforcing his deep passion.",", underscoring his professional pride.",", confirming his lifelong commitment."],"l4":[", reinforcing his deep passion.",", underscoring his professional pride.",", confirming his lifelong commitment."],"l5":[", reinforcing his deep passion.",", underscoring his professional pride.",", confirming his lifelong commitment."],"l6":[", reinforcing his deep passion.",", underscoring his professional pride.",", confirming his lifelong commitment."],"l7":[", reinforcing his deep passion.",", underscoring his professional pride.",", confirming his lifelong commitment."],"l8":[", reinforcing his deep passion.",", underscoring his professional pride.",", confirming his lifelong commitment."],"l9":[", reinforcing his deep passion.",", underscoring his professional pride.",", confirming his lifelong commitment."],"l10":[", reinforcing his deep passion.",", underscoring his professional pride.",", confirming his lifelong commitment."]}},"settings":{"autoProgress":false,"practiceMode":false,"practiceModeLevel":1,"practiceForceAuto":false,"practiceFixedTemplate":false,"worksheetMatchMode":"jumbled","levelRules":{"1":{"maxWords":12,"ellipsesMaxWords":7},"2":{"maxWords":20,"ellipsesMaxWords":7},"3":{"maxWords":30,"ellipsesMaxWords":7},"4":{"maxWords":34,"ellipsesMaxWords":7},"5":{"maxWords":38,"ellipsesMaxWords":7},"6":{"maxWords":30,"ellipsesMaxWords":7},"7":{"maxWords":30,"ellipsesMaxWords":7},"8":{"maxWords":30,"ellipsesMaxWords":7},"9":{"maxWords":30,"ellipsesMaxWords":7},"10":{"maxWords":30,"ellipsesMaxWords":7}},"templates":[],"activeLevels":[1,2,3],"aiPromptAllLevels":false,"strictMode":false},"meta":{"title":"Demo Lesson","author":"System","version":"5.1","id":"lesson_1769757339286"},"sourceText":"Knockout Punch Mark Poulton‚Äôs Punch and Judy puppet show entertains the crowds every summer on Weymouth seafront. He calls it his dream job, even though times are harder now. Reporter Craig Arnott met up with him. It‚Äôs Tuesday morning on Weymouth seafront and the sky is thick with grey clouds. I have only strolled 50 yards when I bump into Weymouth‚Äôs Mr Punch and Judy man, Mark Poulton, who is one of just three licensed Punch and Judy performers left in the UK. We‚Äôd met briefly the night before when I watched his Monday evening show down on the beach. For the rest of the week, his shows run four or five times daily throughout the summer. As it threatens to rain, we dip into a caf√© where he tells me it‚Äôs his dream job, the only one he had ever wanted since watching a Punch and Judy show with his mother as a 5-year-old child. ‚ÄúWe came here for a week‚Äôs holiday,‚Äù he explains. ‚ÄúI watched every performance that week. As soon as I got home, I transformed my teddies into puppets and set up my own show in the back garden.‚Äù When he was just 16 he secured his first summer season at Llandudno, before taking his show all over the country, and then being invited to perform on Weymouth‚Äôs sands in 2005. He‚Äôs a master of his craft, having taught himself to carve his wooden puppets and design and make their costumes. He says that Weymouth has had a Punch and Judy show since 1880, making it an important part of the town‚Äôs history. ‚ÄúAnd I‚Äôm now a part of the town‚Äôs history and tradition too. During the summer I draw big crowds,‚Äù he tells me proudly. ‚ÄúIn fact, many people tell me they come to Weymouth purely to see the rare sight of a Punch and Judy show still being performed on the beach.‚Äù He looks up and smiles, a man in love with his work and with Weymouth. ‚ÄúIt‚Äôs the perfect home for Punch and Judy shows,‚Äù he says. ‚ÄúWith its safe, sandy beach people are happy to come and sit on the sand, but there are always people up on the seafront enjoying the show too.‚Äù Now 48 years old, Mark knows that being Weymouth‚Äôs Punch and Judy man won‚Äôt make him rich but that doesn‚Äôt put him off. ‚ÄúI love the thrill of the work and living off your wits. You‚Äôre constantly pushing to find new routines that will attract an audience.‚Äù His seaside show is one of the last to rely on audiences giving a donation when his assistant goes around with the collecting box. Although his shows often draw audiences of over 200, he tells me that in 2016 he had threatened to end his beach performances because of the poor behaviour of some children. ‚ÄúObviously I encourage their participation in the show, and I want them to shout and yell, but I had kids throwing stones at the show and the parents just sat there and let them do it. I even had adults sunbathing in front of the show, so people who wanted to watch couldn‚Äôt sit there. They refused to pay to watch the show and some of the children were trying to deliberately stop the show by banging on the show booth. I just became fed up and at the time it kind of destroyed my faith in humanity. I just got a load of verbal abuse from the kids and their parents did nothing.‚Äù Fortunately for Weymouth, when he announced he might stop performing, he was overwhelmed with messages of support and he decided to continue. ¬© WJEC CBAC Ltd. (C700U20-1A)3 Despite his obvious passion for keeping the tradition of Punch and Judy alive, in recent years it has been hard for Mark to cover his costs and make a living, ‚ÄúI make a little bit of extra money from selling souvenir key rings after the performances but it‚Äôs never enough.‚Äù This year he successfully appealed for donations on a Facebook crowdfunding page to raise money, and quickly raised enough to cover his expenses. Outside the caf√©, darker clouds are beginning to gather as his first performance of the day approaches. ‚ÄúSometimes people are glad of something to watch when it‚Äôs raining,‚Äù he says, ‚Äúand I‚Äôm always happy to do the shows, come rain or shine.‚Äù","question":"How is language used?","isStandalone":true};</script>

    <div id="save-status" style="position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.8); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; opacity: 1; transition: 0.3s; z-index: 3000;">üíæ Saved</div>

    <div id="emergency-reset">
        <h2>‚ö†Ô∏è App Crashed</h2>
        <p>The loaded data was corrupted.</p>
        <button class="btn btn-outline" style="background:white; color:black; margin-top:10px;" onclick="localStorage.clear(); location.reload();">Emergency Reset</button>
    </div>

    <div id="celebration-overlay" class="celebration hidden">
        <div class="celebration-confetti" id="celebration-confetti"></div>
        <div class="celebration-inner">
            <div class="celebration-title" id="celebration-title">Level Complete! üéâ</div>
            <div id="celebration-sub" style="margin-bottom:15px; color:#cfd8dc;">Great work!</div>
            <button class="btn btn-primary" id="celebration-btn" onclick="ui.closeCelebration()">Continue</button>
        </div>
    </div>

    <div id="splash-screen" class="splash hidden" data-shown="true">
        <div class="splash-title">Answer Architect</div>
        <div class="splash-sub">Booting your analysis tools...</div>
        <div class="splash-glow"></div>
    </div>

    <div id="intro-text-screen" class="intro-screen hidden">
        <div>
            <div id="intro-text" class="intro-text">Knockout Punch Mark Poulton‚Äôs Punch and Judy puppet show entertains the crowds every summer on Weymouth seafront. He calls it his dream job, even though times are harder now. Reporter Craig Arnott met up with him. It‚Äôs Tuesday morning on Weymouth seafront and the sky is thick with grey clouds. I have only strolled 50 yards when I bump into Weymouth‚Äôs Mr Punch and Judy man, Mark Poulton, who is one of just three licensed Punch and Judy performers left in the UK. We‚Äôd met briefly the night before when I watched his Monday evening show down on the beach. For the rest of the week, his shows run four or five times daily throughout the summer. As it threatens to rain, we dip into a caf√© where he tells me it‚Äôs his dream job, the only one he had ever wanted since watching a Punch and Judy show with his mother as a 5-year-old child. ‚ÄúWe came here for a week‚Äôs holiday,‚Äù he explains. ‚ÄúI watched every performance that week. As soon as I got home, I transformed my teddies into puppets and set up my own show in the back garden.‚Äù When he was just 16 he secured his first summer season at Llandudno, before taking his show all over the country, and then being invited to perform on Weymouth‚Äôs sands in 2005. He‚Äôs a master of his craft, having taught himself to carve his wooden puppets and design and make their costumes. He says that Weymouth has had a Punch and Judy show since 1880, making it an important part of the town‚Äôs history. ‚ÄúAnd I‚Äôm now a part of the town‚Äôs history and tradition too. During the summer I draw big crowds,‚Äù he tells me proudly. ‚ÄúIn fact, many people tell me they come to Weymouth purely to see the rare sight of a Punch and Judy show still being performed on the beach.‚Äù He looks up and smiles, a man in love with his work and with Weymouth. ‚ÄúIt‚Äôs the perfect home for Punch and Judy shows,‚Äù he says. ‚ÄúWith its safe, sandy beach people are happy to come and sit on the sand, but there are always people up on the seafront enjoying the show too.‚Äù Now 48 years old, Mark knows that being Weymouth‚Äôs Punch and Judy man won‚Äôt make him rich but that doesn‚Äôt put him off. ‚ÄúI love the thrill of the work and living off your wits. You‚Äôre constantly pushing to find new routines that will attract an audience.‚Äù His seaside show is one of the last to rely on audiences giving a donation when his assistant goes around with the collecting box. Although his shows often draw audiences of over 200, he tells me that in 2016 he had threatened to end his beach performances because of the poor behaviour of some children. ‚ÄúObviously I encourage their participation in the show, and I want them to shout and yell, but I had kids throwing stones at the show and the parents just sat there and let them do it. I even had adults sunbathing in front of the show, so people who wanted to watch couldn‚Äôt sit there. They refused to pay to watch the show and some of the children were trying to deliberately stop the show by banging on the show booth. I just became fed up and at the time it kind of destroyed my faith in humanity. I just got a load of verbal abuse from the kids and their parents did nothing.‚Äù Fortunately for Weymouth, when he announced he might stop performing, he was overwhelmed with messages of support and he decided to continue. ¬© WJEC CBAC Ltd. (C700U20-1A)3 Despite his obvious passion for keeping the tradition of Punch and Judy alive, in recent years it has been hard for Mark to cover his costs and make a living, ‚ÄúI make a little bit of extra money from selling souvenir key rings after the performances but it‚Äôs never enough.‚Äù This year he successfully appealed for donations on a Facebook crowdfunding page to raise money, and quickly raised enough to cover his expenses. Outside the caf√©, darker clouds are beginning to gather as his first performance of the day approaches. ‚ÄúSometimes people are glad of something to watch when it‚Äôs raining,‚Äù he says, ‚Äúand I‚Äôm always happy to do the shows, come rain or shine.‚Äù</div>
            <div class="intro-hint">Get ready to explore the language.</div>
        </div>
    </div>

    <div id="pick-quote-screen" class="pick-screen hidden">
        <div class="pick-title">Pick a quote</div>
    </div>

    <header class="no-print">
        <h1>
            <button class="icon-btn" onclick="app.resetSession()" style="color:red; border-color:red;" title="Reset Session">‚ú®</button>
            Tone &amp; Structure
            <span class="score-badge" id="score-display">0 XP</span>
            <span class="score-badge" id="level-display">Lvl 1</span>
        </h1>
        <div class="header-controls">
            <button class="icon-btn" onclick="ui.openModal('modal-help')">‚ùì</button>
            <button class="icon-btn" onclick="ui.openModal('modal-theme')" title="Colors">üé®</button>
            <select id="level-selector" class="level-select" onchange="app.setLevel(this.value)"><option value="1">Lvl 1</option><option value="2">Lvl 2</option><option value="3">Lvl 3</option><option value="4">Lvl 4</option><option value="5">Lvl 5</option></select>
            
        </div>
    </header>

    <div class="viewport no-print">
        
        <div id="view-lab" class="hub active">
            <div style="display:flex; justify-content:space-between; align-items:center; background:var(--card); padding:10px; border-bottom:1px solid var(--border);">
                <div><strong>Topic:</strong> <span id="lbl-title">Demo Lesson</span></div>
                <button class="btn btn-outline" style="width:auto; padding:5px 10px;" onclick="ui.openModal('modal-source')">üìÑ View Text</button>
            </div>
            
            <div style="padding:10px;">
                <details class="guide-box" open="">
                    <summary>Source Text (Tap to collapse)</summary>
                    <div class="guide-content" id="source-inline">Knockout Punch Mark Poulton‚Äôs Punch and Judy puppet show entertains the crowds every summer on Weymouth seafront. He calls it his dream job, even though times are harder now. Reporter Craig Arnott met up with him. It‚Äôs Tuesday morning on Weymouth seafront and the sky is thick with grey clouds. I have only strolled 50 yards when I bump into Weymouth‚Äôs Mr Punch and Judy man, Mark Poulton, who is one of just three licensed Punch and Judy performers left in the UK. We‚Äôd met briefly the night before when I watched his Monday evening show down on the beach. For the rest of the week, his shows run four or five times daily throughout the summer. As it threatens to rain, we dip into a caf√© where he tells me it‚Äôs his dream job, the only one he had ever wanted since watching a Punch and Judy show with his mother as a 5-year-old child. ‚ÄúWe came here for a week‚Äôs holiday,‚Äù he explains. ‚ÄúI watched every performance that week. As soon as I got home, I transformed my teddies into puppets and set up my own show in the back garden.‚Äù When he was just 16 he secured his first summer season at Llandudno, before taking his show all over the country, and then being invited to perform on Weymouth‚Äôs sands in 2005. He‚Äôs a master of his craft, having taught himself to carve his wooden puppets and design and make their costumes. He says that Weymouth has had a Punch and Judy show since 1880, making it an important part of the town‚Äôs history. ‚ÄúAnd I‚Äôm now a part of the town‚Äôs history and tradition too. During the summer I draw big crowds,‚Äù he tells me proudly. ‚ÄúIn fact, many people tell me they come to Weymouth purely to see the rare sight of a Punch and Judy show still being performed on the beach.‚Äù He looks up and smiles, a man in love with his work and with Weymouth. ‚ÄúIt‚Äôs the perfect home for Punch and Judy shows,‚Äù he says. ‚ÄúWith its safe, sandy beach people are happy to come and sit on the sand, but there are always people up on the seafront enjoying the show too.‚Äù Now 48 years old, Mark knows that being Weymouth‚Äôs Punch and Judy man won‚Äôt make him rich but that doesn‚Äôt put him off. ‚ÄúI love the thrill of the work and living off your wits. You‚Äôre constantly pushing to find new routines that will attract an audience.‚Äù His seaside show is one of the last to rely on audiences giving a donation when his assistant goes around with the collecting box. Although his shows often draw audiences of over 200, he tells me that in 2016 he had threatened to end his beach performances because of the poor behaviour of some children. ‚ÄúObviously I encourage their participation in the show, and I want them to shout and yell, but I had kids throwing stones at the show and the parents just sat there and let them do it. I even had adults sunbathing in front of the show, so people who wanted to watch couldn‚Äôt sit there. They refused to pay to watch the show and some of the children were trying to deliberately stop the show by banging on the show booth. I just became fed up and at the time it kind of destroyed my faith in humanity. I just got a load of verbal abuse from the kids and their parents did nothing.‚Äù Fortunately for Weymouth, when he announced he might stop performing, he was overwhelmed with messages of support and he decided to continue. ¬© WJEC CBAC Ltd. (C700U20-1A)3 Despite his obvious passion for keeping the tradition of Punch and Judy alive, in recent years it has been hard for Mark to cover his costs and make a living, ‚ÄúI make a little bit of extra money from selling souvenir key rings after the performances but it‚Äôs never enough.‚Äù This year he successfully appealed for donations on a Facebook crowdfunding page to raise money, and quickly raised enough to cover his expenses. Outside the caf√©, darker clouds are beginning to gather as his first performance of the day approaches. ‚ÄúSometimes people are glad of something to watch when it‚Äôs raining,‚Äù he says, ‚Äúand I‚Äôm always happy to do the shows, come rain or shine.‚Äù</div>
                </details>

                <div class="filter-bar">
                    <button class="btn btn-outline filter-btn active" data-filter="all" onclick="app.setFilter('all')">All</button>
                    <button class="btn btn-outline filter-btn" data-filter="language" onclick="app.setFilter('language')">Lang</button>
                    <button class="btn btn-outline filter-btn" data-filter="structure" onclick="app.setFilter('structure')">Struct</button>
                    <button class="btn btn-outline filter-btn" data-filter="tone" onclick="app.setFilter('tone')">Tone</button>
                    <button class="btn btn-outline filter-btn" id="btn-show-done" onclick="app.toggleDone()">Show Done</button>
                </div>

                <div id="quote-grid" class="grid"><div class="card card-tone"><span class="quote-text">"calls it his dream job"</span><div class="card-meta"><span>tone</span><span></span></div></div><div class="card card-tone"><span class="quote-text">"entertains the crowds every summer"</span><div class="card-meta"><span>tone</span><span></span></div></div></div>
                
                <div class="section-header" style="margin-top:20px;">Global Analysis</div>
                <div id="global-card-container"><div class="card card-global"><strong>üèóÔ∏è Structure</strong><br><small>How does the writer use the opening to set the scene?</small></div><div class="card card-global"><strong>üèóÔ∏è Structure</strong><br><small>What is the structural shift in the text?</small></div></div>
            </div>
        </div>

        <div id="view-desk" class="hub">
            <div style="padding:15px;">
                <div class="section-header" style="margin-top:0;">Sentence Construction</div>
                <div id="sentence-builder" class="builder-area">
                    <div style="text-align:center; opacity:0.6; padding:20px;">Select a quote in the Evidence Lab to start.</div>
                </div>

                <div class="section-header">Preview &amp; Edit</div>
                <div id="preview-box" class="preview-box" contenteditable="true"></div>
                <div id="hint-panel" class="hint-panel hidden"></div>
                
                <div style="display:grid; grid-template-columns:1fr 2fr; gap:10px; margin-bottom:20px;">
                    <button class="btn btn-accent" onclick="app.undo()">Undo</button>
                    <button class="btn btn-primary" onclick="app.commitSentence()">Commit to Answer ‚¨á</button>
                </div>

                <textarea id="essay-area" class="essay-area" placeholder="Your answer will appear here..." oninput="app.updateEssay(this.value)"></textarea>
                
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-doc" onclick="app.exportDoc()">Download .doc</button>
                    <button class="btn btn-danger" onclick="app.clearEssay()">Clear</button>
                </div>
            </div>
        </div>
    </div>

    <nav class="bottom-nav no-print">
        <button class="nav-item active" onclick="ui.switchView('lab')" id="nav-lab">
            <span class="nav-icon">üß™</span><span class="nav-label">Evidence Lab</span>
        </button>
        <button class="nav-item" onclick="ui.switchView('desk')" id="nav-desk">
            <span class="nav-icon">‚úçÔ∏è</span><span class="nav-label">Writing Desk</span>
        </button>
    </nav>

    <div id="modal-source" class="modal" data-backdrop-bound="true">
        <div class="modal-content">
            <div class="modal-header">Source Text <button class="icon-btn" onclick="ui.closeModal('modal-source')">‚úï</button></div>
            <div class="modal-body"><div id="source-content" style="white-space:pre-wrap; line-height:1.6; font-size:1.1rem; font-family:'Georgia';">Knockout Punch Mark Poulton‚Äôs Punch and Judy puppet show entertains the crowds every summer on Weymouth seafront. He calls it his dream job, even though times are harder now. Reporter Craig Arnott met up with him. It‚Äôs Tuesday morning on Weymouth seafront and the sky is thick with grey clouds. I have only strolled 50 yards when I bump into Weymouth‚Äôs Mr Punch and Judy man, Mark Poulton, who is one of just three licensed Punch and Judy performers left in the UK. We‚Äôd met briefly the night before when I watched his Monday evening show down on the beach. For the rest of the week, his shows run four or five times daily throughout the summer. As it threatens to rain, we dip into a caf√© where he tells me it‚Äôs his dream job, the only one he had ever wanted since watching a Punch and Judy show with his mother as a 5-year-old child. ‚ÄúWe came here for a week‚Äôs holiday,‚Äù he explains. ‚ÄúI watched every performance that week. As soon as I got home, I transformed my teddies into puppets and set up my own show in the back garden.‚Äù When he was just 16 he secured his first summer season at Llandudno, before taking his show all over the country, and then being invited to perform on Weymouth‚Äôs sands in 2005. He‚Äôs a master of his craft, having taught himself to carve his wooden puppets and design and make their costumes. He says that Weymouth has had a Punch and Judy show since 1880, making it an important part of the town‚Äôs history. ‚ÄúAnd I‚Äôm now a part of the town‚Äôs history and tradition too. During the summer I draw big crowds,‚Äù he tells me proudly. ‚ÄúIn fact, many people tell me they come to Weymouth purely to see the rare sight of a Punch and Judy show still being performed on the beach.‚Äù He looks up and smiles, a man in love with his work and with Weymouth. ‚ÄúIt‚Äôs the perfect home for Punch and Judy shows,‚Äù he says. ‚ÄúWith its safe, sandy beach people are happy to come and sit on the sand, but there are always people up on the seafront enjoying the show too.‚Äù Now 48 years old, Mark knows that being Weymouth‚Äôs Punch and Judy man won‚Äôt make him rich but that doesn‚Äôt put him off. ‚ÄúI love the thrill of the work and living off your wits. You‚Äôre constantly pushing to find new routines that will attract an audience.‚Äù His seaside show is one of the last to rely on audiences giving a donation when his assistant goes around with the collecting box. Although his shows often draw audiences of over 200, he tells me that in 2016 he had threatened to end his beach performances because of the poor behaviour of some children. ‚ÄúObviously I encourage their participation in the show, and I want them to shout and yell, but I had kids throwing stones at the show and the parents just sat there and let them do it. I even had adults sunbathing in front of the show, so people who wanted to watch couldn‚Äôt sit there. They refused to pay to watch the show and some of the children were trying to deliberately stop the show by banging on the show booth. I just became fed up and at the time it kind of destroyed my faith in humanity. I just got a load of verbal abuse from the kids and their parents did nothing.‚Äù Fortunately for Weymouth, when he announced he might stop performing, he was overwhelmed with messages of support and he decided to continue. ¬© WJEC CBAC Ltd. (C700U20-1A)3 Despite his obvious passion for keeping the tradition of Punch and Judy alive, in recent years it has been hard for Mark to cover his costs and make a living, ‚ÄúI make a little bit of extra money from selling souvenir key rings after the performances but it‚Äôs never enough.‚Äù This year he successfully appealed for donations on a Facebook crowdfunding page to raise money, and quickly raised enough to cover his expenses. Outside the caf√©, darker clouds are beginning to gather as his first performance of the day approaches. ‚ÄúSometimes people are glad of something to watch when it‚Äôs raining,‚Äù he says, ‚Äúand I‚Äôm always happy to do the shows, come rain or shine.‚Äù</div></div>
        </div>
    </div>

    <div id="modal-wizard" class="modal" data-backdrop-bound="true">
        <div class="modal-content">
            <div class="modal-header"><span id="wizard-title">Analysis</span> <button class="icon-btn" onclick="ui.closeModal('modal-wizard')">‚úï</button></div>
            <div class="modal-body">
                <div id="wizard-prompt" style="margin-bottom:15px;"></div>
                <div id="wizard-options" class="grid"></div>
            </div>
        </div>
    </div>

    <div id="modal-help" class="modal" data-backdrop-bound="true">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">Student Help <button class="icon-btn" onclick="ui.closeModal('modal-help')">‚úï</button></div>
            <div class="modal-body">
                <p><strong>1. Evidence Lab:</strong> Read the source text. Click on colored quote cards to analyze them. Correct answers earn XP.</p>
                <hr>
                <p><strong>2. Writing Desk:</strong> Use the dropdown menus to build professional analytical sentences. You can edit the text manually before adding it to your final essay.</p>
            </div>
        </div>
    </div>

    <div id="modal-theme" class="modal" data-backdrop-bound="true">
        <div class="modal-content" style="max-width:350px;">
            <div class="modal-header">Theme Colors <button class="icon-btn" onclick="ui.closeModal('modal-theme')">‚úï</button></div>
            <div class="modal-body">
                <div class="theme-row"><span>Background:</span> <input type="color" id="col-bg" onchange="ui.setTheme('bg', this.value)"></div>
                <div class="theme-row"><span>Text Color:</span> <input type="color" id="col-text" onchange="ui.setTheme('text', this.value)"></div>
                <div class="theme-row"><span>Card Color:</span> <input type="color" id="col-card" onchange="ui.setTheme('card', this.value)"></div>
                <hr>
                <button class="btn btn-outline" onclick="ui.resetTheme()">Reset to Defaults</button>
            </div>
        </div>
    </div>

    
    <script>
/** ARCHITECT v5.1 (Safety First) **/

/* --- DEFAULT DATA --- */
const defaultData = {
    meta: { title: "Demo Lesson", author: "System", version: "5.1" },
    sourceText: "The sky was a bruised purple...",
    question: "How is language used?",
    settings: { 
        autoProgress: false,
        practiceMode: false,
        practiceModeLevel: 1,
        practiceForceAuto: false,
        practiceFixedTemplate: false,
        worksheetMatchMode: "jumbled",
        activeLevels: [1,2,3],
        aiPromptAllLevels: false,
        strictMode: false,
        levelRules: {
            1: { maxWords: 12, ellipsesMaxWords: 7 },
            2: { maxWords: 20, ellipsesMaxWords: 7 },
            3: { maxWords: 30, ellipsesMaxWords: 7 }
        }
    },
    globalStructure: {
        enabled: true,
        items: [
            { id: "g1", question: "How does the text shift?", correct: "Outside to Inside", distractors: ["Inside to Outside", "No shift"] }
        ]
    },
    banks: {
        markers: ["Furthermore,", "However,"],
        starters: ["The writer implies", "The text suggests"],
        methods: ["Metaphor", "Simile"],
        points: ["a sense of fear is created", "tension builds for the reader"],
        links: { l1: ["This shows"], l2: ["This reinforces"], l3: ["This highlights"] }
    },
    sentenceConfig: {
        1: ["starter", "quote", "link_l1", "point"],
        2: ["marker", "starter", "quote", "method", "point", "link_l2"],
        3: ["marker", "starter", "quote", "method", "point", "link_l3"]
    },
    items: [
        { id: "q1", original: "bruised purple", translation: "Dark color", translationDistractors: ["Bright"], type: "language", effect: "gloomy mood", effectDistractors: ["happy"], levels: [1,2,3], includeInWorksheet: true }
    ],
    isStandalone: false 
};

let appData = null;
let userState = { score: 0, level: 1, essay: "", completed: [], completedLevels: [], filter: "all", showDone: false };
let currentBankKey = null;
let saveTimeout = null;

/* --- APP LOGIC --- */
const app = {
    normalizeKey: function(raw) {
        return String(raw || "lesson").toLowerCase().replace(/[^a-z0-9]+/g, "_").slice(0, 60);
    },
    getStateKey: function() {
        if(appData && appData.isStandalone) {
            const id = app.normalizeKey(appData.meta && appData.meta.id ? appData.meta.id : "");
            if(id) return `tsa_v5_1_state_${id}`;
            const title = app.normalizeKey(appData.meta && appData.meta.title ? appData.meta.title : "standalone");
            const version = app.normalizeKey(appData.meta && appData.meta.version ? appData.meta.version : "v1");
            return `tsa_v5_1_state_${title}_${version}`;
        }
        return "tsa_v5_1_state";
    },
    getPracticeTemplate: function(level) {
        const templates = {
            1: ["starter", "quote", "link_l1", "point"],
            2: ["marker", "starter", "quote", "method", "point", "link_l2"],
            3: ["marker", "starter", "quote", "method", "point", "link_l3"]
        };
        return templates[level] || templates[1];
    },
    cleanSourceText: function(text) {
        if(typeof text !== "string") return "";
        let t = text;
        t = t.replace(/<[^>]*>/g, " ");
        t = t.replace(/&nbsp;/gi, " ").replace(/&amp;/gi, "&").replace(/&lt;/gi, "<").replace(/&gt;/gi, ">");
        const cutoffIdx = (() => {
            const markers = ["Part A: Match", "Part B: Analysis", "Worksheet", "Match Meanings"];
            let idx = -1;
            markers.forEach(m => {
                const i = t.indexOf(m);
                if(i >= 0 && (idx === -1 || i < idx)) idx = i;
            });
            return idx;
        })();
        if(cutoffIdx > 0) t = t.slice(0, cutoffIdx);
        t = t.replace(/\s+\n/g, "\n").replace(/\n{3,}/g, "\n\n").replace(/[ \t]{2,}/g, " ");
        return t.trim();
    },
    getDefaultSentenceConfig: function(level) {
        if(level === 1) return ["starter", "quote", "link_l1", "point"];
        if(level === 2) return ["marker", "starter", "quote", "method", "point", "link_l2"];
        if(level === 3) return ["marker", "starter", "quote", "method", "point", "link_l3"];
        if(level === 4) return ["marker", "starter", "quote", "method", "manual_point", "link_l3"];
        if(level === 5) return ["marker", "starter", "quote", "manual_method", "point", "link_l3"];
        if(level === 6) return ["marker", "manual_starter", "quote", "method", "point", "link_l3"];
        if(level === 7) return ["manual_marker", "starter", "quote", "method", "point", "link_l3"];
        if(level === 8) return ["marker", "starter", "quote", "method", "point", "manual_link"];
        if(level === 9) return ["marker", "starter", "quote", "method", "manual_analysis", "link_l3"];
        return ["marker", "starter", "quote", "method", "manual_effect", "link_l3"];
    },
    getActiveLevels: function() {
        const raw = appData && appData.settings && Array.isArray(appData.settings.activeLevels)
            ? appData.settings.activeLevels
            : [1,2,3];
        const cleaned = raw
            .map(n => parseInt(n, 10))
            .filter(n => n >= 1 && n <= 10);
        return cleaned.length ? Array.from(new Set(cleaned)).sort((a,b)=>a-b) : [1,2,3];
    },
    shuffle: function(arr) {
        const a = arr.slice();
        for(let i = a.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [a[i], a[j]] = [a[j], a[i]];
        }
        return a;
    },
    wordList: function(text) {
        return String(text || "").trim().split(/\s+/).filter(Boolean);
    },
    truncateWithEllipses: function(words, maxWords) {
        if(!Array.isArray(words) || words.length <= maxWords || maxWords <= 0) {
            return words.join(" ");
        }
        const total = words.length;
        const minKeep = Math.min(2, maxWords - 1);
        const targetHead = Math.max(minKeep, Math.ceil(maxWords / 2));
        const isBoundary = (w) => /[.!?;:]$/.test(w || "");

        let headCount = targetHead;
        for(let i = targetHead; i >= minKeep; i--) {
            if(isBoundary(words[i - 1])) { headCount = i; break; }
        }
        headCount = Math.min(headCount, maxWords - 1);

        let tailCount = maxWords - headCount;
        if(tailCount < 1) {
            tailCount = 1;
            headCount = maxWords - 1;
        }

        let tailStart = total - tailCount;
        const tailWindowStart = Math.max(headCount, total - tailCount - 4);
        for(let i = total - 2; i >= tailWindowStart; i--) {
            if(isBoundary(words[i])) {
                const candidateStart = i + 1;
                if(total - candidateStart <= tailCount) {
                    tailStart = candidateStart;
                    tailCount = total - tailStart;
                    break;
                }
            }
        }

        const head = words.slice(0, headCount);
        const tail = words.slice(tailStart);
        return `${head.join(" ")} ... ${tail.join(" ")}`;
    },
    applyLevelRules: function(items, levelRules, overrideLevel) {
        if(!Array.isArray(items) || !levelRules) return items;
        items.forEach(item => {
            const lvl = overrideLevel || (Array.isArray(item.levels) && item.levels.length ? item.levels[0] : 1);
            const rule = levelRules[lvl];
            if(!rule) return;
            const maxWords = parseInt(rule.maxWords, 10) || 0;
            const ellipsesAt = parseInt(rule.ellipsesMaxWords, 10) || 0;
            const words = app.wordList(item.original);
            const total = words.length;
            if(total === 0) return;
            let out = words.join(" ");
            if(maxWords > 0 && total > maxWords) {
                out = app.truncateWithEllipses(words, maxWords);
            } else if(ellipsesAt > 0 && total > ellipsesAt) {
                // No truncation needed, but indicate omission for long quotes
                if(!/(\.\.\.|‚Ä¶)$/.test(out)) out += "...";
            }
            item.original = out;
        });
        return items;
    },
    init: function() {
        window.onerror = function() { document.getElementById('emergency-reset').style.display = 'block'; };

        // CHECK FOR INJECTED STANDALONE DATA
        if (typeof window.STANDALONE_LESSON !== 'undefined') {
            appData = app.repair(window.STANDALONE_LESSON);
            appData.isStandalone = true;
            
            // CLEANUP: If by some miracle HTML remains, kill it
            const btn = document.getElementById('btn-admin'); if(btn) btn.remove();
            const mod = document.getElementById('modal-admin'); if(mod) mod.remove();
            document.querySelectorAll('.modal.open').forEach(m => m.classList.remove('open'));

        } else {
            // NORMAL TEACHER MODE
            const d = localStorage.getItem('tsa_v5_1_data');
            if(d) {
                try { appData = app.repair(JSON.parse(d)); } 
                catch(e) { appData = app.repair(defaultData); }
            } else if (typeof teacherConfig !== "undefined") {
                appData = app.repair(teacherConfig);
            } else {
                appData = app.repair(defaultData);
            }
        }

        if(appData.isStandalone && (!Array.isArray(appData.items) || appData.items.length === 0)) {
            const fallback = app.repair(defaultData);
            appData.items = fallback.items;
            appData.banks = fallback.banks;
            appData.sentenceConfig = fallback.sentenceConfig;
            appData.globalStructure = fallback.globalStructure;
            if(!appData.sourceText) appData.sourceText = fallback.sourceText;
            if(!appData.question) appData.question = fallback.question;
            if(!appData.meta || !appData.meta.title) appData.meta = fallback.meta;
        }

        const s = localStorage.getItem(app.getStateKey());
        if(s) {
            try { userState = JSON.parse(s); } catch(e) { userState = { score: 0, level: 1, essay: "", completed: [], completedLevels: [], filter: "all", showDone: false }; }
        }

        try { ui.init(); } catch(e) { document.getElementById('emergency-reset').style.display = 'block'; }
    },

    repair: function(d) {
        if(!d || typeof d !== 'object') return JSON.parse(JSON.stringify(defaultData));

        const safe = d;
        safe.meta = safe.meta && typeof safe.meta === 'object' ? safe.meta : {};
        safe.meta.title = typeof safe.meta.title === 'string' ? safe.meta.title : defaultData.meta.title;
        safe.meta.author = typeof safe.meta.author === 'string' ? safe.meta.author : defaultData.meta.author;
        safe.meta.version = typeof safe.meta.version === 'string' ? safe.meta.version : defaultData.meta.version;
        safe.sourceText = app.cleanSourceText(typeof safe.sourceText === 'string' ? safe.sourceText : defaultData.sourceText);
        safe.question = typeof safe.question === 'string' ? safe.question : defaultData.question;

        safe.settings = safe.settings && typeof safe.settings === 'object' ? safe.settings : {};
        if(typeof safe.settings.autoProgress !== 'boolean') safe.settings.autoProgress = false;
        if(typeof safe.settings.practiceMode !== 'boolean') safe.settings.practiceMode = false;
        safe.settings.practiceModeLevel = [1,2,3].includes(parseInt(safe.settings.practiceModeLevel, 10))
            ? parseInt(safe.settings.practiceModeLevel, 10)
            : 1;
        if(typeof safe.settings.practiceForceAuto !== 'boolean') safe.settings.practiceForceAuto = false;
        if(typeof safe.settings.practiceFixedTemplate !== 'boolean') safe.settings.practiceFixedTemplate = false;
        safe.settings.worksheetMatchMode = ["aligned","jumbled","list"].includes(safe.settings.worksheetMatchMode)
            ? safe.settings.worksheetMatchMode
            : "jumbled";
        safe.settings.templates = Array.isArray(safe.settings.templates) ? safe.settings.templates : [];
        safe.settings.activeLevels = Array.isArray(safe.settings.activeLevels)
            ? safe.settings.activeLevels.map(n => parseInt(n, 10)).filter(n => n >= 1 && n <= 10)
            : [1,2,3];
        if(!safe.settings.activeLevels.length) safe.settings.activeLevels = [1,2,3];
        if(typeof safe.settings.aiPromptAllLevels !== 'boolean') safe.settings.aiPromptAllLevels = false;
        if(typeof safe.settings.strictMode !== 'boolean') safe.settings.strictMode = false;
        safe.settings.levelRules = safe.settings.levelRules && typeof safe.settings.levelRules === 'object'
            ? safe.settings.levelRules
            : JSON.parse(JSON.stringify(defaultData.settings.levelRules));
        for(let lvl = 1; lvl <= 10; lvl++) {
            const r = safe.settings.levelRules[lvl] || {};
            safe.settings.levelRules[lvl] = {
                maxWords: parseInt(r.maxWords, 10) || (defaultData.settings.levelRules[lvl] ? defaultData.settings.levelRules[lvl].maxWords : defaultData.settings.levelRules[3].maxWords),
                ellipsesMaxWords: parseInt(r.ellipsesMaxWords, 10) || (defaultData.settings.levelRules[lvl] ? defaultData.settings.levelRules[lvl].ellipsesMaxWords : defaultData.settings.levelRules[3].ellipsesMaxWords)
            };
        }

        safe.globalStructure = safe.globalStructure && typeof safe.globalStructure === 'object' ? safe.globalStructure : { enabled: true, items: [] };
        safe.globalStructure.enabled = typeof safe.globalStructure.enabled === 'boolean' ? safe.globalStructure.enabled : true;
        if(safe.globalStructure.question && !safe.globalStructure.items) { 
            safe.globalStructure.items = [{ id:"g_old", question: safe.globalStructure.question, correct: safe.globalStructure.correct, distractors: safe.globalStructure.distractors }];
        }
        if(!Array.isArray(safe.globalStructure.items)) safe.globalStructure.items = [];
        safe.globalStructure.items = safe.globalStructure.items.map((q, idx) => {
            const item = q && typeof q === 'object' ? q : {};
            return {
                id: typeof item.id === 'string' ? item.id : `g${idx + 1}`,
                question: typeof item.question === 'string' ? item.question : 'New Question?',
                correct: typeof item.correct === 'string' ? item.correct : 'Answer',
                distractors: Array.isArray(item.distractors) ? item.distractors.filter(v => typeof v === 'string') : []
            };
        });

        safe.banks = safe.banks && typeof safe.banks === 'object' ? safe.banks : {};
        safe.banks.markers = Array.isArray(safe.banks.markers) ? safe.banks.markers.filter(v => typeof v === 'string') : [];
        safe.banks.starters = Array.isArray(safe.banks.starters) ? safe.banks.starters.filter(v => typeof v === 'string') : [];
        safe.banks.methods = Array.isArray(safe.banks.methods) ? safe.banks.methods.filter(v => typeof v === 'string') : [];
        safe.banks.points = Array.isArray(safe.banks.points) ? safe.banks.points.filter(v => typeof v === 'string') : [];
        safe.banks.links = safe.banks.links && typeof safe.banks.links === 'object' ? safe.banks.links : {};
        for(let lvl = 1; lvl <= 10; lvl++) {
            const key = `l${lvl}`;
            if(Array.isArray(safe.banks.links[key])) {
                safe.banks.links[key] = safe.banks.links[key].filter(v => typeof v === 'string');
            } else if(lvl >= 4 && Array.isArray(safe.banks.links.l3)) {
                safe.banks.links[key] = JSON.parse(JSON.stringify(safe.banks.links.l3));
            } else {
                safe.banks.links[key] = [];
            }
        }

        safe.sentenceConfig = safe.sentenceConfig && typeof safe.sentenceConfig === 'object' ? safe.sentenceConfig : JSON.parse(JSON.stringify(defaultData.sentenceConfig));
        for(let lvl = 1; lvl <= 10; lvl++) {
            const fallback = app.getDefaultSentenceConfig(lvl);
            if(!Array.isArray(safe.sentenceConfig[lvl])) safe.sentenceConfig[lvl] = JSON.parse(JSON.stringify(fallback));
        }

        if(!Array.isArray(safe.items)) safe.items = [];
        safe.items = safe.items.map((i, idx) => {
            const item = i && typeof i === 'object' ? i : {};
            const rawLevels = Array.isArray(item.levels)
                ? item.levels
                : (typeof item.level === 'number' || typeof item.level === 'string')
                    ? [item.level]
                    : (typeof item.levels === 'string' ? item.levels.split(',') : []);
            const levels = Array.isArray(rawLevels)
                ? rawLevels.map(n => parseInt(n, 10)).filter(n => n >= 1 && n <= 10)
                : [1,2,3];
            const original = typeof item.original === 'string' ? item.original
                : (typeof item.quote === 'string' ? item.quote
                : (typeof item.evidence === 'string' ? item.evidence
                : (typeof item.text === 'string' ? item.text : 'New Quote')));
            const translation = typeof item.translation === 'string' ? item.translation
                : (typeof item.meaning === 'string' ? item.meaning
                : (typeof item.simpleMeaning === 'string' ? item.simpleMeaning : 'Meaning'));
            const translationDistractors = Array.isArray(item.translationDistractors)
                ? item.translationDistractors
                : (Array.isArray(item.wrongMeanings) ? item.wrongMeanings
                : (Array.isArray(item.translation_distractors) ? item.translation_distractors : []));
            const effect = typeof item.effect === 'string' ? item.effect
                : (typeof item.analysis === 'string' ? item.analysis
                : (typeof item.interpretation === 'string' ? item.interpretation : ''));
            const effectDistractors = Array.isArray(item.effectDistractors)
                ? item.effectDistractors
                : (Array.isArray(item.wrongAnalyses) ? item.wrongAnalyses
                : (Array.isArray(item.effect_distractors) ? item.effect_distractors : []));
            const type = ['tone','structure','language'].includes(item.type)
                ? item.type
                : (['tone','structure','language'].includes(item.category) ? item.category : 'tone');
            return {
                id: typeof item.id === 'string' ? item.id : `q${idx + 1}`,
                original: original,
                translation: translation,
                translationDistractors: translationDistractors.filter(v => typeof v === 'string'),
                type: type,
                effect: effect,
                effectDistractors: effectDistractors.filter(v => typeof v === 'string'),
                levels: levels.length ? levels : [1,2,3],
                includeInWorksheet: typeof item.includeInWorksheet === 'boolean' ? item.includeInWorksheet : true
            };
        });

        if(safe.settings && safe.settings.levelRules) {
            if(safe.settings.practiceMode) {
                app.applyLevelRules(safe.items, safe.settings.levelRules, safe.settings.practiceModeLevel);
            } else {
                app.applyLevelRules(safe.items, safe.settings.levelRules);
            }
        }

        return safe;
    },

    save: function() {
        if(!appData.isStandalone) {
            localStorage.setItem('tsa_v5_1_data', JSON.stringify(appData));
        }
        localStorage.setItem(app.getStateKey(), JSON.stringify(userState));
        document.getElementById('save-status').style.opacity = 1;
        setTimeout(()=>document.getElementById('save-status').style.opacity=0, 800);
        ui.renderLab();
    },

    updateEssay: function(text) {
        userState.essay = text;
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(() => { app.save(); }, 1000);
    },

    resetSession: function() {
        if(confirm("Reset progress?")) {
            userState = { score: 0, level: 1, essay: "", completed: [], completedLevels: [], filter: "all", showDone: false };
            app.save(); location.reload();
        }
    },

    factoryReset: function() {
        if(confirm("Delete ALL data?")) { localStorage.clear(); location.reload(); }
    },

    setLevel: function(l) {
        const target = parseInt(l, 10);
        const levels = app.getActiveLevels();
        userState.level = levels.includes(target) ? target : levels[0];
        app.save();
        const levelBadge = document.getElementById("level-display");
        if(levelBadge) levelBadge.innerText = "Lvl " + userState.level;
        document.getElementById("sentence-builder").innerHTML = '<div style="text-align:center; opacity:0.6; padding:20px;">Level Changed. Select quote.</div>';
    },

    setFilter: function(f) { userState.filter = f; ui.renderLab(); },
    toggleDone: function() { userState.showDone = !userState.showDone; document.getElementById('btn-show-done').classList.toggle('active', userState.showDone); ui.renderLab(); },

    selectQuote: function(id) {
        const item = appData.items.find(i=>i.id===id);
        if(item) ui.startWizard(item);
    },

    commitSentence: function() {
        const txt = document.getElementById("preview-box").innerText.trim();
        if(!txt) return alert("Empty sentence.");
        const wrong = ui.getIncorrectSelections();
        if(wrong.length) {
            if(appData.settings && appData.settings.strictMode) {
                alert("Some choices may not fit the quote. Try again.");
                return;
            }
            if(!confirm("Some choices may not fit the quote. Continue anyway?")) return;
        }
        
        document.getElementById("essay-area").value += (document.getElementById("essay-area").value ? "\n\n" : "") + txt;
        userState.essay = document.getElementById("essay-area").value;

        if(ui.activeQuoteId && !userState.completed.includes(ui.activeQuoteId)) {
            userState.completed.push(ui.activeQuoteId);
        }
        
        app.save();
        app.checkLevelCompletion();
        ui.switchView('lab'); 
        ui.renderLab(); 
    },

    checkLevelCompletion: function() {
        if(appData.settings && appData.settings.practiceMode) return;
        const levelItems = appData.items
            .filter(i => i.levels.includes(userState.level))
            .filter(i => {
                if(!ui._seenQuoteKeys) ui._seenQuoteKeys = new Set();
                const key = `${i.original}|${i.translation}|${i.type}|${i.effect}`;
                if(ui._seenQuoteKeys.has(key)) return false;
                ui._seenQuoteKeys.add(key);
                return true;
            });
        if(levelItems.length === 0) return;

        const allDone = levelItems.every(i => userState.completed.includes(i.id));

        if(allDone) {
            if(!userState.completedLevels.includes(userState.level)) {
                userState.completedLevels.push(userState.level);
            }
            const levels = app.getActiveLevels();
            const maxLevel = Math.max(...levels);
            if(userState.level < maxLevel) {
                ui.showCelebration(appData.settings && appData.settings.autoProgress);
            } else {
                ui.showCelebration(false, true); 
            }
            app.save();
        }
    },

    undo: function() {
        let v = document.getElementById("essay-area").value;
        let p = v.split("\n\n"); p.pop();
        let newVal = p.join("\n\n");
        document.getElementById("essay-area").value = newVal;
        userState.essay = newVal;
        app.save();
    },

    clearEssay: function() { 
        if(confirm("Clear essay?")) { 
            document.getElementById("essay-area").value = ""; 
            userState.essay = "";
            app.save(); 
        } 
    },

    restartCourse: function() {
        if(confirm("Play again from Level 1?")) {
            userState = { score: 0, level: 1, essay: "", completed: [], completedLevels: [], filter: "all", showDone: false };
            app.save(); location.reload();
        }
    },
    
    exportDoc: function() {
        const text = document.getElementById("essay-area").value || "";
        const html = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>Answer</title>
        <style>body{font-family:'Aptos','Calibri',sans-serif;} p{margin:0 0 10px 0;}</style>
        </head><body><p>${text.replace(/\n/g, '</p><p>')}</p></body></html>`;
        const b = new Blob(['\ufeff'+html], {type:'application/msword'});
        const a = document.createElement("a"); a.href=URL.createObjectURL(b); a.download="Answer.doc"; a.click();
    },

    playSound: function(type) {
        if(window.AudioContext) {
            const ctx = new window.AudioContext();
            const now = ctx.currentTime;
            
            if (type === 'celebrate') {
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'triangle';
                    const start = now + (i * 0.15);
                    const dur = i === 3 ? 0.8 : 0.1; 
                    gain.gain.setValueAtTime(0.1, start);
                    gain.gain.exponentialRampToValueAtTime(0.001, start + dur);
                    osc.start(start);
                    osc.stop(start + dur);
                });
            } else if (type === 'final') {
                [392.00, 523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const osc = ctx.createOscillator();
                    const gain = ctx.createGain();
                    osc.connect(gain); gain.connect(ctx.destination);
                    osc.frequency.value = freq;
                    osc.type = 'sine';
                    const start = now + (i * 0.18);
                    const dur = i === 4 ? 0.9 : 0.12; 
                    gain.gain.setValueAtTime(0.12, start);
                    gain.gain.exponentialRampToValueAtTime(0.001, start + dur);
                    osc.start(start);
                    osc.stop(start + dur);
                });
            } else {
                const osc = ctx.createOscillator();
                const g = ctx.createGain();
                osc.connect(g); g.connect(ctx.destination);
                osc.frequency.value = 600;
                g.gain.value = 0.1;
                osc.start(); osc.stop(now + 0.1);
            }
        }
    }
};

/* --- UI --- */
const ui = {
    activeQuoteId: null,

    init: function() {
        const aiInputEl = document.getElementById("ai-input");
        const fallbackText = aiInputEl && aiInputEl.value && aiInputEl.value.trim()
            ? aiInputEl.value.trim()
            : "";
        const sourceText = app.cleanSourceText((appData.sourceText && appData.sourceText.trim()) ? appData.sourceText : fallbackText);
        document.getElementById("lbl-title").innerText = appData.meta.title;
        document.getElementById("source-content").innerText = sourceText || "Source text not provided.";
        const levelSelect = document.getElementById("level-selector");
        if(levelSelect) {
            const levels = app.getActiveLevels();
            levelSelect.innerHTML = levels.map(n => `<option value="${n}">Lvl ${n}</option>`).join("");
        }
        const inline = document.getElementById("source-inline");
        if(inline) {
            inline.innerText = sourceText || "Source text not provided.";
        }
        const introText = document.getElementById("intro-text");
        if(introText) {
            introText.innerText = sourceText || "Source text not provided.";
        }
        document.getElementById("score-display").innerText = userState.score + " XP";
        const levelBadge = document.getElementById("level-display");
        if(levelBadge) levelBadge.innerText = "Lvl " + userState.level;
        document.getElementById("essay-area").value = userState.essay;
        const activeLevels = app.getActiveLevels();
        if(!activeLevels.includes(userState.level)) userState.level = activeLevels[0];
        if(levelSelect) levelSelect.value = userState.level;
        ui.loadTheme();

        if(appData.settings && appData.settings.practiceMode) {
            const lvl = appData.settings.practiceModeLevel || 1;
            userState.level = lvl;
            userState.showDone = true;
            const sel = document.getElementById("level-selector");
            if(sel) { sel.value = lvl; sel.disabled = true; sel.title = "Practice mode locks the selected level"; }
        }
        
        // --- FORCE LAB VIEW ON START ---
        ui.switchView('lab'); 
        
        ui.renderLab();

        document.querySelectorAll(".modal").forEach(modal => {
            if(modal.dataset.backdropBound) return;
            modal.dataset.backdropBound = "true";
            modal.addEventListener("click", (e) => {
                if(e.target === modal) ui.closeModal(modal.id);
            });
        });
        
        ui.showSplash();
        
        // Only sync admin UI if we are in Teacher Mode AND the element exists
        // This is the check that prevents freezing!
        if(!appData.isStandalone && document.getElementById('modal-admin')) {
            admin.syncUI();
        }
    },

    // THEME
    setTheme: function(key, val) { document.documentElement.style.setProperty('--'+key, val); localStorage.setItem('tsa_theme_'+key, val); },
    loadTheme: function() {
        const bg = localStorage.getItem('tsa_theme_bg');
        const text = localStorage.getItem('tsa_theme_text');
        const card = localStorage.getItem('tsa_theme_card');
        if(bg) document.documentElement.style.setProperty('--bg', bg);
        if(text) document.documentElement.style.setProperty('--text', text);
        if(card) document.documentElement.style.setProperty('--card', card);
    },
    resetTheme: function() { 
        localStorage.removeItem('tsa_theme_bg'); 
        localStorage.removeItem('tsa_theme_text'); 
        localStorage.removeItem('tsa_theme_card'); 
        location.reload(); 
    },

    renderLab: function() {
        const g = document.getElementById("quote-grid"); g.innerHTML = "";
        ui._seenQuoteKeys = new Set();
        
        if(!appData.items || appData.items.length === 0) {
            g.innerHTML = `
                <div class="card" style="cursor:default;">
                    <div style="font-weight:800; font-size:1.1rem; margin-bottom:6px;">No lesson data</div>
                    <div style="opacity:0.8;">This file doesn't contain any quotes yet.</div>
                </div>
            `;
            document.getElementById("global-card-container").innerHTML = "";
            return;
        }
        
        const practiceMode = appData.settings && appData.settings.practiceMode;
        const effectiveLevel = practiceMode ? (appData.settings.practiceModeLevel || 1) : userState.level;

        // If current level has no items, jump to first available level
        if(!practiceMode) {
            const availableLevels = app.getActiveLevels().filter(lvl => appData.items.some(i => i.levels.includes(lvl)));
            if(availableLevels.length && !availableLevels.includes(userState.level)) {
                userState.level = availableLevels[0];
                const sel = document.getElementById("level-selector");
                if(sel) sel.value = userState.level;
            }
        }

        const levelItems = appData.items.filter(i => practiceMode ? true : i.levels.includes(userState.level));
        const levelDone = levelItems.length > 0 && levelItems.every(i => userState.completed.includes(i.id));
        const maxLevel = Math.max(...app.getActiveLevels());
        if(!practiceMode && userState.level === maxLevel && levelDone) {
            const essayPreview = (userState.essay || "").trim().replace(/\n/g, "<br>");
            g.innerHTML = `
                <div class="card" style="cursor:default;">
                    <div style="font-weight:800; font-size:1.1rem; margin-bottom:6px;">üèÅ Course Complete</div>
                    <div style="opacity:0.8; margin-bottom:10px;">You have finished all Level 3 quotes. Great work!</div>
                    <div style="border:1px solid var(--border); border-radius:6px; padding:8px; background:var(--bg); max-height:140px; overflow:auto; margin-bottom:10px;">
                        ${essayPreview ? essayPreview : "<span style='opacity:0.6;'>No essay text yet.</span>"}
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:8px;">
                        <button class="btn btn-outline" onclick="ui.switchView('desk')">Review Answer</button>
                        <button class="btn btn-doc" onclick="app.exportDoc()">Download Answer</button>
                    </div>
                    <button class="btn btn-outline" onclick="window.print()">Print</button>
                    <button class="btn btn-primary" onclick="app.restartCourse()">Play Again</button>
                </div>
            `;
            return;
        }
        let items = levelItems.filter(i => {
            const isType = (userState.filter==="all" || i.type===userState.filter);
            const isDone = userState.completed.includes(i.id);
            if(isDone && !userState.showDone) return false;
            return isType;
        });

        // If nothing shows but level has items, relax filters
        if(items.length === 0 && levelItems.length > 0) {
            if(userState.filter !== "all") userState.filter = "all";
            if(!userState.showDone) userState.showDone = true;
            items = levelItems.filter(i => true);
        }
        
        items.forEach(i => {
            const div = document.createElement("div");
            div.className = `card card-${i.type}`;
            if(userState.completed.includes(i.id)) div.style.opacity = "0.5";
            div.innerHTML = `<span class="quote-text">"${i.original}"</span><div class="card-meta"><span>${i.type}</span><span>${userState.completed.includes(i.id)?'‚úÖ':''}</span></div>`;
            div.onclick = () => app.selectQuote(i.id);
            g.appendChild(div);
        });

        const gs = document.getElementById("global-card-container");
        if(appData.globalStructure.enabled && appData.globalStructure.items.length > 0) {
            gs.innerHTML = "";
            appData.globalStructure.items.forEach(q => {
                const div = document.createElement("div");
                div.className = "card card-global";
                div.innerHTML = `<strong>üèóÔ∏è Structure</strong><br><small>${q.question}</small>`;
                div.onclick = () => ui.runGlobal(q);
                gs.appendChild(div);
            });
        } else { gs.innerHTML = ""; }
        
        document.querySelectorAll(".filter-btn").forEach(b => b.classList.toggle("active", b.dataset.filter === userState.filter));
    },

    switchView: function(v) {
        document.querySelectorAll(".hub").forEach(e=>e.classList.remove("active"));
        document.querySelectorAll(".nav-item").forEach(e=>e.classList.remove("active"));
        document.getElementById("view-"+v).classList.add("active");
        document.getElementById("nav-"+v).classList.add("active");
    },

    openModal: (id) => document.getElementById(id).classList.add("open"),
    closeModal: (id) => {
        document.getElementById(id).classList.remove("open");
        if(id === 'modal-admin' && !appData.isStandalone) {
            ui.renderLab();
            if(ui.activeQuoteId) {
                const item = appData.items.find(i=>i.id===ui.activeQuoteId);
                if(item) ui.runBuilder(item); 
            }
        }
    },
    
    openAdmin: () => {
        admin.renderAll(); 
        if(localStorage.getItem('tsa_unlocked')==='true') { ui.openModal("modal-admin"); }
        else if(prompt("Password (1234)")==="1234") { ui.openModal("modal-admin"); }
    },
    openSourceText: () => ui.openModal("modal-source"),

    startWizard: function(item) {
        const opts = [item.translation, ...item.translationDistractors||[]].sort(()=>Math.random()-0.5);
        ui.openModal("modal-wizard");
        document.getElementById("wizard-title").innerText = "Phase 1: Meaning";
        document.getElementById("wizard-prompt").innerHTML = `<p class="quote-text">"${item.original}"</p><p>What does this mean?</p>`;
        const grid = document.getElementById("wizard-options"); grid.innerHTML = "";
        opts.forEach(o => {
            const b = document.createElement("button"); b.className = "btn btn-outline"; b.textContent = o;
            b.onclick = () => {
                if(o === item.translation) {
                    b.style.background = "var(--success)"; b.style.color="white"; app.playSound('correct');
                    setTimeout(() => {
                        const hasAnalysis = item.effect || (item.effectDistractors && item.effectDistractors.length);
                        if(hasAnalysis) {
                            ui.runAnalysisStep(item);
                        } else {
                            ui.closeModal("modal-wizard");
                            ui.runBuilder(item);
                        }
                    }, 500);
                } else { b.classList.add('shake'); b.style.background = "var(--error)"; b.style.color="white"; }
            };
            grid.appendChild(b);
        });
    },

    runAnalysisStep: function(item) {
        const opts = [item.effect, ...item.effectDistractors||[]].filter(Boolean).sort(()=>Math.random()-0.5);
        document.getElementById("wizard-title").innerText = "Phase 2: Analysis";
        document.getElementById("wizard-prompt").innerHTML = `<p class="quote-text">"${item.original}"</p><p>Which analysis is most accurate?</p>`;
        const grid = document.getElementById("wizard-options"); grid.innerHTML = "";
        opts.forEach(o => {
            const b = document.createElement("button"); b.className = "btn btn-outline"; b.textContent = o;
            b.onclick = () => {
                if(o === item.effect) {
                    b.style.background = "var(--success)"; b.style.color="white"; app.playSound('correct');
                    setTimeout(() => {
                        ui.closeModal("modal-wizard");
                        ui.runBuilder(item);
                    }, 500);
                } else { b.classList.add('shake'); b.style.background = "var(--error)"; b.style.color="white"; }
            };
            grid.appendChild(b);
        });
    },

    runBuilder: function(item) {
        ui.activeQuoteId = item.id;
        ui.switchView("desk");
        const cont = document.getElementById("sentence-builder"); cont.innerHTML = "";
        const level = (appData.settings && appData.settings.practiceMode)
            ? (appData.settings.practiceModeLevel || 1)
            : userState.level;
        let cfg = appData.sentenceConfig[level] || appData.sentenceConfig[3] || [];
        if(appData.settings && appData.settings.practiceMode && appData.settings.practiceFixedTemplate) {
            cfg = app.getPracticeTemplate(level);
        }
        if(appData.settings && appData.settings.practiceMode && appData.settings.practiceForceAuto) {
            const linkSlot = `link_l${level}`;
            const mapSlot = (slot) => {
                if(!slot || !slot.startsWith("manual")) return slot;
                const tail = slot.split("_")[1] || "";
                if(tail === "marker") return "marker";
                if(tail === "starter") return "starter";
                if(tail === "method") return "method";
                if(tail === "link") return linkSlot;
                return "point";
            };
            cfg = cfg.map(mapSlot);
        }
        
        cfg.forEach(slot => {
            const row = document.createElement("div"); row.className = "slot-row";
            if(slot === "quote") {
                row.innerHTML = `<span class="slot-label">EVIDENCE</span><div class="slot-static" data-v='"${item.original}"'>"${item.original}"</div>`;
            } else if(slot.startsWith("manual")) {
                let lbl = slot.split('_')[1] || "Text";
                row.innerHTML = `<span class="slot-label">${lbl.toUpperCase()} (Idea)</span><input class="slot-input" oninput="ui.updPrev()">`;
            } else {
                let key = slot.includes("link") ? (slot.split('_')[1]||'l1') : slot+"s";
                if(slot==='point' || slot === "analysis") key='points';

                const perQuoteList = (() => {
                    if(slot === "point" || slot === "analysis") {
                        if(item.effect || (item.effectDistractors && item.effectDistractors.length)) {
                            return [item.effect, ...(item.effectDistractors || [])].filter(Boolean);
                        }
                    }
                    if(slot === "starter") {
                        const base = Array.isArray(item.starters) ? item.starters : (item.starter ? [item.starter] : null);
                        if(base) return [...base, ...(item.starterDistractors || [])].filter(Boolean);
                    }
                    if(slot === "marker") {
                        const base = Array.isArray(item.markers) ? item.markers : (item.marker ? [item.marker] : null);
                        if(base) return [...base, ...(item.markerDistractors || [])].filter(Boolean);
                    }
                    if(slot === "method") {
                        const base = Array.isArray(item.methods) ? item.methods : (item.method ? [item.method] : null);
                        if(base) return [...base, ...(item.methodDistractors || [])].filter(Boolean);
                    }
                    return null;
                })();

                let list = null;
                let correct = null;
                if(perQuoteList) {
                    list = perQuoteList;
                    if(slot === "point" || slot === "analysis") correct = item.effect;
                    if(slot === "starter") correct = item.starter || (Array.isArray(item.starters) ? item.starters[0] : null);
                    if(slot === "marker") correct = item.marker || (Array.isArray(item.markers) ? item.markers[0] : null);
                    if(slot === "method") correct = item.method || (Array.isArray(item.methods) ? item.methods[0] : null);
                }
                else if(slot.includes("link")) {
                    list = appData.banks.links[key];
                    if(!list || !list.length) list = appData.banks.links.l3;
                } else {
                    list = appData.banks[key];
                }
                if(list) {
                    const options = correct ? app.shuffle(list) : list;
                    row.innerHTML = `<span class="slot-label">${slot.toUpperCase()}</span><select class="slot-select" onchange="ui.updPrev()"><option value="">Select...</option>${options.map(o=>`<option>${o}</option>`).join('')}</select>`;
                    if(correct) {
                        const sel = row.querySelector("select");
                        sel.dataset.correct = correct;
                        sel.dataset.hint = "Does that make sense? What word would work better here?";
                    }
                }
            }
            cont.appendChild(row);
        });
        ui.updPrev();
        
        if(!userState.completed.includes(item.id)) { 
            userState.score+=10; document.getElementById("score-display").innerText = userState.score + " XP";
        }
    },

    updPrev: function() {
        let txt = [];
        document.querySelectorAll("#sentence-builder select, #sentence-builder input, #sentence-builder .slot-static").forEach(el => {
            let v = el.tagName==="DIV"? el.dataset.v : el.value;
            if(v && v.trim()) txt.push(v);
        });
        document.getElementById("preview-box").innerText = txt.join(" ") + ".";
        ui.updateHintPanel();
    },
    updateHintPanel: function() {
        const hint = document.getElementById("hint-panel");
        if(!hint) return;
        const wrong = ui.getIncorrectSelections();
        if(!wrong.length) {
            hint.classList.add("hidden");
            return;
        }
        const el = wrong[0];
        const count = parseInt(el.dataset.wrong || "0", 10);
        const correct = el.dataset.correct || "";
        const messages = [
            "Does that make sense?",
            "Try a different option. Think about meaning and tone.",
            correct ? `Hint: The best fit is "${correct}".` : "Try a different option."
        ];
        hint.textContent = messages[Math.min(count, messages.length - 1)];
        hint.classList.remove("hidden");
    },
    getIncorrectSelections: function() {
        const wrong = [];
        document.querySelectorAll("#sentence-builder select[data-correct]").forEach(sel => {
            if(!sel.dataset.lastValue) sel.dataset.lastValue = sel.value || "";
            const isCorrect = sel.value && sel.value === sel.dataset.correct;
            if(isCorrect) {
                sel.dataset.wrong = "0";
            } else if(sel.value) {
                if(sel.dataset.lastValue !== sel.value) {
                    const next = parseInt(sel.dataset.wrong || "0", 10) + 1;
                    sel.dataset.wrong = String(next);
                }
            }
            sel.dataset.lastValue = sel.value || "";
            if(sel.value && sel.value !== sel.dataset.correct) wrong.push(sel);
        });
        return wrong;
    },

    runGlobal: function(q) {
        ui.openModal("modal-wizard");
        document.getElementById("wizard-title").innerText = "Structure Analysis";
        document.getElementById("wizard-prompt").innerHTML = `<p>${q.question}</p>`;
        const opts = [q.correct, ...q.distractors].sort(()=>Math.random()-0.5);
        const grid = document.getElementById("wizard-options"); grid.innerHTML = "";
        opts.forEach(o => {
            const b = document.createElement("button"); b.className = "btn btn-outline"; b.textContent = o;
            b.onclick = () => {
                if(o === q.correct) {
                    b.style.background = "var(--success)"; b.style.color="white"; userState.score+=20; app.save(); ui.init(); app.playSound('correct');
                    setTimeout(()=>ui.closeModal("modal-wizard"), 800);
                } else { b.classList.add('shake'); b.style.background = "var(--error)"; b.style.color="white"; }
            };
            grid.appendChild(b);
        });
    },

    showCelebration: function(autoAdvance, isFinal) {
        const overlay = document.getElementById('celebration-overlay');
        const title = document.getElementById('celebration-title');
        const sub = document.getElementById('celebration-sub');
        const btn = document.getElementById('celebration-btn');

        overlay.classList.remove('hidden');
        app.playSound(isFinal ? 'final' : 'celebrate');

        if (isFinal) {
            title.innerText = "Course Complete! üèÜ";
            sub.innerText = "Well done! Check your answer and print, save or send to your teacher.";
            btn.innerText = "Review Work";
            btn.style.display = 'block';
            btn.onclick = ui.closeCelebration;
        } else {
            title.innerText = `Level ${userState.level} Complete! üéâ`;
            sub.innerText = "Great work! Moving up...";
            if (autoAdvance) {
                btn.style.display = 'none';
                setTimeout(() => {
                    ui.closeCelebration();
                    app.setLevel(userState.level + 1);
                }, 3000);
            } else {
                btn.innerText = "Continue";
                btn.style.display = 'block';
                btn.onclick = () => {
                    ui.closeCelebration();
                    app.setLevel(userState.level + 1);
                    ui.switchView('lab');
                };
            }
        }
    },

    closeCelebration: function() {
        document.getElementById("celebration-overlay").classList.add("hidden");
    },

    showSplash: function() {
        const splash = document.getElementById("splash-screen");
        if(!splash || splash.dataset.shown) return;
        splash.dataset.shown = "true";
        splash.classList.remove("hidden");
        setTimeout(() => {
            app.playSound("celebrate");
        }, 600);

        const intro = document.getElementById("intro-text-screen");
        const pick = document.getElementById("pick-quote-screen");

        setTimeout(() => {
            splash.classList.add("hidden");
            if(intro) intro.classList.remove("hidden");
        }, 3500);

        setTimeout(() => {
            if(intro) intro.classList.add("hidden");
            if(pick) pick.classList.remove("hidden");
        }, 6500);

        setTimeout(() => {
            if(pick) pick.classList.add("hidden");
        }, 8000);
    }
};

/* --- ADMIN --- */
const admin = {
    aiAutoBound: false,
    renderAll: function() {
        admin.syncUI();
        admin.bindAiAutoPrompt();
        admin.ensureAiStepVisible();
        admin.refreshTemplateList();
        admin.renderQuoteList();
        admin.renderGlobalList();
        const lvl = typeof currentConfigLevel === 'number' ? currentConfigLevel : 1;
        admin.renderConfig(lvl);
    },
    syncUI: function() {
        document.getElementById("keep-unlocked").checked = localStorage.getItem("tsa_unlocked") === "true";
        document.getElementById("auto-progress").checked = appData.settings.autoProgress;
        document.getElementById("practice-mode").checked = !!appData.settings.practiceMode;
        const pl = document.getElementById("practice-level");
        if(pl) pl.value = appData.settings.practiceModeLevel || 1;
        const pfa = document.getElementById("practice-force-auto");
        if(pfa) pfa.checked = !!appData.settings.practiceForceAuto;
        const pft = document.getElementById("practice-fixed-template");
        if(pft) pft.checked = !!appData.settings.practiceFixedTemplate;
        const wmm = document.getElementById("worksheet-match-mode");
        if(wmm) wmm.value = appData.settings.worksheetMatchMode || "jumbled";
        const allLevels = document.getElementById("ai-all-levels");
        if(allLevels) allLevels.checked = !!appData.settings.aiPromptAllLevels;
        const strict = document.getElementById("strict-mode");
        if(strict) strict.checked = !!appData.settings.strictMode;
        const activeWrap = document.getElementById("active-levels");
        if(activeWrap) {
            const active = new Set(app.getActiveLevels());
            activeWrap.innerHTML = "";
            for(let i = 1; i <= 10; i++) {
                const lbl = document.createElement("label");
                lbl.style.display = "flex";
                lbl.style.alignItems = "center";
                lbl.style.gap = "4px";
                lbl.style.fontSize = "0.85rem";
                lbl.innerHTML = `<input type="checkbox" ${active.has(i) ? "checked" : ""} data-level="${i}"> L${i}`;
                const cb = lbl.querySelector("input");
                cb.addEventListener("change", admin.updateActiveLevels);
                activeWrap.appendChild(lbl);
            }
        }
        document.getElementById("gs-enabled").checked = appData.globalStructure.enabled;

        const step2 = document.getElementById("ai-step2");
        const jsonIn = document.getElementById("ai-json-in");
        const keepOpen = localStorage.getItem("tsa_ai_step2") === "true";
        if(step2 && (keepOpen || (jsonIn && jsonIn.value && jsonIn.value.trim()))) {
            step2.classList.remove("hidden");
        }
    },
    setUnlocked: (c) => localStorage.setItem("tsa_unlocked", c),
    setAutoProgress: (c) => { 
        if(!appData.settings) appData.settings = {};
        appData.settings.autoProgress = c; 
        app.save(); 
    },
    setPracticeMode: (c) => {
        if(!appData.settings) appData.settings = {};
        appData.settings.practiceMode = c;
        app.save();
        ui.init();
        admin.syncUI();
    },
    setPracticeLevel: (v) => {
        if(!appData.settings) appData.settings = {};
        const lvl = parseInt(v, 10);
        appData.settings.practiceModeLevel = [1,2,3].includes(lvl) ? lvl : 1;
        app.save();
        if(appData.settings.practiceMode) { ui.init(); admin.syncUI(); }
    },
    setPracticeForceAuto: (c) => {
        if(!appData.settings) appData.settings = {};
        appData.settings.practiceForceAuto = c;
        app.save();
        if(appData.settings.practiceMode) { ui.init(); admin.syncUI(); }
    },
    setPracticeFixedTemplate: (c) => {
        if(!appData.settings) appData.settings = {};
        appData.settings.practiceFixedTemplate = c;
        app.save();
        if(appData.settings.practiceMode) { ui.init(); admin.syncUI(); }
    },
    setStrictMode: (c) => {
        if(!appData.settings) appData.settings = {};
        appData.settings.strictMode = c;
        app.save();
    },
    setAiAllLevels: (c) => {
        if(!appData.settings) appData.settings = {};
        appData.settings.aiPromptAllLevels = c;
        app.save();
    },
    updateActiveLevels: () => {
        const activeWrap = document.getElementById("active-levels");
        if(!activeWrap) return;
        const selected = Array.from(activeWrap.querySelectorAll("input[type='checkbox']"))
            .filter(cb => cb.checked)
            .map(cb => parseInt(cb.dataset.level, 10))
            .filter(n => n >= 1 && n <= 10);
        if(!selected.length) return;
        if(!appData.settings) appData.settings = {};
        appData.settings.activeLevels = selected;
        app.save();
        ui.init();
        admin.syncUI();
    },
    setWorksheetMatchMode: (v) => {
        if(!appData.settings) appData.settings = {};
        appData.settings.worksheetMatchMode = ["aligned","jumbled","list"].includes(v) ? v : "jumbled";
        app.save();
    },
    toggleGlobal: (c) => { appData.globalStructure.enabled = c; app.save(); ui.renderLab(); },

    // QUOTE LIST
    renderQuoteList: function() {
        const c = document.getElementById("quote-editor-list"); c.innerHTML = "";
        appData.items.forEach((item, idx) => {
            const div = document.createElement("div"); div.className = "quote-editor";
            div.innerHTML = `
                <div class="editor-header">#${idx+1} <button class="btn btn-danger btn-small" onclick="admin.delQuote(${idx})">Del</button></div>
                <div class="input-group"><label>Quote</label><input value="${item.original}" onchange="admin.updQuote(${idx},'original',this.value)"></div>
                <div class="input-group"><label>Translation</label><input value="${item.translation}" onchange="admin.updQuote(${idx},'translation',this.value)"></div>
                <div class="input-group"><label>Translation Distractors (CSV)</label><input value="${(item.translationDistractors||[]).join(',')}" onchange="admin.updQuote(${idx},'translationDistractors',this.value.split(','))"></div>
                <div class="input-group"><label>Analysis (Effect)</label><input value="${item.effect || ''}" onchange="admin.updQuote(${idx},'effect',this.value)"></div>
                <div class="input-group"><label>Analysis Distractors (CSV)</label><input value="${(item.effectDistractors||[]).join(',')}" onchange="admin.updQuote(${idx},'effectDistractors',this.value.split(','))"></div>
                <div class="level-checks">
                    <label>Worksheet: <input type="checkbox" ${item.includeInWorksheet?'checked':''} onchange="admin.updQuote(${idx},'includeInWorksheet',this.checked)"></label>
                    | Lvl:
                    ${Array.from({length:10},(_,i)=>`<label>${i+1}<input type="checkbox" ${item.levels.includes(i+1)?'checked':''} onchange="admin.togLvl(${idx},${i+1})"></label>`).join('')}
                </div>
            `;
            c.appendChild(div);
        });
    },
    updQuote: (idx, k, v) => { appData.items[idx][k] = v; app.save(); },
    togLvl: (idx, l) => { 
        const i = appData.items[idx]; 
        if(i.levels.includes(l)) i.levels = i.levels.filter(x=>x!==l); else i.levels.push(l);
        app.save();
    },
    delQuote: (idx) => { appData.items.splice(idx, 1); app.save(); admin.renderQuoteList(); },
    addQuote: () => { 
        appData.items.push({ id:"q"+Date.now(), original:"New Quote", translation:"Meaning", translationDistractors:["Wrong"], effect:"Analysis", effectDistractors:["Wrong analysis"], type:"tone", levels:[1,2,3], includeInWorksheet:true }); 
        app.save(); admin.renderQuoteList();
    },

    // GLOBAL STRUCTURE LIST
    renderGlobalList: function() {
        const c = document.getElementById("global-editor-list"); c.innerHTML = "";
        appData.globalStructure.items.forEach((item, idx) => {
            const div = document.createElement("div"); div.className = "struct-editor";
            div.innerHTML = `
                <div class="editor-header">Q${idx+1} <button class="btn btn-danger btn-small" onclick="admin.delGlobal(${idx})">Del</button></div>
                <div class="input-group"><label>Question</label><input value="${item.question}" onchange="admin.updGlobal(${idx},'question',this.value)"></div>
                <div class="input-group"><label>Correct</label><input value="${item.correct}" onchange="admin.updGlobal(${idx},'correct',this.value)"></div>
                <div class="input-group"><label>Distractors (CSV)</label><input value="${(item.distractors||[]).join(',')}" onchange="admin.updGlobal(${idx},'distractors',this.value.split(','))"></div>
            `;
            c.appendChild(div);
        });
    },
    updGlobal: (idx, k, v) => { appData.globalStructure.items[idx][k] = v; app.save(); },
    delGlobal: (idx) => { appData.globalStructure.items.splice(idx, 1); app.save(); admin.renderGlobalList(); },
    addGlobalQuestion: () => {
        appData.globalStructure.items.push({ id:"g"+Date.now(), question:"New Question?", correct:"Answer", distractors:["Wrong"] });
        app.save(); admin.renderGlobalList();
    },

    // AI
    bindAiAutoPrompt: () => {
        if(admin.aiAutoBound) return;
        const ids = [
            "ai-question","ai-input","ai-mode","ai-count",
            "ai-level-1","ai-level-2","ai-level-3",
            "ai-l1-count","ai-l1-words","ai-l1-complex","ai-l1-subtle","ai-l1-ellipsis",
            "ai-l2-count","ai-l2-words","ai-l2-complex","ai-l2-subtle","ai-l2-ellipsis",
            "ai-l3-count","ai-l3-words","ai-l3-complex","ai-l3-subtle","ai-l3-ellipsis"
        ];
        const handler = () => {
            const txt = document.getElementById("ai-input").value;
            if(txt && txt.trim()) {
                if(!appData.sourceText || appData.sourceText.trim() !== txt.trim()) {
                    appData.sourceText = txt.trim();
                    app.save();
                    ui.init();
                }
                admin.generatePrompt(true);
            }
        };
        ids.forEach(id => {
            const el = document.getElementById(id);
            if(!el) return;
            el.addEventListener("input", handler);
            el.addEventListener("change", handler);
        });
        admin.aiAutoBound = true;
    },
    useSourceText: () => {
        const txt = document.getElementById("ai-input").value || "";
        const cleaned = app.cleanSourceText(txt);
        if(!cleaned) return alert("Paste source text first.");
        appData.sourceText = cleaned;
        app.save();
        ui.init();
    },
    toggleAiPanel: () => {
        const step2 = document.getElementById("ai-step2");
        if(!step2) return;
        const isHidden = step2.classList.contains("hidden");
        step2.classList.toggle("hidden", !isHidden);
        localStorage.setItem("tsa_ai_step2", isHidden ? "true" : "false");
    },
    ensureAiStepVisible: () => {
        const step2 = document.getElementById("ai-step2");
        if(!step2) return;
        const promptOut = document.getElementById("ai-prompt-out");
        const jsonIn = document.getElementById("ai-json-in");
        const hasPrompt = promptOut && promptOut.value && promptOut.value.trim();
        const hasJson = jsonIn && jsonIn.value && jsonIn.value.trim();
        if(hasPrompt || hasJson) step2.classList.remove("hidden");
    },
    getAiSettings: () => {
        const getLevel = (lvl) => ({
            enabled: document.getElementById(`ai-level-${lvl}`).checked,
            count: parseInt(document.getElementById(`ai-l${lvl}-count`).value, 10) || 0,
            maxWords: parseInt(document.getElementById(`ai-l${lvl}-words`).value, 10) || 0,
            complexity: document.getElementById(`ai-l${lvl}-complex`).value,
            subtlety: document.getElementById(`ai-l${lvl}-subtle`).value,
            ellipsesMaxWords: parseInt(document.getElementById(`ai-l${lvl}-ellipsis`).value, 10) || 0
        });
        return {
            question: document.getElementById("ai-question").value,
            count: parseInt(document.getElementById("ai-count").value, 10) || 6,
            mode: document.getElementById("ai-mode").value,
            levels: { 1: getLevel(1), 2: getLevel(2), 3: getLevel(3) }
        };
    },
    applyAiSettings: (s) => {
        if(!s || typeof s !== 'object') return;
        if(typeof s.question === 'string') document.getElementById("ai-question").value = s.question;
        if(typeof s.count === 'number') document.getElementById("ai-count").value = s.count;
        if(typeof s.mode === 'string') document.getElementById("ai-mode").value = s.mode;
        const applyLevel = (lvl) => {
            const l = s.levels && s.levels[lvl] ? s.levels[lvl] : {};
            if(typeof l.enabled === 'boolean') document.getElementById(`ai-level-${lvl}`).checked = l.enabled;
            if(typeof l.count === 'number') document.getElementById(`ai-l${lvl}-count`).value = l.count || "";
            if(typeof l.maxWords === 'number') document.getElementById(`ai-l${lvl}-words`).value = l.maxWords || "";
            if(typeof l.complexity === 'string') document.getElementById(`ai-l${lvl}-complex`).value = l.complexity;
            if(typeof l.subtlety === 'string') document.getElementById(`ai-l${lvl}-subtle`).value = l.subtlety;
            if(typeof l.ellipsesMaxWords === 'number') document.getElementById(`ai-l${lvl}-ellipsis`).value = l.ellipsesMaxWords || "";
        };
        applyLevel(1); applyLevel(2); applyLevel(3);
    },
    getTemplates: () => {
        let local = [];
        try {
            const raw = JSON.parse(localStorage.getItem("tsa_templates_v1") || "[]");
            if(Array.isArray(raw)) local = raw;
        } catch(e) {}
        const embedded = (appData && appData.settings && Array.isArray(appData.settings.templates))
            ? appData.settings.templates
            : [];
        const merged = [...local];
        embedded.forEach(t => {
            if(!t || !t.name) return;
            if(!merged.find(x => x && x.name === t.name)) merged.push(t);
        });
        return merged;
    },
    saveTemplates: (templates) => {
        localStorage.setItem("tsa_templates_v1", JSON.stringify(templates));
        if(appData && appData.settings) {
            appData.settings.templates = templates;
            app.save();
        }
    },
    refreshTemplateList: () => {
        const sel = document.getElementById("template-select");
        if(!sel) return;
        const templates = admin.getTemplates();
        sel.innerHTML = templates.length ? templates.map(t => `<option value="${t.name}">${t.name}</option>`).join('') : `<option value="">No templates</option>`;
    },
    saveTemplate: () => {
        const name = document.getElementById("template-name").value.trim();
        if(!name) return alert("Enter a template name.");
        const templates = admin.getTemplates();
        const payload = {
            name,
            aiSettings: admin.getAiSettings(),
            sentenceConfig: JSON.parse(JSON.stringify(appData.sentenceConfig)),
            banks: JSON.parse(JSON.stringify(appData.banks))
        };
        const idx = templates.findIndex(t => t.name === name);
        if(idx >= 0) templates[idx] = payload; else templates.push(payload);
        admin.saveTemplates(templates);
        admin.refreshTemplateList();
        document.getElementById("template-select").value = name;
    },
    loadTemplate: () => {
        const sel = document.getElementById("template-select");
        const name = sel ? sel.value : "";
        if(!name) return alert("Select a template.");
        const templates = admin.getTemplates();
        const t = templates.find(x => x.name === name);
        if(!t) return alert("Template not found.");
        admin.applyAiSettings(t.aiSettings);
        if(t.sentenceConfig && typeof t.sentenceConfig === 'object') {
            appData.sentenceConfig = JSON.parse(JSON.stringify(t.sentenceConfig));
        }
        if(t.banks && typeof t.banks === 'object') {
            appData.banks = JSON.parse(JSON.stringify(t.banks));
        }
        app.save();
        if(t.sentenceConfig && typeof t.sentenceConfig === 'object') {
            const lvl = typeof currentConfigLevel === 'number' ? currentConfigLevel : 1;
            admin.renderConfig(lvl);
        }
    },
    generatePrompt: (silent) => {
        const c = document.getElementById("ai-count").value;
        const txt = document.getElementById("ai-input").value;
        const q = document.getElementById("ai-question").value || "How does the writer use language?";
        if(!txt) { if(!silent) alert("Paste text."); return; }
        
        const pointCount = Math.max(5, parseInt(c));
        const settings = admin.getAiSettings();
        const lvl = settings.levels;
        const enabledLevels = (appData.settings && appData.settings.aiPromptAllLevels)
            ? Array.from({length:10}, (_,i)=>i+1)
            : app.getActiveLevels();
        if(enabledLevels.length === 0) { if(!silent) alert("Select at least one level."); return; }
        const levelRules = enabledLevels.map(n => {
            const l = lvl[n] || {};
            const maxWords = l.maxWords ? `max ${l.maxWords} words` : (n > 3 ? `max ${30 + (n-3)*4} words` : "short quotes");
            const count = l.count ? `Aim for ${l.count} items` : "Balanced items";
            const complexity = l.complexity || (n >= 6 ? "very advanced" : n >= 4 ? "advanced" : "medium");
            const subtlety = l.subtlety || (n >= 6 ? "very subtle" : n >= 4 ? "subtle" : "medium");
            const ellipsesRule = l.ellipsesMaxWords ? `ellipsis if > ${l.ellipsesMaxWords} words` : "ellipsis only if needed";
            return `- L${n}: ${count}, ${maxWords}, ${complexity} meanings/analysis, ${subtlety} distractors, ${ellipsesRule}.`;
        }).join("\n");
        const levelRulesJson = JSON.stringify(Object.fromEntries(
            enabledLevels.map(n => [
                n,
                {
                    maxWords: (lvl[n] && lvl[n].maxWords) ? lvl[n].maxWords : (n > 3 ? 30 + (n-3)*4 : (n === 1 ? 12 : n === 2 ? 20 : 30)),
                    ellipsesMaxWords: (lvl[n] && lvl[n].ellipsesMaxWords) ? lvl[n].ellipsesMaxWords : 7
                }
            ])
        ));
        const anyCounts = enabledLevels.some(n => (lvl[n] && (lvl[n].count || 0) > 0));
        const targetSplit = anyCounts ? enabledLevels.map(n => `${lvl[n].count || 0}`).join(" / ") : "balanced across selected levels";

        document.getElementById("ai-prompt-out").value = `Role: Expert English Teacher. 
Task: Create a JSON lesson for students.
Source Text: "${txt.substring(0,800)}..."
Focus Question: "${q}"

Requirements:
1. Create ${c} items. Each item object must have: { id, original (quote from text), translation (meaning), translationDistractors (2 wrong meanings), type (tone/structure/language), effect (analysis sentence), effectDistractors (2 wrong analysis sentences), levels:[1..10], includeInWorksheet:true }.
2. Assign EACH item to one level only (${enabledLevels.join(", ")}). Ensure lower levels are simpler and higher levels are more nuanced.
3. Level rules (STRICT): 
${levelRules}
   - Enforce max word limits per level. If a quote exceeds max words, shorten with ellipses per level rule and keep it faithful to the text.
   - Do NOT output quotes longer than the max for that level.
4. Manage cognitive load: keep L1 very accessible to reduce overload, L2 for regular practice, L3 to stretch comprehension, memory, and attention. Increase subtlety gradually across levels.
5. Quality target: L2 and L3 meanings/effects should model Eduqas Grade 4+ responses; L1 is simplified practice phrasing.
6. If you cannot match the exact target split (${targetSplit}) then keep the level proportions close.
7. Populate 'globalStructure': { enabled:true, items:[ {question, correct, distractors:[2]} ] } (Create 2 distinct questions about the whole text structure, relevant to the Focus Question).
8. Provide 'sentenceConfig' for each level to build grammatically correct sentences. Use:
   - L1: ["starter","quote","link_l1","point"]
   - L2: ["marker","starter","quote","method","point","link_l2"]
   - L3: ["marker","starter","quote","method","point","link_l3"]
   - L4: ["marker","starter","quote","method","manual_point","link_l3"]
   - L5: ["marker","starter","quote","manual_method","point","link_l3"]
   - L6: ["marker","manual_starter","quote","method","point","link_l3"]
   - L7: ["manual_marker","starter","quote","method","point","link_l3"]
   - L8: ["marker","starter","quote","method","point","manual_link"]
   - L9: ["marker","starter","quote","method","manual_analysis","link_l3"]
   - L10: ["marker","starter","quote","method","manual_effect","link_l3"]
9. Populate 'banks': markers (5), starters (5), methods (5), points (${pointCount}), links:{l1:[3 simple],l2:[3 medium],l3:[3 advanced]}.
   - Create points FIRST as full, grammatically complete analysis clauses (no capital letter needed).
   - Ensure points slot into the sentenceConfig smoothly (e.g., after method or link), so the assembled sentence reads well without manual edits.
   - Keep markers/starter/link wording consistent with those point clauses.
   - Links should be clause-openers that do NOT repeat verbs from the next element (e.g., "This suggests that" + analysis).
10. If possible, include per-item options for slot-level accuracy:
    - marker or markers + markerDistractors (2)
    - starter or starters + starterDistractors (2)
    - method or methods + methodDistractors (2)
    - effect + effectDistractors (2) for analysis/point slots
11. Include settings: { autoProgress:false, practiceMode:false, practiceModeLevel:1, practiceForceAuto:false, practiceFixedTemplate:false, worksheetMatchMode:"jumbled", levelRules: ${levelRulesJson} }.

Output ONLY valid JSON.`;
        document.getElementById("ai-step2").classList.remove("hidden");
    },
    loadJson: (exportAfter) => {
        try {
            let j = JSON.parse(document.getElementById("ai-json-in").value.replace(/```json|```/g, ''));
            if(Array.isArray(j)) j = { items: j };
            const mode = document.getElementById("ai-mode").value;
            const existingTemplates = admin.getTemplates();
            const safe = app.repair(j);
            const aiText = (document.getElementById("ai-input").value || "").trim();
            const aiQuestion = (document.getElementById("ai-question").value || "").trim();
            if(aiText && !j.sourceText) safe.sourceText = aiText;
            if(aiQuestion && !j.question) safe.question = aiQuestion;
            if((!j.meta || !j.meta.title) && aiQuestion) safe.meta.title = aiQuestion;

            const aiSettings = admin.getAiSettings && admin.getAiSettings();
            if(aiSettings && aiSettings.levels) {
                const rules = {};
                [1,2,3].forEach(lvl => {
                    rules[lvl] = {
                        maxWords: aiSettings.levels[lvl].maxWords || defaultData.settings.levelRules[lvl].maxWords,
                        ellipsesMaxWords: aiSettings.levels[lvl].ellipsesMaxWords || defaultData.settings.levelRules[lvl].ellipsesMaxWords
                    };
                });
                if(!safe.settings) safe.settings = {};
                if(!safe.settings.levelRules || typeof safe.settings.levelRules !== 'object') safe.settings.levelRules = {};
                [1,2,3].forEach(lvl => {
                    if(!safe.settings.levelRules[lvl]) safe.settings.levelRules[lvl] = rules[lvl];
                    if(!safe.settings.levelRules[lvl].maxWords) safe.settings.levelRules[lvl].maxWords = rules[lvl].maxWords;
                    if(!safe.settings.levelRules[lvl].ellipsesMaxWords) safe.settings.levelRules[lvl].ellipsesMaxWords = rules[lvl].ellipsesMaxWords;
                });
                const usePractice = safe.settings && safe.settings.practiceMode;
                const practiceLevel = safe.settings && safe.settings.practiceModeLevel;
                app.applyLevelRules(safe.items, safe.settings.levelRules, usePractice ? practiceLevel : undefined);
            }
            
            if(mode === "replace") {
                appData = safe;
                if(!appData.settings.templates || !appData.settings.templates.length) {
                    appData.settings.templates = existingTemplates;
                }
                userState.completed = [];
                userState.completedLevels = [];
                userState.filter = "all";
                userState.showDone = false;
                userState.level = 1;
            } else if (mode === "append") {
                appData.items = [...(appData.items||[]), ...(safe.items||[])];
            }
            
            app.save();
            ui.renderLab();
            admin.renderAll();
            const step2 = document.getElementById("ai-step2");
            if(step2) step2.classList.remove("hidden");
            if(exportAfter) admin.exportStandalone();
        } catch(e) {
            const msg = e && e.message ? e.message : "Invalid JSON or corrupted file.";
            alert("Invalid JSON: " + msg);
        }
    },

    // BANK EDITOR
    editBank: (key) => {
        currentBankKey = key;
        document.getElementById('bank-editor-ui').classList.remove('hidden');
        document.getElementById('bank-name-display').innerText = "Editing: " + key.toUpperCase();
        
        let list = [];
        if(key.includes('link')) {
            const l = key.split('_')[1];
            list = appData.banks.links[l] || [];
        } else {
            list = appData.banks[key] || [];
        }

        const cont = document.getElementById('bank-list-container');
        cont.innerHTML = list.map((val, i) => 
            `<span class="bank-tag">${val}<button onclick="admin.removeBankItem(${i})">x</button></span>`
        ).join('');
    },

    addBankItem: () => {
        const val = document.getElementById('bank-add-input').value;
        if(!val || !currentBankKey) return;
        
        if(currentBankKey.includes('link')) {
            const l = currentBankKey.split('_')[1];
            if(!appData.banks.links[l]) appData.banks.links[l] = [];
            appData.banks.links[l].push(val);
        } else {
            if(!appData.banks[currentBankKey]) appData.banks[currentBankKey] = [];
            appData.banks[currentBankKey].push(val);
        }
        app.save();
        admin.editBank(currentBankKey); 
        document.getElementById('bank-add-input').value = '';
    },

    removeBankItem: (idx) => {
        if(currentBankKey.includes('link')) {
            const l = currentBankKey.split('_')[1];
            appData.banks.links[l].splice(idx, 1);
        } else {
            appData.banks[currentBankKey].splice(idx, 1);
        }
        app.save();
        admin.editBank(currentBankKey);
    },

    renderConfig: function(lvl) {
        currentConfigLevel = lvl;
        const sel = document.getElementById('config-level-select');
        if(sel) sel.value = String(lvl);
        const cont = document.getElementById('config-slots'); cont.innerHTML = '';
        const slots = appData.sentenceConfig[lvl];
        const allOpts = ['marker', 'starter', 'quote', 'method', 'analysis', 'link_l1', 'link_l2', 'link_l3', 'point', 'manual_marker', 'manual_starter', 'manual_method', 'manual_point', 'manual_link', 'manual_analysis', 'manual_effect'];
        
        for(let i=0; i<6; i++) {
            const sel = document.createElement('select');
            sel.innerHTML = `<option value="none">None</option>` + allOpts.map(o => `<option value="${o}" ${slots[i]===o?'selected':''}>${o}</option>`).join('');
            sel.onchange = () => {
                const arr = Array.from(cont.querySelectorAll('select')).map(s=>s.value).filter(v=>v!=='none');
                appData.sentenceConfig[lvl] = arr; app.save();
            };
            cont.appendChild(sel);
        }
    },

    // EXPORTS
    exportWorksheet: function() {
        let content = `<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>Worksheet</title>
        <style>body{font-family:'Aptos','Calibri',sans-serif;} .box{border:1px solid #999; padding:10px; margin-bottom:15px;} .dotted{border-bottom:1px dotted #000; display:inline-block; width:95%; margin-top:5px;}</style>
        </head><body>
        <h1>${appData.meta.title}</h1>
        <p>${appData.sourceText.replace(/\n/g, '<br>')}</p><hr>`;
        
        const shuffle = (arr) => {
            const a = arr.slice();
            for(let i = a.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [a[i], a[j]] = [a[j], a[i]];
            }
            return a;
        };
        const uiLevel = parseInt((document.getElementById("level-selector") || {}).value, 10) || 1;
        const level = (appData.settings && appData.settings.practiceMode)
            ? (appData.settings.practiceModeLevel || 1)
            : uiLevel;
        let structure = appData.sentenceConfig[level] || appData.sentenceConfig[3] || ["starter", "quote", "point"];
        if(appData.settings && appData.settings.practiceMode && appData.settings.practiceFixedTemplate) {
            structure = app.getPracticeTemplate(level);
        }
        if(appData.settings && appData.settings.practiceMode && appData.settings.practiceForceAuto) {
            const linkSlot = `link_l${level}`;
            const mapSlot = (slot) => {
                if(!slot || !slot.startsWith("manual")) return slot;
                const tail = slot.split("_")[1] || "";
                if(tail === "marker") return "marker";
                if(tail === "starter") return "starter";
                if(tail === "method") return "method";
                if(tail === "link") return linkSlot;
                return "point";
            };
            structure = structure.map(mapSlot);
        }

        // Part A: Match
        const included = appData.items.filter(i=>i.includeInWorksheet);
        const matchMode = (appData.settings && appData.settings.worksheetMatchMode) || "jumbled";
        const meanings = included.map(i=>i.translation);
        if(matchMode === "list") {
            const shuffled = shuffle(meanings);
            content += `<h3>Part A: Match Meanings</h3><p><em>Choices: ${shuffled.join(' / ')}</em></p>`;
            included.forEach((item, idx) => {
                content += `<p>${idx+1}. "${item.original}" = __________________</p>`;
            });
        } else {
            const rightSide = matchMode === "aligned" ? meanings : shuffle(meanings);
            content += `<h3>Part A: Match Meanings</h3>`;
            content += `<p><em>Draw a line through the middle column to match each quote with its interpretation.</em></p>`;
            content += `<table style="width:100%; border-collapse:collapse; margin-bottom:15px;">`;
            content += `<tr><th style="text-align:left; border-bottom:1px solid #999; padding:6px;">Quote</th><th style="text-align:center; border-bottom:1px solid #999; padding:6px;">Match</th><th style="text-align:left; border-bottom:1px solid #999; padding:6px;">Interpretation</th></tr>`;
            included.forEach((item, idx) => {
                const right = rightSide[idx] || "";
                content += `<tr>
                    <td style="border-bottom:1px dotted #ccc; padding:6px;">${idx+1}. "${item.original}"</td>
                    <td style="border-bottom:1px dotted #ccc; padding:6px; text-align:center;">&nbsp;</td>
                    <td style="border-bottom:1px dotted #ccc; padding:6px;">${right}</td>
                </tr>`;
            });
            content += `</table>`;
        }

        // Part B: Analysis
        content += `<br><h3>Part B: Analysis</h3>`;
        appData.items.forEach((item, idx) => {
            if(!item.includeInWorksheet) return;
            content += `<div class="box"><p><strong>${idx+1}. Quote: "${item.original}"</strong></p>`;
            
            structure.forEach(slot => {
                let label = slot.toUpperCase();
                let inner = "";
                
                if(slot === 'quote') return; 
                else if(slot.startsWith('manual')) {
                    inner = `<span class="dotted"></span>`;
                    label = slot.split('_')[1].toUpperCase();
                } else {
                    let key = slot.includes('link') ? (slot.split('_')[1]||'l2') : slot+"s";
                    if(slot==='point' || slot === "analysis") key='points';
                    let opts = null;
                    if(slot === "point" || slot === "analysis") {
                        if(item.effect || (item.effectDistractors && item.effectDistractors.length)) {
                            opts = [item.effect, ...(item.effectDistractors || [])].filter(Boolean);
                        }
                    }
                    if(!opts) {
                        if(slot.includes('link')) {
                            opts = appData.banks.links[key];
                            if(!opts || !opts.length) opts = appData.banks.links.l3;
                        } else {
                            opts = appData.banks[key];
                        }
                    }
                    if(opts) inner = `<em>${opts.join(' / ')}</em><br><span class="dotted"></span>`;
                }
                content += `<p><strong>${label}:</strong> ${inner}</p>`;
            });
            content += `<br><p><strong>Sentence:</strong><br><span class="dotted"></span><br><span class="dotted"></span></p></div>`;
        });
        
        content += `</body></html>`;
        const b = new Blob(['\ufeff'+content], {type:'application/msword'});
        const a = document.createElement("a"); a.href=URL.createObjectURL(b); a.download="Worksheet.doc"; a.click();
    },

    exportStandalone: () => {
        if(!appData.items || appData.items.length === 0) {
            return alert("No lesson data to export yet.");
        }
        // 1. Prepare data with lock
        const exportData = JSON.parse(JSON.stringify(appData));
        exportData.isStandalone = true; 
        if(!exportData.sourceText) {
            const aiInput = document.getElementById("ai-input");
            const sourceInline = document.getElementById("source-inline");
            const sourceModal = document.getElementById("source-content");
            const candidates = [
                aiInput && aiInput.value,
                sourceInline && sourceInline.innerText,
                sourceModal && sourceModal.innerText
            ].map(v => (v || "").trim()).filter(Boolean);
            if(candidates.length) exportData.sourceText = app.cleanSourceText(candidates[0]);
        }
        if(!exportData.meta) exportData.meta = {};
        if(!exportData.meta.id) exportData.meta.id = "lesson_" + Date.now();

        // 2. Clone document to avoid mutating live DOM
        const clone = document.documentElement.cloneNode(true);
        const cloneDoc = document.implementation.createHTMLDocument();
        cloneDoc.replaceChild(clone, cloneDoc.documentElement);

        // 3. Remove teacher-only UI in the clone
        const adminBtn = cloneDoc.querySelector('#btn-admin');
        if (adminBtn) adminBtn.remove();
        const adminModal = cloneDoc.querySelector('#modal-admin');
        if (adminModal) adminModal.remove();

        // 4. Inject standalone data at start of body
        const dataScript = cloneDoc.createElement('script');
        dataScript.textContent = `window.STANDALONE_LESSON = ${JSON.stringify(exportData)};`;
        cloneDoc.body.prepend(dataScript);

        // 5. Serialize with doctype
        const h = '<!DOCTYPE html>\n' + cloneDoc.documentElement.outerHTML;
        const b = new Blob([h], {type:'text/html'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='StudentApp.html'; a.click();
    },
    saveConfig: () => {
        const b = new Blob([JSON.stringify(appData)], {type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='config.json'; a.click();
    },
    exportTemplates: () => {
        const templates = admin.getTemplates();
        const payload = { templates };
        const b = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(b); a.download='templates.json'; a.click();
    },
    importTemplates: (input) => {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = e => {
            try {
                const parsed = JSON.parse(e.target.result);
                const incoming = Array.isArray(parsed) ? parsed : (parsed && parsed.templates) ? parsed.templates : [];
                if(!Array.isArray(incoming)) throw new Error("Invalid templates format.");
                const current = admin.getTemplates();
                const merged = [...current];
                incoming.forEach(t => {
                    if(!t || !t.name) return;
                    if(!merged.find(x => x && x.name === t.name)) merged.push(t);
                });
                admin.saveTemplates(merged);
                admin.refreshTemplateList();
                alert(`Imported ${incoming.length} template(s).`);
            } catch(err) {
                alert("Template import failed: " + (err && err.message ? err.message : "Invalid file"));
            }
        };
        r.readAsText(f);
        input.value = "";
    },
    loadFile: (input) => {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = e => { try { appData = app.repair(JSON.parse(e.target.result)); app.save(); location.reload(); } catch(err) { alert("Error"); } };
        r.readAsText(f);
    }
};

window.onload = app.init;
</script>


</body><grammarly-desktop-integration data-grammarly-shadow-root="true"></grammarly-desktop-integration></html>
