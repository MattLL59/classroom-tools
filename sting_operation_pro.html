<html lang="en"><head><script>(function(firebaseConfig, initialAuthToken, appId) {
        window.__firebase_config = firebaseConfig;
        window.__initial_auth_token = initialAuthToken;
        window.__app_id = appId;
            })("\n{\n  \"apiKey\": \"AIzaSyCqyCcs2R2e7AegGjvFAwG98wlamtbHvZY\",\n  \"authDomain\": \"bard-frontend.firebaseapp.com\",\n  \"projectId\": \"bard-frontend\",\n  \"storageBucket\": \"bard-frontend.firebasestorage.app\",\n  \"messagingSenderId\": \"175205271074\",\n  \"appId\": \"1:175205271074:web:2b7bd4d34d33bf38e6ec7b\"\n}\n","eyJhbGciOiJSUzI1NiIsImtpZCI6IjExYjc0YTUyNzgwMDk5ZjEzNDY0MmNlZWM3ZGE4MjNkMTc4MDc2ZjIiLCJ0eXAiOiJKV1QifQ.eyJzdWIiOiJmaXJlYmFzZS1hZG1pbnNkay1mYnN2Y0BiYXJkLWZyb250ZW5kLmlhbS5nc2VydmljZWFjY291bnQuY29tIiwiYXVkIjoiaHR0cHM6Ly9pZGVudGl0eXRvb2xraXQuZ29vZ2xlYXBpcy5jb20vZ29vZ2xlLmlkZW50aXR5LmlkZW50aXR5dG9vbGtpdC52MS5JZGVudGl0eVRvb2xraXQiLCJ1aWQiOiIwNzY1MTQ5OTk1Nzk5OTM5MzkzNSIsImlzcyI6ImZpcmViYXNlLWFkbWluc2RrLWZic3ZjQGJhcmQtZnJvbnRlbmQuaWFtLmdzZXJ2aWNlYWNjb3VudC5jb20iLCJjbGFpbXMiOnsiYXBwSWQiOiJjX2U0ZTAxN2Y4ZmFhN2VhYTBfc3Rpbmdfb3BlcmF0aW9uX3Byby5odG1sLTEzIn0sImV4cCI6MTc2NTMyMDUwNiwiaWF0IjoxNzY1MzE2OTA2LCJhbGciOiJSUzI1NiJ9.IwUUdwion2R4-1O02xxRhDqLO4BVvC6zv97RG07GqEjuWQ2sShX2wldPVtJ5YdZqQQ-dy_2nllRTAwmJTDw5t5VZL0tFzKT4qS20tMEHrNcVgqZfMgFyphr6MvWHPG4FVXoDA5XleO2oqGwsaK9HSgjJqO8slhQKPSYkrd8QqwkDkyQnGLuApSHtE7R-fMxqw17yTU6-jWcbHVu2DeL2ZoqL9wtZ8RAgOKQ6qsgOGyPB0G8wY35esHPNiut93HWuGr3DQbbPuaxedxb8Lu9KhD12QpYHv5YDKbskEpb8-lMqx_-Ose0qZzj5nLhhNns-iyHsD0hAWTLyfk1iEZnDdw","c_e4e017f8faa7eaa0_sting_operation_pro.html-13")</script><script>'use strict';var h=typeof Object.defineProperties=="function"?Object.defineProperty:function(a,b,d){if(a==Array.prototype||a==Object.prototype)return a;a[b]=d.value;return a};function l(a){a=["object"==typeof globalThis&&globalThis,a,"object"==typeof window&&window,"object"==typeof self&&self,"object"==typeof global&&global];for(var b=0;b<a.length;++b){var d=a[b];if(d&&d.Math==Math)return d}throw Error("Cannot find global object");}var n=l(this);
function p(a,b){if(b)a:{var d=n;a=a.split(".");for(var c=0;c<a.length-1;c++){var e=a[c];if(!(e in d))break a;d=d[e]}a=a[a.length-1];c=d[a];b=b(c);b!=c&&b!=null&&h(d,a,{configurable:!0,writable:!0,value:b})}}function r(a){function b(c){return a.next(c)}function d(c){return a.throw(c)}return new Promise(function(c,e){function f(g){g.done?c(g.value):Promise.resolve(g.value).then(b,d).then(f,e)}f(a.next())})}function t(a){return r(a())}
p("Object.values",function(a){return a?a:function(b){var d=[],c;for(c in b)Object.prototype.hasOwnProperty.call(b,c)&&d.push(b[c]);return d}});p("Array.prototype.includes",function(a){return a?a:function(b,d){var c=this;c instanceof String&&(c=String(c));var e=c.length;d=d||0;for(d<0&&(d=Math.max(d+e,0));d<e;d++){var f=c[d];if(f===b||Object.is(f,b))return!0}return!1}});/*

 MIT License

 Copyright (c) 2017-2023 W.Y.

 Permission is hereby granted, free of charge, to any person obtaining a copy
 of this software and associated documentation files (the "Software"), to deal
 in the Software without restriction, including without limitation the rights
 to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
 copies of the Software, and to permit persons to whom the Software is
 furnished to do so, subject to the following conditions:

 The above copyright notice and this permission notice shall be included in
 all copies or substantial portions of the Software.

 THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
 SOFTWARE.

*/
function u(a,b){const d=a.style;b.backgroundColor&&(d.backgroundColor=b.backgroundColor);b.width&&(d.width=`${b.width}px`);b.height&&(d.height=`${b.height}px`);const c=b.style;c!=null&&Object.keys(c).forEach(e=>{d[e]=c[e]})};var v=(()=>{let a=0;return()=>{a+=1;return`u${`0000${(Math.random()*1679616<<0).toString(36)}`.slice(-4)}${a}`}})();function w(a){const b=[];for(let d=0,c=a.length;d<c;d++)b.push(a[d]);return b}let x=null;function y(a={}){return x?x:a.l?x=a.l:x=w(window.getComputedStyle(document.documentElement))}function z(a,b){return(a=(a.ownerDocument.defaultView||window).getComputedStyle(a).getPropertyValue(b))?parseFloat(a.replace("px","")):0}
function A(a,b={}){var d;if(!(d=b.width)){d=z(a,"border-left-width");var c=z(a,"border-right-width");d=a.clientWidth+d+c}(b=b.height)||(b=z(a,"border-top-width"),c=z(a,"border-bottom-width"),b=a.clientHeight+b+c);return{width:d,height:b}}function B(a){return new Promise((b,d)=>{const c=new Image;c.onload=()=>{c.decode().then(()=>{requestAnimationFrame(()=>b(c))})};c.onerror=d;c.crossOrigin="anonymous";c.decoding="async";c.src=a})}
function C(a){return t(function*(){return Promise.resolve().then(()=>(new XMLSerializer).serializeToString(a)).then(encodeURIComponent).then(b=>`data:image/svg+xml;charset=utf-8,${b}`)})}
function D(a,b,d){return t(function*(){const c=document.createElementNS("http://www.w3.org/2000/svg","svg"),e=document.createElementNS("http://www.w3.org/2000/svg","foreignObject");c.setAttribute("width",`${b}`);c.setAttribute("height",`${d}`);c.setAttribute("viewBox",`0 0 ${b} ${d}`);e.setAttribute("width","100%");e.setAttribute("height","100%");e.setAttribute("x","0");e.setAttribute("y","0");e.setAttribute("externalResourcesRequired","true");c.appendChild(e);e.appendChild(a);return C(c)})}
var E=(a,b)=>{if(a instanceof b)return!0;a=Object.getPrototypeOf(a);return a===null?!1:a.constructor.name===b.name||E(a,b)};function F(a,b){return y(b).map(d=>{const c=a.getPropertyValue(d),e=a.getPropertyPriority(d);return`${d}: ${c}${e?" !important":""};`}).join(" ")}
function G(a,b,d,c){a=window.getComputedStyle(a,d);var e=a.getPropertyValue("content");if(e!==""&&e!=="none"){var f=v();try{b.className=`${b.className} ${f}`}catch(k){return}e=document.createElement("style");var g=e.appendChild;d=`.${f}:${d}`;a.cssText?(c=a.getPropertyValue("content"),c=`${a.cssText} content: '${c.replace(/'|"/g,"")}';`):c=F(a,c);g.call(e,document.createTextNode(`${d}{${c}}`));b.appendChild(e)}};function H(a){return a.search(/^(data:)/)!==-1}function I(a,b,d){return t(function*(){const c=yield fetch(a,b);if(c.status===404)throw Error(`Resource "${c.url}" not found`);const e=yield c.blob();return new Promise((f,g)=>{const k=new FileReader;k.onerror=g;k.onloadend=()=>{try{f(d({o:c,result:k.result}))}catch(m){g(m)}};k.readAsDataURL(e)})})}const J={};function K(a,b,d){let c=a.replace(/\?.*/,"");d&&(c=a);/ttf|otf|eot|woff2?/i.test(c)&&(c=c.replace(/.*\//,""));return b?`[${b}]${c}`:c}
function L(a,b,d){return t(function*(){const c=K(a,b,d.C);if(J[c]!=null)return J[c];d.u&&(a+=(/\?/.test(a)?"&":"?")+(new Date).getTime());let e;try{const f=yield I(a,d.i,({o:g,result:k})=>{b||(b=g.headers.get("Content-Type")||"");return k.split(/,/)[1]});e=`data:${b};base64,${f}`}catch(f){e=d.B||""}return J[c]=e})};const M={P:"application/font-woff",R:"application/font-woff",N:"application/font-truetype",v:"application/vnd.ms-fontobject",H:"image/png",F:"image/jpeg",D:"image/jpeg",A:"image/gif",M:"image/tiff",L:"image/svg+xml",O:"image/webp"};function N(a){return(a=/\.([^./]*?)$/g.exec(a))?a[1]:""};function O(a){return t(function*(){const b=a.toDataURL();return b==="data:,"?a.cloneNode(!1):B(b)})}function aa(a,b){return t(function*(){if(a.currentSrc){var d=document.createElement("canvas");const c=d.getContext("2d");d.width=a.clientWidth;d.height=a.clientHeight;c==null||c.drawImage(a,0,0,d.width,d.height);d=d.toDataURL();return B(d)}d=a.poster;d=yield L(d,M[N(d).toLowerCase()]||"",b);return B(d)})}
function ba(a,b){return t(function*(){try{let d;if(a==null?0:(d=a.contentDocument)==null?0:d.body)return yield P(a.contentDocument.body,b,!0)}catch(d){}return a.cloneNode(!1)})}function ca(a,b){return t(function*(){return E(a,HTMLCanvasElement)?O(a):E(a,HTMLVideoElement)?aa(a,b):E(a,HTMLIFrameElement)?ba(a,b):a.cloneNode(a.tagName!=null&&a.tagName.toUpperCase()==="SVG")})}
function da(a,b,d){return t(function*(){if(b.tagName!=null&&b.tagName.toUpperCase()==="SVG")return b;let c=[];if(a.tagName!=null&&a.tagName.toUpperCase()==="SLOT"&&a.assignedNodes)c=w(a.assignedNodes());else{let e;if(E(a,HTMLIFrameElement)&&((e=a.contentDocument)==null?0:e.body))c=w(a.contentDocument.body.childNodes);else{let f;c=w(((f=a.shadowRoot)!=null?f:a).childNodes)}}if(c.length===0||E(a,HTMLVideoElement))return b;yield c.reduce((e,f)=>e.then(()=>P(f,d)).then(g=>{g&&b.appendChild(g)}),Promise.resolve());
return b})}function ea(a,b,d){const c=b.style;if(c){var e=window.getComputedStyle(a);e.cssText?(c.cssText=e.cssText,c.transformOrigin=e.transformOrigin):y(d).forEach(f=>{let g=e.getPropertyValue(f);f==="font-size"&&g.endsWith("px")&&(g=`${Math.floor(parseFloat(g.substring(0,g.length-2)))-.1}px`);E(a,HTMLIFrameElement)&&f==="display"&&g==="inline"&&(g="block");f==="d"&&b.getAttribute("d")&&(g=`path(${b.getAttribute("d")})`);c.setProperty(f,g,e.getPropertyPriority(f))})}}
function fa(a,b){E(a,HTMLSelectElement)&&(b=Array.from(b.children).find(d=>a.value===d.getAttribute("value")))&&b.setAttribute("selected","")}
function ha(a,b){return t(function*(){var d=a.querySelectorAll?a.querySelectorAll("use"):[];if(d.length===0)return a;var c={};for(var e=0;e<d.length;e++){var f=d[e].getAttribute("xlink:href");if(f){const g=document.querySelector(f);a.querySelector(f)||!g||c[f]||(c[f]=yield P(g,b,!0))}}d=Object.values(c);if(d.length){c=document.createElementNS("http://www.w3.org/1999/xhtml","svg");c.setAttribute("xmlns","http://www.w3.org/1999/xhtml");c.style.position="absolute";c.style.width="0";c.style.height="0";
c.style.overflow="hidden";c.style.display="none";e=document.createElementNS("http://www.w3.org/1999/xhtml","defs");c.appendChild(e);for(f=0;f<d.length;f++)e.appendChild(d[f]);a.appendChild(c)}return a})}
function P(a,b,d){return t(function*(){return d||!b.filter||b.filter(a)?Promise.resolve(a).then(c=>ca(c,b)).then(c=>da(a,c,b)).then(c=>{E(c,Element)&&(ea(a,c,b),G(a,c,":before",b),G(a,c,":after",b),E(a,HTMLTextAreaElement)&&(c.textContent=a.value),E(a,HTMLInputElement)&&c.setAttribute("value",a.value),fa(a,c));return c}).then(c=>ha(c,b)):null})};const Q=/url\((['"]?)([^'"]+?)\1\)/g,ia=/url\([^)]+\)\s*format\((["']?)([^"']+)\1\)/g,ja=/src:\s*(?:url\([^)]+\)\s*format\([^)]+\)[,;]\s*)+/g;function ka(a){const b=[];a.replace(Q,(d,c,e)=>{b.push(e);return d});return b.filter(d=>!H(d))}
function la(a,b,d,c){return t(function*(){try{const e=d?(new URL(b,d||void 0)).toString():b;let f;f=yield L(e,M[N(b).toLowerCase()]||"",c);return a.replace(new RegExp(`(url\\(['"]?)(${b.replace(/([.*+?^${}()|\[\]\/\\])/g,"\\$1")})(['"]?\\))`,"g"),`$1${f}$3`)}catch(e){}return a})}function ma(a,{I:b}){return b?a.replace(ja,d=>{for(;;){const [c,,e]=ia.exec(d)||[],f=c,g=e;if(!g)return"";if(g===b)return`src: ${f};`}}):a}
function R(a,b,d){return t(function*(){if(a.search(Q)===-1)return a;const c=ma(a,d);return ka(c).reduce((e,f)=>e.then(g=>la(g,f,b,d)),Promise.resolve(c))})};function S(a,b,d){return t(function*(){var c;const e=(c=b.style)==null?void 0:c.getPropertyValue(a);return e?(c=yield R(e,null,d),b.style.setProperty(a,c,b.style.getPropertyPriority(a)),!0):!1})}function na(a,b){return t(function*(){(yield S("background",a,b))||(yield S("background-image",a,b));(yield S("mask",a,b))||(yield S("-webkit-mask",a,b))||(yield S("mask-image",a,b))||(yield S("-webkit-mask-image",a,b))})}
function oa(a,b){return t(function*(){const d=E(a,HTMLImageElement);if(d&&!H(a.src)||E(a,SVGImageElement)&&!H(a.href.baseVal)){var c=d?a.src:a.href.baseVal,e=yield L(c,M[N(c).toLowerCase()]||"",b);yield new Promise((f,g)=>{a.onload=f;a.onerror=b.m?(...k)=>{try{f(b.m(...k))}catch(m){g(m)}}:g;a.decode&&(a.decode=f);a.loading==="lazy"&&(a.loading="eager");d?(a.srcset="",a.src=e):a.href.baseVal=e})}})}
function pa(a,b){return t(function*(){const d=w(a.childNodes).map(c=>T(c,b));yield Promise.all(d).then(()=>a)})}function T(a,b){return t(function*(){E(a,Element)&&(yield na(a,b),yield oa(a,b),yield pa(a,b))})};const U={};function V(a){return t(function*(){var b=U[a];if(b!=null)return b;b=yield(yield fetch(a)).text();b={url:a,cssText:b};return U[a]=b})}function W(a,b){return t(function*(){let d=a.cssText;const c=/url\(["']?([^"')]+)["']?\)/g,e=(d.match(/url\([^)]+\)/g)||[]).map(f=>t(function*(){let g=f.replace(c,"$1");g.startsWith("https://")||(g=(new URL(g,a.url)).href);return I(g,b.i,({result:k})=>{d=d.replace(f,`url(${k})`);return[f,k]})}));return Promise.all(e).then(()=>d)})}
function X(a){if(a==null)return[];const b=[];a=a.replace(/(\/\*[\s\S]*?\*\/)/gi,"");for(var d=RegExp("((@.*?keyframes [\\s\\S]*?){([\\s\\S]*?}\\s*?)})","gi");;){var c=d.exec(a);if(c===null)break;b.push(c[0])}a=a.replace(d,"");d=/@import[\s\S]*?url\([^)]*\)[\s\S]*?;/gi;for(c=RegExp("((\\s*?(?:\\/\\*[\\s\\S]*?\\*\\/)?\\s*?@media[\\s\\S]*?){([\\s\\S]*?)}\\s*?})|(([\\s\\S]*?){([\\s\\S]*?)})","gi");;){let e=d.exec(a);if(e===null)if(e=c.exec(a),e===null)break;else d.lastIndex=c.lastIndex;else c.lastIndex=
d.lastIndex;b.push(e[0])}return b}
function qa(a,b){return t(function*(){const d=[],c=[];a.forEach(e=>{if("cssRules"in e)try{w(e.cssRules||[]).forEach((f,g)=>{if(f.type===CSSRule.IMPORT_RULE){let k=g+1;f=V(f.href).then(m=>W(m,b)).then(m=>X(m).forEach(q=>{try{e.insertRule(q,q.startsWith("@import")?k+=1:e.cssRules.length)}catch(Da){}})).catch(()=>{});c.push(f)}})}catch(f){const g=a.find(k=>k.href==null)||document.styleSheets[0];e.href!=null&&c.push(V(e.href).then(k=>W(k,b)).then(k=>X(k).forEach(m=>{g.insertRule(m,g.cssRules.length)})).catch(()=>
{}))}});return Promise.all(c).then(()=>{a.forEach(e=>{if("cssRules"in e)try{w(e.cssRules||[]).forEach(f=>{d.push(f)})}catch(f){}});return d})})}function ra(a){return a.filter(b=>b.type===CSSRule.FONT_FACE_RULE).filter(b=>b.style.getPropertyValue("src").search(Q)!==-1)}function sa(a,b){return t(function*(){if(a.ownerDocument==null)throw Error("Provided element is not within a Document");var d=w(a.ownerDocument.styleSheets);d=yield qa(d,b);return ra(d)})}
function ta(a){function b(c){(c.style.fontFamily||getComputedStyle(c).fontFamily).split(",").forEach(e=>{d.add(e.trim().replace(/["']/g,""))});Array.from(c.children).forEach(e=>{e instanceof HTMLElement&&b(e)})}const d=new Set;b(a);return d}function ua(a,b){return t(function*(){const d=yield sa(a,b),c=ta(a);return(yield Promise.all(d.filter(e=>c.has(e.style.fontFamily.trim().replace(/["']/g,""))).map(e=>R(e.cssText,e.parentStyleSheet?e.parentStyleSheet.href:null,b)))).join("\n")})}
function va(a,b){return t(function*(){const d=b.j!=null?b.j:b.K?null:yield ua(a,b);if(d){const c=document.createElement("style");c.appendChild(document.createTextNode(d));a.firstChild?a.insertBefore(c,a.firstChild):a.appendChild(c)}})};function wa(a,b={}){return t(function*(){const {width:d,height:c}=A(a,b),e=yield P(a,b,!0);yield va(e,b);yield T(e,b);u(e,b);return yield D(e,d,c)})}
function xa(a,b={}){return t(function*(){const {width:d,height:c}=A(a,b);var e=yield wa(a,b);e=yield B(e);const f=document.createElement("canvas"),g=f.getContext("2d"),k=b.G||window.devicePixelRatio||1,m=b.h||d,q=b.g||c;f.width=m*k;f.height=q*k;!b.J&&(f.width>16384||f.height>16384)&&(f.width>16384&&f.height>16384?f.width>f.height?(f.height*=16384/f.width,f.width=16384):(f.width*=16384/f.height,f.height=16384):f.width>16384?(f.height*=16384/f.width,f.width=16384):(f.width*=16384/f.height,f.height=
16384));f.style.width=`${m}`;f.style.height=`${q}`;b.backgroundColor&&(g.fillStyle=b.backgroundColor,g.fillRect(0,0,f.width,f.height));g.drawImage(e,0,0,f.width,f.height);return f})}function ya(a,b={}){return t(function*(){return(yield xa(a,b)).toDataURL()})};const za=["gemini.google.com","corp.google.com","proxy.googlers.com"];function Y(){return document.body.querySelectorAll('[class*="animate"]').length>0}function Z(a){return t(function*(){try{return yield ya(a,{h:a.offsetWidth,g:a.offsetHeight})}catch(d){var b=a.offsetHeight;const c=document.createElement("canvas");c.width=a.offsetWidth;c.height=b;return c.toDataURL("image/png")}})}
function Aa(){return t(function*(){const a=document.body.offsetWidth,b=document.body.offsetHeight,d=document.body.cloneNode(!0);d.querySelectorAll('[class*="animate"]').forEach(c=>{c.classList.remove(...Array.from(c.classList).filter(e=>e.startsWith("animate")))});d.style.width=`${a}px`;d.style.height=`${b}px`;return d})}
function Ba(a){return t(function*(){let b=document.body;if(Y()){var d=yield Aa();b=d;document.body.appendChild(d)}d=yield Z(b);Y()&&document.body.removeChild(b);window.parent.postMessage({type:"SEND_SCREENSHOT",image:d,topOffset:document.documentElement.scrollTop},a.origin)})}function Ca(a){return t(function*(){const b={type:"SEND_SCREENSHOT_FOR_DATA_VISUALIZATION",image:yield Z(document.body),topOffset:0};window.parent.postMessage(b,a.origin)})}
window.addEventListener("message",a=>t(function*(){if(za.some(d=>a.origin.includes(d))){var b=a.data;b&&(b.type==="MAKE_SCREENSHOT"&&(yield Ba(a)),b.type==="MAKE_SCREENSHOT_FOR_DATA_VISUALIZATION"&&(yield Ca(a)))}}));
</script><script>(function() {
  // Ensure this script is executed only once
  if (window.firebaseAuthBridgeScriptLoaded) {
    return;
  }
  window.firebaseAuthBridgeScriptLoaded = true;

  let nextTokenPromiseId = 0;

  // Stores { resolve, reject } for ongoing token requests
  const pendingTokenPromises = {};

  // Listen for messages from the Host Application
  window.addEventListener('message', function(event) {

    const messageData = event.data;

  if (messageData && messageData.type === 'RESOLVE_NEW_FIREBASE_TOKEN') {
      const { success, token, error, promiseId } = messageData ?? {};
      if (pendingTokenPromises[promiseId]) {
        if (success) {
          pendingTokenPromises[promiseId].resolve(token);
        } else {
          pendingTokenPromises[promiseId].reject(new Error(error || 'Token refresh failed from host.'));
        }
        delete pendingTokenPromises[promiseId];
      }
    }
  });

  // Expose a function for the Generated App to request a new Firebase token
  window.requestNewFirebaseToken = function() {
    const currentPromiseId = nextTokenPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingTokenPromises[currentPromiseId] = { resolve, reject };
    });
    if (window.parent && window.parent !== window) {
      window.parent.postMessage({
        type: 'REQUEST_NEW_FIREBASE_TOKEN',
        promiseId: currentPromiseId
      }, '*');
    } else {
      pendingTokenPromises[currentPromiseId].reject(new Error('No parent window to request token from.'));
      delete pendingTokenPromises[currentPromiseId];
    }
    return promise;
  };
})();</script><script>
let realOriginalGetUserMedia = null;
if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
  realOriginalGetUserMedia = navigator.mediaDevices.getUserMedia.bind(navigator.mediaDevices);
}

(function() {
  if (navigator.mediaDevices && navigator.mediaDevices.__proto__) {
    try {
      Object.defineProperty(navigator.mediaDevices.__proto__, 'getUserMedia', {
        get: function() {
          return undefined; // Or throw an error
        },
        configurable: false
      });
    } catch (error) {
      console.error("Error defining prototype getter:", error);
    }
  }
})();

(function() {
  const pendingMediaResolvers = {};
  let nextMediaPromiseId = 0;

  function requestMediaPermissions(constraints) {
    const mediaPromiseId = nextMediaPromiseId++;
    const promise = new Promise((resolve, reject) => {
      pendingMediaResolvers[mediaPromiseId] = (granted) => {
        delete pendingMediaResolvers[mediaPromiseId];
        resolve(granted);
      };
    });

    window.parent.postMessage({
      type: 'requestMediaPermission',
      constraints: constraints,
      promiseId: mediaPromiseId,
    }, '*');

    return promise;
  }

  let originalGetUserMedia = realOriginalGetUserMedia;

  function interceptGetUserMedia() {
    if (navigator.mediaDevices) {
      Object.defineProperty(navigator.mediaDevices, 'getUserMedia', {
        value: function(constraints) {
          return requestMediaPermissions(constraints).then((granted) => {
            if (granted) {
              if (originalGetUserMedia) {
                return originalGetUserMedia(constraints);
              } else {
                throw new Error("Original getUserMedia not available.");
              }
            } else {
              throw new DOMException('Permission denied', 'NotAllowedError');
            }
          });
        },
        writable: false,
        configurable: false
      });
    }
  }

  interceptGetUserMedia();

  const observer = new MutationObserver(function(mutationsList, observer) {
    for (const mutation of mutationsList) {
      if (mutation.type === 'reconfigured' && mutation.name === 'getUserMedia' && mutation.object === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'attributes' && mutation.attributeName === 'getUserMedia' && mutation.target === navigator.mediaDevices) {
        interceptGetUserMedia();
      } else if (mutation.type === 'childList' && mutation.addedNodes) {
        mutation.addedNodes.forEach(node => {
          if (node === navigator.mediaDevices) {
            interceptGetUserMedia();
          }
        });
      }
    }
  });

  function interceptSpeechRecognition() {
    if (!window.SpeechRecognition && !window.webkitSpeechRecognition) {
      return;
    }

    const OriginalSpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;

    const SpeechRecognitionWrapper = function(...args) {
      const recognizer = new OriginalSpeechRecognition(...args);
      const originalStart = recognizer.start.bind(recognizer);

      recognizer.start = function() {
        requestMediaPermissions({ audio: true }).then(granted => {
          if (granted) {
            originalStart();
          } else {
            const errorEvent = new SpeechRecognitionErrorEvent('error');
            errorEvent.error = 'not-allowed'; // This is the standard error for permission denial.
            recognizer.dispatchEvent(errorEvent);
          }
        });
      };

      return recognizer;
    };

    SpeechRecognitionWrapper.prototype = OriginalSpeechRecognition.prototype;
    SpeechRecognitionWrapper.prototype.constructor = SpeechRecognitionWrapper;

    if (window.SpeechRecognition) {
      window.SpeechRecognition = SpeechRecognitionWrapper;
    }
    if (window.webkitSpeechRecognition) {
      window.webkitSpeechRecognition = SpeechRecognitionWrapper;
    }
  }

  interceptSpeechRecognition();

  window.addEventListener('message', function(event) {
    if (event.data) {
      if (event.data.type === 'resolveMediaPermission') {
        const { promiseId, granted } = event.data;
        if (pendingMediaResolvers[promiseId]) {
          pendingMediaResolvers[promiseId](granted);
        }
      }
    }
  });

})();</script><script>((function(modelInformation) {
  const originalFetch = window.fetch;
  // TODO: b/421908508 - Move these out of the script and match all generative AI model calls.
  let googleLlmBaseApiUrls = [
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':streamGenerateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.textModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageEditModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.imageTransformModelName + ':generateContent',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predict',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.videoModelName + ':predictLongRunning',
    'https://generativelanguage.googleapis.com/v1beta/models/' + modelInformation.ttsModelName + ':generateContent',
  ];
  modelInformation.deprecatedTextModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':streamGenerateContent',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':generateContent',
    );
  });
  modelInformation.deprecatedImageModelNames.forEach((modelName) => {
    googleLlmBaseApiUrls.push(
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':predict',
      'https://generativelanguage.googleapis.com/v1beta/models/' + modelName + ':predictLongRunning',
    );
  });

  const pendingFetchResolvers = {};
  let nextPromiseId = 0;

  function handleStringInput(input, optionsArgument) {
    const actualUrl = input;
    const fetchCallArgs = [actualUrl, optionsArgument];
    const effectiveOptions = optionsArgument || {};
    const bodyForApiKeyCheck = effectiveOptions.body;
    const bodyForPostMessage = effectiveOptions.body;
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  function handleRequestInput(input, optionsArgument) {
    const actualUrl = input.url;
    const fetchCallArgs = [input, optionsArgument];
    const effectiveOptions = { method: input.method, headers: new Headers(input.headers) };
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (optionsArgument) {
      if (optionsArgument.method) effectiveOptions.method = optionsArgument.method;
      if (optionsArgument.headers) effectiveOptions.headers = new Headers(optionsArgument.headers);
      if ('body' in optionsArgument) {
        bodyForApiKeyCheck = optionsArgument.body;
        bodyForPostMessage = optionsArgument.body;
      } else {
        bodyForApiKeyCheck = undefined;
        bodyForPostMessage = input.body;
      }
    } else {
      bodyForApiKeyCheck = undefined;
      bodyForPostMessage = input.body;
    }
    return { actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage };
  }

  window.fetch = function(input, optionsArgument) {
    let actualUrl;
    let fetchCallArgs;
    let effectiveOptions = {};
    let bodyForApiKeyCheck;
    let bodyForPostMessage;

    if (typeof input === 'string') {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleStringInput(input, optionsArgument));
    } else if (input instanceof Request) {
      ({actualUrl, fetchCallArgs, effectiveOptions, bodyForApiKeyCheck, bodyForPostMessage} = handleRequestInput(input, optionsArgument));
    } else {
      return originalFetch.apply(window, [input, optionsArgument]);
    }

    effectiveOptions.method = effectiveOptions.method || 'GET';
    if (!effectiveOptions.headers) {
      effectiveOptions.headers = new Headers();
    }


    if (typeof actualUrl === 'string' && googleLlmBaseApiUrls.some((url) => actualUrl.startsWith(url))) {
      let apiKeyIsNull = true;

      const regex = new RegExp("models/([^:]+)");
      const modelNameMatch = actualUrl.match(regex);
      const modelName = modelNameMatch ? modelNameMatch[1] : 'unspecified';


      try {
        const urlObject = new URL(actualUrl);  // Use URL object for robust parsing
        const apiKeyParam = urlObject.searchParams.get('key');
        if (apiKeyParam) {
          apiKeyIsNull = false;
        }
      } catch (e) {
        // Continue checks even if URL parsing fails
      }

      if (apiKeyIsNull && effectiveOptions.headers) {
        const h = new Headers(effectiveOptions.headers);
        const apiKeyHeaderValue = h.get('X-API-Key') || h.get('x-api-key');
        if (apiKeyHeaderValue) {
          apiKeyIsNull = false;
          return originalFetch.apply(window, fetchCallArgs);
        }
      }

      if (apiKeyIsNull && effectiveOptions.method && ['POST', 'PUT', 'PATCH'].includes(effectiveOptions.method.toUpperCase()) && typeof bodyForApiKeyCheck === 'string') {
        try {
          const bodyData = JSON.parse(bodyForApiKeyCheck);
          if (bodyData && bodyData.apiKey) {
            apiKeyIsNull = false;
            return originalFetch.apply(window, fetchCallArgs);
          }
        } catch (e) {
          // Ignore JSON parsing errors
        }
      }

      if(apiKeyIsNull) {
        const promiseId = nextPromiseId++;
        const promise = new Promise((resolve) => {
          pendingFetchResolvers[promiseId] = (resolvedResponse) => {
            delete pendingFetchResolvers[promiseId];
            resolve(resolvedResponse);
          };
        });

        let serializedBodyForPostMessage;
        if (typeof bodyForPostMessage === 'string' || bodyForPostMessage == null) {
            serializedBodyForPostMessage = bodyForPostMessage;
        } else if (bodyForPostMessage instanceof ReadableStream) {
            serializedBodyForPostMessage = null;
        } else {
            try {
                serializedBodyForPostMessage = JSON.stringify(bodyForPostMessage);
            } catch (e) {
                serializedBodyForPostMessage = null;
            }
        }

        const messageOptions = {
            method: effectiveOptions.method,
            headers: Object.fromEntries(new Headers(effectiveOptions.headers).entries()),
            body: serializedBodyForPostMessage
        };

        window.parent.postMessage({
          type: 'requestFetch',
          url: actualUrl,
          modelName: modelName,
          options: messageOptions,
          promiseId: promiseId,
        }, '*');

        return promise;
      }
      return originalFetch.apply(window, fetchCallArgs);
    }
    return originalFetch.apply(window, fetchCallArgs);
  };

  window.addEventListener('message', function(event) {
    if (event.data && event.data.type === 'resolveFetch') {
      const { promiseId, response } = event.data;
      if (pendingFetchResolvers[promiseId]) {
        try {
          const reconstructedResponse = new Response(response.body, {
            status: response.status,
            statusText: response.statusText,
            headers: new Headers(response.headers),
          });
          pendingFetchResolvers[promiseId](reconstructedResponse);
        } catch (error) {
          pendingFetchResolvers[promiseId](new Response(null, { status: 500, statusText: "Interceptor Response Reconstruction Error" }));
        }
      }
    }
  });

}))({"textModelName":"gemini-2.5-flash-preview-09-2025","imageModelName":"imagen-4.0-generate-001","imageEditModelName":"gemini-2.5-flash-image-preview","imageTransformModelName":"gemini-2.5-flash-image-preview","videoModelName":"veo-2.0-generate-001","ttsModelName":"gemini-2.5-flash-preview-tts","deprecatedTextModelNames":["gemini-2.0-flash","gemini-2.5-flash-preview-04-17","gemini-2.5-flash-preview-05-20"],"deprecatedImageModelNames":["imagen-3.0-generate-001","imagen-3.0-generate-002"]})</script><script>(function() {
  const originalConsoleLog = console.log;
  const originalConsoleError = console.error;

    /**
   * Normalizes an error event or a promise rejection reason into a structured error object.
   * @param {*} errorEventOrReason The error object or reason.
   * @return {object} Structured error data { message, name, stack }.
   */
  function getErrorObject(errorEventOrReason) {
    if (errorEventOrReason instanceof Error) {
      return {
        message: errorEventOrReason.message,
        name: errorEventOrReason.name,
        stack: errorEventOrReason.stack,
      };
    }
    // Fallback for non-Error objects.
    try {
      return {
        message: JSON.stringify(errorEventOrReason),
        name: 'UnknownErrorType',
        stack: null,
      };
    } catch (e) {
      return {
        message: String(errorEventOrReason),
        name: 'UnknownErrorTypeNonStringifiable',
        stack: null,
      };
    }
  }

  /**
   * Converts an array of arguments (from log/error) into a single string.
   * Handles Error objects specially to include their message and stack.
   * @param {Array<*>} args - Arguments passed to console methods.
   * @return {string} A string representation of the arguments.
   */
  function stringifyArgs(args) {
    return args
      .map((arg) => {
        if (arg instanceof Error) {
          const {message, stack} = arg;
          return `Error: ${message}${stack ? ('\nStack: ' + stack) : ''}`;
        }
        if (typeof arg === 'object' && arg !== null) {
          try {
            return JSON.stringify(arg);
          } catch (error) {
            return '[Circular Object]';
          }
        } else {
          return String(arg);
        }
      })
      .join(' ');
  }

  console.log = function(...args) {
    const logString = stringifyArgs(args);
    window.parent.postMessage({ type: 'log', message: logString }, '*');
    originalConsoleLog.apply(console, args);
  };

  console.error = function(...args) {
    let errorData;
    if (args.length > 0 && args[0] instanceof Error) {
      const err = args[0];
      // If the first arg is an Error, capture its details.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        ...getErrorObject(err),
        rawArgsString: stringifyArgs(args.slice(1)),
        timestamp: new Date().toISOString(),
      };
    } else {
      // If not an Error object, treat all args as a general error message.
      errorData = {
        type: 'error',
        source: 'CONSOLE_ERROR',
        message: stringifyArgs(args),
        name: 'ConsoleLoggedError',
        stack: null,
        timestamp: new Date().toISOString(),
      };
    }
    window.parent.postMessage(errorData, '*');
    originalConsoleError.apply(console, args);
  };

  // Listen for global unhandled synchronous errors.
  window.addEventListener('error', function(event) {
    const errorDetails = event.error ? getErrorObject(event.error) : {
      message: event.message,
      name: 'GlobalError',
      stack: null,
      filename: event.filename,
      lineno: event.lineno,
      colno: event.colno,
    };

    window.parent.postMessage({
      type: 'error',
      source: 'global',
      ...errorDetails,
      message: errorDetails.message || event.message,
      timestamp: new Date().toISOString(),
    }, '*');
  });

  // Listen for unhandled promise rejections (asynchronous errors).
  window.addEventListener('unhandledrejection', function(event) {
    const errorDetails = getErrorObject(event.reason);

    window.parent.postMessage({
      type: 'error',
      source: 'unhandledrejection',
      ...errorDetails,
      message: errorDetails.message || 'Unhandled Promise Rejection',
      timestamp: new Date().toISOString(),
    }, '*');
  });

})();</script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=5.0, user-scalable=yes">
    <title>Sting Op: Pro Edition</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto:wght@400;700&family=Courier+Prime&display=swap');

        /* Backup styles */
        .hidden { display: none !important; }
        .flex { display: flex !important; }

        body {
            background-color: #111827;
            font-family: 'Roboto', sans-serif;
            color: #e2e8f0;
            overflow-x: auto;
            touch-action: manipulation;
        }

        .stencil-font { font-family: 'Black Ops One', cursive; letter-spacing: 2px; }
        .mono-font { font-family: 'Courier Prime', monospace; }

        .case-file {
            background-color: #f3f4f6;
            color: #1f2937;
            border-top: 12px solid #374151;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            min-height: 400px;
            position: relative;
        }

        .level-1-theme { border-color: #3b82f6; } 
        .level-2-theme { border-color: #d97706; } 

        .stamp {
            border: 4px solid #ef4444;
            color: #ef4444;
            font-weight: bold;
            text-transform: uppercase;
            padding: 0.5rem 1rem;
            font-family: 'Black Ops One', cursive;
            transform: rotate(-12deg);
            opacity: 0.9;
            display: inline-block;
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }

        .rating-star { cursor: pointer; transition: color 0.2s; color: #d1d5db; }
        .rating-star.active { color: #f59e0b; }
        
        .modal-overlay {
            background: rgba(0,0,0,0.9);
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50;
        }

        .admin-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .admin-label {
            display: block;
            font-size: 0.75rem;
            font-weight: bold;
            color: #4b5563;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- DATA BLOCK: THIS HOLDS YOUR QUESTIONS SECURELY -->
    <script id="mission-config" type="application/json">
{
    "adminPass": "1234",
    "level2Code": "Detective",
    "caseTitle": "Case#1: Ramotswe",
    "modelText": "L1.She is  clever when she pretends that there is a real emergency, so she can fool the fake daddy. ‘pretending to be out of breath.’ \nL2. The level of detail in her plan: shown by the speech tag \"Pretending to be out of breath\" shows how clever and efficient she is.",
    "missionData": [
        {
            "tactic": "She borrows a nurse's uniform and sets off at speed.",
            "method": "Use of props / disguise",
            "analysisL1": "It creates immediate authority, forcing the man to trust her.",
            "analysisL2": "It establishes immediate authority and authenticity, forcing the man to trust her without question.",
            "wrongAnalysis": "It shows she likes dressing up in different clothes."
        },
        {
            "tactic": "She orders him: 'Inside! Four minutes left now!'",
            "method": "Imperative verbs / Countdown",
            "analysisL1": "She takes total control of the situation.",
            "analysisL2": "She takes total control of the situation, leaving him no choice but to obey.",
            "wrongAnalysis": "She is helpful by counting the time for him."
        },
        {
            "tactic": "\"The next day, Mma Ramotswe put her plan into action.\"",
            "method": "Narration/Time shift",
            "analysisL1": "The writer presents Mma Ramotswe as clever and effective when she is shown to ‘put her plan into action’ quickly ‘the next day.’ ",
            "analysisL2": "The writer shows how clever Mma Ramotswe is by using a narrative time-shift to the next day, thus emphasising how quickly she worked.",
            "wrongAnalysis": "She was taking a risk by putting her plan into action so quickly. Something might have gone wrong."
        },
        {
            "tactic": " ‘‘A good actor, thought Mma Ramotswe. ‘Yes’ she went on. ‘It is very sad.’’ ",
            "method": "Dialogue",
            "analysisL1": "Mma Ramotswe is clever because she realises the man was acting.",
            "analysisL2": "The writer uses the interaction between the characters through their dialogue and Mma Ramotswe’s thoughts to show the reader that she is both clever and effective at discovering the truth.",
            "wrongAnalysis": "Mma Ramotswe is sad about the man's acting"
        }
    ]
}
</script>

    <!-- Top Bar -->
    <header class="w-full bg-gray-900 p-4 shadow-lg flex justify-between items-center border-b border-gray-700">
        <div class="flex items-center gap-3">
            <i class="fas fa-shield-alt text-3xl text-gray-400" id="badge-icon"></i>
            <div>
                <h1 class="text-xl md:text-2xl stencil-font text-white tracking-widest">OP: STING</h1>
                <p class="text-xs text-gray-500 font-mono" id="clearance-level">CLEARANCE: LEVEL 1 (CONSTABLE)</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleModal('models-modal')" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-xs md:text-sm font-bold border border-gray-500">
                <i class="fas fa-book-open mr-1"></i> MODEL ANSWERS
            </button>
            <button onclick="toggleModal('admin-modal')" class="text-gray-600 hover:text-gray-400 px-2">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </header>

    <!-- Main Game Container -->
    <main class="w-full max-w-4xl flex-grow p-4 relative">

        <!-- START SCREEN -->
        <div id="screen-start" class="flex flex-col items-center justify-center h-full pt-10">
            <div class="bg-gray-800 p-8 rounded-lg border-2 border-gray-700 max-w-lg w-full text-center shadow-2xl">
                <!-- DYNAMIC CASE TITLE -->
                <h2 id="case-title" class="text-3xl font-bold mb-2 text-white"></h2>
                <p class="text-gray-400 mb-6 text-sm">EVALUATION PROTOCOL</p>
                
                <div class="space-y-4">
                    <button onclick="startNewSession()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded text-lg shadow-lg transition transform hover:scale-105">
                        <i class="fas fa-play mr-2"></i> START NEW OPERATION
                    </button>
                    
                    <button id="resume-btn" onclick="resumeSession()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded text-lg shadow-lg hidden">
                        <i class="fas fa-save mr-2"></i> RESUME PROGRESS
                    </button>
                </div>
                
                <p class="mt-6 text-xs text-gray-500">
                    STATUS: <span id="save-status">Ready.</span>
                </p>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="screen-game" class="hidden flex flex-col md:flex-row gap-4 h-full">
            <!-- LEFT: The Evidence File -->
            <div class="w-full md:w-1/2">
                <div id="case-file-ui" class="case-file level-1-theme p-6 rounded-b">
                    <div class="flex justify-between mb-4">
                        <span class="bg-gray-800 text-white px-2 py-1 text-xs font-mono rounded">EVIDENCE ITEM #<span id="evidence-id">1</span></span>
                        <span id="method-tag" class="hidden bg-amber-100 text-amber-800 px-2 py-1 text-xs font-bold border border-amber-300 rounded">METHOD REVEALED</span>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-1">WHAT HAPPENED? (EVIDENCE)</h3>
                        <p id="tactic-text" class="text-lg md:text-xl font-serif text-gray-900 leading-relaxed p-2 bg-white border border-gray-300 shadow-inner">...</p>
                    </div>
                    <!-- Method Section (Hidden in Level 1) -->
                    <div id="method-section" class="mb-6 hidden">
                        <h3 class="text-xs font-bold text-amber-600 uppercase tracking-widest mb-1">WRITER'S METHOD:</h3>
                        <p id="method-text" class="text-md font-bold text-indigo-900 border-l-4 border-indigo-500 pl-3">...</p>
                    </div>
                    <!-- Rating Section -->
                    <div id="rating-section" class="mt-auto border-t border-gray-300 pt-4 opacity-50 pointer-events-none transition-opacity">
                        <p class="text-xs font-bold text-gray-500 mb-2">JUDGE EFFECTIVENESS:</p>
                        <div class="flex space-x-1 text-3xl justify-center">
                             <i class="fas fa-star rating-star" onclick="submitRating(1)"></i>
                             <i class="fas fa-star rating-star" onclick="submitRating(2)"></i>
                             <i class="fas fa-star rating-star" onclick="submitRating(3)"></i>
                             <i class="fas fa-star rating-star" onclick="submitRating(4)"></i>
                             <i class="fas fa-star rating-star" onclick="submitRating(5)"></i>
                        </div>
                    </div>
                </div>
            </div>
            <!-- RIGHT: The Analysis Selector -->
            <div class="w-full md:w-1/2 flex flex-col gap-4">
                <div class="bg-gray-800 p-4 rounded border border-gray-600 flex-grow">
                    <h3 id="right-panel-title" class="text-blue-400 font-bold mb-4 text-sm uppercase border-b border-gray-700 pb-2">
                        <i class="fas fa-search mr-2"></i> Make a Point (What does this show?)
                    </h3>
                    <div id="options-container" class="space-y-3"></div>
                </div>
                <div id="feedback-box" class="h-12 bg-gray-900 rounded border border-gray-700 flex items-center justify-center text-sm font-bold text-gray-500">
                    WAITING FOR INPUT...
                </div>
            </div>
        </div>

        <!-- LEVEL UP SCREEN -->
        <div id="screen-levelup" class="hidden flex flex-col pt-4 h-full">
            <div class="bg-gray-800 p-6 rounded border-2 border-blue-500 text-center w-full shadow-2xl flex flex-col md:flex-row gap-6">
                <!-- Left: Draft -->
                <div class="w-full md:w-2/3 text-left">
                    <h2 class="text-2xl font-bold text-white mb-2">LEVEL 1 DEBRIEF</h2>
                    <p class="text-gray-400 text-sm mb-4">You have collected the evidence. Use the draft below to write your basic answer.</p>
                    <div class="bg-white text-black p-4 rounded h-64 overflow-y-auto font-mono text-sm border border-gray-500 mb-4" id="level1-report-preview"></div>
                    <button onclick="toggleModal('models-modal')" class="w-full bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 rounded text-sm mb-2">
                        <i class="fas fa-search mr-2"></i> COMPARE WITH MODEL ANSWER
                    </button>
                </div>
                <!-- Right: Unlock -->
                <div class="w-full md:w-1/3 bg-gray-900 p-4 rounded border border-gray-700 flex flex-col justify-center">
                    <i class="fas fa-lock text-4xl text-amber-500 mb-4 mx-auto"></i>
                    <h3 class="text-lg font-bold text-amber-500 mb-2 uppercase">Promotion Protocol</h3>
                    <p class="text-gray-500 text-xs mb-4">Enter authorization code to access Advanced Writer's Methods.</p>
                    <input type="text" id="passcode-input" placeholder="ENTER CODE" class="w-full bg-black text-white p-3 text-center text-xl tracking-widest font-mono border border-gray-600 rounded mb-4 uppercase">
                    <button onclick="checkPasscode()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded mb-2">AUTHORIZE LEVEL 2</button>
                    <p id="passcode-error" class="text-red-500 text-xs hidden">INVALID AUTHORIZATION CODE</p>
                </div>
            </div>
        </div>

        <!-- FINAL REPORT SCREEN -->
        <div id="screen-report" class="hidden bg-white text-gray-900 p-6 rounded shadow-2xl min-h-[500px] relative">
            <div class="absolute top-4 right-4 stamp">CASE CLOSED</div>
            <h2 class="text-2xl font-bold mb-4 border-b-2 border-black pb-2">FINAL DEBRIEF LOG (ADVANCED)</h2>
            <div class="bg-blue-50 p-3 rounded text-sm mb-4 border border-blue-200">
                <strong>INSTRUCTION:</strong> These findings include Writer's Methods. Use them to write your full 10-mark response.
            </div>
            <div id="report-content" class="space-y-4 h-96 overflow-y-auto pr-2 font-mono text-sm"></div>
            <div class="mt-4 flex gap-2">
                 <button onclick="restartLevel2()" class="flex-1 bg-amber-100 hover:bg-amber-200 text-amber-900 py-2 rounded font-bold text-sm border border-amber-300">
                    <i class="fas fa-redo mr-1"></i> REPLAY CASE (LEVEL 2)
                </button>
                 <button onclick="clearSaveData()" class="flex-1 bg-red-100 hover:bg-red-200 text-red-800 py-2 rounded font-bold text-sm">
                    DELETE SAVE
                </button>
            </div>
        </div>
    </main>

    <!-- ADMIN MODAL -->
    <div id="admin-modal" class="modal-overlay justify-center items-center flex">
        <div class="bg-white text-black p-6 rounded-lg w-full max-w-4xl h-5/6 overflow-y-auto relative shadow-2xl">
            <button onclick="toggleModal('admin-modal')" class="absolute top-4 right-4 text-xl font-bold hover:text-red-500">×</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Chief Inspector Admin Panel</h2>

            <!-- LOGIN -->
            <div id="editor-lock-screen" class="text-center py-10 hidden">
                <h3 class="font-bold text-lg mb-2 text-red-700 uppercase"><i class="fas fa-lock mr-2"></i> Restricted Access</h3>
                <div id="default-pass-alert" class="bg-yellow-100 text-yellow-800 p-2 rounded text-xs mb-4 inline-block">
                    <i class="fas fa-exclamation-triangle mr-1"></i> Default Password: <strong>ChiefInspector</strong>
                </div>
                <input type="password" id="admin-password-input" class="border-2 border-gray-300 p-3 rounded text-lg w-64 mx-auto block mb-4 text-center" placeholder="Password">
                <button onclick="unlockEditor()" class="bg-red-600 text-white px-6 py-2 rounded font-bold hover:bg-red-700 transition">UNLOCK PANEL</button>
                <p id="admin-auth-error" class="text-red-600 text-sm font-bold mt-4 hidden">Access Denied.</p>
            </div>

            <!-- EDITOR -->
            <div id="editor-unlocked-screen" class="">
                <!-- Settings -->
                <div class="bg-yellow-50 border border-yellow-200 p-4 rounded mb-6 flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <label class="admin-label">Admin Password</label>
                        <input type="text" id="new-admin-pass" class="admin-input border-yellow-300" autocomplete="off">
                    </div>
                    <div class="flex-1">
                        <label class="admin-label">Level 2 Unlock Code</label>
                        <input type="text" id="new-level2-code" class="admin-input border-yellow-300" autocomplete="off">
                    </div>
                    <div class="flex items-end">
                        <button onclick="saveSecuritySettings()" class="bg-yellow-600 text-white px-4 py-2 rounded font-bold text-sm hover:bg-yellow-700 h-10 w-full">UPDATE CODES</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="md:col-span-1">
                        <label class="admin-label">Case Title</label>
                        <input type="text" id="edit-case-title" class="admin-input" autocomplete="off">
                    </div>
                    <div class="md:col-span-2">
                        <label class="admin-label">Model Answers Text</label>
                        <textarea id="edit-model-answers" class="admin-input h-20 bg-white border border-gray-300 p-2"></textarea>
                    </div>
                </div>

                <div class="border-t-4 border-blue-500 pt-4 bg-gray-50 p-4 rounded">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-blue-800">Mission Questions Editor</h3>
                        <button onclick="addNewQuestion()" class="bg-green-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-green-700">+ ADD QUESTION</button>
                    </div>
                    <div id="visual-editor-container" class="space-y-6"><div class="bg-white border p-4 rounded shadow-sm relative group">
                    <div class="absolute top-2 right-2 cursor-pointer text-red-400 hover:text-red-600 font-bold px-2" onclick="deleteQuestion(0)">×</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="admin-label">Evidence / Tactic</label><input type="text" class="admin-input q-tactic" value="She borrows a nurse's uniform and sets off at speed."></div>
                        <div><label class="admin-label">Writer's Method</label><input type="text" class="admin-input q-method" value="Use of props / disguise"></div>
                        <div><label class="admin-label text-blue-600">L1 Analysis (Simple)</label><textarea class="admin-input h-16 q-analysisL1">It creates immediate authority, forcing the man to trust her.</textarea></div>
                        <div><label class="admin-label text-amber-600">L2 Analysis (Advanced)</label><textarea class="admin-input h-16 q-analysisL2">It establishes immediate authority and authenticity, forcing the man to trust her without question.</textarea></div>
                        <div class="md:col-span-2"><label class="admin-label text-red-600">Wrong Analysis</label><textarea class="admin-input h-12 q-wrong">It shows she likes dressing up in different clothes.</textarea></div>
                    </div>
                </div><div class="bg-white border p-4 rounded shadow-sm relative group">
                    <div class="absolute top-2 right-2 cursor-pointer text-red-400 hover:text-red-600 font-bold px-2" onclick="deleteQuestion(1)">×</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="admin-label">Evidence / Tactic</label><input type="text" class="admin-input q-tactic" value="She orders him: 'Inside! Four minutes left now!'"></div>
                        <div><label class="admin-label">Writer's Method</label><input type="text" class="admin-input q-method" value="Imperative verbs / Countdown"></div>
                        <div><label class="admin-label text-blue-600">L1 Analysis (Simple)</label><textarea class="admin-input h-16 q-analysisL1">She takes total control of the situation.</textarea></div>
                        <div><label class="admin-label text-amber-600">L2 Analysis (Advanced)</label><textarea class="admin-input h-16 q-analysisL2">She takes total control of the situation, leaving him no choice but to obey.</textarea></div>
                        <div class="md:col-span-2"><label class="admin-label text-red-600">Wrong Analysis</label><textarea class="admin-input h-12 q-wrong">She is helpful by counting the time for him.</textarea></div>
                    </div>
                </div><div class="bg-white border p-4 rounded shadow-sm relative group">
                    <div class="absolute top-2 right-2 cursor-pointer text-red-400 hover:text-red-600 font-bold px-2" onclick="deleteQuestion(2)">×</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="admin-label">Evidence / Tactic</label><input type="text" class="admin-input q-tactic" value=""></div>
                        <div><label class="admin-label">Writer's Method</label><input type="text" class="admin-input q-method" value=""></div>
                        <div><label class="admin-label text-blue-600">L1 Analysis (Simple)</label><textarea class="admin-input h-16 q-analysisL1"></textarea></div>
                        <div><label class="admin-label text-amber-600">L2 Analysis (Advanced)</label><textarea class="admin-input h-16 q-analysisL2"></textarea></div>
                        <div class="md:col-span-2"><label class="admin-label text-red-600">Wrong Analysis</label><textarea class="admin-input h-12 q-wrong"></textarea></div>
                    </div>
                </div><div class="bg-white border p-4 rounded shadow-sm relative group">
                    <div class="absolute top-2 right-2 cursor-pointer text-red-400 hover:text-red-600 font-bold px-2" onclick="deleteQuestion(3)">×</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="admin-label">Evidence / Tactic</label><input type="text" class="admin-input q-tactic" value=""></div>
                        <div><label class="admin-label">Writer's Method</label><input type="text" class="admin-input q-method" value=""></div>
                        <div><label class="admin-label text-blue-600">L1 Analysis (Simple)</label><textarea class="admin-input h-16 q-analysisL1"></textarea></div>
                        <div><label class="admin-label text-amber-600">L2 Analysis (Advanced)</label><textarea class="admin-input h-16 q-analysisL2"></textarea></div>
                        <div class="md:col-span-2"><label class="admin-label text-red-600">Wrong Analysis</label><textarea class="admin-input h-12 q-wrong"></textarea></div>
                    </div>
                </div></div>
                </div>

                <div class="mt-6 flex flex-col md:flex-row justify-between border-t pt-4 gap-4">
                    <button onclick="resetToDefaults()" class="text-red-500 text-sm font-bold hover:text-red-700">RESET DEFAULTS</button>
                    <div class="flex gap-4">
                        <button onclick="copySourceCode()" class="bg-gray-800 text-white px-6 py-3 rounded font-bold text-lg shadow-lg hover:bg-gray-900 transition flex items-center gap-2">
                            <i class="fas fa-copy"></i> COPY SOURCE
                        </button>
                        <button onclick="exportStandaloneFile()" class="bg-purple-700 text-white px-6 py-3 rounded font-bold text-lg shadow-lg hover:bg-purple-800 transition flex items-center gap-2">
                            <i class="fas fa-file-download"></i> DOWNLOAD FILE
                        </button>
                        <button onclick="saveAllChanges()" class="bg-blue-600 text-white px-8 py-3 rounded font-bold text-lg shadow-lg hover:bg-blue-700 transition">
                            <i class="fas fa-save mr-2"></i> SAVE (LOCAL)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODEL VIEW -->
    <div id="models-modal" class="modal-overlay justify-center items-center hidden">
         <div class="bg-white text-black p-8 rounded-lg w-full max-w-2xl max-h-[80vh] overflow-y-auto relative border-4 border-gray-800">
            <button onclick="toggleModal('models-modal')" class="absolute top-4 right-4 text-gray-500 hover:text-black text-2xl font-bold">×</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b-2 border-gray-300 pb-2">📂 MODEL ANSWERS</h2>
            <div id="model-content-display" class="prose text-sm leading-relaxed text-gray-700 whitespace-pre-wrap">L1.She is  clever when she pretends that there is a real emergency, so she can fool the fake daddy. ‘pretending to be out of breath.’ <br>L2. The level of detail in her plan: shown by the speech tag "Pretending to be out of breath" shows how clever and efficient she is.</div>
         </div>
    </div>

    <script>
        // --- SAFE STORAGE ---
        const SafeStorage = {
            getItem: (key) => { try { return localStorage.getItem(key); } catch(e) { return null; } },
            setItem: (key, val) => { try { localStorage.setItem(key, val); } catch(e) {} },
            removeItem: (key) => { try { localStorage.removeItem(key); } catch(e) {} }
        };

        // --- LOAD CONFIG FROM SCRIPT TAG ---
        let appConfig;
        try {
            const scriptContent = document.getElementById('mission-config').textContent;
            appConfig = JSON.parse(scriptContent);
        } catch (e) {
            console.error("Config Error", e);
            appConfig = { missionData: [] };
        }

        // --- STATE ---
        let playerState = { currentLevel: 1, currentIndex: 0, log: [] };
        let selectedOption = null;

        // Load Local Overrides
        try {
            const storedConfig = SafeStorage.getItem('stingOpConfig');
            if (storedConfig) {
                const local = JSON.parse(storedConfig);
                appConfig = { ...appConfig, ...local };
            }
        } catch(e) {}

        // --- INIT ---
        window.onload = function() {
            document.getElementById('case-title').innerText = appConfig.caseTitle;
            document.getElementById('model-content-display').innerText = appConfig.modelText;
            
            if (SafeStorage.getItem('stingOpProgress')) {
                document.getElementById('resume-btn').classList.remove('hidden');
                document.getElementById('save-status').innerText = "Progress found.";
                document.getElementById('save-status').className = "text-green-400 font-bold";
            }
        };

        // --- EXPORT LOGIC (FIXED for Copy/Paste) ---
        function exportStandaloneFile() {
            saveAllChanges(false); 
            let htmlContent = document.documentElement.outerHTML;
            const configString = JSON.stringify(appConfig, null, 4);
            const scriptStart = '<script id="mission-config" type="application/json">';
            const scriptEnd = '<' + '/script>'; 
            const regex = new RegExp(`(${scriptStart})([\\s\\S]*?)(${scriptEnd})`);
            
            if(htmlContent.match(regex)) {
                htmlContent = htmlContent.replace(regex, `$1\n${configString}\n$3`);
                
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const safeTitle = appConfig.caseTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
                a.href = url;
                a.download = `sting_op_${safeTitle}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                alert("Case Exported! This new file contains all your changes.");
            } else {
                alert("Error: Could not locate config block.");
            }
        }

        function copySourceCode() {
            saveAllChanges(false);
            let htmlContent = document.documentElement.outerHTML;
            const configString = JSON.stringify(appConfig, null, 4);
            const scriptStart = '<script id="mission-config" type="application/json">';
            const scriptEnd = '<' + '/script>'; 
            const regex = new RegExp(`(${scriptStart})([\\s\\S]*?)(${scriptEnd})`);
            htmlContent = htmlContent.replace(regex, `$1\n${configString}\n$3`);
            
            // Fallback copy using textarea
            const textArea = document.createElement("textarea");
            textArea.value = htmlContent;
            textArea.style.position = "fixed";  // Avoid scrolling to bottom
            textArea.style.left = "-9999px";
            textArea.style.top = "0";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if(successful) {
                    alert("Source Code Copied! Paste into your editor and save.");
                } else {
                    prompt("Copy failed. Please manually copy:", htmlContent);
                }
            } catch (err) {
                prompt("Copy failed. Please manually copy:", htmlContent);
            }
            document.body.removeChild(textArea);
        }

        // --- GAME LOGIC ---
        function launchGame() {
            document.getElementById('screen-start').classList.add('hidden');
            if (playerState.currentIndex >= appConfig.missionData.length) {
                if (playerState.currentLevel === 1) showLevelUpScreen();
                else showReport();
            } else {
                document.getElementById('screen-game').classList.remove('hidden');
                updateUITheme();
                loadCard();
            }
        }

        function loadCard() {
            if (!appConfig.missionData[playerState.currentIndex]) playerState.currentIndex = 0;
            const data = appConfig.missionData[playerState.currentIndex];
            
            document.getElementById('evidence-id').innerText = playerState.currentIndex + 1;
            document.getElementById('tactic-text').innerText = `"${data.tactic}"`;
            document.getElementById('method-text').innerText = data.method;
            
            // Lock Rating
            document.getElementById('rating-section').style.opacity = '0.5';
            document.getElementById('rating-section').classList.add('pointer-events-none');
            document.querySelectorAll('.rating-star').forEach(s => s.classList.remove('active'));
            selectedOption = null;

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            const correctText = playerState.currentLevel === 1 ? data.analysisL1 : data.analysisL2;
            
            const opts = [
                { text: correctText, correct: true },
                { text: data.wrongAnalysis, correct: false }
            ].sort(() => Math.random() - 0.5);

            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-3 rounded bg-gray-700 hover:bg-gray-600 border border-gray-600 text-sm transition option-btn";
                btn.innerText = opt.text;
                btn.onclick = () => selectAnalysis(opt.correct, data, btn, correctText);
                container.appendChild(btn);
            });

            document.getElementById('feedback-box').innerText = playerState.currentLevel === 1 ? "SELECT THE POINT" : "SELECT BEST ANALYSIS";
            document.getElementById('feedback-box').className = "h-12 bg-gray-900 rounded border border-gray-700 flex items-center justify-center text-sm font-bold text-gray-500";
        }

        function selectAnalysis(isCorrect, data, btn, analysisText) {
            if (selectedOption) return;
            if (isCorrect) {
                btn.classList.replace('bg-gray-700', 'bg-green-700');
                btn.classList.replace('border-gray-600', 'border-green-500');
                document.getElementById('feedback-box').innerText = "CORRECT. RATE EFFECTIVENESS.";
                document.getElementById('feedback-box').className = "h-12 bg-green-900 rounded border border-green-700 flex items-center justify-center text-sm font-bold text-green-400";
                document.getElementById('rating-section').style.opacity = '1';
                document.getElementById('rating-section').classList.remove('pointer-events-none');
                selectedOption = { data: data, analysis: analysisText };
            } else {
                btn.classList.replace('bg-gray-700', 'bg-red-900');
                btn.classList.replace('border-gray-600', 'border-red-700');
                document.getElementById('feedback-box').innerText = "TRY AGAIN.";
                document.getElementById('feedback-box').className = "h-12 bg-red-900 rounded border border-red-700 flex items-center justify-center text-sm font-bold text-red-400";
            }
        }

        function submitRating(stars) {
            document.querySelectorAll('.rating-star').forEach((s, i) => {
                if (i < stars) s.classList.add('active'); else s.classList.remove('active');
            });
            playerState.log.push({
                level: playerState.currentLevel,
                tactic: selectedOption.data.tactic,
                method: selectedOption.data.method,
                analysis: selectedOption.analysis,
                rating: stars
            });
            playerState.currentIndex++;
            SafeStorage.setItem('stingOpProgress', JSON.stringify(playerState));
            setTimeout(() => {
                if (playerState.currentIndex >= appConfig.missionData.length) {
                    if (playerState.currentLevel === 1) showLevelUpScreen(); else showReport();
                } else {
                    loadCard();
                }
            }, 800);
        }

        function updateUITheme() {
            const file = document.getElementById('case-file-ui');
            const badge = document.getElementById('badge-icon');
            const clearance = document.getElementById('clearance-level');
            const rightTitle = document.getElementById('right-panel-title');

            if (playerState.currentLevel === 1) {
                file.className = "case-file level-1-theme p-6 rounded-b";
                badge.className = "fas fa-shield-alt text-3xl text-blue-500";
                clearance.innerText = "CLEARANCE: LEVEL 1 (CONSTABLE)";
                clearance.className = "text-xs text-blue-400 font-mono";
                document.getElementById('method-section').classList.add('hidden');
                document.getElementById('method-tag').classList.add('hidden');
                rightTitle.innerHTML = '<i class="fas fa-search mr-2"></i> Make a Point (What does this show?)';
            } else {
                file.className = "case-file level-2-theme p-6 rounded-b";
                badge.className = "fas fa-user-secret text-3xl text-amber-500";
                clearance.innerText = "CLEARANCE: LEVEL 2 (DETECTIVE)";
                clearance.className = "text-xs text-amber-500 font-mono";
                document.getElementById('method-section').classList.remove('hidden');
                document.getElementById('method-tag').classList.remove('hidden');
                rightTitle.innerHTML = '<i class="fas fa-microscope mr-2"></i> Why is this effective?';
            }
        }

        // --- SCREENS ---
        function showLevelUpScreen() {
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-levelup').classList.remove('hidden');
            const container = document.getElementById('level1-report-preview');
            container.innerHTML = '';
            playerState.log.forEach((entry, i) => {
                container.innerHTML += `<div class="mb-4 border-b border-gray-300 pb-2"><strong>${i+1}. Point:</strong> ${entry.analysis}<br><strong>Evidence:</strong> "${entry.tactic}"</div>`;
            });
        }

        function showReport() {
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-levelup').classList.add('hidden');
            document.getElementById('screen-report').classList.remove('hidden');
            const container = document.getElementById('report-content');
            container.innerHTML = '';
            playerState.log.forEach((entry, i) => {
                const methodLine = entry.method ? `<strong>Method:</strong> The writer uses ${entry.method.toLowerCase()}.<br>` : '';
                container.innerHTML += `<div class="mb-4 border-b border-gray-200 pb-2"><strong>${i+1}. Point:</strong> ${entry.analysis}<br>${methodLine}<strong>Evidence:</strong> This is shown when "${entry.tactic}".<br><em>(Effectiveness: ${entry.rating}/5 stars)</em></div>`;
            });
        }

        // --- AUTH & ADMIN ---
        function checkPasscode() {
            if (document.getElementById('passcode-input').value.toUpperCase() === appConfig.level2Code.toUpperCase()) {
                playerState.currentLevel = 2;
                SafeStorage.setItem('stingOpProgress', JSON.stringify(playerState));
                document.getElementById('screen-levelup').classList.add('hidden');
                showReport();
            } else {
                document.getElementById('passcode-error').classList.remove('hidden');
            }
        }

        function restartLevel2() {
            if(confirm("Replay the case to practice finding methods?")) {
                playerState.currentIndex = 0; playerState.log = []; 
                SafeStorage.setItem('stingOpProgress', JSON.stringify(playerState));
                document.getElementById('screen-report').classList.add('hidden');
                launchGame();
            }
        }

        function toggleModal(id) {
            const m = document.getElementById(id);
            if(m.classList.contains('hidden')) { 
                m.classList.remove('hidden'); m.classList.add('flex'); 
                if (id === 'admin-modal') {
                     const hint = document.getElementById('default-pass-alert');
                     if(appConfig.adminPass === "ChiefInspector") hint.classList.remove('hidden');
                     else hint.classList.add('hidden');
                }
            } else { 
                m.classList.add('hidden'); m.classList.remove('flex');
                if (id === 'admin-modal') {
                    document.getElementById('editor-lock-screen').classList.remove('hidden');
                    document.getElementById('editor-unlocked-screen').classList.add('hidden');
                    document.getElementById('admin-password-input').value = "";
                }
            }
        }

        function unlockEditor() {
            if (document.getElementById('admin-password-input').value === appConfig.adminPass) {
                document.getElementById('editor-lock-screen').classList.add('hidden');
                document.getElementById('editor-unlocked-screen').classList.remove('hidden');
                renderAdminUI();
            } else {
                document.getElementById('admin-auth-error').classList.remove('hidden');
            }
        }

        function renderAdminUI() {
            document.getElementById('new-admin-pass').value = appConfig.adminPass;
            document.getElementById('new-level2-code').value = appConfig.level2Code;
            document.getElementById('edit-case-title').value = appConfig.caseTitle;
            document.getElementById('edit-model-answers').value = appConfig.modelText;

            const container = document.getElementById('visual-editor-container');
            container.innerHTML = '';
            appConfig.missionData.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = "bg-white border p-4 rounded shadow-sm relative group";
                el.innerHTML = `
                    <div class="absolute top-2 right-2 cursor-pointer text-red-400 hover:text-red-600 font-bold px-2" onclick="deleteQuestion(${index})">&times;</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="admin-label">Evidence / Tactic</label><input type="text" class="admin-input q-tactic" value="${item.tactic.replace(/"/g, '&quot;')}"></div>
                        <div><label class="admin-label">Writer's Method</label><input type="text" class="admin-input q-method" value="${item.method.replace(/"/g, '&quot;')}"></div>
                        <div><label class="admin-label text-blue-600">L1 Analysis (Simple)</label><textarea class="admin-input h-16 q-analysisL1">${item.analysisL1 || ''}</textarea></div>
                        <div><label class="admin-label text-amber-600">L2 Analysis (Advanced)</label><textarea class="admin-input h-16 q-analysisL2">${item.analysisL2 || ''}</textarea></div>
                        <div class="md:col-span-2"><label class="admin-label text-red-600">Wrong Analysis</label><textarea class="admin-input h-12 q-wrong">${item.wrongAnalysis}</textarea></div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // --- NEW STATE-CAPTURING HELPER ---
        function captureCurrentAdminState() {
            // Save Top Settings
            appConfig.adminPass = document.getElementById('new-admin-pass').value.trim();
            appConfig.level2Code = document.getElementById('new-level2-code').value.trim();
            appConfig.caseTitle = document.getElementById('edit-case-title').value.trim();
            appConfig.modelText = document.getElementById('edit-model-answers').value;

            // Save Questions
            const qContainer = document.getElementById('visual-editor-container');
            if (qContainer && qContainer.children.length > 0) {
                const currentQuestions = [];
                Array.from(qContainer.children).forEach(row => {
                    currentQuestions.push({
                        tactic: row.querySelector('.q-tactic').value,
                        method: row.querySelector('.q-method').value,
                        analysisL1: row.querySelector('.q-analysisL1').value,
                        analysisL2: row.querySelector('.q-analysisL2').value,
                        wrongAnalysis: row.querySelector('.q-wrong').value
                    });
                });
                appConfig.missionData = currentQuestions;
            }
        }

        // --- UPDATED HANDLERS ---
        function addNewQuestion() {
            captureCurrentAdminState(); // Save state before adding
            appConfig.missionData.push({ tactic: "", method: "", analysisL1: "", analysisL2: "", wrongAnalysis: "" });
            renderAdminUI(); // Re-render
        }

        function deleteQuestion(index) {
            if(confirm("Delete this question?")) {
                captureCurrentAdminState(); // Save state before deleting
                appConfig.missionData.splice(index, 1);
                renderAdminUI();
            }
        }

        function saveSecuritySettings() {
            // Use the capture function to update config, then save
            captureCurrentAdminState();
            SafeStorage.setItem('stingOpConfig', JSON.stringify(appConfig));
            alert("Security Codes Saved.");
        }

        function saveAllChanges(reload = true) {
            captureCurrentAdminState(); // Grab everything
            
            // Clean empty rows
            appConfig.missionData = appConfig.missionData.filter(q => q.tactic.trim() !== "");
            
            SafeStorage.setItem('stingOpConfig', JSON.stringify(appConfig));
            
            if(reload) { alert("Changes Saved!"); location.reload(); }
        }

        function resetToDefaults() {
            if(confirm("Reset everything?")) { SafeStorage.removeItem('stingOpConfig'); location.reload(); }
        }

        function startNewSession() { SafeStorage.removeItem('stingOpProgress'); playerState = {currentLevel: 1, currentIndex: 0, log: []}; launchGame(); }
        function resumeSession() { const s = SafeStorage.getItem('stingOpProgress'); if(s) { playerState = JSON.parse(s); launchGame(); } }
        function clearSaveData() { SafeStorage.removeItem('stingOpProgress'); location.reload(); }
    </script>

</body></html>
