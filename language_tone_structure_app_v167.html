<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tone & Structure Architect v168 (Visual Force Fix)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #009688; 
            --accent: #ff9800; 
            --bg: #f0f2f5;
            --card: #ffffff; 
            --text: #37474f; 
            --tone-col: #9c27b0;
            --struct-col: #2196f3; 
            --lang-col: #4caf50; 
            --nav-bg: #ffffff;
            --success: #4caf50; 
            --error: #f44336;
            --high-vis: #29b6f6;
        }
        
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.3s, color 0.3s; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--card); box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; flex-shrink: 0; }
        h1 { margin: 0; font-size: 1.1rem; color: var(--primary); display:flex; align-items:center; gap:5px; }
        .score-badge { background: var(--accent); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.9rem; margin-left: 10px; font-weight: bold; }

        /* LAYOUT */
        .main-viewport { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        nav.bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: var(--nav-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 900; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; color: #888; font-size: 0.75rem; border: none; background: none; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        
        /* HUBS */
        .hub { display: none; } .hub.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media(min-width: 600px) { .grid { grid-template-columns: 1fr 1fr; } }
        
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 2px solid #ddd; text-align: center; font-size: 1.1rem; cursor: pointer; transition: transform 0.1s; position: relative; overflow: visible; }
        .card:hover { transform: scale(1.02); border-color: var(--primary); }
        .card-tone { border-left: 10px solid var(--tone-col); }
        .card-struct { border-left: 10px solid var(--struct-col); text-align: left; }
        .card-lang { border-left: 10px solid var(--lang-col); }
        .card-global { border-left: 10px solid #607d8b; background: var(--card); grid-column: 1/-1; margin-top: 20px; border-top: 4px solid #607d8b; }

        /* ANIMATIONS */
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        .shake { animation: shake 0.4s ease-in-out; border-color: var(--error) !important; background: #ffebee !important; }

        /* BUILDER */
        .bank-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; background: rgba(0,0,0,0.02); padding: 10px; border-radius: 8px; width: 100%; box-sizing: border-box; }
        .bank-row { text-align: left; width: 100%; margin-bottom: 10px; display: block; }
        .bank-label { font-size: 0.8rem; font-weight: bold; text-transform: uppercase; color: var(--primary); margin-bottom: 5px; display: block;}
        
        select { 
            width: 100%; 
            height: 45px; 
            padding: 8px; 
            border-radius: 6px; 
            border: 1px solid #bbb; 
            background: var(--card); 
            color: var(--text);
            font-size: 1rem; 
            display: block;
            margin-bottom: 5px;
        } 
        
        #sentence-stage { 
            width: 100%; 
            padding: 15px; 
            background: var(--card); 
            border: 2px dashed var(--primary); 
            border-radius: 10px; 
            margin: 15px 0; 
            font-size: 1.1rem; 
            min-height: 60px; 
            line-height: 1.4; 
            cursor: text;
            color: var(--text);
        }
        #sentence-stage:focus { outline: 2px solid var(--accent); }

        #answer-area { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; background: var(--card); color: var(--text); font-family: inherit; margin-bottom: 10px; font-size: 1rem; }
        #quote-reference { background: #e3f2fd; border-left: 5px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px; font-style: italic; color: #444; display: none; }

        /* ADMIN & EDITORS */
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; font-size: 1rem;}
        .btn-primary { background: var(--primary); width: 100%; }
        .btn-warning { background: var(--accent); }
        .btn-danger { background: #e74c3c; }
        .btn-doc { background: #1976d2; }
        .btn-high-vis { background: var(--high-vis); color: #000; font-size: 1.1rem; border: 2px solid #000; }
        .admin-btn { background:none; border:none; color:var(--text); font-size:1.2rem; cursor:pointer; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999999; justify-content: center; align-items: center; }
        
        /* EXPANDED MODAL WIDTH & OVERFLOW FIX */
        .modal-content { 
            background: var(--card); 
            color: var(--text); 
            width: 95%; 
            max-width: 1200px; 
            max-height: 95vh; 
            border-radius: 8px; 
            display: flex; 
            flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            overflow: visible !important; /* CRITICAL FIX */
        }
        
        .modal-header { padding: 15px; background: rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        
        /* SCROLL FIX FOR DROPDOWNS */
        .modal-body { 
            padding: 20px; 
            overflow-y: auto; 
            text-align: left; 
            padding-bottom: 400px; /* EXTRA SPACE FOR BOTTOM DROPDOWNS */
        } 
        
        .editor-section { 
            border: 2px solid #ddd; 
            padding: 15px; 
            margin-bottom: 20px; 
            border-radius: 5px; 
            background: rgba(0,0,0,0.02); 
            overflow: visible !important; /* CRITICAL FIX */
        }
        
        .admin-input { width: 100%; padding: 10px; border: 1px solid #aaa; border-radius: 4px; box-sizing: border-box; margin-bottom: 5px; font-size: 1rem; background: var(--card); color: var(--text); }
        .admin-tab-bar { display: flex; gap:5px; margin-bottom:10px; }
        .admin-tab { flex:1; padding:10px; border:2px solid #ccc; background:#eee; cursor:pointer; font-weight:bold; border-radius:4px; text-align:center; color:#333; }
        .admin-tab.active { background:var(--accent); color:white; border-color:var(--accent); }
        .bank-edit-btn { background:#607d8b; color:white; padding:5px 10px; border-radius:4px; border:none; margin:2px; font-size:0.85rem; cursor:pointer; }
        
        /* ITEM EDITOR STYLES - FIXED VISIBILITY */
        .item-editor-card { 
            border: 1px solid #ccc; 
            padding: 15px; 
            margin-bottom: 15px; 
            background: var(--card); 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05); 
            overflow: visible !important; /* CRITICAL FIX */
            position: relative; 
            z-index: 1;
        }
        
        .item-header-row {
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 10px;
            flex-wrap: wrap; /* PREVENTS SQUASHING */
            gap: 15px;
        }
        
        /* CRITICAL DROPDOWN FIX */
        .item-header-row select {
            width: auto !important;
            min-width: 150px;
            height: 40px !important;
            position: relative;
            z-index: 99999; /* FLOATS ABOVE EVERYTHING */
        }
        
        .level-block { margin-top: 10px; padding: 10px; border: 1px solid #eee; background: rgba(0,0,0,0.03); border-radius: 4px; }
        .level-label { font-weight: bold; display: block; margin-bottom: 5px; color: var(--text); font-size: 0.9rem; }
        .input-group { margin-bottom: 8px; }
        .input-group label { font-size: 0.8rem; font-weight: bold; color: var(--text); display:block; }

        /* THEME PICKER */
        .theme-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding: 10px; border-bottom: 1px solid #eee; }
        .color-picker { width: 50px; height: 30px; border: none; cursor: pointer; }

        /* CELEBRATION */
        #celebration-modal { text-align: center; }
        .firework-icon { font-size: 4rem; color: #ff9800; animation: spin 2s infinite linear; margin-bottom: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #feedback-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:20000; display:none; flex-direction:column; justify-content:center; align-items:center; color:white; text-align:center; }
        #feedback-icon { font-size: 5rem; margin-bottom: 20px; }
        #save-status { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; opacity: 0; transition: 0.5s; z-index: 10000; }
        
        #crash-curtain { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:999999999; justify-content:center; align-items:center; flex-direction:column; text-align:center; padding: 20px; box-sizing: border-box; }
        
        @media print { 
            .no-print { display: none; } 
            .page-break { page-break-before: always; display: block; height: 1px; }
        }
    </style>
</head>
<body>

    <div id="crash-curtain">
        <h2 style="color:#f44336; font-size: 2rem;">‚ö†Ô∏è App Error</h2>
        <p id="crash-msg">Recovering...</p>
        <div style="display:flex; gap:10px; flex-direction:column; width: 100%; max-width: 300px;">
            <button class="btn btn-danger" onclick="nuclearReset()">üî• FACTORY RESET</button>
            <button class="btn btn-primary" onclick="openAdmin(); document.getElementById('crash-curtain').style.display='none';">Open Settings</button>
        </div>
    </div>

    <header>
        <h1>
            <button onclick="clearSession()" style="background:red; color:white; border:none; border-radius:50%; width:25px; height:25px; font-weight:bold; cursor:pointer; font-size:0.8rem; margin-right:5px;" title="New Session">‚ú®</button>
            <i class="fas fa-cubes"></i> Tone & Structure v168
            <span class="score-badge" id="score-display">0 XP</span>
        </h1>
        <div style="display:flex; gap:10px;">
            <button class="admin-btn" title="Customize Theme" onclick="openThemeModal()"><i class="fas fa-palette"></i></button>
            <select id="level-select" style="padding:4px; border-radius:4px;">
                <option value="1">Lvl 1</option><option value="2">L2</option><option value="3">L3</option>
            </select>
            <button id="main-settings-btn" class="admin-btn"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div id="student-banner" style="display:none; width:100%; background:var(--accent); color:white; padding:5px; text-align:center; font-weight:bold;">
        üéì Student Mode: <span id="student-title"></span>
    </div>
    
    <div id="save-status">üíæ Progress Saved</div>

    <div class="main-viewport">
        <div id="hub-lab" class="hub active">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.9rem;">
                <span style="flex:1;"><strong><span id="header-label">Topic</span>:</strong> <span id="text-display">Loading...</span></span>
                <span style="flex:1; text-align:right;"><strong>Q:</strong> <span id="q-display">Loading...</span></span>
            </div>
            <div id="lab-content">
                <div class="instruction">Step 1: Choose Evidence</div>
                <div class="filter-bar" id="main-filter-bar" style="display:flex; gap:5px; justify-content:center; margin-bottom:10px;">
                    <button class="btn" onclick="filterGrid('all')">All</button>
                    <button class="btn" onclick="filterGrid('language')">Lang</button>
                    <button class="btn" onclick="filterGrid('structure')">Struct</button>
                </div>
                <div id="dynamic-question-display" class="dynamic-question">Select Evidence</div>
                <div class="grid" id="grid-main"></div>
            </div>
        </div>

        <div id="hub-writing" class="hub">
            <div id="quote-reference"></div>
            <div class="instruction">Sentence Construction</div>
            <div class="bank-list" id="dynamic-builder-controls"></div>
            <div class="instruction">Current Construction (Editable):</div>
            <div id="sentence-stage" contenteditable="true" oninput="manualEdit()">Start picking words in the Lab...</div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn btn-warning" style="flex:1" onclick="undoLast()">Undo</button>
                <button class="btn btn-primary" style="flex:2" onclick="commitSentence()">Add to Answer</button>
            </div>
            <hr style="opacity:0.2;">
            <textarea id="answer-area" placeholder="Your full answer will appear here..." oninput="autoSaveProgress()"></textarea>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-doc" style="flex:1" onclick="downloadDoc()">Download .doc</button>
                <button class="btn btn-warning" style="flex:0 0 auto; background:#e74c3c;" onclick="clearEssay()">Reset Essay</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button id="nav-lab" class="nav-item active" onclick="switchHub('lab')"><i class="fas fa-vial"></i><span>Evidence Lab</span></button>
        <button id="nav-writing" class="nav-item" onclick="switchHub('writing')"><i class="fas fa-pen-fancy"></i><span>Writing Desk</span></button>
    </nav>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Settings <button id="close-admin-btn">X</button></div>
            <div class="modal-body">
                <button class="btn btn-danger" style="width:100%; margin-bottom:15px; background:#e74c3c; color:white; padding:15px;" onclick="nuclearReset()">‚ö†Ô∏è Factory Reset</button>

                <div class="editor-section">
                    <h3>üñ®Ô∏è Worksheet & Data</h3>
                    <button class="btn btn-high-vis" style="width:100%; margin-bottom:10px; padding:20px; font-weight:bold;" onclick="downloadWorksheetDoc()">üìÑ DOWNLOAD WORKSHEET (.DOC)</button>
                    
                    <div style="display:flex; align-items:center; gap:5px; margin-bottom:10px;">
                        <button class="btn btn-doc" style="flex:1;" onclick="downloadJSON()">üíæ Save Lesson File</button>
                        <label class="btn btn-primary" style="flex:1; text-align:center; cursor:pointer;">
                            üìÇ Upload Saved Lesson
                            <input type="file" id="file-upload" onchange="uploadJSON(this)" style="display:none;">
                        </label>
                    </div>
                    <button class="btn btn-primary" style="width:100%;" onclick="downloadStudentApp()">üì¶ Download Student App</button>
                </div>

                <div class="editor-section" style="border-left: 5px solid var(--accent);">
                    <h3>üìù Edit Evidence & Analysis</h3>
                    <div id="items-container"></div>
                    <button class="btn btn-add" style="background:#2ecc71; margin-top:10px;" onclick="addNewItem()">+ Add New Quote</button>
                    <button class="btn btn-warning" style="width:100%; margin-top:5px;" onclick="resetUsedQuotes()">‚ôªÔ∏è Reset Used Quotes</button>
                </div>
                
                <div class="editor-section" style="border-left: 5px solid #2196f3;">
                    <h3>üèóÔ∏è Whole Text Structure</h3>
                    <p style="font-size:0.8rem;">General questions about flow, openings, and endings.</p>
                    <textarea class="admin-input" id="global-structure-q" placeholder="e.g. How does the opening paragraph engage the reader?" onchange="updateGlobal('globalStructure', this.value)"></textarea>
                </div>

                <div class="editor-section" style="border: 2px solid #673ab7; background: #f3e5f5;">
                    <h3 style="color:#4a148c;">ü§ñ AI Lesson Generator (v168)</h3>
                    <input id="ai-author-name" class="admin-input" placeholder="e.g. Charles Dickens">
                    <input id="ai-quote-count" type="number" class="admin-input" value="6" min="1" max="15">
                    <textarea id="ai-source-text" class="admin-input" style="height:80px; border-color:#9c27b0;" placeholder="Paste extract here..."></textarea>
                    <textarea id="ai-question-input" class="admin-input" style="height:50px; border-color:#9c27b0;" placeholder="Question..."></textarea>
                    <button class="btn" style="background:#7b1fa2; width:100%; margin:10px 0;" onclick="generateAndShowPrompt()">‚ú® Generate Smart Prompt (Deep)</button>
                    <div id="prompt-display-container" style="display:none; margin-bottom:15px;">
                        <textarea id="ai-generated-prompt" class="admin-input" style="height:120px; background:#e1bee7; color:#000;" readonly></textarea>
                    </div>
                    <p style="font-size:0.85rem; margin-bottom:5px;"><strong>Step
