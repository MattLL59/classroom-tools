<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eduqas Tone & Structure Architect</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS STYLES --- */
        :root {
            --col-1-pink: #ff99cc; --col-2-yellow: #ffeb3b; --col-3-blue: #85c1e9; --col-4-green: #90ee90;
            --app-color: #2c3e50; --accent-color: #e67e22;
            --level-1: #3498db; --level-2: #2ecc71; --level-3: #9b59b6;
        }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: #f4f7f6; 
            color: #333; 
            margin: 0; 
            padding: 20px; 
            height: 100vh; 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
            text-align: center;
        }
        body.dyslexia-mode { font-family: 'Comic Sans MS', sans-serif; line-height: 1.6; }

        header { 
            display: flex; justify-content: space-between; align-items: center; 
            margin-bottom: 10px; padding-bottom: 10px; border-bottom: 2px solid #e0e0e0; 
            flex-shrink: 0; background-color: #f4f7f6; z-index: 50; 
        }
        h1 { margin: 0; color: var(--app-color); font-size: 1.4rem; }
        
        #score-board { background: var(--app-color); color: white; padding: 5px 15px; border-radius: 20px; font-weight: bold; font-size: 0.9rem; display: flex; gap: 15px; align-items: center; }
        .level-badge { padding: 2px 8px; border-radius: 4px; font-size: 0.8rem; text-transform: uppercase; color: white; }
        
        .admin-btn { 
            position: fixed; top: 15px; right: 15px; font-size: 1.5rem; color: #555; background: white; border: 2px solid #e67e22; 
            border-radius: 50%; width: 45px; height: 45px; display: flex; justify-content: center; align-items: center; 
            cursor: pointer; z-index: 9999; box-shadow: 0 4px 10px rgba(0,0,0,0.2); transition: all 0.2s; 
        }
        .admin-btn:hover { transform: scale(1.1); background: #fff8f0; }
        
        .container { 
            flex-grow: 1; max-width: 1000px; width: 100%; margin: 0 auto; background: white; 
            border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); padding: 20px; 
            display: flex; flex-direction: column; overflow-y: auto; position: relative;
        }
        
        .progress-track { background: #eee; height: 10px; border-radius: 5px; margin-bottom: 20px; overflow: hidden; flex-shrink: 0; }
        .progress-fill { height: 100%; width: 0%; background: var(--success, #2ecc71); transition: width 0.4s ease; }
        
        .stage-area { display: none; animation: fadeIn 0.4s; flex-grow: 1; text-align: center; }
        .stage-area.active { display: block; }
        
        h2.stage-title { font-size: 1.4rem; margin-bottom: 5px; color: #444; }
        p.stage-subtitle { color: #777; margin-bottom: 10px; font-style: italic; }
        
        #text-source-display { 
            background: #34495e; color: white; padding: 10px; border-radius: 8px; margin-bottom: 10px; 
            font-weight: bold; font-size: 1rem; text-align: center; flex-shrink: 0;
        }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; }
        
        /* Button Styles optimized for Tone/Structure */
        button.choice-btn { 
            padding: 15px; border: 2px solid #eee; border-radius: 10px; font-size: 1.1rem; 
            cursor: pointer; box-shadow: 0 4px 6px rgba(0,0,0,0.05); transition: all 0.2s; 
            color: #333; background: white; position: relative; overflow: hidden;
        }
        button.choice-btn:hover { transform: translateY(-3px); border-color: var(--accent-color); }
        button.choice-btn.selected { border: 3px solid var(--app-color); background: #ecf0f1; transform: scale(0.98); }
        button.choice-btn.correct { background: #d5f5e3; border-color: #2ecc71; }
        button.choice-btn.incorrect { background: #fadbd8; border-color: #e74c3c; }

        /* The Decoder specific styles */
        .decoder-card { border-left: 5px solid var(--accent-color); background: #fffcf5; }
        .analysis-card { border-left: 5px solid var(--col-3-blue); background: #f0f8ff; }

        #sentence-builder { 
            margin-top: 20px; padding: 15px; background: #f8f9fa; border: 2px dashed #ccc; 
            border-radius: 8px; min-height: 60px; display: flex; align-items: center; 
            justify-content: center; font-size: 1.1rem; flex-wrap: wrap; gap: 5px; flex-shrink: 0; 
        }
        .fragment { padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); }
        
        #essay-display {
            display: none; margin-top: 20px; padding: 20px; background: #fff; border: 1px solid #ddd;
            border-left: 5px solid #f1c40f; border-radius: 8px; text-align: left;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05); line-height: 1.6; max-height: 200px; overflow-y: auto;
        }

        /* Overlays */
        #overlay, #levelup-overlay, #win-overlay, #admin-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 2000; justify-content: center; align-items: center; text-align: center; color: white; 
        }
        #overlay { background: rgba(231, 76, 60, 0.95); } 
        #levelup-overlay { background: rgba(46, 204, 113, 0.98); }
        #admin-modal { background: rgba(0,0,0,0.6); z-index: 2147483646; color: #333; } 
        #win-overlay { background: rgba(0,0,0,0.9); z-index: 3000; }

        .admin-panel { 
            background: white; width: 95%; max-width: 1100px; height: 90%; border-radius: 8px; 
            display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); text-align: left; 
        }
        .panel-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .section-box { border: 1px solid #ddd; padding: 15px; border-radius: 8px; margin-bottom: 20px; background: #fff; }
        .input-row { display: flex; gap: 10px; margin-bottom: 8px; align-items: center; }
        .admin-input { flex-grow: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        
        /* Particle Canvas */
        #particle-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
        
        .settings-bar { position: absolute; top: 10px; left: 10px; z-index: 60; }
        .icon-btn { background: none; border: none; font-size: 1.2rem; cursor: pointer; opacity: 0.6; }
        .icon-btn:hover { opacity: 1; }
    </style>
</head>
<body>

    <button class="admin-btn" onclick="openAdmin()" title="Teacher Settings"><i class="fas fa-cog"></i></button>

    <header>
        <div style="display:flex; align-items:center; gap:10px;">
            <button class="icon-btn" onclick="toggleDyslexia()" title="Dyslexia Font">Aa</button>
            <h1 id="app-title-display">Tone & Structure Architect</h1>
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <div id="score-board">
                <span id="level-badge" class="level-badge" style="background:var(--level-1)">LEVEL 1</span>
                <span>Streak: <span id="streak-val">0</span></span>
            </div>
        </div>
    </header>

    <div class="container" id="game-container">
        <div id="text-source-display">Text: The Electric Telegraph (1851)</div>
        <div class="progress-track"><div class="progress-fill" id="progress-bar"></div></div>
        
        <div id="stage-quote" class="stage-area">
            <h2 class="stage-title">Select Evidence</h2>
            <p class="stage-subtitle">Find a quote to analyze.</p>
            <div class="grid" id="quote-grid"></div>
        </div>

        <div id="stage-decoder" class="stage-area">
            <h2 class="stage-title">The Decoder Bridge</h2>
            <p class="stage-subtitle">Translate the 19th Century language to Modern English.</p>
            <div style="background:#fff3e0; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #ffe0b2;">
                <strong>Original Text:</strong><br>
                <em id="decoder-original" style="font-size:1.2rem; color:#e67e22;">...</em>
            </div>
            <div class="grid" id="decoder-grid"></div>
        </div>

        <div id="stage-analysis" class="stage-area">
            <h2 class="stage-title">Build Analysis</h2>
            <p class="stage-subtitle" id="analysis-prompt">...</p>
            <div class="grid" id="analysis-grid"></div>
        </div>
        
        <div id="stage-final" class="stage-area">
            <h2 class="stage-title" style="color:green;">Paragraph Complete!</h2>
            <p>You have successfully scaffolded this answer.</p>
            <button class="choice-btn" style="background:var(--app-color); color:white;" onclick="saveAndNext()">Add to Essay & Continue</button>
        </div>
        
        <div id="sentence-builder"><span style="color:#ccc;">Your paragraph builds here...</span></div>
        
        <div id="essay-display">
            <h3 style="margin-top:0; border-bottom:1px solid #ccc;">Your Analysis:</h3>
            <div id="essay-content"></div>
            <button onclick="clearEssay()" style="margin-top:10px; background:#e74c3c; color:white; border:none; padding:5px 10px; border-radius:4px; cursor:pointer;">Clear Essay</button>
        </div>
    </div>
    
    <div id="overlay" onclick="closeOverlay()">
        <div><i class="fas fa-times-circle" style="font-size:4rem; margin-bottom:20px;"></i><h2>Try Again</h2></div>
    </div>
    
    <div id="levelup-overlay" onclick="closeLevelUp()">
        <div><i class="fas fa-star" style="font-size:4rem; margin-bottom:20px; color:#f1c40f;"></i><h2>LEVEL UP!</h2><p>Moving to Level <span id="next-lvl-num"></span></p></div>
    </div>
    
    <div id="win-overlay">
        <canvas id="particle-canvas"></canvas>
        <div style="background:white; padding:40px; border-radius:20px; position:relative; z-index:3002;">
            <h1 style="color:#f1c40f; font-size:3rem;">Awesome!</h1>
            <p>You have mastered this text.</p>
            <button class="choice-btn" style="background:var(--success); color:white;" onclick="resetGameFull()">Play Again</button>
        </div>
    </div>

    <div id="admin-modal">
        <div class="admin-panel">
            <div style="padding:15px; background:#eee; display:flex; justify-content:space-between; align-items:center;">
                <strong>Teacher Settings</strong>
                <button onclick="closeAdmin()" style="border:none; background:none; font-size:1.2rem; cursor:pointer;">‚úñ</button>
            </div>
            
            <div class="panel-body">
                <div class="section-box" style="background:#e0f7fa;">
                    <h3>üíæ Data Manager</h3>
                    <button class="choice-btn" style="padding:5px 10px; font-size:0.9rem;" onclick="downloadConfig()">Save to File</button>
                    <button class="choice-btn" style="padding:5px 10px; font-size:0.9rem;" onclick="document.getElementById('file-input').click()">Load from File</button>
                    <input type="file" id="file-input" style="display:none;" onchange="loadConfig(this)">
                </div>

                <div class="section-box">
                    <div class="input-row">
                        <label>Text Title:</label>
                        <input id="edit-text-title" class="admin-input" onchange="updateConfig('textTitle', this.value)">
                    </div>
                </div>

                <div class="section-box" style="border-left:5px solid #9b59b6;">
                    <h3>üñ®Ô∏è Worksheet Generator</h3>
                    <p>Create a printable worksheet based on the current data.</p>
                    <div class="input-row">
                        <label>Task 1: Vocabulary Match</label>
                        <select id="ws-task1" class="admin-input"><option value="true">Show</option><option value="false">Hide</option></select>
                    </div>
                    <div class="input-row">
                        <label>Task 2: Scaffolding Style</label>
                        <select id="ws-style" class="admin-input">
                            <option value="blank">Blank Boxes</option>
                            <option value="scaffold">Partially Filled</option>
                            <option value="key">Answer Key</option>
                        </select>
                    </div>
                    <button class="choice-btn" style="background:#9b59b6; color:white; width:100%;" onclick="printWorksheet()">Generate Worksheet (PDF/Print)</button>
                </div>

                <div class="section-box">
                    <h3>üìù Quote Editor</h3>
                    <div id="quote-editor-list"></div>
                    <button class="choice-btn" style="background:#2ecc71; color:white; width:100%; margin-top:10px;" onclick="addQuote()">+ Add New Quote</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        // 1. DATA STRUCTURE
        // ==========================================
        var defaultData = {
            textTitle: "The Electric Telegraph (1851)",
            quotes: [
                {
                    id: "q1",
                    original: "a wondrous invention",
                    translation: "an amazing machine",
                    icon: "‚ú®",
                    distractor: "a boring tool",
                    level1: { starter: "The writer calls the telegraph", mood: "Excited" },
                    level3: { technique: "Adjective Choice", analysis: "This word choice establishes a tone of awe and wonder." }
                },
                {
                    id: "q2",
                    original: "knitting the nation closer",
                    translation: "joining the country like a family",
                    icon: "üß∂",
                    distractor: "making clothes",
                    level1: { starter: "He says the telegraph is", mood: "Connected" },
                    level3: { technique: "Metaphor", analysis: "This metaphor suggests the country is being tightly connected together." }
                },
                {
                    id: "q3",
                    original: "creating a web of networks",
                    translation: "connecting everyone like a spider web",
                    icon: "üï∏Ô∏è",
                    distractor: "catching flies",
                    level1: { starter: "He describes the impact as a", mood: "Vast" },
                    level3: { technique: "Imagery", analysis: "This imagery emphasizes that the network reaches every corner of the land." }
                }
            ]
        };

        var config = JSON.parse(JSON.stringify(defaultData));
        var gameState = { currentLevel: 1, streak: 0, currentQuoteIndex: null, sentenceBuffer: {} };
        var STORE_KEY = 'eduqas_tone_struct_v1';

        // ==========================================
        // 2. CORE LOGIC
        // ==========================================
        
        function init() {
            var loaded = localStorage.getItem(STORE_KEY);
            if(loaded) { try { config = JSON.parse(loaded); } catch(e){ config = defaultData; } }
            updateDOM();
        }

        function updateDOM() {
            document.getElementById('app-title-display').innerText = "Tone & Structure: " + config.textTitle.substring(0, 20) + "...";
            document.getElementById('text-source-display').innerText = "Text: " + config.textTitle;
            document.getElementById('level-badge').innerText = "LEVEL " + gameState.currentLevel;
            document.getElementById('streak-val').innerText = gameState.streak;
            
            // Check for essay content
            var essay = document.getElementById('essay-content').innerText;
            document.getElementById('essay-display').style.display = essay.length > 5 ? 'block' : 'none';
        }

        function startQuoteSelection() {
            hideAllStages();
            var grid = document.getElementById('quote-grid');
            grid.innerHTML = '';
            config.quotes.forEach((q, index) => {
                var btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerHTML = `<span style="font-size:1.5rem">${q.icon}</span><br>"${q.original}"`;
                btn.onclick = () => loadDecoderStage(index);
                grid.appendChild(btn);
            });
            document.getElementById('stage-quote').classList.add('active');
            updateBuilderDisplay();
        }

        function loadDecoderStage(index) {
            gameState.currentQuoteIndex = index;
            gameState.sentenceBuffer = {}; // Reset buffer
            hideAllStages();
            
            var q = config.quotes[index];
            document.getElementById('decoder-original').innerText = `"${q.original}"`;
            
            var grid = document.getElementById('decoder-grid');
            grid.innerHTML = '';
            
            // Options: Correct Translation vs Distractor
            var options = [
                { txt: q.translation, correct: true },
                { txt: q.distractor, correct: false }
            ].sort(() => Math.random() - 0.5);

            options.forEach(opt => {
                var btn = document.createElement('button');
                btn.className = 'choice-btn decoder-card';
                btn.innerText = opt.txt;
                btn.onclick = () => handleDecoderChoice(opt.correct, btn);
                grid.appendChild(btn);
            });

            document.getElementById('stage-decoder').classList.add('active');
        }

        function handleDecoderChoice(isCorrect, btn) {
            if(isCorrect) {
                btn.classList.add('correct');
                fireConfetti(30); // Mini burst
                gameState.streak++;
                
                // Add to Sentence Buffer
                var q = config.quotes[gameState.currentQuoteIndex];
                if(gameState.currentLevel === 1) {
                    gameState.sentenceBuffer.part1 = q.level1.starter + ` "${q.original}"`;
                    gameState.sentenceBuffer.part2 = `This means ${q.translation}.`;
                } else {
                    gameState.sentenceBuffer.part1 = `The writer uses the phrase "${q.original}"`;
                    gameState.sentenceBuffer.part2 = `which translates to the idea of ${q.translation}.`;
                }
                updateBuilderDisplay();
                
                setTimeout(() => loadAnalysisStage(), 1000);
            } else {
                btn.classList.add('incorrect');
                showOverlay();
                gameState.streak = 0;
            }
            updateDOM();
        }

        function loadAnalysisStage() {
            hideAllStages();
            var q = config.quotes[gameState.currentQuoteIndex];
            var grid = document.getElementById('analysis-grid');
            grid.innerHTML = '';

            if(gameState.currentLevel === 1) {
                // Level 1: Mood Selection
                document.getElementById('analysis-prompt').innerText = "What is the mood/feeling?";
                var moods = [q.level1.mood, "Boring", "Confusing"].sort(() => Math.random() - 0.5);
                moods.forEach(m => {
                    var btn = document.createElement('button');
                    btn.className = 'choice-btn analysis-card';
                    btn.innerText = m;
                    btn.onclick = () => handleAnalysisChoice(m === q.level1.mood, btn, `It creates a ${m} mood.`);
                    grid.appendChild(btn);
                });
            } else {
                // Level 3: Technique & Effect
                document.getElementById('analysis-prompt').innerText = "Identify the technique and effect.";
                // Create logic for correct technique match
                var options = [
                    { txt: `${q.level3.technique}: ${q.level3.analysis}`, correct: true },
                    { txt: `${q.level3.technique}: This makes the reader bored.`, correct: false },
                    { txt: "Simile: This shows nothing specific.", correct: false }
                ].sort(() => Math.random() - 0.5);
                
                options.forEach(opt => {
                    var btn = document.createElement('button');
                    btn.className = 'choice-btn analysis-card';
                    btn.style.fontSize = "0.9rem";
                    btn.innerText = opt.txt;
                    btn.onclick = () => handleAnalysisChoice(opt.correct, btn, `Using the technique of ${q.level3.technique}, the writer suggests that ${q.translation}. ${q.level3.analysis}`);
                    grid.appendChild(btn);
                });
            }
            document.getElementById('stage-analysis').classList.add('active');
        }

        function handleAnalysisChoice(isCorrect, btn, sentenceFragment) {
            if(isCorrect) {
                btn.classList.add('correct');
                fireConfetti(50);
                gameState.sentenceBuffer.part3 = sentenceFragment;
                updateBuilderDisplay();
                setTimeout(() => {
                    hideAllStages();
                    document.getElementById('stage-final').classList.add('active');
                }, 1000);
            } else {
                btn.classList.add('incorrect');
                showOverlay();
            }
        }

        function updateBuilderDisplay() {
            var html = "";
            if(gameState.sentenceBuffer.part1) html += `<span class="fragment" style="background:#e3f2fd">${gameState.sentenceBuffer.part1}</span> `;
            if(gameState.sentenceBuffer.part2) html += `<span class="fragment" style="background:#fff3e0">${gameState.sentenceBuffer.part2}</span> `;
            if(gameState.sentenceBuffer.part3) html += `<span class="fragment" style="background:#e8f5e9">${gameState.sentenceBuffer.part3}</span>`;
            
            document.getElementById('sentence-builder').innerHTML = html || "<span style='color:#ccc'>Your paragraph builds here...</span>";
        }

        function saveAndNext() {
            var fullSentence = Object.values(gameState.sentenceBuffer).join(" ");
            var essayBox = document.getElementById('essay-content');
            essayBox.innerHTML += `<p>${fullSentence}</p>`;
            updateDOM();
            
            if(gameState.streak >= 3 && gameState.currentLevel < 3) {
                document.getElementById('next-lvl-num').innerText = gameState.currentLevel + 1;
                document.getElementById('levelup-overlay').style.display = 'flex';
            } else {
                startQuoteSelection();
            }
        }

        // ==========================================
        // 3. UI HELPERS & ADMIN
        // ==========================================

        function hideAllStages() {
            document.querySelectorAll('.stage-area').forEach(el => el.classList.remove('active'));
        }

        function showOverlay() {
            document.getElementById('overlay').style.display = 'flex';
        }
        function closeOverlay() {
            document.getElementById('overlay').style.display = 'none';
        }
        function closeLevelUp() {
            gameState.currentLevel++;
            gameState.streak = 0;
            document.getElementById('levelup-overlay').style.display = 'none';
            updateDOM();
            startQuoteSelection();
        }
        function resetGameFull() {
            gameState.currentLevel = 1;
            gameState.streak = 0;
            document.getElementById('win-overlay').style.display = 'none';
            document.getElementById('essay-content').innerHTML = "";
            startQuoteSelection();
        }
        function clearEssay() {
            document.getElementById('essay-content').innerHTML = "";
            updateDOM();
        }
        function toggleDyslexia() {
            document.body.classList.toggle('dyslexia-mode');
        }

        // --- Admin Functions ---
        function openAdmin() {
            renderQuoteEditor();
            document.getElementById('admin-modal').style.display = 'flex';
            document.getElementById('edit-text-title').value = config.textTitle;
        }
        function closeAdmin() {
            document.getElementById('admin-modal').style.display = 'none';
            localStorage.setItem(STORE_KEY, JSON.stringify(config));
            updateDOM();
            startQuoteSelection();
        }
        function updateConfig(key, value) {
            config[key] = value;
        }

        function renderQuoteEditor() {
            var list = document.getElementById('quote-editor-list');
            list.innerHTML = '';
            config.quotes.forEach((q, i) => {
                var div = document.createElement('div');
                div.style.marginBottom = "15px";
                div.style.padding = "10px";
                div.style.border = "1px solid #ccc";
                div.style.borderRadius = "5px";
                div.innerHTML = `
                    <div style="display:flex; justify-content:space-between; font-weight:bold;">
                        Quote #${i+1} 
                        <button onclick="deleteQuote(${i})" style="color:red; border:none; background:none; cursor:pointer;">Delete</button>
                    </div>
                    <div class="input-row"><label>Original:</label><input class="admin-input" value="${q.original}" onchange="updateQuote(${i}, 'original', this.value)"></div>
                    <div class="input-row"><label>Translation:</label><input class="admin-input" value="${q.translation}" onchange="updateQuote(${i}, 'translation', this.value)"></div>
                    <div class="input-row"><label>Level 3 Analysis:</label><textarea class="admin-input" onchange="updateQuote(${i}, 'level3.analysis', this.value)">${q.level3.analysis}</textarea></div>
                `;
                list.appendChild(div);
            });
        }

        function updateQuote(index, key, val) {
            if(key.includes('.')) {
                var parts = key.split('.');
                config.quotes[index][parts[0]][parts[1]] = val;
            } else {
                config.quotes[index][key] = val;
            }
        }

        function addQuote() {
            config.quotes.push({
                id: "q" + Date.now(),
                original: "New Quote",
                translation: "New Meaning",
                icon: "üìù",
                distractor: "Wrong answer",
                level1: { starter: "The writer says", mood: "Neutral" },
                level3: { technique: "Technique", analysis: "Analysis here" }
            });
            renderQuoteEditor();
        }
        function deleteQuote(i) {
            if(confirm("Delete this quote?")) {
                config.quotes.splice(i, 1);
                renderQuoteEditor();
            }
        }
        function downloadConfig() {
            var dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(config));
            var downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "tone_structure_data.json");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }
        function loadConfig(input) {
            var file = input.files[0];
            var reader = new FileReader();
            reader.onload = function(e) {
                config = JSON.parse(e.target.result);
                renderQuoteEditor();
                alert("Loaded!");
            };
            reader.readAsText(file);
        }

        // ==========================================
        // 4. WORKSHEET GENERATOR
        // ==========================================
        function printWorksheet() {
            var w = window.open();
            var showTask1 = document.getElementById('ws-task1').value === "true";
            var style = document.getElementById('ws-style').value;
            
            var html = `<html><head><title>Worksheet</title><style>
                body { font-family: 'Segoe UI', sans-serif; padding: 20px; }
                h1 { border-bottom: 2px solid #333; }
                .task-box { border: 1px solid #999; padding: 15px; margin-bottom: 20px; page-break-inside: avoid; }
                table { width: 100%; border-collapse: collapse; margin-top: 10px; }
                td, th { border: 1px solid #ccc; padding: 10px; text-align: left; }
                .fill-box { border: 1px dashed #333; height: 30px; background: #f9f9f9; }
                .key-text { color: green; font-weight: bold; font-style: italic; }
            </style></head><body>`;
            
            html += `<h1>Tone & Structure Analysis: ${config.textTitle}</h1>`;
            
            if(showTask1) {
                html += `<h3>Task 1: The Translation Bridge</h3>
                <p>Match the 19th Century phrase to its modern meaning.</p>
                <table><tr><th>Original Text</th><th>Modern Translation</th></tr>`;
                
                // Shuffle for worksheet
                var shuffledQuotes = [...config.quotes].sort(() => Math.random() - 0.5);
                var answers = [...config.quotes].sort(() => Math.random() - 0.5);
                
                config.quotes.forEach((q, i) => {
                    html += `<tr>
                        <td width="50%">"${q.original}"</td>
                        <td width="50%">${style === 'key' ? '<span class="key-text">'+q.translation+'</span>' : '_______________________'}</td>
                    </tr>`;
                });
                html += `</table>`;
                
                if(style !== 'key') {
                    html += `<p><strong>Word Bank:</strong> ${answers.map(a => a.translation).join("  |  ")}</p>`;
                }
            }
            
            html += `<h3>Task 2: Building Analysis</h3>`;
            
            config.quotes.forEach((q, i) => {
                html += `<div class="task-box">
                    <strong>${i+1}. Evidence:</strong> "${q.original}"<br><br>
                    <strong>Technique:</strong> ${style === 'key' ? '<span class="key-text">'+q.level3.technique+'</span>' : '______________'}<br><br>
                    <strong>Analysis (How does it affect the reader?):</strong><br>`;
                    
                if(style === 'key') {
                    html += `<p class="key-text">${q.level3.analysis}</p>`;
                } else if (style === 'scaffold') {
                    html += `This ${q.level3.technique} suggests that... __________________________________________________`;
                } else {
                    html += `<div style="height:80px; border:1px solid #eee;"></div>`;
                }
                html += `</div>`;
            });
            
            html += `</body></html>`;
            w.document.write(html);
            w.print();
            w.close();
        }

        // ==========================================
        // 5. FX (CONFETTI)
        // ==========================================
        var canvas = document.getElementById("particle-canvas");
        var ctx = canvas.getContext("2d");
        canvas.width = window.innerWidth; canvas.height = window.innerHeight;
        var particles = [];

        function fireConfetti(amount) {
            for(var i=0; i<amount; i++) {
                particles.push({
                    x: window.innerWidth/2, y: window.innerHeight/2,
                    vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15,
                    life: 1, color: `hsl(${Math.random()*360}, 100%, 50%)`
                });
            }
        }
        
        function animate() {
            ctx.clearRect(0,0,canvas.width,canvas.height);
            particles.forEach((p,i) => {
                p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.life -= 0.02;
                ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
                ctx.beginPath(); ctx.arc(p.x, p.y, 5, 0, Math.PI*2); ctx.fill();
                if(p.life <= 0) particles.splice(i,1);
            });
            requestAnimationFrame(animate);
        }
        animate();

        // Boot
        init();
        startQuoteSelection();

    </script>
</body>
</html>
