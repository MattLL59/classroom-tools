<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone & Structure Architect v15</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES (UPDATED THEME) --- */
        :root {
            --primary: #009688; /* Teal */
            --primary-dark: #00796b;
            --accent: #ff9800; /* Orange */
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #37474f;
            --tone-col: #9c27b0;
            --struct-col: #2196f3;
            --lang-col: #4caf50;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; text-align: center;
        }

        /* --- HEADER --- */
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex-shrink: 0; margin-bottom: 20px;
        }
        h1 { margin: 0; color: var(--primary); font-size: 1.4rem; display:flex; align-items:center; gap:10px; }
        
        .admin-btn { 
            font-size: 1.2rem; color: #555; background: #eee; border: none; 
            border-radius: 5px; padding: 8px 12px; cursor: pointer; transition: all 0.2s;
        }
        .admin-btn:hover { background: #ddd; }

        /* --- MAIN CONTAINER --- */
        .container { 
            flex-grow: 1; max-width: 1100px; width: 100%; margin: 0 auto; 
            display: flex; flex-direction: column; gap: 15px; overflow-y: auto; 
            padding-right: 5px; /* Scrollbar space */
        }

        /* --- GRID LAYOUTS --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; }
        
        .card { 
            background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid #ddd;
            cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;
            display: flex; flex-direction: column; justify-content: center; min-height: 80px;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-color: var(--primary); }
        
        /* Specific Card Types */
        .card-struct { border-left: 5px solid var(--struct-col); }
        .card-lang { border-left: 5px solid var(--lang-col); }
        .card-tone { border-left: 5px solid var(--tone-col); }

        /* --- STAGE AREAS --- */
        .stage { display: none; animation: fadeIn 0.3s; }
        .stage.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .instruction { color: #78909c; margin-bottom: 15px; font-weight: 500; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; }

        /* --- BUILDER & ESSAY ZONE --- */
        .builder-panel {
            background: white; border-radius: 10px; padding: 20px; border-top: 4px solid var(--primary);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); flex-shrink: 0;
        }

        .controls { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap; }
        
        select.bank-select {
            padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 20px; 
            background: white; font-weight: bold; color: var(--text); cursor: pointer;
        }
        select.bank-select:hover { border-color: var(--primary); }

        /* Editable Sentence Staging Area */
        #sentence-stage {
            width: 98%; padding: 10px; border: 2px dashed #ccc; border-radius: 5px;
            font-size: 1.1rem; font-family: inherit; margin-bottom: 10px; min-height: 50px;
            background: #fafafa;
        }

        /* Final Essay Box */
        #essay-area {
            width: 98%; height: 150px; padding: 15px; border: 1px solid #ccc; border-radius: 5px;
            font-family: 'Segoe UI', sans-serif; font-size: 1rem; line-height: 1.6; resize: vertical;
            display: none; /* Hidden until content exists */
        }

        /* --- BUTTONS --- */
        .btn { padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: opacity 0.2s; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: var(--accent); }
        .btn-doc { background: #2b5797; } /* Word Blue */

        /* --- MODALS --- */
        .modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; 
        }
        .modal-content { 
            background: white; width: 90%; max-width: 900px; max-height: 90vh; 
            border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .modal-header { padding: 15px; background: #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-body { padding: 20px; overflow-y: auto; text-align: left; }

        /* Admin Styles */
        .input-group { margin-bottom: 15px; }
        .input-group label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; }
        .admin-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .bank-editor { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; background: #f5f5f5; padding: 15px; border-radius: 5px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-cubes"></i> Tone & Structure Architect</h1>
        <div>
            <select id="level-select" onchange="changeLevel()" style="padding:5px; border-radius:5px; border:1px solid #ccc;">
                <option value="1">Level 1: Foundation</option>
                <option value="2">Level 2: Developing</option>
                <option value="3">Level 3: Secure</option>
            </select>
            <button class="admin-btn" onclick="openAdmin()"><i class="fas fa-cog"></i> Settings</button>
        </div>
    </header>

    <div class="container">
        
        <div style="display:flex; justify-content:space-between; color:#607d8b; font-size:0.9rem;">
            <span><strong>Text:</strong> <span id="text-display">Loading...</span></span>
            <span><strong>Q:</strong> <span id="q-display">...</span></span>
        </div>

        <div id="stage-select" class="stage active">
            <div class="instruction">Choose Evidence to Analyze</div>
            <div class="grid" id="grid-main"></div>
        </div>

        <div id="stage-decoder" class="stage">
            <div class="instruction">Translation Bridge</div>
            <div style="background:#e0f2f1; padding:20px; border-radius:8px; margin-bottom:20px; font-size:1.2rem;">
                "<span id="decoder-quote"></span>"
            </div>
            <div class="grid" id="grid-decoder"></div>
        </div>

        <div id="stage-lens" class="stage">
            <div class="instruction">Select Analysis Lens</div>
            <div class="grid">
                <div class="card card-tone" onclick="loadAnalysis('tone')"><strong>üé≠ Tone</strong><small>Attitude & Feeling</small></div>
                <div class="card card-struct" onclick="loadAnalysis('structure')"><strong>üèóÔ∏è Structure</strong><small>Organization & Order</small></div>
                <div class="card card-lang" onclick="loadAnalysis('language')"><strong>üìñ Language</strong><small>Words & Imagery</small></div>
            </div>
        </div>

        <div id="stage-analysis" class="stage">
            <div class="instruction" id="analysis-prompt">...</div>
            <div class="grid" id="grid-analysis"></div>
        </div>

    </div>

    <div class="builder-panel">
        <div class="instruction" style="text-align:center;">Sentence Construction Zone</div>
        
        <div class="controls">
            <select id="sel-starter" class="bank-select" onchange="addScaffold('starter')">
                <option value="">üèÅ Sentence Starter</option>
            </select>
            <select id="sel-connect" class="bank-select" onchange="addScaffold('connect')">
                <option value="">üîó Connective</option>
            </select>
            <button class="btn btn-primary" onclick="commitSentence()">‚¨áÔ∏è Add to Essay</button>
        </div>

        <input type="text" id="sentence-stage" placeholder="Build your sentence here before adding to essay...">

        <textarea id="essay-area" placeholder="Your full essay will appear here..."></textarea>
        
        <div id="essay-controls" style="display:none; margin-top:10px; justify-content:flex-end; gap:10px;">
            <button class="btn btn-doc" onclick="downloadDoc()"><i class="fas fa-file-word"></i> Download .doc</button>
            <button class="btn btn-accent" onclick="clearEssay()">Clear</button>
        </div>
    </div>

    <div id="modal-admin" class="modal">
        <div class="modal-content">
            <div class="modal-header">Teacher Settings <button onclick="closeAdmin()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">&times;</button></div>
            <div class="modal-body">
                
                <div style="background:#e0f7fa; padding:15px; border-radius:5px; margin-bottom:20px; text-align:center;">
                    <button class="btn btn-primary" onclick="openWizard()">‚ú® Open AI Import Wizard</button>
                    <p style="margin:5px 0 0 0; font-size:0.8rem; color:#00695c;">Generate quotes & structure points automatically.</p>
                </div>

                <div class="bank-editor">
                    <div class="input-group">
                        <label>Sentence Starters (Comma separated)</label>
                        <textarea id="edit-starters" class="admin-input" rows="4" onchange="saveBanks()"></textarea>
                    </div>
                    <div class="input-group">
                        <label>Connectives (Comma separated)</label>
                        <textarea id="edit-connects" class="admin-input" rows="4" onchange="saveBanks()"></textarea>
                    </div>
                </div>

                <div class="input-group">
                    <label>Text Title</label>
                    <input id="edit-title" class="admin-input" onchange="updateGlobal('textTitle', this.value)">
                </div>
                <div class="input-group">
                    <label>Focus Question</label>
                    <input id="edit-question" class="admin-input" onchange="updateGlobal('question', this.value)">
                </div>

                <div style="margin-top:20px; border-top:1px solid #eee; padding-top:15px;">
                    <button class="btn btn-doc" onclick="downloadJSON()">üíæ Save Settings to File</button>
                    <button class="btn btn-doc" onclick="document.getElementById('file-up').click()">üìÇ Load Settings from File</button>
                    <input type="file" id="file-up" style="display:none;" onchange="uploadJSON(this)">
                </div>

            </div>
        </div>
    </div>

    <div id="modal-wizard" class="modal">
        <div class="modal-content" style="max-width:800px;">
            <div class="modal-header">AI Wizard <button onclick="closeWizard()" style="border:none;background:none;font-size:1.5rem;">&times;</button></div>
            <div class="modal-body">
                <p>1. Paste Text & Question.</p>
                <textarea id="wiz-text" class="admin-input" style="height:100px;" placeholder="Paste Text..."></textarea>
                <input id="wiz-q" class="admin-input" style="margin-top:10px;" placeholder="Question...">
                
                <p>2. Generate Prompt & Copy to ChatGPT.</p>
                <button class="btn btn-primary" onclick="genPrompt()">Generate Prompt</button>
                <textarea id="wiz-prompt" class="admin-input" style="height:80px; margin-top:5px; background:#f9f9f9;" readonly></textarea>
                
                <p>3. Paste ChatGPT Result.</p>
                <textarea id="wiz-json" class="admin-input" style="height:100px;" placeholder="Paste JSON here..."></textarea>
                
                <div style="margin-top:15px; text-align:right;">
                    <button class="btn btn-accent" onclick="loadWizardData()">üöÄ Load Lesson</button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- DEFAULT DATA ---
    const defaultData = {
        textTitle: "The Electric Telegraph (1851)",
        question: "How does the writer convey impact?",
        starters: ["The writer implies that", "This suggests", "It is evident that", "The author establishes", "Interestingly,"],
        connects: ["Furthermore,", "However,", "Consequently,", "In contrast,", "Significantly,"],
        items: [
            {
                id: "s1", type: "structure", label: "Opening vs Ending", detail: "Compare Para 1 (Wondrous) with Final Para (Revolution).",
                level1: { structure: { prompt: "How does it change?", correct: "Starts with surprise, ends with revolution.", options: ["Starts with surprise, ends with revolution.", "Stays the same."] } },
                level2: { structure: { prompt: "Moves from details to:", correct: "Global prediction", options: ["Global prediction", "Small story"] } },
                level3: { structure: { prompt: "Analyze structural arc:", correct: "Shifts from mechanism to societal revolution.", options: ["Shifts from mechanism to societal revolution.", "Focuses only on wires."] } }
            }
        ]
    };

    let appData = JSON.parse(JSON.stringify(defaultData));
    let state = { level: 1, currentIdx: 0 };

    // --- INIT ---
    function init() {
        const local = localStorage.getItem('tsa_v15');
        if(local) {
            try { 
                const parsed = JSON.parse(local);
                // Merge to ensure banks exist
                appData = { ...defaultData, ...parsed };
            } catch(e) { console.log("Resetting data"); }
        }
        updateUI();
        loadStageSelect();
    }

    function updateUI() {
        document.getElementById('text-display').innerText = appData.textTitle;
        document.getElementById('q-display').innerText = appData.question;
        
        // Populate Banks
        const sSel = document.getElementById('sel-starter');
        const cSel = document.getElementById('sel-connect');
        sSel.innerHTML = '<option value="">üèÅ Sentence Starter</option>';
        cSel.innerHTML = '<option value="">üîó Connective</option>';
        
        appData.starters.forEach(s => sSel.add(new Option(s, s)));
        appData.connects.forEach(c => cSel.add(new Option(c, c)));
    }

    function changeLevel() {
        state.level = parseInt(document.getElementById('level-select').value);
        loadStageSelect();
    }

    // --- STAGE LOGIC ---
    function showStage(id) {
        document.querySelectorAll('.stage').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function loadStageSelect() {
        showStage('stage-select');
        const grid = document.getElementById('grid-main');
        grid.innerHTML = '';
        
        if(!appData.items || appData.items.length === 0) {
            grid.innerHTML = '<p>No data. Go to Settings > Wizard.</p>';
            return;
        }

        appData.items.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = item.type === 'structure' ? 'card card-struct' : 'card card-lang';
            div.innerHTML = `<strong>${item.type === 'structure' ? 'üèóÔ∏è Structure' : 'üî§ Quote'}</strong>
                             <small>${item.type === 'structure' ? item.label : '"'+item.original+'"'}</small>`;
            div.onclick = () => startFlow(i);
            grid.appendChild(div);
        });
    }

    function startFlow(idx) {
        state.currentIdx = idx;
        const item = appData.items[idx];
        if(item.type === 'structure') {
            loadAnalysis('structure'); // Skip decoder for structure
        } else {
            loadDecoder();
        }
    }

    function loadDecoder() {
        showStage('stage-decoder');
        const item = appData.items[state.currentIdx];
        document.getElementById('decoder-quote').innerText = item.original;
        
        const grid = document.getElementById('grid-decoder');
        grid.innerHTML = '';
        
        const opts = [
            { txt: item.translation, correct: true },
            { txt: item.distractor, correct: false }
        ].sort(() => Math.random() - 0.5);

        opts.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'card';
            btn.innerText = opt.txt;
            btn.onclick = () => {
                if(opt.correct) {
                    addToBuilder(`The phrase "${item.original}" implies that ${item.translation}.`);
                    showStage('stage-lens');
                } else {
                    alert("Not quite. That interpretation doesn't fit the context.");
                }
            };
            grid.appendChild(btn);
        });
    }

    function loadAnalysis(lens) {
        const item = appData.items[state.currentIdx];
        const lvlKey = 'level' + state.level;
        
        if(!item[lvlKey] || !item[lvlKey][lens]) {
            if(item.type === 'structure' && lens !== 'structure') {
                alert("This is a structural point. Please choose 'Structure'.");
                return;
            }
            alert("No data for this level/lens."); 
            return; 
        }

        showStage('stage-analysis');
        const data = item[lvlKey][lens];
        document.getElementById('analysis-prompt').innerText = data.prompt;
        
        const grid = document.getElementById('grid-analysis');
        grid.innerHTML = '';
        
        const opts = [...data.options].sort(() => Math.random() - 0.5);
        opts.forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'card ' + (lens === 'tone' ? 'card-tone' : lens === 'structure' ? 'card-struct' : 'card-lang');
            btn.innerText = opt;
            btn.onclick = () => {
                if(opt === data.correct) {
                    // Smart append based on lens
                    let text = opt;
                    if(lens === 'structure') text = `Structurally, ${opt.toLowerCase()}`;
                    else if(lens === 'tone') text = `This creates a tone which ${opt.toLowerCase()}`;
                    addToBuilder(text);
                    loadStageSelect(); // Loop back
                } else {
                    alert("Try again. Look closer at the evidence.");
                }
            };
            grid.appendChild(btn);
        });
    }

    // --- BUILDER LOGIC ---
    function addScaffold(type) {
        const val = document.getElementById(type === 'starter' ? 'sel-starter' : 'sel-connect').value;
        if(val) addToBuilder(val);
        document.getElementById(type === 'starter' ? 'sel-starter' : 'sel-connect').value = "";
    }

    function addToBuilder(text) {
        const field = document.getElementById('sentence-stage');
        // Add space if needed
        const current = field.value;
        field.value = current + (current && !current.endsWith(' ') ? " " : "") + text;
    }

    function commitSentence() {
        const sent = document.getElementById('sentence-stage').value;
        if(!sent) return;
        
        const area = document.getElementById('essay-area');
        area.style.display = 'block';
        document.getElementById('essay-controls').style.display = 'flex';
        
        area.value += (area.value ? "\n\n" : "") + sent;
        document.getElementById('sentence-stage').value = ""; // Clear stage
    }

    function clearEssay() {
        if(confirm("Delete essay?")) {
            document.getElementById('essay-area').value = "";
            document.getElementById('essay-area').style.display = 'none';
            document.getElementById('essay-controls').style.display = 'none';
        }
    }

    function downloadDoc() {
        const text = document.getElementById('essay-area').value;
        const blob = new Blob(['<html><body>' + text.replace(/\n/g, '<br>') + '</body></html>'], {type:'application/msword'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Analysis.doc';
        a.click();
    }

    // --- ADMIN ---
    function openAdmin() {
        document.getElementById('modal-admin').style.display = 'flex';
        document.getElementById('edit-title').value = appData.textTitle;
        document.getElementById('edit-question').value = appData.question;
        document.getElementById('edit-starters').value = appData.starters.join(', ');
        document.getElementById('edit-connects').value = appData.connects.join(', ');
    }
    function closeAdmin() { document.getElementById('modal-admin').style.display = 'none'; }
    
    function updateGlobal(k, v) { appData[k] = v; saveLocal(); updateUI(); }
    
    function saveBanks() {
        appData.starters = document.getElementById('edit-starters').value.split(',').map(s=>s.trim()).filter(s=>s);
        appData.connects = document.getElementById('edit-connects').value.split(',').map(s=>s.trim()).filter(s=>s);
        saveLocal();
        updateUI();
    }

    function saveLocal() { localStorage.setItem('tsa_v15', JSON.stringify(appData)); }
    function downloadJSON() {
        const a = document.createElement('a');
        a.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(appData));
        a.download = 'architect_data.json';
        a.click();
    }
    function uploadJSON(input) {
        const fr = new FileReader();
        fr.onload = (e) => {
            appData = JSON.parse(e.target.result);
            saveLocal();
            openAdmin();
            updateUI();
        };
        fr.readAsText(input.files[0]);
    }

    // --- WIZARD ---
    function openWizard() { document.getElementById('modal-wizard').style.display = 'flex'; }
    function closeWizard() { document.getElementById('modal-wizard').style.display = 'none'; }
    
    function genPrompt() {
        const txt = document.getElementById('wiz-text').value;
        const q = document.getElementById('wiz-q').value;
        const prompt = `Act as a JSON generator for a GCSE English App.
Text: "${txt.substring(0,200)}..."
Question: "${q}"

Create 3 items. Mix of Quotes (Language/Tone) and Macro-Structure (Whole text shifts).
CRITICAL: Distractors must be PLAUSIBLE "Near-Misses". Analysis must be grammatically flowable.

Structure:
{
  "textTitle": "Title",
  "question": "${q}",
  "items": [
    {
      "id": "q1", "type": "quote", "original": "...", "translation": "...", "distractor": "...",
      "level1": { "tone": {"prompt":"Q","correct":"A","options":["A","B"]} },
      "level2": { ... },
      "level3": { ... }
    }
  ]
}`;
        document.getElementById('wiz-prompt').value = prompt;
        document.getElementById('wiz-prompt').select();
        document.execCommand('copy');
        alert("Prompt copied!");
    }

    function loadWizardData() {
        try {
            const json = JSON.parse(document.getElementById('wiz-json').value);
            if(json.items) {
                appData.items = json.items;
                appData.textTitle = json.textTitle || appData.textTitle;
                appData.question = json.question || appData.question;
                saveLocal();
                updateUI();
                closeWizard();
                closeAdmin();
                loadStageSelect();
                alert("Lesson Loaded!");
            }
        } catch(e) { alert("Invalid JSON"); }
    }

    init();
</script>
</body>
</html>
