<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone, Structure & Language Architect</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #2c3e50; 
            --accent: #e67e22;
            --tone-col: #e91e63; /* Pink for Tone */
            --struct-col: #2980b9; /* Blue for Structure */
            --lang-col: #27ae60; /* Green for Language */
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-dyslexic: 'Comic Sans MS', sans-serif;
        }

        body { 
            font-family: var(--font-main); 
            background-color: var(--bg); color: #333; margin: 0; padding: 20px; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; text-align: center;
        }
        body.dyslexia-mode { font-family: var(--font-dyslexic); line-height: 1.6; }

        /* --- HEADER & NAV --- */
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding-bottom: 10px; border-bottom: 2px solid #ddd; flex-shrink: 0; 
        }
        h1 { margin: 0; color: var(--primary); font-size: 1.5rem; }
        
        .admin-btn { 
            font-size: 1.5rem; color: #555; background: white; border: 2px solid var(--accent); 
            border-radius: 50%; width: 45px; height: 45px; cursor: pointer; transition: all 0.2s;
        }
        .admin-btn:hover { transform: scale(1.1); background: #fff8f0; }

        /* --- CONTAINER --- */
        .container { 
            flex-grow: 1; max-width: 1000px; width: 100%; margin: 20px auto; background: white; 
            border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); padding: 20px; 
            display: flex; flex-direction: column; overflow-y: auto; position: relative;
        }

        /* --- GAME STAGES --- */
        .stage-area { display: none; animation: fadeIn 0.4s; flex-grow: 1; text-align: center; }
        .stage-area.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-top: 20px; }
        
        button.choice-btn { 
            padding: 20px; border: 2px solid #eee; border-radius: 10px; font-size: 1.1rem; 
            cursor: pointer; background: white; transition: all 0.2s; color: #333;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
        }
        button.choice-btn:hover { transform: translateY(-3px); border-color: var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        /* Category Buttons */
        .btn-tone { border-bottom: 5px solid var(--tone-col); }
        .btn-struct { border-bottom: 5px solid var(--struct-col); }
        .btn-lang { border-bottom: 5px solid var(--lang-col); }
        
        .btn-tone:hover { background: #fce4ec; }
        .btn-struct:hover { background: #e3f2fd; }
        .btn-lang:hover { background: #e8f5e9; }

        /* --- BUILDER & ESSAY --- */
        #sentence-builder { 
            margin-top: 20px; padding: 15px; background: #f8f9fa; border: 2px dashed #ccc; 
            border-radius: 8px; min-height: 60px; font-size: 1.1rem; color: #555;
        }
        .fragment { padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); margin: 0 3px; display: inline-block;}
        
        #essay-display {
            display: none; margin-top: 20px; padding: 20px; background: #fff; border: 1px solid #ddd;
            border-left: 5px solid #f1c40f; border-radius: 8px; text-align: left; max-height: 150px; overflow-y: auto;
        }

        /* --- ADMIN PANEL --- */
        #admin-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; 
        }
        .admin-panel { 
            background: white; width: 95%; max-width: 1200px; height: 90%; border-radius: 8px; 
            display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
        }
        .panel-body { padding: 20px; overflow-y: auto; flex-grow: 1; text-align: left; }
        
        /* Admin Tabs */
        .tab-nav { display: flex; border-bottom: 1px solid #ccc; margin-bottom: 15px; }
        .tab-btn { 
            padding: 10px 20px; cursor: pointer; border: none; background: #eee; margin-right: 5px; border-radius: 5px 5px 0 0; 
        }
        .tab-btn.active { background: white; border: 1px solid #ccc; border-bottom: 2px solid white; font-weight: bold; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        .editor-section { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .input-row { margin-bottom: 10px; }
        .input-row label { display: block; font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; }
        .admin-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }

        /* --- OVERLAYS --- */
        #overlay-msg { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(44, 62, 80, 0.95); z-index: 3000; color: white;
            flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <h1 id="app-title">Tone & Structure Architect</h1>
            <select id="level-select" onchange="changeLevel()" style="padding:5px; border-radius:5px; border:1px solid #ccc;">
                <option value="1">Level 1: Foundation</option>
                <option value="2">Level 2: Intermediate</option>
                <option value="3">Level 3: Advanced</option>
            </select>
        </div>
        <button class="admin-btn" onclick="openAdmin()" title="Settings"><i class="fas fa-cog"></i></button>
    </header>

    <div class="container">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold; color:#7f8c8d;">
            <span id="text-display">Text: Loading...</span>
            <span>Streak: <span id="streak-val">0</span></span>
        </div>

        <div id="stage-quote" class="stage-area active">
            <h2>Select Evidence</h2>
            <p>Choose a quote to analyze.</p>
            <div class="grid" id="quote-grid"></div>
        </div>

        <div id="stage-decoder" class="stage-area">
            <h2>Translation Bridge</h2>
            <p>What does this mean in modern English?</p>
            <div style="background:#fff3e0; padding:15px; margin-bottom:20px; font-style:italic; font-size:1.2rem;">
                "<span id="decoder-original"></span>"
            </div>
            <div class="grid" id="decoder-grid"></div>
        </div>

        <div id="stage-lens" class="stage-area">
            <h2>Choose Analysis Lens</h2>
            <p>Which feature do you want to focus on?</p>
            <div class="grid">
                <button class="choice-btn btn-tone" onclick="loadAnalysis('tone')">
                    <i class="fas fa-theater-masks fa-2x" style="color:var(--tone-col)"></i>
                    <strong>Tone / Mood</strong>
                    <small>Feelings & Atmosphere</small>
                </button>
                <button class="choice-btn btn-struct" onclick="loadAnalysis('structure')">
                    <i class="fas fa-layer-group fa-2x" style="color:var(--struct-col)"></i>
                    <strong>Structure</strong>
                    <small>Order & Shifts</small>
                </button>
                <button class="choice-btn btn-lang" onclick="loadAnalysis('language')">
                    <i class="fas fa-book-open fa-2x" style="color:var(--lang-col)"></i>
                    <strong>Language</strong>
                    <small>Words & Imagery</small>
                </button>
            </div>
        </div>

        <div id="stage-analysis" class="stage-area">
            <h2 id="analysis-title">Analysis</h2>
            <p id="analysis-prompt">...</p>
            <div class="grid" id="analysis-grid"></div>
        </div>

        <div id="sentence-builder"><span style="color:#ccc;">Paragraph builds here...</span></div>

        <div id="essay-display">
            <h3>Your Essay:</h3>
            <div id="essay-content"></div>
            <button onclick="clearEssay()" style="margin-top:10px; background:#e74c3c; color:white; border:none; padding:5px 10px; cursor:pointer;">Clear</button>
        </div>
    </div>

    <div id="overlay-msg" onclick="this.style.display='none'">
        <i id="overlay-icon" class="fas fa-check-circle" style="font-size:4rem; margin-bottom:20px;"></i>
        <h2 id="overlay-text">Correct!</h2>
    </div>

    <div id="admin-modal">
        <div class="admin-panel">
            <div style="padding:15px; background:#eee; display:flex; justify-content:space-between; align-items:center;">
                <strong>Teacher Settings</strong>
                <button onclick="closeAdmin()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div class="panel-body">
                
                <div style="margin-bottom:20px; padding:15px; background:#e3f2fd; border-radius:5px;">
                    <h3>ðŸ’¾ Data & Worksheet</h3>
                    <button class="choice-btn" style="padding:5px 15px; display:inline-block;" onclick="downloadData()">Save Data</button>
                    <button class="choice-btn" style="padding:5px 15px; display:inline-block;" onclick="document.getElementById('file-in').click()">Load Data</button>
                    <input type="file" id="file-in" style="display:none" onchange="loadData(this)">
                    <hr>
                    <label><strong>Print Worksheet for Level:</strong></label>
                    <select id="print-level" style="padding:5px;"><option value="1">Level 1</option><option value="2">Level 2</option><option value="3">Level 3</option></select>
                    <button class="choice-btn" style="padding:5px 15px; background:var(--primary); color:white; display:inline-block;" onclick="printWorksheet()">Generate PDF</button>
                </div>

                <div class="input-row">
                    <label>Text Title:</label>
                    <input id="edit-title" class="admin-input" onchange="updateGlobal('textTitle', this.value)">
                </div>

                <h3>Quote Editor</h3>
                <div id="quote-editor-container"></div>
                <button class="choice-btn" style="width:100%; background:#27ae60; color:white;" onclick="addQuote()">+ Add New Quote</button>
            </div>
        </div>
    </div>

<script>
    // ==========================================
    // 1. DATA STRUCTURE
    // ==========================================
    var defaultData = {
        textTitle: "The Electric Telegraph (1851)",
        quotes: [
            {
                id: "q1",
                original: "a wondrous invention",
                translation: "an amazing machine",
                distractor: "a boring tool",
                level1: {
                    tone: { prompt: "Is the tone happy or sad?", correct: "Happy / Excited", options: ["Happy / Excited", "Sad / Bored"] },
                    structure: { prompt: "Where is this in the text?", correct: "At the start", options: ["At the start", "At the end"] },
                    language: { prompt: "Which word means 'amazing'?", correct: "Wondrous", options: ["Wondrous", "Invention"] }
                },
                level2: {
                    tone: { prompt: "Select the best description of the tone.", correct: "Awe and Admiration", options: ["Awe and Admiration", "Fear and Panic", "Boredom"] },
                    structure: { prompt: "Why place this at the start?", correct: "To grab attention immediately", options: ["To grab attention immediately", "To confuse the reader", "To conclude the argument"] },
                    language: { prompt: "What technique is 'wondrous invention'?", correct: "Emotive Adjective", options: ["Emotive Adjective", "Simile", "Personification"] }
                },
                level3: {
                    tone: { prompt: "Analyze the nuance of the tone.", correct: "It establishes a tone of reverent wonder.", options: ["It establishes a tone of reverent wonder.", "It suggests cautious optimism.", "It implies sarcasm."] },
                    structure: { prompt: "Analyze the structural positioning.", correct: "Opening with this establishes the positive bias of the article.", options: ["Opening with this establishes the positive bias.", "It contradicts the ending.", "It acts as a flashback."] },
                    language: { prompt: "Analyze the lexical choice.", correct: "The adjective 'wondrous' elevates the machine to something magical.", options: ["The adjective 'wondrous' elevates the machine.", "It is a technical term.", "It is an understatement."] }
                }
            }
        ]
    };

    var appData = JSON.parse(JSON.stringify(defaultData));
    var state = { level: 1, currentQuoteIdx: 0, buffer: {}, streak: 0 };

    // ==========================================
    // 2. CORE LOGIC
    // ==========================================
    
    function init() {
        var local = localStorage.getItem('tsa_data_v2');
        if(local) try { appData = JSON.parse(local); } catch(e) {}
        updateDOM();
        loadStage1();
    }

    function changeLevel() {
        state.level = parseInt(document.getElementById('level-select').value);
        state.streak = 0;
        updateDOM();
        loadStage1();
    }

    function updateDOM() {
        document.getElementById('text-display').innerText = "Text: " + appData.textTitle;
        document.getElementById('streak-val').innerText = state.streak;
    }

    // STAGE 1: QUOTE SELECT
    function loadStage1() {
        showStage('stage-quote');
        var grid = document.getElementById('quote-grid');
        grid.innerHTML = '';
        appData.quotes.forEach((q, i) => {
            var btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerHTML = `"${q.original}"`;
            btn.onclick = () => startFlow(i);
            grid.appendChild(btn);
        });
        state.buffer = {};
        updateBuilder();
    }

    function startFlow(idx) {
        state.currentQuoteIdx = idx;
        loadStage2();
    }

    // STAGE 2: DECODER
    function loadStage2() {
        showStage('stage-decoder');
        var q = appData.quotes[state.currentQuoteIdx];
        document.getElementById('decoder-original').innerText = q.original;
        
        var grid = document.getElementById('decoder-grid');
        grid.innerHTML = '';
        
        var opts = [
            { txt: q.translation, correct: true },
            { txt: q.distractor, correct: false }
        ].sort(() => Math.random() - 0.5);

        opts.forEach(opt => {
            var btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerText = opt.txt;
            btn.onclick = () => handleDecoder(opt.correct, btn, q.original, q.translation);
            grid.appendChild(btn);
        });
    }

    function handleDecoder(correct, btn, orig, trans) {
        if(correct) {
            feedback(true, "Spot on!");
            state.buffer.part1 = `The writer uses the phrase "${orig}"`;
            state.buffer.part2 = `(which means ${trans}).`;
            updateBuilder();
            setTimeout(() => showStage('stage-lens'), 1000);
        } else {
            feedback(false, "Try again.");
            state.streak = 0;
            updateDOM();
        }
    }

    // STAGE 3: ANALYSIS (Based on Lens & Level)
    function loadAnalysis(lens) {
        showStage('stage-analysis');
        var q = appData.quotes[state.currentQuoteIdx];
        var lvlKey = 'level' + state.level;
        var data = q[lvlKey][lens]; // Access nested data: q.level1.tone

        document.getElementById('analysis-title').innerText = "Analyzing " + lens.charAt(0).toUpperCase() + lens.slice(1);
        document.getElementById('analysis-prompt').innerText = data.prompt;

        var grid = document.getElementById('analysis-grid');
        grid.innerHTML = '';

        // Shuffle options
        var opts = [...data.options].sort(() => Math.random() - 0.5);
        
        opts.forEach(opt => {
            var btn = document.createElement('button');
            btn.className = 'choice-btn';
            if(lens === 'tone') btn.classList.add('btn-tone');
            if(lens === 'structure') btn.classList.add('btn-struct');
            if(lens === 'language') btn.classList.add('btn-lang');
            
            btn.innerText = opt;
            btn.onclick = () => handleAnalysis(opt === data.correct, btn, opt);
            grid.appendChild(btn);
        });
    }

    function handleAnalysis(correct, btn, text) {
        if(correct) {
            feedback(true, "Analysis Complete!");
            state.buffer.part3 = text;
            updateBuilder();
            addToEssay();
            state.streak++;
            updateDOM();
            setTimeout(loadStage1, 1500);
        } else {
            feedback(false, "Think closer...");
            state.streak = 0;
            updateDOM();
        }
    }

    // ==========================================
    // 3. UI HELPERS
    // ==========================================
    function showStage(id) {
        document.querySelectorAll('.stage-area').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function updateBuilder() {
        var h = "";
        if(state.buffer.part1) h += `<span class="fragment" style="background:#e3f2fd">${state.buffer.part1}</span> `;
        if(state.buffer.part2) h += `<span class="fragment" style="background:#fff3e0">${state.buffer.part2}</span> `;
        if(state.buffer.part3) h += `<span class="fragment" style="background:#e8f5e9">${state.buffer.part3}</span>`;
        document.getElementById('sentence-builder').innerHTML = h || "<span style='color:#ccc'>Paragraph builds here...</span>";
    }

    function addToEssay() {
        var text = Object.values(state.buffer).join(" ");
        var div = document.getElementById('essay-content');
        div.innerHTML += `<p>${text}</p>`;
        document.getElementById('essay-display').style.display = 'block';
    }

    function clearEssay() {
        document.getElementById('essay-content').innerHTML = '';
        document.getElementById('essay-display').style.display = 'none';
    }

    function feedback(success, txt) {
        var ol = document.getElementById('overlay-msg');
        var icon = document.getElementById('overlay-icon');
        var text = document.getElementById('overlay-text');
        
        ol.style.display = 'flex';
        text.innerText = txt;
        if(success) {
            ol.style.background = 'rgba(39, 174, 96, 0.9)';
            icon.className = 'fas fa-check-circle';
        } else {
            ol.style.background = 'rgba(192, 57, 43, 0.9)';
            icon.className = 'fas fa-times-circle';
        }
        setTimeout(() => ol.style.display = 'none', 1000);
    }

    // ==========================================
    // 4. ADMIN & WORKSHEET
    // ==========================================
    function openAdmin() { 
        document.getElementById('admin-modal').style.display = 'flex'; 
        document.getElementById('edit-title').value = appData.textTitle;
        renderEditor(); 
    }
    function closeAdmin() { 
        document.getElementById('admin-modal').style.display = 'none'; 
        localStorage.setItem('tsa_data_v2', JSON.stringify(appData));
        updateDOM();
        loadStage1();
    }
    
    function updateGlobal(k, v) { appData[k] = v; }

    function renderEditor() {
        var con = document.getElementById('quote-editor-container');
        con.innerHTML = '';
        
        appData.quotes.forEach((q, i) => {
            var div = document.createElement('div');
            div.className = 'editor-section';
            
            // Build the complicated HTML for nested levels
            var levelsHTML = '';
            [1, 2, 3].forEach(lvl => {
                var k = 'level'+lvl;
                levelsHTML += `
                    <div style="background:#f9f9f9; padding:10px; margin-top:5px; border:1px solid #eee;">
                        <strong>Level ${lvl} Settings</strong>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                            ${renderFieldBlock(i, lvl, 'tone', 'Tone')}
                            ${renderFieldBlock(i, lvl, 'structure', 'Struct')}
                            ${renderFieldBlock(i, lvl, 'language', 'Lang')}
                        </div>
                    </div>`;
            });

            div.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <strong>Quote #${i+1}</strong> 
                    <button onclick="delQuote(${i})" style="color:red;border:none;">Del</button>
                </div>
                <div class="input-row"><label>Original:</label><input class="admin-input" value="${q.original}" onchange="editQ(${i}, 'original', this.value)"></div>
                <div class="input-row"><label>Translation:</label><input class="admin-input" value="${q.translation}" onchange="editQ(${i}, 'translation', this.value)"></div>
                ${levelsHTML}
            `;
            con.appendChild(div);
        });
    }

    function renderFieldBlock(qIdx, lvl, type, label) {
        var k = 'level'+lvl;
        var val = appData.quotes[qIdx][k][type];
        // We just show the Correct Answer field for brevity in this UI, 
        // realistically you'd want fields for Prompt + Options too.
        // For this demo, we edit the "Correct Answer" which updates the logic.
        return `
            <div>
                <label style="font-size:0.8rem; color:gray;">${label} Answer</label>
                <input class="admin-input" style="font-size:0.8rem" value="${val.correct}" onchange="editDeep(${qIdx}, ${lvl}, '${type}', 'correct', this.value)">
            </div>
        `;
    }

    function editQ(i, k, v) { appData.quotes[i][k] = v; }
    function editDeep(i, lvl, type, field, v) {
        var key = 'level'+lvl;
        appData.quotes[i][key][type][field] = v;
        // Auto-update options to include the new correct answer
        if(!appData.quotes[i][key][type].options.includes(v)) {
            appData.quotes[i][key][type].options[0] = v; 
        }
    }
    
    function addQuote() {
        var blankLvl = {
            tone: { prompt: "Tone?", correct: "Ans", options: ["Ans", "Dist"] },
            structure: { prompt: "Struct?", correct: "Ans", options: ["Ans", "Dist"] },
            language: { prompt: "Lang?", correct: "Ans", options: ["Ans", "Dist"] }
        };
        appData.quotes.push({
            id: Date.now(), original: "New", translation: "Trans", distractor: "Bad",
            level1: JSON.parse(JSON.stringify(blankLvl)),
            level2: JSON.parse(JSON.stringify(blankLvl)),
            level3: JSON.parse(JSON.stringify(blankLvl))
        });
        renderEditor();
    }
    function delQuote(i) { appData.quotes.splice(i,1); renderEditor(); }

    function downloadData() {
        var a = document.createElement('a');
        a.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(appData));
        a.download = 'tsa_data.json';
        a.click();
    }
    function loadData(input) {
        var fr = new FileReader();
        fr.onload = (e) => { appData = JSON.parse(e.target.result); renderEditor(); updateDOM(); loadStage1(); };
        fr.readAsText(input.files[0]);
    }

    function printWorksheet() {
        var lvl = document.getElementById('print-level').value;
        var w = window.open();
        var h = `<html><head><title>Worksheet Level ${lvl}</title>
        <style>body{font-family:sans-serif; padding:20px;} table{width:100%; border-collapse:collapse; margin-bottom:20px;} td,th{border:1px solid #333; padding:10px; text-align:left;} .box{border:1px dashed #999; height:50px; background:#f9f9f9;}</style>
        </head><body>
        <h1>Analysis Worksheet: ${appData.textTitle}</h1>
        <h3>Level ${lvl} Focus</h3>
        
        <h4>Task 1: Decoding</h4>
        <table><tr><th>Quote</th><th>Meaning</th></tr>
        ${appData.quotes.map(q => `<tr><td>"${q.original}"</td><td>__________________</td></tr>`).join('')}
        </table>
        
        <h4>Task 2: Targeted Analysis</h4>
        ${appData.quotes.map((q, i) => {
            var lData = q['level'+lvl];
            return `
                <div style="border:1px solid #ccc; padding:15px; margin-bottom:15px; break-inside:avoid;">
                    <strong>${i+1}. "${q.original}"</strong><br><br>
                    <strong>Tone:</strong> ${lData.tone.prompt}<br>
                    <div class="box"></div><br>
                    <strong>Structure:</strong> ${lData.structure.prompt}<br>
                    <div class="box"></div><br>
                    <strong>Language:</strong> ${lData.language.prompt}<br>
                    <div class="box"></div>
                </div>
            `;
        }).join('')}
        </body></html>`;
        w.document.write(h);
        w.print();
        w.close();
    }

    init();
</script>
</body>
</html>
