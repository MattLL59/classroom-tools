<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tone & Structure Architect v67 (Two-Hub Design)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #009688; 
            --accent: #ff9800; 
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #37474f;
            --tone-col: #9c27b0;
            --struct-col: #2196f3;
            --lang-col: #4caf50;
            --nav-bg: #ffffff;
        }

        body.theme-dyslexia { --bg: #fdf5e6; --text: #222; --card: #fffcf5; font-family: 'Comic Sans MS', 'Verdana', sans-serif; }
        body.theme-contrast { --bg: #000; --text: #ffff00; --card: #222; --primary: #ffff00; --accent: #00ffff; }

        body { 
            font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); 
            margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden;
        }

        /* FIXED HEADER */
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 15px; background: var(--card); box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }
        h1 { margin: 0; font-size: 1.1rem; color: var(--primary); }

        /* VIEWPORT CONTAINER */
        .main-viewport {
            flex-grow: 1;
            overflow-y: auto;
            padding: 15px;
            padding-bottom: 80px; /* Room for bottom nav */
        }

        /* BOTTOM NAVIGATION */
        nav.bottom-nav {
            position: fixed; bottom: 0; left: 0; width: 100%;
            height: 65px; background: var(--nav-bg);
            display: flex; justify-content: space-around; align-items: center;
            border-top: 1px solid #ddd; box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            z-index: 1000;
        }
        .nav-item {
            flex: 1; display: flex; flex-direction: column; align-items: center;
            color: #888; font-size: 0.75rem; cursor: pointer; border: none; background: none;
        }
        .nav-item i { font-size: 1.3rem; margin-bottom: 3px; }
        .nav-item.active { color: var(--primary); font-weight: bold; }

        /* HUB DISPLAY LOGIC */
        .hub { display: none; }
        .hub.active { display: block; animation: fadeIn 0.3s; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* CARDS & GRIDS */
        .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media(min-width: 600px) { .grid { grid-template-columns: 1fr 1fr; } }

        .card { 
            background: var(--card); padding: 20px; border-radius: 12px; border: 2px solid #ddd;
            text-align: center; font-size: 1.1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            color: var(--text);
        }
        .card-tone { border-left: 10px solid var(--tone-col); }
        .card-struct { border-left: 10px solid var(--struct-col); text-align: left; }
        .card-lang { border-left: 10px solid var(--lang-col); }

        /* WRITING DESK STYLING */
        .bank-list { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
        .bank-row { text-align: left; }
        .bank-label { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; color: var(--primary); margin-left: 5px; }
        
        select.bank-select { 
            width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ccc;
            background: var(--card); color: var(--text); font-size: 1rem;
        }

        #sentence-stage { 
            width: 100%; padding: 15px; background: #fff; border: 2px dashed var(--primary); 
            border-radius: 10px; margin: 15px 0; font-size: 1.1rem; min-height: 50px;
            box-sizing: border-box; color: #333;
        }

        #answer-area { 
            width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; 
            border-radius: 8px; background: var(--bg); color: var(--text); font-family: inherit;
        }

        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
        .btn-primary { background: var(--primary); width: 100%; }
        .btn-warning { background: var(--accent); }

        /* BADGES */
        .badge-bar { display: flex; gap: 10px; justify-content: center; margin-bottom: 10px; }
        .badge { font-size: 1.4rem; color: #ccc; }
        .badge.earned { color: var(--accent); }
    </style>
</head>
<body>

    <header>
        <h1>Architect v67</h1>
        <div style="display:flex; gap:10px;">
            <button class="admin-btn" style="background:none; border:none; color:var(--text);" onclick="openThemeModal()"><i class="fas fa-palette"></i></button>
            <select id="level-select" onchange="changeLevel()" style="padding:4px; border-radius:4px;">
                <option value="1">L1</option><option value="2">L2</option><option value="3">L3</option>
            </select>
            <button id="admin-btn" class="admin-btn" onclick="requestAdminAccess()"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div class="main-viewport">
        
        <div id="hub-lab" class="hub active">
            <div class="badge-bar">
                <i id="badge-1" class="fas fa-medal badge"></i>
                <i id="badge-2" class="fas fa-award badge"></i>
                <i id="badge-3" class="fas fa-trophy badge"></i>
            </div>
            
            <div id="lab-content">
                <div class="instruction">Step 1: Choose Evidence</div>
                <div class="grid" id="grid-main"></div>
            </div>
        </div>

        <div id="hub-writing" class="hub">
            <div class="instruction">Sentence Construction</div>
            
            <div class="bank-list" id="dynamic-builder-controls">
                </div>

            <div class="instruction">Current Construction:</div>
            <div id="sentence-stage">Start picking words in the Lab...</div>

            <div style="display:flex; gap:10px;">
                <button class="btn btn-warning" style="flex:1" onclick="undoLast()">Undo</button>
                <button class="btn btn-primary" style="flex:2" onclick="commitSentence()">Add to Answer</button>
            </div>

            <hr style="margin:20px 0; opacity:0.1;">
            
            <textarea id="answer-area" placeholder="Your full answer will appear here..."></textarea>
            <button class="btn btn-primary" style="background:#2b5797; margin-top:10px;" onclick="downloadDoc()">Download .doc</button>
        </div>

    </div>

    <nav class="bottom-nav">
        <button id="nav-lab" class="nav-item active" onclick="switchHub('lab')">
            <i class="fas fa-vial"></i>
            <span>Evidence Lab</span>
        </button>
        <button id="nav-writing" class="nav-item" onclick="switchHub('writing')">
            <i class="fas fa-pen-fancy"></i>
            <span>Writing Desk</span>
        </button>
    </nav>

    <div id="theme-modal" class="modal">
        <div class="modal-content" style="max-width:300px;">
            <div class="modal-header">Themes</div>
            <div class="modal-body">
                <button class="btn btn-primary" style="margin-bottom:5px;" onclick="setTheme('default')">Default</button>
                <button class="btn btn-primary" style="margin-bottom:5px; background:#fdf5e6; color:#333;" onclick="setTheme('dyslexia')">Cream (Dyslexia)</button>
                <button class="btn btn-primary" style="background:#000; color:#ff0;" onclick="setTheme('contrast')">High Contrast</button>
            </div>
        </div>
    </div>

    <div id="phrasing-overlay" class="modal">
        <div class="modal-content">
            <div class="modal-header">How should we phrase this?</div>
            <div class="modal-body" id="phrase-options"></div>
        </div>
    </div>

<script>
    /* DATA_START */ const teacherConfig = null; /* DATA_END */

    // Morphology logic (Abbreviated for performance)
    const wordMorphology = { "admiring":{adj:"admiring",noun:"admiration"}, "angry":{adj:"angry",noun:"anger"}, "chaotic":{adj:"chaotic",noun:"chaos"} };

    const defaultData = {
        textTitle: "New Lesson", adminPassword: "1234",
        sentenceOrder: ['starter', 'quote', 'point', 'analysis'],
        analysisTemplates: { tone: ["creates a {adj} tone", "evokes {noun}"], structure: ["highlights {noun}"], language: ["suggests {noun}"] },
        starters: ["The writer implies", "This suggests"], points: ["a sense of danger"], methods: ["metaphor"],
        items: [{ id: "q1", type: "quote", original: "darkness fell", translation: "it got dark", distractors: ["it was bright"], level1: { tone: { prompt:"Feeling?", correct:"Ominous", options:["Ominous","Happy"] } } }]
    };

    let appData = JSON.parse(JSON.stringify(defaultData));
    let state = { level: 1, currentIdx: -1, completedCount: 0 };
    let sentenceSlots = { starter:"", point:"", method:"", quote:"", analysis:"" };

    function init() {
        if (teacherConfig) { appData = teacherConfig; document.getElementById('admin-btn').style.display='none'; }
        loadStageSelect();
        renderBuilderDropdowns();
    }

    // HUB NAVIGATION
    function switchHub(hubId) {
        document.querySelectorAll('.hub').forEach(h => h.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('hub-' + hubId).classList.add('active');
        document.getElementById('nav-' + hubId).classList.add('active');
    }

    // LAB LOGIC
    function loadStageSelect() {
        const grid = document.getElementById('grid-main');
        grid.innerHTML = '';
        appData.items.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = `card card-${item.type || 'tone'}`;
            div.innerHTML = `<strong>"${item.original}"</strong>`;
            div.onclick = () => startAnalysis(i);
            grid.appendChild(div);
        });
    }

    function startAnalysis(idx) {
        state.currentIdx = idx;
        const item = appData.items[idx];
        const lab = document.getElementById('lab-content');
        lab.innerHTML = `<div class="instruction">Step 2: Meaning of "${item.original}"</div><div class="grid" id="grid-decoder"></div>`;
        
        let opts = [{txt: item.translation, correct: true}, ...item.distractors.map(d => ({txt:d, correct:false}))];
        opts.sort(() => Math.random() - 0.5).forEach(o => {
            const btn = document.createElement('div');
            btn.className = 'card';
            btn.innerText = o.txt;
            btn.onclick = () => { 
                if(o.correct) { 
                    sentenceSlots.quote=`"${item.original}"`; 
                    loadLensChoice();
                } else alert("Try again!");
            };
            document.getElementById('grid-decoder').appendChild(btn);
        });
    }

    function loadLensChoice() {
        const lab = document.getElementById('lab-content');
        lab.innerHTML = `<div class="instruction">Step 3: Choose Lens</div>
            <div class="grid">
                <div class="card card-tone" onclick="loadFinalAnalysis('tone')">üé≠ Tone</div>
                <div class="card card-struct" onclick="loadFinalAnalysis('structure')">üèóÔ∏è Structure</div>
                <div class="card card-lang" onclick="loadFinalAnalysis('language')">üìñ Language</div>
            </div>`;
    }

    function loadFinalAnalysis(lens) {
        const item = appData.items[state.currentIdx];
        const data = item[`level${state.level}`] ? item[`level${state.level}`][lens] : null;
        if (!data) { alert("No data for this level."); return loadStageSelect(); }
        
        const lab = document.getElementById('lab-content');
        lab.innerHTML = `<div class="instruction">${data.prompt}</div><div class="grid" id="grid-analysis"></div>`;
        
        data.options.forEach(o => {
            const btn = document.createElement('div');
            btn.className = `card card-${lens}`;
            btn.innerText = o;
            btn.onclick = () => { 
                if(o === data.correct) showPhrasingChoices(lens, o); 
                else alert("Try again!");
            };
            document.getElementById('grid-analysis').appendChild(btn);
        });
    }

    function showPhrasingChoices(lens, word) {
        const modal = document.getElementById('phrasing-overlay');
        const container = document.getElementById('phrase-options');
        modal.style.display = 'flex';
        container.innerHTML = '';

        appData.analysisTemplates[lens].forEach(tmpl => {
            let adj = wordMorphology[word.toLowerCase()]?.adj || word;
            let noun = wordMorphology[word.toLowerCase()]?.noun || word;
            let text = tmpl.replace("{adj}", adj).replace("{noun}", noun).replace("{word}", word);
            
            const div = document.createElement('div');
            div.className = 'phrase-option';
            div.innerText = text;
            div.onclick = () => {
                sentenceSlots.analysis = text;
                modal.style.display = 'none';
                rebuildSentence();
                alert("Added to Writing Desk!");
                switchHub('writing');
                loadStageSelect();
            };
            container.appendChild(div);
        });
    }

    // WRITING DESK LOGIC
    function renderBuilderDropdowns() {
        const container = document.getElementById('dynamic-builder-controls');
        container.innerHTML = '';
        appData.sentenceOrder.forEach(type => {
            if (['quote', 'analysis'].includes(type)) return;
            const div = document.createElement('div');
            div.className = 'bank-row';
            div.innerHTML = `<span class="bank-label">${type}</span>
                <select class="bank-select" onchange="sentenceSlots['${type}']=this.value; rebuildSentence();">
                    <option value="">Choose...</option>
                    ${(appData[type+'s'] || []).map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                </select>`;
            container.appendChild(div);
        });
    }

    function rebuildSentence() {
        let parts = [];
        appData.sentenceOrder.forEach(type => { if(sentenceSlots[type]) parts.push(sentenceSlots[type]); });
        let str = parts.join(" ");
        if(str) str = str.charAt(0).toUpperCase() + str.slice(1);
        document.getElementById('sentence-stage').innerText = str || "Start picking words in the Lab...";
    }

    function commitSentence() {
        const text = document.getElementById('sentence-stage').innerText;
        if (text.includes("Start picking")) return;
        const area = document.getElementById('answer-area');
        area.style.display = 'block';
        document.getElementById('essay-controls').style.display = 'flex';
        area.value += (area.value ? "\n\n" : "") + text;
        sentenceSlots = { starter:"", point:"", method:"", quote:"", analysis:"" };
        rebuildSentence();
        state.completedCount++;
        updateBadges();
        switchHub('lab');
    }

    function undoLast() { sentenceSlots.analysis = ""; rebuildSentence(); }
    
    function updateBadges() {
        if(state.completedCount >= 1) document.getElementById('badge-1').classList.add('earned');
        if(state.completedCount >= 3) document.getElementById('badge-2').classList.add('earned');
        if(state.completedCount >= 5) document.getElementById('badge-3').classList.add('earned');
    }

    // UTILS
    function openThemeModal() { document.getElementById('theme-modal').style.display='flex'; }
    function setTheme(t) { document.body.className = t==='default' ? '' : 'theme-'+t; document.getElementById('theme-modal').style.display='none'; }
    function requestAdminAccess() { if(prompt("Password:") === appData.adminPassword) alert("Editor functions would go here as per previous versions."); }
    function downloadDoc() { const blob = new Blob(['<html><body>'+document.getElementById('answer-area').value.replace(/\n/g,'<br>')+'</body></html>'], {type:'application/msword'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Answer.doc'; a.click(); }

    init();
</script>
</body>
</html>
