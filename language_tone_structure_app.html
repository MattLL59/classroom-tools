<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone, Structure & Language Architect</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #2c3e50; 
            --accent: #d35400; 
            --tone-col: #8e44ad; 
            --struct-col: #2980b9; 
            --lang-col: #27ae60; 
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body { 
            font-family: var(--font-main); 
            background-color: var(--bg); color: #333; margin: 0; padding: 20px; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; text-align: center;
        }

        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding-bottom: 10px; border-bottom: 2px solid #ddd; flex-shrink: 0; 
        }
        h1 { margin: 0; color: var(--primary); font-size: 1.5rem; }
        
        .admin-btn { 
            font-size: 1.5rem; color: #555; background: white; border: 2px solid var(--accent); 
            border-radius: 50%; width: 45px; height: 45px; cursor: pointer; transition: all 0.2s;
        }
        .admin-btn:hover { transform: scale(1.1); background: #fff8f0; }

        .container { 
            flex-grow: 1; max-width: 1100px; width: 100%; margin: 20px auto; background: white; 
            border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); padding: 20px; 
            display: flex; flex-direction: column; overflow-y: auto; position: relative;
        }

        .stage-area { display: none; animation: fadeIn 0.4s; flex-grow: 1; text-align: center; }
        .stage-area.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .section-title { text-align: left; border-bottom: 2px solid #eee; padding-bottom: 5px; margin-top: 20px; color: #7f8c8d; font-weight: bold; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px; margin-top: 10px; }
        
        button.choice-btn { 
            padding: 20px; border: 2px solid #eee; border-radius: 10px; font-size: 1rem; 
            cursor: pointer; background: white; transition: all 0.2s; color: #333;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
            min-height: 100px;
        }
        button.choice-btn:hover { transform: translateY(-3px); border-color: var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        .struct-card { border-left: 5px solid var(--struct-col) !important; background: #f4faff !important; text-align: left; align-items: flex-start !important; }
        .lang-card { border-left: 5px solid var(--lang-col) !important; }

        .btn-tone { border-bottom: 5px solid var(--tone-col); }
        .btn-struct { border-bottom: 5px solid var(--struct-col); }
        .btn-lang { border-bottom: 5px solid var(--lang-col); }
        
        #builder-controls { display: flex; gap: 10px; margin-bottom: 10px; justify-content: center; }
        .scaffold-select { padding: 8px; border: 1px solid #ccc; border-radius: 5px; background: #f9f9f9; color: var(--primary); font-weight: bold; }

        #sentence-builder { 
            margin-top: 10px; padding: 15px; background: #f8f9fa; border: 2px dashed #ccc; 
            border-radius: 8px; min-height: 60px; font-size: 1.1rem; color: #555;
        }
        .fragment { padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); margin: 0 3px; display: inline-block;}
        
        #essay-display {
            display: none; margin-top: 20px; padding: 20px; background: #fff; border: 1px solid #ddd;
            border-left: 5px solid var(--lang-col); border-radius: 8px; text-align: left; 
        }
        #essay-textarea {
            width: 100%; height: 200px; padding: 10px; border: 1px solid #ccc; border-radius: 5px;
            font-family: inherit; font-size: 1rem; resize: vertical; margin-top: 10px;
        }

        #admin-modal, #wizard-overlay, #overlay-msg { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 2000; justify-content: center; align-items: center; 
        }
        #admin-modal, #wizard-overlay { background: rgba(0,0,0,0.6); }
        #overlay-msg { background: rgba(44, 62, 80, 0.95); color: white; flex-direction: column; }

        .admin-panel { 
            background: white; width: 95%; max-width: 1200px; height: 90%; border-radius: 8px; 
            display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
        }
        .panel-body { padding: 20px; overflow-y: auto; flex-grow: 1; text-align: left; }
        
        .editor-section { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .input-row { margin-bottom: 10px; }
        .admin-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        #wizard-overlay { flex-direction:column; padding:20px; box-sizing:border-box; background: white; }
    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <h1 id="app-title">Analysis Architect</h1>
            <select id="level-select" onchange="changeLevel()" style="padding:5px; border-radius:5px; border:1px solid #ccc;">
                <option value="1">Level 1: Foundation (G1-2)</option>
                <option value="2">Level 2: Developing (G3)</option>
                <option value="3">Level 3: Secure (G4+)</option>
            </select>
        </div>
        <button class="admin-btn" onclick="openAdmin()" title="Settings"><i class="fas fa-cog"></i></button>
    </header>

    <div class="container">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold; color:#7f8c8d;">
            <span id="text-display">Text: Loading...</span>
            <span id="question-display">Question: ...</span>
        </div>

        <div id="stage-quote" class="stage-area active">
            <h2>Select Evidence</h2>
            <p>Choose an element to analyze.</p>
            <div class="section-title">üèóÔ∏è MACRO-STRUCTURE (Whole Text)</div>
            <div class="grid" id="macro-grid"></div>
            <div class="section-title">üîç MICRO-ANALYSIS (Language & Tone)</div>
            <div class="grid" id="micro-grid"></div>
        </div>

        <div id="stage-decoder" class="stage-area">
            <h2>Translation Bridge</h2>
            <p>What does this mean in modern English?</p>
            <div style="background:#fff3e0; padding:15px; margin-bottom:20px; font-style:italic; font-size:1.2rem;">
                "<span id="decoder-original"></span>"
            </div>
            <div class="grid" id="decoder-grid"></div>
        </div>

        <div id="stage-lens" class="stage-area">
            <h2>Choose Analysis Lens</h2>
            <div class="grid">
                <button class="choice-btn btn-tone" onclick="loadAnalysis('tone')"><strong>Tone</strong></button>
                <button class="choice-btn btn-struct" onclick="loadAnalysis('structure')"><strong>Structure</strong></button>
                <button class="choice-btn btn-lang" onclick="loadAnalysis('language')"><strong>Language</strong></button>
            </div>
        </div>

        <div id="stage-analysis" class="stage-area">
            <h2 id="analysis-title">Analysis</h2>
            <p id="analysis-prompt">...</p>
            <div class="grid" id="analysis-grid"></div>
        </div>

        <div id="builder-wrapper" style="margin-top:20px;">
            <div id="builder-controls">
                <select id="select-connective" class="scaffold-select" onchange="insertScaffold('connective')">
                    <option value="">‚ûï Add Connective...</option>
                </select>
                <select id="select-starter" class="scaffold-select" onchange="insertScaffold('starter')">
                    <option value="">‚ûï Add Sentence Starter...</option>
                </select>
            </div>
            <div id="sentence-builder"><span style="color:#ccc;">Paragraph builds here...</span></div>
        </div>

        <div id="essay-display">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3>Your Essay (Draft):</h3>
                <div>
                    <button onclick="downloadWord()" style="background:#2980b9; color:white; border:none; padding:5px 10px; cursor:pointer; border-radius:4px;">Download .doc</button>
                    <button onclick="clearEssay()" style="background:#e74c3c; color:white; border:none; padding:5px 10px; cursor:pointer; border-radius:4px;">Clear</button>
                </div>
            </div>
            <textarea id="essay-textarea" placeholder="Your constructed analysis will appear here. You can edit it freely."></textarea>
        </div>
    </div>

    <div id="overlay-msg" onclick="this.style.display='none'">
        <i id="overlay-icon" class="fas fa-check-circle" style="font-size:4rem; margin-bottom:20px;"></i>
        <h2 id="overlay-text">Correct!</h2>
    </div>

    <div id="admin-modal">
        <div class="admin-panel">
            <div style="padding:15px; background:#eee; display:flex; justify-content:space-between; align-items:center;">
                <strong>Teacher Settings</strong>
                <button onclick="closeAdmin()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div class="panel-body">
                
                <div style="background:linear-gradient(135deg, #e67e22 0%, #d35400 100%); padding:20px; border-radius:8px; color:white; margin-bottom:20px; text-align:center;">
                    <h3 style="margin:0 0 10px 0;">‚ú® AI Import Wizard</h3>
                    <p style="margin:0;">Generates plausible distractors & whole-text analysis.</p>
                    <button class="choice-btn" style="border:none; color:#333; padding:10px 20px; margin-top:10px;" onclick="openWizard()">Open Wizard</button>
                </div>

                <div class="editor-section">
                    <h3>Basic Info</h3>
                    <div class="input-row">
                        <label>Text Title:</label>
                        <input id="edit-title" class="admin-input" onchange="updateGlobal('textTitle', this.value)">
                    </div>
                    <div class="input-row">
                        <label>Focus Question:</label>
                        <input id="edit-question" class="admin-input" onchange="updateGlobal('question', this.value)">
                    </div>
                </div>

                <div class="editor-section">
                    <h3>üè¶ Scaffolding Banks</h3>
                    <label><strong>Connectives (comma separated):</strong></label>
                    <input id="edit-connectives" class="admin-input" onchange="updateBanks()">
                    <label style="margin-top:10px; display:block;"><strong>Sentence Starters (comma separated):</strong></label>
                    <input id="edit-starters" class="admin-input" onchange="updateBanks()">
                </div>

                <div class="editor-section">
                    <h3>Analysis Points</h3>
                    <div id="quote-editor-container"></div>
                    <button class="choice-btn" style="width:100%; background:#27ae60; color:white;" onclick="addQuote()">+ Add New Point</button>
                </div>
            </div>
        </div>
    </div>

    <div id="wizard-overlay">
        <h2>‚ú® AI Import Wizard</h2>
        <div style="display:flex; gap:20px; height:100%;">
            <div style="flex:1; display:flex; flex-direction:column;">
                <p><strong>Step 1:</strong> Paste FULL Text (Auto-Saved).</p>
                <textarea id="wiz-text" class="admin-input" style="flex:1; resize:none; white-space: pre-wrap;" placeholder="Paste text here..." onchange="saveSourceText(this.value)"></textarea>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input id="wiz-q" class="admin-input" style="flex:2;" placeholder="Question">
                </div>
            </div>
            <div style="flex:1; display:flex; flex-direction:column;">
                <p><strong>Step 2:</strong> Configure & Generate.</p>
                <select id="wiz-type" class="admin-input" style="margin-bottom:10px;">
                    <option value="mix">Mix (Macro Structure + Quotes)</option>
                    <option value="macro">Only Macro-Structure</option>
                    <option value="quotes">Only Quotes</option>
                </select>
                <button class="choice-btn" style="background:#3498db; color:white; margin-bottom:10px;" onclick="generatePrompt()">Generate Prompt</button>
                <textarea id="wiz-prompt" class="admin-input" style="height:100px; background:#eee;" readonly></textarea>
                
                <p><strong>Step 3:</strong> Paste JSON.</p>
                <textarea id="wiz-json" class="admin-input" style="flex:1; resize:none;" placeholder="Paste JSON here..."></textarea>
                
                <div style="display:flex; gap:10px; align-items:center; margin-top:10px;">
                    <input type="checkbox" id="wiz-append"> <label for="wiz-append">Append to existing list</label>
                </div>
                
                <button class="choice-btn" style="background:#27ae60; color:white; margin-top:10px;" onclick="loadFromWizard()">üöÄ Review & Load</button>
                <button class="choice-btn" style="background:#95a5a6; color:white; margin-top:5px;" onclick="document.getElementById('wizard-overlay').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

<script>
    var defaultData = {
        textTitle: "The Electric Telegraph (1851)",
        question: "How does the writer convey the impact of the telegraph?",
        sourceText: "",
        connectives: ["Furthermore,", "However,", "Consequently,", "In contrast,", "Significantly,"],
        starters: ["The writer implies that", "This suggests", "It is evident that", "The use of this technique highlights"],
        items: [
            {
                id: "s1",
                type: "structure", 
                label: "The Beginning vs The End",
                detail: "Compare Para 1 (Wondrous) with the Final Para (Revolution).",
                level1: { structure: { prompt: "How does the text change?", correct: "It starts with surprise and ends with a revolution.", options: ["It starts with surprise and ends with a revolution.", "It stays the same."] } },
                level2: { structure: { prompt: "The text moves from specific details to:", correct: "A global prediction", options: ["A global prediction", "A small story", "A joke"] } },
                level3: { structure: { prompt: "Analyze the structural arc.", correct: "The text shifts from describing the mechanism ('currents') to predicting a societal 'revolution', widening the scope.", options: ["It shifts from mechanism to revolution, widening the scope.", "It focuses only on the wires.", "It creates a circular structure."] } }
            }
        ]
    };

    var appData = JSON.parse(JSON.stringify(defaultData));
    var state = { level: 1, currentIdx: 0, buffer: { starter: "", part1: "", part2: "", part3: "", link: "" }, streak: 0 };

    function init() {
        var local = localStorage.getItem('tsa_data_v13_fixed');
        if(local) try { appData = JSON.parse(local); } catch(e) {}
        if(!appData.connectives) appData.connectives = defaultData.connectives;
        if(!appData.starters) appData.starters = defaultData.starters;
        updateDOM();
        loadStage1();
    }

    function changeLevel() {
        state.level = parseInt(document.getElementById('level-select').value);
        state.streak = 0;
        updateDOM();
        loadStage1();
    }

    function updateDOM() {
        document.getElementById('text-display').innerText = "Text: " + appData.textTitle;
        document.getElementById('question-display').innerText = "Q: " + (appData.question || "Analysis");
        populateScaffolding();
    }

    function populateScaffolding() {
        var selC = document.getElementById('select-connective');
        var selS = document.getElementById('select-starter');
        selC.innerHTML = '<option value="">‚ûï Add Connective...</option>';
        selS.innerHTML = '<option value="">‚ûï Add Sentence Starter...</option>';
        
        appData.connectives.forEach(c => {
            var opt = document.createElement('option');
            opt.value = c; opt.innerText = c;
            selC.appendChild(opt);
        });
        appData.starters.forEach(s => {
            var opt = document.createElement('option');
            opt.value = s; opt.innerText = s;
            selS.appendChild(opt);
        });
    }

    function insertScaffold(type) {
        var val = document.getElementById('select-' + type).value;
        if(!val) return;
        state.buffer[type] = val;
        updateBuilder();
        document.getElementById('select-' + type).value = "";
    }

    function loadStage1() {
        showStage('stage-quote');
        var macroGrid = document.getElementById('macro-grid');
        var microGrid = document.getElementById('micro-grid');
        macroGrid.innerHTML = '';
        microGrid.innerHTML = '';

        if(appData.items) {
            appData.items.forEach((item, i) => {
                var btn = document.createElement('button');
                btn.className = 'choice-btn';
                
                if(item.type === 'structure') {
                    btn.classList.add('struct-card');
                    btn.innerHTML = `<strong>üèóÔ∏è ${item.label}</strong><small>${item.detail}</small>`;
                    btn.onclick = () => startFlow(i);
                    macroGrid.appendChild(btn);
                } else {
                    btn.classList.add('lang-card');
                    btn.innerHTML = `<strong>üî§ Quote</strong><small>"${item.original}"</small>`;
                    btn.onclick = () => startFlow(i);
                    microGrid.appendChild(btn);
                }
            });
        }
        state.buffer = { starter: "", part1: "", part2: "", part3: "", link: "" };
        updateBuilder();
    }

    function startFlow(idx) {
        state.currentIdx = idx;
        var item = appData.items[idx];
        if(item.type === 'structure') {
            state.buffer.part1 = `Regarding the structure, specifically ${item.label.toLowerCase()}...`;
            updateBuilder();
            loadAnalysis('structure');
        } else {
            loadStage2();
        }
    }

    function loadStage2() {
        showStage('stage-decoder');
        var q = appData.items[state.currentIdx];
        document.getElementById('decoder-original').innerText = q.original;
        
        var grid = document.getElementById('decoder-grid');
        grid.innerHTML = '';
        
        var opts = [
            { txt: q.translation, correct: true },
            { txt: q.distractor, correct: false }
        ].sort(() => Math.random() - 0.5);

        opts.forEach(opt => {
            var btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerText = opt.txt;
            btn.onclick = () => handleDecoder(opt.correct, btn, q.original, q.translation);
            grid.appendChild(btn);
        });
    }

    function handleDecoder(correct, btn, orig, trans) {
        if(correct) {
            feedback(true, "Spot on!");
            state.buffer.part1 = `The writer uses the phrase "${orig}"`;
            state.buffer.part2 = `(which means ${trans}).`;
            updateBuilder();
            setTimeout(() => showStage('stage-lens'), 1000);
        } else {
            feedback(false, "Try again.");
        }
    }

    function loadAnalysis(lens) {
        showStage('stage-analysis');
        var item = appData.items[state.currentIdx];
        var lvlKey = 'level' + state.level;
        
        if(!item[lvlKey] || !item[lvlKey][lens]) {
            if(item.type === 'structure' && lens !== 'structure') {
                alert("For Macro-Structure items, please select 'Structure' lens.");
                return;
            }
            alert("Data missing for this level/lens.");
            return;
        }

        var data = item[lvlKey][lens]; 
        document.getElementById('analysis-title').innerText = "Analyzing " + lens.charAt(0).toUpperCase() + lens.slice(1);
        document.getElementById('analysis-prompt').innerText = data.prompt;

        var grid = document.getElementById('analysis-grid');
        grid.innerHTML = '';

        var opts = [...data.options].sort(() => Math.random() - 0.5);
        opts.forEach(opt => {
            var btn = document.createElement('button');
            btn.className = 'choice-btn';
            if(lens === 'tone') btn.classList.add('btn-tone');
            if(lens === 'structure') btn.classList.add('btn-struct');
            if(lens === 'language') btn.classList.add('btn-lang');
            
            btn.innerText = opt;
            btn.onclick = () => handleAnalysis(opt === data.correct, btn, opt);
            grid.appendChild(btn);
        });
    }

    function handleAnalysis(correct, btn, text) {
        if(correct) {
            feedback(true, "Analysis Complete!");
            state.buffer.part3 = text;
            updateBuilder();
            addToEssay();
            setTimeout(loadStage1, 1500);
        } else {
            feedback(false, "Think closer...");
        }
    }

    function showStage(id) {
        document.querySelectorAll('.stage-area').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function updateBuilder() {
        var h = "";
        if(state.buffer.link) h += `<span class="fragment" style="background:#34495e; color:white;">${state.buffer.link}</span> `;
        if(state.buffer.starter) h += `<span class="fragment" style="background:#2c3e50; color:white;">${state.buffer.starter}</span> `;
        if(state.buffer.part1) h += `<span class="fragment" style="background:#e3f2fd">${state.buffer.part1}</span> `;
        if(state.buffer.part2) h += `<span class="fragment" style="background:#fff3e0">${state.buffer.part2}</span> `;
        if(state.buffer.part3) h += `<span class="fragment" style="background:#e8f5e9">${state.buffer.part3}</span>`;
        document.getElementById('sentence-builder').innerHTML = h || "<span style='color:#ccc'>Paragraph builds here...</span>";
    }

    function addToEssay() {
        var parts = [state.buffer.link, state.buffer.starter, state.buffer.part1, state.buffer.part2, state.buffer.part3];
        var text = parts.filter(p => p).join(" ");
        var textarea = document.getElementById('essay-textarea');
        textarea.value += (textarea.value ? "\n\n" : "") + text;
        document.getElementById('essay-display').style.display = 'block';
    }

    function clearEssay() {
        if(confirm("Clear your essay draft?")) {
            document.getElementById('essay-textarea').value = '';
            document.getElementById('essay-display').style.display = 'none';
        }
    }

    function downloadWord() {
        var text = document.getElementById('essay-textarea').value;
        if(!text) return;
        var blob = new Blob(['<html><body><p>' + text.replace(/\n/g, '</p><p>') + '</p></body></html>'], {
            type: 'application/msword'
        });
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'My_Analysis.doc';
        a.click();
    }

    function feedback(success, txt) {
        var ol = document.getElementById('overlay-msg');
        var text = document.getElementById('overlay-text');
        var icon = document.getElementById('overlay-icon');
        ol.style.display = 'flex';
        text.innerText = txt;
        if(success) {
            ol.style.background = 'rgba(39, 174, 96, 0.9)';
            icon.className = 'fas fa-check-circle';
        } else {
            ol.style.background = 'rgba(192, 57, 43, 0.9)';
            icon.className = 'fas fa-times-circle';
        }
        setTimeout(() => ol.style.display = 'none', 1000);
    }

    function openAdmin() { 
        document.getElementById('admin-modal').style.display = 'flex'; 
        // SAFE LOAD: Check if element exists before assigning
        if(document.getElementById('edit-title')) document.getElementById('edit-title').value = appData.textTitle;
        if(document.getElementById('edit-question')) document.getElementById('edit-question').value = appData.question || "";
        if(document.getElementById('edit-connectives')) document.getElementById('edit-connectives').value = appData.connectives.join(', ');
        if(document.getElementById('edit-starters')) document.getElementById('edit-starters').value = appData.starters.join(', ');
        renderEditor(); 
    }
    
    function closeAdmin() { 
        document.getElementById('admin-modal').style.display = 'none'; 
        localStorage.setItem('tsa_data_v13_fixed', JSON.stringify(appData));
        updateDOM();
        loadStage1();
    }
    
    function updateGlobal(k, v) { appData[k] = v; }
    
    function updateBanks() {
        appData.connectives = document.getElementById('edit-connectives').value.split(',').map(s=>s.trim());
        appData.starters = document.getElementById('edit-starters').value.split(',').map(s=>s.trim());
    }

    function openWizard() { 
        document.getElementById('wizard-overlay').style.display = 'flex'; 
        if(appData.sourceText) document.getElementById('wiz-text').value = appData.sourceText;
        if(appData.question) document.getElementById('wiz-q').value = appData.question;
    }

    function saveSourceText(val) { appData.sourceText = val; }

    function generatePrompt() {
        var text = document.getElementById('wiz-text').value;
        var q = document.getElementById('wiz-q').value;
        var type = document.getElementById('wiz-type').value;
        var count = 3;
        
        var prompt = `I need you to act as a JSON generator for a GCSE English App.
I have a text. Analyze it carefully.
Question: "${q}"

REQUIREMENT: Generate ${count} items.
MODE: ${type === 'macro' ? 'ONLY Macro-Structure' : type === 'quotes' ? 'ONLY Micro Quotes' : 'Mix'}.

CRITICAL INSTRUCTIONS:
1. DISTRACTORS: Must be PLAUSIBLE "Near-Misses" (e.g. a literal reading of a metaphor, or a common student misconception). DO NOT USE SILLY ANSWERS.
2. STRUCTURE: Must focus on WHOLE TEXT (Opening vs Ending, Shifts).

Return ONLY valid JSON matching this structure:
{
  "textTitle": "Title",
  "question": "${q}",
  "items": [
    {
      "id": "s1",
      "type": "structure",
      "label": "Opening vs Ending",
      "detail": "Compare Para 1 and Para 5",
      "level1": { "structure": {"prompt": "Q", "correct": "A", "options": ["A","B"]} },
      "level2": { "structure": {"prompt": "Q", "correct": "A", "options": ["A","B"]} },
      "level3": { "structure": {"prompt": "Q", "correct": "A", "options": ["A","B"]} }
    },
    {
      "id": "q1",
      "type": "quote",
      "original": "quote text",
      "translation": "meaning",
      "distractor": "plausible wrong meaning",
      "level1": { "tone": {"prompt": "Q", "correct": "A", "options": ["A","B"]}, "language": {"prompt": "Q", "correct": "A", "options": ["A","B"]} },
      "level2": { "tone": {"prompt": "Q", "correct": "A", "options": ["A","B"]}, "language": {"prompt": "Q", "correct": "A", "options": ["A","B"]} },
      "level3": { "tone": {"prompt": "Q", "correct": "A", "options": ["A","B"]}, "language": {"prompt": "Q", "correct": "A", "options": ["A","B"]} }
    }
  ]
}`;
        var promptArea = document.getElementById('wiz-prompt');
        promptArea.value = prompt;
        promptArea.select();
        document.execCommand('copy');
        alert("Prompt copied to clipboard!");
    }
    
    function loadFromWizard() {
        var raw = document.getElementById('wiz-json').value.trim();
        raw = raw.replace(/^```json/i, '').replace(/^```/i, '').replace(/```$/i, '');
        var first = raw.indexOf('{');
        var last = raw.lastIndexOf('}');
        
        if (first === -1 || last === -1) { alert("Could not find JSON object."); return; }
        
        try {
            var json = JSON.parse(raw.substring(first, last + 1));
            appData.textTitle = json.textTitle || appData.textTitle;
            appData.question = json.question || appData.question;
            appData.sourceText = document.getElementById('wiz-text').value;

            if(json.items) {
                var appendMode = document.getElementById('wiz-append').checked;
                if (appendMode) {
                    if (!appData.items) appData.items = [];
                    json.items.forEach(item => {
                        item.id = "gen_" + Date.now() + "_" + Math.random().toString(16).slice(2);
                        appData.items.push(item);
                    });
                    alert("Added " + json.items.length + " new items.");
                } else {
                    appData.items = json.items;
                    alert("List replaced.");
                }
                
                // Force a DOM Update to ensure inputs exist before setting values
                openAdmin(); 
                document.getElementById('wizard-overlay').style.display = 'none';
            } else { alert("JSON missing 'items' array."); }
        } catch(e) { alert("JSON Error: " + e.message); }
    }

    function renderEditor() {
        var con = document.getElementById('quote-editor-container');
        con.innerHTML = '';
        if(!appData.items) return;
        
        appData.items.forEach((item, i) => {
            var div = document.createElement('div');
            div.className = 'editor-section';
            
            if(item.type === 'structure') {
                div.style.borderLeft = "5px solid var(--struct-col)";
                div.innerHTML = `<strong>üèóÔ∏è Structure: ${item.label}</strong><br><small>${item.detail}</small>`;
            } else {
                div.style.borderLeft = "5px solid var(--lang-col)";
                div.innerHTML = `<strong>üî§ Quote:</strong> ${item.original}`;
            }
            div.innerHTML += `<br><button onclick="delQuote(${i})" style="color:red;border:none;">Delete</button>`;
            con.appendChild(div);
        });
    }

    function delQuote(i) { appData.items.splice(i,1); renderEditor(); }
    
    function addQuote() {
        appData.items.push({ type: "quote", original: "New Quote", translation: "Meaning", distractor: "Wrong", level1:{}, level2:{}, level3:{} });
        renderEditor();
    }

    init();
</script>
</body>
</html>
