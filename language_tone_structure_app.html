<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tone & Structure Architect v144 (Stable Core)</title>
    <link href="[https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css](https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css)" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #009688; --accent: #ff9800; --bg: #f0f2f5;
            --card: #ffffff; --text: #37474f; --tone-col: #9c27b0;
            --struct-col: #2196f3; --lang-col: #4caf50; --nav-bg: #ffffff;
            --success: #4caf50; --error: #f44336;
        }
        body.theme-dyslexia { --bg: #fdf5e6; --text: #222; --card: #fffcf5; font-family: 'Verdana', sans-serif !important; line-height: 1.6; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--card); box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; flex-shrink: 0; }
        h1 { margin: 0; font-size: 1.1rem; color: var(--primary); display:flex; align-items:center; gap:5px; }
        .score-badge { background: var(--accent); color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.9rem; margin-left: 10px; font-weight: bold; }

        /* LAYOUT */
        .main-viewport { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        nav.bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: var(--nav-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 900; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; color: #888; font-size: 0.75rem; border: none; background: none; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        
        /* HUBS */
        .hub { display: none; } .hub.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media(min-width: 600px) { .grid { grid-template-columns: 1fr 1fr; } }
        
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 2px solid #ddd; text-align: center; font-size: 1.1rem; cursor: pointer; transition: transform 0.1s; position: relative; overflow: hidden; }
        .card:hover { transform: scale(1.02); border-color: var(--primary); }
        .card-tone { border-left: 10px solid var(--tone-col); }
        .card-struct { border-left: 10px solid var(--struct-col); text-align: left; }
        .card-lang { border-left: 10px solid var(--lang-col); }

        /* ANIMATIONS */
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        .shake { animation: shake 0.4s ease-in-out; border-color: var(--error) !important; background: #ffebee !important; }

        /* BUILDER */
        .bank-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; background: rgba(0,0,0,0.02); padding: 10px; border-radius: 8px; }
        .bank-row { text-align: left; width: 100%; }
        .bank-label { font-size: 0.75rem; font-weight: bold; text-transform: uppercase; color: var(--primary); margin-left: 5px; margin-bottom: 3px; display: block;}
        select.bank-select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #bbb; background: var(--card); color: var(--text); font-size: 1.1rem; min-height: 45px; } 
        #sentence-stage { width: 100%; padding: 15px; background: var(--card); border: 2px dashed var(--primary); border-radius: 10px; margin: 15px 0; font-size: 1.1rem; min-height: 60px; box-sizing: border-box; line-height: 1.4; }
        #answer-area { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; background: var(--card); font-family: inherit; margin-bottom: 10px; box-sizing: border-box; font-size: 1rem; }
        #quote-reference { background: #e3f2fd; border-left: 5px solid #2196f3; padding: 10px; margin-bottom: 15px; border-radius: 4px; font-style: italic; color: #444; display: none; }

        /* ADMIN & EDITORS */
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
        .btn-primary { background: var(--primary); width: 100%; }
        .btn-warning { background: var(--accent); }
        .btn-doc { background: #2b5797; }
        .admin-btn { background:none; border:none; color:var(--text); font-size:1.2rem; cursor:pointer; }
        
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999999; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); color: var(--text); width: 95%; max-width: 800px; max-height: 90vh; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px; background: rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-body { padding: 20px; overflow-y: auto; text-align: left; }
        .editor-section { border: 2px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; background: rgba(0,0,0,0.02); }
        .admin-input { width: 100%; padding: 10px; border: 1px solid #aaa; border-radius: 4px; box-sizing: border-box; margin-bottom: 5px; font-size: 1rem; }
        .admin-tab-bar { display: flex; gap:5px; margin-bottom:10px; }
        .admin-tab { flex:1; padding:10px; border:2px solid #ccc; background:#eee; cursor:pointer; font-weight:bold; border-radius:4px; text-align:center; color:#333; }
        .admin-tab.active { background:var(--accent); color:white; border-color:var(--accent); }
        .bank-edit-btn { background:#607d8b; color:white; padding:5px 10px; border-radius:4px; border:none; margin:2px; font-size:0.85rem; cursor:pointer; }
        .analysis-details { margin-top: 10px; padding: 10px; border: 2px dashed #9c27b0; border-radius: 5px; display:none; background: #fafafa; }
        .level-block { margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .btn-edit-item { background: #ff9800; color: white; padding: 5px 10px; border-radius: 4px; border: none; cursor: pointer; font-size: 0.8rem; }

        /* CELEBRATION */
        #celebration-modal { text-align: center; }
        .firework-icon { font-size: 4rem; color: #ff9800; animation: spin 2s infinite linear; margin-bottom: 10px; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        #feedback-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:20000; display:none; flex-direction:column; justify-content:center; align-items:center; color:white; text-align:center; }
        #feedback-icon { font-size: 5rem; margin-bottom: 20px; }
        #save-status { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; opacity: 0; transition: 0.5s; z-index: 10000; }
        
        #crash-curtain { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999999; justify-content:center; align-items:center; flex-direction:column; text-align:center; }
        @media print { .no-print { display: none; } }
    </style>
</head>
<body>

    <div id="crash-curtain">
        <h2>‚ö†Ô∏è App Error</h2>
        <p>The saved data was corrupt. Settings have been opened.</p>
        <button class="btn btn-primary" onclick="openAdmin(); this.parentElement.style.display='none';">Open Settings</button>
    </div>

    <header>
        <h1>
            <button onclick="clearSession()" style="background:red; color:white; border:none; border-radius:50%; width:25px; height:25px; font-weight:bold; cursor:pointer; font-size:0.8rem; margin-right:5px;" title="New Session">‚ú®</button>
            <i class="fas fa-cubes"></i> Tone & Structure v144
            <span class="score-badge" id="score-display">0 XP</span>
        </h1>
        <div style="display:flex; gap:10px;">
            <button class="admin-btn" title="Change Theme" onclick="openThemeModal()"><i class="fas fa-palette"></i></button>
            <select id="level-select" onchange="changeLevel()" style="padding:4px; border-radius:4px;">
                <option value="1">Lvl 1</option><option value="2">L2</option><option value="3">L3</option>
            </select>
            <button id="admin-btn" class="admin-btn" onclick="openAdmin()"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div id="student-banner" style="display:none; width:100%; background:var(--accent); color:white; padding:5px; text-align:center; font-weight:bold;">
        üéì Student Mode: <span id="student-title"></span>
    </div>
    
    <div id="save-status">üíæ Progress Saved</div>

    <div class="main-viewport">
        <div id="hub-lab" class="hub active">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-size:0.9rem;">
                <span style="flex:1;"><strong><span id="header-label">Topic</span>:</strong> <span id="text-display">Loading...</span></span>
                <span style="flex:1; text-align:right;"><strong>Q:</strong> <span id="q-display">Loading...</span></span>
            </div>
            <div id="lab-content">
                <div class="instruction">Step 1: Choose Evidence</div>
                <div class="filter-bar" id="main-filter-bar" style="display:flex; gap:5px; justify-content:center; margin-bottom:10px;">
                    <button class="btn" onclick="filterGrid('all')">All</button>
                    <button class="btn" onclick="filterGrid('language')">Lang</button>
                    <button class="btn" onclick="filterGrid('structure')">Struct</button>
                </div>
                <div id="dynamic-question-display" class="dynamic-question">Select Evidence</div>
                <div class="grid" id="grid-main"></div>
            </div>
        </div>

        <div id="hub-writing" class="hub">
            <div id="quote-reference"></div>
            <div class="instruction">Sentence Construction</div>
            <div class="bank-list" id="dynamic-builder-controls"></div>
            <div class="instruction">Current Construction:</div>
            <div id="sentence-stage">Start picking words in the Lab...</div>
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <button class="btn btn-warning" style="flex:1" onclick="undoLast()">Undo</button>
                <button class="btn btn-primary" style="flex:2" onclick="commitSentence()">Add to Answer</button>
            </div>
            <hr style="opacity:0.2;">
            <textarea id="answer-area" placeholder="Your full answer will appear here..." oninput="autoSaveProgress()"></textarea>
            <div style="display:flex; gap:5px;">
                <button class="btn btn-doc" style="flex:1" onclick="downloadDoc()">Download .doc</button>
                <button class="btn btn-warning" style="flex:0 0 auto; background:#e74c3c;" onclick="clearEssay()">Reset Essay</button>
            </div>
        </div>
    </div>

    <nav class="bottom-nav">
        <button id="nav-lab" class="nav-item active" onclick="switchHub('lab')"><i class="fas fa-vial"></i><span>Evidence Lab</span></button>
        <button id="nav-writing" class="nav-item" onclick="switchHub('writing')"><i class="fas fa-pen-fancy"></i><span>Writing Desk</span></button>
    </nav>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Settings <button onclick="closeAdmin()">X</button></div>
            <div class="modal-body">
                <button class="btn btn-danger" style="width:100%; margin-bottom:15px; background:#e74c3c; color:white; padding:15px;" onclick="hardReset()">‚ö†Ô∏è Factory Reset</button>

                <div class="editor-section" style="border: 2px solid #673ab7; background: #f3e5f5;">
                    <h3 style="color:#4a148c;">ü§ñ AI Lesson Generator (v144)</h3>
                    <p style="font-size:0.85rem; margin-bottom:5px;"><strong>Step 1:</strong> Author Name:</p>
                    <input id="ai-author-name" class="admin-input" placeholder="e.g. Charles Dickens">
                    <p style="font-size:0.85rem; margin-bottom:5px;"><strong>Step 2:</strong> Quote Count:</p>
                    <input id="ai-quote-count" type="number" class="admin-input" value="6" min="1" max="15">
                    <p style="font-size:0.85rem; margin-bottom:5px;"><strong>Step 3:</strong> Paste Source Text:</p>
                    <textarea id="ai-source-text" class="admin-input" style="height:80px; border-color:#9c27b0;" placeholder="Paste extract here..."></textarea>
                    <p style="font-size:0.85rem; margin-bottom:5px;"><strong>Step 4:</strong> Essay Question:</p>
                    <textarea id="ai-question-input" class="admin-input" style="height:50px; border-color:#9c27b0;" placeholder="Question..."></textarea>
                    <button class="btn" style="background:#7b1fa2; width:100%; margin:10px 0;" onclick="generateAndShowPrompt()">‚ú® Generate Smart Prompt</button>
                    <div id="prompt-display-container" style="display:none; margin-bottom:15px;">
                        <textarea id="ai-generated-prompt" class="admin-input" style="height:120px; background:#e1bee7; color:#000;" readonly></textarea>
                    </div>
                    <p style="font-size:0.85rem; margin-bottom:5px;"><strong>Step 5:</strong> Paste JSON Response (Safe Paste):</p>
                    <textarea id="ai-paste-area" class="admin-input" style="height:80px;" placeholder="Paste JSON here..."></textarea>
                    <select id="ai-bank-mode" class="admin-input">
                        <option value="replace">Replace Existing Banks</option>
                        <option value="append">Append to Existing Banks</option>
                        <option value="keep">Keep Existing Banks</option>
                    </select>
                    <button class="btn" style="background:#4a148c; width:100%; margin-top:10px;" onclick="loadDataFromText()">üì• Load Data (Instant)</button>
                </div>

                <div class="editor-section">
                    <h3>Basic Info</h3>
                    <label>Title:</label><input id="edit-title" class="admin-input" oninput="updateGlobal('textTitle', this.value)">
                    <label>Question:</label><input id="edit-question" class="admin-input" oninput="updateGlobal('question', this.value)">
                </div>

                <div class="editor-section" style="border-left: 5px solid var(--accent);">
                    <h3>üìù Edit Evidence & Analysis</h3>
                    <div id="items-container"></div>
                    <button class="btn btn-add" style="background:#2ecc71; margin-top:10px;" onclick="addNewItem()">+ Add New Quote</button>
                    <button class="btn btn-warning" style="width:100%; margin-top:5px;" onclick="resetUsedQuotes()">‚ôªÔ∏è Reset Used Quotes</button>
                </div>

                <div class="editor-section" style="border-left: 5px solid #2196f3;">
                    <h3>‚öôÔ∏è Sentence Structure (Admin)</h3>
                    <div class="admin-tab-bar">
                        <div id="cfg-tab-1" class="admin-tab active" onclick="switchAdminConfigLevel(1)">Lvl 1</div>
                        <div id="cfg-tab-2" class="admin-tab" onclick="switchAdminConfigLevel(2)">Lvl 2</div>
                        <div id="cfg-tab-3" class="admin-tab" onclick="switchAdminConfigLevel(3)">Lvl 3</div>
                    </div>
                    <div style="display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap;">
                        <select class="admin-input" id="cfg-slot1" onchange="saveStructureConfig()" style="width:auto;"></select>
                        <select class="admin-input" id="cfg-slot2" onchange="saveStructureConfig()" style="width:auto;"></select>
                        <select class="admin-input" id="cfg-slot3" onchange="saveStructureConfig()" style="width:auto;"></select>
                        <select class="admin-input" id="cfg-slot4" onchange="saveStructureConfig()" style="width:auto;"></select>
                        <select class="admin-input" id="cfg-slot5" onchange="saveStructureConfig()" style="width:auto;"></select>
                        <select class="admin-input" id="cfg-slot6" onchange="saveStructureConfig()" style="width:auto;"></select>
                    </div>
                </div>

                <div class="editor-section">
                    <h3>‚úçÔ∏è Analysis Banks (Edit)</h3>
                    <div style="display:flex; gap:5px; flex-wrap:wrap;">
                        <button class="bank-edit-btn" onclick="editBank('markers')">Markers</button>
                        <button class="bank-edit-btn" onclick="editBank('starters')">Starters</button>
                        <button class="bank-edit-btn" onclick="editBank('methods')">Methods</button>
                        <button class="bank-edit-btn" onclick="editBank('simpleLinks')">Links (L1)</button>
                        <button class="bank-edit-btn" onclick="editBank('complexLinks')">Links (L2/3)</button>
                        <button class="bank-edit-btn" onclick="editBank('points')">Points</button>
                    </div>
                    <div id="bank-editor-area" style="margin-top:10px; padding:10px; border:1px solid #ccc; display:none; background:#fafafa;">
                        <div style="display:flex; justify-content:space-between;">
                            <h4 id="bank-editor-title" style="margin:0;">Editing...</h4>
                            <button onclick="document.getElementById('bank-editor-area').style.display='none'" style="border:none;background:none;">‚ùå</button>
                        </div>
                        <div id="bank-list" class="list-container" style="max-height:200px; overflow-y:auto; margin-top:10px;"></div>
                        <button class="btn btn-add" style="background:#2ecc71;" onclick="addBankItem()">+ Add Item</button>
                    </div>
                </div>

                <div class="editor-section">
                    <h3>üñ®Ô∏è Worksheet & Data</h3>
                    <div style="display:flex; align-items:center; gap:5px; margin-bottom:10px;">
                        <select id="ws-print-mode" class="admin-input" style="width:auto; flex-grow:1;">
                            <option value="all">Merged Levels</option>
                            <option value="1">Level 1 (Scaffold)</option>
                            <option value="2">Level 2 (Deep)</option>
                            <option value="3">Level 3 (Full)</option>
                        </select>
                        <button class="btn btn-accent" onclick="openPrintView()">üìÑ View/Print</button>
                    </div>
                    <button class="btn btn-doc" style="width:100%; margin-bottom:10px; padding:15px; font-size:1.1rem; background:#1976d2;" onclick="downloadJSON()">üíæ Save Lesson File</button>
                    <button class="btn btn-primary" style="width:100%;" onclick="downloadStudentApp()">üì¶ Download Student App</button>
                    <label style="margin-top:10px; display:block;"><input type="checkbox" id="auto-progress-check" onchange="toggleAutoProgress(this.checked)"> Auto-Progress Levels</label>
                </div>
            </div>
        </div>
    </div>

    <div id="feedback-overlay" onclick="this.style.display='none'">
        <div id="feedback-icon"><i class="fas fa-check-circle"></i></div>
        <h2 id="feedback-text">Correct!</h2>
    </div>

    <div id="celebration-modal" class="modal">
        <div class="modal-content" style="max-width:400px; text-align:center; padding:40px;">
            <i class="fas fa-star firework-icon"></i>
            <h2>Level Complete!</h2>
            <div id="progression-btn-container"></div>
            <button class="btn btn-primary" onclick="document.getElementById('celebration-modal').style.display='none'">Close</button>
        </div>
    </div>

    <div id="theme-modal" class="modal"><div class="modal-content" style="max-width:300px;"><div class="modal-header">Themes <button onclick="document.getElementById('theme-modal').style.display='none'">X</button></div><div class="modal-body"><div class="theme-grid"><div class="theme-opt" style="background:#f0f2f5;" onclick="setTheme('default')">Default</div><div class="theme-opt" style="background:#fdf5e6;" onclick="setTheme('dyslexia')">Cream</div></div></div></div></div>
    <div id="phrasing-overlay" class="modal"><div class="modal-content"><div class="modal-header">Select Phrasing</div><div class="modal-body" id="phrase-options"></div></div></div>

<script id="data-script">
    /* DATA_START */ const teacherConfig = null; /* DATA_END */

    const defaultData = {
        textTitle: "New Lesson", question: "Enter Question", adminPassword: "1234",
        sentenceConfigs: { 1: ['starter', 'quote', 'link', 'point', 'none', 'none'], 2: ['starter', 'quote', 'method', 'analysis', 'none', 'none'], 3: ['marker', 'starter', 'quote', 'method', 'point', 'analysis'] },
        worksheetOptions: { lvl1: true, lvl2: true, lvl3: true },
        analysisTemplates: { tone: ["creates a {adj} tone", "evokes {noun}"], structure: ["highlights {noun}"], language: ["suggests {noun}"] },
        markers: ["Furthermore,", "However,"], starters: ["The writer implies", "The author suggests"], methods: ["Metaphor", "Simile"], points: ["a sense of tension"], simpleLinks: ["This shows", "This suggests", "It is clear"], complexLinks: ["This reinforces the tone (Tone)", "This structural shift implies (Structure)"],
        items: []
    };

    let appData = JSON.parse(JSON.stringify(defaultData));
    let state = { level: 1, currentIdx: -1, filter: 'all', completed: [], currentLens: '', score: 0 };
    let sentenceSlots = { marker:"", starter:"", point:"", method:"", quote:"", link:"", analysis:"" };
    let currentEditingBank = '';
    let adminConfigLevel = 1;
    const wordMorphology = { "admiring":{adj:"admiring",noun:"admiration"}, "angry":{adj:"angry",noun:"anger"}, "chaotic":{adj:"chaotic",noun:"chaos"} };

    function init() {
        try {
            if (teacherConfig && typeof teacherConfig === 'object') {
                appData = validateAndRepair(teacherConfig);
                document.getElementById('student-banner').style.display='block';
                document.getElementById('student-title').innerText = appData.textTitle;
                loadState();
                return;
            }
            
            let local = localStorage.getItem('tsa_v144_stable');
            // Legacy Migration
            if(!local) local = localStorage.getItem('tsa_v143_crashproof') || localStorage.getItem('tsa_v142_settings');
            
            if(local) { 
                try { 
                    const parsed = JSON.parse(local);
                    appData = validateAndRepair(parsed);
                } catch(e) { 
                    console.error("Local Data Corrupt", e);
                    appData = defaultData; 
                } 
            }
            
            sanitizeLinks();
            loadState();
            
            if(localStorage.getItem('tsa_auto_login') === 'true') document.getElementById('auto-login-check').checked = true;
            if(localStorage.getItem('tsa_auto_progress') === 'true') document.getElementById('auto-progress-check').checked = true;
        } catch (fatal) {
            console.error("Fatal Init Error", fatal);
            document.getElementById('crash-curtain').style.display = 'flex';
        }
    }

    // THE SELF-HEALING ENGINE
    function validateAndRepair(data) {
        if (!data) return JSON.parse(JSON.stringify(defaultData));
        // Repair missing arrays
        ['markers','starters','methods','points','simpleLinks','complexLinks','items'].forEach(key => {
            if (!Array.isArray(data[key])) data[key] = [];
        });
        // Repair sentence configs
        if (!data.sentenceConfigs) data.sentenceConfigs = defaultData.sentenceConfigs;
        // Repair items
        data.items.forEach(item => {
            if (!item.distractors) item.distractors = ["Wrong 1", "Wrong 2"];
            if (!item.level1) item.level1 = {};
            if (!item.level2) item.level2 = {};
            if (!item.level3) item.level3 = {};
        });
        return data;
    }
    
    function loadState() {
        const savedEssay = localStorage.getItem('tsa_student_essay');
        if(savedEssay) document.getElementById('answer-area').value = savedEssay;
        const savedCompleted = localStorage.getItem('tsa_student_completed');
        if(savedCompleted) state.completed = JSON.parse(savedCompleted);
        const savedScore = localStorage.getItem('tsa_student_score');
        if(savedScore) state.score = parseInt(savedScore);
        
        document.getElementById('level-select').value = "1";
        state.level = 1;
        updateUI(); 
        changeLevel();
    }
    
    function sanitizeLinks() {
        if(appData.simpleLinks) appData.simpleLinks = appData.simpleLinks.map(s => s.replace(/\s+that\s*$/i, "").trim());
    }
    
    function autoSaveProgress() {
        localStorage.setItem('tsa_student_essay', document.getElementById('answer-area').value);
        localStorage.setItem('tsa_student_score', state.score);
        const ind = document.getElementById('save-status'); ind.style.opacity = 1; setTimeout(() => ind.style.opacity = 0, 1500);
    }
    
    function clearSession() {
        if(confirm("Start a Fresh Session? (Clears all progress)")) {
            localStorage.removeItem('tsa_student_essay');
            localStorage.removeItem('tsa_student_completed');
            localStorage.removeItem('tsa_student_score');
            location.reload();
        }
    }
    
    function resetUsedQuotes() {
        if(confirm("Restore all completed quotes?")) {
            state.completed = [];
            localStorage.removeItem('tsa_student_completed');
            resetToGrid();
            alert("Restored!");
        }
    }

    function switchHub(hubId) {
        document.querySelectorAll('.hub').forEach(h => h.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        document.getElementById('hub-' + hubId).classList.add('active');
        document.getElementById('nav-' + hubId).classList.add('active');
        if(hubId === 'lab') resetToGrid();
    }

    function resetToGrid() {
        state.currentIdx = -1;
        document.getElementById('header-label').innerText = "Topic";
        document.getElementById('text-display').innerText = appData.textTitle;
        const lab = document.getElementById('lab-content');
        lab.innerHTML = `<div class="instruction">Step 1: Choose Evidence</div><div class="filter-bar" id="main-filter-bar" style="display:flex; gap:5px; justify-content:center; margin-bottom:10px;"><button class="btn" onclick="filterGrid('all')">All</button><button class="btn" onclick="filterGrid('language')">Lang</button><button class="btn" onclick="filterGrid('structure')">Struct</button></div><div class="grid" id="grid-main"></div>`;
        if(state.level === 1) { document.getElementById('main-filter-bar').style.display = 'none'; state.filter = 'all'; }
        loadStageSelect();
    }

    function loadStageSelect() {
        const grid = document.getElementById('grid-main');
        if(!grid) return; grid.innerHTML = '';
        let count = 0;
        appData.items.forEach((item, i) => {
            if(state.completed.includes(i)) return; 
            if(state.level !== 1 && state.filter !== 'all' && item.type !== state.filter) return;
            count++;
            const div = document.createElement('div');
            div.className = `card card-${item.type || 'tone'}`;
            div.innerHTML = `<strong>"${item.original}"</strong><br><small>${item.type}</small>`;
            div.onclick = () => startAnalysis(i);
            grid.appendChild(div);
        });
        if(count === 0) {
            if(appData.items.length > 0 && state.completed.length === appData.items.length) {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px;"><h3>üéâ All Quotes Analyzed!</h3></div>';
            } else {
                grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:20px;"><h3>No Evidence Found</h3></div>';
            }
        }
    }
    
    function filterGrid(type) { state.filter = type; resetToGrid(); }
    
    function changeLevel() { 
        state.level = parseInt(document.getElementById('level-select').value); 
        resetToGrid(); 
        renderBuilderDropdowns(); 
    }

    function startAnalysis(idx) {
        state.currentIdx = idx;
        const item = appData.items[idx];
        document.getElementById('header-label').innerText = "Quote";
        document.getElementById('text-display').innerText = item.original.length > 50 ? item.original.substring(0,50)+"..." : item.original;

        const lab = document.getElementById('lab-content');
        lab.innerHTML = `<div class="instruction">Step 2: Match Meaning</div><div class="grid" id="grid-decoder"></div><button class="btn btn-warning" onclick="resetToGrid()" style="margin-top:10px;">‚¨Ö Back</button>`;
        let opts = [{txt: item.translation, correct: true}, ...item.distractors.map(d => ({txt:d, correct:false}))];
        opts.sort(() => Math.random() - 0.5).forEach(o => {
            const btn = document.createElement('div');
            btn.className = 'card'; btn.innerText = o.txt;
            btn.onclick = (e) => checkMatch(e, o.correct, item.original, item.type);
            document.getElementById('grid-decoder').appendChild(btn);
        });
    }

    function checkMatch(e, isCorrect, original, type) {
        if(isCorrect) {
            showFeedback(true);
            state.score += 10;
            updateUI();
            sentenceSlots.quote=`"${original}"`; 
            document.getElementById('quote-reference').innerHTML = `<strong>Current Quote:</strong> "${original}"`;
            document.getElementById('quote-reference').style.display = 'block';
            if (state.level === 1) {
                state.currentLens = type || 'tone';
                switchHub('writing'); rebuildSentence(); renderBuilderDropdowns(); return; 
            }
            loadLensChoice(); 
        } else {
            showFeedback(false);
            e.target.classList.add('shake');
            setTimeout(() => e.target.classList.remove('shake'), 500);
        }
    }

    function showFeedback(correct) {
        const overlay = document.getElementById('feedback-overlay');
        const icon = document.getElementById('feedback-icon');
        const text = document.getElementById('feedback-text');
        overlay.style.display = 'flex';
        if(correct) {
            icon.innerHTML = '<i class="fas fa-check-circle" style="color:#4caf50;"></i>';
            text.innerText = "Correct! (+10 XP)";
            setTimeout(() => overlay.style.display = 'none', 1000);
        } else {
            icon.innerHTML = '<i class="fas fa-times-circle" style="color:#f44336;"></i>';
            text.innerText = "Try Again";
            setTimeout(() => overlay.style.display = 'none', 1000);
        }
    }

    function loadLensChoice() {
        const lab = document.getElementById('lab-content');
        lab.innerHTML = `<div class="instruction">Step 3: Choose Lens</div><div class="grid"><div class="card card-tone" onclick="loadFinalAnalysis('tone')">üé≠ Tone</div><div class="card card-struct" onclick="loadFinalAnalysis('structure')">üèóÔ∏è Structure</div><div class="card card-lang" onclick="loadFinalAnalysis('language')">üìñ Language</div></div><button class="btn btn-warning" onclick="resetToGrid()" style="margin-top:10px;">‚¨Ö Back</button>`;
    }

    function loadFinalAnalysis(lens) {
        state.currentLens = lens; 
        const item = appData.items[state.currentIdx];
        const lvlData = item[`level${state.level}`];
        // FAILSAFE: If analysis is missing, create dummy data to prevent crash
        if (!lvlData || !lvlData[lens]) { 
            console.warn("Missing Analysis Data");
            showPhrasingChoices(lens, "generic");
            return;
        }
        const data = lvlData[lens];
        const lab = document.getElementById('lab-content');
        lab.innerHTML = `<div class="instruction">${data.prompt || 'Analyze'}</div><div class="grid" id="grid-analysis"></div><button class="btn btn-warning" onclick="loadLensChoice()" style="margin-top:10px;">‚¨Ö Back</button>`;
        let rawOpts = data.options || [];
        if(data.correct && !rawOpts.includes(data.correct)) rawOpts.push(data.correct);
        rawOpts.forEach(o => {
            const btn = document.createElement('div');
            btn.className = `card card-${lens}`; btn.innerText = o;
            btn.onclick = (e) => { 
                if(o === data.correct) {
                    showFeedback(true);
                    state.score += 20;
                    showPhrasingChoices(lens, o); 
                } else {
                    showFeedback(false);
                    e.target.classList.add('shake');
                    setTimeout(()=>e.target.classList.remove('shake'), 500);
                }
            };
            document.getElementById('grid-analysis').appendChild(btn);
        });
    }

    function showPhrasingChoices(lens, word) {
        const modal = document.getElementById('phrasing-overlay');
        const container = document.getElementById('phrase-options');
        modal.style.display = 'flex'; container.innerHTML = '';
        let templates = appData.analysisTemplates[lens] || ["creates a {adj} tone"];
        templates.forEach(tmpl => {
            let adj = wordMorphology[word.toLowerCase()]?.adj || word;
            let noun = wordMorphology[word.toLowerCase()]?.noun || word;
            let text = tmpl.replace("{adj}", adj).replace("{noun}", noun).replace("{word}", word);
            const div = document.createElement('div');
            div.className = 'phrase-option'; div.innerText = text;
            div.onclick = () => {
                sentenceSlots.analysis = text; modal.style.display = 'none';
                rebuildSentence(); switchHub('writing'); renderBuilderDropdowns(); resetToGrid(); 
            };
            container.appendChild(div);
        });
    }

    function renderBuilderDropdowns() {
        const container = document.getElementById('dynamic-builder-controls');
        container.innerHTML = '';
        const currentConfig = appData.sentenceConfigs[state.level] || defaultData.sentenceConfigs[1];
        
        currentConfig.forEach(type => {
            if (['quote', 'analysis', 'none'].includes(type)) return;
            
            let options = [];
            // SMART LINK FILTERING
            if(type === 'link') {
                if(state.level === 1) {
                    options = appData['simpleLinks']; 
                } else {
                    options = appData['complexLinks']; 
                    if (state.currentLens) {
                        options = options.filter(opt => {
                            const lower = opt.toLowerCase();
                            if (lower.includes(`(${state.currentLens})`)) return true; 
                            if (lower.includes('(tone)') || lower.includes('(structure)') || lower.includes('(lang)') || lower.includes('(language)')) return false; 
                            return true; 
                        });
                    }
                }
            } else {
                options = appData[type+'s'];
            }
            
            // FAILSAFE: If options array is somehow undefined/empty
            if (!options || options.length === 0) options = ["(No items available)"];

            const div = document.createElement('div');
            div.className = 'bank-row';
            div.innerHTML = `<span class="bank-label">${type}</span><select class="bank-select" onchange="sentenceSlots['${type}']=this.value; rebuildSentence();"><option value="">Choose...</option>${options.map(opt => {
                let d = opt; if(type==='link') d = d.replace(/\s+that\s*$/i, "");
                return `<option value="${d}">${d}</option>`;
            }).join('')}</select>`;
            container.appendChild(div);
        });
    }

    function rebuildSentence() {
        const currentConfig = appData.sentenceConfigs[state.level] || defaultData.sentenceConfigs[1];
        let parts = [];
        currentConfig.forEach(type => { 
            let val = sentenceSlots[type];
            if(val) {
                if(type === 'link') val = val.replace(/\s+that\s*$/i, "");
                val = val.replace(/\s*\((Tone|Structure|Lang|Language)\)/gi, '').trim();
                parts.push(val);
            }
        });
        let str = parts.join(" ");
        if(str) { str = str.charAt(0).toUpperCase() + str.slice(1); if(!str.endsWith('.')) str += "."; }
        document.getElementById('sentence-stage').innerText = str || "Start picking words in the Lab...";
    }

    function commitSentence() {
        const text = document.getElementById('sentence-stage').innerText;
        if (text.includes("Start picking")) return;
        const area = document.getElementById('answer-area');
        area.value += (area.value ? "\n\n" : "") + text;
        
        if(state.currentIdx !== -1 && !state.completed.includes(state.currentIdx)) {
            state.completed.push(state.currentIdx);
        }
        localStorage.setItem('tsa_student_completed', JSON.stringify(state.completed)); 
        autoSaveProgress();
        
        sentenceSlots = { starter:"", point:"", method:"", quote:"", analysis:"", marker:"", link:"" };
        document.getElementById('quote-reference').style.display = 'none';
        
        const total = appData.items.length;
        if(state.completed.length === total) {
            triggerCelebration();
        }
        
        rebuildSentence(); renderBuilderDropdowns(); resetToGrid(); switchHub('lab');
    }
    
    function triggerCelebration() {
        const modal = document.getElementById('celebration-modal');
        modal.style.display = 'flex';
        const progBtn = document.getElementById('progression-btn-container');
        progBtn.innerHTML = '';
        const autoProgress = localStorage.getItem('tsa_auto_progress') === 'true';
        if(autoProgress && state.level < 3) {
            const nextBtn = document.createElement('button');
            nextBtn.className = 'btn btn-primary';
            nextBtn.innerText = `Advance to Level ${state.level + 1}`;
            nextBtn.onclick = () => {
                document.getElementById('level-select').value = state.level + 1;
                changeLevel();
                modal.style.display = 'none';
            };
            progBtn.appendChild(nextBtn);
        }
    }

    function undoLast() { sentenceSlots.analysis = ""; rebuildSentence(); }
    function clearEssay() { if(confirm("Clear Progress?")) { document.getElementById('answer-area').value=""; state.completed = []; localStorage.removeItem('tsa_student_essay'); localStorage.removeItem('tsa_student_completed'); resetToGrid(); } }

    function toggleAutoProgress(c) { if(c) localStorage.setItem('tsa_auto_progress', 'true'); else localStorage.removeItem('tsa_auto_progress'); }

    function downloadDoc() { 
        const BOM = "\ufeff";
        const html = `<html><head><meta charset="utf-8"><title>Essay</title></head><body>${document.getElementById('answer-area').value.replace(/\n/g,'<br>')}</body></html>`;
        const blob = new Blob([BOM + html], {type:'application/msword;charset=utf-8'}); 
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Answer.doc'; a.click(); 
    }

    // ADMIN FUNCTIONS
    function generateAndShowPrompt() { const c = document.getElementById('ai-quote-count').value; const t = document.getElementById('ai-source-text').value; const q = document.getElementById('ai-question-input').value; const a = document.getElementById('ai-author-name').value; document.getElementById('ai-generated-prompt').value = `Act as expert English teacher. Create JSON lesson.\nSOURCE: "${t}"\nQ: "${q}"\nAUTHOR: "${a}"\n\nREQUIRED JSON FORMAT:\n{ "textTitle": "Title", "question": "${q}", "items": [ { "id":"q1", "type":"structure", "original":"quote", "translation":"meaning", "distractors":["wrong1"], "level1":{}, "level2":{}, "level3":{} } ]... (include markers, starters, methods, points, simpleLinks (no 'that'), complexLinks) }`; document.getElementById('prompt-display-container').style.display='block'; }
    
    function loadDataFromText() { 
        let text = document.getElementById('ai-paste-area').value;
        text = text.replace(/```json/g, "").replace(/```/g, "").trim();
        try { 
            const json = JSON.parse(text);
            appData = validateAndRepair({...appData, ...json}); // RUN REPAIR ON LOAD
            sanitizeLinks(); 
            state.completed=[]; 
            saveLocal(); 
            location.reload(); 
        } catch(e){ 
            alert("Invalid JSON Error: " + e.message); 
        } 
    }
    
    function saveLocal() { localStorage.setItem('tsa_v144_stable', JSON.stringify(appData)); }
    function updateUI() { document.getElementById('student-title').innerText = appData.textTitle; document.getElementById('text-display').innerText = appData.textTitle; document.getElementById('q-display').innerText = appData.question; document.getElementById('score-display').innerText = state.score + " XP"; document.getElementById('edit-title').value = appData.textTitle; document.getElementById('edit-question').value = appData.question;}
    
    // GLOBAL ACCESS for buttons
    window.openAdmin = function() { document.getElementById('admin-modal').style.display='flex'; try{ renderItems(); }catch(e){} };
    window.closeAdmin = function() { document.getElementById('admin-modal').style.display='none'; };
    window.requestAdminAccess = function() { if(localStorage.getItem('tsa_auto_login')==='true') openAdmin(); else if(prompt("Password:")===appData.adminPassword) openAdmin(); };
    window.toggleAutoLogin = function(c) { if(c) localStorage.setItem('tsa_auto_login','true'); else localStorage.removeItem('tsa_auto_login'); };
    window.updateGlobal = function(k, v) { appData[k]=v; saveLocal(); updateUI(); };
    window.hardReset = function() { if(confirm("Reset?")) { localStorage.removeItem('tsa_v144_stable'); location.reload(); } };
    window.downloadJSON = function() { const b = new Blob([JSON.stringify(appData)], {type: "text/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'data.json'; a.click(); };
    window.downloadStudentApp = function() { const c = JSON.parse(JSON.stringify(appData)); delete c.adminPassword; let h = document.documentElement.outerHTML.replace(/const teacherConfig = null;/, `const teacherConfig = ${JSON.stringify(c)};`); const b = new Blob([h], {type:'text/html'}); const a = document.createElement('a'); a.href = URL.createObjectURL(b); a.download = 'student-lesson.html'; a.click(); };
    window.editBank = function(t) { currentEditingBank=t; document.getElementById('bank-editor-area').style.display='block'; document.getElementById('bank-editor-title').innerText=t.toUpperCase(); renderBankList(); };
    window.updateBankItem = function(i,v) { appData[currentEditingBank][i]=v; saveLocal(); };
    window.delBankItem = function(i) { appData[currentEditingBank].splice(i,1); renderBankList(); saveLocal(); };
    window.addBankItem = function() { if(!appData[currentEditingBank]) appData[currentEditingBank]=[]; appData[currentEditingBank].push("New"); renderBankList(); saveLocal(); };
    window.renderItems = renderItems; // Expose render function
    window.toggleDetails = toggleDetails;
    window.updateItem = updateItem;
    window.updateItemBool = updateItemBool;
    window.updateDeep = updateDeep;
    window.delItem = delItem;
    window.addNewItem = addNewItem;
    window.saveStructureConfig = saveStructureConfig;
    window.openPrintView = openPrintView;
    window.exportWordDoc = exportWordDoc;
    window.openThemeModal = openThemeModal;
    window.setTheme = setTheme;
    window.switchAdminConfigLevel = switchAdminConfigLevel;
    window.initAdminConfig = initAdminConfig;
    window.renderBankList = renderBankList;

    init();
</script>
</body>
</html>
