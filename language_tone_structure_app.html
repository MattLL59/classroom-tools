<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone, Structure & Language Architect</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #2c3e50; 
            --accent: #d35400; 
            --tone-col: #8e44ad; 
            --struct-col: #2980b9; 
            --lang-col: #27ae60; 
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-dyslexic: 'Comic Sans MS', sans-serif;
        }

        body { 
            font-family: var(--font-main); 
            background-color: var(--bg); color: #333; margin: 0; padding: 20px; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; text-align: center;
        }
        body.dyslexia-mode { font-family: var(--font-dyslexic); line-height: 1.6; }

        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding-bottom: 10px; border-bottom: 2px solid #ddd; flex-shrink: 0; 
        }
        h1 { margin: 0; color: var(--primary); font-size: 1.5rem; }
        
        .admin-btn { 
            font-size: 1.5rem; color: #555; background: white; border: 2px solid var(--accent); 
            border-radius: 50%; width: 45px; height: 45px; cursor: pointer; transition: all 0.2s;
        }
        .admin-btn:hover { transform: scale(1.1); background: #fff8f0; }

        .container { 
            flex-grow: 1; max-width: 1000px; width: 100%; margin: 20px auto; background: white; 
            border-radius: 12px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); padding: 20px; 
            display: flex; flex-direction: column; overflow-y: auto; position: relative;
        }

        .stage-area { display: none; animation: fadeIn 0.4s; flex-grow: 1; text-align: center; }
        .stage-area.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 15px; margin-top: 20px; }
        
        button.choice-btn { 
            padding: 20px; border: 2px solid #eee; border-radius: 10px; font-size: 1.1rem; 
            cursor: pointer; background: white; transition: all 0.2s; color: #333;
            display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 10px;
        }
        button.choice-btn:hover { transform: translateY(-3px); border-color: var(--accent); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        .btn-tone { border-bottom: 5px solid var(--tone-col); }
        .btn-struct { border-bottom: 5px solid var(--struct-col); }
        .btn-lang { border-bottom: 5px solid var(--lang-col); }
        .btn-tone:hover { background: #f3e5f5; }
        .btn-struct:hover { background: #e3f2fd; }
        .btn-lang:hover { background: #e8f5e9; }

        #sentence-builder { 
            margin-top: 20px; padding: 15px; background: #f8f9fa; border: 2px dashed #ccc; 
            border-radius: 8px; min-height: 60px; font-size: 1.1rem; color: #555;
        }
        .fragment { padding: 3px 8px; border-radius: 4px; border: 1px solid rgba(0,0,0,0.1); margin: 0 3px; display: inline-block;}
        
        #essay-display {
            display: none; margin-top: 20px; padding: 20px; background: #fff; border: 1px solid #ddd;
            border-left: 5px solid #f1c40f; border-radius: 8px; text-align: left; max-height: 150px; overflow-y: auto;
        }

        #admin-modal { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center; 
        }
        .admin-panel { 
            background: white; width: 95%; max-width: 1200px; height: 90%; border-radius: 8px; 
            display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
        }
        .panel-body { padding: 20px; overflow-y: auto; flex-grow: 1; text-align: left; }
        
        .editor-section { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; }
        .input-row { margin-bottom: 10px; }
        .input-row label { display: block; font-weight: bold; font-size: 0.9rem; margin-bottom: 5px; }
        .admin-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        #wizard-overlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index: 2500; flex-direction:column; padding:20px; box-sizing:border-box; }

        #overlay-msg { 
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(44, 62, 80, 0.95); z-index: 3000; color: white;
            flex-direction: column; justify-content: center; align-items: center;
        }
    </style>
</head>
<body>

    <header>
        <div style="display:flex; align-items:center; gap:15px;">
            <h1 id="app-title">Analysis Architect</h1>
            <select id="level-select" onchange="changeLevel()" style="padding:5px; border-radius:5px; border:1px solid #ccc;">
                <option value="1">Level 1: Foundation (G1-2)</option>
                <option value="2">Level 2: Developing (G3)</option>
                <option value="3">Level 3: Secure (G4+)</option>
            </select>
        </div>
        <button class="admin-btn" onclick="openAdmin()" title="Settings"><i class="fas fa-cog"></i></button>
    </header>

    <div class="container">
        <div style="display:flex; justify-content:space-between; margin-bottom:10px; font-weight:bold; color:#7f8c8d;">
            <span id="text-display">Text: Loading...</span>
            <span id="question-display">Question: ...</span>
        </div>

        <div id="stage-quote" class="stage-area active">
            <h2>Select Evidence</h2>
            <p>Choose a part of the text to analyze.</p>
            <div class="grid" id="quote-grid"></div>
        </div>

        <div id="stage-decoder" class="stage-area">
            <h2>Translation Bridge</h2>
            <p>What does this mean in modern English?</p>
            <div style="background:#fff3e0; padding:15px; margin-bottom:20px; font-style:italic; font-size:1.2rem;">
                "<span id="decoder-original"></span>"
            </div>
            <div class="grid" id="decoder-grid"></div>
        </div>

        <div id="stage-lens" class="stage-area">
            <h2>Choose Analysis Lens</h2>
            <p>Select the feature you want to focus on.</p>
            <div class="grid">
                <button class="choice-btn btn-tone" onclick="loadAnalysis('tone')">
                    <i class="fas fa-theater-masks fa-2x" style="color:var(--tone-col)"></i>
                    <strong>Tone</strong>
                    <small>Writer's Attitude</small>
                </button>
                <button class="choice-btn btn-struct" onclick="loadAnalysis('structure')">
                    <i class="fas fa-layer-group fa-2x" style="color:var(--struct-col)"></i>
                    <strong>Structure</strong>
                    <small>Whole Text & Sequencing</small>
                </button>
                <button class="choice-btn btn-lang" onclick="loadAnalysis('language')">
                    <i class="fas fa-book-open fa-2x" style="color:var(--lang-col)"></i>
                    <strong>Language</strong>
                    <small>Words & Imagery</small>
                </button>
            </div>
        </div>

        <div id="stage-analysis" class="stage-area">
            <h2 id="analysis-title">Analysis</h2>
            <p id="analysis-prompt">...</p>
            <div class="grid" id="analysis-grid"></div>
        </div>

        <div id="sentence-builder"><span style="color:#ccc;">Paragraph builds here...</span></div>

        <div id="essay-display">
            <h3>Your Essay:</h3>
            <div id="essay-content"></div>
            <button onclick="clearEssay()" style="margin-top:10px; background:#e74c3c; color:white; border:none; padding:5px 10px; cursor:pointer;">Clear</button>
        </div>
    </div>

    <div id="overlay-msg" onclick="this.style.display='none'">
        <i id="overlay-icon" class="fas fa-check-circle" style="font-size:4rem; margin-bottom:20px;"></i>
        <h2 id="overlay-text">Correct!</h2>
    </div>

    <div id="admin-modal">
        <div class="admin-panel">
            <div style="padding:15px; background:#eee; display:flex; justify-content:space-between; align-items:center;">
                <strong>Teacher Settings</strong>
                <button onclick="closeAdmin()" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">&times;</button>
            </div>
            <div class="panel-body">
                
                <div style="background:linear-gradient(135deg, #e67e22 0%, #d35400 100%); padding:20px; border-radius:8px; color:white; margin-bottom:20px; text-align:center;">
                    <h3 style="margin:0 0 10px 0;">âœ¨ AI Import Wizard (Whole-Text Logic)</h3>
                    <p style="margin:0 0 15px 0;">Generate analysis that compares paragraphs.</p>
                    <button class="choice-btn" style="border:none; color:#333; padding:10px 20px;" onclick="openWizard()">Open Wizard</button>
                </div>

                <div style="margin-bottom:20px; padding:15px; background:#e3f2fd; border-radius:5px;">
                    <h3>ðŸ’¾ Data & Worksheet</h3>
                    <button class="choice-btn" style="padding:5px 15px; display:inline-block;" onclick="downloadData()">Save Data</button>
                    <button class="choice-btn" style="padding:5px 15px; display:inline-block;" onclick="document.getElementById('file-in').click()">Load Data</button>
                    <input type="file" id="file-in" style="display:none" onchange="loadData(this)">
                    <hr>
                    <label><strong>Print Worksheet for Level:</strong></label>
                    <select id="print-level" style="padding:5px;"><option value="1">Level 1</option><option value="2">Level 2</option><option value="3">Level 3</option></select>
                    <button class="choice-btn" style="padding:5px 15px; background:var(--primary); color:white; display:inline-block;" onclick="printWorksheet()">Generate PDF</button>
                </div>

                <div class="input-row">
                    <label>Text Title:</label>
                    <input id="edit-title" class="admin-input" onchange="updateGlobal('textTitle', this.value)">
                </div>
                <div class="input-row">
                    <label>Focus Question:</label>
                    <input id="edit-question" class="admin-input" onchange="updateGlobal('question', this.value)">
                </div>

                <h3>Quote Editor</h3>
                <div id="quote-editor-container"></div>
                <button class="choice-btn" style="width:100%; background:#27ae60; color:white;" onclick="addQuote()">+ Add New Quote</button>
            </div>
        </div>
    </div>

    <div id="wizard-overlay">
        <h2>âœ¨ AI Import Wizard</h2>
        <div style="display:flex; gap:20px; height:100%;">
            <div style="flex:1; display:flex; flex-direction:column;">
                <p><strong>Step 1:</strong> Paste FULL Text & Question.</p>
                <textarea id="wiz-text" class="admin-input" style="flex:1; resize:none;" placeholder="Paste the whole text here to allow structural comparison..."></textarea>
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <input id="wiz-q" class="admin-input" style="flex:2;" placeholder="Question">
                    <input id="wiz-count" type="number" class="admin-input" style="flex:1;" value="3" min="1" title="Quotes">
                </div>
            </div>
            <div style="flex:1; display:flex; flex-direction:column;">
                <p><strong>Step 2:</strong> Generate Prompt.</p>
                <button class="choice-btn" style="background:#3498db; color:white; margin-bottom:10px;" onclick="generatePrompt()">Generate Prompt</button>
                <textarea id="wiz-prompt" class="admin-input" style="height:100px; background:#eee;" readonly></textarea>
                
                <p><strong>Step 3:</strong> Paste JSON (Auto-Fix enabled).</p>
                <textarea id="wiz-json" class="admin-input" style="flex:1; resize:none;" placeholder="Paste JSON here..."></textarea>
                <button class="choice-btn" style="background:#27ae60; color:white; margin-top:10px;" onclick="loadFromWizard()">ðŸš€ Review & Load</button>
                <button class="choice-btn" style="background:#95a5a6; color:white; margin-top:5px;" onclick="document.getElementById('wizard-overlay').style.display='none'">Cancel</button>
            </div>
        </div>
    </div>

<script>
    // ==========================================
    // 1. DATA STRUCTURE (Pedagogically Correct)
    // ==========================================
    var defaultData = {
        textTitle: "The Electric Telegraph (1851)",
        question: "How does the writer convey the impact of the telegraph?",
        quotes: [
            {
                id: "q1",
                original: "We stand at the dawn of a communications revolution.",
                translation: "We are at the start of a huge change in how we communicate.",
                distractor: "We are standing outside in the morning.",
                level1: {
                    tone: { prompt: "The word 'Revolution' makes the tone:", correct: "Dramatic", options: ["Dramatic", "Calm"] },
                    structure: { prompt: "This is the very LAST sentence. Why put it here?", correct: "To give a powerful ending", options: ["To give a powerful ending", "To start the story"] },
                    language: { prompt: "The word 'dawn' is a metaphor for:", correct: "A new beginning", options: ["A new beginning", "The sun rising"] }
                },
                level2: {
                    tone: { prompt: "The tone of this conclusion is:", correct: "Prophetic (Predicting the future)", options: ["Prophetic (Predicting the future)", "Confused", "Angry"] },
                    structure: { prompt: "How does this ending connect to the rest of the text?", correct: "It summarizes the main idea of 'progress' seen throughout.", options: ["It summarizes the main idea of 'progress'.", "It introduces a totally new topic.", "It repeats the first sentence exactly."] },
                    language: { prompt: "Analyze the word 'Revolution'.", correct: "It suggests a total and permanent change to society.", options: ["It suggests a total and permanent change.", "It suggests a small improvement.", "It suggests a war is coming."] }
                },
                level3: {
                    tone: { prompt: "Analyze the shift in tone at the end.", correct: "The tone shifts from informative to visionary, elevating the telegraph to a history-changing event.", options: ["The tone shifts from informative to visionary.", "The tone becomes sarcastic.", "The tone remains flat and factual."] },
                    structure: { prompt: "Analyze the text's macro-structure (The Arc).", correct: "The text moves from specific technical details (middle) to a grand philosophical conclusion (end), widening the scope.", options: ["It moves from technical details to a grand conclusion.", "It stays focused on small details the whole time.", "It ends abruptly without a conclusion."] },
                    language: { prompt: "Analyze the imagery of 'dawn'.", correct: "It connotes light and hope, implying the 'dark' age of slow communication is over.", options: ["It connotes light and hope for the future.", "It is a literal reference to the time of day.", "It suggests the writer is tired."] }
                }
            }
        ]
    };

    var appData = JSON.parse(JSON.stringify(defaultData));
    var state = { level: 1, currentQuoteIdx: 0, buffer: {}, streak: 0 };

    // ==========================================
    // 2. CORE LOGIC
    // ==========================================
    function init() {
        var local = localStorage.getItem('tsa_data_v9_whole_text');
        if(local) try { appData = JSON.parse(local); } catch(e) {}
        updateDOM();
        loadStage1();
    }

    function changeLevel() {
        state.level = parseInt(document.getElementById('level-select').value);
        state.streak = 0;
        updateDOM();
        loadStage1();
    }

    function updateDOM() {
        document.getElementById('text-display').innerText = "Text: " + appData.textTitle;
        document.getElementById('question-display').innerText = "Q: " + (appData.question || "Analysis");
        if(!appData.quotes || appData.quotes.length === 0) {
            document.getElementById('quote-grid').innerHTML = "<p>No data. Use Settings > Wizard.</p>";
        }
    }

    // STAGE 1: QUOTE SELECT
    function loadStage1() {
        showStage('stage-quote');
        var grid = document.getElementById('quote-grid');
        grid.innerHTML = '';
        if(appData.quotes && appData.quotes.length > 0) {
            appData.quotes.forEach((q, i) => {
                var btn = document.createElement('button');
                btn.className = 'choice-btn';
                btn.innerHTML = `"${q.original}"`;
                btn.onclick = () => startFlow(i);
                grid.appendChild(btn);
            });
        }
        state.buffer = {};
        updateBuilder();
    }

    function startFlow(idx) {
        state.currentQuoteIdx = idx;
        loadStage2();
    }

    // STAGE 2: DECODER
    function loadStage2() {
        showStage('stage-decoder');
        var q = appData.quotes[state.currentQuoteIdx];
        document.getElementById('decoder-original').innerText = q.original;
        
        var grid = document.getElementById('decoder-grid');
        grid.innerHTML = '';
        
        var opts = [
            { txt: q.translation, correct: true },
            { txt: q.distractor, correct: false }
        ].sort(() => Math.random() - 0.5);

        opts.forEach(opt => {
            var btn = document.createElement('button');
            btn.className = 'choice-btn';
            btn.innerText = opt.txt;
            btn.onclick = () => handleDecoder(opt.correct, btn, q.original, q.translation);
            grid.appendChild(btn);
        });
    }

    function handleDecoder(correct, btn, orig, trans) {
        if(correct) {
            feedback(true, "Spot on!");
            state.buffer.part1 = `The writer uses the phrase "${orig}"`;
            state.buffer.part2 = `(which means ${trans}).`;
            updateBuilder();
            setTimeout(() => showStage('stage-lens'), 1000);
        } else {
            feedback(false, "Try again.");
            state.streak = 0;
            updateDOM();
        }
    }

    // STAGE 3: ANALYSIS
    function loadAnalysis(lens) {
        showStage('stage-analysis');
        var q = appData.quotes[state.currentQuoteIdx];
        var lvlKey = 'level' + state.level;
        
        if(!q[lvlKey] || !q[lvlKey][lens]) {
            alert("Data missing for Level " + state.level);
            loadStage1();
            return;
        }

        var data = q[lvlKey][lens]; 
        document.getElementById('analysis-title').innerText = "Analyzing " + lens.charAt(0).toUpperCase() + lens.slice(1);
        document.getElementById('analysis-prompt').innerText = data.prompt;

        var grid = document.getElementById('analysis-grid');
        grid.innerHTML = '';

        var opts = [...data.options].sort(() => Math.random() - 0.5);
        opts.forEach(opt => {
            var btn = document.createElement('button');
            btn.className = 'choice-btn';
            if(lens === 'tone') btn.classList.add('btn-tone');
            if(lens === 'structure') btn.classList.add('btn-struct');
            if(lens === 'language') btn.classList.add('btn-lang');
            
            btn.innerText = opt;
            btn.onclick = () => handleAnalysis(opt === data.correct, btn, opt);
            grid.appendChild(btn);
        });
    }

    function handleAnalysis(correct, btn, text) {
        if(correct) {
            feedback(true, "Analysis Complete!");
            state.buffer.part3 = text;
            updateBuilder();
            addToEssay();
            setTimeout(loadStage1, 1500);
        } else {
            feedback(false, "Think closer...");
        }
    }

    // ==========================================
    // 3. UI HELPERS
    // ==========================================
    function showStage(id) {
        document.querySelectorAll('.stage-area').forEach(el => el.classList.remove('active'));
        document.getElementById(id).classList.add('active');
    }

    function updateBuilder() {
        var h = "";
        if(state.buffer.part1) h += `<span class="fragment" style="background:#e3f2fd">${state.buffer.part1}</span> `;
        if(state.buffer.part2) h += `<span class="fragment" style="background:#fff3e0">${state.buffer.part2}</span> `;
        if(state.buffer.part3) h += `<span class="fragment" style="background:#e8f5e9">${state.buffer.part3}</span>`;
        document.getElementById('sentence-builder').innerHTML = h || "<span style='color:#ccc'>Paragraph builds here...</span>";
    }

    function addToEssay() {
        var text = Object.values(state.buffer).join(" ");
        var div = document.getElementById('essay-content');
        div.innerHTML += `<p>${text}</p>`;
        document.getElementById('essay-display').style.display = 'block';
    }

    function clearEssay() {
        document.getElementById('essay-content').innerHTML = '';
        document.getElementById('essay-display').style.display = 'none';
    }

    function feedback(success, txt) {
        var ol = document.getElementById('overlay-msg');
        var text = document.getElementById('overlay-text');
        var icon = document.getElementById('overlay-icon');
        ol.style.display = 'flex';
        text.innerText = txt;
        if(success) {
            ol.style.background = 'rgba(39, 174, 96, 0.9)';
            icon.className = 'fas fa-check-circle';
        } else {
            ol.style.background = 'rgba(192, 57, 43, 0.9)';
            icon.className = 'fas fa-times-circle';
        }
        setTimeout(() => ol.style.display = 'none', 1000);
    }

    // ==========================================
    // 4. ADMIN & WIZARD (STRICT STRUCTURE + WHOLE TEXT)
    // ==========================================
    function openAdmin() { 
        document.getElementById('admin-modal').style.display = 'flex'; 
        document.getElementById('edit-title').value = appData.textTitle;
        document.getElementById('edit-question').value = appData.question || "";
        renderEditor(); 
    }
    function closeAdmin() { 
        document.getElementById('admin-modal').style.display = 'none'; 
        localStorage.setItem('tsa_data_v9_whole_text', JSON.stringify(appData));
        updateDOM();
        loadStage1();
    }
    
    function updateGlobal(k, v) { appData[k] = v; }

    function openWizard() { document.getElementById('wizard-overlay').style.display = 'flex'; }
    function generatePrompt() {
        var text = document.getElementById('wiz-text').value;
        var q = document.getElementById('wiz-q').value;
        var count = document.getElementById('wiz-count').value || 3;
        
        // --- THE PEDAGOGICALLY CORRECT PROMPT ---
        var prompt = `I need you to act as a JSON generator for a GCSE English App.
I have a text: "${text.substring(0, 300)}..."
And a question: "${q}"
Please extract ${count} key quotes/moments.

CRITICAL INSTRUCTIONS FOR STRUCTURE:
- DO NOT confuse structure with content.
- Structure must refer to: Syntax (Sentence length/type), Paragraphing, Sequencing (Opening/Ending), Shifts in focus.
- The Analysis for Structure MUST relate the quote to the WHOLE TEXT (e.g. "This opening contrasts with the ending").

LEVEL DEFINITIONS:
- Level 1 (Grade 1/2): Simple binary choices (Start vs End, Long vs Short).
- Level 2 (Grade 3): Identification of effect (e.g. "The list suggests variety").
- Level 3 (Grade 4+): Explanation of purpose (e.g. "The shift from description to dialogue increases the pace").

Return ONLY valid JSON matching this exact structure:
{
  "textTitle": "Title",
  "question": "${q}",
  "quotes": [
    {
      "id": "q1",
      "original": "quote",
      "translation": "meaning",
      "distractor": "plausible wrong meaning",
      "level1": { "tone": {"prompt": "Q", "correct": "A", "options": ["A","B"]}, "structure": {"prompt": "Q (Focus: Start/End/Length)", "correct": "A", "options": ["A","B"]}, "language": {"prompt": "Q", "correct": "A", "options": ["A","B"]} },
      "level2": { "tone": {"prompt": "Q", "correct": "A", "options": ["A","B"]}, "structure": {"prompt": "Q (Focus: Link to whole text)", "correct": "A", "options": ["A","B"]}, "language": {"prompt": "Q", "correct": "A", "options": ["A","B"]} },
      "level3": { "tone": {"prompt": "Q", "correct": "A", "options": ["A","B"]}, "structure": {"prompt": "Q (Focus: Progression/Arc)", "correct": "A", "options": ["A","B"]}, "language": {"prompt": "Q", "correct": "A", "options": ["A","B"]} }
    }
  ]
}`;
        document.getElementById('wiz-prompt').value = prompt;
    }
    
    function loadFromWizard() {
        var raw = document.getElementById('wiz-json').value.trim();
        raw = raw.replace(/^```json/i, '').replace(/^```/i, '').replace(/```$/i, '');
        var first = raw.indexOf('{');
        var last = raw.lastIndexOf('}');
        
        if (first === -1 || last === -1) { alert("Could not find JSON object."); return; }
        
        try {
            var json = JSON.parse(raw.substring(first, last + 1));
            if(json.quotes) {
                appData = json;
                renderEditor();
                document.getElementById('edit-title').value = appData.textTitle;
                document.getElementById('edit-question').value = appData.question;
                document.getElementById('wizard-overlay').style.display = 'none';
                alert("Data Loaded! Check the Structure definitions below.");
            } else { alert("JSON missing 'quotes' array."); }
        } catch(e) { alert("JSON Error: " + e.message); }
    }

    function renderEditor() {
        var con = document.getElementById('quote-editor-container');
        con.innerHTML = '';
        if(!appData.quotes) return;
        
        appData.quotes.forEach((q, i) => {
            var div = document.createElement('div');
            div.className = 'editor-section';
            
            var levelsHTML = '';
            [1, 2, 3].forEach(lvl => {
                var k = 'level'+lvl;
                levelsHTML += `
                    <div style="background:#f9f9f9; padding:10px; margin-top:5px; border:1px solid #eee;">
                        <strong>Level ${lvl} Settings</strong>
                        <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:5px;">
                            ${renderFieldBlock(i, lvl, 'tone', 'Tone')}
                            ${renderFieldBlock(i, lvl, 'structure', 'Struct')}
                            ${renderFieldBlock(i, lvl, 'language', 'Lang')}
                        </div>
                    </div>`;
            });

            div.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <strong>Quote #${i+1}</strong> 
                    <button onclick="delQuote(${i})" style="color:red;border:none;">Del</button>
                </div>
                <div class="input-row"><label>Original:</label><input class="admin-input" value="${q.original}" onchange="editQ(${i}, 'original', this.value)"></div>
                <div style="display:flex; gap:10px;">
                    <div class="input-row" style="flex:1"><label>Translation:</label><input class="admin-input" value="${q.translation}" onchange="editQ(${i}, 'translation', this.value)"></div>
                    <div class="input-row" style="flex:1"><label>Distractor:</label><input class="admin-input" value="${q.distractor}" onchange="editQ(${i}, 'distractor', this.value)"></div>
                </div>
                ${levelsHTML}
            `;
            con.appendChild(div);
        });
    }

    function renderFieldBlock(qIdx, lvl, type, label) {
        var k = 'level'+lvl;
        var val = appData.quotes[qIdx][k] ? appData.quotes[qIdx][k][type] : { correct: "" };
        return `
            <div>
                <label style="font-size:0.8rem; color:gray;">${label} Answer</label>
                <input class="admin-input" style="font-size:0.8rem" value="${val.correct}" onchange="editDeep(${qIdx}, ${lvl}, '${type}', 'correct', this.value)">
            </div>
        `;
    }

    function editQ(i, k, v) { appData.quotes[i][k] = v; }
    function editDeep(i, lvl, type, field, v) {
        var key = 'level'+lvl;
        if(!appData.quotes[i][key]) appData.quotes[i][key] = {};
        if(!appData.quotes[i][key][type]) appData.quotes[i][key][type] = { options: [] };
        appData.quotes[i][key][type][field] = v;
        if(!appData.quotes[i][key][type].options.includes(v)) {
            appData.quotes[i][key][type].options[0] = v; 
        }
    }
    
    function addQuote() {
        var blankLvl = {
            tone: { prompt: "Tone Q?", correct: "Ans", options: ["Ans", "Dist"] },
            structure: { prompt: "Struct Q?", correct: "Ans", options: ["Ans", "Dist"] },
            language: { prompt: "Lang Q?", correct: "Ans", options: ["Ans", "Dist"] }
        };
        appData.quotes.push({
            id: Date.now(), original: "New", translation: "Trans", distractor: "Bad",
            level1: JSON.parse(JSON.stringify(blankLvl)),
            level2: JSON.parse(JSON.stringify(blankLvl)),
            level3: JSON.parse(JSON.stringify(blankLvl))
        });
        renderEditor();
    }
    function delQuote(i) { appData.quotes.splice(i,1); renderEditor(); }

    function downloadData() {
        var a = document.createElement('a');
        a.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(appData));
        a.download = 'tsa_data.json';
        a.click();
    }
    function loadData(input) {
        var fr = new FileReader();
        fr.onload = (e) => { appData = JSON.parse(e.target.result); renderEditor(); updateDOM(); loadStage1(); };
        fr.readAsText(input.files[0]);
    }

    function printWorksheet() {
        var lvl = document.getElementById('print-level').value;
        var w = window.open();
        var h = `<html><head><title>Worksheet Level ${lvl}</title>
        <style>body{font-family:sans-serif; padding:20px;} table{width:100%; border-collapse:collapse; margin-bottom:20px;} td,th{border:1px solid #333; padding:10px; text-align:left;} .box{border:1px dashed #999; height:50px; background:#f9f9f9;}</style>
        </head><body>
        <h1>Analysis Worksheet: ${appData.textTitle}</h1>
        <h3>Level ${lvl} Focus | Question: ${appData.question || "Analysis"}</h3>
        
        <h4>Task 1: Decoding</h4>
        <table><tr><th>Quote</th><th>Meaning</th></tr>
        ${appData.quotes.map(q => `<tr><td>"${q.original}"</td><td>__________________</td></tr>`).join('')}
        </table>
        
        <h4>Task 2: Targeted Analysis</h4>
        ${appData.quotes.map((q, i) => {
            var lData = q['level'+lvl];
            return `
                <div style="border:1px solid #ccc; padding:15px; margin-bottom:15px; break-inside:avoid;">
                    <strong>${i+1}. "${q.original}"</strong><br><br>
                    <strong>Tone:</strong> ${lData.tone.prompt}<br>
                    <div class="box"></div><br>
                    <strong>Structure:</strong> ${lData.structure.prompt}<br>
                    <div class="box"></div><br>
                    <strong>Language:</strong> ${lData.language.prompt}<br>
                    <div class="box"></div>
                </div>
            `;
        }).join('')}
        </body></html>`;
        w.document.write(h);
        w.print();
        w.close();
    }

    init();
</script>
</body>
</html>
