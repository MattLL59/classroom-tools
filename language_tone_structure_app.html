<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tone & Structure Architect v62 (Mobile & Access)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES (THEME ENGINE) --- */
        :root {
            --primary: #009688; 
            --accent: #ff9800; 
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #37474f;
            --tone-col: #9c27b0;
            --struct-col: #2196f3;
            --lang-col: #4caf50;
            --font-size-base: 16px;
        }

        /* DYSLEXIA FRIENDLY OVERRIDES */
        body.theme-dyslexia { --bg: #fdf5e6; --text: #222; --card: #fffcf5; font-family: 'Comic Sans MS', 'Verdana', sans-serif; }
        body.theme-contrast { --bg: #000; --text: #ffff00; --card: #222; --primary: #ffff00; --accent: #00ffff; }
        body.theme-magenta { --bg: #b30089; --text: #ffffff; --card: #800062; --primary: #fff; --accent: #ffeb3b; }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); color: var(--text); margin: 0; padding: 10px; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; text-align: center;
            font-size: var(--font-size-base); transition: background 0.3s, color 0.3s;
        }

        /* HEADER RESPONSIVE */
        header { 
            display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; 
            padding: 10px; background: var(--card); border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            flex-shrink: 0; margin-bottom: 10px; gap: 10px;
        }
        h1 { margin: 0; color: var(--primary); font-size: 1.2rem; display:flex; align-items:center; gap:5px; flex-grow: 1; text-align: left; }
        
        .header-controls { display: flex; gap: 5px; align-items: center; }

        /* STUDENT BANNER */
        #student-banner {
            display: none; width: 100%; background: var(--accent); color: white; 
            padding: 8px; border-radius: 5px; margin-bottom: 10px; font-weight: bold; font-size: 0.9rem;
        }

        .admin-btn, .theme-btn { 
            font-size: 1rem; color: #555; background: #eee; border: 1px solid #ccc;
            border-radius: 5px; padding: 6px 10px; cursor: pointer; transition: all 0.2s;
        }
        .theme-btn { background: var(--bg); color: var(--text); border-color: var(--text); }

        .container { 
            flex-grow: 1; width: 100%; margin: 0 auto; 
            display: flex; flex-direction: column; gap: 10px; overflow-y: auto; padding-bottom: 10px;
        }

        .stage { display: none; animation: fadeIn 0.3s; }
        .stage.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .instruction { color: var(--text); opacity: 0.7; margin-bottom: 5px; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; }
        .dynamic-question { font-size: 1.2rem; color: var(--primary); font-weight: bold; margin-bottom: 10px; }

        /* RESPONSIVE GRID */
        .grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Wider min-width for phones */
            gap: 10px; 
            padding-bottom: 20px;
        }
        
        .card { 
            background: var(--card); padding: 15px; border-radius: 8px; border: 2px solid #ddd;
            cursor: pointer; transition: transform 0.1s;
            display: flex; flex-direction: column; justify-content: center; min-height: 70px;
            color: var(--text);
        }
        .card:hover { border-color: var(--primary); transform: scale(1.01); }
        .card-struct { border-left: 8px solid var(--struct-col) !important; text-align: left; align-items: flex-start !important; }
        .card-lang { border-left: 8px solid var(--lang-col) !important; }
        .card-tone { border-left: 8px solid var(--tone-col) !important; }

        .card strong { font-size: 1.1rem; display: block; margin-bottom: 4px; }
        .card small { font-size: 0.85rem; opacity: 0.8; font-style: italic; }

        /* BUILDER PANEL RESPONSIVE */
        .builder-panel {
            background: var(--card); border-radius: 10px; padding: 10px; border-top: 4px solid var(--primary);
            box-shadow: 0 -4px 15px rgba(0,0,0,0.1); flex-shrink: 0;
        }
        
        .controls { 
            display: flex; gap: 5px; justify-content: flex-start; margin-bottom: 10px; 
            overflow-x: auto; padding-bottom: 5px; -webkit-overflow-scrolling: touch;
        }
        
        .bank-group { display: flex; flex-direction: column; gap: 2px; align-items: flex-start; min-width: 120px; }
        .bank-label { font-size: 0.7rem; opacity: 0.6; font-weight: bold; text-transform: uppercase; }
        
        select.bank-select { 
            padding: 8px; border: 1px solid #ccc; border-radius: 5px; width: 100%;
            background: var(--bg); color: var(--text); font-size: 0.9rem;
        }

        .locked-slot {
            padding: 8px; border: 1px dashed var(--primary); border-radius: 5px;
            background: rgba(0, 150, 136, 0.1); color: var(--primary); font-size: 0.8rem;
            font-weight: bold; width: 100%; text-align: center; box-sizing: border-box;
        }

        #sentence-stage { 
            width: 100%; padding: 10px; border: 2px dashed #ccc; border-radius: 5px; 
            font-size: 1rem; margin-bottom: 5px; box-sizing: border-box;
            background: var(--bg); color: var(--text);
        }
        #structure-preview { font-size: 0.7rem; opacity: 0.6; text-align: left; margin-bottom: 10px; font-family: monospace; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        #answer-area { 
            width: 100%; height: 120px; padding: 10px; border: 1px solid #ccc; border-radius: 5px; 
            font-family: inherit; font-size: 1rem; resize: vertical; display: none; box-sizing: border-box;
            background: var(--bg); color: var(--text);
        }

        .btn { padding: 10px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; margin-top:5px; font-size: 0.9rem;}
        .btn-primary { background: var(--primary); }
        .btn-accent { background: var(--accent); }
        .btn-doc { background: #2b5797; }
        .btn-danger { background: #e74c3c; padding: 4px 8px; font-size: 0.8rem; margin-left: 5px; }
        .btn-add { background: #2ecc71; width: 100%; }
        .btn-warning { background: #f39c12; color: white; }
        
        /* MODALS */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { 
            background: var(--card); color: var(--text); width: 95%; max-width: 800px; max-height: 90vh; 
            border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
        }
        .modal-header { padding: 15px; background: rgba(0,0,0,0.05); display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-body { padding: 20px; overflow-y: auto; text-align: left; }

        /* THEME MODAL SPECIFICS */
        .theme-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .theme-opt { 
            padding: 15px; text-align: center; border: 2px solid #ddd; border-radius: 8px; cursor: pointer; 
            font-weight: bold; 
        }
        .theme-opt:hover { border-color: var(--primary); }

        .list-container { margin-bottom: 15px; }
        .list-item { display: flex; align-items: center; margin-bottom: 5px; }
        .list-input { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .editor-section { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; background: rgba(0,0,0,0.02); }
        .admin-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 5px; }
        .analysis-details { margin-top: 10px; padding: 15px; border: 2px solid var(--tone-col); border-radius: 5px; display:none; }
        .lens-group { display: none; } .lens-group.active { display: block; }
        .level-block { margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        
        #phrasing-overlay { z-index: 2000; background: rgba(0,0,0,0.8); }
        .phrase-option { 
            background: #fff; color: #333; padding: 15px; margin-bottom: 10px; border-radius: 8px; 
            cursor: pointer; font-size: 1.1rem; border: 2px solid transparent; 
        }
        .phrase-option:hover { border-color: var(--primary); background: #f0f0f0; }

        #overlay-msg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); z-index: 3000; color: white; flex-direction: column; justify-content: center; align-items: center; }
        
        .hard-reset-btn { background: #e74c3c; color: white; border: none; padding: 5px 8px; border-radius: 5px; font-size: 0.7rem; cursor: pointer; }
        .filter-bar { display: flex; gap: 5px; justify-content: center; margin-bottom: 10px; flex-wrap: wrap; }
        .filter-btn { padding: 8px 12px; border: 1px solid #ccc; background: var(--card); color: var(--text); border-radius: 20px; cursor: pointer; font-size: 0.8rem; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-cubes"></i> Tone & Structure v62</h1>
        <div class="header-controls">
            <button class="theme-btn" onclick="openThemeModal()"><i class="fas fa-palette"></i></button>
            <button id="reset-btn" class="hard-reset-btn" onclick="hardReset()">Reset</button>
            <select id="level-select" onchange="changeLevel()" style="padding:5px; border-radius:5px; border:1px solid #ccc;">
                <option value="1">Lvl 1</option>
                <option value="2">Lvl 2</option>
                <option value="3">Lvl 3</option>
            </select>
            <button id="admin-btn" class="admin-btn" onclick="requestAdminAccess()"><i class="fas fa-cog"></i></button>
        </div>
    </header>

    <div id="student-banner">
        üéì Student Mode: <span id="student-title"></span>
    </div>

    <div class="container">
        <div style="display:flex; justify-content:space-between; color:var(--text); opacity:0.8; font-size:0.85rem;">
            <span><strong id="text-display">Loading...</strong></span>
            <span><span id="q-display">...</span></span>
        </div>

        <div id="stage-select" class="stage active">
            <div class="instruction">Step 1: Evidence</div>
            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterGrid('all', this)">All</button>
                <button class="filter-btn" onclick="filterGrid('language', this)">Tone/Lang</button>
                <button class="filter-btn" onclick="filterGrid('structure', this)">Structure</button>
            </div>
            <div id="dynamic-question-display" class="dynamic-question">Select Evidence</div>
            <div class="grid" id="grid-main"></div>
        </div>

        <div id="stage-decoder" class="stage">
            <div class="instruction">Step 2: Translate</div>
            <div style="background:rgba(0,0,0,0.05); padding:15px; border-radius:8px; margin-bottom:15px; font-size:1.1rem; color:var(--text);">
                "<span id="decoder-quote"></span>"
            </div>
            <div class="grid" id="grid-decoder"></div>
        </div>

        <div id="stage-lens" class="stage">
            <div class="instruction">Step 3: Lens</div>
            <div class="grid">
                <div class="card card-tone" onclick="loadAnalysis('tone')"><strong>üé≠ Tone</strong><small>Emotion</small></div>
                <div class="card card-struct" onclick="loadAnalysis('structure')"><strong>üèóÔ∏è Structure</strong><small>Order/Shift</small></div>
                <div class="card card-lang" onclick="loadAnalysis('language')"><strong>üìñ Language</strong><small>Devices</small></div>
            </div>
        </div>

        <div id="stage-analysis" class="stage">
            <div class="instruction" id="analysis-prompt">...</div>
            <div class="grid" id="grid-analysis"></div>
        </div>
    </div>

    <div class="builder-panel">
        <div class="instruction" style="text-align:center;">Answer Builder</div>
        <div class="controls" id="dynamic-builder-controls"></div>
        <input type="text" id="sentence-stage" placeholder="Answer builds here...">
        <div id="structure-preview">Structure: [Empty]</div>
        <textarea id="answer-area" placeholder="Your full answer..."></textarea>
        <div id="essay-controls" style="display:none; margin-top:10px; justify-content:flex-end; gap:5px;">
            <button class="btn btn-doc" style="flex:1" onclick="downloadDoc()">Download (.doc)</button>
            <button class="btn btn-accent" style="flex:0 0 auto;" onclick="clearEssay()">Clear</button>
        </div>
    </div>

    <div id="theme-modal" class="modal">
        <div class="modal-content" style="max-width:400px;">
            <div class="modal-header">Select Theme <button onclick="document.getElementById('theme-modal').style.display='none'" style="border:none;background:none;font-size:1.5rem;">&times;</button></div>
            <div class="modal-body">
                <div class="theme-grid">
                    <div class="theme-opt" style="background:#f0f2f5; color:#333;" onclick="setTheme('default')">Default</div>
                    <div class="theme-opt" style="background:#fdf5e6; color:#222;" onclick="setTheme('dyslexia')">Cream (Dyslexia)</div>
                    <div class="theme-opt" style="background:#000; color:#ffff00;" onclick="setTheme('contrast')">High Contrast</div>
                    <div class="theme-opt" style="background:#b30089; color:#fff;" onclick="setTheme('magenta')">Magenta</div>
                </div>
                <hr>
                <label>Custom Background:</label>
                <input type="color" id="custom-bg" onchange="setCustomTheme()" style="width:100%;">
                <label style="margin-top:10px; display:block;">Custom Text:</label>
                <input type="color" id="custom-text" onchange="setCustomTheme()" style="width:100%;">
            </div>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Settings 
                <div>
                    <button class="btn btn-warning" onclick="changePassword()" style="font-size:0.8rem; margin-right:5px;">Change PW</button>
                    <button onclick="closeAdmin()" style="border:none;background:none;font-size:1.5rem;">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="editor-section">
                    <h3>Basic Info</h3>
                    <label>Title:</label><input id="edit-title" class="admin-input" oninput="updateGlobal('textTitle', this.value)">
                    <label>Question:</label><input id="edit-question" class="admin-input" oninput="updateGlobal('question', this.value)">
                </div>
                
                <div class="editor-section">
                    <h3>Data Management</h3>
                    <div style="display:flex; gap:5px;">
                        <button class="btn btn-doc" onclick="downloadJSON()">Save JSON</button>
                        <button class="btn btn-doc" onclick="document.getElementById('file-up').click()">Load JSON</button>
                        <input type="file" id="file-up" style="display:none;" onchange="uploadJSON(this)">
                    </div>
                    <hr>
                    <button class="btn btn-primary" style="width:100%;" onclick="downloadStudentApp()">üì¶ Download Student App (HTML)</button>
                </div>

                <div class="editor-section">
                    <h3>Analysis Points</h3>
                    <div id="items-container"></div>
                    <button class="btn btn-add" onclick="addNewItem()">+ Add Point</button>
                </div>
                </div>
        </div>
    </div>

    <div id="phrasing-overlay" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">Select Phrasing</div>
            <div class="modal-body">
                <p>You chose: <strong id="phrase-word" style="color:var(--primary);"></strong></p>
                <div id="phrase-options"></div>
            </div>
        </div>
    </div>

    <div id="overlay-msg" onclick="this.style.display='none'">
        <i id="overlay-icon" class="fas fa-check-circle" style="font-size:4rem; margin-bottom:20px;"></i>
        <h2 id="overlay-text">Correct!</h2>
    </div>

<script>
    // --- INJECTION POINT ---
    /* DATA_START */ const teacherConfig = null; /* DATA_END */
    // -----------------------

    const wordMorphology = { "admiring":{adj:"admiring",noun:"admiration",verb:"admires"}, "angry":{adj:"angry",noun:"anger",verb:"angers"}, "anxious":{adj:"anxious",noun:"anxiety",verb:"worries"}, "chaotic":{adj:"chaotic",noun:"chaos",verb:"disrupts"}, "critical":{adj:"critical",noun:"criticism",verb:"criticizes"}, "cyclical":{adj:"cyclical",noun:"cyclical structure",verb:"cycles"}, "desperate":{adj:"desperate",noun:"desperation",verb:"despairs"}, "enthusiastic":{adj:"enthusiastic",noun:"enthusiasm",verb:"enthuses"}, "fearful":{adj:"fearful",noun:"fear",verb:"fears"}, "gloomy":{adj:"gloomy",noun:"gloom",verb:"saddens"}, "hopeful":{adj:"hopeful",noun:"hope",verb:"hopes"}, "hostile":{adj:"hostile",noun:"hostility",verb:"attacks"}, "joyful":{adj:"joyful",noun:"joy",verb:"rejoices"}, "melancholy":{adj:"melancholic",noun:"melancholy",verb:"saddens"}, "nostalgic":{adj:"nostalgic",noun:"nostalgia",verb:"remembers"}, "ominous":{adj:"ominous",noun:"foreboding",verb:"threatens"}, "peaceful":{adj:"peaceful",noun:"peace",verb:"calms"}, "tense":{adj:"tense",noun:"tension",verb:"tenses"} };

    const defaultData = {
        textTitle: "The Electric Telegraph", question: "How is impact conveyed?", adminPassword: "1234",
        sentenceOrder: ['starter', 'quote', 'method', 'point', 'analysis', 'link'], worksheetOptions: { lvl1: true, lvl2: true, lvl3: true },
        analysisTemplates: { tone: ["creates a {adj} tone","evokes a sense of {noun}"], structure: ["structurally highlights {noun}"], language: ["suggests the idea of {noun}"] },
        markers: ["However,", "Furthermore,", "In contrast,"], starters: ["The writer implies", "This suggests"], points: ["The writer presents a negative view"], methods: ["metaphor", "simile"], links: ["This reinforces the idea"],
        items: [{ id: "q1", type: "quote", original: "wondrous invention", translation: "amazing machine", distractors: ["boring machine"], custom_q: "Which phrase suggests amazement?", includeInWS: true, pageBreak: false, level1: { tone: { prompt:"Tone?", correct:"Enthusiastic", options:["Enthusiastic","Bored"] } }, level2: { tone: { prompt:"Tone?", correct:"Awe", options:["Awe","Fear"] } }, level3: { tone: { prompt:"Tone?", correct:"Sublime", options:["Sublime","Mocking"] } } }]
    };

    let appData = JSON.parse(JSON.stringify(defaultData));
    let state = { level: 1, currentIdx: 0, filter: 'all', completed: [] };
    let sentenceSlots = { marker:"", starter:"", point:"", method:"", quote:"", link:"", analysis:"" };

    function init() {
        if (teacherConfig && typeof teacherConfig === 'object') {
            appData = teacherConfig;
            document.getElementById('admin-btn').style.display = 'none'; 
            document.getElementById('reset-btn').style.display = 'none'; 
            document.getElementById('student-banner').style.display = 'block';
            document.getElementById('student-title').innerText = appData.textTitle;
            runStartup(); return;
        }
        let local = localStorage.getItem('tsa_v62_mobile');
        if(!local) local = localStorage.getItem('tsa_v61_reliable'); // Migration
        if(local) { try { appData = { ...defaultData, ...JSON.parse(local) }; } catch(e) { appData = defaultData; } }
        runStartup();
    }
    
    function runStartup() { state.currentIdx = -1; state.completed = []; updateUI(); loadStageSelect(); }
    function hardReset() { if(confirm("Factory Reset?")) { localStorage.removeItem('tsa_v62_mobile'); location.reload(); } }
    function updateUI() { document.getElementById('text-display').innerText = appData.textTitle; document.getElementById('q-display').innerText = appData.question; renderBuilderUI(); }
    function requestAdminAccess() { const input = prompt("Enter Admin Password:"); if (input === appData.adminPassword) { openAdmin(); } else { alert("Incorrect Password."); } }
    function changePassword() { const newPass = prompt("Enter new password:"); if(newPass && newPass.trim() !== "") { appData.adminPassword = newPass.trim(); saveLocal(); alert("Password changed."); } }
    
    // --- THEME ENGINE ---
    function openThemeModal() { document.getElementById('theme-modal').style.display = 'flex'; }
    function setTheme(theme) {
        document.body.className = ''; // Reset
        if(theme !== 'default') document.body.classList.add('theme-'+theme);
        document.getElementById('theme-modal').style.display = 'none';
    }
    function setCustomTheme() {
        const bg = document.getElementById('custom-bg').value;
        const text = document.getElementById('custom-text').value;
        document.documentElement.style.setProperty('--bg', bg);
        document.documentElement.style.setProperty('--card', bg); // Card matches bg for high contrast logic
        document.documentElement.style.setProperty('--text', text);
        document.body.className = ''; // remove presets
        document.getElementById('theme-modal').style.display = 'none';
    }

    function getMorphology(word, type) { const lower = word.toLowerCase(); const entry = wordMorphology[lower]; if (entry && entry[type]) return entry[type]; if (type === 'noun') { if (lower.endsWith('ing')) return lower.replace('ing', 'ion'); if (lower.endsWith('ent')) return lower.replace('ent', 'ence'); if (lower.endsWith('ous')) return lower.replace('ous', 'ness'); } return lower; }
    function applyGrammarRules(text) { return text.replace(/\b(a)\s([aeiou])/g, "an $2"); }

    function renderBuilderUI() {
        const container = document.getElementById('dynamic-builder-controls'); if(!container) return; container.innerHTML = '';
        let previewStr = "";
        appData.sentenceOrder.forEach((type, index) => {
            if(type === 'none') return;
            previewStr += `[${type}] + `;
            const group = document.createElement('div'); group.className = 'bank-group';
            let labelText = type.charAt(0).toUpperCase() + type.slice(1);
            if(type === 'quote') labelText = "Quote"; if(type === 'analysis') labelText = "Analysis";
            const label = document.createElement('span'); label.className = 'bank-label'; label.innerText = `${index+1}. ${labelText}`; group.appendChild(label);
            if(type === 'quote' || type === 'analysis') {
                const placeholder = document.createElement('div'); placeholder.className = 'locked-slot';
                placeholder.innerHTML = type === 'quote' ? `<i class="fas fa-quote-right"></i>` : `<i class="fas fa-gamepad"></i>`;
                if(sentenceSlots[type]) { placeholder.style.background = '#c8e6c9'; placeholder.style.color = '#2e7d32'; placeholder.innerHTML = `<i class="fas fa-check"></i>`; }
                group.appendChild(placeholder);
            } else {
                const select = document.createElement('select'); select.className = 'bank-select'; select.id = `sel-${type}`; select.onchange = () => updateSlot(type); select.innerHTML = `<option value="">‚ûï ${labelText}</option>`;
                if(appData[type+'s']) appData[type+'s'].forEach(opt => select.add(new Option(opt, opt)));
                group.appendChild(select);
            }
            container.appendChild(group);
        });
        document.getElementById('structure-preview').innerText = "Structure: " + previewStr.slice(0, -3);
        const btnGroup = document.createElement('div'); btnGroup.style.display = 'flex'; btnGroup.style.gap = '5px'; btnGroup.style.alignSelf = 'flex-end';
        container.appendChild(btnGroup); // Buttons moved out to separate container in HTML for layout safety
    }

    function updateSlot(type) { const el = document.getElementById(`sel-${type}`); if(el && el.value) { sentenceSlots[type] = el.value; rebuildSentenceBox(); el.value = ""; } }
    function undoLast() { let order = [...appData.sentenceOrder].reverse(); for(let key of order) { if(sentenceSlots[key]) { sentenceSlots[key] = ""; rebuildSentenceBox(); return; } } }
    function rebuildSentenceBox() {
        let parts = []; appData.sentenceOrder.forEach(type => { if(type !== 'none' && sentenceSlots[type]) { parts.push(sentenceSlots[type]); } });
        if(sentenceSlots.analysis && !appData.sentenceOrder.includes('analysis')) parts.push(sentenceSlots.analysis);
        let fullSentence = parts.join(" "); fullSentence = applyGrammarRules(fullSentence);
        if(fullSentence.length > 0) { fullSentence = fullSentence.charAt(0).toUpperCase() + fullSentence.slice(1); }
        document.getElementById('sentence-stage').value = fullSentence.trim(); renderBuilderUI();
    }
    function changeLevel() { state.level = parseInt(document.getElementById('level-select').value); loadStageSelect(); }
    function filterGrid(type, btn) { state.filter = type; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); loadStageSelect(); }

    function loadStageSelect() {
        document.querySelectorAll('.stage').forEach(e=>e.classList.remove('active')); document.getElementById('stage-select').classList.add('active');
        const grid = document.getElementById('grid-main'); if(!grid) return; grid.innerHTML = '';
        if(!appData.items) return;
        let availableCount = 0;
        appData.items.forEach((item, i) => {
            if(state.completed.includes(i)) return; 
            if(state.filter === 'structure' && item.type !== 'structure') return;
            if(state.filter === 'language' && item.type === 'structure') return;
            availableCount++;
            const div = document.createElement('div'); div.className = item.type === 'structure' ? 'card card-struct' : 'card card-lang';
            const mainText = item.type==='structure' ? item.label : '"'+item.original+'"';
            const subText = item.custom_q ? item.custom_q : (item.type==='structure' ? item.detail : "Analyze this quote");
            div.innerHTML = `<strong>${item.type==='structure'?'üèóÔ∏è':'üî§'} ${mainText}</strong><small style="opacity:0.8;">${subText}</small>`;
            div.onclick = () => { state.currentIdx = i; document.getElementById('dynamic-question-display').innerText = item.custom_q || "Analyzing Evidence"; item.type==='structure'?loadAnalysis('structure'):loadDecoder(); };
            grid.appendChild(div);
        });
        if(availableCount === 0 && appData.items.length > 0) { grid.innerHTML = `<div style="grid-column:1/-1; text-align:center;"><h3>üéâ Analysis Complete!</h3><button class="btn btn-accent" onclick="runStartup()">Start Over</button></div>`; }
        sentenceSlots.quote = ""; sentenceSlots.analysis = ""; rebuildSentenceBox();
    }

    function loadDecoder() {
        document.getElementById('stage-select').classList.remove('active'); document.getElementById('stage-decoder').classList.add('active');
        const item = appData.items[state.currentIdx]; document.getElementById('decoder-quote').innerText = item.original;
        const grid = document.getElementById('grid-decoder'); grid.innerHTML = '';
        let opts = [{txt: item.translation, correct:true}]; if(item.distractors) item.distractors.forEach(d => opts.push({txt: d, correct:false}));
        opts.sort(()=>Math.random()-0.5).forEach(opt => {
            const btn = document.createElement('div'); btn.className = 'card'; btn.innerText = opt.txt;
            btn.onclick = () => { if(opt.correct) { sentenceSlots.quote = `"${item.original}"`; rebuildSentenceBox(); document.getElementById('stage-decoder').classList.remove('active'); document.getElementById('stage-lens').classList.add('active'); } else alert("Try again."); };
            grid.appendChild(btn);
        });
    }

    function loadAnalysis(lens) {
        const item = appData.items[state.currentIdx]; const lvlKey = 'level'+state.level;
        if(!item[lvlKey] || !item[lvlKey][lens]) { alert("No data for this level."); return; }
        document.getElementById('stage-lens').classList.remove('active'); document.getElementById('stage-analysis').classList.add('active');
        const data = item[lvlKey][lens]; document.getElementById('analysis-prompt').innerText = data.prompt;
        const grid = document.getElementById('grid-analysis'); grid.innerHTML = '';
        let rawOptions = data.options ? [...data.options] : [];
        if(data.correct && !rawOptions.includes(data.correct)) rawOptions.push(data.correct);
        let opts = rawOptions.map(o => ({txt:o, correct: o===data.correct}));
        opts.sort(()=>Math.random()-0.5).forEach(opt => {
            const btn = document.createElement('div'); btn.className = 'card ' + (lens==='tone'?'card-tone':lens==='structure'?'card-struct':'card-lang'); btn.innerText = opt.txt;
            btn.onclick = () => {
                if(opt.correct) { showPhrasingSelector(lens, opt.txt.toLowerCase()); } else alert("Try again.");
            };
            grid.appendChild(btn);
        });
    }

    function showPhrasingSelector(lens, word) {
        const modal = document.getElementById('phrasing-overlay'); const container = document.getElementById('phrase-options');
        document.getElementById('phrase-word').innerText = word; container.innerHTML = '';
        let templates = appData.analysisTemplates[lens] || ["creates a {adj} tone"];
        templates.forEach(t => {
            let filled = t;
            if (t.includes("{noun}")) filled = filled.replace("{noun}", getMorphology(word, 'noun'));
            if (t.includes("{adj}")) filled = filled.replace("{adj}", getMorphology(word, 'adj'));
            if (t.includes("{verb}")) filled = filled.replace("{verb}", getMorphology(word, 'verb'));
            if (t.includes("{word}")) filled = filled.replace("{word}", word);
            const btn = document.createElement('div'); btn.className = 'phrase-option'; btn.innerText = filled;
            btn.onclick = () => { sentenceSlots.analysis = filled; rebuildSentenceBox(); modal.style.display = 'none'; document.getElementById('overlay-msg').style.display='flex'; setTimeout(() => { document.getElementById('overlay-msg').style.display='none'; }, 1000); };
            container.appendChild(btn);
        });
        modal.style.display = 'flex';
    }

    function commitSentence() {
        const val = document.getElementById('sentence-stage').value; if(!val) return;
        const area = document.getElementById('answer-area'); area.style.display='block';
        document.getElementById('essay-controls').style.display='flex'; area.value += (area.value ? "\n\n" : "") + val;
        if(state.currentIdx !== -1) state.completed.push(state.currentIdx);
        sentenceSlots = { marker:"", starter:"", point:"", method:"", quote:"", link:"", analysis:"" };
        document.getElementById('sentence-stage').value = ""; loadStageSelect();
    }
    
    function clearEssay() { if(confirm("Clear answer?")) { document.getElementById('answer-area').value=""; } }
    function downloadDoc() { const blob = new Blob(['<html><body>'+document.getElementById('answer-area').value.replace(/\n/g,'<br>')+'</body></html>'], {type:'application/msword'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Answer.doc'; a.click(); }
    
    function saveLocal() { localStorage.setItem('tsa_v62_mobile', JSON.stringify(appData)); }
    function updateGlobal(k, v) { appData[k]=v; saveLocal(); updateUI(); }
    function openAdmin() { document.getElementById('admin-modal').style.display='flex'; renderItems(); document.getElementById('edit-title').value=appData.textTitle; document.getElementById('edit-question').value=appData.question;}
    function closeAdmin() { document.getElementById('admin-modal').style.display='none'; }
    
    function renderItems() {
        const con = document.getElementById('items-container'); con.innerHTML = '';
        if(!appData.items) return;
        appData.items.forEach((item, i) => {
            const div = document.createElement('div'); div.className = 'editor-section';
            div.innerHTML = `<strong>#${i+1}</strong> <button class="btn btn-add" style="padding:5px;" onclick="delItem(${i})">Del</button>`;
            con.appendChild(div);
        });
    }
    function delItem(i) { appData.items.splice(i,1); renderItems(); saveLocal(); }
    function addNewItem() { appData.items.push({type:"quote", original:"New", translation:"", includeInWS: true, pageBreak: false, level1:{tone:{correct:"", options:[]}} }); renderItems(); saveLocal(); }
    
    function downloadStudentApp() {
        const clone = JSON.parse(JSON.stringify(appData));
        const htmlContent = document.documentElement.outerHTML;
        const cleanContent = htmlContent.replace(/style="display:\s*flex;"/g, 'style="display:none;"');
        const injectionTarget = '/* DATA_START */ const teacherConfig = null; /* DATA_END */';
        const injectionPayload = `/* DATA_START */ const teacherConfig = ${JSON.stringify(clone)}; /* DATA_END */`;
        if (cleanContent.includes(injectionTarget)) {
            const finalHTML = cleanContent.replace(injectionTarget, injectionPayload);
            const blob = new Blob([finalHTML], {type:'text/html'});
            const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'tone-structure-lesson.html'; a.click();
        } else { alert("Error: Injection point not found."); }
    }
    
    function downloadJSON() { const blob = new Blob([JSON.stringify(appData)], {type: "text/json;charset=utf-8"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'architect_data.json'; document.body.appendChild(a); a.click(); document.body.removeChild(a); alert("Saved!"); }
    function uploadJSON(input) { const fr = new FileReader(); fr.onload = (e) => { appData = JSON.parse(e.target.result); saveLocal(); openAdmin(); updateUI(); alert("Loaded!"); }; fr.readAsText(input.files[0]); input.value=''; }

    init();
</script>
</body>
</html>
