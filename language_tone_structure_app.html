<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eduqas Tone & Structure Scaffolder</title>
    <style>
        /* --- CSS VARIABLES & ACCESSIBILITY --- */
        :root {
            --primary: #2c3e50; /* Deep Blue */
            --accent: #e67e22;  /* Pumpkin Orange */
            --success: #27ae60; /* Green */
            --text: #333;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-dyslexic: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        body.dyslexia-mode {
            font-family: var(--font-dyslexic);
            line-height: 1.8;
            letter-spacing: 0.05em;
        }

        /* --- APP CONTAINER --- */
        #app-container {
            width: 100%;
            max-width: 900px;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 40px;
            position: relative;
            overflow: hidden;
            min-height: 600px;
            transition: all 0.3s ease;
        }

        /* --- PROGRESS BAR --- */
        .progress-container {
            width: 100%;
            background-color: #eee;
            border-radius: 10px;
            margin-bottom: 20px;
            height: 12px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--success);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* --- TYPOGRAPHY & LAYOUT --- */
        h1 { color: var(--primary); text-align: center; margin-bottom: 10px; }
        h2 { color: var(--accent); margin-top: 0; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; }
        
        .screen { display: none; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- BUTTONS --- */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            font-weight: bold;
            margin: 5px;
        }
        .btn:hover { transform: scale(1.02); filter: brightness(1.1); }
        .btn:active { transform: scale(0.98); }
        .btn-large { width: 100%; margin-bottom: 15px; text-align: left; display: flex; align-items: center; justify-content: space-between; }
        .btn-option { background: white; color: var(--text); border: 2px solid #ddd; }
        .btn-option:hover { border-color: var(--accent); background: #fffdf5; }
        
        /* --- TEACHER BUTTON --- */
        .btn-teacher { background: #34495e; font-size: 0.9rem; padding: 10px 15px; }

        /* --- QUOTE CARDS --- */
        .quote-card {
            background: #fff;
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .quote-card:hover { border-color: var(--accent); transform: translateX(5px); }
        .quote-icon { font-size: 2rem; margin-right: 15px; }
        
        /* --- SCAFFOLDING BUILDER --- */
        .builder-box {
            background: #f8f9fa;
            border: 2px dashed #ccc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 1.2rem;
            min-height: 80px;
        }
        .highlight { color: var(--accent); font-weight: bold; }

        /* --- GAMIFICATION --- */
        #particle-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 99;
        }
        
        .modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
            text-align: center;
        }
        .modal-active { display: flex; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .badge-large { font-size: 6rem; margin-bottom: 20px; display: block; }
        
        @keyframes popIn { from {transform: scale(0.5); opacity:0;} to {transform: scale(1); opacity:1;} }

        /* --- TEACHER SETTINGS PANEL --- */
        #teacher-panel textarea {
            width: 80%;
            height: 300px;
            font-family: monospace;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .json-error { color: red; display: none; margin-bottom: 10px; }

        /* --- ACCESS TOGGLE --- */
        .settings-bar {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 101;
        }
        .icon-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; opacity: 0.5; margin-left: 10px; }
        .icon-btn:hover { opacity: 1; }
        .icon-btn.active { color: var(--primary); opacity: 1; }

    </style>
</head>
<body>

<canvas id="particle-canvas"></canvas>

<div id="app-container">
    <div class="settings-bar">
        <button class="icon-btn" onclick="toggleDyslexia()" title="Toggle Dyslexia Font">Aa</button>
        <button class="icon-btn" onclick="toggleMotion()" title="Reduce Motion">üõë</button>
        <button class="icon-btn" onclick="openTeacherSettings()" title="Teacher Settings">‚öôÔ∏è</button>
    </div>

    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>

    <h1>Eduqas 19th Century Decoder</h1>
    <p class="subtitle" id="text-title-display">Text: The Electric Telegraph (The Times, 1851)</p>

    <div id="screen-level" class="screen active">
        <h2>Choose Your Mode:</h2>
        <button class="btn btn-large" onclick="setLevel(1)">
            <span>üß± <strong>The Builder</strong><br><small>Level 1-2: Help me build sentences block by block.</small></span>
            <span>‚û§</span>
        </button>
        <button class="btn btn-large" onclick="setLevel(3)">
            <span>üïµÔ∏è <strong>The Explorer</strong><br><small>Level 3+: Help me analyze tone and metaphors.</small></span>
            <span>‚û§</span>
        </button>
    </div>

    <div id="screen-quotes" class="screen">
        <h2 id="instruction-text">Find the evidence...</h2>
        <div id="quote-list">
            </div>
        <button class="btn btn-secondary" onclick="showScreen('screen-level')" style="margin-top:20px;">Back</button>
    </div>

    <div id="screen-decoder" class="screen">
        <h2><span id="decoder-icon"></span> The Translation Bridge</h2>
        <p>The writer says: <strong id="decoder-original" class="highlight">...</strong></p>
        <p>What does this mean in modern English?</p>
        <div id="decoder-options" class="btn-grid">
            </div>
    </div>

    <div id="screen-builder" class="screen">
        <h2>Build Your Answer</h2>
        <div id="builder-interface">
            </div>
        <button class="btn" style="width:100%; margin-top:20px;" onclick="finishQuote()">Add to Paragraph ‚ú®</button>
    </div>

    <div id="screen-export" class="screen">
        <h2>Well Done! üéâ</h2>
        <p>Here is your analysis paragraph ready for the exam:</p>
        <div class="builder-box" id="final-paragraph"></div>
        <button class="btn" onclick="location.reload()">Start New Text ‚Ü∫</button>
    </div>

    <div id="modal-reward" class="modal">
        <span class="badge-large" id="reward-badge">üèÜ</span>
        <h2 id="reward-title">Great Job!</h2>
        <p id="reward-msg">You unlocked a new insight.</p>
        <button class="btn" onclick="closeModal()">Continue ‚û§</button>
    </div>

    <div id="teacher-panel" class="modal">
        <h2>‚öôÔ∏è Teacher Settings</h2>
        <p>Edit the JSON data below to change the text, quotes, and questions.</p>
        <textarea id="json-editor"></textarea>
        <p id="json-error" class="json-error">Invalid JSON! Please check your syntax.</p>
        <div>
            <button class="btn btn-teacher" onclick="saveTeacherSettings()">Save & Reload</button>
            <button class="btn btn-teacher" style="background:#7f8c8d;" onclick="closeTeacherSettings()">Cancel</button>
            <button class="btn btn-teacher" style="background:#c0392b;" onclick="resetDefaults()">Reset to Default</button>
        </div>
    </div>

</div>

<script>
/* --- 1. DEFAULT DATA (The "Hardcoded" Content) --- */
const defaultData = {
    textTitle: "The Electric Telegraph (1851)",
    quotes: [
        {
            id: "q1",
            original: "a wondrous invention",
            translation: "an amazing machine",
            icon: "‚ú®",
            distractor: "a boring machine",
            level1: {
                starter: "The writer thinks the telegraph is amazing because he calls it",
                mood: "Excited"
            },
            level3: {
                technique: "Adjective Choice",
                analysis: "This word choice establishes a tone of awe and wonder.",
                question: "Why use the word 'wondrous'?",
                options: [
                    {text: "To show it is dull.", correct: false, feedback: "Think again!"},
                    {text: "To show he is astonished.", correct: true, feedback: "Correct!"}
                ]
            },
            badge: "The Magician üé©"
        },
        {
            id: "q2",
            original: "knitting the nation closer",
            translation: "joining the country like a family",
            icon: "üß∂",
            distractor: "making clothes for people",
            level1: {
                starter: "The writer shows the telegraph brings people together by saying it is",
                mood: "Connected"
            },
            level3: {
                technique: "Metaphor",
                analysis: "This metaphor suggests the country is being tightly connected together.",
                question: "Why compare it to 'knitting'?",
                options: [
                    {text: "To show it is soft.", correct: false, feedback: "Not quite."},
                    {text: "To show it makes strong connections.", correct: true, feedback: "Spot on!"}
                ]
            },
            badge: "The Connector üîó"
        },
        {
            id: "q3",
            original: "creating a web of networks",
            translation: "connecting everyone like a spider web",
            icon: "üï∏Ô∏è",
            distractor: "catching flies",
            level1: {
                starter: "The writer shows the impact is everywhere by calling it a",
                mood: "Huge"
            },
            level3: {
                technique: "Imagery",
                analysis: "This imagery emphasizes that the network reaches every corner of the land.",
                question: "What does a 'web' imply?",
                options: [
                    {text: "It is messy.", correct: false, feedback: "Try again."},
                    {text: "It is interconnected and vast.", correct: true, feedback: "Exactly!"}
                ]
            },
            badge: "The Architect üèóÔ∏è"
        }
    ]
};

/* --- 2. APP STATE & INITIALIZATION --- */
let appData = defaultData;
let currentState = {
    level: 1,
    currentQuoteIndex: 0,
    reducedMotion: false,
    dyslexiaFont: false,
    finalTextParts: []
};

// Load from LocalStorage if available
function initApp() {
    const savedData = localStorage.getItem('eduqasAppData');
    if (savedData) {
        try {
            appData = JSON.parse(savedData);
        } catch (e) {
            console.error("Save data corrupted, using defaults");
            appData = defaultData;
        }
    }
    // Update Title
    document.getElementById('text-title-display').innerText = "Text: " + appData.textTitle;
}

initApp();

/* --- 3. TEACHER SETTINGS FUNCTIONS --- */
function openTeacherSettings() {
    const editor = document.getElementById('json-editor');
    // Pretty print JSON for easier editing
    editor.value = JSON.stringify(appData, null, 4); 
    document.getElementById('teacher-panel').classList.add('modal-active');
}

function closeTeacherSettings() {
    document.getElementById('teacher-panel').classList.remove('modal-active');
    document.getElementById('json-error').style.display = 'none';
}

function saveTeacherSettings() {
    const editor = document.getElementById('json-editor');
    const errorMsg = document.getElementById('json-error');
    
    try {
        const newData = JSON.parse(editor.value);
        
        // Basic validation check
        if (!newData.quotes || !Array.isArray(newData.quotes)) {
            throw new Error("Missing 'quotes' array.");
        }

        appData = newData;
        localStorage.setItem('eduqasAppData', JSON.stringify(appData));
        location.reload(); // Reload to apply changes cleanly
    } catch (e) {
        errorMsg.innerText = "Error: " + e.message;
        errorMsg.style.display = 'block';
    }
}

function resetDefaults() {
    if(confirm("Are you sure? This will delete your custom text settings.")) {
        localStorage.removeItem('eduqasAppData');
        location.reload();
    }
}

/* --- 4. CORE NAVIGATION --- */

function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}

function setLevel(lvl) {
    currentState.level = lvl;
    renderQuoteList();
    showScreen('screen-quotes');
    updateProgress(10);
}

function updateProgress(percent) {
    document.getElementById('progressBar').style.width = percent + '%';
}

function toggleDyslexia() {
    document.body.classList.toggle('dyslexia-mode');
    currentState.dyslexiaFont = !currentState.dyslexiaFont;
}

function toggleMotion() {
    currentState.reducedMotion = !currentState.reducedMotion;
    alert(currentState.reducedMotion ? "Motion Reduced" : "Motion Enabled");
}

/* --- 5. RENDER LOGIC --- */

function renderQuoteList() {
    const list = document.getElementById('quote-list');
    list.innerHTML = '';
    
    appData.quotes.forEach((q, index) => {
        // Don't show already done quotes
        if (currentState.finalTextParts[index]) return;

        const div = document.createElement('div');
        div.className = 'quote-card';
        div.innerHTML = `<span class="quote-icon">${q.icon}</span> <strong>"${q.original}"</strong>`;
        div.onclick = () => startQuoteFlow(index);
        list.appendChild(div);
    });

    if(currentState.finalTextParts.filter(p => p).length === appData.quotes.length) {
        showExport();
    }
}

function startQuoteFlow(index) {
    currentState.currentQuoteIndex = index;
    const q = appData.quotes[index];
    
    // Setup Decoder Screen
    document.getElementById('decoder-icon').innerText = q.icon;
    document.getElementById('decoder-original').innerText = q.original;
    
    const optsDiv = document.getElementById('decoder-options');
    optsDiv.innerHTML = '';
    
    // Randomize options
    const options = [
        { text: q.translation, correct: true },
        { text: q.distractor, correct: false }
    ].sort(() => Math.random() - 0.5);

    options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-option';
        btn.innerText = opt.text;
        // Use inline styling for grid compatibility
        btn.style.width = "100%";
        btn.onclick = () => checkTranslation(opt.correct, btn);
        optsDiv.appendChild(btn);
    });

    showScreen('screen-decoder');
    updateProgress(30 + (currentState.finalTextParts.filter(p => p).length * 20));
}

function checkTranslation(isCorrect, btn) {
    if (isCorrect) {
        btn.style.background = 'var(--success)';
        btn.style.color = 'white';
        fireParticles(30);
        setTimeout(() => {
            renderBuilder();
            showScreen('screen-builder');
        }, 800);
    } else {
        btn.style.background = '#e74c3c';
        btn.style.color = 'white';
        btn.innerText = "Try again!";
    }
}

function renderBuilder() {
    const q = appData.quotes[currentState.currentQuoteIndex];
    const container = document.getElementById('builder-interface');
    container.innerHTML = '';

    if (currentState.level === 1) {
        // LEVEL 1: Sentence Completion
        container.innerHTML = `
            <p>Complete the sentence:</p>
            <div class="builder-box">
                ${q.level1.starter} 
                <strong style="color:var(--primary)">'${q.original}'</strong>.
                <br><br>
                This shows the mood is: 
                <select id="l1-select" style="font-size:1.1rem; padding:5px;">
                    <option>${q.level1.mood}</option>
                    <option>Boring</option>
                    <option>Scary</option>
                </select>.
            </div>
        `;
    } else {
        // LEVEL 3: Analysis Circuit
        container.innerHTML = `
            <p><strong>Technique:</strong> ${q.level3.technique}</p>
            <p class="highlight">${q.level3.question}</p>
            <div class="btn-grid" style="grid-template-columns: 1fr;">
                ${q.level3.options.map((opt, i) => `
                    <button class="btn btn-option" onclick="selectAnalysis(this, ${opt.correct}, '${q.level3.analysis.replace(/'/g, "\\'")}')">
                        ${opt.text}
                    </button>
                `).join('')}
            </div>
            <div id="l3-draft" class="builder-box hidden">
                The writer uses the phrase <strong>'${q.original}'</strong>. ${q.level3.analysis}
            </div>
        `;
    }
}

function selectAnalysis(btn, isCorrect, analysisText) {
    if(!isCorrect) {
        btn.style.background = '#e74c3c';
        btn.style.color = 'white';
        return;
    }
    // Success
    btn.style.background = 'var(--success)';
    btn.style.color = 'white';
    document.getElementById('l3-draft').classList.remove('hidden');
    fireParticles(20);
}

function finishQuote() {
    const q = appData.quotes[currentState.currentQuoteIndex];
    let sentence = "";

    if (currentState.level === 1) {
        sentence = `${q.level1.starter} '${q.original}'. This shows the mood is ${q.level1.mood}.`;
    } else {
        const draft = document.getElementById('l3-draft');
        if(draft.classList.contains('hidden')) {
            alert("Please select the correct analysis first!");
            return;
        }
        sentence = `The writer uses the phrase '${q.original}'. ${q.level3.analysis}`;
    }

    // Save
    currentState.finalTextParts[currentState.currentQuoteIndex] = sentence;
    
    // Reward
    showReward(q.badge);
}

function showReward(badge) {
    document.getElementById('reward-badge').innerText = badge;
    document.getElementById('modal-reward').classList.add('modal-active');
    fireParticles(100); // Mega win
}

function closeModal() {
    document.getElementById('modal-reward').classList.remove('modal-active');
    renderQuoteList();
    showScreen('screen-quotes');
}

function showExport() {
    const finalDiv = document.getElementById('final-paragraph');
    // Filter out empty slots if any
    finalDiv.innerHTML = currentState.finalTextParts.filter(p => p).join(' <br><br> ');
    showScreen('screen-export');
    updateProgress(100);
}

/* --- 6. GAMIFICATION (PARTICLE SYSTEM) --- */
const canvas = document.getElementById('particle-canvas');
const ctx = canvas.getContext('2d');
let particles = [];

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function fireParticles(amount) {
    if (currentState.reducedMotion) return;
    
    const colors = ['#f1c40f', '#e67e22', '#2ecc71', '#3498db'];
    for (let i = 0; i < amount; i++) {
        particles.push({
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            vx: (Math.random() - 0.5) * 10,
            vy: (Math.random() - 0.5) * 10,
            life: 1.0,
            color: colors[Math.floor(Math.random() * colors.length)],
            size: Math.random() * 5 + 2
        });
    }
    requestAnimationFrame(updateParticles);
}

function updateParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    
    for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i];
        p.x += p.vx;
        p.y += p.vy;
        p.life -= 0.02;
        p.vy += 0.2; // gravity

        ctx.fillStyle = p.color;
        ctx.globalAlpha = p.life;
        ctx.beginPath();
        ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
        ctx.fill();

        if (p.life <= 0) particles.splice(i, 1);
    }

    if (particles.length > 0) requestAnimationFrame(updateParticles);
}

</script>
</body>
</html>
