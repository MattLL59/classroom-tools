<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Eduqas Tone & Structure App</title>
    <style>
        /* --- CSS VARIABLES & ACCESSIBILITY --- */
        :root {
            --primary: #2c3e50; /* Deep Blue */
            --accent: #e67e22;  /* Pumpkin Orange */
            --success: #27ae60; /* Green */
            --danger: #e74c3c;  /* Red */
            --text: #333;
            --bg: #f4f7f6;
            --card-bg: #ffffff;
            --font-main: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --font-dyslexic: 'Comic Sans MS', 'Chalkboard SE', sans-serif;
        }

        body {
            font-family: var(--font-main);
            background-color: var(--bg);
            color: var(--text);
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        body.dyslexia-mode {
            font-family: var(--font-dyslexic);
            line-height: 1.8;
            letter-spacing: 0.05em;
        }

        /* --- APP CONTAINER --- */
        #app-container {
            width: 100%;
            max-width: 900px;
            background: var(--card-bg);
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            padding: 40px;
            position: relative;
            overflow: hidden;
            min-height: 600px;
        }

        /* --- PROGRESS BAR --- */
        .progress-container {
            width: 100%;
            background-color: #eee;
            border-radius: 10px;
            margin-bottom: 20px;
            height: 12px;
            overflow: hidden;
        }
        .progress-bar {
            height: 100%;
            background-color: var(--success);
            width: 0%;
            transition: width 0.5s ease;
        }

        /* --- TYPOGRAPHY & LAYOUT --- */
        h1 { color: var(--primary); text-align: center; margin-bottom: 10px; }
        h2 { color: var(--accent); margin-top: 0; }
        .subtitle { text-align: center; color: #7f8c8d; margin-bottom: 30px; }
        
        .screen { display: none; animation: fadeIn 0.4s ease; }
        .screen.active { display: block; }
        
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- BUTTONS --- */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            cursor: pointer;
            transition: transform 0.1s, background 0.2s;
            font-weight: bold;
            margin: 5px;
        }
        .btn:hover { transform: scale(1.02); filter: brightness(1.1); }
        .btn:active { transform: scale(0.98); }
        .btn-large { width: 100%; margin-bottom: 15px; text-align: left; display: flex; align-items: center; justify-content: space-between; padding: 20px; font-size: 1.2rem; }
        .btn-option { background: white; color: var(--text); border: 2px solid #ddd; }
        .btn-option:hover { border-color: var(--accent); background: #fffdf5; }
        
        .btn-danger { background: var(--danger); }
        .btn-success { background: var(--success); }

        /* --- QUOTE CARDS --- */
        .quote-card {
            background: #fff;
            border: 2px solid #eee;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
        }
        .quote-card:hover { border-color: var(--accent); transform: translateX(5px); }
        .quote-icon { font-size: 2rem; margin-right: 15px; }
        
        /* --- SCAFFOLDING BUILDER --- */
        .builder-box {
            background: #f8f9fa;
            border: 2px dashed #ccc;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 1.2rem;
            min-height: 80px;
        }
        .highlight { color: var(--accent); font-weight: bold; }

        /* --- GAMIFICATION --- */
        #particle-canvas {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none;
            z-index: 99;
        }
        
        .modal {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255,255,255,0.98);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 100;
            flex-direction: column;
            text-align: center;
        }
        .modal-active { display: flex; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .badge-large { font-size: 6rem; margin-bottom: 20px; display: block; }
        
        @keyframes popIn { from {transform: scale(0.5); opacity:0;} to {transform: scale(1); opacity:1;} }

        /* --- TEACHER DASHBOARD STYLES --- */
        #teacher-panel {
            justify-content: flex-start;
            padding-top: 20px;
            overflow-y: auto;
            text-align: left;
        }
        .teacher-form-container {
            width: 90%;
            max-width: 800px;
            margin-bottom: 50px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
            color: var(--primary);
        }
        .form-input, .form-select, .form-textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 5px;
            font-family: inherit;
        }
        .quote-editor-block {
            background: #f0f3f5;
            padding: 15px;
            border-radius: 10px;
            border-left: 5px solid var(--accent);
            margin-bottom: 20px;
            position: relative;
        }
        .delete-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #e74c3c;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-weight: bold;
        }
        .section-title {
            border-bottom: 2px solid #ddd;
            padding-bottom: 5px;
            margin-top: 20px;
            margin-bottom: 10px;
            color: var(--primary);
        }
        .toolbar {
            position: sticky;
            bottom: 0;
            background: white;
            width: 100%;
            padding: 15px;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.05);
        }

        /* --- ACCESS TOGGLE --- */
        .settings-bar {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 101;
        }
        .icon-btn { background: none; border: none; font-size: 1.5rem; cursor: pointer; opacity: 0.5; margin-left: 10px; }
        .icon-btn:hover { opacity: 1; }
        .icon-btn.active { color: var(--primary); opacity: 1; }

    </style>
</head>
<body>

<canvas id="particle-canvas"></canvas>

<div id="app-container">
    <div class="settings-bar">
        <button class="icon-btn" onclick="toggleDyslexia()" title="Toggle Dyslexia Font">Aa</button>
        <button class="icon-btn" onclick="toggleMotion()" title="Reduce Motion">üõë</button>
        <button class="icon-btn" onclick="openTeacherSettings()" title="Teacher Edit Mode">‚öôÔ∏è</button>
    </div>

    <div class="progress-container"><div class="progress-bar" id="progressBar"></div></div>

    <h1>Eduqas Tone & Structure</h1>
    <p class="subtitle" id="text-title-display">Loading...</p>

    <div id="screen-level" class="screen active">
        <h2>Choose Your Mode:</h2>
        <button class="btn btn-large" onclick="setLevel(1)">
            <span>üß± <strong>The Builder</strong><br><small style="font-size:0.9rem; color:#666;">Level 1-2: Help me build sentences.</small></span>
            <span>‚û§</span>
        </button>
        <button class="btn btn-large" onclick="setLevel(3)">
            <span>üïµÔ∏è <strong>The Explorer</strong><br><small style="font-size:0.9rem; color:#666;">Level 3+: Help me analyze techniques.</small></span>
            <span>‚û§</span>
        </button>
    </div>

    <div id="screen-quotes" class="screen">
        <h2 id="instruction-text">Find the evidence...</h2>
        <div id="quote-list">
            </div>
        <button class="btn btn-secondary" onclick="showScreen('screen-level')" style="margin-top:20px;">Back</button>
    </div>

    <div id="screen-decoder" class="screen">
        <h2><span id="decoder-icon"></span> Translation Bridge</h2>
        <p>The writer says: <strong id="decoder-original" class="highlight">...</strong></p>
        <p>What does this mean in modern English?</p>
        <div id="decoder-options" class="btn-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
            </div>
    </div>

    <div id="screen-builder" class="screen">
        <h2>Build Your Answer</h2>
        <div id="builder-interface">
            </div>
        <button class="btn btn-success" style="width:100%; margin-top:20px;" onclick="finishQuote()">Add to Paragraph ‚ú®</button>
    </div>

    <div id="screen-export" class="screen">
        <h2>Well Done! üéâ</h2>
        <p>Here is your analysis paragraph ready for the exam:</p>
        <div class="builder-box" id="final-paragraph"></div>
        <button class="btn" onclick="location.reload()">Start New Text ‚Ü∫</button>
    </div>

    <div id="modal-reward" class="modal">
        <span class="badge-large" id="reward-badge">üèÜ</span>
        <h2 id="reward-title">Great Job!</h2>
        <p id="reward-msg">You unlocked a new insight.</p>
        <button class="btn" onclick="closeModal()">Continue ‚û§</button>
    </div>

    <div id="teacher-panel" class="modal">
        <h2>‚úèÔ∏è Teacher Editor</h2>
        <div class="teacher-form-container" id="teacher-form-content">
            </div>
        <div class="toolbar">
            <button class="btn btn-success" onclick="saveTeacherForm()">Save Changes üíæ</button>
            <button class="btn" style="background:#7f8c8d;" onclick="closeTeacherSettings()">Cancel</button>
            <button class="btn btn-danger" onclick="resetDefaults()">Reset Default</button>
        </div>
    </div>

</div>

<script>
/* --- 1. DEFAULT DATA --- */
const defaultData = {
    textTitle: "The Electric Telegraph (1851)",
    quotes: [
        {
            id: "q1",
            original: "a wondrous invention",
            translation: "an amazing machine",
            icon: "‚ú®",
            distractor: "a boring machine",
            level1: { starter: "The writer thinks the telegraph is amazing because he calls it", mood: "Excited" },
            level3: { 
                technique: "Adjective Choice", 
                question: "Why use the word 'wondrous'?",
                analysis: "This word choice establishes a tone of awe and wonder.",
                correctOpt: "To show he is astonished.",
                wrongOpt: "To show it is dull."
            },
            badge: "The Magician üé©"
        },
        {
            id: "q2",
            original: "knitting the nation closer",
            translation: "joining the country like a family",
            icon: "üß∂",
            distractor: "making clothes for people",
            level1: { starter: "The writer shows the telegraph brings people together by saying it is", mood: "Connected" },
            level3: { 
                technique: "Metaphor", 
                question: "Why compare it to 'knitting'?",
                analysis: "This metaphor suggests the country is being tightly connected together.",
                correctOpt: "To show it makes strong connections.",
                wrongOpt: "To show it is soft."
            },
            badge: "The Connector üîó"
        },
        {
            id: "q3",
            original: "creating a web of networks",
            translation: "connecting everyone like a spider web",
            icon: "üï∏Ô∏è",
            distractor: "catching flies",
            level1: { starter: "The writer shows the impact is everywhere by calling it a", mood: "Huge" },
            level3: { 
                technique: "Imagery", 
                question: "What does a 'web' imply?",
                analysis: "This imagery emphasizes that the network reaches every corner of the land.",
                correctOpt: "It is interconnected and vast.",
                wrongOpt: "It is messy."
            },
            badge: "The Architect üèóÔ∏è"
        }
    ]
};

/* --- 2. APP STATE & INITIALIZATION --- */
let appData = defaultData;
let currentState = {
    level: 1,
    currentQuoteIndex: 0,
    reducedMotion: false,
    dyslexiaFont: false,
    finalTextParts: []
};

function initApp() {
    const savedData = localStorage.getItem('eduqasAppData');
    if (savedData) {
        try { appData = JSON.parse(savedData); } 
        catch (e) { appData = defaultData; }
    }
    document.getElementById('text-title-display').innerText = "Text: " + appData.textTitle;
}

initApp();

/* --- 3. TEACHER FORM BUILDER (NEW) --- */
function openTeacherSettings() {
    renderTeacherForm();
    document.getElementById('teacher-panel').classList.add('modal-active');
}

function closeTeacherSettings() {
    document.getElementById('teacher-panel').classList.remove('modal-active');
}

function renderTeacherForm() {
    const container = document.getElementById('teacher-form-content');
    container.innerHTML = '';

    // Title Input
    container.innerHTML += `
        <div class="form-group">
            <label class="form-label">Text Title:</label>
            <input type="text" id="edit-title" class="form-input" value="${appData.textTitle}">
        </div>
        <hr>
        <h3>Quotes & Analysis</h3>
    `;

    // Quotes Loop
    appData.quotes.forEach((q, index) => {
        container.innerHTML += createQuoteFormBlock(q, index);
    });

    // Add New Button
    const addBtn = document.createElement('button');
    addBtn.className = "btn";
    addBtn.innerText = "‚ûï Add New Quote";
    addBtn.style.width = "100%";
    addBtn.style.border = "2px dashed #ccc";
    addBtn.style.background = "#fff";
    addBtn.style.color = "#333";
    addBtn.onclick = addNewQuoteToForm;
    container.appendChild(addBtn);
}

function createQuoteFormBlock(q, index) {
    return `
    <div class="quote-editor-block" id="quote-block-${index}">
        <button class="delete-btn" onclick="removeQuoteFromForm(${index})" title="Delete Quote">√ó</button>
        <h4 class="section-title">Quote #${index + 1}</h4>
        
        <div class="form-group">
            <label class="form-label">Original Quote (Evidence):</label>
            <input type="text" class="form-input edit-original" value="${q.original}">
        </div>
        <div class="form-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div>
                <label class="form-label">Modern Translation:</label>
                <input type="text" class="form-input edit-trans" value="${q.translation}">
            </div>
            <div>
                <label class="form-label">Distractor (Wrong Answer):</label>
                <input type="text" class="form-input edit-distract" value="${q.distractor}">
            </div>
        </div>
        
        <div class="form-group" style="display:grid; grid-template-columns: 1fr 2fr; gap:10px;">
            <div>
                <label class="form-label">Icon:</label>
                <select class="form-select edit-icon">
                    <option value="‚ú®" ${q.icon === '‚ú®' ? 'selected' : ''}>‚ú® Sparkles</option>
                    <option value="üï∏Ô∏è" ${q.icon === 'üï∏Ô∏è' ? 'selected' : ''}>üï∏Ô∏è Web</option>
                    <option value="üß∂" ${q.icon === 'üß∂' ? 'selected' : ''}>üß∂ Yarn</option>
                    <option value="‚ö°" ${q.icon === '‚ö°' ? 'selected' : ''}>‚ö° Bolt</option>
                    <option value="üëª" ${q.icon === 'üëª' ? 'selected' : ''}>üëª Ghost</option>
                    <option value="üåç" ${q.icon === 'üåç' ? 'selected' : ''}>üåç Globe</option>
                    <option value="‚öôÔ∏è" ${q.icon === '‚öôÔ∏è' ? 'selected' : ''}>‚öôÔ∏è Gear</option>
                    <option value="üõë" ${q.icon === 'üõë' ? 'selected' : ''}>üõë Stop</option>
                </select>
            </div>
            <div>
                <label class="form-label">Reward Badge Name:</label>
                <input type="text" class="form-input edit-badge" value="${q.badge}">
            </div>
        </div>

        <h5 class="section-title">Level 1 Setup (Builder)</h5>
        <div class="form-group">
            <label class="form-label">Sentence Starter:</label>
            <input type="text" class="form-input edit-starter" value="${q.level1.starter}">
        </div>
        <div class="form-group">
            <label class="form-label">Mood Word:</label>
            <input type="text" class="form-input edit-mood" value="${q.level1.mood}">
        </div>

        <h5 class="section-title">Level 3 Setup (Analysis)</h5>
        <div class="form-group">
            <label class="form-label">Technique Name:</label>
            <input type="text" class="form-input edit-tech" value="${q.level3.technique}">
        </div>
        <div class="form-group">
            <label class="form-label">Analysis Question:</label>
            <input type="text" class="form-input edit-question" value="${q.level3.question}">
        </div>
        <div class="form-group">
            <label class="form-label">Correct Analysis Sentence:</label>
            <textarea class="form-textarea edit-analysis" rows="2">${q.level3.analysis}</textarea>
        </div>
        <div class="form-group" style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
            <div>
                <label class="form-label">Correct Option:</label>
                <input type="text" class="form-input edit-correct-opt" value="${q.level3.correctOpt}">
            </div>
            <div>
                <label class="form-label">Wrong Option:</label>
                <input type="text" class="form-input edit-wrong-opt" value="${q.level3.wrongOpt}">
            </div>
        </div>
    </div>
    `;
}

function addNewQuoteToForm() {
    // Determine the next index
    const count = document.getElementsByClassName('quote-editor-block').length;
    
    // Default empty template
    const emptyQuote = {
        original: "", translation: "", icon: "‚ú®", distractor: "", badge: "New Badge üèÖ",
        level1: { starter: "The writer says...", mood: "Mood" },
        level3: { technique: "Technique", question: "Why?", analysis: "Analysis goes here.", correctOpt: "Right Answer", wrongOpt: "Wrong Answer" }
    };
    
    // Insert before the add button
    const container = document.getElementById('teacher-form-content');
    const btn = container.lastElementChild; // The add button
    const newBlock = document.createElement('div');
    newBlock.innerHTML = createQuoteFormBlock(emptyQuote, count);
    
    // We just strip the wrapper div to insert cleanly
    container.insertBefore(newBlock.firstElementChild, btn); // This inserts the block
    // Note: The HTML string creates a div. We need to handle DOM insertion properly.
    // Easier way: just re-render with a push to a temp array? No, let's append to DOM.
    // Actually, simply appending the HTML string before the button is cleaner:
    btn.insertAdjacentHTML('beforebegin', createQuoteFormBlock(emptyQuote, count));
}

function removeQuoteFromForm(index) {
    const block = document.getElementById(`quote-block-${index}`);
    if(block) block.remove();
}

function saveTeacherForm() {
    // 1. Scrape Title
    const newTitle = document.getElementById('edit-title').value;
    
    // 2. Scrape Quotes
    const blocks = document.getElementsByClassName('quote-editor-block');
    let newQuotes = [];
    
    for (let block of blocks) {
        newQuotes.push({
            id: "q" + Math.random().toString(36).substr(2, 9),
            original: block.querySelector('.edit-original').value,
            translation: block.querySelector('.edit-trans').value,
            distractor: block.querySelector('.edit-distract').value,
            icon: block.querySelector('.edit-icon').value,
            badge: block.querySelector('.edit-badge').value,
            level1: {
                starter: block.querySelector('.edit-starter').value,
                mood: block.querySelector('.edit-mood').value
            },
            level3: {
                technique: block.querySelector('.edit-tech').value,
                question: block.querySelector('.edit-question').value,
                analysis: block.querySelector('.edit-analysis').value,
                correctOpt: block.querySelector('.edit-correct-opt').value,
                wrongOpt: block.querySelector('.edit-wrong-opt').value
            }
        });
    }

    // 3. Save
    appData = { textTitle: newTitle, quotes: newQuotes };
    localStorage.setItem('eduqasAppData', JSON.stringify(appData));
    location.reload();
}

function resetDefaults() {
    if(confirm("Reset everything to 'The Electric Telegraph'?")) {
        localStorage.removeItem('eduqasAppData');
        location.reload();
    }
}

/* --- 4. CORE NAVIGATION & LOGIC --- */
function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
}

function setLevel(lvl) {
    currentState.level = lvl;
    renderQuoteList();
    showScreen('screen-quotes');
    updateProgress(10);
}

function updateProgress(percent) {
    document.getElementById('progressBar').style.width = percent + '%';
}

function toggleDyslexia() {
    document.body.classList.toggle('dyslexia-mode');
}

function toggleMotion() {
    currentState.reducedMotion = !currentState.reducedMotion;
}

/* --- 5. RENDER USER INTERFACE --- */
function renderQuoteList() {
    const list = document.getElementById('quote-list');
    list.innerHTML = '';
    
    appData.quotes.forEach((q, index) => {
        if (currentState.finalTextParts[index]) return; // Skip done quotes

        const div = document.createElement('div');
        div.className = 'quote-card';
        div.innerHTML = `<span class="quote-icon">${q.icon}</span> <strong>"${q.original}"</strong>`;
        div.onclick = () => startQuoteFlow(index);
        list.appendChild(div);
    });

    if(currentState.finalTextParts.filter(p=>p).length === appData.quotes.length && appData.quotes.length > 0) {
        showExport();
    }
}

function startQuoteFlow(index) {
    currentState.currentQuoteIndex = index;
    const q = appData.quotes[index];
    
    document.getElementById('decoder-icon').innerText = q.icon;
    document.getElementById('decoder-original').innerText = q.original;
    
    const optsDiv = document.getElementById('decoder-options');
    optsDiv.innerHTML = '';
    
    const options = [
        { text: q.translation, correct: true },
        { text: q.distractor, correct: false }
    ].sort(() => Math.random() - 0.5);

    options.forEach(opt => {
        const btn = document.createElement('button');
        btn.className = 'btn btn-option';
        btn.innerText = opt.text;
        btn.style.width = "100%";
        btn.onclick = () => checkTranslation(opt.correct, btn);
        optsDiv.appendChild(btn);
    });

    showScreen('screen-decoder');
    updateProgress(30 + (currentState.finalTextParts.filter(p=>p).length * 20));
}

function checkTranslation(isCorrect, btn) {
    if (isCorrect) {
        btn.className = "btn btn-success";
        btn.style.color = "white";
        fireParticles(30);
        setTimeout(() => {
            renderBuilder();
            showScreen('screen-builder');
        }, 800);
    } else {
        btn.className = "btn btn-danger";
        btn.style.color = "white";
        btn.innerText = "Try again!";
    }
}

function renderBuilder() {
    const q = appData.quotes[currentState.currentQuoteIndex];
    const container = document.getElementById('builder-interface');
    container.innerHTML = '';

    if (currentState.level === 1) {
        container.innerHTML = `
            <p>Complete the sentence:</p>
            <div class="builder-box">
                ${q.level1.starter} 
                <strong style="color:var(--primary)">'${q.original}'</strong>.
                <br><br>
                This shows the mood is: 
                <select id="l1-select" style="font-size:1.1rem; padding:5px;">
                    <option>${q.level1.mood}</option>
                    <option>Boring</option>
                    <option>Scary</option>
                </select>.
            </div>
        `;
    } else {
        container.innerHTML = `
            <p><strong>Technique:</strong> ${q.level3.technique}</p>
            <p class="highlight">${q.level3.question}</p>
            <div class="btn-grid" style="display:grid; gap:10px;">
                <button class="btn btn-option" onclick="selectAnalysis(this, true, '${q.level3.analysis.replace(/'/g, "\\'")}')">${q.level3.correctOpt}</button>
                <button class="btn btn-option" onclick="selectAnalysis(this, false, '')">${q.level3.wrongOpt}</button>
            </div>
            <div id="l3-draft" class="builder-box" style="display:none; margin-top:15px;">
                The writer uses the phrase <strong>'${q.original}'</strong>. ${q.level3.analysis}
            </div>
        `;
        // Randomize button order
        const grid = container.querySelector('.btn-grid');
        for (let i = grid.children.length; i >= 0; i--) {
            grid.appendChild(grid.children[Math.random() * i | 0]);
        }
    }
}

function selectAnalysis(btn, isCorrect, analysisText) {
    if(!isCorrect) {
        btn.className = "btn btn-danger";
        btn.style.color = "white";
        return;
    }
    btn.className = "btn btn-success";
    btn.style.color = "white";
    document.getElementById('l3-draft').style.display = 'block';
    fireParticles(20);
}

function finishQuote() {
    const q = appData.quotes[currentState.currentQuoteIndex];
    let sentence = "";

    if (currentState.level === 1) {
        sentence = `${q.level1.starter} '${q.original}'. This shows the mood is ${q.level1.mood}.`;
    } else {
        const draft = document.getElementById('l3-draft');
        if(draft.style.display === 'none') {
            alert("Please select the correct analysis first!");
            return;
        }
        sentence = `The writer uses the phrase '${q.original}'. ${q.level3.analysis}`;
    }

    currentState.finalTextParts[currentState.currentQuoteIndex] = sentence;
    showReward(q.badge);
}

function showReward(badge) {
    document.getElementById('reward-badge').innerText = badge;
    document.getElementById('modal-reward').classList.add('modal-active');
    fireParticles(100);
}

function closeModal() {
    document.getElementById('modal-reward').classList.remove('modal-active');
    renderQuoteList();
    showScreen('screen-quotes');
}

function showExport() {
    const finalDiv = document.getElementById('final-paragraph');
    finalDiv.innerHTML = currentState.finalTextParts.filter(p => p).join(' <br><br> ');
    showScreen('screen-export');
    updateProgress(100);
}

/* --- 6. GAMIFICATION --- */
const canvas = document.getElementById('particle-canvas');
const ctx = canvas.getContext('2d');
let particles = [];

function resizeCanvas() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resizeCanvas);
resizeCanvas();

function fireParticles(amount) {
    if (currentState.reducedMotion) return;
    const colors = ['#f1c40f', '#e67e22', '#2ecc71', '#3498db'];
    for (let i = 0; i < amount; i++) {
        particles.push({
            x: window.innerWidth / 2,
            y: window.innerHeight / 2,
            vx: (Math.random() - 0.5) * 10,
            vy: (Math.random() - 0.5) * 10,
            life: 1.0,
            color: colors[Math.floor(Math.random() * colors.length)],
            size: Math.random() * 5 + 2
        });
    }
    requestAnimationFrame(updateParticles);
}

function updateParticles() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    for (let i = particles.length - 1; i >= 0; i--) {
        let p = particles[i];
        p.x += p.vx; p.y += p.vy; p.life -= 0.02; p.vy += 0.2;
        ctx.fillStyle = p.color; ctx.globalAlpha = p.life;
        ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
        if (p.life <= 0) particles.splice(i, 1);
    }
    if (particles.length > 0) requestAnimationFrame(updateParticles);
}

</script>
</body>
</html>
