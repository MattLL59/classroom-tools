<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tone & Structure Architect v123</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --primary: #009688; --accent: #ff9800; --bg: #f0f2f5;
            --card: #ffffff; --text: #37474f; --tone-col: #9c27b0;
            --struct-col: #2196f3; --lang-col: #4caf50; --nav-bg: #ffffff;
        }
        body.theme-dyslexia { --bg: #fdf5e6; --text: #222; --card: #fffcf5; font-family: 'Verdana', sans-serif !important; }
        body { font-family: 'Segoe UI', sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        header { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: var(--card); box-shadow: 0 2px 5px rgba(0,0,0,0.1); z-index: 100; flex-shrink: 0; }
        h1 { margin: 0; font-size: 1.1rem; color: var(--primary); display:flex; align-items:center; gap:5px; }
        .main-viewport { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        nav.bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 65px; background: var(--nav-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #ddd; z-index: 900; }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; color: #888; font-size: 0.75rem; border: none; background: none; cursor: pointer; }
        .nav-item.active { color: var(--primary); font-weight: bold; }
        .hub { display: none; } .hub.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media(min-width: 600px) { .grid { grid-template-columns: 1fr 1fr; } }
        .card { background: var(--card); padding: 20px; border-radius: 12px; border: 2px solid #ddd; text-align: center; cursor: pointer; transition: transform 0.1s; }
        .card:hover { transform: scale(1.02); border-color: var(--primary); }
        .bank-list { display: flex; flex-direction: column; gap: 12px; margin-bottom: 20px; background: rgba(0,0,0,0.02); padding: 10px; border-radius: 8px; }
        .bank-label { font-size: 0.75rem; font-weight: bold; text-transform: uppercase; color: var(--primary); display: block; margin-bottom: 3px; }
        select.bank-select { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #bbb; background: var(--card); font-size: 1.1rem; }
        #sentence-stage { width: 100%; padding: 15px; background: var(--card); border: 2px dashed var(--primary); border-radius: 10px; margin: 15px 0; font-size: 1.1rem; min-height: 60px; box-sizing: border-box; line-height: 1.4; }
        #answer-area { width: 100%; height: 150px; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-bottom: 10px; box-sizing: border-box; font-size: 1rem; }
        .btn { padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; color: white; }
        .btn-primary { background: var(--primary); width: 100%; }
        .admin-btn { background:none; border:none; color:var(--text); font-size:1.2rem; cursor:pointer; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 999999; justify-content: center; align-items: center; }
        .modal-content { background: var(--card); width: 95%; max-width: 800px; max-height: 90vh; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; }
        .modal-body { padding: 20px; overflow-y: auto; text-align: left; }
        .editor-section { border: 2px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 5px; background: rgba(0,0,0,0.02); }
        .admin-input { width: 100%; padding: 10px; border: 1px solid #aaa; border-radius: 4px; box-sizing: border-box; margin-bottom: 5px; }
        #save-status { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: #000; color: #fff; padding: 5px 15px; border-radius: 20px; opacity: 0; transition: 0.5s; z-index: 10000; }
        .bank-btn { background:#607d8b; color:white; border:none; padding:8px; border-radius:4px; margin:2px; cursor:pointer; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; } th, td { border: 1px solid #ccc; padding: 8px; }
    </style>
</head>
<body>

<header>
    <h1><button onclick="hardReset()" style="background:red; border:none; color:white; border-radius:50%; width:24px; cursor:pointer;">‚ö†Ô∏è</button> v123</h1>
    <div style="display:flex; gap:10px;">
        <button class="admin-btn" onclick="document.getElementById('theme-modal').style.display='flex'"><i class="fas fa-palette"></i></button>
        <select id="level-select" onchange="changeLevel()"><option value="1">L1</option><option value="2">L2</option><option value="3">L3</option></select>
        <button class="admin-btn" onclick="requestAdmin()"><i class="fas fa-cog"></i></button>
    </div>
</header>

<div id="save-status">üíæ Auto-Saved</div>

<div class="main-viewport">
    <div id="hub-lab" class="hub active">
        <div style="margin-bottom:10px; font-size:0.8rem;">Text: <b id="text-display"></b> | Q: <b id="q-display"></b></div>
        <div id="lab-content"></div>
    </div>
    <div id="hub-writing" class="hub">
        <div class="bank-list" id="builder-controls"></div>
        <div id="sentence-stage">Start in the Lab...</div>
        <button class="btn btn-primary" onclick="commitSentence()">Add to Answer</button>
        <textarea id="answer-area" oninput="autoSave()"></textarea>
    </div>
</div>

<nav class="bottom-nav">
    <button id="nav-lab" class="nav-item active" onclick="switchHub('lab')"><i class="fas fa-vial"></i><span>Lab</span></button>
    <button id="nav-writing" class="nav-item" onclick="switchHub('writing')"><i class="fas fa-pen"></i><span>Desk</span></button>
</nav>

<div id="admin-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header" style="padding:15px; background:#eee; font-weight:bold; display:flex; justify-content:space-between;">Settings <button onclick="closeAdmin()">X</button></div>
        <div class="modal-body">
            <div class="editor-section" style="background:#f3e5f5; border-color:#9c27b0;">
                <h3>ü§ñ AI Assistant</h3>
                <label>Author Name:</label><input id="ai-author" class="admin-input" placeholder="The writer">
                <label>Number of Quotes:</label><input id="ai-count" type="number" class="admin-input" value="5">
                <label>Source Text:</label><textarea id="ai-text" class="admin-input" style="height:60px;"></textarea>
                <label>Essay Question:</label><textarea id="ai-q" class="admin-input" style="height:40px;"></textarea>
                <button class="btn" style="background:#7b1fa2; width:100%;" onclick="makeAIPrompt()">‚ú® Generate Prompt</button>
                <textarea id="ai-out" class="admin-input" style="display:none; height:100px; margin-top:10px; background:#eee;" readonly></textarea>
                <hr>
                <label>Paste AI Response here:</label><textarea id="ai-in" class="admin-input" style="height:60px;"></textarea>
                <button class="btn" style="background:#4a148c; width:100%;" onclick="loadAI()">üì• Load Lesson</button>
            </div>

            <div class="editor-section">
                <h3>‚úçÔ∏è Analysis Banks</h3>
                <div id="bank-btns">
                    <button class="bank-btn" onclick="openBank('starters')">Starters</button>
                    <button class="bank-btn" onclick="openBank('markers')">Markers</button>
                    <button class="bank-btn" onclick="openBank('methods')">Methods</button>
                    <button class="bank-btn" onclick="openBank('points')">Points</button>
                    <button class="bank-btn" onclick="openBank('links')">Links</button>
                </div>
                <div id="bank-editor" style="display:none; margin-top:10px; border:1px solid #ccc; padding:10px;">
                    <h4 id="bank-title"></h4>
                    <div id="bank-items"></div>
                    <button class="btn btn-primary" onclick="addBankItem()" style="margin-top:5px;">+ Add</button>
                </div>
            </div>

            <div class="editor-section">
                <h3>üñ®Ô∏è Worksheet Generator</h3>
                <div style="display:flex; gap:5px;">
                    <button class="btn" style="background:#00796b; flex:1;" onclick="doPrint()">üìÑ View/Print</button>
                    <button class="btn" style="background:#1976d2; flex:1;" onclick="doWord()">‚¨á Word Doc</button>
                </div>
            </div>

            <div class="editor-section">
                <h3>üíæ Data</h3>
                <button class="btn btn-primary" onclick="downloadData()">Save JSON File</button>
                <button class="btn" style="background:#000; width:100%; margin-top:10px;" onclick="downloadStudent()">üì¶ Download Student App</button>
            </div>
        </div>
    </div>
</div>

<div id="theme-modal" class="modal"><div class="modal-content" style="max-width:300px;"><div class="modal-body"><div onclick="setTheme('default')" class="card">Default</div><div onclick="setTheme('dyslexia')" class="card" style="margin-top:10px;">Cream</div><button onclick="this.parentElement.parentElement.parentElement.style.display='none'">Close</button></div></div></div>

<script id="data-script">
    /* DATA_START */ const teacherConfig = null; /* DATA_END */
    let appData = { textTitle:"New Text", question:"Q?", items:[], starters:[], markers:[], methods:[], points:[], links:[], sentenceConfigs:{1:['starter','quote','point'], 2:['starter','quote','method','analysis'], 3:['marker','starter','quote','method','point','analysis']} };
    let state = { level:1, currentIdx:-1, completed:[], currentLens:'' };
    let sentenceSlots = {};
    let activeBank = '';

    function init() {
        const local = localStorage.getItem('tsa_v123');
        if(teacherConfig) appData = teacherConfig;
        else if(local) appData = JSON.parse(local);
        
        const savedWork = localStorage.getItem('tsa_essay');
        if(savedWork) document.getElementById('answer-area').value = savedWork;
        
        updateUI();
        switchHub('lab');
    }

    function switchHub(h) {
        document.querySelectorAll('.hub').forEach(el=>el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el=>el.classList.remove('active'));
        document.getElementById('hub-'+h).classList.add('active');
        document.getElementById('nav-'+h).classList.add('active');
        if(h==='lab') resetToGrid();
    }

    function resetToGrid() {
        state.currentIdx = -1;
        document.getElementById('lab-content').innerHTML = `<div class="grid" id="main-grid"></div>`;
        const grid = document.getElementById('main-grid');
        appData.items.forEach((item, i) => {
            if(state.completed.includes(i)) return;
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `"${item.original}"<br><small>${item.type}</small>`;
            div.onclick = () => startItem(i);
            grid.appendChild(div);
        });
    }

    function startItem(i) {
        state.currentIdx = i;
        const item = appData.items[i];
        document.getElementById('lab-content').innerHTML = `<h3>Step 2: Meaning</h3><div class="grid" id="meaning-grid"></div>`;
        let opts = [{t:item.translation, c:true}, ...item.distractors.map(d=>({t:d, c:false}))].sort(()=>Math.random()-0.5);
        opts.forEach(o => {
            const d = document.createElement('div'); d.className='card'; d.innerText = o.t;
            d.onclick = () => { if(o.c){ sentenceSlots.quote=`"${item.original}"`; state.currentLens=item.type; switchHub('writing'); renderBuilder(); } else alert("Try again"); };
            document.getElementById('meaning-grid').appendChild(d);
        });
    }

    function renderBuilder() {
        const container = document.getElementById('builder-controls');
        container.innerHTML = '';
        const cfg = appData.sentenceConfigs[state.level] || appData.sentenceConfigs[1];
        cfg.forEach(type => {
            if(type==='quote' || type==='analysis' || type==='none') return;
            const row = document.createElement('div'); row.className='bank-row';
            let opts = appData[type+'s'] || [];
            row.innerHTML = `<span class="bank-label">${type}</span><select class="bank-select" onchange="sentenceSlots['${type}']=this.value; updateSentence();"><option value="">Choose...</option>${opts.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
            container.appendChild(row);
        });
        updateSentence();
    }

    function updateSentence() {
        const cfg = appData.sentenceConfigs[state.level];
        let str = cfg.map(t => sentenceSlots[t] || '').filter(s=>s!='').join(' ');
        document.getElementById('sentence-stage').innerText = str || 'Build your sentence...';
    }

    function commitSentence() {
        const txt = document.getElementById('sentence-stage').innerText;
        if(txt.includes('Build')) return;
        document.getElementById('answer-area').value += (document.getElementById('answer-area').value ? '\n\n' : '') + txt;
        if(state.currentIdx > -1) state.completed.push(state.currentIdx);
        autoSave();
        sentenceSlots = {};
        switchHub('lab');
    }

    function autoSave() { localStorage.setItem('tsa_v123', JSON.stringify(appData)); localStorage.setItem('tsa_essay', document.getElementById('answer-area').value); }
    function requestAdmin() { if(prompt("Password")==="1234") document.getElementById('admin-modal').style.display='flex'; }
    function closeAdmin() { document.getElementById('admin-modal').style.display='none'; }
    function setTheme(t) { document.body.className = t==='default'?'':'theme-'+t; }

    function makeAIPrompt() {
        const count = document.getElementById('ai-count').value;
        const txt = document.getElementById('ai-text').value;
        const q = document.getElementById('ai-q').value;
        const auth = document.getElementById('ai-author').value || "The writer";
        
        const prompt = `Act as an English Teacher. 
        1. Write a model analytical paragraph answering: "${q}" using the text: "${txt}".
        2. Break this paragraph into ${count} JSON items.
        3. Rules: Starters MUST begin with "${auth}". Methods MUST be single words. Include 3 plausible distractors for meanings. Tag links with (Tone), (Structure) or (Lang).
        JSON Format: { "textTitle":"...", "items":[{ "original":"Quote", "type":"tone/lang/struct", "translation":"...", "distractors":["..."] }], "starters":[], "markers":[], "methods":[], "points":[], "links":[] }`;
        
        document.getElementById('ai-out').style.display='block';
        document.getElementById('ai-out').value = prompt;
    }

    function loadAI() {
        try {
            const data = JSON.parse(document.getElementById('ai-in').value);
            appData = { ...appData, ...data };
            autoSave(); updateUI(); alert("Loaded");
        } catch(e) { alert("Invalid JSON"); }
    }

    function openBank(b) {
        activeBank = b;
        document.getElementById('bank-editor').style.display='block';
        document.getElementById('bank-title').innerText = b.toUpperCase();
        renderBankItems();
    }

    function renderBankItems() {
        const container = document.getElementById('bank-items');
        container.innerHTML = '';
        appData[activeBank].forEach((item, i) => {
            const div = document.createElement('div');
            div.innerHTML = `<input value="${item}" onchange="appData['${activeBank}'][${i}]=this.value; autoSave();"> <button onclick="appData['${activeBank}'].splice(${i},1); renderBankItems();">X</button>`;
            container.appendChild(div);
        });
    }

    function addBankItem() { appData[activeBank].push("New"); renderBankItems(); }

    function doPrint() {
        const w = window.open('', '_blank');
        let html = `<h1>${appData.textTitle}</h1><h3>Match Up</h3><table>`;
        const items = appData.items;
        const shuff = [...items].sort(()=>Math.random()-0.5);
        items.forEach((it, i) => html += `<tr><td>${it.original}</td><td>${shuff[i].translation}</td></tr>`);
        html += `</table><h3>Analysis</h3>`;
        items.forEach((it, i) => html += `<div style="border:1px solid #000; padding:10px; margin:5px;">${i+1}. "${it.original}"<br><br><br></div>`);
        w.document.write(html); w.document.close();
    }

    function updateUI() {
        document.getElementById('text-display').innerText = appData.textTitle;
        document.getElementById('q-display').innerText = appData.question;
        document.getElementById('edit-title').value = appData.textTitle;
        document.getElementById('edit-question').value = appData.question;
    }

    function updateGlobal(k, v) { appData[k]=v; autoSave(); updateUI(); }
    function hardReset() { if(confirm("Reset everything?")) { localStorage.clear(); location.reload(); } }
    function downloadData() { const blob = new Blob([JSON.stringify(appData)], {type:'application/json'}); const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='lesson.json'; a.click(); }
    function downloadStudent() {
        const clone = JSON.parse(JSON.stringify(appData));
        let html = document.documentElement.outerHTML;
        html = html.replace(/const teacherConfig = null;/, `const teacherConfig = ${JSON.stringify(clone)};`);
        const blob = new Blob([html], {type:'text/html'});
        const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='student.html'; a.click();
    }

    init();
</script>
</body>
</html>
