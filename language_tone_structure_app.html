<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone & Structure Architect v54 (QR & Hosting)</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #009688; 
            --accent: #ff9800; 
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #37474f;
            --tone-col: #9c27b0;
            --struct-col: #2196f3;
            --lang-col: #4caf50;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; text-align: center;
        }

        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex-shrink: 0; margin-bottom: 20px;
        }
        h1 { margin: 0; color: var(--primary); font-size: 1.4rem; display:flex; align-items:center; gap:10px; }
        
        .admin-btn { 
            font-size: 1.2rem; color: #555; background: #eee; border: none; 
            border-radius: 5px; padding: 8px 12px; cursor: pointer; transition: all 0.2s;
        }
        .admin-btn:hover { background: #ddd; }

        .container { 
            flex-grow: 1; max-width: 1100px; width: 100%; margin: 0 auto; 
            display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-right: 5px; 
        }

        .stage { display: none; animation: fadeIn 0.3s; }
        .stage.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .instruction { color: #78909c; margin-bottom: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; }
        .dynamic-question { font-size: 1.4rem; color: var(--primary); font-weight: bold; margin-bottom: 20px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; }
        
        .card { 
            background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid #ddd;
            cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;
            display: flex; flex-direction: column; justify-content: center; min-height: 80px;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-color: var(--primary); }
        .card-struct { border-left: 5px solid var(--struct-col) !important; background: #f4faff !important; text-align: left; align-items: flex-start !important; }
        .card-lang { border-left: 5px solid var(--lang-col) !important; }
        .card-tone { border-left: 5px solid var(--tone-col) !important; }

        .card strong { font-size: 1.1rem; display: block; margin-bottom: 5px; color: #333; }
        .card small { font-size: 0.85rem; color: #666; font-style: italic; }

        /* BUILDER PANEL */
        .builder-panel {
            background: white; border-radius: 10px; padding: 20px; border-top: 4px solid var(--primary);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); flex-shrink: 0;
        }
        
        .controls { 
            display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap; 
            padding-bottom: 15px; border-bottom: 1px dashed #eee;
        }
        
        .bank-group { display: flex; flex-direction: column; gap: 5px; align-items: flex-start; }
        .bank-label { font-size: 0.7rem; color: #999; font-weight: bold; text-transform: uppercase; }
        
        select.bank-select { 
            padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; 
            background: #f9f9f9; font-weight: 500; cursor: pointer; min-width: 140px; max-width: 200px;
        }
        select.bank-select:hover { border-color: var(--primary); background: white; }

        .locked-slot {
            padding: 8px 12px; border: 1px dashed var(--primary); border-radius: 5px;
            background: #e0f2f1; color: var(--primary-dark); font-size: 0.85rem;
            font-weight: bold; display: flex; align-items: center; justify-content: center;
            min-width: 140px; text-align: center;
        }

        #sentence-stage { width: 98%; padding: 10px; border: 2px dashed #ccc; border-radius: 5px; font-size: 1.1rem; margin-bottom: 5px; }
        #structure-preview { font-size: 0.75rem; color: #888; text-align: left; margin-bottom: 15px; font-family: monospace; }
        
        #answer-area { width: 98%; height: 150px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; font-family: 'Segoe UI'; font-size: 1rem; resize: vertical; display: none; }

        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; transition: all 0.2s; }
        .btn:hover { opacity: 0.9; transform: translateY(-1px); }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: var(--accent); }
        .btn-doc { background: #2b5797; }
        .btn-danger { background: #e74c3c; padding: 4px 8px; font-size: 0.8rem; margin-left: 5px; }
        .btn-add { background: #2ecc71; width: 100%; margin-top: 5px; }
        .btn-warning { background: #f39c12; color: white; }
        
        .btn-edit-analysis {
            background-color: #9c27b0;
            color: white;
            font-size: 0.9rem;
            padding: 6px 12px;
            border: 1px solid #7b1fa2;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .btn-edit-analysis:hover { background-color: #7b1fa2; box-shadow: 0 4px 8px rgba(0,0,0,0.3); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 95%; max-width: 900px; max-height: 90vh; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px; background: #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-body { padding: 20px; overflow-y: auto; text-align: left; }

        .list-container { margin-bottom: 15px; }
        .list-item { display: flex; align-items: center; margin-bottom: 5px; }
        .list-input { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        .editor-section { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; background: #f9f9f9; }
        .admin-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 5px; }
        
        .analysis-details { margin-top: 10px; padding: 15px; border: 2px solid #9c27b0; border-radius: 5px; background: #fdfbff; display:none; }
        .lens-group { display: none; } 
        .lens-group.active { display: block; animation: fadeIn 0.3s; }
        .level-block { margin-bottom: 10px; border-bottom: 1px dashed #eee; padding-bottom: 10px; }
        
        #wizard-overlay { flex-direction:column; padding:20px; box-sizing:border-box; background: white; }
        
        #phrasing-overlay { z-index: 2000; background: rgba(0,0,0,0.8); }
        .phrase-option { 
            background: #f0f4c3; padding: 15px; margin-bottom: 10px; border-radius: 8px; 
            cursor: pointer; font-size: 1.1rem; border: 2px solid transparent; transition:0.2s; 
        }
        .phrase-option:hover { border-color: var(--primary); background: #fff; transform: scale(1.02); }

        #overlay-msg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.95); z-index: 3000; color: white; flex-direction: column; justify-content: center; align-items: center; }
        
        .hard-reset-btn { background: #e74c3c; color: white; border: none; padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; cursor: pointer; }
        .filter-bar { display: flex; gap: 5px; justify-content: center; margin-bottom: 15px; }
        .filter-btn { padding: 5px 15px; border: 1px solid #ccc; background: white; border-radius: 20px; cursor: pointer; font-size: 0.8rem; }
        .filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-cubes"></i> Tone & Structure v54</h1>
        <div>
            <button class="hard-reset-btn" onclick="hardReset()">‚ö†Ô∏è Factory Reset</button>
            <select id="level-select" onchange="changeLevel()" style="padding:5px; border-radius:5px; border:1px solid #ccc;">
                <option value="1">Level 1: Foundation</option>
                <option value="2">Level 2: Developing</option>
                <option value="3">Level 3: Secure</option>
            </select>
            <button class="admin-btn" onclick="requestAdminAccess()"><i class="fas fa-cog"></i> Settings</button>
        </div>
    </header>

    <div class="container">
        <div style="display:flex; justify-content:space-between; color:#607d8b; font-size:0.9rem;">
            <span><strong>Text:</strong> <span id="text-display">Loading...</span></span>
            <span><strong>Q:</strong> <span id="q-display">...</span></span>
        </div>

        <div id="stage-select" class="stage active">
            <div class="instruction">Step 1: Evidence</div>
            <div class="filter-bar">
                <button class="filter-btn active" onclick="filterGrid('all', this)">All</button>
                <button class="filter-btn" onclick="filterGrid('language', this)">Tone/Lang</button>
                <button class="filter-btn" onclick="filterGrid('structure', this)">Structure</button>
            </div>
            <div id="dynamic-question-display" class="dynamic-question">Select Evidence to Analyze</div>
            <div class="grid" id="grid-main"></div>
        </div>

        <div id="stage-decoder" class="stage">
            <div class="instruction">Step 2: Translation Bridge</div>
            <div style="background:#e0f2f1; padding:20px; border-radius:8px; margin-bottom:20px; font-size:1.2rem;">
                "<span id="decoder-quote"></span>"
            </div>
            <div class="grid" id="grid-decoder"></div>
        </div>

        <div id="stage-lens" class="stage">
            <div class="instruction">Step 3: Select Lens</div>
            <div class="grid">
                <div class="card card-tone" onclick="loadAnalysis('tone')"><strong>üé≠ Tone</strong><small>Emotion</small></div>
                <div class="card card-struct" onclick="loadAnalysis('structure')"><strong>üèóÔ∏è Structure</strong><small>Order/Shift</small></div>
                <div class="card card-lang" onclick="loadAnalysis('language')"><strong>üìñ Language</strong><small>Devices</small></div>
            </div>
        </div>

        <div id="stage-analysis" class="stage">
            <div class="instruction" id="analysis-prompt">...</div>
            <div class="grid" id="grid-analysis"></div>
        </div>
    </div>

    <div class="builder-panel">
        <div class="instruction" style="text-align:center;">Answer Builder</div>
        <div class="controls" id="dynamic-builder-controls"></div>
        <input type="text" id="sentence-stage" placeholder="Answer builds here...">
        <div id="structure-preview">Structure: [Empty]</div>
        <textarea id="answer-area" placeholder="Your full answer..."></textarea>
        <div id="essay-controls" style="display:none; margin-top:10px; justify-content:flex-end; gap:10px;">
            <button class="btn btn-doc" onclick="downloadDoc()">Download Answer (.doc)</button>
            <button class="btn btn-accent" onclick="clearEssay()">Clear</button>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Teacher Settings 
                <div>
                    <button class="btn btn-warning" onclick="changePassword()" style="font-size:0.8rem; margin-right:10px;">Change Password</button>
                    <button onclick="closeAdmin()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">&times;</button>
                </div>
            </div>
            <div class="modal-body">
                <div class="editor-section">
                    <h3>Basic Info</h3>
                    <label>Text Title:</label><input id="edit-title" class="admin-input" onchange="updateGlobal('textTitle', this.value)">
                    <label>Question:</label><input id="edit-question" class="admin-input" onchange="updateGlobal('question', this.value)">
                </div>

                <div class="editor-section" style="border-left: 5px solid #9c27b0;">
                    <h3>üó£Ô∏è Analysis Phrasing & Grammar</h3>
                    <p style="font-size:0.9rem;">
                        Use <strong>{adj}</strong> for adjective, <strong>{noun}</strong> for noun.<br>
                    </p>
                    <label><strong>Tone Templates:</strong></label>
                    <div id="list-tmpl-tone" class="list-container"></div>
                    <button class="btn btn-add" onclick="addTemplate('tone')">+ Add Tone Template</button>
                    
                    <label style="margin-top:15px;display:block;"><strong>Structure Templates:</strong></label>
                    <div id="list-tmpl-structure" class="list-container"></div>
                    <button class="btn btn-add" onclick="addTemplate('structure')">+ Add Structure Template</button>
                    
                    <label style="margin-top:15px;display:block;"><strong>Language Templates:</strong></label>
                    <div id="list-tmpl-language" class="list-container"></div>
                    <button class="btn btn-add" onclick="addTemplate('language')">+ Add Language Template</button>
                </div>

                <div class="editor-section" style="border-left: 5px solid var(--accent);">
                    <h3>‚öôÔ∏è Sentence Structure Config</h3>
                    <div style="display:flex; gap:5px; margin-bottom:10px; flex-wrap:wrap;">
                        <select class="admin-input" id="cfg-slot1" onchange="saveStructureConfig()" style="width:auto;"></select>
                        <select class="admin-input" id="cfg-slot2" onchange="saveStructureConfig()" style="width:auto;"></select>
                        <select class="admin-input" id="cfg-slot3" onchange="saveStructureConfig()" style="width:auto;"></select>
                        <select class="admin-input" id="cfg-slot4" onchange="saveStructureConfig()" style="width:auto;"></select>
                        <select class="admin-input" id="cfg-slot5" onchange="saveStructureConfig()" style="width:auto;"></select>
                        <select class="admin-input" id="cfg-slot6" onchange="saveStructureConfig()" style="width:auto;"></select>
                    </div>
                    <button class="btn btn-danger" style="width:100%; margin-top:5px; background:#e74c3c;" onclick="resetSentenceOrder()">‚Ü∫ Reset to Default</button>
                </div>

                <div class="editor-section">
                    <h3>üè¶ Scaffolding Banks</h3>
                    <label><strong>1. Markers</strong></label><div id="list-markers" class="list-container"></div><button class="btn btn-add" onclick="addItem('markers')">+ Add</button>
                    <label style="margin-top:10px;"><strong>2. Starters</strong></label><div id="list-starters" class="list-container"></div><button class="btn btn-add" onclick="addItem('starters')">+ Add</button>
                    <label style="margin-top:10px;"><strong>3. Methods</strong></label><div id="list-methods" class="list-container"></div><button class="btn btn-add" onclick="addItem('methods')">+ Add</button>
                    <label style="margin-top:10px;"><strong>4. Points</strong></label><div id="list-points" class="list-container"></div><button class="btn btn-add" onclick="addItem('points')">+ Add</button>
                    <label style="margin-top:10px;"><strong>5. Links</strong></label><div id="list-links" class="list-container"></div><button class="btn btn-add" onclick="addItem('links')">+ Add</button>
                </div>
                
                <div class="editor-section">
                    <h3>Analysis Points (Deep Edit)</h3>
                    <div id="items-container"></div>
                    <button class="btn btn-add" onclick="addNewItem()">+ Add New Analysis Point</button>
                </div>

                <div style="margin-top:20px; padding:15px; background:#e3f2fd; border-radius:5px;">
                    <h3>üíæ Data & Distribution</h3>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <button class="btn btn-doc" onclick="downloadJSON()">Save Settings JSON</button>
                        <button class="btn btn-doc" onclick="document.getElementById('file-up').click()">Load Settings JSON</button>
                        <input type="file" id="file-up" style="display:none;" onchange="uploadJSON(this)">
                    </div>
                    
                    <div style="padding:15px; border:2px dashed var(--primary); border-radius:5px; background:white; margin-bottom:15px; text-align:left;">
                        <strong>üöÄ Share with Students</strong><br>
                        <p style="font-size:0.85rem; margin:5px 0;">1. Click "Download Class App".<br>2. Upload that file to GitHub Pages or Netlify Drop.<br>3. Paste the URL below to get a QR Code.</p>
                        <button class="btn btn-primary" style="width:100%; margin-top:5px;" onclick="downloadStudentApp()">üì¶ Download Class App (.html)</button>
                        
                        <div style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
                            <label style="font-size:0.9rem; font-weight:bold;">Generate QR Code:</label>
                            <input class="admin-input" id="qr-input" placeholder="Paste your hosted link (e.g. https://...)" oninput="generateQR(this.value)">
                            <div id="qr-display" style="margin-top:10px; text-align:center; min-height:150px; display:flex; align-items:center; justify-content:center; background:#f9f9f9; border:1px solid #ddd;">
                                <span style="color:#ccc;">QR will appear here</span>
                            </div>
                        </div>
                    </div>

                    <hr>
                    <p style="margin-bottom:5px; font-weight:bold;">Select Level to Print:</p>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <select id="ws-print-mode" class="admin-input" style="width:auto; flex-grow:1;">
                            <option value="all">Merged (Use Checkboxes)</option>
                            <option value="1">Level 1 Only</option>
                            <option value="2">Level 2 Only</option>
                            <option value="3">Level 3 Only</option>
                        </select>
                        <button class="btn btn-accent" onclick="downloadWorksheetDoc()">üìù Download Worksheet (.doc)</button>
                    </div>
                    <div style="margin-top:10px; display:flex; gap:10px;">
                        <label><input type="checkbox" id="ws-lvl1" checked onchange="saveWSOptions()"> Incl. L1</label>
                        <label><input type="checkbox" id="ws-lvl2" checked onchange="saveWSOptions()"> Incl. L2</label>
                        <label><input type="checkbox" id="ws-lvl3" checked onchange="saveWSOptions()"> Incl. L3</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="phrasing-overlay" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">Select Phrasing</div>
            <div class="modal-body">
                <p>You chose: <strong id="phrase-word" style="color:var(--primary);"></strong></p>
                <p>Choose how to say it:</p>
                <div id="phrase-options"></div>
            </div>
        </div>
    </div>

    <div id="overlay-msg" onclick="this.style.display='none'">
        <i id="overlay-icon" class="fas fa-check-circle" style="font-size:4rem; margin-bottom:20px;"></i>
        <h2 id="overlay-text">Correct!</h2>
    </div>

<script>
    // --- MORPHOLOGY DICTIONARY ---
    const wordMorphology = {
        "admiring": { adj: "admiring", noun: "admiration", verb: "admires" },
        "admiration": { adj: "admiring", noun: "admiration", verb: "admires" },
        "angry": { adj: "angry", noun: "anger", verb: "angers" },
        "anger": { adj: "angry", noun: "anger", verb: "angers" },
        "anxious": { adj: "anxious", noun: "anxiety", verb: "worries" },
        "anxiety": { adj: "anxious", noun: "anxiety", verb: "worries" },
        "chaotic": { adj: "chaotic", noun: "chaos", verb: "disrupts" },
        "chaos": { adj: "chaotic", noun: "chaos", verb: "disrupts" },
        "critical": { adj: "critical", noun: "criticism", verb: "criticizes" },
        "criticism": { adj: "critical", noun: "criticism", verb: "criticizes" },
        "cyclical": { adj: "cyclical", noun: "cyclical structure", verb: "cycles" },
        "desperate": { adj: "desperate", noun: "desperation", verb: "despairs" },
        "desperation": { adj: "desperate", noun: "desperation", verb: "despairs" },
        "enthusiastic": { adj: "enthusiastic", noun: "enthusiasm", verb: "enthuses" },
        "enthusiasm": { adj: "enthusiastic", noun: "enthusiasm", verb: "enthuses" },
        "fearful": { adj: "fearful", noun: "fear", verb: "fears" },
        "fear": { adj: "fearful", noun: "fear", verb: "fears" },
        "gloomy": { adj: "gloomy", noun: "gloom", verb: "saddens" },
        "gloom": { adj: "gloomy", noun: "gloom", verb: "saddens" },
        "hopeful": { adj: "hopeful", noun: "hope", verb: "hopes" },
        "hope": { adj: "hopeful", noun: "hope", verb: "hopes" },
        "hostile": { adj: "hostile", noun: "hostility", verb: "attacks" },
        "hostility": { adj: "hostile", noun: "hostility", verb: "attacks" },
        "joyful": { adj: "joyful", noun: "joy", verb: "rejoices" },
        "joy": { adj: "joyful", noun: "joy", verb: "rejoices" },
        "melancholy": { adj: "melancholic", noun: "melancholy", verb: "saddens" },
        "nostalgic": { adj: "nostalgic", noun: "nostalgia", verb: "remembers" },
        "nostalgia": { adj: "nostalgic", noun: "nostalgia", verb: "remembers" },
        "ominous": { adj: "ominous", noun: "foreboding", verb: "threatens" },
        "peaceful": { adj: "peaceful", noun: "peace", verb: "calms" },
        "peace": { adj: "peaceful", noun: "peace", verb: "calms" },
        "tense": { adj: "tense", noun: "tension", verb: "tenses" },
        "tension": { adj: "tense", noun: "tension", verb: "tenses" }
    };

    const defaultData = {
        textTitle: "The Electric Telegraph",
        question: "How is impact conveyed?",
        adminPassword: "1234",
        sentenceOrder: ['starter', 'quote', 'method', 'point', 'analysis', 'link'], 
        worksheetOptions: { lvl1: true, lvl2: true, lvl3: true },
        analysisTemplates: {
            tone: ["creates a {adj} tone", "evokes a sense of {noun}", "establishes an {adj} atmosphere"],
            structure: ["structurally highlights {noun}", "draws attention to the {noun}", "focuses the reader on {noun}"],
            language: ["suggests the idea of {noun}", "conveys a feeling of {noun}", "implies that it is {noun}"]
        },
        markers: ["However,", "Furthermore,", "In contrast,", "Significantly,"],
        starters: ["The writer implies", "This suggests", "It is evident that"],
        points: ["The writer presents a negative view", "The writer highlights the danger"],
        methods: ["metaphor", "simile", "juxtaposition", "imagery", "imperative"],
        links: ["This reinforces the idea that", "linking back to", "creating a sense of"],
        items: [
            {
                id: "q1", type: "quote", original: "wondrous invention", translation: "amazing machine", 
                distractors: ["boring machine", "confusing tool"],
                custom_q: "Which phrase suggests amazement?",
                level1: { tone: { prompt:"Tone?", correct:"Enthusiastic", options:["Enthusiastic","Bored"] } },
                level2: { tone: { prompt:"Tone?", correct:"Awe", options:["Awe","Fear"] } },
                level3: { tone: { prompt:"Tone?", correct:"Sublime", options:["Sublime","Mocking"] } }
            }
        ]
    };

    let appData = JSON.parse(JSON.stringify(defaultData));
    let state = { level: 1, currentIdx: 0, filter: 'all', completed: [] };
    let sentenceSlots = { marker:"", starter:"", point:"", method:"", quote:"", link:"", analysis:"" };

    function init() {
        let local = localStorage.getItem('tsa_v54_qr');
        if(!local) { local = localStorage.getItem('tsa_v53_blob'); }

        if(local) {
            try { 
                const saved = JSON.parse(local);
                appData = { ...defaultData, ...saved };
                ['markers','starters','points','methods','links','sentenceOrder'].forEach(k => { 
                    if(!Array.isArray(appData[k])) appData[k] = defaultData[k]; 
                });
                if(!appData.analysisTemplates) appData.analysisTemplates = defaultData.analysisTemplates;
                if(!appData.adminPassword) appData.adminPassword = "1234";
                if(!appData.worksheetOptions) appData.worksheetOptions = defaultData.worksheetOptions;
            } catch(e) { appData = defaultData; }
        }
        if(document.readyState === 'loading') { document.addEventListener('DOMContentLoaded', runStartup); } else { runStartup(); }
    }
    
    function runStartup() { state.currentIdx = -1; state.completed = []; updateUI(); loadStageSelect(); }
    function hardReset() { if(confirm("Factory Reset? This wipes password and all data.")) { localStorage.removeItem('tsa_v54_qr'); location.reload(); } }
    function updateUI() { document.getElementById('text-display').innerText = appData.textTitle; document.getElementById('q-display').innerText = appData.question; renderBuilderUI(); }
    
    function requestAdminAccess() {
        const input = prompt("Enter Admin Password:");
        if (input === appData.adminPassword) { openAdmin(); } else { alert("Incorrect Password."); }
    }

    function changePassword() {
        const newPass = prompt("Enter new password:");
        if(newPass && newPass.trim() !== "") { appData.adminPassword = newPass.trim(); saveLocal(); alert("Password changed successfully."); }
    }

    // --- QR GENERATOR ---
    function generateQR(url) {
        const display = document.getElementById('qr-display');
        if(!url || url.trim() === "") {
            display.innerHTML = '<span style="color:#ccc;">QR will appear here</span>';
            return;
        }
        display.innerHTML = `<img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encodeURIComponent(url)}" alt="QR Code" style="border:5px solid white;">`;
    }

    // --- SMART GRAMMAR ---
    function getMorphology(word, type) {
        const lower = word.toLowerCase();
        const entry = wordMorphology[lower];
        if (entry && entry[type]) return entry[type];
        if (type === 'noun') {
            if (lower.endsWith('ing')) return lower.replace('ing', 'ion'); 
            if (lower.endsWith('ent')) return lower.replace('ent', 'ence');
            if (lower.endsWith('ous')) return lower.replace('ous', 'ness');
        }
        return lower; 
    }

    function applyGrammarRules(text) {
        text = text.replace(/\b(a)\s([aeiou])/g, "an $2");
        return text;
    }

    function renderBuilderUI() {
        const container = document.getElementById('dynamic-builder-controls');
        if(!container) return;
        container.innerHTML = '';
        if(!appData.sentenceOrder) appData.sentenceOrder = defaultData.sentenceOrder;
        let previewStr = "";
        appData.sentenceOrder.forEach((type, index) => {
            if(type === 'none') return;
            previewStr += `[${type}] + `;
            const group = document.createElement('div');
            group.className = 'bank-group';
            let labelText = type.charAt(0).toUpperCase() + type.slice(1);
            if(type === 'quote') labelText = "Quote (From Card)";
            if(type === 'analysis') labelText = "Analysis (From Game)";
            const label = document.createElement('span');
            label.className = 'bank-label';
            label.innerText = `${index+1}. ${labelText}`;
            group.appendChild(label);
            if(type === 'quote' || type === 'analysis') {
                const placeholder = document.createElement('div');
                placeholder.className = 'locked-slot';
                placeholder.innerHTML = type === 'quote' ? `<i class="fas fa-quote-right"></i>&nbsp;Quote` : `<i class="fas fa-gamepad"></i>&nbsp;Game`;
                if(sentenceSlots[type]) {
                    placeholder.style.background = '#c8e6c9';
                    placeholder.style.color = '#2e7d32';
                    placeholder.innerHTML = `<i class="fas fa-check"></i> ${type}`;
                }
                group.appendChild(placeholder);
            } else {
                const select = document.createElement('select');
                select.className = 'bank-select';
                select.id = `sel-${type}`;
                select.onchange = () => updateSlot(type);
                select.innerHTML = `<option value="">‚ûï ${labelText}</option>`;
                let key = type + 's'; 
                if(appData[key]) {
                    appData[key].forEach(opt => select.add(new Option(opt, opt)));
                }
                group.appendChild(select);
            }
            container.appendChild(group);
        });
        document.getElementById('structure-preview').innerText = "Structure: " + previewStr.slice(0, -3);
        const btnGroup = document.createElement('div');
        btnGroup.style.display = 'flex'; btnGroup.style.gap = '5px'; btnGroup.style.alignSelf = 'flex-end';
        const btnUndo = document.createElement('button'); btnUndo.className = 'btn btn-warning'; btnUndo.onclick = undoLast; btnUndo.innerHTML = '‚Ü© Undo';
        const btnAdd = document.createElement('button'); btnAdd.className = 'btn btn-primary'; btnAdd.onclick = commitSentence; btnAdd.innerHTML = '‚¨áÔ∏è Add to Answer';
        btnGroup.appendChild(btnUndo); btnGroup.appendChild(btnAdd); container.appendChild(btnGroup);
    }

    function updateSlot(type) { const el = document.getElementById(`sel-${type}`); if(el && el.value) { sentenceSlots[type] = el.value; rebuildSentenceBox(); el.value = ""; } }
    function undoLast() { let order = [...appData.sentenceOrder].reverse(); for(let key of order) { if(sentenceSlots[key]) { sentenceSlots[key] = ""; rebuildSentenceBox(); return; } } }
    function rebuildSentenceBox() {
        let parts = [];
        appData.sentenceOrder.forEach(type => { if(type !== 'none' && sentenceSlots[type]) { parts.push(sentenceSlots[type]); } });
        if(sentenceSlots.analysis && !appData.sentenceOrder.includes('analysis')) parts.push(sentenceSlots.analysis);
        let fullSentence = parts.join(" ");
        fullSentence = applyGrammarRules(fullSentence);
        if(fullSentence.length > 0) { fullSentence = fullSentence.charAt(0).toUpperCase() + fullSentence.slice(1); }
        document.getElementById('sentence-stage').value = fullSentence.trim(); renderBuilderUI();
    }
    function changeLevel() { state.level = parseInt(document.getElementById('level-select').value); loadStageSelect(); }
    function filterGrid(type, btn) { state.filter = type; document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); loadStageSelect(); }

    function loadStageSelect() {
        document.querySelectorAll('.stage').forEach(e=>e.classList.remove('active')); document.getElementById('stage-select').classList.add('active');
        const grid = document.getElementById('grid-main'); if(!grid) return; grid.innerHTML = '';
        if(!appData.items) return;
        let availableCount = 0;
        appData.items.forEach((item, i) => {
            if(state.completed.includes(i)) return; 
            if(state.filter === 'structure' && item.type !== 'structure') return;
            if(state.filter === 'language' && item.type === 'structure') return;
            availableCount++;
            const div = document.createElement('div'); div.className = item.type === 'structure' ? 'card card-struct' : 'card card-lang';
            const mainText = item.type==='structure' ? item.label : '"'+item.original+'"';
            const subText = item.custom_q ? item.custom_q : (item.type==='structure' ? item.detail : "Analyze this quote");
            div.innerHTML = `<strong>${item.type==='structure'?'üèóÔ∏è':'üî§'} ${mainText}</strong><small style="color:#e67e22; font-weight:bold; display:block; margin-top:5px;">${subText}</small>`;
            div.onclick = () => { state.currentIdx = i; document.getElementById('dynamic-question-display').innerText = item.custom_q || "Analyzing Evidence"; item.type==='structure'?loadAnalysis('structure'):loadDecoder(); };
            grid.appendChild(div);
        });
        if(availableCount === 0 && appData.items.length > 0) { grid.innerHTML = `<div style="grid-column:1/-1; text-align:center;"><h3>üéâ Analysis Complete!</h3><button class="btn btn-accent" onclick="runStartup()">Start Over</button></div>`; }
        sentenceSlots.quote = ""; sentenceSlots.analysis = ""; rebuildSentenceBox();
    }

    function loadDecoder() {
        document.getElementById('stage-select').classList.remove('active'); document.getElementById('stage-decoder').classList.add('active');
        const item = appData.items[state.currentIdx]; document.getElementById('decoder-quote').innerText = item.original;
        const grid = document.getElementById('grid-decoder'); grid.innerHTML = '';
        let opts = [{txt: item.translation, correct:true}]; if(item.distractors) item.distractors.forEach(d => opts.push({txt: d, correct:false}));
        opts.sort(()=>Math.random()-0.5).forEach(opt => {
            const btn = document.createElement('div'); btn.className = 'card'; btn.innerText = opt.txt;
            btn.onclick = () => { if(opt.correct) { sentenceSlots.quote = `"${item.original}"`; rebuildSentenceBox(); document.getElementById('stage-decoder').classList.remove('active'); document.getElementById('stage-lens').classList.add('active'); } else alert("Try again."); };
            grid.appendChild(btn);
        });
    }

    function loadAnalysis(lens) {
        const item = appData.items[state.currentIdx]; const lvlKey = 'level'+state.level;
        if(!item[lvlKey] || !item[lvlKey][lens]) { alert("No data for this level."); return; }
        document.getElementById('stage-lens').classList.remove('active'); document.getElementById('stage-analysis').classList.add('active');
        const data = item[lvlKey][lens]; document.getElementById('analysis-prompt').innerText = data.prompt;
        const grid = document.getElementById('grid-analysis'); grid.innerHTML = '';
        let rawOptions = data.options ? [...data.options] : [];
        if(data.correct && !rawOptions.includes(data.correct)) rawOptions.push(data.correct);
        let opts = rawOptions.map(o => ({txt:o, correct: o===data.correct}));
        opts.sort(()=>Math.random()-0.5).forEach(opt => {
            const btn = document.createElement('div'); btn.className = 'card ' + (lens==='tone'?'card-tone':lens==='structure'?'card-struct':'card-lang'); btn.innerText = opt.txt;
            btn.onclick = () => {
                if(opt.correct) { showPhrasingSelector(lens, opt.txt.toLowerCase()); } else alert("Try again.");
            };
            grid.appendChild(btn);
        });
    }

    function showPhrasingSelector(lens, word) {
        const modal = document.getElementById('phrasing-overlay'); const container = document.getElementById('phrase-options');
        document.getElementById('phrase-word').innerText = word; container.innerHTML = '';
        let templates = appData.analysisTemplates[lens] || ["creates a {adj} tone"];
        templates.forEach(t => {
            let filled = t;
            if (t.includes("{noun}")) filled = filled.replace("{noun}", getMorphology(word, 'noun'));
            if (t.includes("{adj}")) filled = filled.replace("{adj}", getMorphology(word, 'adj'));
            if (t.includes("{verb}")) filled = filled.replace("{verb}", getMorphology(word, 'verb'));
            if (t.includes("{word}")) filled = filled.replace("{word}", word);
            const btn = document.createElement('div'); btn.className = 'phrase-option'; btn.innerText = filled;
            btn.onclick = () => { sentenceSlots.analysis = filled; rebuildSentenceBox(); modal.style.display = 'none'; document.getElementById('overlay-msg').style.display='flex'; setTimeout(() => { document.getElementById('overlay-msg').style.display='none'; }, 1000); };
            container.appendChild(btn);
        });
        modal.style.display = 'flex';
    }

    function commitSentence() {
        const val = document.getElementById('sentence-stage').value; if(!val) return;
        const area = document.getElementById('answer-area'); area.style.display='block';
        document.getElementById('essay-controls').style.display='flex'; area.value += (area.value ? "\n\n" : "") + val;
        if(state.currentIdx !== -1) state.completed.push(state.currentIdx);
        sentenceSlots = { marker:"", starter:"", point:"", method:"", quote:"", link:"", analysis:"" };
        document.getElementById('sentence-stage').value = ""; loadStageSelect();
    }
    
    function clearEssay() { if(confirm("Clear answer?")) { document.getElementById('answer-area').value=""; } }
    function downloadDoc() { const blob = new Blob(['<html><body>'+document.getElementById('answer-area').value.replace(/\n/g,'<br>')+'</body></html>'], {type:'application/msword'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Answer.doc'; a.click(); }
    
    // --- FULLY RESTORED WORKSHEET GENERATOR ---
    function downloadWorksheetDoc() {
        try {
            const modeEl = document.getElementById('ws-print-mode');
            const mode = modeEl ? modeEl.value : 'all';
            let evidenceList = [];
            let meaningList = [];
            
            if(!appData.items || appData.items.length === 0) {
                alert("No items to print.");
                return;
            }

            appData.items.forEach(i => {
                evidenceList.push(i.type==='structure' ? 'üèóÔ∏è '+i.label : '"'+i.original+'"');
                meaningList.push(i.type==='structure' ? i.detail : i.translation);
            });
            meaningList.sort(() => Math.random() - 0.5);

            let html = `
            <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
            <head><meta charset='utf-8'><title>Worksheet</title>
            <style>body{font-family:'Calibri',sans-serif;} table{width:100%;border-collapse:collapse;margin-bottom:20px;} td,th{border:1px solid #999;padding:8px;text-align:left;} th{background-color:#eee;} .box-row{height:30px;}</style></head><body>
            <h1>Worksheet: ${appData.textTitle}</h1>
            <p><strong>Question:</strong> ${appData.question}</p>
            <hr><h2>Task 1: Evidence Match-Up</h2>
            <table><tr><th>Evidence</th><th>Meaning (Jumbled)</th></tr>
            ${evidenceList.map((ev, i) => `<tr><td>${ev}</td><td>${meaningList[i]}</td></tr>`).join('')}
            </table><br><h2>Task 2: Analysis</h2>`;

            appData.items.forEach((i, idx) => {
                let levelHtml = "";
                const showL1 = (mode === 'all' && appData.worksheetOptions?.lvl1) || mode === '1';
                const showL2 = (mode === 'all' && appData.worksheetOptions?.lvl2) || mode === '2';
                const showL3 = (mode === 'all' && appData.worksheetOptions?.lvl3) || mode === '3';

                if(showL1 && i.level1) levelHtml += `<p>Level 1: ${i.level1.tone?.prompt || 'Tone?'}</p><table style="width:100%;border:1px solid #000;"><tr><td class="box-row">&nbsp;</td></tr><tr><td class="box-row">&nbsp;</td></tr></table>`;
                if(showL2 && i.level2) levelHtml += `<p>Level 2: ${i.level2.tone?.prompt || 'Implication?'}</p><table style="width:100%;border:1px solid #000;"><tr><td class="box-row">&nbsp;</td></tr><tr><td class="box-row">&nbsp;</td></tr></table>`;
                if(showL3 && i.level3) levelHtml += `<p>Level 3: ${i.level3.tone?.prompt || 'Effect?'}</p><table style="width:100%;border:1px solid #000;"><tr><td class="box-row">&nbsp;</td></tr><tr><td class="box-row">&nbsp;</td></tr></table>`;
                
                if(levelHtml) {
                    html += `<div style="border:1px solid #333;padding:10px;margin-bottom:15px;"><p><strong>${idx+1}. ${i.type==='structure'?i.label:'"'+i.original+'"'}</strong></p>${levelHtml}</div>`;
                }
            });
            html += "</body></html>";
            const blob = new Blob([html], {type:'application/msword'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = 'Worksheet.doc'; document.body.appendChild(a); a.click(); document.body.removeChild(a);
        } catch(e) {
            alert("Worksheet Generation Error: " + e.message);
        }
    }

    // --- STUDENT APP GENERATOR ---
    function downloadStudentApp() {
        const clone = JSON.parse(JSON.stringify(appData));
        const htmlContent = document.documentElement.outerHTML;
        const scriptStart = htmlContent.indexOf('const defaultData =');
        const scriptEnd = htmlContent.indexOf('let appData =');
        
        if(scriptStart === -1 || scriptEnd === -1) { alert("Error generating app."); return; }
        
        const newScript = `const defaultData = ${JSON.stringify(clone)};\n    `;
        const finalHTML = htmlContent.substring(0, scriptStart) + newScript + htmlContent.substring(scriptEnd);
        
        const blob = new Blob([finalHTML], {type:'text/html'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'Student_Lesson.html';
        a.click();
    }

    function saveLocal() { localStorage.setItem('tsa_v54_qr', JSON.stringify(appData)); }
    function updateGlobal(k, v) { appData[k]=v; saveLocal(); updateUI(); }
    function openAdmin() { document.getElementById('admin-modal').style.display='flex'; renderTemplateList('tone','list-tmpl-tone'); renderTemplateList('structure','list-tmpl-structure'); renderTemplateList('language','list-tmpl-language'); renderList('markers','list-markers'); renderList('starters','list-starters'); renderList('points','list-points'); renderList('methods','list-methods'); renderList('links','list-links'); renderItems(); initAdminConfig(); 
        if(appData.worksheetOptions) {
            document.getElementById('ws-lvl1').checked = appData.worksheetOptions.lvl1;
            document.getElementById('ws-lvl2').checked = appData.worksheetOptions.lvl2;
            document.getElementById('ws-lvl3').checked = appData.worksheetOptions.lvl3;
        }
    }
    function closeAdmin() { document.getElementById('admin-modal').style.display='none'; }
    function renderTemplateList(type, divId) {
        const div = document.getElementById(divId); div.innerHTML = '';
        if(!appData.analysisTemplates[type]) appData.analysisTemplates[type] = [];
        appData.analysisTemplates[type].forEach((t, i) => { const row = document.createElement('div'); row.className = 'list-item'; row.innerHTML = `<input class="list-input" value="${t}" onchange="updateTemplateItem('${type}',${i},this.value)"><button class="btn btn-danger" onclick="deleteTemplateItem('${type}',${i})">X</button>`; div.appendChild(row); });
    }
    function addTemplate(type) { if(!appData.analysisTemplates[type]) appData.analysisTemplates[type] = []; appData.analysisTemplates[type].push("New {word} template"); renderTemplateList(type, 'list-tmpl-'+type); saveLocal(); }
    function updateTemplateItem(type, i, val) { appData.analysisTemplates[type][i] = val; saveLocal(); }
    function deleteTemplateItem(type, i) { appData.analysisTemplates[type].splice(i,1); renderTemplateList(type, 'list-tmpl-'+type); saveLocal(); }
    function renderList(key, divId) { const div = document.getElementById(divId); div.innerHTML = ''; if(!appData[key]) appData[key] = []; appData[key].forEach((item, i) => { const row = document.createElement('div'); row.className = 'list-item'; row.innerHTML = `<input class="list-input" value="${item.replace(/"/g,'&quot;')}" onchange="updateListItem('${key}',${i},this.value)"><button class="btn btn-danger" onclick="deleteListItem('${key}',${i})">X</button>`; div.appendChild(row); }); }
    function updateListItem(key, i, val) { appData[key][i] = val; saveLocal(); updateUI(); }
    function deleteListItem(key, i) { appData[key].splice(i,1); renderList(key, 'list-'+key); saveLocal(); updateUI(); }
    function addItem(key) { appData[key].push("New Item"); renderList(key, 'list-'+key); saveLocal(); }
    function uploadJSON(input) {
        const fr = new FileReader();
        fr.onload = (e) => {
            try {
                const json = JSON.parse(e.target.result);
                if(!json.analysisTemplates) json.analysisTemplates = defaultData.analysisTemplates;
                ['tone', 'structure', 'language'].forEach(k => { if (json.analysisTemplates[k] && typeof json.analysisTemplates[k] === 'string') { json.analysisTemplates[k] = [json.analysisTemplates[k]]; } });
                appData = json; saveLocal(); openAdmin(); updateUI(); alert("File loaded!");
            } catch(err) { alert("Error: " + err.message); }
        };
        fr.readAsText(input.files[0]); input.value=''; 
    }
    function initAdminConfig() { const opts = ['marker', 'starter', 'point', 'method', 'quote', 'analysis', 'link', 'none']; for(let i=0; i<6; i++) { const sel = document.getElementById(`cfg-slot${i+1}`); if(!sel) continue; sel.innerHTML = ''; opts.forEach(o => sel.add(new Option(o, o))); sel.value = appData.sentenceOrder[i] || 'none'; } }
    function saveStructureConfig() { const newOrder = []; for(let i=0; i<6; i++) { newOrder.push(document.getElementById(`cfg-slot${i+1}`).value); } appData.sentenceOrder = newOrder; saveLocal(); updateUI(); }
    function resetSentenceOrder() { if(confirm("Revert sentence order to default?")) { appData.sentenceOrder = ['starter', 'quote', 'method', 'point', 'analysis', 'link']; saveLocal(); updateUI(); openAdmin(); } }
    function saveWSOptions() {
        appData.worksheetOptions = {
            lvl1: document.getElementById('ws-lvl1').checked,
            lvl2: document.getElementById('ws-lvl2').checked,
            lvl3: document.getElementById('ws-lvl3').checked
        };
        saveLocal();
    }
    function downloadJSON() {
        const blob = new Blob([JSON.stringify(appData)], {type: "text/json;charset=utf-8"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'architect_data.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        alert("Settings Saved to File!");
    }
    
    // --- SMART EDITOR WITH LENS TOGGLE ---
    function renderItems() {
        const con = document.getElementById('items-container'); con.innerHTML = '';
        if(!appData.items) return;
        appData.items.forEach((item, i) => {
            const div = document.createElement('div'); div.className = 'editor-section';
            const defaultLens = item.type === 'structure' ? 'structure' : 'tone';
            div.innerHTML = `
                <div style="display:flex;justify-content:space-between;"><strong>#${i+1} (${item.type})</strong> <div><button class="btn btn-edit-analysis" onclick="toggleDetails(${i})"><i class="fas fa-edit"></i> Edit Analysis</button> <button class="btn btn-danger" onclick="delItem(${i})"><i class="fas fa-trash"></i></button></div></div>
                <input class="admin-input" value="${item.custom_q||''}" placeholder="Question" onchange="updateItem(${i},'custom_q',this.value)">
                <input class="admin-input" value="${item.original}" placeholder="Quote" onchange="updateItem(${i},'original',this.value)">
                <div id="details-${i}" class="analysis-details">
                    <label><strong>Editing Focus:</strong></label>
                    <select class="admin-input" onchange="updateLensVisibility(${i}, this.value)">
                        <option value="tone" ${defaultLens==='tone'?'selected':''}>Tone</option>
                        <option value="structure" ${defaultLens==='structure'?'selected':''}>Structure</option>
                        <option value="language">Language</option>
                    </select>
                    <div id="lens-tone-${i}" class="lens-group ${defaultLens==='tone'?'active':''}"><h4>Tone Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="${item.level1?.tone?.correct||''}" onchange="updateDeep(${i},'level1','tone','correct',this.value)"> Opts: <input class="admin-input" value="${item.level1?.tone?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level1','tone',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="${item.level2?.tone?.correct||''}" onchange="updateDeep(${i},'level2','tone','correct',this.value)"> Opts: <input class="admin-input" value="${item.level2?.tone?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level2','tone',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="${item.level3?.tone?.correct||''}" onchange="updateDeep(${i},'level3','tone','correct',this.value)"> Opts: <input class="admin-input" value="${item.level3?.tone?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level3','tone',this.value)"></div></div>
                    <div id="lens-structure-${i}" class="lens-group ${defaultLens==='structure'?'active':''}"><h4>Structure Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="${item.level1?.structure?.correct||''}" onchange="updateDeep(${i},'level1','structure','correct',this.value)"> Opts: <input class="admin-input" value="${item.level1?.structure?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level1','structure',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="${item.level2?.structure?.correct||''}" onchange="updateDeep(${i},'level2','structure','correct',this.value)"> Opts: <input class="admin-input" value="${item.level2?.structure?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level2','structure',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="${item.level3?.structure?.correct||''}" onchange="updateDeep(${i},'level3','structure','correct',this.value)"> Opts: <input class="admin-input" value="${item.level3?.structure?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level3','structure',this.value)"></div></div>
                    <div id="lens-language-${i}" class="lens-group"><h4>Language Analysis</h4><div class="level-block">L1 Correct: <input class="admin-input" value="${item.level1?.language?.correct||''}" onchange="updateDeep(${i},'level1','language','correct',this.value)"> Opts: <input class="admin-input" value="${item.level1?.language?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level1','language',this.value)"></div><div class="level-block">L2 Correct: <input class="admin-input" value="${item.level2?.language?.correct||''}" onchange="updateDeep(${i},'level2','language','correct',this.value)"> Opts: <input class="admin-input" value="${item.level2?.language?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level2','language',this.value)"></div><div class="level-block">L3 Correct: <input class="admin-input" value="${item.level3?.language?.correct||''}" onchange="updateDeep(${i},'level3','language','correct',this.value)"> Opts: <input class="admin-input" value="${item.level3?.language?.options?.join(',')||''}" onchange="updateDeepOpts(${i},'level3','language',this.value)"></div></div>
                </div>
            `;
            con.appendChild(div);
        });
    }
    
    function updateLensVisibility(i, lens) {
        document.getElementById(`lens-tone-${i}`).classList.remove('active');
        document.getElementById(`lens-structure-${i}`).classList.remove('active');
        document.getElementById(`lens-language-${i}`).classList.remove('active');
        document.getElementById(`lens-${lens}-${i}`).classList.add('active');
    }

    function toggleDetails(i) { const el = document.getElementById('details-'+i); el.style.display = el.style.display==='block'?'none':'block'; }
    function updateItem(i, k, v) { appData.items[i][k] = v; saveLocal(); }
    function updateDeep(i, lvl, type, key, val) { if(!appData.items[i][lvl]) appData.items[i][lvl]={}; if(!appData.items[i][lvl][type]) appData.items[i][lvl][type]={}; appData.items[i][lvl][type][key]=val; saveLocal(); }
    function updateDeepOpts(i, lvl, type, val) { if(!appData.items[i][lvl]) appData.items[i][lvl]={}; if(!appData.items[i][lvl][type]) appData.items[i][lvl][type]={}; appData.items[i][lvl][type].options=val.split(',').map(s=>s.trim()); saveLocal(); }
    function delItem(i) { appData.items.splice(i,1); renderItems(); loadStageSelect(); }
    function addNewItem() { appData.items.push({type:"quote", original:"New", translation:"", level1:{tone:{correct:"", options:[]}} }); renderItems(); }

    function openWizard() { document.getElementById('wizard-overlay').style.display='flex'; }
    function closeWizard() { document.getElementById('wizard-overlay').style.display='none'; }
    function genPrompt() { /* Same as v45 */ }
    function loadWizardData() { /* Same as v45 */ }
    
    init();
</script>
</body>
</html>
