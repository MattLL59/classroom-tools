<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tone & Structure Architect v19</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        /* --- CSS VARIABLES --- */
        :root {
            --primary: #009688; 
            --accent: #ff9800; 
            --bg: #f0f2f5;
            --card: #ffffff;
            --text: #37474f;
            --tone-col: #9c27b0;
            --struct-col: #2196f3;
            --lang-col: #4caf50;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background-color: var(--bg); color: var(--text); margin: 0; padding: 20px; 
            height: 100vh; display: flex; flex-direction: column; overflow: hidden; text-align: center;
        }

        /* --- HEADER --- */
        header { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 15px; background: white; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            flex-shrink: 0; margin-bottom: 20px;
        }
        h1 { margin: 0; color: var(--primary); font-size: 1.4rem; display:flex; align-items:center; gap:10px; }
        
        .admin-btn { 
            font-size: 1.2rem; color: #555; background: #eee; border: none; 
            border-radius: 5px; padding: 8px 12px; cursor: pointer; transition: all 0.2s;
        }
        .admin-btn:hover { background: #ddd; }

        /* --- CONTAINER --- */
        .container { 
            flex-grow: 1; max-width: 1100px; width: 100%; margin: 0 auto; 
            display: flex; flex-direction: column; gap: 15px; overflow-y: auto; padding-right: 5px; 
        }

        /* --- STAGE AREAS --- */
        .stage { display: none; animation: fadeIn 0.3s; }
        .stage.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .instruction { color: #78909c; margin-bottom: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; font-size: 0.9rem; }
        .dynamic-question { font-size: 1.4rem; color: var(--primary); font-weight: bold; margin-bottom: 20px; }

        /* --- GRIDS --- */
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 15px; }
        
        .card { 
            background: var(--card); padding: 20px; border-radius: 8px; border: 1px solid #ddd;
            cursor: pointer; transition: transform 0.1s, box-shadow 0.1s;
            display: flex; flex-direction: column; justify-content: center; min-height: 80px;
        }
        .card:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); border-color: var(--primary); }
        .card-struct { border-left: 5px solid var(--struct-col) !important; background: #f4faff !important; text-align: left; align-items: flex-start !important; }
        .card-lang { border-left: 5px solid var(--lang-col) !important; }
        .card-tone { border-left: 5px solid var(--tone-col) !important; }

        /* --- BUILDER PANEL --- */
        .builder-panel {
            background: white; border-radius: 10px; padding: 20px; border-top: 4px solid var(--primary);
            box-shadow: 0 -4px 20px rgba(0,0,0,0.05); flex-shrink: 0;
        }
        
        .controls { 
            display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; flex-wrap: wrap; 
            padding-bottom: 15px; border-bottom: 1px dashed #eee;
        }
        
        .bank-group { display: flex; flex-direction: column; gap: 5px; align-items: flex-start; }
        .bank-label { font-size: 0.7rem; color: #999; font-weight: bold; text-transform: uppercase; }
        
        select.bank-select { 
            padding: 8px 12px; border: 1px solid #ccc; border-radius: 5px; 
            background: #f9f9f9; font-weight: 500; cursor: pointer; min-width: 140px; max-width: 200px;
        }
        select.bank-select:hover { border-color: var(--primary); background: white; }

        #sentence-stage { width: 98%; padding: 10px; border: 2px dashed #ccc; border-radius: 5px; font-size: 1.1rem; margin-bottom: 10px; }
        #essay-area { width: 98%; height: 150px; padding: 15px; border: 1px solid #ccc; border-radius: 5px; font-family: 'Segoe UI'; font-size: 1rem; resize: vertical; display: none; }

        /* --- BUTTONS --- */
        .btn { padding: 8px 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; }
        .btn:hover { opacity: 0.9; }
        .btn-primary { background: var(--primary); }
        .btn-accent { background: var(--accent); }
        .btn-doc { background: #2b5797; }
        .btn-danger { background: #e74c3c; padding: 4px 8px; font-size: 0.8rem; margin-left: 5px; }
        .btn-add { background: #2ecc71; width: 100%; margin-top: 5px; }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; width: 95%; max-width: 900px; max-height: 90vh; border-radius: 8px; overflow: hidden; display: flex; flex-direction: column; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-header { padding: 15px; background: #eee; display: flex; justify-content: space-between; align-items: center; font-weight: bold; }
        .modal-body { padding: 20px; overflow-y: auto; text-align: left; }

        .list-container { margin-bottom: 15px; }
        .list-item { display: flex; align-items: center; margin-bottom: 5px; }
        .list-input { flex-grow: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        
        .editor-section { border: 1px solid #ddd; padding: 15px; margin-bottom: 15px; border-radius: 5px; background: #f9f9f9; }
        .admin-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; margin-bottom: 5px; }
        
        #wizard-overlay { flex-direction:column; padding:20px; box-sizing:border-box; background: white; }
        
        #overlay-msg { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(44, 62, 80, 0.95); z-index: 3000; color: white; flex-direction: column; justify-content: center; align-items: center; }
    </style>
</head>
<body>

    <header>
        <h1><i class="fas fa-cubes"></i> Tone & Structure v19</h1>
        <div>
            <select id="level-select" onchange="changeLevel()" style="padding:5px; border-radius:5px; border:1px solid #ccc;">
                <option value="1">Level 1: Foundation</option>
                <option value="2">Level 2: Intermediate</option>
                <option value="3">Level 3: Advanced</option>
            </select>
            <button class="admin-btn" onclick="openAdmin()"><i class="fas fa-cog"></i> Settings</button>
        </div>
    </header>

    <div class="container">
        
        <div style="display:flex; justify-content:space-between; color:#607d8b; font-size:0.9rem;">
            <span><strong>Text:</strong> <span id="text-display">Loading...</span></span>
            <span><strong>Q:</strong> <span id="q-display">...</span></span>
        </div>

        <div id="stage-select" class="stage active">
            <div class="instruction">Step 1: Evidence</div>
            <div id="dynamic-question-display" class="dynamic-question">Select Evidence to Analyze</div>
            <div class="grid" id="grid-main"></div>
        </div>

        <div id="stage-decoder" class="stage">
            <div class="instruction">Step 2: Translation Bridge</div>
            <div style="background:#e0f2f1; padding:20px; border-radius:8px; margin-bottom:20px; font-size:1.2rem;">
                "<span id="decoder-quote"></span>"
            </div>
            <div class="grid" id="grid-decoder"></div>
        </div>

        <div id="stage-lens" class="stage">
            <div class="instruction">Step 3: Select Lens</div>
            <div class="grid">
                <div class="card card-tone" onclick="loadAnalysis('tone')"><strong>üé≠ Tone</strong></div>
                <div class="card card-struct" onclick="loadAnalysis('structure')"><strong>üèóÔ∏è Structure</strong></div>
                <div class="card card-lang" onclick="loadAnalysis('language')"><strong>üìñ Language</strong></div>
            </div>
        </div>

        <div id="stage-analysis" class="stage">
            <div class="instruction" id="analysis-prompt">...</div>
            <div class="grid" id="grid-analysis"></div>
        </div>

    </div>

    <div class="builder-panel">
        <div class="instruction" style="text-align:center;">Sentence Construction Zone</div>
        
        <div class="controls" id="dynamic-builder-controls">
            </div>

        <input type="text" id="sentence-stage" placeholder="Build sentence here...">
        <textarea id="essay-area" placeholder="Full essay..."></textarea>
        
        <div id="essay-controls" style="display:none; margin-top:10px; justify-content:flex-end; gap:10px;">
            <button class="btn btn-doc" onclick="downloadDoc()">Download .doc</button>
            <button class="btn btn-accent" onclick="clearEssay()">Clear</button>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">Teacher Settings <button onclick="closeAdmin()" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">&times;</button></div>
            <div class="modal-body">
                
                <div style="background:#e0f7fa; padding:15px; border-radius:5px; margin-bottom:20px; text-align:center;">
                    <button class="btn btn-primary" onclick="openWizard()">‚ú® Open AI Wizard</button>
                </div>

                <div class="editor-section">
                    <h3>Basic Info</h3>
                    <label>Text Title:</label><input id="edit-title" class="admin-input" onchange="updateGlobal('textTitle', this.value)">
                    <label>Question:</label><input id="edit-question" class="admin-input" onchange="updateGlobal('question', this.value)">
                </div>

                <div class="editor-section" style="border-left: 5px solid var(--accent);">
                    <h3>‚öôÔ∏è Sentence Structure Config</h3>
                    <p style="font-size:0.9rem;">Decide the order of elements for the student.</p>
                    <div style="display:flex; gap:5px; margin-bottom:10px;">
                        <select class="admin-input" id="cfg-slot1" onchange="saveStructureConfig()"></select>
                        <select class="admin-input" id="cfg-slot2" onchange="saveStructureConfig()"></select>
                        <select class="admin-input" id="cfg-slot3" onchange="saveStructureConfig()"></select>
                        <select class="admin-input" id="cfg-slot4" onchange="saveStructureConfig()"></select>
                        <select class="admin-input" id="cfg-slot5" onchange="saveStructureConfig()"></select>
                    </div>
                </div>

                <div class="editor-section">
                    <h3>üè¶ Scaffolding Banks</h3>
                    <label><strong>1. Discourse Markers</strong></label>
                    <div id="list-markers" class="list-container"></div>
                    <button class="btn btn-add" onclick="addItem('markers')">+ Add Marker</button>
                    
                    <label style="margin-top:15px; display:block;"><strong>2. Sentence Starters</strong></label>
                    <div id="list-starters" class="list-container"></div>
                    <button class="btn btn-add" onclick="addItem('starters')">+ Add Starter</button>

                    <label style="margin-top:15px; display:block;"><strong>3. Methods</strong></label>
                    <div id="list-methods" class="list-container"></div>
                    <button class="btn btn-add" onclick="addItem('methods')">+ Add Method</button>

                    <label style="margin-top:15px; display:block;"><strong>4. Links</strong></label>
                    <div id="list-links" class="list-container"></div>
                    <button class="btn btn-add" onclick="addItem('links')">+ Add Link</button>
                </div>

                <div class="editor-section">
                    <h3>Analysis Points</h3>
                    <div id="items-container"></div>
                    <button class="btn btn-add" onclick="addNewItem()">+ Add New Analysis Point</button>
                </div>
                
                <div style="margin-top:20px; padding:15px; background:#e3f2fd; border-radius:5px;">
                    <button class="btn btn-doc" onclick="downloadJSON()">üíæ Save to File</button>
                    <button class="btn btn-doc" onclick="document.getElementById('file-up').click()">üìÇ Load File</button>
                    <input type="file" id="file-up" style="display:none;" onchange="uploadJSON(this)">
                </div>
            </div>
        </div>
    </div>

    <div id="wizard-overlay" class="modal">
        <div class="modal-content" style="max-width:800px;">
            <div class="modal-header">AI Wizard <button onclick="closeWizard()" style="border:none;background:none;font-size:1.5rem;">&times;</button></div>
            <div class="modal-body">
                <p>1. Paste Text & Question.</p>
                <textarea id="wiz-text" class="admin-input" style="height:100px;" placeholder="Paste Text..."></textarea>
                <input id="wiz-q" class="admin-input" style="margin-top:10px;" placeholder="Question...">
                
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <div style="flex:1">
                        <label>Quotes to Find:</label>
                        <input id="wiz-quote-count" type="number" class="admin-input" value="3" min="0">
                    </div>
                    <div style="flex:1">
                        <label>Structure Points:</label>
                        <input id="wiz-struct-count" type="number" class="admin-input" value="2" min="0">
                    </div>
                    <div style="flex:1">
                        <label>Distractors per Item:</label>
                        <input id="wiz-dist-count" type="number" class="admin-input" value="2" min="1" max="4">
                    </div>
                </div>

                <p>2. Generate Prompt & Copy to ChatGPT.</p>
                <button class="btn btn-primary" onclick="genPrompt()">Generate Prompt</button>
                <textarea id="wiz-prompt" class="admin-input" style="height:80px; margin-top:5px; background:#f9f9f9;" readonly></textarea>
                
                <p>3. Paste ChatGPT Result.</p>
                <textarea id="wiz-json" class="admin-input" style="height:100px;" placeholder="Paste JSON here..."></textarea>
                
                <div style="margin-top:15px; display:flex; justify-content:space-between; align-items:center;">
                    <div><input type="checkbox" id="wiz-append"> <label for="wiz-append">Append to existing</label></div>
                    <button class="btn btn-accent" onclick="loadWizardData()">üöÄ Load Lesson</button>
                </div>
            </div>
        </div>
    </div>

    <div id="overlay-msg" onclick="this.style.display='none'">
        <i id="overlay-icon" class="fas fa-check-circle" style="font-size:4rem; margin-bottom:20px;"></i>
        <h2 id="overlay-text">Correct!</h2>
    </div>

<script>
    // --- DATA ---
    const defaultData = {
        textTitle: "The Electric Telegraph",
        question: "How is impact conveyed?",
        // Configurable Sentence Order
        sentenceOrder: ['marker', 'starter', 'method', 'quote', 'link'], 
        markers: ["However,", "Furthermore,", "In contrast,", "Significantly,"],
        starters: ["The writer implies", "This suggests", "It is evident that"],
        methods: ["metaphor", "simile", "juxtaposition", "imagery", "imperative"],
        links: ["This reinforces the idea that", "linking back to", "creating a sense of"],
        items: [
            {
                id: "q1", type: "quote", original: "wondrous invention", translation: "amazing machine", 
                distractors: ["boring machine", "confusing tool"],
                custom_q: "Which phrase suggests amazement?",
                level1: { tone: { prompt:"Tone?", correct:"Excited", options:["Excited","Bored"] } },
                level2: { tone: { prompt:"Tone?", correct:"Awe", options:["Awe","Fear"] } },
                level3: { tone: { prompt:"Tone?", correct:"Sublime", options:["Sublime","Mocking"] } }
            }
        ]
    };

    let appData = JSON.parse(JSON.stringify(defaultData));
    let state = { level: 1, currentIdx: 0, buffer: {} };

    // --- INIT ---
    function init() {
        const local = localStorage.getItem('tsa_v19');
        if(local) try { appData = JSON.parse(local); } catch(e){}
        // Ensure defaults exist
        ['markers','starters','methods','links','sentenceOrder'].forEach(k => { 
            if(!appData[k]) appData[k] = defaultData[k]; 
        });
        updateUI();
        loadStageSelect();
        initAdminConfig();
    }

    function updateUI() {
        document.getElementById('text-display').innerText = appData.textTitle;
        document.getElementById('q-display').innerText = appData.question;
        renderBuilderUI();
    }

    function renderBuilderUI() {
        const container = document.getElementById('dynamic-builder-controls');
        container.innerHTML = '';
        
        // Loop through configured order
        appData.sentenceOrder.forEach((type, index) => {
            if(type === 'none') return; // Skip
            
            const group = document.createElement('div');
            group.className = 'bank-group';
            
            let labelText = type.charAt(0).toUpperCase() + type.slice(1);
            if(type === 'quote') labelText = "Analysis (From Card)";
            
            const label = document.createElement('span');
            label.className = 'bank-label';
            label.innerText = `${index+1}. ${labelText}`;
            group.appendChild(label);

            if(type === 'quote') {
                // Placeholder for where analysis goes
                const placeholder = document.createElement('div');
                placeholder.style.padding = '8px';
                placeholder.style.background = '#e3f2fd';
                placeholder.style.borderRadius = '5px';
                placeholder.style.fontSize = '0.8rem';
                placeholder.innerText = "(Added via Game)";
                group.appendChild(placeholder);
            } else {
                const select = document.createElement('select');
                select.className = 'bank-select';
                select.id = `sel-${type}`;
                select.onchange = () => insertScaffold(type);
                select.innerHTML = `<option value="">‚ûï ${labelText}</option>`;
                
                // Populate options
                let key = type + 's'; // e.g. marker -> markers
                if(appData[key]) {
                    appData[key].forEach(opt => select.add(new Option(opt, opt)));
                }
                group.appendChild(select);
            }
            container.appendChild(group);
        });
        
        // Add Button
        const btn = document.createElement('button');
        btn.className = 'btn btn-primary';
        btn.onclick = commitSentence;
        btn.style.alignSelf = 'flex-end';
        btn.innerHTML = '‚¨áÔ∏è Add';
        container.appendChild(btn);
    }

    function insertScaffold(type) {
        const el = document.getElementById(`sel-${type}`);
        if(el.value) {
            addToBuilder(el.value);
            el.value = "";
        }
    }

    function changeLevel() {
        state.level = parseInt(document.getElementById('level-select').value);
        loadStageSelect();
    }

    // --- GAME LOGIC ---
    function loadStageSelect() {
        document.querySelectorAll('.stage').forEach(e=>e.classList.remove('active'));
        document.getElementById('stage-select').classList.add('active');
        const grid = document.getElementById('grid-main');
        grid.innerHTML = '';
        
        appData.items.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = item.type === 'structure' ? 'card card-struct' : 'card card-lang';
            const label = item.custom_q ? item.custom_q : (item.type==='structure' ? item.label : '"'+item.original+'"');
            div.innerHTML = `<strong>${item.type==='structure'?'üèóÔ∏è':'üî§'}</strong><br><small>${label}</small>`;
            div.onclick = () => { 
                state.currentIdx = i; 
                document.getElementById('dynamic-question-display').innerText = item.custom_q || "Analyzing Evidence";
                item.type==='structure'?loadAnalysis('structure'):loadDecoder(); 
            };
            grid.appendChild(div);
        });
    }

    function loadDecoder() {
        document.getElementById('stage-select').classList.remove('active');
        document.getElementById('stage-decoder').classList.add('active');
        const item = appData.items[state.currentIdx];
        document.getElementById('decoder-quote').innerText = item.original;
        const grid = document.getElementById('grid-decoder');
        grid.innerHTML = '';
        
        let opts = [{txt: item.translation, correct:true}];
        if(item.distractors) item.distractors.forEach(d => opts.push({txt: d, correct:false}));
        else if(item.distractor) opts.push({txt: item.distractor, correct:false});
        
        opts.sort(()=>Math.random()-0.5).forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'card';
            btn.innerText = opt.txt;
            btn.onclick = () => {
                if(opt.correct) {
                    addToBuilder(`"${item.original}"`); // Add quote to builder
                    document.getElementById('stage-decoder').classList.remove('active');
                    document.getElementById('stage-lens').classList.add('active');
                } else alert("Try again.");
            };
            grid.appendChild(btn);
        });
    }

    function loadAnalysis(lens) {
        const item = appData.items[state.currentIdx];
        const lvlKey = 'level'+state.level;
        if(!item[lvlKey] || !item[lvlKey][lens]) { alert("No data for this level."); return; }
        
        document.getElementById('stage-lens').classList.remove('active');
        document.getElementById('stage-analysis').classList.add('active');
        const data = item[lvlKey][lens];
        document.getElementById('analysis-prompt').innerText = data.prompt;
        
        const grid = document.getElementById('grid-analysis');
        grid.innerHTML = '';
        
        let opts = data.options.map(o => ({txt:o, correct: o===data.correct}));
        opts.sort(()=>Math.random()-0.5).forEach(opt => {
            const btn = document.createElement('div');
            btn.className = 'card ' + (lens==='tone'?'card-tone':lens==='structure'?'card-struct':'card-lang');
            btn.innerText = opt.txt;
            btn.onclick = () => {
                if(opt.correct) {
                    let text = lens==='structure' ? `Structurally, ${opt.txt.toLowerCase()}` : opt.txt;
                    addToBuilder(text);
                    loadStageSelect();
                } else alert("Try again.");
            };
            grid.appendChild(btn);
        });
    }

    // --- BUILDER ---
    function addToBuilder(txt) {
        const f = document.getElementById('sentence-stage');
        f.value = f.value + (f.value && !f.value.endsWith(' ') ? " " : "") + txt;
    }
    function commitSentence() {
        const val = document.getElementById('sentence-stage').value;
        if(!val) return;
        const area = document.getElementById('essay-area');
        area.style.display='block';
        document.getElementById('essay-controls').style.display='flex';
        area.value += (area.value ? "\n\n" : "") + val;
        document.getElementById('sentence-stage').value = "";
    }
    function clearEssay() { if(confirm("Clear essay?")) { document.getElementById('essay-area').value=""; } }
    function downloadDoc() {
        const blob = new Blob(['<html><body>'+document.getElementById('essay-area').value.replace(/\n/g,'<br>')+'</body></html>'], {type:'application/msword'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'essay.doc'; a.click();
    }

    // --- ADMIN ---
    function openAdmin() {
        document.getElementById('modal-admin').style.display='flex';
        document.getElementById('edit-title').value = appData.textTitle;
        document.getElementById('edit-question').value = appData.question;
        renderList('markers', 'list-markers');
        renderList('starters', 'list-starters');
        renderList('methods', 'list-methods');
        renderList('links', 'list-links');
        renderItems();
        initAdminConfig();
    }
    function closeAdmin() { document.getElementById('modal-admin').style.display='none'; }
    function updateGlobal(k, v) { appData[k]=v; saveLocal(); updateUI(); }
    
    // LIST MANAGER
    function renderList(key, divId) {
        const div = document.getElementById(divId);
        div.innerHTML = '';
        appData[key].forEach((item, i) => {
            const row = document.createElement('div');
            row.className = 'list-item';
            row.innerHTML = `<input class="list-input" value="${item.replace(/"/g,'&quot;')}" onchange="updateListItem('${key}',${i},this.value)">
                             <button class="btn btn-danger" onclick="deleteListItem('${key}',${i})">X</button>`;
            div.appendChild(row);
        });
    }
    function updateListItem(key, i, val) { appData[key][i] = val; saveLocal(); updateUI(); }
    function deleteListItem(key, i) { appData[key].splice(i,1); renderList(key, 'list-'+key); saveLocal(); updateUI(); }
    function addItem(key) { appData[key].push("New Item"); renderList(key, 'list-'+key); }

    // STRUCTURE CONFIG
    function initAdminConfig() {
        const opts = ['marker', 'starter', 'method', 'quote', 'link', 'none'];
        for(let i=0; i<5; i++) {
            const sel = document.getElementById(`cfg-slot${i+1}`);
            if(!sel) continue;
            sel.innerHTML = '';
            opts.forEach(o => sel.add(new Option(o, o)));
            sel.value = appData.sentenceOrder[i] || 'none';
        }
    }
    function saveStructureConfig() {
        const newOrder = [];
        for(let i=0; i<5; i++) {
            newOrder.push(document.getElementById(`cfg-slot${i+1}`).value);
        }
        appData.sentenceOrder = newOrder;
        saveLocal();
        updateUI();
    }

    // ITEM EDITOR
    function renderItems() {
        const con = document.getElementById('items-container');
        con.innerHTML = '';
        appData.items.forEach((item, i) => {
            const div = document.createElement('div');
            div.className = 'editor-section';
            
            // Distractor List
            let distHTML = `<div style="margin-top:5px; border-top:1px dashed #ccc; padding-top:5px;"><label>Distractors:</label>`;
            const dists = item.distractors || (item.distractor ? [item.distractor] : []);
            dists.forEach((d, di) => {
                distHTML += `<div class="list-item"><input class="list-input" value="${d.replace(/"/g,'&quot;')}" onchange="updateDist(${i},${di},this.value)"><button class="btn btn-danger" onclick="delDist(${i},${di})">X</button></div>`;
            });
            distHTML += `<button class="btn" style="font-size:0.8rem; background:#ccc;" onclick="addDist(${i})">+ Add Distractor</button></div>`;

            div.innerHTML = `
                <div style="display:flex; justify-content:space-between;"><strong>#${i+1} (${item.type})</strong> <button class="btn btn-danger" onclick="delItem(${i})">Delete</button></div>
                <input class="admin-input" value="${item.custom_q||''}" placeholder="Custom Question (Optional)" onchange="updateItem(${i},'custom_q',this.value)">
                <input class="admin-input" value="${item.original}" placeholder="Quote" onchange="updateItem(${i},'original',this.value)">
                <input class="admin-input" value="${item.translation||item.detail}" placeholder="Translation" onchange="updateItem(${i},'translation',this.value)">
                ${distHTML}
            `;
            con.appendChild(div);
        });
    }
    
    function updateItem(i, k, v) { appData.items[i][k] = v; saveLocal(); }
    function delItem(i) { appData.items.splice(i,1); renderItems(); loadStageSelect(); }
    function addNewItem() { appData.items.push({type:"quote", original:"New", translation:"", distractors:["Wrong"], level1:{tone:{correct:"", options:[]}}, level2:{tone:{correct:"", options:[]}}, level3:{tone:{correct:"", options:[]}} }); renderItems(); }
    function updateDist(i, di, v) { 
        if(!appData.items[i].distractors) appData.items[i].distractors = [];
        appData.items[i].distractors[di] = v; saveLocal(); 
    }
    function delDist(i, di) { appData.items[i].distractors.splice(di,1); renderItems(); saveLocal(); }
    function addDist(i) { 
        if(!appData.items[i].distractors) appData.items[i].distractors = [];
        appData.items[i].distractors.push("New Distractor"); renderItems(); saveLocal();
    }

    // --- WIZARD ---
    function openWizard() { document.getElementById('modal-wizard').style.display='flex'; }
    function closeWizard() { document.getElementById('modal-wizard').style.display='none'; }
    
    function genPrompt() {
        const txt = document.getElementById('wiz-text').value;
        const q = document.getElementById('wiz-q').value;
        const qCount = document.getElementById('wiz-quote-count').value;
        const sCount = document.getElementById('wiz-struct-count').value;
        const distCount = document.getElementById('wiz-dist-count').value;
        
        const prompt = `Act as a JSON generator for a GCSE English App.
Text: "${txt.substring(0,250)}..."
Question: "${q}"

Create ${qCount} Quotes (Micro-Analysis).
Create ${sCount} Structure Points (Macro-Analysis).
For each item, provide ${distCount} PLAUSIBLE DISTRACTORS.
IMPORTANT: Generate analysis for ALL 3 LEVELS (1, 2, 3) in the same object.

Structure:
{
  "textTitle": "Title",
  "question": "${q}",
  "items": [
    {
      "id": "q1", "type": "quote", "original": "...", "translation": "...", 
      "distractors": ["Wrong 1", "Wrong 2"],
      "level1": { "tone": {"prompt":"Q","correct":"A","options":["A","B"]}, "structure": {..}, "language": {..} },
      "level2": { "tone": {"prompt":"Q","correct":"A","options":["A","B"]}, "structure": {..}, "language": {..} },
      "level3": { "tone": {"prompt":"Q","correct":"A","options":["A","B"]}, "structure": {..}, "language": {..} }
    }
  ]
}`;
        document.getElementById('wiz-prompt').value = prompt;
        document.getElementById('wiz-prompt').select();
        document.execCommand('copy');
    }

    function loadWizardData() {
        const raw = document.getElementById('wiz-json').value;
        const clean = raw.replace(/```json/g, '').replace(/```/g, '').trim();
        const first = clean.indexOf('{');
        const last = clean.lastIndexOf('}');
        try {
            const json = JSON.parse(clean.substring(first, last+1));
            if(json.items) {
                if(document.getElementById('wiz-append').checked) {
                    appData.items = appData.items.concat(json.items);
                } else {
                    appData.items = json.items;
                    appData.textTitle = json.textTitle || appData.textTitle;
                    appData.question = json.question || appData.question;
                }
                saveLocal();
                updateUI();
                closeWizard();
                openAdmin();
            }
        } catch(e) { alert("Invalid JSON: " + e.message); }
    }

    function saveLocal() { localStorage.setItem('tsa_v19', JSON.stringify(appData)); }
    function downloadJSON() {
        const a = document.createElement('a');
        a.href = 'data:text/json;charset=utf-8,' + encodeURIComponent(JSON.stringify(appData));
        a.download = 'architect_data.json';
        a.click();
    }
    function uploadJSON(input) {
        const fr = new FileReader();
        fr.onload = (e) => {
            appData = JSON.parse(e.target.result);
            saveLocal();
            openAdmin();
            updateUI();
        };
        fr.readAsText(input.files[0]);
    }

    init();
</script>
</body>
</html>
