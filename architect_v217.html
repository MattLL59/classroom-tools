<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tone & Structure Architect v217 (Full Suite)</title>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #00897b; /* Teal */
            --accent: #f57c00;  /* Orange */
            --bg: #f4f7f6;
            --card: #ffffff;
            --text: #263238;
            --nav-bg: #ffffff;
            --border: #cfd8dc;
            --success: #43a047;
            --error: #e53935;
            --tone: #8e24aa;
            --struct: #1e88e5;
            --lang: #43a047;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */
        header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: var(--card); box-shadow: 0 2px 8px rgba(0,0,0,0.08); z-index: 100; flex-shrink: 0; }
        h1 { margin: 0; font-size: 1.15rem; color: var(--primary); display: flex; align-items: center; gap: 8px; font-weight: 700; }
        .score-pill { background: var(--accent); color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; box-shadow: 0 2px 4px rgba(245, 124, 0, 0.3); }
        
        .header-controls { display: flex; gap: 8px; align-items: center; }
        .icon-btn { background: none; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; padding: 6px 10px; font-size: 1.1rem; transition: all 0.2s; }
        .icon-btn:hover { background: #eceff1; transform: translateY(-1px); }
        select.level-select { padding: 6px; border-radius: 6px; border: 1px solid var(--border); font-weight: bold; color: var(--text); background: #fff; }

        /* --- MAIN LAYOUT --- */
        .viewport { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; scroll-behavior: smooth; }
        
        /* --- BOTTOM NAV --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--nav-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); z-index: 900; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #90a4ae; border: none; background: none; cursor: pointer; height: 100%; gap: 4px; transition: all 0.2s; }
        .nav-item.active { color: var(--primary); background: rgba(0, 137, 123, 0.05); }
        .nav-icon { font-size: 1.4rem; }
        .nav-label { font-size: 0.75rem; font-weight: 600; }

        /* --- HUBS (VIEWS) --- */
        .hub { display: none; animation: fadeIn 0.3s ease-out; }
        .hub.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- COMMON UI COMPONENTS --- */
        .section-title { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: #78909c; margin: 20px 0 10px 0; border-bottom: 2px solid #eceff1; padding-bottom: 5px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: filter 0.2s; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-doc { background: #1976d2; color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-outline { background: white; border: 2px solid var(--border); color: var(--text); }

        /* --- EVIDENCE LAB --- */
        .source-header { display: flex; justify-content: space-between; align-items: center; background: #e0f2f1; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #b2dfdb; }
        .filter-bar { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { flex: 1; white-space: nowrap; padding: 8px; font-size: 0.9rem; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; }
        .card { background: var(--card); padding: 15px; border-radius: 10px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s, border-color 0.2s; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-3px); border-color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
        .card-tone::before { background: var(--tone); }
        .card-structure::before { background: var(--struct); }
        .card-language::before { background: var(--lang); }
        .card-quote { font-family: 'Georgia', serif; font-size: 1.05rem; line-height: 1.4; color: #37474f; font-style: italic; margin-bottom: 8px; display: block; }
        .card-meta { font-size: 0.75rem; text-transform: uppercase; color: #90a4ae; font-weight: bold; display: flex; justify-content: space-between; }

        /* --- WRITING DESK --- */
        .builder-container { background: #fff; border-radius: 10px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .slot-row { margin-bottom: 12px; }
        .slot-label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--primary); margin-bottom: 4px; text-transform: uppercase; }
        .slot-select, .slot-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; background: #fafafa; }
        .slot-static { background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; padding: 10px; border-radius: 6px; font-style: italic; }
        
        .preview-box { padding: 15px; background: #fff8e1; border: 2px dashed #ffb74d; border-radius: 8px; font-size: 1.1rem; min-height: 60px; line-height: 1.5; margin-bottom: 15px; }
        .preview-box:focus { outline: none; border-color: var(--accent); background: #fff; }
        
        textarea#final-essay { width: 100%; height: 200px; padding: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; font-family: inherit; line-height: 1.6; resize: vertical; margin-bottom: 10px; }

        /* --- ADMIN / MODALS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal.open { display: flex; }
        .modal-content { background: var(--bg); width: 95%; max-width: 900px; max-height: 95vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-header { padding: 15px 20px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.1rem; }
        .modal-body { padding: 20px; overflow-y: auto; }
        
        .admin-panel { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        .admin-panel h3 { margin-top: 0; color: var(--primary); font-size: 1rem; display: flex; align-items: center; gap: 8px; border-bottom:1px solid #eee; padding-bottom:5px;}
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.95rem; }
        
        .bank-tag { display: inline-block; background: #e0f2f1; padding: 4px 8px; border-radius: 4px; margin: 2px; font-size: 0.9rem; border: 1px solid #b2dfdb; }
        .bank-tag button { background: none; border: none; color: #d32f2f; font-weight: bold; cursor: pointer; margin-left: 5px; }
        
        .admin-tab-bar { display:flex; gap:5px; margin-bottom:10px; }
        .admin-tab { flex:1; padding:8px; border:1px solid var(--border); background:#f5f5f5; cursor:pointer; text-align:center; font-weight:bold; border-radius:4px; }
        .admin-tab.active { background: var(--primary); color:white; border-color:var(--primary); }

        .editor-item { border: 1px solid #eee; padding: 10px; margin-bottom: 10px; background: #fafafa; border-radius: 6px; }
        .editor-row { display:flex; gap:10px; align-items:center; margin-bottom:5px; }

        /* --- UTILS --- */
        .hidden { display: none !important; }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        
        #save-indicator { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 3000; }
        
        @media print { body { background: white; color: black; } .no-print { display: none; } }
    </style>
</head>
<body>

    <div id="save-indicator">üíæ Progress Saved</div>

    <audio id="sfx-success" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
    <audio id="sfx-cheer" src="https://actions.google.com/sounds/v1/crowds/crowd_cheer.ogg"></audio>

    <header class="no-print">
        <h1>
            <button class="icon-btn" onclick="app.resetSession()" style="color:red; border-color:red;" title="New Session">‚ú®</button>
            Tone & Structure <span style="font-size:0.8em; color:#999;">v217</span>
            <span class="score-pill" id="score-display">0 XP</span>
        </h1>
        <div class="header-controls">
            <button class="icon-btn" onclick="ui.openHelp()">‚ùì</button>
            <select id="level-selector" class="level-select" onchange="app.setLevel(this.value)">
                <option value="1">Lvl 1</option>
                <option value="2">L2</option>
                <option value="3">L3</option>
            </select>
            <button class="icon-btn" onclick="ui.openAdmin()">‚öôÔ∏è</button>
        </div>
    </header>

    <div class="viewport no-print">
        
        <div id="hub-lab" class="hub active">
            <div class="source-header">
                <div>
                    <strong>Topic:</strong> <span id="text-title">Loading...</span>
                </div>
                <button class="btn btn-outline" style="width:auto; padding:5px 10px; font-size:0.85rem;" onclick="ui.openSourceText()">
                    üìÑ Read Source
                </button>
            </div>

            <div class="section-title">Step 1: Gather Evidence</div>
            
            <div class="filter-bar">
                <button class="btn btn-outline filter-btn" onclick="app.filterGrid('all')">All</button>
                <button class="btn btn-outline filter-btn" onclick="app.filterGrid('language')">Language</button>
                <button class="btn btn-outline filter-btn" onclick="app.filterGrid('structure')">Structure</button>
                <button class="btn btn-outline filter-btn" onclick="app.filterGrid('tone')">Tone</button>
            </div>

            <div id="quote-grid" class="grid"></div>

            <div class="section-title" style="margin-top:30px;">Global Analysis</div>
            <div id="global-structure-container"></div>
        </div>

        <div id="hub-write" class="hub">
            <div class="section-title">Step 2: Construct Analysis</div>
            <div class="builder-container" id="sentence-builder">
                <div style="text-align:center; color:#999; font-style:italic; padding:20px;">
                    Select a quote in the Evidence Lab to begin.
                </div>
            </div>

            <div class="section-title">Step 3: Refine & Commit</div>
            <div id="preview-box" class="preview-box" contenteditable="true" oninput="app.handleManualInput()">
                [Your sentence will appear here...]
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn btn-accent" onclick="app.undoLast()">Undo</button>
                <button class="btn btn-primary" onclick="app.commitSentence()">Commit to Essay ‚¨á</button>
            </div>

            <div class="section-title">Final Essay</div>
            <textarea id="final-essay" placeholder="Your full analytical response will be built here..." oninput="app.saveProgress()"></textarea>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-doc" onclick="app.exportDoc()">üìÑ Download .doc</button>
                <button class="btn btn-danger" onclick="app.clearEssay()">üóë Clear</button>
            </div>
        </div>

    </div>

    <nav class="bottom-nav no-print">
        <button class="nav-item active" onclick="ui.switchHub('lab')" id="nav-btn-lab">
            <span class="nav-icon">üß™</span>
            <span class="nav-label">Evidence Lab</span>
        </button>
        <button class="nav-item" onclick="ui.switchHub('write')" id="nav-btn-write">
            <span class="nav-icon">‚úçÔ∏è</span>
            <span class="nav-label">Writing Desk</span>
        </button>
    </nav>

    <div id="modal-source" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Source Text
                <button class="icon-btn" onclick="ui.closeModal('modal-source')">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="source-content" style="white-space: pre-wrap; line-height:1.6; font-family:'Georgia',serif; font-size:1.1rem; color:#333;"></div>
            </div>
        </div>
    </div>

    <div id="modal-help" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                How to Use
                <button class="icon-btn" onclick="ui.closeModal('modal-help')">‚úï</button>
            </div>
            <div class="modal-body">
                <p><strong>1. Evidence Lab:</strong> Read the source text. Click on colored quote cards to analyze them.</p>
                <hr>
                <p><strong>2. Writing Desk:</strong> Use the dropdown menus to build professional analytical sentences. You can edit the text manually before adding it to your final essay.</p>
            </div>
        </div>
    </div>

    <div id="modal-admin" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Teacher Settings
                <button class="icon-btn" onclick="ui.closeModal('modal-admin')">‚úï</button>
            </div>
            <div class="modal-body">
                
                <div class="admin-panel" style="background:#e3f2fd; border-color:#90caf9;">
                    <h3>ü§ñ AI Lesson Generator</h3>
                    <div style="display:flex; gap:10px;">
                        <div class="input-group" style="flex:1;">
                            <label>Quotes to Generate</label>
                            <input type="number" id="gen-quote-count" value="6" min="1" max="15">
                        </div>
                    </div>
                    <div class="input-group">
                        <label>Paste Source Text & Question</label>
                        <textarea id="gen-input-text" style="height:60px;" placeholder="Paste text here..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="admin.generatePrompt()">Generate Prompt</button>
                    
                    <div id="gen-output-area" class="hidden" style="margin-top:10px;">
                        <textarea id="gen-prompt-out" style="height:80px; background:#fff;" readonly></textarea>
                        <p style="font-size:0.8rem; color:#666;">Copy above -> Paste to AI -> Paste Result below:</p>
                        <textarea id="gen-json-in" style="height:80px;" placeholder="Paste JSON here..."></textarea>
                        <button class="btn btn-success" style="background:var(--success); color:white; margin-top:5px;" onclick="admin.loadJson()">üì• Load Lesson Data</button>
                    </div>
                </div>

                <div class="admin-panel" style="border-left: 4px solid var(--struct);">
                    <h3>‚öôÔ∏è Sentence Structure Config</h3>
                    <div class="admin-tab-bar">
                        <div class="admin-tab active" onclick="admin.renderConfig(1)" id="tab-c1">Lvl 1</div>
                        <div class="admin-tab" onclick="admin.renderConfig(2)" id="tab-c2">Lvl 2</div>
                        <div class="admin-tab" onclick="admin.renderConfig(3)" id="tab-c3">Lvl 3</div>
                    </div>
                    <div id="config-slots-container"></div>
                    <button class="btn btn-outline" style="margin-top:10px;" onclick="admin.saveSentenceConfig()">Save Structure</button>
                </div>

                <div class="admin-panel" style="border-left: 4px solid var(--tone);">
                    <h3>‚úçÔ∏è Analysis Banks Editor</h3>
                    <div style="display:flex; gap:5px; flex-wrap:wrap; margin-bottom:10px;">
                        <button class="btn btn-outline" style="width:auto; padding:5px 10px;" onclick="admin.renderBank('markers')">Markers</button>
                        <button class="btn btn-outline" style="width:auto; padding:5px 10px;" onclick="admin.renderBank('starters')">Starters</button>
                        <button class="btn btn-outline" style="width:auto; padding:5px 10px;" onclick="admin.renderBank('methods')">Methods</button>
                    </div>
                    <div id="bank-editor-ui" class="hidden">
                        <strong id="bank-name-display"></strong>
                        <div style="display:flex; gap:5px; margin-bottom:5px;">
                            <input id="bank-new-item" placeholder="New item...">
                            <button class="btn btn-primary" style="width:auto;" onclick="admin.addBankItem()">Add</button>
                        </div>
                        <div id="bank-items-list"></div>
                    </div>
                </div>

                <div class="admin-panel" style="border-left: 4px solid var(--lang);">
                    <h3>üìù Edit Evidence (Quotes)</h3>
                    <div id="items-editor-container" style="max-height:200px; overflow-y:auto; border:1px solid #eee; padding:5px; margin-bottom:10px;"></div>
                    <button class="btn btn-success" style="background:var(--success); color:white;" onclick="admin.addNewQuote()">+ Add New Quote</button>
                </div>

                <div class="admin-panel" style="border-left: 4px solid #607d8b;">
                    <h3>üèóÔ∏è Whole Text Structure</h3>
                    <div class="input-group">
                        <label>Global Question</label>
                        <input id="global-q-input" onchange="admin.updateGlobal('question', this.value)">
                    </div>
                    <div class="input-group">
                        <label>Correct Answer</label>
                        <input id="global-a-input" onchange="admin.updateGlobal('correct', this.value)">
                    </div>
                </div>

                <div class="admin-panel">
                    <h3>üì¶ Export</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn btn-doc" onclick="admin.exportWorksheet()">üìÑ Worksheet</button>
                        <button class="btn btn-primary" style="background:#37474f;" onclick="admin.exportStandalone()">üì¶ Standalone App</button>
                        <button class="btn btn-outline" onclick="admin.saveConfig()">üíæ Save Config</button>
                        <label class="btn btn-outline" style="text-align:center; cursor:pointer;">üìÇ Load Config<input type="file" id="file-upload" class="hidden" onchange="admin.loadConfig(this)"></label>
                    </div>
                </div>

                <button class="btn btn-danger" onclick="app.factoryReset()">Factory Reset App</button>

            </div>
        </div>
    </div>

<script>
// --- 1. CORE DATA ---
const defaultData = {
    meta: { title: "Demo Lesson", author: "System", version: 217 },
    sourceText: "The sky was a bruised purple. The wind howled like a banshee...",
    question: "How does the writer use language?",
    globalStructure: { enabled: true, question: "How does the focus shift?", correct: "From outside to inside.", distractors: ["It stays outside."] },
    banks: {
        markers: ["Furthermore,", "However,", "Consequently,"],
        starters: ["The writer suggests", "The author highlights"],
        methods: ["Metaphor", "Simile", "Personification"],
        links: { l1: ["This shows", "This suggests"], l2: ["This reinforces", "This highlights"] }
    },
    sentenceConfig: {
        1: ["starter", "quote", "link_l1", "manual_point"],
        2: ["marker", "starter", "quote", "method", "link_l2", "manual_analysis"],
        3: ["marker", "starter", "quote", "method", "manual_deep_analysis", "link_l2"]
    },
    items: [
        { id: "d1", original: "bruised purple", translation: "Dark color", type: "language", levels: [1, 2, 3], l1: { prompt: "Technique?", correct: "Metaphor", distractors: ["Simile"] } }
    ]
};

let appData = null;
let userState = { score: 0, level: 1, essay: "", completed: [], currentBuilder: {} };
let currentConfigLevel = 1;
let currentBank = null;

// --- 2. APP LOGIC ---
const app = {
    init: function() {
        const storedData = localStorage.getItem('tsa_data_v217');
        appData = storedData ? JSON.parse(storedData) : JSON.parse(JSON.stringify(defaultData));
        if (!appData.items) appData.items = []; // Safety check
        if (!appData.banks) appData.banks = defaultData.banks;

        const storedState = localStorage.getItem('tsa_state_v217');
        if (storedState) userState = JSON.parse(storedState);

        ui.updateScore();
        document.getElementById('final-essay').value = userState.essay;
        document.getElementById('level-selector').value = userState.level;
        ui.renderLab();
    },

    saveProgress: function() {
        userState.essay = document.getElementById('final-essay').value;
        localStorage.setItem('tsa_state_v217', JSON.stringify(userState));
        localStorage.setItem('tsa_data_v217', JSON.stringify(appData));
        document.getElementById('save-indicator').style.opacity = 1;
        setTimeout(() => document.getElementById('save-indicator').style.opacity = 0, 1000);
    },

    resetSession: function() {
        if(confirm("Clear progress?")) {
            userState = { score: 0, level: 1, essay: "", completed: [], currentBuilder: {} };
            app.saveProgress();
            location.reload();
        }
    },

    factoryReset: function() {
        if(confirm("NUCLEAR RESET: Delete ALL data?")) {
            localStorage.clear();
            location.reload();
        }
    },

    setLevel: function(lvl) {
        userState.level = parseInt(lvl);
        app.saveProgress();
        ui.renderLab();
        document.getElementById('sentence-builder').innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Level changed. Reselect quote.</div>';
    },

    filterGrid: function(type) {
        document.querySelectorAll('.card-item').forEach(el => {
            el.style.display = (type === 'all' || el.dataset.type === type) ? 'block' : 'none';
        });
    },

    selectQuote: function(id) {
        const item = appData.items.find(i => i.id === id);
        if(item) ui.showAnalysisModal(item);
    },

    commitSentence: function() {
        const text = document.getElementById('preview-box').innerText.trim();
        if(!text || text.includes("[")) return alert("Complete sentence first.");
        document.getElementById('final-essay').value += (document.getElementById('final-essay').value ? "\n\n" : "") + text;
        app.saveProgress();
    },

    undoLast: function() {
        const lines = document.getElementById('final-essay').value.split("\n\n");
        if(lines.length > 0) { lines.pop(); document.getElementById('final-essay').value = lines.join("\n\n"); app.saveProgress(); }
    },

    exportDoc: function() {
        const blob = new Blob(['\ufeff' + document.getElementById('final-essay').value], { type: 'application/msword' });
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Essay.doc'; a.click();
    },
    
    clearEssay: function() { if(confirm("Clear essay?")) { document.getElementById('final-essay').value = ""; app.saveProgress(); } },
    handleManualInput: function() {} // Binding stub
};

// --- 3. UI RENDERER ---
const ui = {
    renderLab: function() {
        document.getElementById('text-title').innerText = appData.meta.title;
        document.getElementById('source-content').innerText = appData.sourceText;
        const grid = document.getElementById('quote-grid');
        grid.innerHTML = '';
        appData.items.forEach(item => {
            if (item.levels && !item.levels.includes(userState.level)) return;
            const div = document.createElement('div');
            div.className = `card card-item card-${item.type}`;
            div.dataset.type = item.type;
            div.innerHTML = `<span class="card-quote">"${item.original}"</span><div class="card-meta"><span>${item.type}</span><span>${userState.completed.includes(item.id) ? '‚úÖ' : ''}</span></div>`;
            div.onclick = () => app.selectQuote(item.id);
            grid.appendChild(div);
        });
        
        const gc = document.getElementById('global-structure-container');
        if (appData.globalStructure && appData.globalStructure.enabled) {
            gc.innerHTML = `<div class="card card-structure" onclick="ui.runGlobalCheck()"><strong>üèóÔ∏è Whole Text Structure Question</strong><br><small>Click to answer</small></div>`;
        } else { gc.innerHTML = ''; }
    },

    updateScore: () => document.getElementById('score-display').innerText = userState.score + " XP",
    switchHub: (h) => {
        document.querySelectorAll('.hub').forEach(el => el.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        document.getElementById('hub-'+h).classList.add('active');
        document.getElementById('nav-btn-'+h).classList.add('active');
    },
    openModal: (id) => document.getElementById(id).classList.add('open'),
    closeModal: (id) => document.getElementById(id).classList.remove('open'),
    openHelp: () => ui.openModal('modal-help'),
    openSourceText: () => ui.openModal('modal-source'),
    openAdmin: () => {
        const p = prompt("Password (default: 1234)");
        if (p === "1234" || p === "admin") {
            ui.openModal('modal-admin');
            admin.renderConfig(1); // Load default view
            admin.renderQuoteList();
            document.getElementById('global-q-input').value = appData.globalStructure.question;
            document.getElementById('global-a-input').value = appData.globalStructure.correct;
        } else { alert("Incorrect"); }
    },

    showAnalysisModal: function(item) {
        const opts = [item.translation, ...item.distractors || ["Wrong"]].sort(() => Math.random() - 0.5);
        const ov = document.createElement('div'); ov.className = 'modal open';
        ov.innerHTML = `<div class="modal-content"><div class="modal-header">Phase 1: Meaning <button class="icon-btn" onclick="this.closest('.modal').remove()">‚úï</button></div><div class="modal-body"><p>"${item.original}"</p><p>Meaning?</p><div class="grid">${opts.map(o => `<button class="btn btn-outline a-btn" data-c="${o===item.translation}">${o}</button>`).join('')}</div></div></div>`;
        document.body.appendChild(ov);
        ov.querySelectorAll('.a-btn').forEach(b => b.onclick = function() {
            if(this.dataset.c === "true") { 
                this.style.background = "var(--success)"; 
                setTimeout(() => { ov.remove(); ui.startSentenceBuilder(item); }, 500);
            } else { this.classList.add('shake'); this.style.background = "var(--error)"; }
        });
    },

    runGlobalCheck: function() {
        const q = appData.globalStructure;
        const opts = [q.correct, ...q.distractors].sort(() => Math.random()-0.5);
        const ov = document.createElement('div'); ov.className = 'modal open';
        ov.innerHTML = `<div class="modal-content"><div class="modal-header">Structure <button class="icon-btn" onclick="this.closest('.modal').remove()">‚úï</button></div><div class="modal-body"><p>${q.question}</p>${opts.map(o => `<button class="btn btn-outline g-btn" data-c="${o===q.correct}">${o}</button>`).join('')}</div></div>`;
        document.body.appendChild(ov);
        ov.querySelectorAll('.g-btn').forEach(b => b.onclick = function() {
            if(this.dataset.c === "true") { this.style.background = "var(--success)"; userState.score += 20; ui.updateScore(); setTimeout(()=>ov.remove(), 800); }
            else { this.classList.add('shake'); this.style.background="#ffebee"; }
        });
    },

    startSentenceBuilder: function(item) {
        ui.switchHub('write');
        const cont = document.getElementById('sentence-builder'); cont.innerHTML = '';
        const config = appData.sentenceConfig[userState.level] || ["starter", "quote", "manual_analysis"];
        config.forEach(slot => {
            const div = document.createElement('div'); div.className = 'slot-row';
            if(slot.startsWith('manual')) {
                div.innerHTML = `<span class="slot-label">${slot.split('_')[1]} (Idea)</span><input class="slot-input" placeholder="..." oninput="ui.updatePreview()">`;
            } else if (slot === 'quote') {
                div.innerHTML = `<span class="slot-label">EVIDENCE</span><div class="slot-static" data-v='"${item.original}"'>"${item.original}"</div>`;
            } else {
                const k = slot.includes('link') ? (slot.split('_')[1]||'l1') : slot + "s";
                const opts = (slot.includes('link') ? appData.banks.links[k] : appData.banks[k]) || [];
                if(opts.length) {
                    div.innerHTML = `<span class="slot-label">${slot.toUpperCase()}</span><select class="slot-select" onchange="ui.updatePreview()"><option value="">...</option>${opts.map(o=>`<option value="${o}">${o}</option>`).join('')}</select>`;
                }
            }
            cont.appendChild(div);
        });
        ui.updatePreview();
    },

    updatePreview: function() {
        const parts = [];
        document.querySelectorAll('#sentence-builder select, #sentence-builder input, #sentence-builder .slot-static').forEach(el => {
            let v = el.tagName === 'DIV' ? el.dataset.v : el.value;
            if(v && v.trim()) parts.push(v);
        });
        document.getElementById('preview-box').innerText = parts.join(" ") + ".";
    }
};

// --- 4. ADMIN FEATURES ---
const admin = {
    generatePrompt: function() {
        const c = document.getElementById('gen-quote-count').value;
        const t = document.getElementById('gen-input-text').value;
        if(!t) return alert("Paste text first");
        document.getElementById('gen-prompt-out').value = `Create JSON lesson with ${c} quotes. Source: "${t.substring(0,500)}...". Format: { meta: {title, author}, sourceText, items: [{id, original, translation, type, levels:[1,2,3], l1:{prompt, correct, distractors}}] }`;
        document.getElementById('gen-output-area').classList.remove('hidden');
    },
    loadJson: function() {
        try {
            let d = JSON.parse(document.getElementById('gen-json-in').value.replace(/```json|```/g, ''));
            appData.items = d.items || []; appData.sourceText = d.sourceText || ""; appData.meta = d.meta || appData.meta;
            app.saveProgress(); location.reload();
        } catch(e) { alert("Invalid JSON"); }
    },
    
    // Manual Editors Logic
    renderConfig: function(lvl) {
        currentConfigLevel = lvl;
        document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
        document.getElementById(`tab-c${lvl}`).classList.add('active');
        const cont = document.getElementById('config-slots-container');
        cont.innerHTML = '';
        const slots = appData.sentenceConfig[lvl] || [];
        const allOpts = ['marker', 'starter', 'quote', 'method', 'link_l1', 'link_l2', 'manual_point', 'manual_analysis', 'manual_effect'];
        
        // 6 Slots
        for(let i=0; i<6; i++) {
            const sel = document.createElement('select');
            sel.className = 'input-group';
            sel.innerHTML = `<option value="none">None</option>` + allOpts.map(o => `<option value="${o}" ${slots[i]===o ? 'selected':''}>${o}</option>`).join('');
            sel.onchange = () => {
                const newArr = Array.from(cont.querySelectorAll('select')).map(s => s.value).filter(v => v !== 'none');
                appData.sentenceConfig[lvl] = newArr;
                app.saveProgress();
            };
            cont.appendChild(sel);
        }
    },

    saveSentenceConfig: function() { app.saveProgress(); alert("Structure Saved!"); },

    renderBank: function(key) {
        currentBank = key;
        document.getElementById('bank-editor-ui').classList.remove('hidden');
        document.getElementById('bank-name-display').innerText = "Editing: " + key.toUpperCase();
        const list = document.getElementById('bank-items-list');
        list.innerHTML = '';
        // Handle links special case
        let arr = (key.includes('link')) ? appData.banks.links.l1 : appData.banks[key]; // Simplified for UI
        if(!arr) arr = [];
        
        arr.forEach((val, idx) => {
            const span = document.createElement('span');
            span.className = 'bank-tag';
            span.innerHTML = `${val} <button onclick="admin.removeBankItem('${key}', ${idx})">x</button>`;
            list.appendChild(span);
        });
    },

    addBankItem: function() {
        const val = document.getElementById('bank-new-item').value;
        if(val && currentBank) {
            if(!appData.banks[currentBank]) appData.banks[currentBank] = [];
            appData.banks[currentBank].push(val);
            app.saveProgress();
            admin.renderBank(currentBank);
            document.getElementById('bank-new-item').value = '';
        }
    },

    removeBankItem: function(key, idx) {
        appData.banks[key].splice(idx, 1);
        app.saveProgress();
        admin.renderBank(key);
    },

    renderQuoteList: function() {
        const cont = document.getElementById('items-editor-container');
        cont.innerHTML = '';
        appData.items.forEach((item, idx) => {
            const d = document.createElement('div');
            d.className = 'editor-item';
            d.innerHTML = `
                <div class="editor-row"><strong>#${idx+1}</strong> <button class="btn btn-danger" style="width:auto; padding:2px 8px;" onclick="admin.deleteQuote(${idx})">Delete</button></div>
                <input class="input-group" value="${item.original}" onchange="admin.updateQuote(${idx}, 'original', this.value)">
                <div class="editor-row">
                    <label>L1 <input type="checkbox" ${item.levels.includes(1)?'checked':''} onchange="admin.toggleLevel(${idx}, 1)"></label>
                    <label>L2 <input type="checkbox" ${item.levels.includes(2)?'checked':''} onchange="admin.toggleLevel(${idx}, 2)"></label>
                    <label>L3 <input type="checkbox" ${item.levels.includes(3)?'checked':''} onchange="admin.toggleLevel(${idx}, 3)"></label>
                </div>
            `;
            cont.appendChild(d);
        });
    },

    updateQuote: function(idx, key, val) { appData.items[idx][key] = val; app.saveProgress(); },
    deleteQuote: function(idx) { appData.items.splice(idx, 1); app.saveProgress(); admin.renderQuoteList(); },
    addNewQuote: function() { 
        appData.items.push({ id: "new"+Date.now(), original: "New Quote", type: "tone", levels: [1,2,3], l1:{prompt:"?", correct:"Ans", distractors:["X"]} });
        app.saveProgress(); admin.renderQuoteList();
    },
    toggleLevel: function(idx, lvl) {
        const i = appData.items[idx];
        if(i.levels.includes(lvl)) i.levels = i.levels.filter(l => l !== lvl);
        else i.levels.push(lvl);
        app.saveProgress();
    },
    updateGlobal: function(k, v) { appData.globalStructure[k] = v; app.saveProgress(); },

    // Exports
    exportWorksheet: function() {
        let html = `<html><body><h1>${appData.meta.title}</h1><p>${appData.sourceText}</p><hr>`;
        appData.items.forEach(i => html += `<p><strong>"${i.original}"</strong><br>Analysis: ________________</p>`);
        const blob = new Blob(['\ufeff', html], {type: 'application/msword'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'Worksheet.doc'; a.click();
    },
    exportStandalone: function() {
        let html = document.documentElement.outerHTML;
        html = html.replace(/const defaultData = \{[\s\S]*?\}\};/, `const defaultData = ${JSON.stringify(appData)};`);
        const blob = new Blob([html], {type: 'text/html'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'StudentApp.html'; a.click();
    },
    saveConfig: function() {
        const blob = new Blob([JSON.stringify(appData)], {type: 'application/json'});
        const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'config.json'; a.click();
    },
    loadConfig: function(input) {
        const f = input.files[0]; if(!f) return;
        const r = new FileReader();
        r.onload = e => { try { appData = JSON.parse(e.target.result); app.saveProgress(); location.reload(); } catch(err) { alert("Error"); } };
        r.readAsText(f);
    }
};

window.onload = app.init;
</script>
</body>
</html>
