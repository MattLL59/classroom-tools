<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reading Skills Booster: Editable Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Library for generating Word Documents -->
    <script src="https://unpkg.com/docx@7.1.0/build/index.js"></script>
    <!-- Library for saving files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; touch-action: pan-y; }
        
        /* Draggable Styles */
        .draggable { cursor: grab; touch-action: none; user-select: none; -webkit-user-select: none; transition: transform 0.1s, box-shadow 0.1s; }
        .draggable:active { cursor: grabbing; opacity: 0.9; transform: scale(1.02); }
        
        /* Animation */
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Drop Zones */
        .drop-zone { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .drop-active { border-color: #6366f1; background-color: #e0e7ff; transform: scale(1.02); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.2); }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Print Styles */
        @media print {
            .no-print { display: none !important; }
            .print-only { display: block !important; }
            body { background: white !important; padding: 0 !important; height: auto !important; }
            .page-break { page-break-before: always; }
        }
        .print-only { display: none; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-slate-50 to-purple-50 min-h-screen p-3 md:p-6 text-slate-800 flex items-center justify-center">

    <!-- MAIN APP CONTAINER -->
    <div class="w-full max-w-6xl bg-white/90 backdrop-blur-xl rounded-3xl shadow-2xl border border-white/50 overflow-hidden flex flex-col h-[85vh] md:h-[800px] no-print">
        
        <!-- Header -->
        <header class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white p-5 md:p-6 shadow-md z-20 shrink-0 flex justify-between items-center">
            <div>
                <div class="flex items-center gap-2">
                    <span class="bg-white/20 text-xs font-bold px-2 py-0.5 rounded-full uppercase tracking-wider border border-white/10">Pro Edition</span>
                </div>
                <h1 id="app-title-display" class="text-xl md:text-3xl font-bold mt-1 tracking-tight">Reading Skills Booster</h1>
            </div>
            <div class="flex gap-2">
                 <button onclick="toggleTeacherMode()" class="bg-white/10 hover:bg-white/20 border border-white/20 text-white px-3 py-2 rounded-xl transition-all duration-200 text-sm font-semibold flex items-center gap-2 backdrop-blur-sm">
                    <span>üéì</span> 
                    <span class="hidden md:inline">Teacher Mode</span>
                </button>
                <button onclick="window.location.href='index.html'" class="bg-white/10 hover:bg-white/20 border border-white/20 text-white px-3 py-2 rounded-xl transition-all duration-200 text-sm font-semibold flex items-center gap-2 backdrop-blur-sm">
                    <span>üè†</span> 
                    <span class="hidden md:inline">Back</span>
                </button>
            </div>
        </header>

        <!-- Navigation -->
        <div class="bg-white border-b border-slate-100 p-2 shrink-0 z-10 shadow-sm overflow-x-auto">
            <nav class="flex space-x-2 min-w-max md:justify-center" id="nav-container">
                <!-- Nav generated by JS -->
            </nav>
        </div>

        <!-- Content Area -->
        <main id="game-container" class="flex-1 p-4 md:p-8 relative overflow-y-auto bg-slate-50/50">
            <!-- Dynamic Content Loaded Here -->
        </main>
    </div>

    <!-- TEACHER MODE MODAL -->
    <div id="teacher-modal" class="hidden fixed inset-0 bg-slate-900/50 backdrop-blur-sm z-50 flex items-center justify-center p-4 no-print">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl h-[90vh] flex flex-col overflow-hidden">
            <div class="bg-slate-800 text-white p-4 flex justify-between items-center shrink-0">
                <h2 class="text-xl font-bold">üéì Teacher Dashboard</h2>
                <button onclick="toggleTeacherMode()" class="text-slate-400 hover:text-white">‚úï Close</button>
            </div>
            
            <div class="flex flex-1 overflow-hidden">
                <!-- Sidebar -->
                <div class="w-48 bg-slate-100 border-r border-slate-200 p-2 overflow-y-auto shrink-0">
                    <button onclick="switchEditor('general')" class="w-full text-left p-2 rounded hover:bg-white font-medium text-sm mb-1">‚öôÔ∏è General</button>
                    <div class="my-2 border-b border-slate-300"></div>
                    <button onclick="switchEditor('game1')" class="w-full text-left p-2 rounded hover:bg-white font-medium text-sm mb-1">1. Impressions</button>
                    <button onclick="switchEditor('game2')" class="w-full text-left p-2 rounded hover:bg-white font-medium text-sm mb-1">2. Imagery</button>
                    <button onclick="switchEditor('game3')" class="w-full text-left p-2 rounded hover:bg-white font-medium text-sm mb-1">3. Emotions</button>
                    <button onclick="switchEditor('game4')" class="w-full text-left p-2 rounded hover:bg-white font-medium text-sm mb-1">4. Structure</button>
                    <div class="my-2 border-b border-slate-300"></div>
                    <button onclick="switchEditor('export')" class="w-full text-left p-2 rounded hover:bg-indigo-50 text-indigo-600 font-bold text-sm mb-1">üíæ Save / Export</button>
                    <button onclick="printWorksheet()" class="w-full text-left p-2 rounded hover:bg-teal-50 text-teal-600 font-bold text-sm mb-1">üñ®Ô∏è Print PDF</button>
                </div>
                
                <!-- Editor Area -->
                <div class="flex-1 p-6 overflow-y-auto bg-slate-50" id="editor-content">
                    <!-- Dynamic Forms Injection -->
                </div>
            </div>
            
            <div class="bg-white border-t border-slate-200 p-4 flex justify-end gap-3 shrink-0">
                <button onclick="resetToDefaults()" class="text-red-500 text-sm font-semibold hover:underline mr-auto">Reset Defaults</button>
                <button onclick="toggleTeacherMode()" class="px-4 py-2 text-slate-600 font-semibold hover:bg-slate-100 rounded-lg">Cancel</button>
                <button onclick="saveChanges()" class="px-6 py-2 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 shadow-lg">Apply Changes</button>
            </div>
        </div>
    </div>

    <!-- PRINT WORKSHEET LAYOUT (For PDF Printing) -->
    <div id="print-layout" class="print-only p-8 max-w-4xl mx-auto bg-white text-black">
        <h1 class="text-3xl font-bold mb-2 text-center border-b-2 border-black pb-4" id="print-title">Reading Skills Worksheet</h1>
        <p class="mb-8 text-center italic text-gray-600">Name: ___________________________________  Date: __________________</p>
        <div id="print-content" class="space-y-8"></div>
    </div>

    <!-- MAIN LOGIC SCRIPT -->
    <script>
        // --- DEFAULT DATA ---
        const defaultData = {
            general: { title: "Reading Skills Booster" },
            game1: {
                id: "blackwood", navTitle: "1. Mr. Blackwood", title: "The Impression Detective", instruction: "Analyze the character. Match the Evidence (Quote) to the Impression it creates.", type: "matching",
                pairs: [
                    { id: "q1", quote: "A smile that didn‚Äôt quite reach his eyes", target: "Fake", targetFull: "Mr. Blackwood is Insincere / Fake", color: "indigo" },
                    { id: "q2", quote: "Glancing up with a mixture of surprise and caution", target: "Suspicious", targetFull: "Evelyn is Suspicious / Wary", color: "teal" },
                    { id: "q3", quote: "His polished shoes made barely a sound", target: "Stealthy", targetFull: "Mr. Blackwood is Stealthy / Sneaky", color: "indigo" },
                    { id: "q4", quote: "Her fingers hovered... pen poised in mid-air", target: "Tense", targetFull: "Evelyn is Tense / Guarded", color: "teal" }
                ]
            },
            game2: {
                id: "imagery", navTitle: "2. Imagery", title: "The Menu Match-Up", instruction: "Match the unappealing description to the food item.", type: "matching",
                pairs: [
                    { id: "d1", quote: "Stacked wedges of rubbery white sponges", target: "Tofu", targetFull: "Tofu", color: "slate" },
                    { id: "d2", quote: "Backs crisscrossed... resembled bicycle tires", target: "Squid", targetFull: "Squid", color: "slate" },
                    { id: "d3", quote: "Slimy... with bulging eyes", target: "Rock Cod", targetFull: "Rock Cod", color: "slate" },
                    { id: "d4", quote: "Fleshy... pulling out black veins", target: "Prawns", targetFull: "Prawns", color: "slate" }
                ]
            },
            game3: {
                id: "emotions", navTitle: "3. Emotions", title: "Thoughts & Feelings Sorter", instruction: "Decide if the quote shows 'Crush' or 'Shame'.", cat1: "Crush / Love", cat2: "Shame / Despair",
                cards: [
                    { text: "He was as white as Mary in the manger.", type: "cat1" },
                    { text: "I wanted to disappear.", type: "cat2" },
                    { text: "I prayed for a slim new American nose.", type: "cat1" },
                    { text: "I was stunned into silence.", type: "cat2" },
                    { text: "I pretended he was not worthy of existence.", type: "cat1" },
                    { text: "Robert grimaced.", type: "cat2" }
                ]
            },
            game4: {
                id: "structure", navTitle: "4. Structure", title: "Point & Evidence Builder", instruction: "Reorder the blocks to build a solid analysis paragraph.",
                items: [
                    { id: "e1", text: "EVIDENCE: The text states that her relatives 'licked the ends of their chopsticks'...", type: "evidence" },
                    { id: "p2", text: "POINT: She also uses disgusting descriptions of the food to show that she is ashamed...", type: "point" },
                    { id: "p1", text: "POINT: The writer feels humiliated by her family's lack of manners...", type: "point" },
                    { id: "e2", text: "EVIDENCE: For instance, she describes the tofu as 'rubbery white sponges'...", type: "evidence" }
                ],
                correctOrder: ["p1", "e1", "p2", "e2"]
            }
        };

        // --- STATE ---
        let gameData = JSON.parse(localStorage.getItem('readingSkillsData')) || JSON.parse(JSON.stringify(defaultData));
        let activeTab = 'game1';
        let dragSrcEl = null;
        let matches = 0;

        // --- INIT ---
        function init() {
            renderNav();
            switchTab('game1');
            document.getElementById('app-title-display').innerText = gameData.general.title;
        }

        // --- RENDER ---
        function renderNav() {
            const container = document.getElementById('nav-container');
            container.innerHTML = '';
            ['game1', 'game2', 'game3', 'game4'].forEach(key => {
                const btn = document.createElement('button');
                btn.id = `tab-btn-${key}`;
                btn.className = "nav-pill px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-500 hover:bg-slate-50 whitespace-nowrap";
                btn.innerText = gameData[key].navTitle;
                btn.onclick = () => switchTab(key);
                container.appendChild(btn);
            });
        }

        function switchTab(key) {
            activeTab = key;
            document.querySelectorAll('#nav-container button').forEach(b => {
                b.className = "nav-pill px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 text-slate-500 hover:bg-slate-50 whitespace-nowrap";
            });
            document.getElementById(`tab-btn-${key}`).className = "nav-pill px-4 py-2.5 rounded-xl text-sm font-medium transition-all duration-200 bg-indigo-50 text-indigo-700 shadow-sm ring-1 ring-indigo-200 whitespace-nowrap";
            
            const container = document.getElementById('game-container');
            container.innerHTML = ''; 
            
            const data = gameData[key];
            const header = document.createElement('div');
            header.className = "text-center mb-8 fade-in";
            header.innerHTML = `
                <h2 class="text-2xl font-bold text-slate-800">${data.title}</h2>
                <p class="text-slate-500 mt-1">${data.instruction}</p>
            `;
            container.appendChild(header);

            if (key === 'game1' || key === 'game2') renderMatchingGame(container, data);
            else if (key === 'game3') renderSorterGame(container, data);
            else if (key === 'game4') renderStructureGame(container, data);
        }

        function renderMatchingGame(container, data) {
            matches = 0;
            const wrapper = document.createElement('div');
            wrapper.className = "grid grid-cols-1 lg:grid-cols-2 gap-8 md:gap-12 items-start fade-in max-w-5xl mx-auto";
            
            const dragCol = document.createElement('div');
            dragCol.className = "bg-white p-6 rounded-2xl shadow-sm border border-slate-100 space-y-4";
            dragCol.innerHTML = `<div class="flex items-center gap-2 mb-2 pb-2 border-b border-slate-100"><span class="bg-indigo-100 text-indigo-600 p-1.5 rounded-lg text-xs">üìù</span><h3 class="font-bold text-slate-400 uppercase text-xs tracking-wide">Draggable Items</h3></div>`;
            
            const targetCol = document.createElement('div');
            targetCol.className = "bg-slate-100/50 p-6 rounded-2xl border border-dashed border-slate-300 space-y-4";
            targetCol.innerHTML = `<div class="flex items-center gap-2 mb-2 pb-2 border-b border-slate-200/50"><span class="bg-teal-100 text-teal-600 p-1.5 rounded-lg text-xs">üéØ</span><h3 class="font-bold text-slate-400 uppercase text-xs tracking-wide">Target Categories</h3></div>`;

            data.pairs.forEach(pair => {
                const d = document.createElement('div');
                d.className = "draggable group bg-white border border-slate-200 shadow-sm hover:shadow-md p-4 rounded-xl cursor-grab active:cursor-grabbing relative overflow-hidden";
                d.draggable = true;
                d.setAttribute('data-match', pair.target);
                d.id = `drag-${pair.id}`;
                d.innerHTML = `<div class="absolute left-0 top-0 bottom-0 w-1.5 bg-${pair.color}-400 group-hover:bg-${pair.color}-500 transition-colors"></div><p class="pl-2 font-medium text-slate-700">${pair.quote}</p>`;
                setupDragEvents(d);
                dragCol.appendChild(d);

                const t = document.createElement('div');
                t.className = "droppable drop-zone bg-white border-2 border-slate-200 rounded-xl p-4 min-h-[90px] flex flex-col items-center justify-center text-center";
                t.setAttribute('data-target', pair.target);
                t.innerHTML = `<span class="font-bold text-${pair.color}-800">${pair.targetFull}</span><span class="text-xs text-slate-400 mt-1">Drop here</span>`;
                setupDropEvents(t, () => checkMatch(d, t, pair.target));
                targetCol.appendChild(t);
            });

            wrapper.appendChild(dragCol);
            wrapper.appendChild(targetCol);
            
            const fb = document.createElement('div');
            fb.id = "game-feedback";
            fb.className = "hidden animate-bounce mt-6 mx-auto max-w-md bg-green-500 text-white px-6 py-3 rounded-full shadow-lg text-center font-bold flex items-center justify-center gap-2";
            fb.innerHTML = `<span>‚ú®</span> Excellent work! All items matched.`;
            
            container.appendChild(wrapper);
            container.appendChild(fb);
        }

        let currentCardIndex = 0;
        let emotionScore = 0;
        function renderSorterGame(container, data) {
            currentCardIndex = 0;
            emotionScore = 0;
            
            const area = document.createElement('div');
            area.className = "max-w-4xl mx-auto fade-in";
            
            area.innerHTML = `
                <div id="card-display" class="h-64 flex items-center justify-center my-8">
                     <div id="sorter-card" class="bg-white border-2 border-slate-100 p-8 rounded-3xl shadow-xl w-full max-w-lg text-center text-xl md:text-2xl font-medium text-slate-700 cursor-pointer hover:scale-105 transition-transform flex flex-col items-center justify-center min-h-[200px]">
                        <span class="text-4xl mb-4">üëã</span>Click to Start
                     </div>
                </div>
                <div class="grid grid-cols-2 gap-6 max-w-lg mx-auto">
                    <button onclick="handleSorterChoice('cat1')" class="group relative overflow-hidden bg-white border-2 border-pink-100 hover:border-pink-300 text-slate-700 p-4 rounded-2xl shadow-sm hover:shadow-lg transition-all transform hover:-translate-y-1">
                        <div class="absolute inset-0 bg-pink-50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="relative z-10 font-bold text-lg">${data.cat1}</div>
                    </button>
                    <button onclick="handleSorterChoice('cat2')" class="group relative overflow-hidden bg-white border-2 border-blue-100 hover:border-blue-300 text-slate-700 p-4 rounded-2xl shadow-sm hover:shadow-lg transition-all transform hover:-translate-y-1">
                        <div class="absolute inset-0 bg-blue-50 opacity-0 group-hover:opacity-100 transition-opacity"></div>
                        <div class="relative z-10 font-bold text-lg">${data.cat2}</div>
                    </button>
                </div>
                <div class="text-center mt-6">
                    <span class="inline-block bg-slate-800 text-white px-4 py-1 rounded-full text-sm font-bold">SCORE: <span id="sorter-score">0</span></span>
                </div>
            `;
            container.appendChild(area);
            document.getElementById('sorter-card').onclick = nextSorterCard;
        }

        function renderStructureGame(container, data) {
            const wrapper = document.createElement('div');
            wrapper.className = "max-w-4xl mx-auto fade-in space-y-8";
            
            const list = document.createElement('div');
            list.id = "structure-list";
            list.className = "bg-slate-100 rounded-3xl p-6 md:p-8 space-y-4";
            
            data.items.forEach((item, idx) => {
                const el = document.createElement('div');
                el.className = "bg-white p-4 rounded-xl shadow-sm border border-slate-200 flex items-center justify-between select-none";
                if(item.type === 'point') el.classList.add('border-l-8', 'border-l-indigo-500');
                else el.classList.add('border-l-8', 'border-l-teal-500');
                
                // Allow HTML in text for teacher formatting
                el.innerHTML = `
                    <div class="text-slate-700 pr-4 leading-snug">${item.text}</div>
                    <div class="flex flex-col gap-1 ml-2">
                        <button onclick="moveItem(${idx}, -1)" class="text-slate-400 hover:text-indigo-600 rounded p-1">‚ñ≤</button>
                        <button onclick="moveItem(${idx}, 1)" class="text-slate-400 hover:text-indigo-600 rounded p-1">‚ñº</button>
                    </div>
                `;
                list.appendChild(el);
            });

            const btnArea = document.createElement('div');
            btnArea.className = "text-center";
            btnArea.innerHTML = `
                <button onclick="checkStructure()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-xl font-bold shadow-lg transition-transform active:scale-95">Check Order</button>
                <p id="structure-feedback" class="mt-4 font-bold h-6 text-lg"></p>
            `;

            wrapper.appendChild(list);
            wrapper.appendChild(btnArea);
            container.appendChild(wrapper);
        }

        // --- INTERACTION ---
        function setupDragEvents(el) {
            el.addEventListener('dragstart', e => {
                e.dataTransfer.setData('text', el.getAttribute('data-match'));
                e.dataTransfer.setData('id', el.id);
                dragSrcEl = el;
            });
            el.addEventListener('touchstart', handleTouchStart, {passive: false});
            el.addEventListener('touchmove', handleTouchMove, {passive: false});
            el.addEventListener('touchend', handleTouchEnd);
        }
        function setupDropEvents(el, callback) {
            el.addEventListener('dragover', e => e.preventDefault());
            el.addEventListener('drop', e => {
                e.preventDefault();
                const match = e.dataTransfer.getData('text');
                const target = el.getAttribute('data-target');
                if (match === target) callback();
                else {
                    el.classList.add('bg-red-50', 'border-red-300');
                    setTimeout(() => el.classList.remove('bg-red-50', 'border-red-300'), 500);
                }
            });
        }
        function checkMatch(dragEl, dropEl, target) {
            dragEl.style.display = 'none';
            dropEl.classList.remove('bg-white', 'bg-slate-50');
            dropEl.classList.add('bg-green-50', 'border-green-400', 'text-green-800', 'scale-105', 'shadow');
            dropEl.innerHTML = `<span class="text-2xl mb-1">‚úÖ</span><span class="font-bold text-sm">Matched!</span>`;
            matches++;
            if (matches === gameData[activeTab].pairs.length) {
                document.getElementById('game-feedback').classList.remove('hidden');
            }
        }

        function nextSorterCard() {
            const data = gameData.game3;
            const card = document.getElementById('sorter-card');
            if (currentCardIndex < data.cards.length) {
                card.innerText = data.cards[currentCardIndex].text;
                card.onclick = null; 
            } else {
                card.innerHTML = `<span class="text-4xl">üéâ</span><br>Complete!<br>Score: ${emotionScore}/${data.cards.length}`;
                card.onclick = () => renderSorterGame(document.getElementById('game-container'), data);
            }
        }
        function handleSorterChoice(choiceType) {
            const data = gameData.game3;
            if (currentCardIndex >= data.cards.length) return;
            const correctType = data.cards[currentCardIndex].type;
            const card = document.getElementById('sorter-card');
            
            if (choiceType === correctType) {
                emotionScore++;
                card.classList.add('bg-green-100', 'border-green-400');
            } else {
                card.classList.add('bg-red-100', 'border-red-400');
            }
            setTimeout(() => {
                card.classList.remove('bg-green-100', 'border-green-400', 'bg-red-100', 'border-red-400');
                currentCardIndex++;
                nextSorterCard();
            }, 300);
        }

        function moveItem(idx, dir) {
            const items = gameData.game4.items;
            const newIdx = idx + dir;
            if (newIdx < 0 || newIdx >= items.length) return;
            [items[idx], items[newIdx]] = [items[newIdx], items[idx]];
            switchTab('game4'); 
        }
        function checkStructure() {
            const items = gameData.game4.items;
            const fb = document.getElementById('structure-feedback');
            let correct = true;
            if (items[0].type !== 'point' || items[1].type !== 'evidence') correct = false;
            if (items[2].type !== 'point' || items[3].type !== 'evidence') correct = false;

            if (correct) {
                fb.innerText = "‚úÖ Excellent structure!";
                fb.className = "mt-4 font-bold h-6 text-lg text-green-600";
            } else {
                fb.innerText = "‚ùå Remember: Point then Evidence.";
                fb.className = "mt-4 font-bold h-6 text-lg text-red-600";
            }
        }

        // --- TEACHER & EXPORT ---
        function toggleTeacherMode() {
            const modal = document.getElementById('teacher-modal');
            modal.classList.toggle('hidden');
            if (!modal.classList.contains('hidden')) switchEditor('general');
        }

        function switchEditor(section) {
            const container = document.getElementById('editor-content');
            container.innerHTML = '';
            
            if (section === 'export') {
                renderExportTools(container);
                return;
            }
            
            if (section === 'general') {
                container.innerHTML = `
                    <h3 class="font-bold text-lg mb-4">General Settings</h3>
                    <label class="block text-sm font-bold mb-1">App Title</label>
                    <input type="text" id="edit-title" class="w-full border p-2 rounded mb-4" value="${gameData.general.title}">
                `;
                return;
            }

            const data = gameData[section];
            container.innerHTML = `<h3 class="font-bold text-lg mb-4">Editing: ${data.navTitle}</h3>`;
            
            container.innerHTML += `
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">Tab Title</label>
                    <input type="text" id="edit-nav" class="w-full border p-2 rounded" value="${data.navTitle}" onchange="gameData.${section}.navTitle = this.value">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">Page Heading</label>
                    <input type="text" id="edit-page-title" class="w-full border p-2 rounded" value="${data.title}" onchange="gameData.${section}.title = this.value">
                </div>
                <div class="mb-4">
                    <label class="block text-sm font-bold mb-1">Instructions</label>
                    <textarea class="w-full border p-2 rounded" onchange="gameData.${section}.instruction = this.value">${data.instruction}</textarea>
                </div>
            `;

            if (section === 'game1' || section === 'game2') {
                data.pairs.forEach((pair, i) => {
                    container.innerHTML += `
                        <div class="bg-white p-3 rounded border mb-2 shadow-sm">
                            <div class="font-bold text-xs text-slate-400 mb-2">PAIR #${i+1}</div>
                            <input type="text" class="w-full border p-1 rounded mb-1 text-sm" placeholder="Draggable Text" value="${pair.quote}" onchange="gameData.${section}.pairs[${i}].quote = this.value">
                            <input type="text" class="w-full border p-1 rounded mb-1 text-sm" placeholder="Target Category" value="${pair.targetFull}" onchange="gameData.${section}.pairs[${i}].targetFull = this.value">
                            <input type="text" class="w-full border p-1 rounded text-xs text-slate-500" placeholder="Internal Match Key (One Word)" value="${pair.target}" onchange="gameData.${section}.pairs[${i}].target = this.value">
                        </div>
                    `;
                });
            } else if (section === 'game3') {
                container.innerHTML += `
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <input type="text" class="border p-2 rounded" value="${data.cat1}" onchange="gameData.${section}.cat1 = this.value">
                        <input type="text" class="border p-2 rounded" value="${data.cat2}" onchange="gameData.${section}.cat2 = this.value">
                    </div>
                `;
                data.cards.forEach((card, i) => {
                    container.innerHTML += `
                        <div class="flex gap-2 mb-2">
                            <input type="text" class="flex-1 border p-1 rounded text-sm" value="${card.text}" onchange="gameData.${section}.cards[${i}].text = this.value">
                            <select class="border p-1 rounded text-sm" onchange="gameData.${section}.cards[${i}].type = this.value">
                                <option value="cat1" ${card.type === 'cat1' ? 'selected' : ''}>Cat 1</option>
                                <option value="cat2" ${card.type === 'cat2' ? 'selected' : ''}>Cat 2</option>
                            </select>
                        </div>
                    `;
                });
            }
        }

        function renderExportTools(container) {
            container.innerHTML = `
                <h3 class="font-bold text-lg mb-4">Save & Export</h3>
                
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 mb-4">
                    <h4 class="font-bold text-blue-800 mb-2">üìù Word Document</h4>
                    <p class="text-sm text-blue-600 mb-3">Generate an editable .docx worksheet from your current questions.</p>
                    <button onclick="downloadWordDoc()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700">Download .docx</button>
                </div>

                <div class="bg-indigo-50 p-4 rounded-xl border border-indigo-100 mb-4">
                    <h4 class="font-bold text-indigo-800 mb-2">üíæ Standalone File</h4>
                    <p class="text-sm text-indigo-600 mb-3">Download a new HTML file with all your changes baked in.</p>
                    <button onclick="downloadStandalone()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-indigo-700">Download .html</button>
                </div>

                <div class="bg-slate-50 p-4 rounded-xl border border-slate-200 mb-4">
                    <h4 class="font-bold text-slate-800 mb-2">‚öôÔ∏è Raw Code</h4>
                    <textarea id="json-export" class="w-full h-24 border p-2 rounded text-xs font-mono mb-2" readonly></textarea>
                    <button onclick="copyConfig()" class="bg-slate-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-slate-700">Copy to Clipboard</button>
                </div>
            `;
            document.getElementById('json-export').value = JSON.stringify(gameData, null, 2);
        }

        function saveChanges() {
            const titleInput = document.getElementById('edit-title');
            if (titleInput) gameData.general.title = titleInput.value;
            localStorage.setItem('readingSkillsData', JSON.stringify(gameData));
            init(); 
            toggleTeacherMode();
            alert("Changes saved to this browser!");
        }

        function resetToDefaults() {
            if(confirm("Are you sure? This will erase all your custom edits.")) {
                localStorage.removeItem('readingSkillsData');
                location.reload();
            }
        }

        function downloadStandalone() {
            const currentHTML = document.documentElement.outerHTML;
            const scriptContent = `const defaultData = ${JSON.stringify(gameData)};`;
            const newHTML = currentHTML.replace(/const defaultData = \{[\s\S]*?\}\;/m, scriptContent);
            const blob = new Blob([newHTML], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'reading-skills-custom.html';
            a.click();
        }

        function copyConfig() {
            const copyText = document.getElementById("json-export");
            copyText.select();
            document.execCommand("copy");
            alert("Configuration copied!");
        }

        // --- WORD DOC GENERATION ---
        function downloadWordDoc() {
            const doc = new docx.Document({
                sections: [{
                    properties: {},
                    children: [
                        new docx.Paragraph({
                            children: [new docx.TextRun({ text: gameData.general.title + " - Worksheet", bold: true, size: 32 })],
                            alignment: docx.AlignmentType.CENTER,
                            spacing: { after: 200 }
                        }),
                        new docx.Paragraph({
                            children: [new docx.TextRun({ text: "Name: ______________________  Date: ____________", italics: true })],
                            alignment: docx.AlignmentType.CENTER,
                            spacing: { after: 400 }
                        }),
                        
                        // Game 1
                        createWordSectionHeading(gameData.game1.title),
                        new docx.Paragraph({ text: gameData.game1.instruction, spacing: { after: 200 } }),
                        createWordTable(gameData.game1.pairs, "Quote / Evidence", "Impression"),
                        
                        // Game 2
                        createWordSectionHeading(gameData.game2.title),
                        new docx.Paragraph({ text: gameData.game2.instruction, spacing: { after: 200 } }),
                        createWordTable(gameData.game2.pairs, "Description", "Food Item"),
                        
                        // Game 3
                        createWordSectionHeading(gameData.game3.title),
                        new docx.Paragraph({ 
                            children: [
                                new docx.TextRun({ text: "Circle the correct emotion: " }),
                                new docx.TextRun({ text: gameData.game3.cat1, bold: true }),
                                new docx.TextRun({ text: " or " }),
                                new docx.TextRun({ text: gameData.game3.cat2, bold: true })
                            ],
                            spacing: { after: 200 }
                        }),
                        ...gameData.game3.cards.map(card => new docx.Paragraph({
                            children: [ new docx.TextRun({ text: "‚Ä¢ " + card.text }) ],
                            spacing: { after: 100 }
                        })),

                        // Game 4
                        createWordSectionHeading(gameData.game4.title),
                        new docx.Paragraph({ text: "Number these in the correct order (1-4):", spacing: { after: 200 } }),
                        ...gameData.game4.items.map(item => new docx.Paragraph({
                            children: [ new docx.TextRun({ text: "___ " + item.text.replace(/<[^>]*>?/gm, '') }) ], // Strip HTML
                            spacing: { after: 100 }
                        }))
                    ]
                }]
            });

            docx.Packer.toBlob(doc).then(blob => {
                saveAs(blob, "reading-skills-worksheet.docx");
            });
        }

        function createWordSectionHeading(text) {
            return new docx.Paragraph({
                children: [new docx.TextRun({ text: text, bold: true, size: 24 })],
                spacing: { before: 400, after: 200 }
            });
        }

        function createWordTable(items, header1, header2) {
            const rows = [
                new docx.TableRow({
                    children: [
                        new docx.TableCell({ children: [new docx.Paragraph({ children: [new docx.TextRun({ text: header1, bold: true })] })], width: { size: 50, type: docx.WidthType.PERCENTAGE } }),
                        new docx.TableCell({ children: [new docx.Paragraph({ children: [new docx.TextRun({ text: header2, bold: true })] })], width: { size: 50, type: docx.WidthType.PERCENTAGE } }),
                    ]
                })
            ];
            
            items.forEach(item => {
                rows.push(new docx.TableRow({
                    children: [
                        new docx.TableCell({ children: [new docx.Paragraph(item.quote)] }),
                        new docx.TableCell({ children: [new docx.Paragraph("")] }) // Empty cell for student answer
                    ]
                }));
            });

            return new docx.Table({ rows: rows, width: { size: 100, type: docx.WidthType.PERCENTAGE } });
        }

        // --- PRINT PDF ---
        function printWorksheet() {
            document.getElementById('print-title').innerText = gameData.general.title + " - Worksheet";
            const content = document.getElementById('print-content');
            content.innerHTML = '';
            
            ['game1', 'game2'].forEach(key => {
                const data = gameData[key];
                content.innerHTML += `
                    <div><h3 class="font-bold text-xl mb-2">${data.title}</h3><p class="mb-4">${data.instruction}</p>
                    <table class="w-full border-collapse border border-black mb-6"><thead><tr class="bg-gray-100"><th class="border border-black p-2 text-left">Quote / Description</th><th class="border border-black p-2 text-left">Match (Write Answer)</th></tr></thead><tbody>${data.pairs.map(p => `<tr><td class="border border-black p-3">${p.quote}</td><td class="border border-black p-3"></td></tr>`).join('')}</tbody></table></div>`;
            });
            window.print();
        }

        // --- TOUCH FIX ---
        let draggedElement = null, originalX, originalY, touchStartX, touchStartY;
        function handleTouchStart(e) { draggedElement = e.target.closest('.draggable'); if (!draggedElement) return; const touch = e.touches[0]; touchStartX = touch.clientX; touchStartY = touch.clientY; const rect = draggedElement.getBoundingClientRect(); originalX = rect.left; originalY = rect.top; document.querySelectorAll('.droppable').forEach(d => d.classList.add('drop-active')); draggedElement.style.position = 'fixed'; draggedElement.style.left = originalX + 'px'; draggedElement.style.top = originalY + 'px'; draggedElement.style.width = rect.width + 'px'; draggedElement.style.zIndex = '1000'; draggedElement.style.opacity = '0.9'; }
        function handleTouchMove(e) { if (!draggedElement) return; e.preventDefault(); const touch = e.touches[0]; draggedElement.style.left = (originalX + (touch.clientX - touchStartX)) + 'px'; draggedElement.style.top = (originalY + (touch.clientY - touchStartY)) + 'px'; }
        function handleTouchEnd(e) { if (!draggedElement) return; draggedElement.style.visibility = 'hidden'; const elemBelow = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY); draggedElement.style.visibility = 'visible'; draggedElement.style.position = ''; draggedElement.style.left = ''; draggedElement.style.top = ''; draggedElement.style.width = ''; draggedElement.style.zIndex = ''; draggedElement.style.opacity = ''; document.querySelectorAll('.droppable').forEach(d => d.classList.remove('drop-active')); let targetEl = elemBelow; while (targetEl && !targetEl.classList.contains('droppable')) targetEl = targetEl.parentElement; if (targetEl) { const match = draggedElement.getAttribute('data-match'); const target = targetEl.getAttribute('data-target'); if (match === target) checkMatch(draggedElement, targetEl, target); } draggedElement = null; }

        init();
    </script>
</body>
</html>
