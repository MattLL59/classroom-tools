<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=0.5, maximum-scale=5.0, user-scalable=yes">
    <title>Sting Op: Pro Edition</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tailwindcss/2.2.19/tailwind.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Ops+One&family=Roboto:wght@400;700&family=Courier+Prime&display=swap');

        /* Utility Overrides */
        .hidden { display: none !important; }
        .flex { display: flex !important; }

        body {
            background-color: #111827;
            font-family: 'Roboto', sans-serif;
            color: #e2e8f0;
            overflow-x: auto;
            touch-action: manipulation;
        }

        .stencil-font { font-family: 'Black Ops One', cursive; letter-spacing: 2px; }
        .mono-font { font-family: 'Courier Prime', monospace; }

        .case-file {
            background-color: #f3f4f6;
            color: #1f2937;
            border-top: 12px solid #374151;
            box-shadow: 5px 5px 15px rgba(0,0,0,0.5);
            min-height: 400px;
            position: relative;
        }

        .level-1-theme { border-color: #3b82f6; } 
        .level-2-theme { border-color: #d97706; } 

        .rating-star { cursor: pointer; transition: color 0.2s; color: #d1d5db; }
        .rating-star.active { color: #f59e0b; }
        
        .modal-overlay {
            background: rgba(0,0,0,0.9);
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            z-index: 50;
        }

        .admin-input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.25rem;
            font-size: 0.875rem;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }
        .admin-label {
            display: block;
            font-size: 0.75rem;
            font-weight: bold;
            color: #4b5563;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }
        
        .stamp {
            border: 4px solid #ef4444;
            color: #ef4444;
            font-weight: bold;
            text-transform: uppercase;
            padding: 0.5rem 1rem;
            font-family: 'Black Ops One', cursive;
            transform: rotate(-12deg);
            opacity: 0.9;
            display: inline-block;
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 10;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center">

    <!-- DATA BLOCK: THIS HOLDS YOUR QUESTIONS SECURELY -->
    <script id="mission-config" type="application/json">
    {
        "fileVersion": 1,
        "adminPass": "ChiefInspector",
        "level2Code": "DETECTIVE",
        "caseTitle": "CASE #004: RAMOTSWE",
        "modelText": "Level 1 Model:\nMma Ramotswe shows she is clever by taking control.\n\nLevel 2 Model:\nThe writer uses imperative verbs to show authority.",
        "missionData": [
            {
                "tactic": "She borrows a nurse's uniform and sets off at speed.",
                "method": "Use of props / disguise",
                "analysisL1": "It creates immediate authority, forcing the man to trust her.",
                "analysisL2": "It establishes immediate authority and authenticity, forcing the man to trust her without question.",
                "wrongAnalysis": "It shows she likes dressing up in different clothes."
            },
            {
                "tactic": "She orders him: 'Inside! Four minutes left now!'",
                "method": "Imperative verbs / Countdown",
                "analysisL1": "She takes total control of the situation.",
                "analysisL2": "She takes total control of the situation, leaving him no choice but to obey.",
                "wrongAnalysis": "She is helpful by counting the time for him."
            }
        ]
    }
    </script>

    <!-- Top Bar -->
    <header class="w-full bg-gray-900 p-4 shadow-lg flex justify-between items-center border-b border-gray-700">
        <div class="flex items-center gap-3">
            <i class="fas fa-shield-alt text-3xl text-gray-400" id="badge-icon"></i>
            <div>
                <h1 class="text-xl md:text-2xl stencil-font text-white tracking-widest">OP: STING</h1>
                <p class="text-xs text-gray-500 font-mono" id="clearance-level">CLEARANCE: LEVEL 1 (CONSTABLE)</p>
            </div>
        </div>
        <div class="flex gap-2">
            <button onclick="toggleModal('models-modal')" class="bg-gray-700 hover:bg-gray-600 px-3 py-1 rounded text-xs md:text-sm font-bold border border-gray-500">
                <i class="fas fa-book-open mr-1"></i> MODEL ANSWERS
            </button>
            <button onclick="toggleModal('admin-modal')" class="text-gray-600 hover:text-gray-400 px-2">
                <i class="fas fa-cog"></i>
            </button>
        </div>
    </header>

    <!-- Main Game Container -->
    <main class="w-full max-w-4xl flex-grow p-4 relative">

        <!-- START SCREEN -->
        <div id="screen-start" class="flex flex-col items-center justify-center h-full pt-10">
            <div class="bg-gray-800 p-8 rounded-lg border-2 border-gray-700 max-w-lg w-full text-center shadow-2xl">
                <!-- DYNAMIC CASE TITLE -->
                <h2 id="case-title" class="text-3xl font-bold mb-2 text-white">CASE #004</h2>
                <p class="text-gray-400 mb-6 text-sm">EVALUATION PROTOCOL</p>
                
                <div class="space-y-4">
                    <button onclick="startNewSession()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded text-lg shadow-lg transition transform hover:scale-105">
                        <i class="fas fa-play mr-2"></i> START NEW OPERATION
                    </button>
                    
                    <button id="resume-btn" onclick="resumeSession()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 rounded text-lg shadow-lg hidden">
                        <i class="fas fa-save mr-2"></i> RESUME PROGRESS
                    </button>
                </div>
                
                <p class="mt-6 text-xs text-gray-500">
                    STATUS: <span id="save-status">Ready.</span>
                </p>
            </div>
        </div>

        <!-- GAME SCREEN -->
        <div id="screen-game" class="hidden flex flex-col md:flex-row gap-4 h-full">
            <!-- LEFT: The Evidence File -->
            <div class="w-full md:w-1/2">
                <div id="case-file-ui" class="case-file level-1-theme p-6 rounded-b">
                    <div class="flex justify-between mb-4">
                        <span class="bg-gray-800 text-white px-2 py-1 text-xs font-mono rounded">EVIDENCE ITEM #<span id="evidence-id">1</span></span>
                        <span id="method-tag" class="hidden bg-amber-100 text-amber-800 px-2 py-1 text-xs font-bold border border-amber-300 rounded">METHOD REVEALED</span>
                    </div>
                    <div class="mb-6">
                        <h3 class="text-xs font-bold text-gray-500 uppercase tracking-widest mb-1">WHAT HAPPENED? (EVIDENCE)</h3>
                        <p id="tactic-text" class="text-lg md:text-xl font-serif text-gray-900 leading-relaxed p-2 bg-white border border-gray-300 shadow-inner">...</p>
                    </div>
                    <!-- Method Section (Hidden in Level 1) -->
                    <div id="method-section" class="mb-6 hidden">
                        <h3 class="text-xs font-bold text-amber-600 uppercase tracking-widest mb-1">WRITER'S METHOD:</h3>
                        <p id="method-text" class="text-md font-bold text-indigo-900 border-l-4 border-indigo-500 pl-3">...</p>
                    </div>
                    <!-- Rating Section -->
                    <div id="rating-section" class="mt-auto border-t border-gray-300 pt-4 opacity-50 pointer-events-none transition-opacity">
                        <p class="text-xs font-bold text-gray-500 mb-2">JUDGE EFFECTIVENESS:</p>
                        <div class="flex space-x-1 text-3xl justify-center">
                             <i class="fas fa-star rating-star" onclick="submitRating(1)"></i>
                             <i class="fas fa-star rating-star" onclick="submitRating(2)"></i>
                             <i class="fas fa-star rating-star" onclick="submitRating(3)"></i>
                             <i class="fas fa-star rating-star" onclick="submitRating(4)"></i>
                             <i class="fas fa-star rating-star" onclick="submitRating(5)"></i>
                        </div>
                    </div>
                </div>
            </div>
            <!-- RIGHT: The Analysis Selector -->
            <div class="w-full md:w-1/2 flex flex-col gap-4">
                <div class="bg-gray-800 p-4 rounded border border-gray-600 flex-grow">
                    <h3 id="right-panel-title" class="text-blue-400 font-bold mb-4 text-sm uppercase border-b border-gray-700 pb-2">
                        <i class="fas fa-search mr-2"></i> Make a Point (What does this show?)
                    </h3>
                    <div id="options-container" class="space-y-3"></div>
                </div>
                <div id="feedback-box" class="h-12 bg-gray-900 rounded border border-gray-700 flex items-center justify-center text-sm font-bold text-gray-500">
                    WAITING FOR INPUT...
                </div>
            </div>
        </div>

        <!-- LEVEL UP SCREEN -->
        <div id="screen-levelup" class="hidden flex flex-col pt-4 h-full">
            <div class="bg-gray-800 p-6 rounded border-2 border-blue-500 text-center w-full shadow-2xl flex flex-col md:flex-row gap-6">
                <!-- Left: Draft -->
                <div class="w-full md:w-2/3 text-left">
                    <h2 class="text-2xl font-bold text-white mb-2">LEVEL 1 DEBRIEF</h2>
                    <p class="text-gray-400 text-sm mb-4">You have collected the evidence. Use the draft below to write your basic answer.</p>
                    <div class="bg-white text-black p-4 rounded h-64 overflow-y-auto font-mono text-sm border border-gray-500 mb-4" id="level1-report-preview"></div>
                    <button onclick="toggleModal('models-modal')" class="w-full bg-blue-700 hover:bg-blue-600 text-white font-bold py-2 rounded text-sm mb-2">
                        <i class="fas fa-search mr-2"></i> COMPARE WITH MODEL ANSWER
                    </button>
                </div>
                <!-- Right: Unlock -->
                <div class="w-full md:w-1/3 bg-gray-900 p-4 rounded border border-gray-700 flex flex-col justify-center">
                    <i class="fas fa-lock text-4xl text-amber-500 mb-4 mx-auto"></i>
                    <h3 class="text-lg font-bold text-amber-500 mb-2 uppercase">Promotion Protocol</h3>
                    <p class="text-gray-500 text-xs mb-4">Enter authorization code to access Advanced Writer's Methods.</p>
                    <input type="text" id="passcode-input" placeholder="ENTER CODE" class="w-full bg-black text-white p-3 text-center text-xl tracking-widest font-mono border border-gray-600 rounded mb-4 uppercase">
                    <button onclick="checkPasscode()" class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3 rounded mb-2">AUTHORIZE LEVEL 2</button>
                    <p id="passcode-error" class="text-red-500 text-xs hidden">INVALID AUTHORIZATION CODE</p>
                </div>
            </div>
        </div>

        <!-- FINAL REPORT SCREEN -->
        <div id="screen-report" class="hidden bg-white text-gray-900 p-6 rounded shadow-2xl min-h-[500px] relative">
            <div class="absolute top-4 right-4 stamp">CASE CLOSED</div>
            <h2 class="text-2xl font-bold mb-4 border-b-2 border-black pb-2">FINAL DEBRIEF LOG (ADVANCED)</h2>
            <div class="bg-blue-50 p-3 rounded text-sm mb-4 border border-blue-200">
                <strong>INSTRUCTION:</strong> These findings include Writer's Methods. Use them to write your full 10-mark response.
            </div>
            <div id="report-content" class="space-y-4 h-96 overflow-y-auto pr-2 font-mono text-sm"></div>
            <div class="mt-4 flex gap-2">
                 <button onclick="restartLevel2()" class="flex-1 bg-amber-100 hover:bg-amber-200 text-amber-900 py-2 rounded font-bold text-sm border border-amber-300">
                    <i class="fas fa-redo mr-1"></i> REPLAY CASE (LEVEL 2)
                </button>
                 <button onclick="clearSaveData()" class="flex-1 bg-red-100 hover:bg-red-200 text-red-800 py-2 rounded font-bold text-sm">
                    DELETE SAVE
                </button>
            </div>
        </div>
    </main>

    <!-- ADMIN MODAL -->
    <div id="admin-modal" class="hidden modal-overlay justify-center items-center">
        <div class="bg-white text-black p-6 rounded-lg w-full max-w-4xl h-5/6 overflow-y-auto relative shadow-2xl">
            <button onclick="toggleModal('admin-modal')" class="absolute top-4 right-4 text-xl font-bold hover:text-red-500">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b pb-2">Chief Inspector Admin Panel</h2>

            <!-- LOGIN -->
            <div id="editor-lock-screen" class="text-center py-10">
                <h3 class="font-bold text-lg mb-2 text-red-700 uppercase"><i class="fas fa-lock mr-2"></i> Restricted Access</h3>
                <div id="default-pass-alert" class="bg-yellow-100 text-yellow-800 p-2 rounded text-xs mb-4 inline-block hidden">
                    <i class="fas fa-exclamation-triangle mr-1"></i> Default Password: <strong>ChiefInspector</strong>
                </div>
                <input type="password" id="admin-password-input" class="border-2 border-gray-300 p-3 rounded text-lg w-64 mx-auto block mb-4 text-center" placeholder="Password" autocomplete="new-password">
                <button onclick="unlockEditor()" class="bg-red-600 text-white px-6 py-2 rounded font-bold hover:bg-red-700 transition">UNLOCK PANEL</button>
                <p id="admin-auth-error" class="text-red-600 text-sm font-bold mt-4 hidden">Access Denied.</p>
            </div>

            <!-- EDITOR -->
            <div id="editor-unlocked-screen" class="hidden">
                <!-- Settings -->
                <div class="bg-yellow-50 border border-yellow-200 p-4 rounded mb-6 flex flex-col md:flex-row gap-4">
                    <div class="flex-1">
                        <label class="admin-label">Admin Password</label>
                        <input type="text" id="new-admin-pass" class="admin-input border-yellow-300" autocomplete="off">
                    </div>
                    <div class="flex-1">
                        <label class="admin-label">Level 2 Unlock Code</label>
                        <input type="text" id="new-level2-code" class="admin-input border-yellow-300" autocomplete="off">
                    </div>
                    <div class="flex items-end">
                        <button onclick="saveSecuritySettings()" class="bg-yellow-600 text-white px-4 py-2 rounded font-bold text-sm hover:bg-yellow-700 h-10 w-full">UPDATE CODES</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-6">
                    <div class="md:col-span-1">
                        <label class="admin-label">Case Title</label>
                        <input type="text" id="edit-case-title" class="admin-input" autocomplete="off">
                    </div>
                    <div class="md:col-span-2">
                        <label class="admin-label">Model Answers Text</label>
                        <textarea id="edit-model-answers" class="admin-input h-20 bg-white border border-gray-300 p-2"></textarea>
                    </div>
                </div>

                <div class="border-t-4 border-blue-500 pt-4 bg-gray-50 p-4 rounded">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="font-bold text-lg text-blue-800">Mission Questions Editor</h3>
                        <button onclick="addNewQuestion()" class="bg-green-600 text-white px-3 py-1 rounded text-sm font-bold hover:bg-green-700">+ ADD QUESTION</button>
                    </div>
                    <div id="visual-editor-container" class="space-y-6"></div>
                </div>

                <div class="mt-6 flex flex-col md:flex-row justify-between border-t pt-4 gap-4">
                    <button onclick="resetToDefaults()" class="text-red-500 text-sm font-bold hover:text-red-700">RESET DEFAULTS</button>
                    <div class="flex gap-4">
                        <button onclick="copySourceCode()" class="bg-gray-800 text-white px-6 py-3 rounded font-bold text-lg shadow-lg hover:bg-gray-900 transition flex items-center gap-2">
                            <i class="fas fa-copy"></i> COPY SOURCE
                        </button>
                        <button onclick="exportStandaloneFile()" class="bg-purple-700 text-white px-6 py-3 rounded font-bold text-lg shadow-lg hover:bg-purple-800 transition flex items-center gap-2">
                            <i class="fas fa-file-download"></i> DOWNLOAD FILE
                        </button>
                        <button onclick="saveAllChanges(true)" class="bg-blue-600 text-white px-8 py-3 rounded font-bold text-lg shadow-lg hover:bg-blue-700 transition">
                            <i class="fas fa-save mr-2"></i> APPLY (PREVIEW)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODEL VIEW -->
    <div id="models-modal" class="hidden modal-overlay justify-center items-center">
         <div class="bg-white text-black p-8 rounded-lg w-full max-w-2xl max-h-[80vh] overflow-y-auto relative border-4 border-gray-800">
            <button onclick="toggleModal('models-modal')" class="absolute top-4 right-4 text-gray-500 hover:text-black text-2xl font-bold">&times;</button>
            <h2 class="text-2xl font-bold mb-4 text-gray-800 border-b-2 border-gray-300 pb-2">ðŸ“‚ MODEL ANSWERS</h2>
            <div id="model-content-display" class="prose text-sm leading-relaxed text-gray-700 whitespace-pre-wrap">Loading...</div>
         </div>
    </div>

    <script>
        // --- SAFE STORAGE ---
        const SafeStorage = {
            getItem: (key) => { try { return localStorage.getItem(key); } catch(e) { return null; } },
            setItem: (key, val) => { try { localStorage.setItem(key, val); } catch(e) {} },
            removeItem: (key) => { try { localStorage.removeItem(key); } catch(e) {} }
        };

        // --- CONFIG & STATE ---
        let appConfig;
        
        try {
            // LOAD CONFIG FROM SCRIPT TAG
            const scriptContent = document.getElementById('mission-config').textContent;
            appConfig = JSON.parse(scriptContent);
            
            // VERSION CHECK: If File ID is newer, use File. Else check local.
            // NOTE: We prioritize the file content to fix the "not saving" bug.
            // LocalStorage logic is stripped back to just student progress.
            
        } catch (e) {
            console.error("Config Error", e);
            appConfig = { missionData: [] };
        }

        let playerState = { currentLevel: 1, currentIndex: 0, log: [] };
        let selectedOption = null;

        // --- INIT ---
        window.onload = function() {
            document.getElementById('case-title').innerText = appConfig.caseTitle;
            document.getElementById('model-content-display').innerText = appConfig.modelText;
            
            if (SafeStorage.getItem('stingOpProgress')) {
                document.getElementById('resume-btn').classList.remove('hidden');
                document.getElementById('save-status').innerText = "Progress found.";
                document.getElementById('save-status').className = "text-green-400 font-bold";
            }
        };

        // --- ROBUST EXPORT LOGIC ---
        function exportStandaloneFile() {
            // 1. Gather all current state from UI inputs
            collectConfigFromUI();
            
            // 2. STAMP IT: Update file version
            appConfig.fileVersion = Date.now();
            
            // 3. Inject into DOM before snapshot
            const configScript = document.getElementById('mission-config');
            configScript.textContent = JSON.stringify(appConfig, null, 4);
            
            // 4. Clean UI
            cleanUIForExport();

            // 5. Download
            const htmlContent = document.documentElement.outerHTML;
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const safeTitle = appConfig.caseTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            a.href = url;
            a.download = `sting_op_${safeTitle}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            
            alert("File Exported Successfully.\n\nTip: The downloaded file contains your new questions and is ready to use.");
            location.reload(); 
        }

        function copySourceCode() {
            collectConfigFromUI();
            appConfig.fileVersion = Date.now();
            document.getElementById('mission-config').textContent = JSON.stringify(appConfig, null, 4);
            cleanUIForExport();
            
            const htmlContent = document.documentElement.outerHTML;
            const textArea = document.createElement("textarea");
            textArea.value = htmlContent;
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                alert("Source Code Copied! Paste into your editor and save.");
            } catch (err) {
                prompt("Copy failed. Manually copy:", htmlContent);
            }
            document.body.removeChild(textArea);
            location.reload(); 
        }

        function cleanUIForExport() {
            document.querySelectorAll('.modal-overlay').forEach(el => { el.classList.add('hidden'); el.classList.remove('flex'); });
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-levelup').classList.add('hidden');
            document.getElementById('screen-report').classList.add('hidden');
            document.getElementById('screen-start').classList.remove('hidden');
            document.getElementById('admin-password-input').value = "";
            document.getElementById('editor-lock-screen').classList.remove('hidden');
            document.getElementById('editor-unlocked-screen').classList.add('hidden');
        }

        // --- DATA COLLECTION ---
        function collectConfigFromUI() {
            // Only collect if admin panel is actually open/unlocked
            const adminPanel = document.getElementById('editor-unlocked-screen');
            if (adminPanel.classList.contains('hidden')) return;

            appConfig.caseTitle = document.getElementById('edit-case-title').value.trim();
            appConfig.modelText = document.getElementById('edit-model-answers').value;
            appConfig.adminPass = document.getElementById('new-admin-pass').value.trim();
            appConfig.level2Code = document.getElementById('new-level2-code').value.trim();

            const qContainer = document.getElementById('visual-editor-container');
            const newQuestions = [];
            if (qContainer) {
                Array.from(qContainer.children).forEach(row => {
                    newQuestions.push({
                        tactic: row.querySelector('.q-tactic').value,
                        method: row.querySelector('.q-method').value,
                        analysisL1: row.querySelector('.q-analysisL1').value,
                        analysisL2: row.querySelector('.q-analysisL2').value,
                        wrongAnalysis: row.querySelector('.q-wrong').value
                    });
                });
            }
            if(newQuestions.length > 0) appConfig.missionData = newQuestions.filter(q => q.tactic.trim() !== "");
        }

        // --- GAME LOGIC ---
        function launchGame() {
            document.getElementById('screen-start').classList.add('hidden');
            if (playerState.currentIndex >= appConfig.missionData.length) {
                if (playerState.currentLevel === 1) showLevelUpScreen();
                else showReport();
            } else {
                document.getElementById('screen-game').classList.remove('hidden');
                updateUITheme();
                loadCard();
            }
        }

        function loadCard() {
            if (!appConfig.missionData[playerState.currentIndex]) playerState.currentIndex = 0;
            const data = appConfig.missionData[playerState.currentIndex];
            
            document.getElementById('evidence-id').innerText = playerState.currentIndex + 1;
            document.getElementById('tactic-text').innerText = `"${data.tactic}"`;
            document.getElementById('method-text').innerText = data.method;
            
            document.getElementById('rating-section').style.opacity = '0.5';
            document.getElementById('rating-section').classList.add('pointer-events-none');
            document.querySelectorAll('.rating-star').forEach(s => s.classList.remove('active'));
            selectedOption = null;

            const container = document.getElementById('options-container');
            container.innerHTML = '';
            const correctText = playerState.currentLevel === 1 ? data.analysisL1 : data.analysisL2;
            
            const opts = [
                { text: correctText, correct: true },
                { text: data.wrongAnalysis, correct: false }
            ].sort(() => Math.random() - 0.5);

            opts.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "w-full text-left p-3 rounded bg-gray-700 hover:bg-gray-600 border border-gray-600 text-sm transition option-btn";
                btn.innerText = opt.text;
                btn.onclick = () => selectAnalysis(opt.correct, data, btn, correctText);
                container.appendChild(btn);
            });

            document.getElementById('feedback-box').innerText = playerState.currentLevel === 1 ? "SELECT THE POINT" : "SELECT BEST ANALYSIS";
            document.getElementById('feedback-box').className = "h-12 bg-gray-900 rounded border border-gray-700 flex items-center justify-center text-sm font-bold text-gray-500";
        }

        function selectAnalysis(isCorrect, data, btn, analysisText) {
            if (selectedOption) return;
            if (isCorrect) {
                btn.classList.replace('bg-gray-700', 'bg-green-700');
                btn.classList.replace('border-gray-600', 'border-green-500');
                document.getElementById('feedback-box').innerText = "CORRECT. RATE EFFECTIVENESS.";
                document.getElementById('feedback-box').className = "h-12 bg-green-900 rounded border border-green-700 flex items-center justify-center text-sm font-bold text-green-400";
                document.getElementById('rating-section').style.opacity = '1';
                document.getElementById('rating-section').classList.remove('pointer-events-none');
                selectedOption = { data: data, analysis: analysisText };
            } else {
                btn.classList.replace('bg-gray-700', 'bg-red-900');
                btn.classList.replace('border-gray-600', 'border-red-700');
                document.getElementById('feedback-box').innerText = "TRY AGAIN.";
                document.getElementById('feedback-box').className = "h-12 bg-red-900 rounded border border-red-700 flex items-center justify-center text-sm font-bold text-red-400";
            }
        }

        function submitRating(stars) {
            document.querySelectorAll('.rating-star').forEach((s, i) => {
                if (i < stars) s.classList.add('active'); else s.classList.remove('active');
            });
            playerState.log.push({
                level: playerState.currentLevel,
                tactic: selectedOption.data.tactic,
                method: selectedOption.data.method,
                analysis: selectedOption.analysis,
                rating: stars
            });
            playerState.currentIndex++;
            SafeStorage.setItem('stingOpProgress', JSON.stringify(playerState));
            setTimeout(() => {
                if (playerState.currentIndex >= appConfig.missionData.length) {
                    if (playerState.currentLevel === 1) showLevelUpScreen(); else showReport();
                } else {
                    loadCard();
                }
            }, 800);
        }

        function updateUITheme() {
            const file = document.getElementById('case-file-ui');
            const badge = document.getElementById('badge-icon');
            const clearance = document.getElementById('clearance-level');
            const rightTitle = document.getElementById('right-panel-title');

            if (playerState.currentLevel === 1) {
                file.className = "case-file level-1-theme p-6 rounded-b";
                badge.className = "fas fa-shield-alt text-3xl text-blue-500";
                clearance.innerText = "CLEARANCE: LEVEL 1 (CONSTABLE)";
                clearance.className = "text-xs text-blue-400 font-mono";
                document.getElementById('method-section').classList.add('hidden');
                document.getElementById('method-tag').classList.add('hidden');
                rightTitle.innerHTML = '<i class="fas fa-search mr-2"></i> Make a Point (What does this show?)';
            } else {
                file.className = "case-file level-2-theme p-6 rounded-b";
                badge.className = "fas fa-user-secret text-3xl text-amber-500";
                clearance.innerText = "CLEARANCE: LEVEL 2 (DETECTIVE)";
                clearance.className = "text-xs text-amber-500 font-mono";
                document.getElementById('method-section').classList.remove('hidden');
                document.getElementById('method-tag').classList.remove('hidden');
                rightTitle.innerHTML = '<i class="fas fa-microscope mr-2"></i> Why is this effective?';
            }
        }

        // --- SCREENS ---
        function showLevelUpScreen() {
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-levelup').classList.remove('hidden');
            const container = document.getElementById('level1-report-preview');
            container.innerHTML = '';
            playerState.log.forEach((entry, i) => {
                container.innerHTML += `<div class="mb-4 border-b border-gray-300 pb-2"><strong>${i+1}. Point:</strong> ${entry.analysis}<br><strong>Evidence:</strong> "${entry.tactic}"</div>`;
            });
        }

        function showReport() {
            document.getElementById('screen-game').classList.add('hidden');
            document.getElementById('screen-levelup').classList.add('hidden');
            document.getElementById('screen-report').classList.remove('hidden');
            const container = document.getElementById('report-content');
            container.innerHTML = '';
            playerState.log.forEach((entry, i) => {
                const methodLine = entry.method ? `<strong>Method:</strong> The writer uses ${entry.method.toLowerCase()}.<br>` : '';
                container.innerHTML += `<div class="mb-4 border-b border-gray-200 pb-2"><strong>${i+1}. Point:</strong> ${entry.analysis}<br>${methodLine}<strong>Evidence:</strong> This is shown when "${entry.tactic}".<br><em>(Effectiveness: ${entry.rating}/5 stars)</em></div>`;
            });
        }

        // --- AUTH & ADMIN ---
        function checkPasscode() {
            if (document.getElementById('passcode-input').value.toUpperCase() === appConfig.level2Code.toUpperCase()) {
                playerState.currentLevel = 2;
                SafeStorage.setItem('stingOpProgress', JSON.stringify(playerState));
                document.getElementById('screen-levelup').classList.add('hidden');
                showReport();
            } else {
                document.getElementById('passcode-error').classList.remove('hidden');
            }
        }

        function restartLevel2() {
            if(confirm("Replay the case to practice finding methods?")) {
                playerState.currentIndex = 0; playerState.log = []; 
                SafeStorage.setItem('stingOpProgress', JSON.stringify(playerState));
                document.getElementById('screen-report').classList.add('hidden');
                launchGame();
            }
        }

        function toggleModal(id) {
            const m = document.getElementById(id);
            if(m.classList.contains('hidden')) { 
                m.classList.remove('hidden'); m.classList.add('flex'); 
                if (id === 'admin-modal') {
                     const hint = document.getElementById('default-pass-alert');
                     if(appConfig.adminPass === "ChiefInspector") hint.classList.remove('hidden');
                     else hint.classList.add('hidden');
                }
            } else { 
                m.classList.add('hidden'); m.classList.remove('flex');
                if (id === 'admin-modal') {
                    document.getElementById('editor-lock-screen').classList.remove('hidden');
                    document.getElementById('editor-unlocked-screen').classList.add('hidden');
                    document.getElementById('admin-password-input').value = "";
                }
            }
        }

        function unlockEditor() {
            if (document.getElementById('admin-password-input').value === appConfig.adminPass) {
                document.getElementById('editor-lock-screen').classList.add('hidden');
                document.getElementById('editor-unlocked-screen').classList.remove('hidden');
                renderAdminUI();
            } else {
                document.getElementById('admin-auth-error').classList.remove('hidden');
            }
        }

        function renderAdminUI() {
            document.getElementById('new-admin-pass').value = appConfig.adminPass;
            document.getElementById('new-level2-code').value = appConfig.level2Code;
            document.getElementById('edit-case-title').value = appConfig.caseTitle;
            document.getElementById('edit-model-answers').value = appConfig.modelText;

            const container = document.getElementById('visual-editor-container');
            container.innerHTML = '';
            appConfig.missionData.forEach((item, index) => {
                const el = document.createElement('div');
                el.className = "bg-white border p-4 rounded shadow-sm relative group";
                el.innerHTML = `
                    <div class="absolute top-2 right-2 cursor-pointer text-red-400 hover:text-red-600 font-bold px-2" onclick="deleteQuestion(${index})">&times;</div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div><label class="admin-label">Evidence / Tactic</label><input type="text" class="admin-input q-tactic" value="${item.tactic.replace(/"/g, '&quot;')}"></div>
                        <div><label class="admin-label">Writer's Method</label><input type="text" class="admin-input q-method" value="${item.method.replace(/"/g, '&quot;')}"></div>
                        <div><label class="admin-label text-blue-600">L1 Analysis (Simple)</label><textarea class="admin-input h-16 q-analysisL1">${item.analysisL1 || ''}</textarea></div>
                        <div><label class="admin-label text-amber-600">L2 Analysis (Advanced)</label><textarea class="admin-input h-16 q-analysisL2">${item.analysisL2 || ''}</textarea></div>
                        <div class="md:col-span-2"><label class="admin-label text-red-600">Wrong Analysis</label><textarea class="admin-input h-12 q-wrong">${item.wrongAnalysis}</textarea></div>
                    </div>
                `;
                container.appendChild(el);
            });
        }

        // --- HANDLERS ---
        function addNewQuestion() {
            collectConfigFromUI();
            appConfig.missionData.push({ tactic: "", method: "", analysisL1: "", analysisL2: "", wrongAnalysis: "" });
            renderAdminUI();
        }

        function deleteQuestion(index) {
            if(confirm("Delete this question?")) {
                collectConfigFromUI();
                appConfig.missionData.splice(index, 1);
                renderAdminUI();
            }
        }

        function saveSecuritySettings() {
            collectConfigFromUI();
            alert("Security Codes Cached (Click Apply/Save to finalize).");
        }

        function saveAllChanges(reload = true) {
            collectConfigFromUI();
            // Just reload to apply to the current view (since we aren't using local storage for config anymore)
            if(reload) { 
                alert("Preview Applied! To keep these changes permanently, click DOWNLOAD FILE."); 
                // We don't reload because that would reset to the hardcoded values!
                // Instead we re-init the UI with the new memory state
                document.getElementById('case-title').innerText = appConfig.caseTitle;
                document.getElementById('model-content-display').innerText = appConfig.modelText;
                toggleModal('admin-modal');
            }
        }

        function resetToDefaults() {
            if(confirm("Reset everything?")) { location.reload(); }
        }

        function startNewSession() { SafeStorage.removeItem('stingOpProgress'); playerState = {currentLevel: 1, currentIndex: 0, log: []}; launchGame(); }
        function resumeSession() { const s = SafeStorage.getItem('stingOpProgress'); if(s) { playerState = JSON.parse(s); launchGame(); } }
        function clearSaveData() { SafeStorage.removeItem('stingOpProgress'); location.reload(); }
    </script>
</body>
</html>
