<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes"> 
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Story Starter Pro</title>
    
    <link rel="icon" type="image/png" href="https://img.icons8.com/color/96/books.png">
    <link rel="apple-touch-icon" href="https://img.icons8.com/color/180/books.png">
    <!-- FontAwesome for Admin Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* --- GENERAL STYLES & WALLPAPER --- */
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            height: 100vh; 
            display: flex;
            flex-direction: row;
            background-color: #1a3c2a;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='100' height='100' viewBox='0 0 100 100'%3E%3Cg fill='%232a5c4a' opacity='0.5'%3E%3Ctext x='10' y='20' font-family='Georgia, serif' font-size='20'%3E?%3C/text%3E%3Ctext x='60' y='30' font-family='Georgia, serif' font-size='24'%3E!%3C/text%3E%3Ctext x='30' y='60' font-family='Georgia, serif' font-size='22'%3E;%3C/text%3E%3Ctext x='80' y='70' font-family='Georgia, serif' font-size='20'%3E.%3C/text%3E%3Ctext x='40' y='90' font-family='Georgia, serif' font-size='18'%3E,%3C/text%3E%3C/g%3E%3C/svg%3E");
        }

        /* --- LEFT SIDEBAR (SCENE REFERENCE) --- */
        .sidebar {
            width: 350px;
            flex-shrink: 0;
            background-color: rgba(249, 249, 249, 0.92);
            border-right: 2px solid rgba(0,0,0,0.1);
            padding: 20px;
            overflow-y: auto;
            order: 0; 
            display: flex;
            flex-direction: column;
        }
        .sidebar h2 { color: #1a3c2a; margin-top: 0; border-bottom: 2px solid #0056b3; padding-bottom: 10px;}
        .instructions { color: #555; font-style: italic; margin-bottom: 20px;}
        .scene-card { background: #fff; border-left: 5px solid #0056b3; padding: 15px; margin-bottom: 15px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .scene-title { font-weight: bold; font-size: 15px; color: #0056b3; margin-bottom: 5px; }
        .scene-text { font-size: 13px; color: #444; line-height: 1.4;}

        /* --- MAIN CONTENT AREA --- */
        .main-content {
            flex-grow: 1;
            display: flex;
            background-color: transparent; 
            overflow: hidden;
            position: relative;
            order: 1;
        }

        /* --- WHEEL CONTAINER --- */
        .wheel-container {
            width: 50%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background-color: rgba(255, 255, 255, 0.95);
            border-right: 1px solid #eee;
            position: relative; 
            padding-top: 50px;
        }

        /* --- RIGHT PANEL --- */
        #right-panel {
            width: 50%;
            padding: 20px 30px;
            display: flex;
            flex-direction: column;
            overflow-y: auto; 
            background-color: rgba(255, 255, 255, 0.95);
        }

        /* Output Box */
        .output-box {
            background-color: #fff;
            border: 1px solid #ddd;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        .output-box h3 { 
            color: #d9534f;
            margin-top: 0;
            font-size: 1.4em;
            border-bottom: 2px solid #d9534f;
            padding-bottom: 5px;
            margin-bottom: 15px;
        }
        .output-box strong { color: #0056b3; display: block; margin-bottom: 8px; font-size: 1.1em;}
        .output-suggestion { font-size: 14px; line-height: 1.6; margin-bottom: 10px; padding-left: 10px; border-left: 3px solid #eee; }

        /* Writing Editor */
        .editor-container {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 15px;
            min-height: 300px;
        }
        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }
        .editor-title { font-weight: bold; color: #333; }
        textarea {
            width: 100%;
            flex-grow: 1;
            border: 1px solid #eee;
            padding: 10px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 14px;
            resize: none;
            outline: none;
            background-color: #fafafa;
        }
        textarea:focus { background-color: #fff; border-color: #0056b3; }

        .save-btn-group { display: flex; gap: 5px; }
        .btn-save { padding: 5px 10px; font-size: 12px; background-color: #28a745; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .btn-save:hover { background-color: #218838; }
        .btn-save.blue { background-color: #0056b3; }
        .btn-save.blue:hover { background-color: #004494; }
        .btn-save.red { background-color: #d9534f; }
        .btn-save.red:hover { background-color: #c9302c; }

        /* --- RINGS --- */
        .ring {
            position: absolute; border-radius: 50%; border: 4px solid #fff; box-shadow: 0 5px 15px rgba(0,0,0,0.2); transition: transform 0.3s cubic-bezier(0.25, 0.1, 0.25, 1);
        }
        
        #outer-ring { width: 480px; height: 480px; background-color: #0056b3; z-index: 1; }
        #inner-ring { width: 320px; height: 320px; background-color: #d9534f; z-index: 2; }

        .ring-spoke { 
            position: absolute; height: 50%; top: 0; left: 50%; width: 0; 
            transform-origin: bottom center; pointer-events: none; 
        }
        .text-label { 
            position: absolute; 
            top: 15px; 
            left: -90px; 
            width: 180px; 
            text-align: center; 
            color: white; 
            font-weight: bold; 
            font-size: 11px; 
            text-transform: uppercase; 
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5); 
            line-height: 1.2;
        }
        
        .arrow { 
            position: absolute; 
            top: -25px; 
            left: 50%;
            transform: translateX(-50%);
            z-index: 10; 
            border-left: 20px solid transparent; 
            border-right: 20px solid transparent; 
            border-top: 30px solid #333; 
        }

        /* CONTROLS */
        .controls-area { margin-top: 520px; display: flex; gap: 20px; z-index: 20; position: relative; }
        .control-group { text-align: center; background: #f0f0f0; padding: 10px; border-radius: 8px; border: 1px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.1);}
        .wheel-btn { padding: 8px 15px; font-size: 16px; cursor: pointer; background-color: #fff; border: 1px solid #999; border-radius: 4px; }
        .wheel-btn:hover { background-color: #e2e6ea; }
        .lbl { font-size: 12px; font-weight: bold; margin-bottom: 5px; display: block; color: #333; text-transform: uppercase;}
        .lbl.blue { color: #0056b3; }
        .lbl.red { color: #d9534f; }

        /* ADMIN BUTTON (ENLARGED) */
        .admin-trigger {
            margin-top: auto;
            background-color: #e2e8f0; 
            color: #4b5563; 
            border: 1px solid #cbd5e1;
            cursor: pointer; 
            font-size: 14px;
            font-weight: bold;
            padding: 12px;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.2s;
        }
        .admin-trigger:hover { 
            background-color: #cbd5e1; 
            color: #1f2937;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* --- ADMIN MODAL STYLES --- */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 100;
            justify-content: center; align-items: center;
        }
        .modal-content {
            background: #fff; width: 90%; max-width: 800px; height: 90%;
            border-radius: 8px; display: flex; flex-direction: column;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .modal-header { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; background: #f8f9fa; border-radius: 8px 8px 0 0; }
        .modal-body { padding: 20px; overflow-y: auto; flex-grow: 1; }
        .modal-footer { padding: 15px; border-top: 1px solid #eee; background: #f8f9fa; border-radius: 0 0 8px 8px; display: flex; justify-content: space-between; }
        
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-weight: bold; font-size: 12px; margin-bottom: 5px; color: #555; text-transform: uppercase; }
        .form-input { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .form-textarea { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; height: 80px; resize: vertical; }
        
        .btn-primary { background: #0056b3; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-success { background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-danger { background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        .btn-secondary { background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        /* Responsive */
        @media (max-width: 900px) {
            body { flex-direction: column; height: auto; overflow-y: auto; }
            .main-content { flex-direction: column; overflow: visible; height: auto; order: 1; }
            .sidebar { display: block; width: 100%; height: auto; order: 2; border-right: none; border-top: 2px solid #ddd; }
            .wheel-container { width: 100%; min-height: 450px; padding-top: 50px; padding-bottom: 20px; border-right: none; border-bottom: 1px solid #eee; }
            #right-panel { width: 100%; height: auto; overflow: visible; }
            #outer-ring { width: 310px; height: 310px; }
            #inner-ring { width: 210px; height: 210px; }
            .controls-area { margin-top: 350px; gap: 10px; }
            .text-label { font-size: 9px; width: 120px; left: -60px; top: 10px; }
        }
    </style>
</head>
<body>

    <!-- CONFIGURATION BLOCK -->
    <script id="app-config" type="application/json">
    {
        "adminPass": "ChiefInspector",
        "appTitle": "Story Starter",
        "scenesData": [
            { "id": 0, "title": "Thriller: The Ledge", "synopsis": "A narrow ledge... Someone moves gingerly, back against the wall, eyes trying not to look down..." },
            { "id": 1, "title": "Western: Saloon", "synopsis": "A western saloon. Piano tinkling. Cowhands drinking. A stranger appears at the swing door..." },
            { "id": 2, "title": "Horror: Bedroom Visitor", "synopsis": "A bedroom at night, full moon. A young person sleeping. A figure appears beside the bed, leans over..." },
            { "id": 3, "title": "Sports: The Final Kick", "synopsis": "A penalty shootout. Final kick. The player places the ball. Looks at the keeper. Begins run..." },
            { "id": 4, "title": "Mystery: Manor Break-in", "synopsis": "Night. An old country house. A figure climbs ivy to a balcony. Flash of a blade, window prised open..." },
            { "id": 5, "title": "Crime: Airport Handoff", "synopsis": "Airport lockers. A person approaches furtively, opens a locker, removes a briefcase. From behind, a gun pressed into ribs..." },
            { "id": 6, "title": "Action: The Wire Fence", "synopsis": "Night. A figure crawls to a barbed wire fence. Whistles softly. Joined by a second figure. They begin to cut the wire." },
            { "id": 7, "title": "Drama: Schoolyard Hide", "synopsis": "School yard at night. Caretaker doing rounds. Shadowy figures dodge and hide. They approach a window..." }
        ],
        "planningCategories": [
            { "label": "WHO?", "full": "Character Archetype" },
            { "label": "WHY?", "full": "Motivation / Goal" },
            { "label": "WHAT NEXT?", "full": "Immediate Action" },
            { "label": "SIGHT / SOUND", "full": "Sensory Clues" },
            { "label": "TOUCH / FEEL", "full": "Physical State" },
            { "label": "EMOTION", "full": "Internal Conflict" }
        ],
        "suggestionMatrix": {
            "0": [
                ["Character Archetype", "A disgraced spy on the run.", "An innocent person framed for murder.", "A master thief on their final job."],
                ["Motivation / Goal", "To escape the police waiting below.", "To reach an open window on the next balcony.", "To hide from the spotlight sweeping the wall."],
                ["Immediate Action", "Their foot slips on wet masonry.", "They press flat against the brickwork as a window opens.", "They risk a jump to the fire escape."],
                ["Sensory Clues", "The dizzying pull of the streetlights below.", "The smell of rain and exhaust fumes.", "The wail of a distant siren closing in."],
                ["Physical State", "Fingers cramping from the cold.", "Legs shaking uncontrollably.", "Heart beating so loud it masks the city noise."],
                ["Internal Conflict", "The urge to just let go versus the will to survive.", "Regret over the decision that led them here."]
            ],
            "1": [
                ["Character Archetype", "A weary Sheriff with a dark past.", "A Bounty Hunter tracking a target."],
                ["Motivation / Goal", "To arrest a fugitive without a shootout.", "To find the man who killed their brother."],
                ["Immediate Action", "The piano stops abruptly.", "Hands hover over holsters."],
                ["Sensory Clues", "The smell of stale beer and sawdust.", "The creak of the swing doors."],
                ["Physical State", "Sweat trickling down a dusty temple.", "A finger twitching near the trigger."],
                ["Internal Conflict", "Pride vs. Survival.", "The temptation to draw first vs. the law."]
            ]
        }
    }
    </script>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <h2 id="sidebar-title">Scene Reference</h2>
        <p class="instructions">Use the buttons to align a scene title with a planning focus.</p>
        <div id="sidebar-scenes-container"></div>
        <!-- Admin Trigger -->
        <button onclick="toggleAdmin()" class="admin-trigger"><i class="fas fa-lock"></i> Teacher Config</button>
    </div>

    <!-- MAIN -->
    <div class="main-content">
        <div class="wheel-container">
            <div class="arrow"></div>
            <div id="outer-ring" class="ring"></div>
            <div id="inner-ring" class="ring"></div>
            
            <div class="controls-area">
                <div class="control-group">
                    <span class="lbl blue">Scene-Shift</span>
                    <button class="wheel-btn" onclick="rotateRing('outer-ring', -45)">◀</button>
                    <button class="wheel-btn" onclick="rotateRing('outer-ring', 45)">▶</button>
                </div>
                <div class="control-group">
                    <span class="lbl red">Focus</span>
                    <button class="wheel-btn" onclick="rotateRing('inner-ring', -60)">◀</button>
                    <button class="wheel-btn" onclick="rotateRing('inner-ring', 60)">▶</button>
                </div>
            </div>
        </div>

        <div id="right-panel">
            <div class="output-box">
                <h3 id="result-title">Welcome</h3>
                <div id="result-desc">
                    <p>Use the buttons to spin the wheels and generate a prompt.</p>
                </div>
            </div>

            <div class="editor-container">
                <div class="editor-header">
                    <span class="editor-title">Writing Window</span>
                    <div class="save-btn-group">
                        <button class="btn-save" onclick="saveText()">Save .TXT</button>
                        <button class="btn-save blue" onclick="saveWord()">Save .DOC</button>
                        <button class="btn-save red" onclick="savePDF()">Save .PDF</button>
                    </div>
                </div>
                <textarea id="story-editor" placeholder="Write your story idea here..."></textarea>
            </div>
        </div>
    </div>

    <!-- ADMIN MODAL -->
    <div id="admin-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2 style="margin:0; font-size:18px;">Chief Inspector Admin Panel</h2>
                <button onclick="toggleAdmin()" style="border:none; background:none; font-size:20px; cursor:pointer;">&times;</button>
            </div>
            
            <!-- LOCK SCREEN -->
            <div id="lock-screen" class="modal-body" style="display:flex; flex-direction:column; align-items:center; justify-content:center;">
                <p style="margin-bottom:15px; color:#666;">Enter password to edit wheel data.</p>
                <div id="pass-hint" style="background:#fff3cd; padding:5px; font-size:11px; margin-bottom:10px; display:none;">Default: ChiefInspector</div>
                <!-- FIX: Changed ID to match JS -->
                <input type="password" id="admin-pass-input" class="form-input" style="width:200px; text-align:center; margin-bottom:10px;" placeholder="Password">
                <button onclick="checkPass()" class="btn-primary">Unlock</button>
                <p id="error-msg" style="color:red; font-size:12px; margin-top:5px; display:none;">Access Denied</p>
            </div>

            <!-- EDITOR SCREEN -->
            <div id="unlock-screen" class="modal-body" style="display:none;">
                <div class="form-group" style="background:#e9ecef; padding:10px; border-radius:4px;">
                    <div style="display:flex; gap:10px;">
                        <div style="flex:1;">
                            <label class="form-label">App Title</label>
                            <input id="edit-title" class="form-input">
                        </div>
                        <div style="flex:1;">
                            <label class="form-label">New Password</label>
                            <!-- FIX: Changed ID to match JS logic -->
                            <input id="new-admin-pass" class="form-input" placeholder="Leave empty to keep current" autocomplete="off">
                        </div>
                    </div>
                </div>

                <div style="display:flex; border-bottom:1px solid #ccc; margin-bottom:15px;">
                    <button class="btn-secondary" style="border-radius:4px 4px 0 0; background:#fff; color:#333; border:1px solid #ccc; border-bottom:none;" onclick="showTab('tab-scenes')">Edit Scenes</button>
                    <button class="btn-secondary" style="border-radius:4px 4px 0 0; background:#f0f0f0; color:#666; border:1px solid #eee;" onclick="showTab('tab-matrix')">Edit Prompts (Matrix)</button>
                </div>

                <div id="tab-scenes">
                    <p style="font-size:11px; color:#666; margin-bottom:10px;">Edit the 8 Scenes on the outer wheel.</p>
                    <div id="scenes-editor-list"></div>
                </div>

                <div id="tab-matrix" style="display:none;">
                    <p style="font-size:11px; color:#666; margin-bottom:10px;">Select a Scene to edit its specific prompts.</p>
                    <select id="matrix-scene-select" class="form-input" onchange="loadMatrixForScene()" style="margin-bottom:15px;"></select>
                    <div id="matrix-editor-area"></div>
                </div>
            </div>

            <div class="modal-footer" id="modal-footer" style="display:none;">
                <button onclick="resetDefaults()" style="color:red; background:none; border:none; cursor:pointer; font-size:11px;">Reset Defaults</button>
                <div style="display:flex; gap:10px;">
                    <button onclick="copySourceCode()" class="btn-secondary">Copy Source</button>
                    <button onclick="exportStandaloneFile()" class="btn-success">Download File</button>
                    <button onclick="saveLocal()" class="btn-primary">Save (Local)</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- SAFE STORAGE ---
        const SafeStorage = {
            getItem: (k) => { try { return localStorage.getItem(k) } catch(e){ return null } },
            setItem: (k,v) => { try { localStorage.setItem(k,v) } catch(e){} },
            removeItem: (k) => { try { localStorage.removeItem(k) } catch(e){} }
        };

        // --- LOAD CONFIG ---
        let appConfig;
        try {
            appConfig = JSON.parse(document.getElementById('app-config').textContent);
        } catch(e) { console.error("Config load error", e); }

        // Local Override
        try {
            const local = SafeStorage.getItem('storyWheelConfig');
            if(local) appConfig = { ...appConfig, ...JSON.parse(local) };
        } catch(e){}

        // --- GLOBAL VARS ---
        var rotations = { 'outer-ring': 0, 'inner-ring': 0 };

        // --- INIT ---
        document.addEventListener('DOMContentLoaded', function() {
            document.title = appConfig.appTitle;
            document.getElementById('sidebar-title').innerText = appConfig.appTitle;
            
            // Populate Sidebar
            const sbContainer = document.getElementById('sidebar-scenes-container');
            sbContainer.innerHTML = '';
            appConfig.scenesData.forEach(scene => {
                const card = document.createElement('div');
                card.className = 'scene-card';
                card.innerHTML = `<div class="scene-title">${scene.title}</div><div class="scene-text">${scene.synopsis}</div>`;
                sbContainer.appendChild(card);
            });

            // Setup Rings
            setupRing('outer-ring', appConfig.scenesData, 45, 'title');
            setupRing('inner-ring', appConfig.planningCategories, 60, 'label');
            
            updateCenter();
        });

        function setupRing(id, data, step, prop) {
            const ring = document.getElementById(id);
            ring.innerHTML = '';
            for (let i = 0; i < data.length; i++) {
                const spoke = document.createElement('div');
                spoke.className = 'ring-spoke';
                spoke.style.transform = 'rotate(' + (i * step) + 'deg)';
                const label = document.createElement('div');
                label.className = 'text-label';
                label.innerText = data[i][prop];
                spoke.appendChild(label);
                ring.appendChild(spoke);
            }
        }

        // --- WHEEL LOGIC ---
        function rotateRing(id, deg) {
            rotations[id] += deg;
            document.getElementById(id).style.transform = 'rotate(' + rotations[id] + 'deg)';
            updateCenter();
        }

        function getIndex(rotation, total) {
            const step = 360 / total;
            let angle = rotation % 360;
            if (angle < 0) angle += 360;
            return Math.round(((360 - angle) % 360) / step) % total;
        }

        function updateCenter() {
            const sIdx = getIndex(rotations['outer-ring'], 8);
            const cIdx = getIndex(rotations['inner-ring'], 6);
            
            let matrixData = appConfig.suggestionMatrix[sIdx];
            if(!matrixData) matrixData = []; 
            
            const categoryLabel = appConfig.planningCategories[cIdx].label;
            const fullLabel = appConfig.planningCategories[cIdx].full;
            
            document.getElementById('result-title').innerText = fullLabel;
            
            const catData = matrixData[cIdx]; 
            
            let html = "";
            if (catData && catData.length > 1) {
                for(let i=1; i<catData.length; i++) {
                    html += `<div class="output-suggestion">${catData[i]}</div>`;
                }
            } else {
                html = "<div class='output-suggestion'>No specific prompts configured for this combination yet.</div>";
            }
            
            document.getElementById('result-desc').innerHTML = html;
        }

        // --- ADMIN LOGIC ---
        function toggleAdmin() {
            const m = document.getElementById('admin-modal');
            if(m.style.display === 'flex') {
                m.style.display = 'none';
                document.getElementById('lock-screen').style.display = 'flex';
                document.getElementById('unlock-screen').style.display = 'none';
                document.getElementById('modal-footer').style.display = 'none';
                document.getElementById('admin-pass-input').value = '';
            } else {
                m.style.display = 'flex';
                if(appConfig.adminPass === 'ChiefInspector') document.getElementById('pass-hint').style.display = 'block';
                else document.getElementById('pass-hint').style.display = 'none';
            }
        }

        function checkPass() {
            if(document.getElementById('admin-pass-input').value === appConfig.adminPass) {
                document.getElementById('lock-screen').style.display = 'none';
                document.getElementById('unlock-screen').style.display = 'block';
                document.getElementById('modal-footer').style.display = 'flex';
                initEditor();
            } else {
                document.getElementById('error-msg').style.display = 'block';
            }
        }

        function initEditor() {
            document.getElementById('edit-title').value = appConfig.appTitle;
            document.getElementById('new-admin-pass').value = appConfig.adminPass;
            
            // Scenes Editor
            const sc = document.getElementById('scenes-editor-list');
            sc.innerHTML = '';
            appConfig.scenesData.forEach((s, i) => {
                sc.innerHTML += `
                    <div style="margin-bottom:10px; border-bottom:1px solid #eee; padding-bottom:5px;">
                        <label style="font-size:10px; font-weight:bold;">Scene ${i+1}</label>
                        <input class="form-input s-title" value="${s.title}" placeholder="Title" style="margin-bottom:2px;">
                        <textarea class="form-input s-synopsis" style="height:40px;">${s.synopsis}</textarea>
                    </div>
                `;
            });

            // Matrix Select
            const sel = document.getElementById('matrix-scene-select');
            sel.innerHTML = '';
            appConfig.scenesData.forEach((s, i) => {
                sel.innerHTML += `<option value="${i}">${s.title}</option>`;
            });
            loadMatrixForScene();
        }

        function loadMatrixForScene() {
            const sIdx = document.getElementById('matrix-scene-select').value;
            const area = document.getElementById('matrix-editor-area');
            area.innerHTML = '';
            
            if(!appConfig.suggestionMatrix[sIdx]) {
                appConfig.suggestionMatrix[sIdx] = appConfig.planningCategories.map(c => [c.full, "Prompt 1", "Prompt 2"]);
            }

            const sceneMatrix = appConfig.suggestionMatrix[sIdx];

            sceneMatrix.forEach((catArr, cIdx) => {
                const label = appConfig.planningCategories[cIdx].full;
                const prompts = catArr.slice(1).join('\n');
                
                area.innerHTML += `
                    <div style="margin-bottom:10px;">
                        <label style="font-size:11px; font-weight:bold; color:#0056b3;">${label}</label>
                        <textarea class="form-textarea matrix-prompt-input" data-cat="${cIdx}">${prompts}</textarea>
                    </div>
                `;
            });
        }

        function showTab(tabId) {
            document.getElementById('tab-scenes').style.display = tabId==='tab-scenes'?'block':'none';
            document.getElementById('tab-matrix').style.display = tabId==='tab-matrix'?'block':'none';
        }

        function collectData() {
            appConfig.appTitle = document.getElementById('edit-title').value;
            const np = document.getElementById('new-admin-pass').value;
            if(np) appConfig.adminPass = np;

            // Collect Scenes
            const titles = document.querySelectorAll('.s-title');
            const synops = document.querySelectorAll('.s-synopsis');
            appConfig.scenesData.forEach((s, i) => {
                if(titles[i]) s.title = titles[i].value;
                if(synops[i]) s.synopsis = synops[i].value;
            });

            // Collect Current Matrix Scene
            const sIdx = document.getElementById('matrix-scene-select').value;
            const prompts = document.querySelectorAll('.matrix-prompt-input');
            if(prompts.length > 0) {
                const newMatrixRow = [];
                prompts.forEach((p, i) => {
                    const lines = p.value.split('\n').filter(l => l.trim() !== "");
                    const label = appConfig.planningCategories[i].full;
                    newMatrixRow.push([label, ...lines]);
                });
                appConfig.suggestionMatrix[sIdx] = newMatrixRow;
            }
        }

        function saveLocal() {
            collectData();
            SafeStorage.setItem('storyWheelConfig', JSON.stringify(appConfig));
            alert("Saved to Browser.");
            location.reload();
        }

        function prepareDOMForExport() {
            collectData();
            document.getElementById('app-config').textContent = JSON.stringify(appConfig, null, 4);
            
            // Clean UI
            document.getElementById('admin-modal').style.display = 'none';
            document.getElementById('lock-screen').style.display = 'flex';
            document.getElementById('unlock-screen').style.display = 'none';
            document.getElementById('modal-footer').style.display = 'none';
            document.getElementById('admin-pass-input').value = '';
        }

        function exportStandaloneFile() {
            prepareDOMForExport();
            const html = document.documentElement.outerHTML;
            const blob = new Blob([html], {type: 'text/html'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const safeTitle = appConfig.appTitle.replace(/[^a-z0-9]/gi, '_').toLowerCase();
            a.href = url;
            a.download = `story_wheel_${safeTitle}.html`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            location.reload();
        }

        function copySourceCode() {
            prepareDOMForExport();
            const htmlContent = document.documentElement.outerHTML;
            
            const textArea = document.createElement("textarea");
            textArea.value = htmlContent;
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                document.execCommand('copy');
                alert("Source Code Copied! Paste into your editor and save.");
            } catch (err) {
                prompt("Copy failed. Manually copy:", htmlContent);
            }
            document.body.removeChild(textArea);
            location.reload();
        }

        function resetDefaults() {
            if(confirm("Reset?")) { SafeStorage.removeItem('storyWheelConfig'); location.reload(); }
        }

        // --- EDITOR FUNCTIONS ---
        function getContent() {
            var text = document.getElementById('story-editor').value;
            if(!text) { alert("Please write something first."); return null; }
            return text;
        }
        function saveText() {
            var text = getContent(); if(!text) return;
            var blob = new Blob([text], { type: "text/plain;charset=utf-8" });
            var a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "story.txt"; a.click();
        }
        function saveWord() {
            var text = getContent(); if(!text) return;
            var html = '<html><body>' + text.replace(/\n/g, "<br>") + '</body></html>';
            var blob = new Blob([html], { type: "application/msword" });
            var a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "story.doc"; a.click();
        }
        function savePDF() {
            var text = getContent(); if(!text) return;
            if (!window.jspdf) { alert("PDF Error. Save as .TXT instead."); return; }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            var splitText = doc.splitTextToSize(text, 180);
            doc.text(splitText, 10, 10);
            doc.save("story.pdf");
        }
    </script>
</body>
</html>
