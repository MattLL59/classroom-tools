<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dialogue Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .container {
            max-width: 800px;
        }
        .feedback-area {
            min-height: 50px;
            transition: all 0.3s ease;
        }
        textarea {
            min-height: 400px;
            resize: vertical;
        }
        .nudge {
            background-color: #fef2f2;
            border-left: 4px solid #ef4444;
            color: #b91c1c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 700;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto bg-white p-6 rounded-xl shadow-2xl">
        
        <!-- Navigation: Back to Toolkit (Links to index.html) -->
        <a href="index.html" class="inline-block text-blue-600 font-semibold mb-4 hover:underline">
            &larr; Back to Toolkit
        </a>

        <header class="mb-6 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-blue-800">Dialogue Coach</h1>
            <p class="text-gray-600 mt-2">Practice dialogue rules in real-time.</p>
        </header>

        <!-- Spelling Instruction Banner -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4 flex items-start">
            <span class="text-2xl mr-3">✍️</span>
            <div>
                <h4 class="font-bold text-yellow-800">How to Fix Spelling:</h4>
                <p class="text-sm text-yellow-800">
                    Errors have a <span class="underline decoration-red-500 decoration-wavy font-bold">red wavy line</span>. 
                    <strong>Right-click</strong> the word to select the correct spelling.
                </p>
            </div>
        </div>

        <!-- Writing Area -->
        <div class="mb-6">
            <label for="writing-area" class="block text-lg font-semibold text-gray-700 mb-2">Write Your Dialogue Here:</label>
            <textarea id="writing-area" 
                      spellcheck="true"
                      lang="en"
                      class="w-full border-2 border-gray-300 rounded-lg p-4 focus:outline-none focus:ring-4 focus:ring-blue-200 text-lg leading-relaxed"
                      placeholder="Start typing... &#10;Example: &quot;Hello,&quot; she said."></textarea>
        </div>

        <!-- Feedback Area -->
        <div id="feedback-container" class="feedback-area">
            <!-- Feedback messages will appear here -->
        </div>

        <!-- Quick Rules -->
        <div class="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h3 class="font-bold text-gray-700">Quick Rules:</h3>
            <ul class="list-disc list-inside text-gray-600 mt-2 space-y-1 text-sm">
                <li>New speaker = <strong>New paragraph</strong> (Enter key twice).</li>
                <li>Punctuation goes <strong>inside</strong> the quotes.</li>
                <li>Close quotes <strong>before</strong> the speaker's name.</li>
            </ul>
        </div>
    </div>

    <!-- THE LOGIC SCRIPT (Crucial for the app to work) -->
    <script>
        const writingArea = document.getElementById('writing-area');
        const feedbackContainer = document.getElementById('feedback-container');

        function debounce(func, timeout = 500) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        };

        // Helper to format the final HTML for a single message
        function createNudge(title, problem, fix) {
            return `
            <div class="nudge">
                <div class="uppercase tracking-wide text-sm font-bold mb-1">${title}</div>
                <div class="font-normal text-red-900 mb-1">${problem}</div>
                <div class="text-sm bg-white/50 p-2 rounded mt-1 text-red-800">${fix}</div>
            </div>
            `;
        };


        function checkDialogueRules(text) {
            // Store messages as objects {title, problem, fix}
            let feedbackMessages = [];
            const lines = text.split('\n');
            
            const dialogueTagRegex = /\b(said|asked|replied|whispered|shouted|insisted|muttered|yelled|screamed|cried)\b/i;
            const simpleTagRegex = /\b(said|asked|replied)\b/i; 
            const quoteRegex = /"/g; // Global regex for counting quotes
            
            let simpleTagCounter = 0; 
            let previousLineWasDialogue = false; 

            // --- GLOBAL CHECKS ---

            // Rule 13: Open Quote Alert (Checks for odd number of quotes)
            const quoteCount = (text.match(quoteRegex) || []).length;
            if (quoteCount % 2 !== 0 && quoteCount > 0) {
                feedbackMessages.push({
                    title: "Open Quote Alert", 
                    problem: "You have an odd number of quotation marks in your text.", 
                    fix: "This usually means a quote has been opened but not closed. Please check your text."
                });
            }

            // Rule 1: Punctuation Inside Quotes (Fixes period being used before tag)
            const punctuationErrorRegex = /"\.(?=\s*\b(said|asked|replied|whispered|shouted|insisted|muttered|yelled)\b)/gi;
            if (punctuationErrorRegex.test(text)) {
                feedbackMessages.push({
                    title: "Punctuation Check", 
                    problem: "You used a period inside the quotes followed by a tag.", 
                    fix: "Use a **comma** instead.<br><em>Wrong: \"Go away.\" he said.<br>Right: \"Go away,\" he said.</em>"
                });
            }

            // Rule 2: Lowercase Start inside Quotes (Targets uncapitalized quote starts reliably)
            let foundLowercaseStart = false;
            const rawLowercaseStarts = [...text.matchAll(/"\s*([a-zA-Z])/g)];

            for (const match of rawLowercaseStarts) {
                const quoteStartChar = match[1]; 
                const quoteIndex = match.index; 

                if (quoteStartChar === quoteStartChar.toLowerCase()) {
                    const context = text.substring(Math.max(0, quoteIndex - 5), quoteIndex);
                    
                    // Allow lowercase if it's a mid-sentence break (e.g., preceded by a comma)
                    if (!context.includes(',')) {
                        foundLowercaseStart = true;
                        break; 
                    }
                }
            }
            
            if (foundLowercaseStart) {
                 feedbackMessages.push({
                    title: "Capitalization Check",
                    problem: "A new sentence or piece of dialogue inside quotation marks usually starts with a capital letter.",
                    fix: "<em>Example: \"<span class='text-green-600 font-bold'>H</span>ello,\" she said.</em>"
                });
            }

            // Rule 18: Capitalized Tag Subject (FINAL FIX: "Hello," He said.)
            // Checks for: " [comma] [quote] [space] [Capitalized Letter] [lowercase letters] [space] [tag] "
            const capitalizedTagSubjectRegex = /"\s*,\s+([A-Z][a-z]+)\s+\b(said|asked|replied|whispered|shouted|insisted|muttered|yelled|screamed|cried)\b/g;

            if (capitalizedTagSubjectRegex.test(text)) {
                feedbackMessages.push({
                    title: "Capitalization Error in Tag",
                    problem: "The pronoun or name in the dialogue tag starts with a capital letter.",
                    fix: "When dialogue ends with a comma, the following dialogue tag subject should be **lowercase**.<br><em>Right: \"Hello,\" he said.</em>"
                });
            }


            // Rule 3: Lets vs Let's Check
            const letsRegex = /"\s*Lets\b/g;
            if (letsRegex.test(text)) {
                feedbackMessages.push({
                    title: "Grammar Check: Lets vs Let's",
                    problem: "Did you mean **Let's** (short for Let us)?",
                    fix: "<em>'Lets' (without apostrophe) means to allow something.</em>"
                });
            }
            
            // Rule 14: Contraction Apostrophe Check (Whats, Hes, Shes, Its)
            const contractionCheckRegex = /\b(Whats|Hes|Shes)\b/g;
            if (contractionCheckRegex.test(text)) {
                feedbackMessages.push({
                    title: "Missing Apostrophe",
                    problem: "You used a common contraction (like 'Whats') without an apostrophe.",
                    fix: "Contractions need an apostrophe. Use **What's** or **He's**."
                });
            }

            // Rule 15: Common Contracted Verb Errors (dont, cant, wont, isnt, etc.)
            const commonContractionErrors = /\b(dont|cant|wont|isnt|arent|didnt|hasnt|wouldnt|shouldnt|couldnt)\b/gi;
             if (commonContractionErrors.test(text)) {
                feedbackMessages.push({
                    title: "Missing Apostrophe",
                    problem: "You used a common contracted verb (like 'dont') without an apostrophe.",
                    fix: "Contractions need an apostrophe. Use **don't** or **can't**."
                });
            }

            // Rule 16: Homophone Check (no vs know)
            const noVsKnowRegex = /\b(dont|do\snot|didnt|did\snot|doesnt|does\snot)\s+no\b/gi;
             if (noVsKnowRegex.test(text)) {
                feedbackMessages.push({
                    title: "Homophone Check (no/know)",
                    problem: "You wrote 'no' after a negative verb (don't, didn't, etc.).",
                    fix: "You likely meant to use **know** (to have information)."
                });
            }


            // Rule 4: Tag Inside Quotes (The Run-on Quote Detector)
            const tagInsideQuotesRegex = /\b(said|asked|replied|whispered|shouted|he|she|they|I|we)\s*"\s*\b(said|asked|replied|whispered|shouted)\b/i;
            if (tagInsideQuotesRegex.test(text)) {
                feedbackMessages.push({
                    title: "Structure Check: Tag Inside Quotes",
                    problem: "It looks like you put the dialogue tag or pronoun <strong>inside</strong> the quotation marks.",
                    fix: "Close the quotes <strong>before</strong> the tag.<br><em>Right: \"Let's go,\" he said.</em>"
                });
            }

            // Rule 5: Missing Punctuation before closing quote
            const missingPuncRegex = /[a-z0-9]\s*"(?=\s*\b(he|she|it|they|we|I|said|asked))/i;
            if (missingPuncRegex.test(text)) {
                 feedbackMessages.push({
                    title: "Missing Punctuation",
                    problem: "You closed the quote without any punctuation inside.",
                    fix: "You usually need a <strong>comma</strong>.<br><em>Example: \"Hello<span class='text-red-600 font-bold'>,</span>\" she said.</em>"
                });
            }
            
            // Rule 6: Invalid Punctuation (Typo Check)
            const invalidPuncRegex = /[a-z]+[£$%^&*@#]/i;
            if (invalidPuncRegex.test(text)) {
                feedbackMessages.push({
                    title: "Typo / Punctuation Check",
                    problem: "I see a symbol (like £ or $) where punctuation should be.",
                    fix: "Did you hit the wrong key? Try <strong>?</strong> or <strong>!</strong> instead."
                });
            }

            // Rule 7: Your vs You're
            const yourUglyRegex = /\byour\s+(ugly|beautiful|stupid|smart|funny|mean|kind|nice|bad|good|right|wrong)\b/i;
            if (yourUglyRegex.test(text)) {
                feedbackMessages.push({
                    title: "Grammar Check: Your vs You're",
                    problem: "You wrote 'your' followed by a description.",
                    fix: "Did you mean **You're** (You are)?"
                });
            }
            
            // Rule 11: Invalid Line Start (Catching things like '2dougal')
            const invalidStartRegex = /^\s*[^a-zA-Z"'\s]/m;
            if (invalidStartRegex.test(text)) {
                feedbackMessages.push({
                    title: "Invalid Line Start",
                    problem: "Your line appears to start with an unusual character or number.",
                    fix: "Lines usually begin with a letter or a quotation mark."
                });
            }
            
            // Rule 12: Common Contraction/Possessive Errors (Its vs It's)
            const contractionItsRegex = /\bits\s+(ugly|beautiful|stupid|smart|funny|mean|kind|nice|bad|good|right|wrong)\b/i;
            if (contractionItsRegex.test(text)) {
                feedbackMessages.push({
                    title: "Grammar Check: Its vs It's",
                    problem: "You wrote 'its' followed by a description.",
                    fix: "Did you mean **It's** (It is)?"
                });
            }
            
            // Rule 10: Suspicious Punctuation without Quotes (FIXED to allow embedded single quotes)
            // It flags ? or ! if they are NOT immediately followed by a quote OR a dialogue tag
            const suspiciousPuncRegex = /[\?\!](?!\s*["']|\s*\b(said|asked|replied|whispered|shouted|insisted|muttered|yelled|screamed|cried)\b)/gi; 
            if (suspiciousPuncRegex.test(text)) {
                feedbackMessages.push({
                    title: "Suspicious Punctuation",
                    problem: "You used '?' or '!' but did not use quotes or a dialogue tag.",
                    fix: "Is this direct speech? If so, add quotation marks."
                });
            }
            
            // Rule 17: Embedded Quote Reminder (New Rule for Advanced Structure)
            // Detects the use of single quotes when double quotes are also present.
            const singleQuoteRegex = /'([^']*?)'/g; 
            if (text.match(quoteRegex) && text.match(singleQuoteRegex)) {
                feedbackMessages.push({
                    title: "Advanced Structure: Embedded Quote Detected",
                    problem: "You are using single quotes for a quote within double quotes.",
                    fix: "Ensure all inner punctuation belongs to the embedded quote and the outer quote is closed correctly. This is an advanced technique!"
                });
            }

            // --- LINE BY LINE CHECKS ---
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                const nextLine = (i + 1 < lines.length) ? lines[i + 1].trim() : '';

                if (line.length === 0) {
                    previousLineWasDialogue = false;
                    simpleTagCounter = 0; 
                    continue;
                }

                const hasTag = dialogueTagRegex.test(line);
                const hasQuotes = quoteRegex.test(line);

                // Check 8: Missing Quotation Marks (when a tag is present)
                if (hasTag && !hasQuotes) {
                    // Only trigger if it doesn't look like an indirect quote (like 'He said that...')
                    if (!/\bthat\b/i.test(line)) {
                        feedbackMessages.push({
                            title: "Missing Quotation Marks?",
                            problem: `I see a dialogue tag like '${line.match(dialogueTagRegex)[0]}' but no quotation marks.`,
                            fix: "Wrap spoken words in double quotes."
                        });
                    }
                }
                
                if (hasQuotes || hasTag) {
                    // Overuse of 'Said' counter logic
                    if (simpleTagRegex.test(line)) {
                        simpleTagCounter++;
                    } else {
                        simpleTagCounter = 0; 
                    }

                    if (simpleTagCounter >= 3) {
                        feedbackMessages.push({
                            title: "Vocabulary Nudge",
                            problem: "You've used 'said' (or similar) three times in a row.",
                            fix: "Try a stronger verb like <em>whispered, demanded, or insisted</em>."
                        });
                        // Reset counter after providing the suggestion
                        simpleTagCounter = 0; 
                    }

                    // Check 9: Paragraph Break Nudge (New Speaker)
                    if (previousLineWasDialogue && (hasQuotes || hasTag) && nextLine.length > 0) {
                         feedbackMessages.push({
                            title: "Paragraph Break Nudge",
                            problem: `It looks like two speakers are speaking on consecutive lines.`,
                            fix: "<strong>New Speaker = New Paragraph.</strong> Press Enter twice."
                        });
                        previousLineWasDialogue = false; 
                    } else {
                        previousLineWasDialogue = true;
                    }
                } else {
                    previousLineWasDialogue = false;
                    simpleTagCounter = 0;
                }
            }
            
            // --- FINAL RENDERING ---
            if (feedbackMessages.length > 0) {
                const uniqueMessages = [];
                const seenProblems = new Set();
                
                // De-duplication based on the 'problem' and 'fix' content
                feedbackMessages.forEach(msg => {
                    const key = msg.title + msg.problem + msg.fix; // Use a unique key for object de-duplication
                    if (!seenProblems.has(key)) {
                        seenProblems.add(key);
                        uniqueMessages.push(createNudge(msg.title, msg.problem, msg.fix));
                    }
                });
                
                feedbackContainer.innerHTML = uniqueMessages.join('');
            } else if (text.length > 20) {
                 feedbackContainer.innerHTML = '<div class="p-3 mt-4 bg-green-100 border-l-4 border-green-500 text-green-700 rounded-lg font-semibold flex items-center"><span class="text-xl mr-2">✅</span> <span>Looking good! No major dialogue structure errors found. Check for red underlines for spelling.</span></span></div>';
            } else {
                feedbackContainer.innerHTML = '';
            }
        }

        // Event listener with debounce to prevent constant checking while typing
        writingArea.addEventListener('input', debounce(() => {
            checkDialogueRules(writingArea.value);
        }, 500));

        // Initial check on load
        checkDialogueRules(writingArea.value);
    </script>
</body>
</html>
