<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dialogue Coach</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fc;
        }
        .container {
            max-width: 800px;
        }
        .feedback-area {
            min-height: 50px;
            transition: all 0.3s ease;
        }
        textarea {
            min-height: 400px;
            resize: vertical;
        }
        .nudge {
            background-color: #fef2f2;
            border-left: 4px solid #ef4444;
            color: #b91c1c;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: 1rem;
            font-weight: 700;
        }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="container mx-auto bg-white p-6 rounded-xl shadow-2xl">
        
        <!-- Navigation: Back to Toolkit (Links to index.html) -->
        <a href="index.html" class="inline-block text-blue-600 font-semibold mb-4 hover:underline">
            &larr; Back to Toolkit
        </a>

        <header class="mb-6 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-blue-800">Dialogue Coach</h1>
            <p class="text-gray-600 mt-2">Practice dialogue rules in real-time.</p>
        </header>

        <!-- Spelling Instruction Banner -->
        <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-3 mb-4 flex items-start">
            <span class="text-2xl mr-3">✍️</span>
            <div>
                <h4 class="font-bold text-yellow-800">How to Fix Spelling:</h4>
                <p class="text-sm text-yellow-800">
                    Errors have a <span class="underline decoration-red-500 decoration-wavy font-bold">red wavy line</span>. 
                    <strong>Right-click</strong> the word to select the correct spelling.
                </p>
            </div>
        </div>

        <!-- Writing Area -->
        <div class="mb-6">
            <label for="writing-area" class="block text-lg font-semibold text-gray-700 mb-2">Write Your Dialogue Here:</label>
            <textarea id="writing-area" 
                      spellcheck="true"
                      lang="en"
                      class="w-full border-2 border-gray-300 rounded-lg p-4 focus:outline-none focus:ring-4 focus:ring-blue-200 text-lg leading-relaxed"
                      placeholder="Start typing... &#10;Example: &quot;Hello,&quot; she said."></textarea>
        </div>

        <!-- Feedback Area -->
        <div id="feedback-container" class="feedback-area">
            <!-- Feedback messages will appear here -->
        </div>

        <!-- Quick Rules -->
        <div class="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <h3 class="text-lg font-bold text-gray-700">Quick Rules:</h3>
            <ul class="list-disc list-inside text-gray-600 mt-2 space-y-1">
                <li>New speaker = <strong>New paragraph</strong> (Enter key twice).</li>
                <li>Punctuation goes <strong>inside</strong> the quotes.</li>
                <li>Close quotes <strong>before</strong> the speaker's name.</li>
            </ul>
        </div>
    </div>

    <!-- THE LOGIC SCRIPT (Crucial for the app to work) -->
    <script>
        const writingArea = document.getElementById('writing-area');
        const feedbackContainer = document.getElementById('feedback-container');

        function debounce(func, timeout = 500) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        function checkDialogueRules(text) {
            let feedbackMessages = [];
            const lines = text.split('\n');
            
            const dialogueTagRegex = /\b(said|asked|replied|whispered|shouted|insisted|muttered|yelled|screamed|cried)\b/i;
            const simpleTagRegex = /\b(said|asked|replied)\b/i; 
            const quoteRegex = /"/g; // Global regex for counting quotes
            
            let simpleTagCounter = 0; 
            let previousLineWasDialogue = false; 

            // --- GLOBAL CHECKS ---

            // Rule 13: Open Quote Alert (NEW)
            const quoteCount = (text.match(quoteRegex) || []).length;
            if (quoteCount % 2 !== 0 && quoteCount > 0) {
                feedbackMessages.push(createNudge(
                    "Open Quote Alert", 
                    "You have an odd number of quotation marks in your text.", 
                    "This usually means a quote has been opened but not closed. Please check your text."
                ));
            }

            // Rule 1: Punctuation Inside Quotes
            const punctuationErrorRegex = /"\.(?=\s*\b(said|asked|replied|whispered|shouted|insisted|muttered|yelled)\b)/gi;
            if (punctuationErrorRegex.test(text)) {
                feedbackMessages.push(createNudge(
                    "Punctuation Check", 
                    "You used a period inside the quotes followed by a tag.", 
                    "Use a **comma** instead.<br><em>Wrong: \"Go away.\" he said.<br>Right: \"Go away,\" he said.</em>"
                ));
            }

            // Rule 2: Lowercase Start inside Quotes
            const lowercaseStartRegex = /"\s*[a-z]/g;
            if (lowercaseStartRegex.test(text)) {
                feedbackMessages.push(createNudge(
                    "Capitalization Check",
                    "A sentence inside quotation marks usually starts with a capital letter.",
                    "<em>Example: \"<span class='text-green-600 font-bold'>H</span>ello,\" she said.</em>"
                ));
            }

            // Rule 3: Lets vs Let's Check
            const letsRegex = /"\s*Lets\b/g;
            if (letsRegex.test(text)) {
                feedbackMessages.push(createNudge(
                    "Grammar Check: Lets vs Let's",
                    "Did you mean **Let's** (short for Let us)?",
                    "<em>'Lets' (without apostrophe) means to allow something.</em>"
                ));
            }

            // Rule 4: Tag Inside Quotes (The Run-on Quote Detector)
            // Catches cases like: "Let's go he said" or "Hello he" said
            const tagInsideQuotesRegex = /\b(said|asked|replied|whispered|shouted|he|she|they|I|we)\s*"\s*\b(said|asked|replied|whispered|shouted)\b/i;
            if (tagInsideQuotesRegex.test(text)) {
                feedbackMessages.push(createNudge(
                    "Structure Check: Tag Inside Quotes",
                    "It looks like you put the dialogue tag or pronoun <strong>inside</strong> the quotation marks.",
                    "Close the quotes <strong>before</strong> the tag.<br><em>Right: \"Let's go,\" he said.</em>"
                ));
            }

            // Rule 5: Missing Punctuation before closing quote
            const missingPuncRegex = /[a-z0-9]\s*"(?=\s*\b(he|she|it|they|we|I|said|asked))/i;
            if (missingPuncRegex.test(text)) {
                 feedbackMessages.push(createNudge(
                    "Missing Punctuation",
                    "You closed the quote without any punctuation inside.",
                    "You usually need a <strong>comma</strong>.<br><em>Example: \"Hello<span class='text-red-600 font-bold'>,</span>\" she said.</em>"
                ));
            }
            
            // Rule 6: Invalid Punctuation (Typo Check)
            const invalidPuncRegex = /[a-z]+[£$%^&*@#]/i;
            if (invalidPuncRegex.test(text)) {
                feedbackMessages.push(createNudge(
                    "Typo / Punctuation Check",
                    "I see a symbol (like £ or $) where punctuation should be.",
                    "Did you hit the wrong key? Try <strong>?</strong> or <strong>!</strong> instead."
                ));
            }

            // Rule 7: Your vs You're
            const yourUglyRegex = /\byour\s+(ugly|beautiful|stupid|smart|funny|mean|kind|nice|bad|good|right|wrong)\b/i;
            if (yourUglyRegex.test(text)) {
                feedbackMessages.push(createNudge(
                    "Grammar Check: Your vs You're",
                    "You wrote 'your' followed by a description.",
                    "Did you mean **You're** (You are)?"
                ));
            }
            
            // Rule 11: Invalid Line Start (Catching things like '2dougal')
            const invalidStartRegex = /^\s*[^a-zA-Z"'\s]/m;
            if (invalidStartRegex.test(text)) {
                feedbackMessages.push(createNudge(
                    "Invalid Line Start",
                    "Your line appears to start with an unusual character or number.",
                    "Lines usually begin with a letter or a quotation mark."
                ));
            }
            
            // Rule 12: Common Contraction/Possessive Errors (Its vs It's)
            const contractionItsRegex = /\bits\s+(ugly|beautiful|stupid|smart|funny|mean|kind|nice|bad|good|right|wrong)\b/i;
            if (contractionItsRegex.test(text)) {
                feedbackMessages.push(createNudge(
                    "Grammar Check: Its vs It's",
                    "You wrote 'its' followed by a description.",
                    "Did you mean **It's** (It is)?"
                ));
            }
            
            // Rule 10: Suspicious Punctuation without Quotes
            const suspiciousPuncRegex = /(?<!")[\?\!](?!\s*['"])/g;
            if (suspiciousPuncRegex.test(text)) {
                feedbackMessages.push(createNudge(
                    "Suspicious Punctuation",
                    "You used '?' or '!' but did not use quotes or a dialogue tag.",
                    "Is this direct speech? If so, add quotation marks."
                ));
            }

            // --- LINE BY LINE CHECKS ---
            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                const nextLine = (i + 1 < lines.length) ? lines[i + 1].trim() : '';

                if (line.length === 0) {
                    previousLineWasDialogue = false;
                    simpleTagCounter = 0; 
                    continue;
                }

                const hasTag = dialogueTagRegex.test(line);
                const hasQuotes = quoteRegex.test(line);

                // Check 8: Missing Quotation Marks
                if (hasTag && !hasQuotes) {
                    // Only trigger if it doesn't look like an indirect quote (like 'He said that...')
                    if (!/\bthat\b/i.test(line)) {
                        feedbackMessages.push(createNudge(
                            "Missing Quotation Marks?",
                            `I see a dialogue tag like '${line.match(dialogueTagRegex)[0]}' but no quotation marks.`,
                            "Wrap spoken words in double quotes."
                        ));
                    }
                }
                
                if (hasQuotes || hasTag) {
                    // Overuse of 'Said' counter logic
                    if (simpleTagRegex.test(line)) {
                        simpleTagCounter++;
                    } else {
                        simpleTagCounter = 0; 
                    }

                    if (simpleTagCounter >= 3) {
                        feedbackMessages.push(createNudge(
                            "Vocabulary Nudge",
                            "You've used 'said' (or similar) three times in a row.",
                            "Try a stronger verb like <em>whispered, demanded, or insisted</em>."
                        ));
                        // Reset counter after providing the suggestion
                        simpleTagCounter = 0; 
                    }

                    // Check 9: Paragraph Break Nudge (New Speaker)
                    if (previousLineWasDialogue && (hasQuotes || hasTag) && nextLine.length > 0) {
                         feedbackMessages.push(createNudge(
                            "Paragraph Break Nudge",
                            `It looks like two speakers are speaking on consecutive lines.`,
                            "<strong>New Speaker = New Paragraph.</strong> Press Enter twice."
                        ));
                        previousLineWasDialogue = false; 
                    } else {
                        previousLineWasDialogue = true;
                    }
                } else {
                    previousLineWasDialogue = false;
                    simpleTagCounter = 0;
                }
            }
            
            // Render Feedback
            if (feedbackMessages.length > 0) {
                // Ensure only unique messages are shown
                const uniqueMessages = Array.from(new Set(feedbackMessages.map(msg => msg.replace(/<[^>]*>?/gm, ''))))
                    .map(msg => createNudge('', msg.split('\n')[0], msg.split('\n')[1] || '')); // Recreate Nudges
                
                feedbackContainer.innerHTML = uniqueMessages.join('');
            } else if (text.length > 20) {
                 feedbackContainer.innerHTML = '<div class="p-3 mt-4 bg-green-100 border-l-4 border-green-500 text-green-700 rounded-lg font-semibold flex items-center"><span class="text-xl mr-2">✅</span> <span>Looking good! No major dialogue structure errors found. Check for red underlines for spelling.</span></div>';
            } else {
                feedbackContainer.innerHTML = '';
            }
        }

        function createNudge(title, problem, fix) {
            // Simple helper to create the visual feedback blocks
            return `
            <div class="nudge">
                <div class="uppercase tracking-wide text-sm font-bold mb-1">${title}</div>
                <div class="font-normal text-red-900 mb-1">${problem}</div>
                <div class="text-sm bg-white/50 p-2 rounded mt-1 text-red-800">${fix}</div>
            </div>
            `;
        }

        // Event listener with debounce to prevent constant checking while typing
        writingArea.addEventListener('input', debounce(() => {
            checkDialogueRules(writingArea.value);
        }, 500));

        // Initial check on load
        checkDialogueRules(writingArea.value);
    </script>
</body>
</html>
