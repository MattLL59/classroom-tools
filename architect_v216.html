<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tone & Structure Architect v216 (Robust Build)</title>
    <style>
        /* --- CSS VARIABLES & RESET --- */
        :root {
            --primary: #00897b; /* Teal */
            --accent: #f57c00;  /* Orange */
            --bg: #f4f7f6;
            --card: #ffffff;
            --text: #263238;
            --nav-bg: #ffffff;
            --border: #cfd8dc;
            --success: #43a047;
            --error: #e53935;
            --tone: #8e24aa;
            --struct: #1e88e5;
            --lang: #43a047;
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Segoe UI', system-ui, sans-serif; background-color: var(--bg); color: var(--text); margin: 0; padding: 0; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- HEADER --- */
        header { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: var(--card); box-shadow: 0 2px 8px rgba(0,0,0,0.08); z-index: 100; flex-shrink: 0; }
        h1 { margin: 0; font-size: 1.15rem; color: var(--primary); display: flex; align-items: center; gap: 8px; font-weight: 700; }
        .score-pill { background: var(--accent); color: white; padding: 3px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: bold; box-shadow: 0 2px 4px rgba(245, 124, 0, 0.3); }
        
        .header-controls { display: flex; gap: 8px; align-items: center; }
        .icon-btn { background: none; border: 1px solid var(--border); border-radius: 6px; cursor: pointer; padding: 6px 10px; font-size: 1.1rem; transition: all 0.2s; }
        .icon-btn:hover { background: #eceff1; transform: translateY(-1px); }
        select.level-select { padding: 6px; border-radius: 6px; border: 1px solid var(--border); font-weight: bold; color: var(--text); background: #fff; }

        /* --- MAIN LAYOUT --- */
        .viewport { flex-grow: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; scroll-behavior: smooth; }
        
        /* --- BOTTOM NAV --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; height: 70px; background: var(--nav-bg); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); z-index: 900; box-shadow: 0 -2px 10px rgba(0,0,0,0.05); }
        .nav-item { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; color: #90a4ae; border: none; background: none; cursor: pointer; height: 100%; gap: 4px; transition: all 0.2s; }
        .nav-item.active { color: var(--primary); background: rgba(0, 137, 123, 0.05); }
        .nav-icon { font-size: 1.4rem; }
        .nav-label { font-size: 0.75rem; font-weight: 600; }

        /* --- HUBS (VIEWS) --- */
        .hub { display: none; animation: fadeIn 0.3s ease-out; }
        .hub.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* --- COMMON UI COMPONENTS --- */
        .section-title { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: #78909c; margin: 20px 0 10px 0; border-bottom: 2px solid #eceff1; padding-bottom: 5px; }
        .btn { width: 100%; padding: 12px; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; font-size: 1rem; transition: filter 0.2s; margin-bottom: 8px; display: flex; align-items: center; justify-content: center; gap: 8px; }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; }
        .btn-accent { background: var(--accent); color: white; }
        .btn-doc { background: #1976d2; color: white; }
        .btn-danger { background: var(--error); color: white; }
        .btn-outline { background: white; border: 2px solid var(--border); color: var(--text); }

        /* --- EVIDENCE LAB --- */
        .source-header { display: flex; justify-content: space-between; align-items: center; background: #e0f2f1; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #b2dfdb; }
        .filter-bar { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .filter-btn { flex: 1; white-space: nowrap; padding: 8px; font-size: 0.9rem; }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 12px; }
        .card { background: var(--card); padding: 15px; border-radius: 10px; border: 1px solid var(--border); box-shadow: 0 2px 5px rgba(0,0,0,0.05); cursor: pointer; transition: transform 0.2s, border-color 0.2s; position: relative; overflow: hidden; }
        .card:hover { transform: translateY(-3px); border-color: var(--primary); box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
        .card-tone::before { background: var(--tone); }
        .card-structure::before { background: var(--struct); }
        .card-language::before { background: var(--lang); }
        .card-quote { font-family: 'Georgia', serif; font-size: 1.05rem; line-height: 1.4; color: #37474f; font-style: italic; margin-bottom: 8px; display: block; }
        .card-meta { font-size: 0.75rem; text-transform: uppercase; color: #90a4ae; font-weight: bold; display: flex; justify-content: space-between; }

        /* --- WRITING DESK --- */
        .builder-container { background: #fff; border-radius: 10px; padding: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .slot-row { margin-bottom: 12px; }
        .slot-label { display: block; font-size: 0.75rem; font-weight: 700; color: var(--primary); margin-bottom: 4px; text-transform: uppercase; }
        .slot-select, .slot-input { width: 100%; padding: 10px; border: 1px solid var(--border); border-radius: 6px; font-size: 1rem; background: #fafafa; }
        .slot-static { background: #e3f2fd; color: #1565c0; border: 1px solid #90caf9; padding: 10px; border-radius: 6px; font-style: italic; }
        
        .preview-box { padding: 15px; background: #fff8e1; border: 2px dashed #ffb74d; border-radius: 8px; font-size: 1.1rem; min-height: 60px; line-height: 1.5; margin-bottom: 15px; }
        .preview-box:focus { outline: none; border-color: var(--accent); background: #fff; }
        
        textarea#final-essay { width: 100%; height: 200px; padding: 15px; border: 1px solid var(--border); border-radius: 8px; font-size: 1rem; font-family: inherit; line-height: 1.6; resize: vertical; margin-bottom: 10px; }

        /* --- ADMIN / MODALS --- */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); z-index: 2000; align-items: center; justify-content: center; backdrop-filter: blur(2px); }
        .modal.open { display: flex; }
        .modal-content { background: var(--bg); width: 95%; max-width: 800px; max-height: 90vh; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        .modal-header { padding: 15px 20px; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; font-weight: bold; font-size: 1.1rem; }
        .modal-body { padding: 20px; overflow-y: auto; }
        
        .admin-panel { background: white; border-radius: 8px; padding: 15px; margin-bottom: 15px; border: 1px solid var(--border); }
        .admin-panel h3 { margin-top: 0; color: var(--primary); font-size: 1rem; display: flex; align-items: center; gap: 8px; }
        .input-group { margin-bottom: 10px; }
        .input-group label { display: block; font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; }
        .input-group input, .input-group textarea, .input-group select { width: 100%; padding: 8px; border: 1px solid var(--border); border-radius: 4px; font-size: 0.95rem; }
        
        /* --- UTILS --- */
        .hidden { display: none !important; }
        .shake { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
        
        #save-indicator { position: fixed; top: 10px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); color: white; padding: 6px 16px; border-radius: 20px; font-size: 0.85rem; pointer-events: none; opacity: 0; transition: opacity 0.3s; z-index: 3000; }
        
        /* Print styles for worksheet */
        @media print { body { background: white; color: black; } .no-print { display: none; } }
    </style>
</head>
<body>

    <div id="save-indicator">üíæ Progress Saved</div>

    <audio id="sfx-success" src="https://actions.google.com/sounds/v1/cartoon/pop.ogg"></audio>
    <audio id="sfx-cheer" src="https://actions.google.com/sounds/v1/crowds/crowd_cheer.ogg"></audio>

    <header class="no-print">
        <h1>
            <button class="icon-btn" onclick="app.resetSession()" style="color:red; border-color:red;" title="New Session">‚ú®</button>
            Tone & Structure <span style="font-size:0.8em; color:#999;">v216</span>
            <span class="score-pill" id="score-display">0 XP</span>
        </h1>
        <div class="header-controls">
            <button class="icon-btn" onclick="ui.openHelp()">‚ùì</button>
            <select id="level-selector" class="level-select" onchange="app.setLevel(this.value)">
                <option value="1">Lvl 1</option>
                <option value="2">L2</option>
                <option value="3">L3</option>
            </select>
            <button class="icon-btn" onclick="ui.openAdmin()">‚öôÔ∏è</button>
        </div>
    </header>

    <div class="viewport no-print">
        
        <div id="hub-lab" class="hub active">
            <div class="source-header">
                <div>
                    <strong>Topic:</strong> <span id="text-title">Loading...</span>
                </div>
                <button class="btn btn-outline" style="width:auto; padding:5px 10px; font-size:0.85rem;" onclick="ui.openSourceText()">
                    üìÑ Read Source
                </button>
            </div>

            <div class="section-title">Step 1: Gather Evidence</div>
            
            <div class="filter-bar">
                <button class="btn btn-outline filter-btn" onclick="app.filterGrid('all')">All</button>
                <button class="btn btn-outline filter-btn" onclick="app.filterGrid('language')">Language</button>
                <button class="btn btn-outline filter-btn" onclick="app.filterGrid('structure')">Structure</button>
                <button class="btn btn-outline filter-btn" onclick="app.filterGrid('tone')">Tone</button>
            </div>

            <div id="quote-grid" class="grid">
                </div>

            <div class="section-title" style="margin-top:30px;">Global Analysis</div>
            <div id="global-structure-container">
                </div>
        </div>

        <div id="hub-write" class="hub">
            <div class="section-title">Step 2: Construct Analysis</div>
            
            <div class="builder-container" id="sentence-builder">
                <div style="text-align:center; color:#999; font-style:italic; padding:20px;">
                    Select a quote in the Evidence Lab to begin.
                </div>
            </div>

            <div class="section-title">Step 3: Refine & Commit</div>
            <div id="preview-box" class="preview-box" contenteditable="true" oninput="app.handleManualInput()">
                [Your sentence will appear here...]
            </div>

            <div style="display:flex; gap:10px;">
                <button class="btn btn-accent" onclick="app.undoLast()">Undo</button>
                <button class="btn btn-primary" onclick="app.commitSentence()">Commit to Essay ‚¨á</button>
            </div>

            <div class="section-title">Final Essay</div>
            <textarea id="final-essay" placeholder="Your full analytical response will be built here..." oninput="app.saveProgress()"></textarea>
            
            <div style="display:flex; gap:10px; margin-top:10px;">
                <button class="btn btn-doc" onclick="app.exportDoc()">üìÑ Download .doc</button>
                <button class="btn btn-danger" onclick="app.clearEssay()">üóë Clear</button>
            </div>
        </div>

    </div>

    <nav class="bottom-nav no-print">
        <button class="nav-item active" onclick="ui.switchHub('lab')" id="nav-btn-lab">
            <span class="nav-icon">üß™</span>
            <span class="nav-label">Evidence Lab</span>
        </button>
        <button class="nav-item" onclick="ui.switchHub('write')" id="nav-btn-write">
            <span class="nav-icon">‚úçÔ∏è</span>
            <span class="nav-label">Writing Desk</span>
        </button>
    </nav>

    <div id="modal-source" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Source Text
                <button class="icon-btn" onclick="ui.closeModal('modal-source')">‚úï</button>
            </div>
            <div class="modal-body">
                <div id="source-content" style="white-space: pre-wrap; line-height:1.6; font-family:'Georgia',serif; font-size:1.1rem; color:#333;"></div>
            </div>
        </div>
    </div>

    <div id="modal-help" class="modal">
        <div class="modal-content" style="max-width:500px;">
            <div class="modal-header">
                How to Use
                <button class="icon-btn" onclick="ui.closeModal('modal-help')">‚úï</button>
            </div>
            <div class="modal-body">
                <p><strong>1. Evidence Lab:</strong> Read the source text. Click on colored quote cards to analyze them. Answer the questions correctly to earn XP.</p>
                <hr>
                <p><strong>2. Writing Desk:</strong> Use the dropdown menus to build professional analytical sentences. You can edit the text manually before adding it to your final essay.</p>
                <hr>
                <p><strong>3. Levels:</strong> Use the dropdown in the top right to change difficulty. Higher levels require deeper analysis.</p>
            </div>
        </div>
    </div>

    <div id="modal-admin" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                Teacher Settings
                <button class="icon-btn" onclick="ui.closeModal('modal-admin')">‚úï</button>
            </div>
            <div class="modal-body">
                
                <div class="admin-panel" style="background:#e3f2fd; border-color:#90caf9;">
                    <h3>ü§ñ AI Lesson Generator</h3>
                    <div class="input-group">
                        <label>Config: Number of Quotes</label>
                        <input type="number" id="gen-quote-count" value="6" min="1" max="15">
                    </div>
                    <div class="input-group">
                        <label>1. Paste Source Text & Question</label>
                        <textarea id="gen-input-text" style="height:80px;" placeholder="Paste text here..."></textarea>
                    </div>
                    <button class="btn btn-primary" onclick="admin.generatePrompt()">Generate Prompt</button>
                    
                    <div id="gen-output-area" class="hidden" style="margin-top:10px;">
                        <textarea id="gen-prompt-out" style="height:100px; background:#fff;" readonly></textarea>
                        <p style="font-size:0.8rem; color:#666;">Copy above prompt -> Paste into ChatGPT -> Paste JSON result below:</p>
                        <textarea id="gen-json-in" style="height:80px;" placeholder="Paste JSON here..."></textarea>
                        <button class="btn btn-success" style="background:var(--success); color:white; margin-top:5px;" onclick="admin.loadJson()">üì• Load Lesson Data</button>
                    </div>
                </div>

                <div class="admin-panel">
                    <h3>üì¶ Export & Share</h3>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn btn-doc" onclick="admin.exportWorksheet()">üìÑ Worksheet (.doc)</button>
                        <button class="btn btn-primary" style="background:#37474f;" onclick="admin.exportStandalone()">üì¶ Student App (.html)</button>
                        <button class="btn btn-outline" onclick="admin.saveConfig()">üíæ Save Config (.json)</button>
                        <button class="btn btn-outline" onclick="document.getElementById('file-upload').click()">üìÇ Load Config</button>
                        <input type="file" id="file-upload" class="hidden" onchange="admin.loadConfig(this)">
                    </div>
                </div>

                <div class="admin-panel">
                    <h3>‚ö†Ô∏è Danger Zone</h3>
                    <button class="btn btn-danger" onclick="app.factoryReset()">Factory Reset App</button>
                </div>

            </div>
        </div>
    </div>

<script>
/**
 * TONE & STRUCTURE ARCHITECT v216
 * Robust Single-File Implementation
 */

// --- 1. CORE DATA & STATE MANAGEMENT ---

// Default Configuration (Fallback)
const defaultData = {
    meta: { title: "Demo Lesson", author: "System", version: 216 },
    sourceText: "The sky was a bruised purple. The wind howled like a banshee, tearing at the shutters. Inside, the silence was heavy, a physical weight pressing down on him.",
    question: "How does the writer use language to create atmosphere?",
    globalStructure: {
        enabled: true,
        question: "How does the focus shift in this extract?",
        correct: "From the chaotic outside weather to the oppressive internal silence.",
        distractors: ["It stays focused on the weather.", "It moves from morning to night."]
    },
    // Banks allow for flexible sentence construction
    banks: {
        markers: ["Furthermore,", "However,", "Consequently,", "Significantly,", "In contrast,"],
        starters: ["The writer suggests", "The author highlights", "The imagery implies", "The text conveys"],
        methods: ["Metaphor", "Simile", "Personification", "Pathetic Fallacy", "Juxtaposition"],
        links: {
            l1: ["This shows", "This suggests", "This means"],
            l2: ["This reinforces", "This highlights", "This creates a sense of"]
        }
    },
    // Sentence Structure Configuration per Level
    sentenceConfig: {
        1: ["starter", "quote", "link_l1", "manual_point"],
        2: ["marker", "starter", "quote", "method", "link_l2", "manual_analysis"],
        3: ["marker", "starter", "quote", "method", "manual_deep_analysis", "link_l2", "manual_effect"]
    },
    // Content Items
    items: [
        {
            id: "d1",
            original: "bruised purple",
            translation: "Dark, painful looking color",
            type: "language",
            levels: [1, 2, 3],
            l1: { prompt: "Technique?", correct: "Metaphor", distractors: ["Simile"] },
            l2: { prompt: "Connotation?", correct: "Pain / Injury", distractors: ["Royalty"] },
            l3: { prompt: "Effect?", correct: "Suggests the sky itself has been hurt", distractors: ["Suggests it is night"] }
        },
        {
            id: "d2",
            original: "howled like a banshee",
            translation: "Screamed very loudly",
            type: "language",
            levels: [1, 2],
            l1: { prompt: "Technique?", correct: "Simile", distractors: ["Metaphor"] },
            l2: { prompt: "Atmosphere?", correct: "Supernatural terror", distractors: ["Excitement"] }
        }
    ]
};

// Global State
let appData = null;
let userState = {
    score: 0,
    level: 1,
    essay: "",
    completed: [], // IDs of completed items
    currentBuilder: {} // Current sentence being built
};

// --- 2. INITIALIZATION & SAFETY ---

const app = {
    init: function() {
        console.log("Initializing Architect v216...");
        
        // 1. Load Data
        const storedData = localStorage.getItem('tsa_data_v216');
        if (storedData) {
            try {
                appData = JSON.parse(storedData);
                // Sanity check critical fields
                if (!appData.items) appData.items = [];
                if (!appData.banks) appData.banks = defaultData.banks;
            } catch (e) {
                console.error("Data corruption detected. Reverting to default.");
                appData = JSON.parse(JSON.stringify(defaultData));
            }
        } else {
            // Check for injected config (Student Mode)
            if (typeof teacherConfig !== 'undefined' && teacherConfig) {
                appData = teacherConfig;
            } else {
                appData = JSON.parse(JSON.stringify(defaultData));
            }
        }

        // 2. Load User State
        const storedState = localStorage.getItem('tsa_state_v216');
        if (storedState) {
            userState = JSON.parse(storedState);
        }

        // 3. Render
        ui.updateScore();
        document.getElementById('final-essay').value = userState.essay;
        document.getElementById('level-selector').value = userState.level;
        ui.renderLab();
        
        // Auto-save loop
        setInterval(app.saveProgress, 30000); 
    },

    saveProgress: function() {
        userState.essay = document.getElementById('final-essay').value;
        localStorage.setItem('tsa_state_v216', JSON.stringify(userState));
        localStorage.setItem('tsa_data_v216', JSON.stringify(appData));
        
        const ind = document.getElementById('save-indicator');
        ind.style.opacity = 1;
        setTimeout(() => ind.style.opacity = 0, 2000);
    },

    resetSession: function() {
        if(confirm("Clear your current progress? (Lesson data will stay)")) {
            userState = { score: 0, level: 1, essay: "", completed: [], currentBuilder: {} };
            app.saveProgress();
            location.reload();
        }
    },

    factoryReset: function() {
        if(confirm("NUCLEAR RESET: Delete ALL data and return to default demo?")) {
            localStorage.clear();
            location.reload();
        }
    },

    setLevel: function(lvl) {
        userState.level = parseInt(lvl);
        app.saveProgress();
        ui.renderLab();
        // Clear builder if level changes to prevent incompatibility
        document.getElementById('sentence-builder').innerHTML = '<div style="text-align:center; padding:20px; color:#999;">Level changed. Please select a quote again.</div>';
    },

    filterGrid: function(type) {
        const items = document.querySelectorAll('.card-item');
        items.forEach(el => {
            if (type === 'all' || el.dataset.type === type) el.style.display = 'block';
            else el.style.display = 'none';
        });
    },

    // --- GAMEPLAY LOGIC ---

    selectQuote: function(id) {
        // 1. Find Item
        const item = appData.items.find(i => i.id === id);
        if(!item) return;

        // 2. Start Analysis Workflow (Step 1: Match)
        ui.showAnalysisModal(item);
    },

    commitSentence: function() {
        const text = document.getElementById('preview-box').innerText.trim();
        if(!text || text.includes("[")) {
            alert("Please complete the sentence first.");
            return;
        }
        
        const area = document.getElementById('final-essay');
        area.value += (area.value ? "\n\n" : "") + text;
        
        // Clear Builder
        document.getElementById('preview-box').innerText = "[Sentence added]";
        document.getElementById('sentence-builder').innerHTML = '<div style="text-align:center; padding:20px; color:#success;">Saved! Select another quote.</div>';
        
        app.saveProgress();
    },

    undoLast: function() {
        const area = document.getElementById('final-essay');
        const lines = area.value.split("\n\n");
        if(lines.length > 0) {
            lines.pop();
            area.value = lines.join("\n\n");
            app.saveProgress();
        }
    },

    handleManualInput: function() {
        // Just ensures binding, real logic happens on commit
    },

    exportDoc: function() {
        const content = document.getElementById('final-essay').value;
        const blob = new Blob(['\ufeff' + content.replace(/\n/g, '\r\n')], { type: 'application/msword' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'My_Essay.doc';
        a.click();
    },
    
    clearEssay: function() {
        if(confirm("Delete entire essay?")) {
            document.getElementById('final-essay').value = "";
            app.saveProgress();
        }
    }
};

// --- 3. UI RENDERING ---

const ui = {
    renderLab: function() {
        document.getElementById('text-title').innerText = appData.meta.title;
        document.getElementById('source-content').innerText = appData.sourceText;
        
        const grid = document.getElementById('quote-grid');
        grid.innerHTML = '';

        appData.items.forEach(item => {
            // Level Gating check
            if (item.levels && !item.levels.includes(userState.level)) return;

            const div = document.createElement('div');
            div.className = `card card-item card-${item.type}`;
            div.dataset.type = item.type;
            div.innerHTML = `
                <span class="card-quote">"${item.original}"</span>
                <div class="card-meta">
                    <span>${item.type}</span>
                    <span>${userState.completed.includes(item.id) ? '‚úÖ' : ''}</span>
                </div>
            `;
            div.onclick = () => app.selectQuote(item.id);
            grid.appendChild(div);
        });

        // Global Structure
        const globalContainer = document.getElementById('global-structure-container');
        if (appData.globalStructure && appData.globalStructure.enabled) {
            globalContainer.innerHTML = `
                <div class="card card-structure" onclick="ui.runGlobalCheck()">
                    <strong>üèóÔ∏è Whole Text Structure Question</strong><br>
                    <small>Click to answer</small>
                </div>
            `;
        } else {
            globalContainer.innerHTML = '';
        }
    },

    updateScore: function() {
        document.getElementById('score-display').innerText = userState.score + " XP";
    },

    switchHub: function(hubName) {
        document.querySelectorAll('.hub').forEach(h => h.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
        
        document.getElementById('hub-' + hubName).classList.add('active');
        document.getElementById('nav-btn-' + hubName).classList.add('active');
    },

    openModal: function(id) { document.getElementById(id).classList.add('open'); },
    closeModal: function(id) { document.getElementById(id).classList.remove('open'); },
    
    openHelp: function() { ui.openModal('modal-help'); },
    openAdmin: function() { 
        const pass = prompt("Enter Teacher Password (default: 1234)");
        if(pass === "1234" || pass === "admin") ui.openModal('modal-admin');
        else alert("Incorrect password.");
    },
    openSourceText: function() { ui.openModal('modal-source'); },

    // --- ANALYSIS WORKFLOW (The "Wizard") ---
    showAnalysisModal: function(item) {
        // Simple 3-step logic implemented via standard prompt/confirm flow for robustness in single-file
        // In a larger app, this would be a dedicated modal.
        
        // Step 1: Meaning
        const opts = [item.translation, ...item.distractors];
        opts.sort(() => Math.random() - 0.5);
        
        // We create a temporary modal overlay for interaction
        const overlay = document.createElement('div');
        overlay.className = 'modal open';
        overlay.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">Phase 1: Meaning <button class="icon-btn" id="close-temp">‚úï</button></div>
                <div class="modal-body">
                    <p class="card-quote">"${item.original}"</p>
                    <p>What does this mean?</p>
                    <div class="grid">
                        ${opts.map(opt => `<button class="btn btn-outline answer-btn" data-correct="${opt === item.translation}">${opt}</button>`).join('')}
                    </div>
                </div>
            </div>
        `;
        document.body.appendChild(overlay);

        document.getElementById('close-temp').onclick = () => overlay.remove();

        overlay.querySelectorAll('.answer-btn').forEach(btn => {
            btn.onclick = function() {
                if(this.dataset.correct === "true") {
                    this.style.background = "var(--success)";
                    this.style.color = "white";
                    document.getElementById('sfx-success').play().catch(()=>{});
                    setTimeout(() => {
                        overlay.remove();
                        ui.startSentenceBuilder(item); // Proceed to builder
                    }, 500);
                } else {
                    this.classList.add('shake');
                    this.style.background = "var(--error)";
                    this.style.color = "white";
                }
            };
        });
    },

    runGlobalCheck: function() {
        const q = appData.globalStructure;
        const opts = [q.correct, ...q.distractors].sort(() => Math.random() - 0.5);
        
        const overlay = document.createElement('div');
        overlay.className = 'modal open';
        overlay.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">Structure Check <button class="icon-btn" onclick="this.closest('.modal').remove()">‚úï</button></div>
                <div class="modal-body">
                    <p><strong>${q.question}</strong></p>
                    ${opts.map(opt => `<button class="btn btn-outline g-btn" data-correct="${opt === q.correct}">${opt}</button>`).join('')}
                </div>
            </div>
        `;
        document.body.appendChild(overlay);
        
        overlay.querySelectorAll('.g-btn').forEach(btn => {
            btn.onclick = function() {
                if(this.dataset.correct === "true") {
                    this.style.background = "var(--success)";
                    this.style.color = "white";
                    userState.score += 20;
                    ui.updateScore();
                    setTimeout(() => overlay.remove(), 800);
                } else {
                    this.classList.add('shake');
                    this.style.background = "#ffebee";
                }
            }
        });
    },

    startSentenceBuilder: function(item) {
        ui.switchHub('write');
        const container = document.getElementById('sentence-builder');
        container.innerHTML = '';
        
        // 1. Get Config for current level
        const config = appData.sentenceConfig[userState.level] || ["starter", "quote", "manual_analysis"];
        
        // 2. Build Inputs
        config.forEach(slotType => {
            const wrapper = document.createElement('div');
            wrapper.className = 'slot-row';
            
            // Handle Manual Input
            if(slotType.startsWith('manual')) {
                const label = slotType.split('_')[1] || "Analysis";
                wrapper.innerHTML = `
                    <span class="slot-label">${label} (Your Idea)</span>
                    <input class="slot-input builder-input" placeholder="Type here..." oninput="ui.updatePreview()">
                `;
            } 
            // Handle Quote
            else if(slotType === 'quote') {
                wrapper.innerHTML = `
                    <span class="slot-label">EVIDENCE</span>
                    <div class="slot-static" data-value='"${item.original}"'>"${item.original}"</div>
                `;
            } 
            // Handle Dropdowns (Banks)
            else {
                // Handle Level-specific links (link_l1)
                let bankKey = slotType;
                let options = [];
                
                if(slotType.includes('link')) {
                    const lKey = slotType.split('_')[1] || 'l1';
                    options = appData.banks.links[lKey] || [];
                    bankKey = "Link";
                } else {
                    // Pluralize simple keys (starter -> starters)
                    const plural = slotType + "s";
                    options = appData.banks[plural] || [];
                }

                if(options.length > 0) {
                    const optsHtml = options.map(o => `<option value="${o}">${o}</option>`).join('');
                    wrapper.innerHTML = `
                        <span class="slot-label">${bankKey}</span>
                        <select class="slot-select builder-select" onchange="ui.updatePreview()">
                            <option value="">Select...</option>
                            ${optsHtml}
                        </select>
                    `;
                }
            }
            container.appendChild(wrapper);
        });
        
        ui.updatePreview();
    },

    updatePreview: function() {
        // Scrape all values from the builder
        const parts = [];
        const inputs = document.querySelectorAll('#sentence-builder select, #sentence-builder input, #sentence-builder .slot-static');
        
        inputs.forEach(el => {
            let val = "";
            if(el.tagName === 'DIV') val = el.dataset.value; // Static quote
            else val = el.value;
            
            if(val && val.trim() !== "") parts.push(val);
        });
        
        const fullSentence = parts.join(" ") + ".";
        document.getElementById('preview-box').innerText = fullSentence;
    }
};

// --- 4. ADMIN FEATURES ---

const admin = {
    generatePrompt: function() {
        const count = document.getElementById('gen-quote-count').value;
        const text = document.getElementById('gen-input-text').value;
        if(!text) { alert("Paste text first"); return; }
        
        // Robust Prompt Engineering
        const prompt = `Role: Expert English Teacher. Task: Create a JSON structure for a lesson.
Source Text: "${text.replace(/"/g, "'").substring(0, 1000)}..."
Requirements:
1. Generate ${count} analysis items.
2. Each item must have 'original' (quote), 'translation' (simple meaning), and 'type' (language/structure/tone).
3. Important: Include 'levels' array [1,2,3] and specific prompts for l1, l2, l3.
Output Format: Pure JSON matching this schema:
{
  "meta": { "title": "...", "author": "..." },
  "sourceText": "...",
  "items": [ { "id": "1", "original": "...", "type": "tone", "levels": [1,2,3], "l1": {"prompt": "...", "correct": "..."} } ]
}`;
        document.getElementById('gen-prompt-out').value = prompt;
        document.getElementById('gen-output-area').classList.remove('hidden');
    },

    loadJson: function() {
        let raw = document.getElementById('gen-json-in').value;
        // Strip markdown
        raw = raw.replace(/```json/g, '').replace(/```/g, '');
        
        try {
            const data = JSON.parse(raw);
            // Merge logic
            appData.items = data.items || [];
            appData.meta.title = data.meta?.title || "Imported Lesson";
            appData.sourceText = data.sourceText || appData.sourceText;
            
            app.saveProgress();
            alert("Lesson Loaded Successfully!");
            location.reload();
        } catch(e) {
            alert("Invalid JSON. Please check the format.");
        }
    },

    exportWorksheet: function() {
        let html = `<html><body><h1>${appData.meta.title}</h1><p>${appData.sourceText}</p><hr>`;
        appData.items.forEach(i => {
            html += `<p><strong>Quote:</strong> "${i.original}"</p><p>Analysis: _________________________</p><br>`;
        });
        html += "</body></html>";
        
        const blob = new Blob(['\ufeff', html], {
            type: 'application/msword'
        });
        
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'Worksheet.doc';
        link.click();
    },

    exportStandalone: function() {
        // Clone current HTML
        let html = document.documentElement.outerHTML;
        
        // Embed current appData into the defaultData variable
        const scriptInject = `const defaultData = ${JSON.stringify(appData)};`;
        
        // Replace the top constant
        html = html.replace(/const defaultData = \{[\s\S]*?\}\};/, scriptInject);
        
        const blob = new Blob([html], {type: 'text/html'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'ToneStructure_Lesson.html';
        link.click();
    },

    saveConfig: function() {
        const blob = new Blob([JSON.stringify(appData)], {type: 'application/json'});
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'config.json';
        link.click();
    },

    loadConfig: function(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                appData = JSON.parse(e.target.result);
                app.saveProgress();
                location.reload();
            } catch(err) { alert("Error reading config file"); }
        };
        reader.readAsText(file);
    }
};

// Boot
window.onload = app.init;

</script>
</body>
</html>
